cscope 15 $HOME/Documents/code/barley -q 0000005619 0000881602
	@frcapi/frc_api.c

1 
	~<¡ršg.h
>

2 
	~<¡dšt.h
>

3 
	~<uni¡d.h
>

5 
	~"äc_­i.h
"

6 
	~"äc_ioùl.h
"

7 
	~<sys/ioùl.h
>

8 
	~<fú.h
>

9 
	~"äc_ty³s.h
"

10 
	~"äc_cmd.h
"

11 
	~"äc_·ck.h
"

14 #ià
FRC_DEBUG_API


15 
	#FRCAPI_ERROR
(
_fmt
, 
_¬gs
...è
	`´štf
("[ERROR] %s.%d:" _fmt, 
__func__
, 
__LINE__
, ##_¬gs)

	)

16 
	#FRCAPI_DEBUG
(
_fmt
, 
_¬gs
...è
	`´štf
("[DEBUG] %s.%d:" _fmt, 
__func__
, 
__LINE__
, ##_¬gs)

	)

18 
	#FRCAPI_ERROR
(
_fmt
, 
_¬gs
...)

	)

19 
	#FRCAPI_DEBUG
(
_fmt
, 
_¬gs
...)

	)

23 
	$äÿpi_ioùl
(
äc_ioùl_t
 *
¬g
)

25 
rv
, 
fd
;

26 
fd
 = 
	`İ’
(
FRC_DEVICE_PATH
, 
O_RDWR
);

27 if(
fd
 < 0)

29 
	`FRCAPI_ERROR
("Cª'ˆİ’ %s.\n", 
FRC_DEVICE_PATH
);

30  
FRE_OPEN
;

34 ià(
¬g
->
ty³
 =ğ
CMD_TYPE_USER
)

36 
	`FRCAPI_DEBUG
("%s.%d\n", 
__func__
,
__LINE__
);

37 
rv
 = 
	`ioùl
(
fd
, 
IOCTL_FRCORE_REQUEST
, 
¬g
);

39 if(
¬g
->
ty³
 =ğ
CMD_TYPE_DRV
)

41 
	`FRCAPI_DEBUG
("%s.%d\n", 
__func__
,
__LINE__
);

42 
rv
 = 
	`ioùl
(
fd
, 
IOCTL_FRCDRV_REQUEST
, 
¬g
);

44 
	`şo£
(
fd
);

45 ià(
rv
 !ğ
FRE_SUCCESS
)

47 
	`FRCAPI_DEBUG
("IoùÈç:„v = %d!\n", 
rv
);

48  
FRE_IOCTL
;

51 ià(
¬g
->
rv
 !ğ
FRE_SUCCESS
)

53 
	`FRCAPI_DEBUG
("IoùÈç:‡rg->rv = %d!\n", 
¬g
->
rv
);

54  
¬g
->
rv
;

58  
FRE_SUCCESS
;

59 
	}
}

62 
	$äÿpi_ä_¡©us_g‘
(
äc_ä_¡©us_t
 *
¡©us
)

64 
rv
;

65 
äc_ioùl_t
 
¬g
;

67 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

69 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

70 
¬g
.
cmd
 = 
USER_CMD_GET_FR_STATUS
;

71 
¬g
.
šput
 = 
NULL
;

72 
¬g
.
’
 = 0;

73 
¬g
.
ouut
 = (*)
¡©us
;

74 
¬g
.
Ş’
 = (
äc_ä_¡©us_t
);

76 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

78  
rv
;

80 
	}
}

83 
	$äÿpi_ä_’abË
(
ušt8_t
 
’abË
)

85 
rv
;

86 
äc_ioùl_t
 
¬g
;

88 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

90 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

91 
¬g
.
cmd
 = 
USER_CMD_FR_ENABLE
;

92 
¬g
.
šput
 = (*)(&
’abË
);

93 
¬g
.
’
 = 1;

94 
¬g
.
ouut
 = 
NULL
;

95 
¬g
.
Ş’
 = 0;

97 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

99  
rv
;

101 
	}
}

104 
	$äÿpi_ä_age_time_£t
(
ušt8_t
 
age
)

106 
rv
;

107 
äc_ioùl_t
 
¬g
;

109 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

111 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

112 
¬g
.
cmd
 = 
USER_CMD_SET_AGE_TIME
;

113 
¬g
.
šput
 = (*)(&
age
);

114 
¬g
.
’
 = 1;

115 
¬g
.
ouut
 = 
NULL
;

116 
¬g
.
Ş’
 = 0;

118 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

120  
rv
;

122 
	}
}

125 
	$äÿpi_ä_disÜd”_d•th_£t
(
ušt8_t
 
disÜd”
)

127 
rv
;

128 
äc_ioùl_t
 
¬g
;

130 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

132 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

133 
¬g
.
cmd
 = 
USER_CMD_SET_DISORDER_DEPTH
;

134 
¬g
.
šput
 = (*)(&
disÜd”
);

135 
¬g
.
’
 = 1;

136 
¬g
.
ouut
 = 
NULL
;

137 
¬g
.
Ş’
 = 0;

139 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

141  
rv
;

143 
	}
}

145 
	$äÿpi_ä_»Œªs_time_£t
(
ušt8_t
 
»Œªs
)

147 
rv
;

148 
äc_ioùl_t
 
¬g
;

150 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

152 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

153 
¬g
.
cmd
 = 
USER_CMD_SET_RETRANS_TIME
;

154 
¬g
.
šput
 = (*)(&
»Œªs
);

155 
¬g
.
’
 = 1;

156 
¬g
.
ouut
 = 
NULL
;

157 
¬g
.
Ş’
 = 
NULL
;

159 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

161  
rv
;

163 
	}
}

166 
	$äÿpi_s¢_g‘
(
äc_ä_tu¶e_t
 *
ä_tu¶e
, 
äc_ä_£ssiÚ_¡©_t
 *
ä_¡©
)

168 
rv
;

169 
äc_ioùl_t
 
¬g
;

173 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

178 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

179 
¬g
.
cmd
 = 
USER_CMD_SSN_GET_FIVETUPLE
;

180 
¬g
.
šput
 = (*)
ä_tu¶e
;

181 
¬g
.
’
 = (
äc_ä_tu¶e_t
);

182 
¬g
.
ouut
 = (*)
ä_¡©
;

183 
¬g
.
Ş’
 = (
äc_ä_£ssiÚ_¡©_t
);

185 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

187  
rv
;

189 
	}
}

191 
	$äÿpi_s¢_buck‘_g‘
(
ušt32_t
 
hash
, 
äc_ä_hash_£ssiÚ_t
 *
hash_£ssiÚ
)

193 
rv
;

194 
äc_ioùl_t
 
¬g
;

196 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

198 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

199 
¬g
.
cmd
 = 
USER_CMD_SSN_BUCKET_GET
;

200 
¬g
.
šput
 = (*)(&
hash
);

201 
¬g
.
’
 = 4;

202 
¬g
.
ouut
 = (*)
hash_£ssiÚ
;

203 
¬g
.
Ş’
 = (
äc_ä_hash_£ssiÚ_t
);

205 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

207  
rv
;

209 
	}
}

212 
	$äÿpi_s¢_m©ch
(
äc_s¢_m©ch_t
 *
s¢_m©ch
, 
ušt64_t
 *
num
)

214 
rv
;

215 
äc_ioùl_t
 
¬g
;

217 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

219 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

220 
¬g
.
cmd
 = 
USER_CMD_SSN_MATCH
;

221 
¬g
.
šput
 = (*)
s¢_m©ch
;

222 
¬g
.
’
 = (
äc_s¢_m©ch_t
);

223 
¬g
.
ouut
 = (*)
num
;

224 
¬g
.
Ş’
 = 8;

226 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

228  
rv
;

229 
	}
}

232 
	$äÿpi_ruË_¡©us_g‘
(
ušt8_t
 *
’abË
)

234 
rv
;

235 
äc_ioùl_t
 
¬g
;

237 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

239 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

240 
¬g
.
cmd
 = 
USER_CMD_GET_RULE_STATUS
;

241 
¬g
.
šput
 = 
NULL
;

242 
¬g
.
’
 = 0;

243 
¬g
.
ouut
 = (*)
’abË
;

244 
¬g
.
Ş’
 = 1;

246 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

248  
rv
;

250 
	}
}

253 
	$äÿpi_ruË_’abË
(
ušt8_t
 
’abË
)

255 
rv
;

256 
äc_ioùl_t
 
¬g
;

258 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

260 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

261 
¬g
.
cmd
 = 
USER_CMD_RULE_ENABLE
;

262 
¬g
.
šput
 = (*)(&
’abË
);

263 
¬g
.
’
 = 1;

264 
¬g
.
ouut
 = 
NULL
;

265 
¬g
.
Ş’
 = 0;

267 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

269  
rv
;

270 
	}
}

272 
	$äÿpi_ruË_add
(
äc_ruË_t
 *
ruË
)

274 
rv
;

275 
äc_ioùl_t
 
¬g
;

277 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

279 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

280 
¬g
.
cmd
 = 
USER_CMD_ADD_RULE
;

281 
¬g
.
šput
 = (*)
ruË
;

282 
¬g
.
’
 = (
äc_ruË_t
);

283 
¬g
.
ouut
 = 
NULL
;

284 
¬g
.
Ş’
 = 0;

286 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

288  
rv
;

289 
	}
}

291 
	$äÿpi_ruË_d–
(
äc_ruË_İ_š_t
 *
ruË_d–_š
, 
ušt16_t
 *
num
)

293 
rv
;

294 
äc_ioùl_t
 
¬g
;

296 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

298 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

299 
¬g
.
cmd
 = 
USER_CMD_DEL_RULE
;

300 
¬g
.
šput
 = (*)
ruË_d–_š
;

301 
¬g
.
’
 = (
äc_ruË_İ_š_t
);

302 
¬g
.
ouut
 = (*)
num
;

303 
¬g
.
Ş’
 = 2;

305 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

307  
rv
;

309 
	}
}

311 
	$äÿpi_ruË_¡©_g‘
(
äc_ruË_İ_š_t
 *
¡©_š
, 
äc_ruË_¡©_out_t
 *
¡©_out
)

313 
rv
;

314 
äc_ioùl_t
 
¬g
;

316 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

318 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

319 
¬g
.
cmd
 = 
USER_CMD_GET_RULE
;

320 
¬g
.
šput
 = (*)
¡©_š
;

321 
¬g
.
’
 = (
äc_ruË_İ_š_t
);

322 
¬g
.
ouut
 = (*)
¡©_out
;

323 
¬g
.
Ş’
 = (
äc_ruË_¡©_out_t
);

325 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

327  
rv
;

329 
	}
}

332 
	$äÿpi_ruË_út_g‘
(
äc_ruË_İ_š_t
 *
ruË_út_š
, 
äc_ruË_pkt_¡©_t
 *
út_out
)

334 
rv
;

335 
i
;

337 
äc_ruË_¡©_out_t
 
¡©_out
;

339 
	`mem£t
(&
¡©_out
, 0, (
äc_ruË_¡©_out_t
));

341 
rv
 = 
	`äÿpi_ruË_¡©_g‘
(
ruË_út_š
, &
¡©_out
);

343 
i
 = 0; i < 
ruË_út_š
->
num
; i ++)

345 
út_out
->
pkts
 +ğ
¡©_out
.
ruË_¡©
[
i
].
¡©
.pkts;

346 
út_out
->
by‹s
 +ğ
¡©_out
.
ruË_¡©
[
i
].
¡©
.bytes;

349 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

350 
¬g
.
cmd
 = 
USER_CMD_GET_RULE_CNT
;

351 
¬g
.
šput
 = (*)
ruË_út_š
;

352 
¬g
.
’
 = (
äc_ruË_İ_š_t
);

353 
¬g
.
ouut
 = (*)
út_out
;

354 
¬g
.
Ş’
 = (
äc_ruË_pkt_¡©_t
);

358  
rv
;

359 
	}
}

363 
	#UP16
(
_buf
, 
_v¬
) \

364 
_v¬
 = (*(
_buf
) & 0xff) << 8; \

365 
_v¬
 |ğ(*(
_buf
 + 1è& 0xff);

	)

367 
	$äÿpi_ruË_¡©_ş—r
(
äc_ruË_İ_š_t
 *
ş—r_¡©_š
, 
ušt16_t
 *
num
)

369 
rv
;

370 
äc_ioùl_t
 
¬g
;

371 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

372 
ušt16_t
 
ş—r_num
;

374 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

375 
¬g
.
cmd
 = 
USER_CMD_CLEAN_RULE_STAT
;

376 
¬g
.
šput
 = (*)
ş—r_¡©_š
;

377 
¬g
.
’
 = (
äc_ruË_İ_š_t
);

378 
¬g
.
ouut
 = (*)
num
;

379 
¬g
.
Ş’
 = 2;

381 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

382 
	`UP16
((
ušt8_t
 *)
num
, 
ş—r_num
);

383 *
num
 = 
ş—r_num
;

385  
rv
;

386 
	}
}

388 
	$äÿpi_ruË_ş—r
(
äc_ruË_İ_š_t
 *
ruË_d–_š
, 
ušt16_t
 *
num
)

390 
rv
;

391 
äc_ioùl_t
 
¬g
;

392 
ušt16_t
 
ş—r_num
;

393 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

395 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

396 
¬g
.
cmd
 = 
USER_CMD_CLEAN_ALL_RULE
;

397 
¬g
.
šput
 = (*)
ruË_d–_š
;

398 
¬g
.
’
 = (
äc_ruË_İ_š_t
);

399 
¬g
.
ouut
 = (*)
num
;

400 
¬g
.
Ş’
 = 2;

402 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

403 
	`UP16
((
ušt8_t
 *)
num
, 
ş—r_num
);

404 *
num
 = 
ş—r_num
;

405  
rv
;

406 
	}
}

408 
	$äÿpi_ruË_upd©e
()

410 
rv
;

411 
äc_ioùl_t
 
¬g
;

412 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

414 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

415 
¬g
.
cmd
 = 
USER_CMD_UPDATE_RULE
;

416 
¬g
.
šput
 = 
NULL
;

417 
¬g
.
’
 = 0;

418 
¬g
.
ouut
 = 
NULL
;

419 
¬g
.
Ş’
 = 0;

421 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

422 ià(
FRE_TIMEOUT
 =ğ
rv
)

424 
	`¦“p
(30);

425 
rv
 = 
FRE_SUCCESS
;

428  
rv
;

429 
	}
}

431 
	$äÿpi_ruË_num_g‘
(
ušt16_t
 *
num
)

433 
rv
;

434 
äc_ioùl_t
 
¬g
;

435 
ušt16_t
 
ruË_num
;

437 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

439 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

440 
¬g
.
cmd
 = 
USER_CMD_GET_RULE_NUM
;

441 
¬g
.
šput
 = (*)
NULL
;

442 
¬g
.
’
 = 0;

443 
¬g
.
ouut
 = (*)
num
;

444 
¬g
.
Ş’
 = 2;

446 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

447 
	`UP16
((
ušt8_t
 *)
num
, 
ruË_num
);

448 *
num
 = 
ruË_num
;

449  
rv
;

450 
	}
}

454 
	$äÿpi_ruË_m©ch
(
äc_ruË_¡©_t
 *
ruË_¡©
, 
äc_ruË_t
 *
ruË
, 
ušt16_t
 
ruË_num
, ušt16_ˆ*
m©ch_num
)

456 
i
;

459 
i
 = 0; i < 
ruË_num
; i ++)

464 ià((
ruË
->
s
 =ğ
ruË_¡©
[
i
].rule.sip) &&

465 (
ruË
->
d
 =ğ
ruË_¡©
[
i
].rule.dip) &&

466 (
ruË
->
¥
 =ğ
ruË_¡©
[
i
].rule.sp) &&

467 (
ruË
->
dp
 =ğ
ruË_¡©
[
i
].rule.dp) &&

468 (
ruË
->
´Ùo
 =ğ
ruË_¡©
[
i
].rule.proto))

471 (*
m©ch_num
) ++;

478  
FRE_SUCCESS
;

479 
	}
}

482 #ià
FRC_CONFIG_TWO_TUPLE


483 
	$äÿpi_aş_¡©us_g‘
(
ušt8_t
 *
’abË
)

485 
rv
;

486 
äc_ioùl_t
 
¬g
;

488 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

490 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

491 
¬g
.
cmd
 = 
USER_CMD_GET_ACL_STATUS
;

492 
¬g
.
šput
 = 
NULL
;

493 
¬g
.
’
 = 0;

494 
¬g
.
ouut
 = (*)
’abË
;

495 
¬g
.
Ş’
 = 1;

497 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

499  
rv
;

501 
	}
}

504 
	$äÿpi_aş_’abË
(
ušt8_t
 
’abË
)

506 
rv
;

507 
äc_ioùl_t
 
¬g
;

509 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

511 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

512 
¬g
.
cmd
 = 
USER_CMD_ACL_ENABLE
;

513 
¬g
.
šput
 = (*)(&
’abË
);

514 
¬g
.
’
 = 1;

515 
¬g
.
ouut
 = 
NULL
;

516 
¬g
.
Ş’
 = 0;

518 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

520  
rv
;

521 
	}
}

523 
	$äÿpi_aş_add
(
äc_aş_t
 *
aş
)

525 
rv
;

526 
äc_ioùl_t
 
¬g
;

528 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

530 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

531 
¬g
.
cmd
 = 
USER_CMD_ADD_ACL
;

532 
¬g
.
šput
 = (*)
aş
;

533 
¬g
.
’
 = (
äc_aş_t
);

534 
¬g
.
ouut
 = 
NULL
;

535 
¬g
.
Ş’
 = 0;

537 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

539  
rv
;

540 
	}
}

542 
	$äÿpi_aş_d–
(
äc_aş_İ_š_t
 *
aş_d–_š
, 
ušt16_t
 *
num
)

544 
rv
;

545 
äc_ioùl_t
 
¬g
;

547 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

549 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

550 
¬g
.
cmd
 = 
USER_CMD_DEL_ACL
;

551 
¬g
.
šput
 = (*)
aş_d–_š
;

552 
¬g
.
’
 = (
äc_aş_İ_š_t
);

553 
¬g
.
ouut
 = (*)
num
;

554 
¬g
.
Ş’
 = 2;

556 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

558  
rv
;

560 
	}
}

562 
	$äÿpi_aş_¡©_g‘
(
äc_aş_İ_š_t
 *
¡©_š
, 
äc_aş_¡©_out_t
 *
¡©_out
)

564 
rv
;

565 
äc_ioùl_t
 
¬g
;

567 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

569 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

570 
¬g
.
cmd
 = 
USER_CMD_GET_ACL
;

571 
¬g
.
šput
 = (*)
¡©_š
;

572 
¬g
.
’
 = (
äc_aş_İ_š_t
);

573 
¬g
.
ouut
 = (*)
¡©_out
;

574 
¬g
.
Ş’
 = (
äc_aş_¡©_out_t
);

576 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

578  
rv
;

580 
	}
}

582 
	$äÿpi_aş_hash_bË_¡©_g‘
(
äc_aş_hash_bË_İ_š_t
 *
¡©_š
,

583 
äc_aş_hash_bË_¡©_out_t
 *
¡©_out
)

585 
rv
;

586 
äc_ioùl_t
 
¬g
;

588 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

590 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

591 
¬g
.
cmd
 = 
USER_CMD_GET_ACL_HASH_TABLE
;

592 
¬g
.
šput
 = (*)
¡©_š
;

593 
¬g
.
’
 = (
äc_aş_hash_bË_İ_š_t
);

594 
¬g
.
ouut
 = (*)
¡©_out
;

595 
¬g
.
Ş’
 = (
äc_aş_hash_bË_¡©_out_t
);

597 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

599  
rv
;

601 
	}
}

603 
	#UP16
(
_buf
, 
_v¬
) \

604 
_v¬
 = (*(
_buf
) & 0xff) << 8; \

605 
_v¬
 |ğ(*(
_buf
 + 1è& 0xff);

	)

607 
	$äÿpi_aş_¡©_ş—r
(
äc_aş_İ_š_t
 *
ş—r_¡©_š
, 
ušt16_t
 *
num
)

609 
rv
;

610 
äc_ioùl_t
 
¬g
;

611 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

612 
ušt16_t
 
ş—r_num
;

614 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

615 
¬g
.
cmd
 = 
USER_CMD_CLEAN_ACL_STAT
;

616 
¬g
.
šput
 = (*)
ş—r_¡©_š
;

617 
¬g
.
’
 = (
äc_aş_İ_š_t
);

618 
¬g
.
ouut
 = (*)
num
;

619 
¬g
.
Ş’
 = 2;

621 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

622 
	`UP16
((
ušt8_t
 *)
num
, 
ş—r_num
);

623 *
num
 = 
ş—r_num
;

625  
rv
;

626 
	}
}

628 
	$äÿpi_aş_ş—r
(
äc_aş_İ_š_t
 *
aş_d–_š
, 
ušt16_t
 *
num
)

630 
rv
;

631 
äc_ioùl_t
 
¬g
;

632 
ušt16_t
 
ş—r_num
;

633 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

635 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

636 
¬g
.
cmd
 = 
USER_CMD_CLEAN_ALL_ACL
;

637 
¬g
.
šput
 = (*)
aş_d–_š
;

638 
¬g
.
’
 = (
äc_aş_İ_š_t
);

639 
¬g
.
ouut
 = (*)
num
;

640 
¬g
.
Ş’
 = 2;

642 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

643 
	`UP16
((
ušt8_t
 *)
num
, 
ş—r_num
);

644 *
num
 = 
ş—r_num
;

645  
rv
;

646 
	}
}

648 
	$äÿpi_aş_num_g‘
(
ušt16_t
 *
num
)

650 
rv
;

651 
äc_ioùl_t
 
¬g
;

652 
ušt16_t
 
aş_num
;

654 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

656 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

657 
¬g
.
cmd
 = 
USER_CMD_GET_ACL_NUM
;

658 
¬g
.
šput
 = (*)
NULL
;

659 
¬g
.
’
 = 0;

660 
¬g
.
ouut
 = (*)
num
;

661 
¬g
.
Ş’
 = 2;

663 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

664 
	`UP16
((
ušt8_t
 *)
num
, 
aş_num
);

665 *
num
 = 
aş_num
;

666  
rv
;

667 
	}
}

671 
	$äÿpi_aş_m©ch
(
äc_aş_¡©_t
 *
aş_¡©
, 
äc_aş_t
 *
aş
, 
ušt16_t
 
aş_num
, ušt16_ˆ*
m©ch_num
)

673 
i
;

675 
i
 = 0; i < 
aş_num
; i ++)

677 ià((
aş
->
Úe_tu¶e
 =ğ
aş_¡©
[
i
].acl.one_tuple) &&

678 (
aş
->
´Ùo
 =ğ
aş_¡©
[
i
].acl.proto))

680 (*
m©ch_num
) ++;

685  
FRE_SUCCESS
;

686 
	}
}

690 
	$äÿpi_bdd_šfo_g‘
(
äc_bdd_šfo_out_t
 *
bdd_šfo
)

692 
rv
;

693 
äc_ioùl_t
 
¬g
;

695 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

697 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

698 
¬g
.
cmd
 = 
USER_CMD_GET_BDD_INFO
;

699 
¬g
.
šput
 = 
NULL
;

700 
¬g
.
’
 = 0;

701 
¬g
.
ouut
 = (*)
bdd_šfo
;

702 
¬g
.
Ş’
 = (
äc_bdd_šfo_out_t
);

704 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

706  
rv
;

707 
	}
}

709 
	$äÿpi_äcdrv_v”siÚ_g‘
(
äc_v”siÚ_t
 *
äcdrv
)

711 
rv
;

712 
äc_ioùl_t
 
¬g
;

714 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

716 
¬g
.
ty³
 = 
CMD_TYPE_DRV
;

717 
¬g
.
cmd
 = 
DRV_CMD_GET_VERSION
;

718 
¬g
.
šput
 = 
NULL
;

719 
¬g
.
’
 = 0;

720 
¬g
.
ouut
 = (*)
äcdrv
;

721 
¬g
.
Ş’
 = (
äc_v”siÚ_t
);

723 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

725  
rv
;

727 
	}
}

730 
	$äÿpi_bdd_¡©us_g‘
(
äc_bdd_¡©us_out_t
 *
bdd_¡©us
)

732 
rv
;

733 
äc_ioùl_t
 
¬g
;

735 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

737 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

738 
¬g
.
cmd
 = 
USER_CMD_GET_BDD_STATUS
;

739 
¬g
.
šput
 = 
NULL
;

740 
¬g
.
’
 = 0;

741 
¬g
.
ouut
 = (*)
bdd_¡©us
;

742 
¬g
.
Ş’
 = (
äc_bdd_¡©us_out_t
);

744 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

746  
rv
;

747 
	}
}

749 
	$äÿpi_bdd_pow”off
()

751 
rv
;

752 
äc_ioùl_t
 
¬g
;

754 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

756 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

757 
¬g
.
cmd
 = 
USER_CMD_POWEROFF
;

758 
¬g
.
šput
 = 
NULL
;

759 
¬g
.
’
 = 0;

760 
¬g
.
ouut
 = 
NULL
;

761 
¬g
.
Ş’
 = 0;

763 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

765  
rv
;

766 
	}
}

768 
	$äÿpi_bdd_pÜt_’abË
(
äc_bdd_£t_pÜt_š_t
 *
£t_pÜt
)

770 
rv
;

771 
äc_ioùl_t
 
¬g
;

773 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

775 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

776 
¬g
.
cmd
 = 
USER_CMD_BDD_PORT_ENABLE
;

777 
¬g
.
šput
 = (*)
£t_pÜt
;

778 
¬g
.
’
 = (
äc_bdd_£t_pÜt_š_t
);

779 
¬g
.
ouut
 = 
NULL
;

780 
¬g
.
Ş’
 = 0;

782 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

784  
rv
;

785 
	}
}

787 
	$äÿpi_bdd_pÜt_loİback_£t
(
äc_bdd_£t_loİback_š_t
 *
mode
)

789 
rv
;

790 
äc_ioùl_t
 
¬g
;

792 
	`mem£t
(&
¬g
, 0 ,(
äc_ioùl_t
));

794 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

795 
¬g
.
cmd
 = 
USER_CMD_SET_LOOPBACK_MODE
;

796 
¬g
.
šput
 = (*)
mode
;

797 
¬g
.
’
 = (
äc_bdd_£t_loİback_š_t
);

798 
¬g
.
ouut
 = 
NULL
;

799 
¬g
.
Ş’
 = 0;

801 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

803  
rv
;

804 
	}
}

806 
	$äÿpi_bdd_log_cÚfig_£t
(
äc_bdd_log_š_t
 *
log_š
)

808 
rv
;

809 
äc_ioùl_t
 
¬g
;

811 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

813 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

814 
¬g
.
cmd
 = 
USER_CMD_CONFIG_LOG_SW
;

815 
¬g
.
šput
 = (*)
log_š
;

816 
¬g
.
’
 = (
äc_bdd_log_š_t
);

817 
¬g
.
ouut
 = 
NULL
;

818 
¬g
.
Ş’
 = 0;

820 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

822  
rv
;

823 
	}
}

825 
	$äÿpi_bdd_phy
(
äc_bdd_phy_t
 *
šput
, 
äc_phy_İ_t
 *
ouut
)

827 
rv
;

828 
äc_ioùl_t
 
¬g
;

829 
	`mem£t
(&
¬g
, 0 ,(
äc_ioùl_t
));

831 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

832 
¬g
.
’
 = 8;

833 
¬g
.
šput
 = &(šput->
phy
);

834 ià(!
šput
->
İ
)

836 
¬g
.
cmd
 = 
USER_CMD_GET_PHY
;

837 
¬g
.
ouut
 = output;

838 
¬g
.
Ş’
 = 8;

842 
¬g
.
cmd
 = 
USER_CMD_SET_PHY
;

843 
¬g
.
ouut
 = 
NULL
;

844 
¬g
.
Ş’
 = 0;

847 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

849  
rv
;

850 
	}
}

853 
	$äÿpi_bdd_ıld
(
äc_bdd_ıld_t
 *
šput
, 
äc_ıld_İ_t
 *
ouut
)

855 
rv
;

856 
äc_ioùl_t
 
¬g
;

858 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

860 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

861 
¬g
.
šput
 = &(šput->
ıld
);

862 
¬g
.
’
 = (
äc_ıld_İ_t
);

863 ià(!
šput
->
İ
)

865 
¬g
.
cmd
 = 
USER_CMD_GET_CPLD
;

866 
¬g
.
ouut
 = output;

867 
¬g
.
Ş’
 = (
äc_ıld_İ_t
);

871 
¬g
.
cmd
 = 
USER_CMD_SET_CPLD
;

872 
¬g
.
ouut
 = 
NULL
;

873 
¬g
.
Ş’
 = 0;

876 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

878  
rv
;

879 
	}
}

881 
	$äÿpi_bdd_wÜkmode_£t
(
äc_bdd_wÜkmode_£t_š_t
 *
wÜkmode
)

883 
rv
;

884 
äc_ioùl_t
 
¬g
;

886 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

888 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

889 
¬g
.
cmd
 = 
USER_CMD_SET_WORK_MODE
;

890 
¬g
.
šput
 = (*)
wÜkmode
;

891 
¬g
.
’
 = (
äc_bdd_wÜkmode_£t_š_t
);

892 
¬g
.
ouut
 = 
NULL
;

893 
¬g
.
Ş’
 = 0;

895 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

897  
rv
;

898 
	}
}

901 
	$äÿpi_bdd_fÜû_lšk
(
äc_bdd_fÜû_lšk_š_t
 *
fÜû_lšk
)

903 
rv
;

904 
äc_ioùl_t
 
¬g
;

906 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

908 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

909 
¬g
.
cmd
 = 
USER_CMD_FORCE_LINK
;

910 
¬g
.
šput
 = (*)
fÜû_lšk
;

911 
¬g
.
’
 = (
äc_bdd_fÜû_lšk_š_t
);

912 
¬g
.
ouut
 = 
NULL
;

913 
¬g
.
Ş’
 = 0;

915 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

917  
rv
;

918 
	}
}

921 
	$äÿpi_dma_block_£t
(
ušt8_t
 
size
)

923 
rv
;

924 
äc_ioùl_t
 
¬g
;

926 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

928 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

929 
¬g
.
cmd
 = 
USER_CMD_SET_DMA_BLOCK_SIZE
;

930 
¬g
.
šput
 = (*)&
size
;

931 
¬g
.
’
 = 1;

932 
¬g
.
ouut
 = 
NULL
;

933 
¬g
.
Ş’
 = 0;

935 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

937  
rv
;

938 
	}
}

940 
	$äÿpi_dma_mem_»ad
(
äc_bdd_dma_»ad_š_t
 *
dma_š
, 
ušt8_t
 *
d©a
)

942 
rv
;

943 
äc_ioùl_t
 
¬g
;

945 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

947 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

948 
¬g
.
cmd
 = 
USER_CMD_READ_DMA
;

949 
¬g
.
šput
 = (*)
dma_š
;

950 
¬g
.
’
 = (
äc_bdd_dma_»ad_š_t
);

951 
¬g
.
ouut
 = (*)
d©a
;

952 
¬g
.
Ş’
 = 
dma_š
->
size
;

954 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

956  
rv
;

957 
	}
}

959 
	$äÿpi_¡©_ş—r
()

961 
rv
;

962 
äc_ioùl_t
 
¬g
;

964 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

966 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

967 
¬g
.
cmd
 = 
USER_CMD_CLEAR_STAT
;

968 
¬g
.
šput
 = 
NULL
;

969 
¬g
.
’
 = 0;

970 
¬g
.
ouut
 = 
NULL
;

971 
¬g
.
Ş’
 = 0;

973 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

975  
rv
;

976 
	}
}

978 
	$äÿpi_pkt_¡©_g‘
(
äc_¡©_İ_š_t
 *
šput
, 
ušt64_t
 *
¡©
)

980 
rv
;

981 
äc_ioùl_t
 
¬g
;

983 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

985 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

986 
¬g
.
cmd
 = 
USER_CMD_GET_STAT
;

987 
¬g
.
šput
 = (*)input;

988 
¬g
.
’
 = (
äc_¡©_İ_š_t
);

989 
¬g
.
ouut
 = (*)
¡©
;

990 
¬g
.
Ş’
 = (
ušt64_t
è* 
šput
->
num
;

992 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

994  
rv
;

995 
	}
}

998 
	$äÿpi_chª_Ü_´_s¢_¡¬t
(
ušt64_t
 
ty³
, 
äc_dma_s¢_chª_desc_t
 *
desc
)

1000 
rv
;

1001 
äc_ioùl_t
 
¬g
;

1003 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

1005 
¬g
.
ty³
 = 
CMD_TYPE_DRV
;

1006 
¬g
.
cmd
 = 
DRV_CMD_GET_POOL_AND_RING_ADDR
;

1007 
¬g
.
šput
 = (*)(&
ty³
);

1008 
¬g
.
’
 = 8;

1009 
¬g
.
ouut
 = (*)
desc
;

1010 
¬g
.
Ş’
 = (
äc_dma_s¢_chª_desc_t
);

1012 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

1014  
rv
;

1015 
	}
}

1017 
	$äÿpi_chª_Ü_´_ruË_Ü_udp_¡¬t
(
ušt64_t
 
ty³
, 
äc_dma_chª_desc_t
 *
desc
)

1019 
rv
;

1020 
äc_ioùl_t
 
¬g
;

1022 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

1024 
¬g
.
ty³
 = 
CMD_TYPE_DRV
;

1025 
¬g
.
cmd
 = 
DRV_CMD_GET_POOL_AND_RING_ADDR
;

1026 
¬g
.
šput
 = (*)(&
ty³
);

1027 
¬g
.
’
 = 8;

1028 
¬g
.
ouut
 = (*)
desc
;

1029 
¬g
.
Ş’
 = (
äc_dma_chª_desc_t
);

1031 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

1033  
rv
;

1034 
	}
}

1036 
	$äÿpi_chª_‹¡_¡¬t
(
ušt64_t
 *
chª
, 
ušt16_t
 *
Ş’
)

1038 *
ouut
 = 
NULL
;

1039 
äc_ioùl_t
 
¬g
;

1040 
fd
, 
rv
;

1042 
fd
 = 
	`İ’
(
FRC_DEVICE_PATH
, 
O_RDWR
);

1043 if(
fd
 < 0) {

1044 
	`FRCAPI_ERROR
("Cª'ˆİ’ %s.\n", 
FRC_DEVICE_PATH
);

1045  
FRE_OPEN
;

1048 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

1050 
¬g
.
ty³
 = 
CMD_TYPE_TEST
;

1051 
¬g
.
cmd
 = 
TEST_CMD_SIMPLE_PACKET_CHAN
;

1052 
¬g
.
’
 = 8;

1053 
¬g
.
šput
 = 
chª
;

1054 ià(
Ş’
 !ğ
NULL
 && 
ouut
 != NULL)

1056 
¬g
.
Ş’
 = *olen;

1057 
¬g
.
ouut
 = output;

1060 
¬g
.
ty³
)

1062 
CMD_TYPE_DRV
:

1063 
rv
 = 
	`ioùl
(
fd
, 
IOCTL_FRCDRV_REQUEST
, &
¬g
);

1065 
CMD_TYPE_TEST
:

1066 
CMD_TYPE_CTRL
:

1067 
CMD_TYPE_USER
:

1068 
rv
 = 
	`ioùl
(
fd
, 
IOCTL_FRCORE_REQUEST
, &
¬g
);

1071 
rv
 = 
FRE_UNSUPPORT
;

1075 
	`şo£
(
fd
);

1077 ià(
rv
 !ğ
FRE_SUCCESS
) {

1078 
	`FRCAPI_ERROR
("IoùÈç:„v = %d!\n", 
rv
);

1079  
FRE_IOCTL
;

1082 ià(
¬g
.
rv
 !ğ
FRE_SUCCESS
)

1084  
¬g
.
rv
;

1087 ià(
Ş’
 !ğ
NULL
)

1089 *
Ş’
 = 
¬g
.olen;

1092  
FRE_SUCCESS
;

1093 
	}
}

1095 
	$äÿpi_sysšfo_g‘
(
äc_sy¡em_šfo_t
 *
ouut
)

1097 
rv
;

1098 
äc_ioùl_t
 
¬g
;

1100 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

1102 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

1103 
¬g
.
cmd
 = 
USER_CMD_GET_SYSINFO
;

1104 
¬g
.
šput
 = 
NULL
;

1105 
¬g
.
’
 = 0;

1106 
¬g
.
ouut
 = (*)output;

1107 
¬g
.
Ş’
 = (
äc_sy¡em_šfo_t
);

1109 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

1111  
rv
;

1112 
	}
}

1114 #ià
FRC_CONFIG_UDP


1115 
	$äÿpi_udp_¡©us_g‘
(
ušt8_t
 *
’abË
)

1117 
rv
;

1118 
äc_ioùl_t
 
¬g
;

1120 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

1122 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

1123 
¬g
.
cmd
 = 
USER_CMD_GET_UDP_STATUS
;

1124 
¬g
.
šput
 = 
NULL
;

1125 
¬g
.
’
 = 0;

1126 
¬g
.
ouut
 = (*)
’abË
;

1127 
¬g
.
Ş’
 = 1;

1129 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

1131  
rv
;

1133 
	}
}

1136 
	$äÿpi_udp_’abË
(
ušt8_t
 
’abË
)

1138 
rv
;

1139 
äc_ioùl_t
 
¬g
;

1141 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

1143 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

1144 
¬g
.
cmd
 = 
USER_CMD_UDP_ENABLE
;

1145 
¬g
.
šput
 = (*)(&
’abË
);

1146 
¬g
.
’
 = 1;

1147 
¬g
.
ouut
 = 
NULL
;

1148 
¬g
.
Ş’
 = 0;

1150 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

1152  
rv
;

1153 
	}
}

1157 #ià
FRC_CONFIG_VLAN_CHECK


1158 
	$äÿpi_vÏn_check_¡©us_g‘
(
äc_vÏn_check_·¿_t
 *
vÏn_check_·¿
)

1160 
rv
;

1161 
äc_ioùl_t
 
¬g
;

1163 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

1165 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

1166 
¬g
.
cmd
 = 
USER_CMD_GET_VLAN_CHECK_PARAMETER
;

1167 
¬g
.
šput
 = 
NULL
;

1168 
¬g
.
’
 = 0;

1169 
¬g
.
ouut
 = (*)
vÏn_check_·¿
;

1170 
¬g
.
Ş’
 = (
äc_vÏn_check_·¿_t
);

1172 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

1174  
rv
;

1176 
	}
}

1179 
	$äÿpi_vÏn_check_£t_·¿m‘”
(
äc_vÏn_check_·¿_t
 *
vÏn_check_·¿
)

1181 
rv
;

1182 
äc_ioùl_t
 
¬g
;

1184 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

1186 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

1187 
¬g
.
cmd
 = 
USER_CMD_SET_VLAN_CHECK_PARAMETER
;

1188 
¬g
.
šput
 = (*)(
vÏn_check_·¿
);

1189 
¬g
.
’
 = (
äc_vÏn_check_·¿_t
);

1190 
¬g
.
ouut
 = 
NULL
;

1191 
¬g
.
Ş’
 = 0;

1193 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

1195  
rv
;

1196 
	}
}

1198 
	$äÿpi_vÏn_check_¡©_ş—r
()

1200 
rv
;

1201 
äc_ioùl_t
 
¬g
;

1203 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

1205 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

1206 
¬g
.
cmd
 = 
USER_CMD_CLEAR_VLAN_CHECK_STAT
;

1207 
¬g
.
šput
 = 
NULL
;

1208 
¬g
.
’
 = 0;

1209 
¬g
.
ouut
 = 
NULL
;

1210 
¬g
.
Ş’
 = 0;

1212 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

1214  
rv
;

1215 
	}
}

1217 
	$äÿpi_vÏn_check_¡©_g‘
(
äc_vÏn_İ_š_t
 *
šput
, 
ušt64_t
 *
¡©
)

1219 
rv
;

1220 
äc_ioùl_t
 
¬g
;

1222 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

1224 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

1225 
¬g
.
cmd
 = 
USER_CMD_GET_VLAN_CHECK_STAT
;

1226 
¬g
.
šput
 = (*)input;

1227 
¬g
.
’
 = (
äc_vÏn_İ_š_t
);

1228 
¬g
.
ouut
 = (*)
¡©
;

1229 
¬g
.
Ş’
 = (
ušt64_t
è* 
šput
->
num
;

1231 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

1233  
rv
;

1234 
	}
}

1237 #ià
FRC_CONFIG_MAC_STATISTICS


1238 
	$äÿpi_mac_¡©_£t
(
äc_mac_¡©_š_t
 *
šput
, 
äcÜe_u£r_cmd_e
 
cmd
)

1240 
rv
;

1241 
äc_ioùl_t
 
¬g
;

1243 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

1244 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

1245 
¬g
.
cmd
 = cmd;

1246 
¬g
.
šput
 = (*)input;

1247 
¬g
.
’
 = (
äc_mac_¡©_š_t
);

1248 
¬g
.
ouut
 = 
NULL
;

1249 
¬g
.
Ş’
 = 0;

1251 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

1253  
rv
;

1254 
	}
}

1256 
	$äÿpi_mac_¡©_g‘
(
äc_mac_¡©_š_t
 *
šput
, 
äc_mac_¡©_out_t
 *
¡©
, 
äcÜe_u£r_cmd_e
 
cmd
)

1258 
rv
;

1259 
äc_ioùl_t
 
¬g
;

1261 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

1262 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

1263 
¬g
.
cmd
 = cmd;

1264 
¬g
.
šput
 = (*)input;

1265 
¬g
.
’
 = (
äc_mac_¡©_š_t
);

1266 
¬g
.
ouut
 = (*è
¡©
;

1267 
¬g
.
Ş’
 = (
äc_mac_¡©_out_t
) ;

1269 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

1271  
rv
;

1272 
	}
}

1273 
	$äÿpi_mac_¡©_g‘_®l
(
äc_mac_¡©_š_t
 *
šput
, 
äc_mac_¡©_out_t
 *
¡©
, 
ušt16_t
 
num
, 
äcÜe_u£r_cmd_e
 
cmd
)

1275 
rv
;

1276 
äc_ioùl_t
 
¬g
;

1278 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

1279 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

1280 
¬g
.
cmd
 = cmd;

1281 
¬g
.
šput
 = (*)input;

1282 
¬g
.
’
 = (
äc_mac_¡©_š_t
);

1283 
¬g
.
ouut
 = (*è
¡©
;

1284 
¬g
.
Ş’
 = (
äc_mac_¡©_out_t
);

1286 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

1288  
rv
;

1289 
	}
}

1293 #ià
FRC_CONFIG_TIMESTAMP_CHECK


1294 
	$äÿpi_time¡amp_check_¡©_ş—r
()

1296 
rv
;

1297 
äc_ioùl_t
 
¬g
;

1299 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

1301 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

1302 
¬g
.
cmd
 = 
USER_CMD_CLEAR_TIMESTAMP_CHECK_STAT
;

1303 
¬g
.
šput
 = 
NULL
;

1304 
¬g
.
’
 = 0;

1305 
¬g
.
ouut
 = 
NULL
;

1306 
¬g
.
Ş’
 = 0;

1308 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

1310  
rv
;

1311 
	}
}

1313 
	$äÿpi_time¡amp_check_¡©_g‘
(
äc_time¡amp_İ_š_t
 *
šput
, 
ušt64_t
 *
¡©
)

1315 
rv
;

1316 
äc_ioùl_t
 
¬g
;

1318 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

1320 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

1321 
¬g
.
cmd
 = 
USER_CMD_GET_TIMESTAMP_CHECK_STAT
;

1322 
¬g
.
šput
 = (*)input;

1323 
¬g
.
’
 = (
äc_time¡amp_İ_š_t
);

1324 
¬g
.
ouut
 = (*)
¡©
;

1325 
¬g
.
Ş’
 = (
ušt64_t
è* 
šput
->
num
;

1327 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

1329  
rv
;

1330 
	}
}

1333 #ià
FRC_CONFIG_IPC


1334 
	$äÿpi_c_misc_g‘
(
c_misc_t
 *
misc
)

1336 
rv
;

1337 
äc_ioùl_t
 
¬g
;

1339 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

1340 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

1341 
¬g
.
cmd
 = 
USER_CMD_IPC_MISC_GET
;

1342 
¬g
.
šput
 = 
NULL
;

1343 
¬g
.
’
 = 0;

1344 
¬g
.
ouut
 = (*è
misc
;

1345 
¬g
.
Ş’
 = (
c_misc_t
);

1347 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

1349  
rv
;

1350 
	}
}

1353 
	$äÿpi_c_misc_£t
(
c_misc_t
 *
misc
)

1355 
rv
;

1356 
äc_ioùl_t
 
¬g
;

1358 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

1359 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

1360 
¬g
.
cmd
 = 
USER_CMD_IPC_MISC_SET
;

1361 
¬g
.
šput
 = (*è
misc
;

1362 
¬g
.
’
 = (
c_misc_t
);

1363 
¬g
.
ouut
 = 
NULL
;

1364 
¬g
.
Ş’
 = 0;

1366 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

1368  
rv
;

1369 
	}
}

1371 
	$äÿpi_c_cur_g‘
(
c_cur_t
 *
cur
)

1373 
rv
;

1374 
äc_ioùl_t
 
¬g
;

1376 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

1377 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

1378 
¬g
.
cmd
 = 
USER_CMD_IPC_CUR_GET
;

1379 
¬g
.
šput
 = 
NULL
;

1380 
¬g
.
’
 = 0;

1381 
¬g
.
ouut
 = (*è
cur
;

1382 
¬g
.
Ş’
 = (
c_cur_t
);

1384 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

1386  
rv
;

1387 
	}
}

1390 
	$äÿpi_c_cur_£t
(
c_cur_t
 *
cur
)

1392 
rv
;

1393 
äc_ioùl_t
 
¬g
;

1395 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

1396 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

1397 
¬g
.
cmd
 = 
USER_CMD_IPC_CUR_SET
;

1398 
¬g
.
šput
 = (*è
cur
;

1399 
¬g
.
’
 = (
c_cur_t
);

1400 
¬g
.
ouut
 = 
NULL
;

1401 
¬g
.
Ş’
 = 0;

1403 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

1405  
rv
;

1406 
	}
}

1408 
	$äÿpi_c_exp_g‘
(
c_exp_t
 *
exp
)

1410 
rv
;

1411 
äc_ioùl_t
 
¬g
;

1413 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

1414 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

1415 
¬g
.
cmd
 = 
USER_CMD_IPC_EXP_GET
;

1416 
¬g
.
šput
 = 
NULL
;

1417 
¬g
.
’
 = 0;

1418 
¬g
.
ouut
 = (*è
exp
;

1419 
¬g
.
Ş’
 = (
c_exp_t
);

1421 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

1423  
rv
;

1424 
	}
}

1427 
	$äÿpi_c_exp_£t
(
c_exp_t
 *
exp
)

1429 
rv
;

1430 
äc_ioùl_t
 
¬g
;

1432 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

1433 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

1434 
¬g
.
cmd
 = 
USER_CMD_IPC_EXP_SET
;

1435 
¬g
.
šput
 = (*è
exp
;

1436 
¬g
.
’
 = (
c_exp_t
);

1437 
¬g
.
ouut
 = 
NULL
;

1438 
¬g
.
Ş’
 = 0;

1440 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

1442  
rv
;

1443 
	}
}

1446 
	$äÿpi_c_š¡r_g‘
(
c_š¡r_cfg_t
 *
š¡r
)

1448 
rv
;

1449 
äc_ioùl_t
 
¬g
;

1451 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

1452 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

1453 
¬g
.
cmd
 = 
USER_CMD_IPC_INSTR_GET
;

1454 
¬g
.
šput
 = 
NULL
;

1455 
¬g
.
’
 = 0;

1456 
¬g
.
ouut
 = (*è
š¡r
;

1457 
¬g
.
Ş’
 = (
c_š¡r_cfg_t
);

1459 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

1461  
rv
;

1462 
	}
}

1465 
	$äÿpi_c_š¡r_£t
(
c_š¡r_cfg_t
 *
š¡r
)

1467 
rv
;

1468 
äc_ioùl_t
 
¬g
;

1470 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

1471 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

1472 
¬g
.
cmd
 = 
USER_CMD_IPC_INSTR_SET
;

1473 
¬g
.
šput
 = (*è
š¡r
;

1474 
¬g
.
’
 = (
c_š¡r_cfg_t
);

1475 
¬g
.
ouut
 = 
NULL
;

1476 
¬g
.
Ş’
 = 0;

1478 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

1480  
rv
;

1481 
	}
}

1484 
	$äÿpi_c_š¡r_·ylßd_£t
(
c_·ylßd_£t_š_t
 *
·ylßd_£t
)

1486 
rv
;

1487 
äc_ioùl_t
 
¬g
;

1489 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

1490 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

1491 
¬g
.
cmd
 = 
USER_CMD_IPC_INSTR_PAYLOAD_SET
;

1492 
¬g
.
šput
 = (*è
·ylßd_£t
;

1493 
¬g
.
’
 = (
c_·ylßd_£t_š_t
);

1494 
¬g
.
ouut
 = 
NULL
;

1495 
¬g
.
Ş’
 = 0;

1497 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

1499  
rv
;

1500 
	}
}

1503 #ià
FRC_CONFIG_VLAN_IV


1504 
	$äùw—k_c_hash4_mask_£t
(
äc_vÏn_hash_mask_t
 *
mask_£t
)

1506 
rv
;

1507 
äc_ioùl_t
 
¬g
;

1509 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

1510 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

1511 
¬g
.
cmd
 = 
USER_CMD_VLAN_V4_HASH_MASK_SET
;

1512 
¬g
.
šput
 = (*è
mask_£t
;

1513 
¬g
.
’
 = (
äc_vÏn_hash_mask_t
);

1514 
¬g
.
ouut
 = 
NULL
;

1515 
¬g
.
Ş’
 = 0;

1517 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

1519  
rv
;

1520 
	}
}

1523 
	$äùw—k_c_hash6_mask_£t
(
äc_vÏn_hash_mask_t
 *
mask_£t
)

1525 
rv
;

1526 
äc_ioùl_t
 
¬g
;

1528 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

1529 
¬g
.
ty³
 = 
CMD_TYPE_USER
;

1530 
¬g
.
cmd
 = 
USER_CMD_VLAN_V6_HASH_MASK_SET
;

1531 
¬g
.
šput
 = (*è
mask_£t
;

1532 
¬g
.
’
 = (
äc_vÏn_hash_mask_t
);

1533 
¬g
.
ouut
 = 
NULL
;

1534 
¬g
.
Ş’
 = 0;

1536 
rv
 = 
	`äÿpi_ioùl
(&
¬g
);

1538  
rv
;

1539 
	}
}

	@frcapi/frc_api.h

1 #iâdeà
__FRC_API_H__


2 
	#__FRC_API_H__


	)

4 
	~"äc_ioùl.h
"

5 
	~<sys/ioùl.h
>

6 
	~<fú.h
>

7 
	~"äc_ty³s.h
"

8 
	~"äc_cmd.h
"

9 
	~"äc_dma.h
"

10 
	~"äc_debug.h
"

16 
äÿpi_ä_¡©us_g‘
(
äc_ä_¡©us_t
 *
¡©us
);

17 
äÿpi_ä_’abË
(
ušt8_t
 
’abË
);

18 
äÿpi_ä_age_time_£t
(
ušt8_t
 
age
);

20 
äÿpi_ä_disÜd”_d•th_£t
(
ušt8_t
 
disÜd”
);

22 
äÿpi_s¢_g‘
(
äc_ä_tu¶e_t
 *
ä_tu¶e
, 
äc_ä_£ssiÚ_¡©_t
 *
ä_¡©
);

23 
äÿpi_s¢_buck‘_g‘
(
ušt32_t
 
hash
, 
äc_ä_hash_£ssiÚ_t
 *
hash_£ssiÚ
);

24 
äÿpi_s¢_m©ch
(
äc_s¢_m©ch_t
 *
s¢_m©ch
, 
ušt64_t
 *
num
);

28 
äÿpi_ruË_¡©us_g‘
(
ušt8_t
 *
’abË
);

29 
äÿpi_ruË_’abË
(
ušt8_t
 
’abË
);

30 
äÿpi_ruË_add
(
äc_ruË_t
 *
ruË
);

31 
äÿpi_ruË_d–
(
äc_ruË_İ_š_t
 *
ruË_d–_š
, 
ušt16_t
 *
num
);

32 
äÿpi_ruË_¡©_g‘
(
äc_ruË_İ_š_t
 *
¡©_š
, 
äc_ruË_¡©_out_t
 *
¡©_out
);

34 
äÿpi_ruË_¡©_ş—r
(
äc_ruË_İ_š_t
 *
ş—r_¡©_š
, 
ušt16_t
 *
num
);

35 
äÿpi_ruË_ş—r
(
äc_ruË_İ_š_t
 *
ruË_d–_š
, 
ušt16_t
 *
num
);

36 
äÿpi_ruË_upd©e
();

37 
äÿpi_ruË_num_g‘
(
ušt16_t
 *
num
);

39 
äÿpi_ruË_m©ch
(
äc_ruË_¡©_t
 *
ruË_¡©
, 
äc_ruË_t
 *
ruË
, 
ušt16_t
 
ruË_num
, ušt16_ˆ*
m©ch_num
);

41 #ià
FRC_CONFIG_TWO_TUPLE


42 
äÿpi_aş_¡©us_g‘
(
ušt8_t
 *
’abË
);

43 
äÿpi_aş_’abË
(
ušt8_t
 
’abË
);

44 
äÿpi_aş_add
(
äc_aş_t
 *
aş
);

45 
äÿpi_aş_d–
(
äc_aş_İ_š_t
 *
aş_d–_š
, 
ušt16_t
 *
num
);

46 
äÿpi_aş_¡©_g‘
(
äc_aş_İ_š_t
 *
¡©_š
, 
äc_aş_¡©_out_t
 *
¡©_out
);

47 
äÿpi_aş_hash_bË_¡©_g‘
(
äc_aş_hash_bË_İ_š_t
 *
¡©_š
,

48 
äc_aş_hash_bË_¡©_out_t
 *
¡©_out
);

50 
äÿpi_aş_¡©_ş—r
(
äc_aş_İ_š_t
 *
ş—r_¡©_š
, 
ušt16_t
 *
num
);

51 
äÿpi_aş_ş—r
(
äc_aş_İ_š_t
 *
aş_d–_š
, 
ušt16_t
 *
num
);

52 
äÿpi_aş_upd©e
();

53 
äÿpi_aş_num_g‘
(
ušt16_t
 *
num
);

55 
äÿpi_aş_m©ch
(
äc_aş_¡©_t
 *
aş_¡©
, 
äc_aş_t
 *
aş
, 
ušt16_t
 
aş_num
, ušt16_ˆ*
m©ch_num
);

59 
äÿpi_bdd_šfo_g‘
(
äc_bdd_šfo_out_t
 *
bdd_šfo
);

60 
äÿpi_äcdrv_v”siÚ_g‘
(
äc_v”siÚ_t
 *
äcdrv
);

61 
äÿpi_bdd_¡©us_g‘
(
äc_bdd_¡©us_out_t
 *
bdd_¡©us
);

62 
äÿpi_bdd_pow”off
();

63 
äÿpi_bdd_pÜt_’abË
(
äc_bdd_£t_pÜt_š_t
 *
£t_pÜt
);

64 
äÿpi_bdd_pÜt_loİback_£t
(
äc_bdd_£t_loİback_š_t
 *
mode
);

65 
äÿpi_bdd_log_cÚfig_£t
(
äc_bdd_log_š_t
 *
log_š
);

66 
äÿpi_bdd_phy
(
äc_bdd_phy_t
 *
šput
, 
äc_phy_İ_t
 *
ouut
);

67 
äÿpi_bdd_ıld
(
äc_bdd_ıld_t
 *
šput
, 
äc_ıld_İ_t
 *
ouut
);

68 
äÿpi_bdd_wÜkmode_£t
(
äc_bdd_wÜkmode_£t_š_t
 *
wÜkmode
);

69 
äÿpi_bdd_fÜû_lšk
(
äc_bdd_fÜû_lšk_š_t
 *
fÜû_lšk
);

78 
äÿpi_¡©_ş—r
();

79 
äÿpi_pkt_¡©_g‘
(
äc_¡©_İ_š_t
 *
šput
, 
ušt64_t
 *
¡©
);

80 
äÿpi_chª_Ü_´_s¢_¡¬t
(
ušt64_t
 
ty³
, 
äc_dma_s¢_chª_desc_t
 *
desc
);

81 
äÿpi_chª_Ü_´_ruË_Ü_udp_¡¬t
(
ušt64_t
 
ty³
, 
äc_dma_chª_desc_t
 *
desc
);

84 
äÿpi_chª_‹¡_¡¬t
(
ušt64_t
 *
chª
, 
ušt16_t
 *
Ş’
);

85 
äÿpi_sysšfo_g‘
(
äc_sy¡em_šfo_t
 *
ouut
);

87 #ià
FRC_CONFIG_UDP


88 
äÿpi_udp_¡©us_g‘
(
ušt8_t
 *
’abË
);

89 
äÿpi_udp_’abË
(
ušt8_t
 
’abË
);

91 #ià
FRC_CONFIG_VLAN_CHECK


92 
äÿpi_vÏn_check_¡©us_g‘
(
äc_vÏn_check_·¿_t
 *
vÏn_check_·¿
);

93 
äÿpi_vÏn_check_£t_·¿m‘”
(
äc_vÏn_check_·¿_t
 *
vÏn_check_·¿
);

94 
äÿpi_vÏn_check_¡©_ş—r
();

95 
äÿpi_vÏn_check_¡©_g‘
(
äc_vÏn_İ_š_t
 *
šput
, 
ušt64_t
 *
¡©
);

97 #ià
FRC_CONFIG_MAC_STATISTICS


98 
äÿpi_mac_¡©_£t
(
äc_mac_¡©_š_t
 *
šput
, 
äcÜe_u£r_cmd_e
 
cmd
);

99 
äÿpi_mac_¡©_g‘
(
äc_mac_¡©_š_t
 *
šput
, 
äc_mac_¡©_out_t
 *
¡©
, 
äcÜe_u£r_cmd_e
 
cmd
);

100 
äÿpi_mac_¡©_g‘_®l
(
äc_mac_¡©_š_t
 *
šput
, 
äc_mac_¡©_out_t
 *
¡©
, 
ušt16_t
 
num
, 
äcÜe_u£r_cmd_e
 
cmd
);

102 #ià
FRC_CONFIG_TIMESTAMP_CHECK


103 
äÿpi_time¡amp_check_¡©_ş—r
();

104 
äÿpi_time¡amp_check_¡©_g‘
(
äc_time¡amp_İ_š_t
 *
šput
, 
ušt64_t
 *
¡©
);

106 #ià
FRC_CONFIG_IPC


107 
äÿpi_c_misc_g‘
(
c_misc_t
 *
misc
);

108 
äÿpi_c_misc_£t
(
c_misc_t
 *
misc
);

109 
äÿpi_c_cur_g‘
(
c_cur_t
 *
cur
);

110 
äÿpi_c_cur_£t
(
c_cur_t
 *
cur
);

111 
äÿpi_c_exp_g‘
(
c_exp_t
 *
exp
);

112 
äÿpi_c_exp_£t
(
c_exp_t
 *
exp
);

113 
äÿpi_c_š¡r_g‘
(
c_š¡r_cfg_t
 *
š¡r
);

114 
äÿpi_c_š¡r_£t
(
c_š¡r_cfg_t
 *
š¡r
);

115 
äÿpi_c_š¡r_·ylßd_£t
(
c_·ylßd_£t_š_t
 *
·ylßd_£t
);

117 #ià
FRC_CONFIG_VLAN_IV


118 
äùw—k_c_hash4_mask_£t
(
äc_vÏn_hash_mask_t
 *
mask_£t
);

119 
äùw—k_c_hash6_mask_£t
(
äc_vÏn_hash_mask_t
 *
mask_£t
);

	@frcdrv/frcdrv.c

1 
	~"äcdrv.h
"

	@frcdrv/frcdrv.h

1 #iâdeà
__FRCDRV_H__


2 
	#__FRCDRV_H__


	)

4 
	~"oùeÚ_deviû.h
"

5 
	~"ÿvium_sysd•.h
"

6 
	~"äc.h
"

8 
	#MAJOR_VERSION
 1

	)

9 
	#MINOR_VERSION
 1

	)

10 
	#BUILD_VERSION
 1

	)

18 #ià
FRC_DEBUG_DRV


19 
	#FRCDRV_ERROR
(
_fmt
, 
_¬gs
...è
	`´štk
("[ERROR] %s.%d:" _fmt, 
__func__
, 
__LINE__
, ##_¬gs)

	)

20 
	#FRCDRV_DEBUG
(
_fmt
, 
_¬gs
...è
	`´štk
("[DEBUG] %s.%d:" _fmt, 
__func__
, 
__LINE__
, ##_¬gs)

	)

22 
	#FRCDRV_ERROR
(
_fmt
, 
_¬gs
...)

	)

23 
	#FRCDRV_DEBUG
(
_fmt
, 
_¬gs
...)

	)

25 
	#äcdrv_m®loc
(
size
è
	`km®loc
((size), 
GFP_ATOMIC
)

	)

26 
	#äcdrv_ä“
(
pbuf
è
	`kä“
Õbuf)

	)

30 
	#FRC_LIST_NEW
(
li¡
) \

32 
li¡
 = 
	`äcdrv_m®loc
((
li¡_t
)); \

33 ià(
li¡
 =ğ
NULL
) \

35  
FRE_MEMORY
; \

37 
	`mem£t
(
li¡
, 0, (
li¡_t
)); \

38 }

	)

	@frcdrv/frcdrv_chan.c

1 
	~"äcdrv.h
"

2 
	~"äcdrv_chª.h
"

3 
	~"äcdrv_dma.h
"

4 
	~"äcdrv_cmd.h
"

6 #ià
FRC_CONFIG_SIMPLE_PACKAGE


7 
äc_dma_sim¶e_·ckage_chª_t
 *
	gäcdrv_dma_sim¶e_·ckage_chªs
 = 
NULL
;

9 
äc_dma_sim¶e_·ckage_chª_t
 *

10 
	$äcdrv_sim¶e_·kÿge_chª_g‘
(
ušt32_t
 
chª_id
)

12 ià(
chª_id
 >ğ
FRC_DMA_SIMPLE_PACKAGE_CHAN_NUM
)

14  
NULL
;

17 ià(
äcdrv_dma_sim¶e_·ckage_chªs
 =ğ
NULL
)

19  
NULL
;

22  &
äcdrv_dma_sim¶e_·ckage_chªs
[
chª_id
];

23 
	}
}

25 
	$äcdrv_sim¶e_·ckage_chªs_ä“
(
äc_dma_sim¶e_·ckage_chª_t
 *
chª
)

27 
i
;

28 
äc_dma_sim¶e_·ckage_poŞ_t
 *
poŞ
 = 
chª
->pool;

29 ià(
poŞ
)

31 
i
 = 0; i < 
poŞ
->
poŞ_num
; i++)

33 
	`äcdrv_dma_poŞ_ä“
(
	`__va
(
poŞ
->
poŞ_addr
[
i
]));

35 
	`äcdrv_dma_poŞ_ä“
(
poŞ
);

36 
chª
->
poŞ
 = 
NULL
;

39 ià(
chª
->
dma_ù¾
)

41 
	`äcdrv_dma_poŞ_ä“
(
chª
->
dma_ù¾
);

43 
chª
->
dma_ù¾
 = 
NULL
;

44 
	}
}

47 
	$äcdrv_sim¶e_·ckage_chª_ava_š™
(
äc_dma_sim¶e_·ckage_chª_t
 *
chª
)

49 
ušt64_t
 
block_addr
, 
poŞ_id
, 
block_off£t
;

50 
äc_dma_sim¶e_·ckage_poŞ_t
 *
poŞ
 = 
NULL
;

52 
poŞ
 = 
chª
->pool;

53 ià(
poŞ
 =ğ
NULL
)

55 
	`FRCDRV_ERROR
("pool is NULL.\n");

56  
FRE_INIT
;

59 
poŞ_id
 = 0;…oŞ_id < 
poŞ
->
poŞ_num
;…ool_id++)

61 
block_off£t
 = 0; block_off£ˆ< 
FRC_DMA_POOL_SIZE
; block_off£t+=
FRC_DMA_SIMPLE_PACKAGE_BLOCK_SIZE
)

63 
block_addr
 = 
poŞ
->
poŞ_addr
[
poŞ_id
] + 
block_off£t
;

64 ià(!
	`SIMPLE_PACKAGE_AVAIL_RING_PUT
(*
chª
->
dma_ù¾
, 
block_addr
))

66 
	`FRCDRV_ERROR
("Available„ing…ut fail!\n");

67  
FRE_INIT
;

73 
	`FRCDRV_DEBUG
("chª[%Îx]:‡vaabË_ršg.widx = 0x%Îx\n", (
ULL
)
chª
->
desc
.
ty³
, (ULLèchª->
dma_ù¾
->
avaabË_ršg
.
widx
);

74 
	`FRCDRV_DEBUG
("chª[%Îx]:‡vaabË_ršg.ridx = 0x%Îx\n", (
ULL
)
chª
->
desc
.
ty³
, (ULLèchª->
dma_ù¾
->
avaabË_ršg
.
ridx
);

75 
	`FRCDRV_DEBUG
("chª[%Îx]:†™’dŸÀavaabË_ršg.widx = 0x%Îx\n", (
ULL
)
chª
->
desc
.
ty³
, (ULLè
	`SWAP_8_BYTE
(chª->
dma_ù¾
->
avaabË_ršg
.
widx
));

76 
	`FRCDRV_DEBUG
("chª[%Îx]:†™’dŸÀavaabË_ršg.ridx = 0x%Îx\n", (
ULL
)
chª
->
desc
.
ty³
, (ULLè
	`SWAP_8_BYTE
(chª->
dma_ù¾
->
avaabË_ršg
.
ridx
));

77  
FRE_SUCCESS
;

78 
	}
}

81 
	$äcdrv_sim¶e_·ckage_chª_dma_ù¾_š™
(
äc_dma_sim¶e_·ckage_chª_t
 *
chª
)

83 
ušt64_t
 
ù¾_addr
;

84 ià(
chª
->
poŞ
 =ğ
NULL
)

86 
	`FRCDRV_ERROR
("chan->pool is NULL!\n");

87  
FRE_INIT
;

90 
chª
->
dma_ù¾
 = 
	`äcdrv_dma_poŞ_®loc
();

91 ià(
chª
->
dma_ù¾
 =ğ
NULL
)

93 
	`FRCDRV_ERROR
("Malloc dma ctrl fail!\n");

94  
FRE_MEMORY
;

96 
	`mem£t
(
chª
->
dma_ù¾
, 0, (
äc_dma_sim¶e_·ckage_chª_ù¾_t
));

97 
chª
->
desc
.
ù¾_size
 = (
äc_dma_sim¶e_·ckage_chª_ù¾_t
);

98 
ù¾_addr
 = 
	`__·
(
chª
->
dma_ù¾
);

99 
chª
->
desc
.
ù¾_addr
 = ctrl_addr;

101 
	`FRCDRV_DEBUG
("chª[%Îx]: chª->dma_ù¾ = %p\n", (
ULL
)
chª
->
desc
.
ty³
, chª->
dma_ù¾
);

102 
	`FRCDRV_DEBUG
("chª[%Îx]: chª->desc.ù¾_add¸ğ0x%Îx\n", (
ULL
)
chª
->
desc
.
ty³
, (ULLèchª->desc.
ù¾_addr
);

103 
	`FRCDRV_DEBUG
("chª[%Îx]: chª->desc.ù¾_sizğ0x%Îx\n", (
ULL
)
chª
->
desc
.
ty³
, (ULLèchª->desc.
ù¾_size
);

104 
	`FRCDRV_DEBUG
("chª[%Îx]: sizeof(äc_dma_sim¶e_·ckage_chª_ù¾_tèğ0x%Îx\n", (
ULL
)
chª
->
desc
.
ty³
,

105 (
ULL
)(
äc_dma_sim¶e_·ckage_chª_ù¾_t
));

106 
	`FRCDRV_DEBUG
("chª[%Îx]:‡vaabË_ršg.widx = 0x%Îx\n", (
ULL
)
chª
->
desc
.
ty³
, (ULLèchª->
dma_ù¾
->
avaabË_ršg
.
widx
);

107 
	`FRCDRV_DEBUG
("chª[%Îx]:‡vaabË_ršg.ridx = 0x%Îx\n", (
ULL
)
chª
->
desc
.
ty³
, (ULLèchª->
dma_ù¾
->
avaabË_ršg
.
ridx
);

108 
	`FRCDRV_DEBUG
("chª[%Îx]: com¶‘ed_ršg.widx = 0x%Îx\n", (
ULL
)
chª
->
desc
.
ty³
, (ULLèchª->
dma_ù¾
->
com¶‘ed_ršg
.
widx
);

109 
	`FRCDRV_DEBUG
("chª[%Îx]: com¶‘ed_ršg.ridx = 0x%Îx\n", (
ULL
)
chª
->
desc
.
ty³
, (ULLèchª->
dma_ù¾
->
com¶‘ed_ršg
.
ridx
);

111  
FRE_SUCCESS
;

112 
	}
}

115 
	$äcdrv_sim¶e_·ckage_chª_poŞ_š™
(
äc_dma_sim¶e_·ckage_chª_t
 *
chª
, 
ušt64_t
 
poŞ_num
)

117 
i
;

118 *
buff
 = 
NULL
;

119 
äc_dma_sim¶e_·ckage_poŞ_t
 *
poŞ
;

120 
ušt64_t
 
addr_mš
, 
addr_max
;

122 
poŞ
 = 
	`äcdrv_dma_poŞ_®loc
();

123 ià(
poŞ
 =ğ
NULL
)

125 
	`FRCDRV_ERROR
("Malloc buf_pool fail!\n");

126  
FRE_MEMORY
;

128 
	`mem£t
(
poŞ
, 0, (
äc_dma_sim¶e_·ckage_poŞ_t
));

130 
chª
->
poŞ
 =…ool;

131 
poŞ
->
poŞ_num
 =…ool_num;

133 
	`FRCDRV_DEBUG
("chan->pool=%p,chan->pool->pool_num=%llu\n",

134 
chª
->
poŞ
, chª->poŞ->
poŞ_num
);

136 
i
 = 0; i < 
poŞ
->
poŞ_num
 ; i++)

138 
buff
 = 
	`äcdrv_dma_poŞ_®loc
();

139 ià(
buff
 =ğ
NULL
)

141 
	`FRCDRV_ERROR
("M®loødm¨bufã¸%d fa!\n", 
i
);

142  
FRE_MEMORY
;

144 
poŞ
->
poŞ_addr
[
i
] = 
	`__·
(
buff
);

145 
	`FRCDRV_DEBUG
("buff=%p,poŞ->poŞ_addr[%d]=%Îx\n",
buff
, 
i
, (
ULL
)
poŞ
->
poŞ_addr
[i]);

148 
addr_mš
 = 
poŞ
->
poŞ_addr
[0];

149 
addr_max
 = 
poŞ
->
poŞ_addr
[0];

150 
i
 = 1; i < 
poŞ
->
poŞ_num
; i++)

152 ià(
addr_mš
 > 
poŞ
->
poŞ_addr
[
i
])

154 
addr_mš
 = 
poŞ
->
poŞ_addr
[
i
];

156 ià(
addr_max
 < 
poŞ
->
poŞ_addr
[
i
])

158 
addr_max
 = 
poŞ
->
poŞ_addr
[
i
];

161 
chª
->
desc
.
poŞ_addr
 = 
addr_mš
;

162 
chª
->
desc
.
poŞ_size
 = 
addr_max
 - 
addr_mš
 + 
FRC_DMA_POOL_SIZE
;

163 
	`FRCDRV_DEBUG
("poŞ_addr_mš=%Îx\n", (
ULL
)
addr_mš
);

164 
	`FRCDRV_DEBUG
("poŞ_addr_max=%Îx\n", (
ULL
)
addr_max
);

165 
	`FRCDRV_DEBUG
("chª->desc.poŞ_addr=%Îx, chª->desc.poŞ_size=%Îx\n", 
chª
->
desc
.
poŞ_addr
, chª->desc.
poŞ_size
);

166  
FRE_SUCCESS
;

167 
	}
}

170 
	$äcdrv_sim¶e_·ckage_chª_£tup
(
äc_dma_sim¶e_·ckage_chª_t
 *
chª
, 
ušt32_t
 
ty³
, 
ušt64_t
 
poŞ_num
)

172 
rv
;

173 ià(
poŞ_num
 > 
FRC_DMA_SIMPLE_PACKAGE_POOL_NUM_MAX
)

175  
FRE_PARAM
;

178 
rv
 = 
	`äcdrv_sim¶e_·ckage_chª_poŞ_š™
(
chª
, 
poŞ_num
);

179 ià(
rv
)

181 
	`FRCDRV_ERROR
("äcdrv_queue_buff_poŞ_š™ fa: %d.\n", 
rv
);

182  
FRE_FAIL
;

185 
rv
 = 
	`äcdrv_sim¶e_·ckage_chª_dma_ù¾_š™
(
chª
);

186 ià(
rv
)

188 
	`FRCDRV_ERROR
("äcdrv_queue_dma_ù¾_š™ fa: %d.\n", 
rv
);

189  
FRE_FAIL
;

192 
rv
 = 
	`äcdrv_sim¶e_·ckage_chª_ava_š™
(
chª
);

193 ià(
rv
)

195 
	`FRCDRV_ERROR
("äcdrv_queue_ava_š™ fa: %d.\n", 
rv
);

196  
FRE_FAIL
;

199 
chª
->
desc
.
ty³
 =ype;

201  
FRE_SUCCESS
;

202 
	}
}

205 
	$äcdrv_sim¶e_·ckage_chª_£t_cÜe
(
oùeÚ_deviû_t
 *
où
, 
äc_dma_sim¶e_·ckage_chª_t
 *
chª
)

207 
rv
;

208 
rv
 = 
	`äcÜe_£t
(
où
, 
CMD_TYPE_CTRL
, 
CTRL_CMD_SETUP_SIMPLE_PACKAGE_CHAN
, (
äc_dma_chª_desc_t
), &
chª
->
desc
);

209 
	`FRCDRV_DEBUG
("chan %lld setup: ctrl_size = %llx,‡pp_addr 0x%llx ,„v = %d.\n",

210 (
ULL
è
chª
->
desc
.
ty³
, (ULLèchª->desc.
ù¾_size
,

211 (
ULL
è
chª
->
desc
.
ù¾_addr
, 
rv
);

212 ià(
rv
 !ğ
FRE_SUCCESS
) {

213 
	`FRCDRV_ERROR
("CTRL_CMD_SET_SIMPLE_PACKAGE_CHANƒxecu‹ fa:„v = %d.\n", 
rv
);

214  
rv
;

217  
FRE_SUCCESS
;

218 
	}
}

221 
	$äcdrv_sim¶e_·ckage_chª_de¡roy
()

223 
i
;

224 ià(
äcdrv_dma_sim¶e_·ckage_chªs
)

226 
i
 = 0; i < 
FRC_DMA_SIMPLE_PACKAGE_CHAN_NUM
; i++)

228 
	`äcdrv_sim¶e_·ckage_chªs_ä“
(&
äcdrv_dma_sim¶e_·ckage_chªs
[
i
]);

230 
	`kä“
(
äcdrv_dma_sim¶e_·ckage_chªs
);

231 
äcdrv_dma_sim¶e_·ckage_chªs
 = 
NULL
;

233 
	}
}

236 
	$äcdrv_sim¶e_·ckage_chª_š™
()

238 
äcdrv_dma_sim¶e_·ckage_chªs
 = 
	`km®loc
((
äc_dma_sim¶e_·ckage_chª_t
è* 
FRC_DMA_SIMPLE_PACKAGE_CHAN_NUM
, 
GFP_KERNEL
);

239 ià(
äcdrv_dma_sim¶e_·ckage_chªs
 =ğ
NULL
)

241 
	`FRCDRV_ERROR
("Malloc simple…ackage dma ctrl fail!\n");

242  
FRE_MEMORY
;

244 
	`mem£t
(
äcdrv_dma_sim¶e_·ckage_chªs
, 0, (
äc_dma_sim¶e_·ckage_chª_t
è* 
FRC_DMA_SIMPLE_PACKAGE_CHAN_NUM
);

246 
äcdrv_dma_sim¶e_·ckage_chªs
[0].
desc
.
ty³
 = 
FRC_WORK_UDP
;

247 
äcdrv_dma_sim¶e_·ckage_chªs
[1].
desc
.
ty³
 = 
FRC_WORK_RULE
;

250 
	`FRCDRV_DEBUG
("frcdrv_dma_simple_package_chans:%p,"

252 
äcdrv_dma_sim¶e_·ckage_chªs
, (
ULL
)(
äc_dma_sim¶e_·ckage_chª_t
),

253 (
ULL
)(
äcdrv_dma_sim¶e_·ckage_chªs
));

254 
	`FRCDRV_DEBUG
("frcdrv_dma_simple_package_chans[0].desc.type=%llx, "

256 
äcdrv_dma_sim¶e_·ckage_chªs
[0].
desc
.
ty³
, frcdrv_dma_simple_package_chans[1].desc.type);

258  
FRE_SUCCESS
;

259 
	}
}

264 #ià
FRC_CONFIG_SSN_CHAN


265 
äc_dma_s¢_chª_t
 *
	gäcdrv_dma_s¢_chªs
 = 
NULL
;

267 
äc_dma_s¢_chª_t
 *

268 
	$äcdrv_s¢_chª_g‘
(
ušt32_t
 
chª_id
)

270 ià(
chª_id
 > 
FRC_WORK_MAX
 - 1)

272  
NULL
;

275 ià(
äcdrv_dma_s¢_chªs
 =ğ
NULL
)

277  
NULL
;

280  &
äcdrv_dma_s¢_chªs
[
chª_id
 - 
FRC_WORK_SSN
];

281 
	}
}

283 
	$äcdrv_s¢_chªs_ä“
(
äc_dma_s¢_chª_t
 *
chª
)

285 
i
;

286 
äc_dma_s¢_poŞ_t
 *
poŞ
 = 
chª
->pool;

287 ià(
poŞ
)

289 
i
 = 0; i < 
poŞ
->
poŞ_num
; i++)

291 
	`äcdrv_dma_poŞ_ä“
(
	`__va
(
poŞ
->
poŞ_addr
[
i
]));

293 
	`äcdrv_dma_poŞ_ä“
(
poŞ
);

294 
chª
->
poŞ
 = 
NULL
;

297 ià(
chª
->
avaabË_ršg
)

299 
	`äcdrv_dma_poŞ_ä“
(
chª
->
avaabË_ršg
);

301 
chª
->
avaabË_ršg
 = 
NULL
;

303 ià(
chª
->
com¶‘ed_ršg
)

305 
	`äcdrv_dma_poŞ_ä“
(
chª
->
com¶‘ed_ršg
);

307 
chª
->
com¶‘ed_ršg
 = 
NULL
;

308 
	}
}

311 
	$äcdrv_s¢_chª_ava_š™
(
äc_dma_s¢_chª_t
 *
chª
)

313 
ušt64_t
 
block_addr
, 
poŞ_id
, 
block_off£t
;

314 
äc_dma_s¢_poŞ_t
 *
poŞ
 = 
NULL
;

316 
poŞ
 = 
chª
->pool;

317 ià(
poŞ
 =ğ
NULL
)

319 
	`FRCDRV_ERROR
("pool is NULL.\n");

320  
FRE_INIT
;

323 
poŞ_id
 = 0;…oŞ_id < 
poŞ
->
poŞ_num
;…ool_id++)

325 
block_off£t
 = 0; block_off£ˆ< 
FRC_DMA_POOL_SIZE
; block_off£t+=
FRC_DMA_SSN_BLOCK_SIZE
)

327 
block_addr
 = 
poŞ
->
poŞ_addr
[
poŞ_id
] + 
block_off£t
;

328 ià(!
	`SSN_AVAIL_RING_PUT
(*
chª
, 
block_addr
))

330 
	`FRCDRV_ERROR
("Available„ing…ut fail!\n");

331  
FRE_INIT
;

338 
	`FRCDRV_DEBUG
("chª[%Îx]:‡vaabË_ršg.widx = 0x%Îx\n", (
ULL
)
chª
->
desc
.
ty³
, (ULLèchª->
avaabË_ršg
->
widx
);

339 
	`FRCDRV_DEBUG
("chª[%Îx]:‡vaabË_ršg.ridx = 0x%Îx\n", (
ULL
)
chª
->
desc
.
ty³
, (ULLèchª->
avaabË_ršg
->
ridx
);

340 
	`FRCDRV_DEBUG
("chª[%Îx]:†™’dŸÀavaabË_ršg.widx = 0x%Îx\n", (
ULL
)
chª
->
desc
.
ty³
, (ULLè
	`SWAP_8_BYTE
(chª->
avaabË_ršg
->
widx
));

341 
	`FRCDRV_DEBUG
("chª[%Îx]:†™’dŸÀavaabË_ršg.ridx = 0x%Îx\n", (
ULL
)
chª
->
desc
.
ty³
, (ULLè
	`SWAP_8_BYTE
(chª->
avaabË_ršg
->
ridx
));

342  
FRE_SUCCESS
;

343 
	}
}

346 
	$äcdrv_s¢_chª_dma_ù¾_š™
(
äc_dma_s¢_chª_t
 *
chª
)

348 ià(
chª
->
poŞ
 =ğ
NULL
)

350 
	`FRCDRV_ERROR
("chan->pool is NULL!\n");

351  
FRE_INIT
;

355 
chª
->
avaabË_ršg
 = 
	`äcdrv_dma_poŞ_®loc
();

356 ià(
chª
->
avaabË_ršg
 =ğ
NULL
)

358 
	`FRCDRV_ERROR
("Malloc dma‡vailable_ring fail!\n");

359  
FRE_MEMORY
;

361 
	`mem£t
(
chª
->
avaabË_ršg
, 0, (
äc_s¢_ršg_buff_t
));

362 
chª
->
desc
.
ava_size
 = (
äc_s¢_ršg_buff_t
);

363 
chª
->
desc
.
ava_addr
 = 
	`__·
(chª->
avaabË_ršg
);

366 
chª
->
com¶‘ed_ršg
 = 
	`äcdrv_dma_poŞ_®loc
();

367 ià(
chª
->
com¶‘ed_ršg
 =ğ
NULL
)

369 
	`FRCDRV_ERROR
("Malloc dma completed_ring fail!\n");

370  
FRE_MEMORY
;

372 
	`mem£t
(
chª
->
com¶‘ed_ršg
, 0, (
äc_s¢_ršg_buff_t
));

373 
chª
->
desc
.
com¶_size
 = (
äc_s¢_ršg_buff_t
);

374 
chª
->
desc
.
com¶_addr
 = 
	`__·
(chª->
com¶‘ed_ršg
);

376 
	`FRCDRV_DEBUG
("chª[%Îx]: chª->avaabË_ršg = %p\n", (
ULL
)
chª
->
desc
.
ty³
, chª->
avaabË_ršg
);

377 
	`FRCDRV_DEBUG
("chª[%Îx]: chª->desc.ava_add¸ğ0x%Îx\n", (
ULL
)
chª
->
desc
.
ty³
, (ULLèchª->desc.
ava_addr
);

378 
	`FRCDRV_DEBUG
("chª[%Îx]: chª->desc.ava_sizğ0x%Îx\n", (
ULL
)
chª
->
desc
.
ty³
, (ULLèchª->desc.
ava_size
);

379 
	`FRCDRV_DEBUG
("chª[%Îx]: chª->com¶‘ed_ršg = %p\n", (
ULL
)
chª
->
desc
.
ty³
, chª->
com¶‘ed_ršg
);

380 
	`FRCDRV_DEBUG
("chª[%Îx]: chª->desc.com¶_add¸ğ0x%Îx\n", (
ULL
)
chª
->
desc
.
ty³
, (ULLèchª->desc.
com¶_addr
);

381 
	`FRCDRV_DEBUG
("chª[%Îx]: chª->desc.com¶_sizğ0x%Îx\n", (
ULL
)
chª
->
desc
.
ty³
, (ULLèchª->desc.
com¶_size
);

382 
	`FRCDRV_DEBUG
("chª[%Îx]: sizeof(äc_s¢_ršg_buff_tèğ0x%Îx\n", (
ULL
)
chª
->
desc
.
ty³
,

383 (
ULL
)(
äc_s¢_ršg_buff_t
));

384 
	`FRCDRV_DEBUG
("chª[%Îx]:‡vaabË_ršg.widx = 0x%Îx\n", (
ULL
)
chª
->
desc
.
ty³
, (ULLèchª->
avaabË_ršg
->
widx
);

385 
	`FRCDRV_DEBUG
("chª[%Îx]:‡vaabË_ršg.ridx = 0x%Îx\n", (
ULL
)
chª
->
desc
.
ty³
, (ULLèchª->
avaabË_ršg
->
ridx
);

386 
	`FRCDRV_DEBUG
("chª[%Îx]: com¶‘ed_ršg.widx = 0x%Îx\n", (
ULL
)
chª
->
desc
.
ty³
, (ULLèchª->
com¶‘ed_ršg
->
widx
);

387 
	`FRCDRV_DEBUG
("chª[%Îx]: com¶‘ed_ršg.ridx = 0x%Îx\n", (
ULL
)
chª
->
desc
.
ty³
, (ULLèchª->
com¶‘ed_ršg
->
ridx
);

389  
FRE_SUCCESS
;

390 
	}
}

393 
	$äcdrv_s¢_chª_poŞ_š™
(
äc_dma_s¢_chª_t
 *
chª
, 
ušt64_t
 
poŞ_num
)

395 
i
;

396 *
buff
 = 
NULL
;

397 
äc_dma_s¢_poŞ_t
 *
poŞ
;

398 
ušt64_t
 
addr_mš
, 
addr_max
;

400 
poŞ
 = 
	`äcdrv_dma_poŞ_®loc
();

401 ià(
poŞ
 =ğ
NULL
)

403 
	`FRCDRV_ERROR
("Malloc buf_pool fail!\n");

404  
FRE_MEMORY
;

406 
	`mem£t
(
poŞ
, 0, (
äc_dma_s¢_poŞ_t
));

408 
chª
->
poŞ
 =…ool;

409 
poŞ
->
poŞ_num
 =…ool_num;

411 
	`FRCDRV_DEBUG
("chan->pool=%p,chan->pool->pool_num=%llu\n",

412 
chª
->
poŞ
, chª->poŞ->
poŞ_num
);

414 
i
 = 0; i < 
poŞ
->
poŞ_num
 ; i++)

416 
buff
 = 
	`äcdrv_dma_poŞ_®loc
();

417 ià(
buff
 =ğ
NULL
)

419 
	`FRCDRV_ERROR
("M®loødm¨bufã¸%d fa!\n", 
i
);

420  
FRE_MEMORY
;

422 
poŞ
->
poŞ_addr
[
i
] = 
	`__·
(
buff
);

423 
	`FRCDRV_DEBUG
("buff=%p,poŞ->poŞ_addr[%d]=%Îx\n",
buff
, 
i
, (
ULL
)
poŞ
->
poŞ_addr
[i]);

426 
addr_mš
 = 
poŞ
->
poŞ_addr
[0];

427 
addr_max
 = 
poŞ
->
poŞ_addr
[0];

428 
i
 = 1; i < 
poŞ
->
poŞ_num
; i++)

430 ià(
addr_mš
 > 
poŞ
->
poŞ_addr
[
i
])

432 
addr_mš
 = 
poŞ
->
poŞ_addr
[
i
];

434 ià(
addr_max
 < 
poŞ
->
poŞ_addr
[
i
])

436 
addr_max
 = 
poŞ
->
poŞ_addr
[
i
];

439 
chª
->
desc
.
poŞ_addr
 = 
addr_mš
;

440 
chª
->
desc
.
poŞ_size
 = 
addr_max
 - 
addr_mš
 + 
FRC_DMA_POOL_SIZE
;

441 
	`FRCDRV_DEBUG
("poŞ_addr_mš=%Îx\n", (
ULL
)
addr_mš
);

442 
	`FRCDRV_DEBUG
("poŞ_addr_max=%Îx\n", (
ULL
)
addr_max
);

443 
	`FRCDRV_DEBUG
("chª->desc.poŞ_addr=%Îx, chª->desc.poŞ_size=%Îx\n", 
chª
->
desc
.
poŞ_addr
, chª->desc.
poŞ_size
);

444  
FRE_SUCCESS
;

445 
	}
}

448 
	$äcdrv_s¢_chª_£tup
(
äc_dma_s¢_chª_t
 *
chª
, 
ušt32_t
 
ty³
, 
ušt64_t
 
poŞ_num
)

450 
rv
;

451 ià(
poŞ_num
 > 
FRC_DMA_SSN_POOL_NUM_MAX
)

453  
FRE_PARAM
;

456 
rv
 = 
	`äcdrv_s¢_chª_poŞ_š™
(
chª
, 
poŞ_num
);

457 ià(
rv
)

459 
	`FRCDRV_ERROR
("äcdrv_s¢_chª_poŞ_š™ fa: %d.\n", 
rv
);

460  
FRE_FAIL
;

463 
rv
 = 
	`äcdrv_s¢_chª_dma_ù¾_š™
(
chª
);

464 ià(
rv
)

466 
	`FRCDRV_ERROR
("äcdrv_s¢_chª_dma_ù¾_š™ fa: %d.\n", 
rv
);

467  
FRE_FAIL
;

470 
rv
 = 
	`äcdrv_s¢_chª_ava_š™
(
chª
);

471 ià(
rv
)

473 
	`FRCDRV_ERROR
("äcdrv_s¢_chª_ava_š™ fa: %d.\n", 
rv
);

474  
FRE_FAIL
;

477 
chª
->
desc
.
ty³
 =ype;

479  
FRE_SUCCESS
;

480 
	}
}

483 
	$äcdrv_s¢_chª_£t_cÜe
(
oùeÚ_deviû_t
 *
où
, 
äc_dma_s¢_chª_t
 *
chª
)

485 
rv
;

486 
rv
 = 
	`äcÜe_£t
(
où
, 
CMD_TYPE_CTRL
, 
CTRL_CMD_SETUP_SSN_CHAN
, (
äc_dma_s¢_chª_desc_t
), &
chª
->
desc
);

487 
	`FRCDRV_DEBUG
("chan %lld setup: ctrl_size = %llx,‡vail_addr 0x%llx, compl_size = %llx, compl_addr 0x%llx,„v = %d.\n",

488 (
ULL
è
chª
->
desc
.
ty³
, (ULLèchª->desc.
ava_size
,

489 (
ULL
è
chª
->
desc
.
ava_addr
, (ULLèchª->desc.
com¶_size
,

490 (
ULL
è
chª
->
desc
.
com¶_addr
, 
rv
);

491 ià(
rv
 !ğ
FRE_SUCCESS
) {

492 
	`FRCDRV_ERROR
("CTRL_CMD_SETUP_SSN_CHANƒxecu‹ fa:„v = %d.\n", 
rv
);

493  
rv
;

496  
FRE_SUCCESS
;

497 
	}
}

501 
	$äcdrv_s¢_chª_de¡roy
()

503 
i
;

504 ià(
äcdrv_dma_s¢_chªs
)

506 
i
 = 0; i < 
FRC_DMA_SSN_CHAN_NUM
; i++)

508 
	`äcdrv_s¢_chªs_ä“
(&
äcdrv_dma_s¢_chªs
[
i
]);

510 
	`kä“
(
äcdrv_dma_s¢_chªs
);

511 
äcdrv_dma_s¢_chªs
 = 
NULL
;

513 
	}
}

516 
	$äcdrv_s¢_chª_š™
()

518 
äcdrv_dma_s¢_chªs
 = 
	`km®loc
((
äc_dma_s¢_chª_t
è* 
FRC_DMA_SSN_CHAN_NUM
, 
GFP_KERNEL
);

519 ià(
äcdrv_dma_s¢_chªs
 =ğ
NULL
)

521 
	`FRCDRV_ERROR
("Malloc ssn dma ctrl fail!\n");

522  
FRE_MEMORY
;

524 
	`mem£t
(
äcdrv_dma_s¢_chªs
, 0, (
äc_dma_s¢_chª_t
è* 
FRC_DMA_SSN_CHAN_NUM
);

526 
äcdrv_dma_s¢_chªs
[0].
desc
.
ty³
 = 
FRC_WORK_SSN
;

528 
	`FRCDRV_DEBUG
("frcdrv_dma_ssn_chans:%p,"

530 
äcdrv_dma_s¢_chªs
, (
ULL
)(
äc_dma_s¢_chª_t
),

531 (
ULL
)(
äcdrv_dma_s¢_chªs
));

532 
	`FRCDRV_DEBUG
("frcdrv_dma_ssn_chans[0].desc.type=%llx\n",

533 
äcdrv_dma_s¢_chªs
[0].
desc
.
ty³
);

535  
FRE_SUCCESS
;

536 
	}
}

541 
	$äcdrv_cmd_poŞ_ªd_ršg_addr_g‘
(
äc_ioùl_t
 *
ioùl_¬g
)

543 
ušt64_t
 
ty³
;

544 ià(
ioùl_¬g
->
Ş’
 !ğ(
äc_dma_chª_desc_t
) &&

545 
ioùl_¬g
->
Ş’
 !ğ(
äc_dma_s¢_chª_desc_t
) )

547  
FRE_PARAM
;

551 
ty³
 = *((
ušt64_t
 *è
ioùl_¬g
->
šput
);

553 ià(
ty³
 > 
FRC_WORK_MAX
)

555  
FRE_PARAM
;

558 ià(
ty³
 =ğ
FRC_WORK_UDP
 ||y³ =ğ
FRC_WORK_RULE
)

560 #ià
FRC_CONFIG_SIMPLE_PACKAGE


561 ià(
äcdrv_dma_sim¶e_·ckage_chªs
 =ğ
NULL
)

563  
FRE_INIT
;

565 
	`ÿvium_memıy
(
ioùl_¬g
->
ouut
, &
äcdrv_dma_sim¶e_·ckage_chªs
[
ty³
].
desc
, (
äc_dma_chª_desc_t
));

566 
ioùl_¬g
->
Ş’
 = (
äc_dma_chª_desc_t
);

568 }ià(
ty³
 =ğ
FRC_WORK_SSN
)

570 #ià
FRC_CONFIG_SSN_CHAN


571 ià(
äcdrv_dma_s¢_chªs
 =ğ
NULL
)

573  
FRE_INIT
;

575 
	`ÿvium_memıy
(
ioùl_¬g
->
ouut
, &
äcdrv_dma_s¢_chªs
[
ty³
 - 
FRC_WORK_SSN
].
desc
, (
äc_dma_s¢_chª_desc_t
));

576 
ioùl_¬g
->
Ş’
 = (
äc_dma_s¢_chª_desc_t
);

580  
FRE_SUCCESS
;

581 
	}
}

	@frcdrv/frcdrv_chan.h

1 #iâdeà
__FRC_QUEUE_H__


2 
	#__FRC_QUEUE_H__


	)

4 
	~"äc_dma.h
"

5 
	~"äc_ioùl.h
"

7 #ià
FRC_CONFIG_SIMPLE_PACKAGE


8 
äcdrv_sim¶e_·ckage_chª_de¡roy
();

9 
äcdrv_sim¶e_·ckage_chª_š™
();

10 
äc_dma_sim¶e_·ckage_chª_t
 *
äcdrv_sim¶e_·kÿge_chª_g‘
(
ušt32_t
 
chª_id
);

11 
äcdrv_sim¶e_·ckage_chª_£tup
(
äc_dma_sim¶e_·ckage_chª_t
 *
chª
, 
ušt32_t
 
ty³
, 
ušt64_t
 
poŞ_num
);

12 
äcdrv_sim¶e_·ckage_chª_£t_cÜe
(
oùeÚ_deviû_t
 *
où
, 
äc_dma_sim¶e_·ckage_chª_t
 *
chª
);

14 
äcdrv_cmd_poŞ_ªd_ršg_addr_g‘
(
äc_ioùl_t
 *
ioùl_¬g
);

15 #ià
FRC_CONFIG_SSN_CHAN


16 
äcdrv_s¢_chª_de¡roy
();

17 
äcdrv_s¢_chª_š™
();

18 
äc_dma_s¢_chª_t
 *
äcdrv_s¢_chª_g‘
(
ušt32_t
 
chª_id
);

19 
äcdrv_s¢_chª_£tup
(
äc_dma_s¢_chª_t
 *
chª
, 
ušt32_t
 
ty³
, 
ušt64_t
 
poŞ_num
);

20 
äcdrv_s¢_chª_£t_cÜe
(
oùeÚ_deviû_t
 *
où
, 
äc_dma_s¢_chª_t
 *
chª
);

	@frcdrv/frcdrv_cmd.c

3 
	~"ÿvium_sysd•.h
"

4 
	~"ÿvium_defs.h
"

5 
	~"ÿvium_k”Ãl_defs.h
"

6 
	~"ÿvium_»Ëa£.h
"

7 
	~"oùeÚ-İcodes.h
"

9 
	~"äcdrv.h
"

10 
	~"äcdrv_cmd.h
"

11 
	~"äcdrv_ÃtwÜk.h
"

12 
	~"äc_·ck.h
"

14 
äcdev_´İs_t
 *
äırİs
[
MAX_OCTEON_DEVICES
];

21 
	$äcdrv_cmd_ÿÎback
(
oùeÚ_»q_¡©us_t
 
¡©us
, *
sif_±r
)

24 
oùeÚ_soá_š¡ruùiÚ_t
 *
si
 = (oùeÚ_soá_š¡ruùiÚ_ˆ*)
sif_±r
;

25 
äcdrv_cmd_pkt_t
 *
pkt
;

27 
pkt
 = (
äcdrv_cmd_pkt_t
 *)((
ušt8_t
 *)
si
 + 
OCT_SOFT_INSTR_SIZE
);

29 
	`FRCDRV_DEBUG
("¡©u ğ%d, s˜ğ%p,…kt=%p.\n", 
¡©us
, 
si
, 
pkt
);

35 if(!
¡©us
 && 
pkt
->
cb_â
)

36 
pkt
->
	`cb_â
(pkt);

38 
	`ÿvium_ä“_dma
(
si
);

39 
	}
}

44 
šlše
 
oùeÚ_soá_š¡ruùiÚ_t
 *

45 
	$äcdrv_®loc_cmd_si
(
oùeÚ_deviû_t
 *
où
, 
äcdrv_cmd_pkt_t
 *
ıkt
, *
·¿m
)

47 
oùeÚ_soá_š¡ruùiÚ_t
 *
si
 = 
NULL
;

48 
ušt8_t
 *
d©a
, *
p
;

49 
ušt32_t
 
d©asize
 = 0;

51 
	`FRCDRV_DEBUG
("ıkt->wa™_tim%lu\n", 
ıkt
->
wa™_time
);

53 
d©asize
 = (
äcdrv_cmd_pkt_t
è+ (
ıkt
->
wa™_time
?16:0);

56 
d©asize
 +ğ(
äcÜe_cmd_t
è+ (
ıkt
->
cmd
.
Ën
) + 8;

58 
si
 = 
	`ÿvium_m®loc_dma
Ğ(
OCT_SOFT_INSTR_SIZE
 + 
d©asize
),

59 
__CAVIUM_MEM_ATOMIC
);

60 if(
si
 =ğ
NULL
){

61 
	`FRCDRV_ERROR
("malloc is fail!\n");

62  
NULL
;

65 
	`ÿvium_mem£t
(
si
, 0, (
OCT_SOFT_INSTR_SIZE
 + 
d©asize
) );

67 
	`ÿvium_memıy
(((
ušt8_t
 *)
si
 + 
OCT_SOFT_INSTR_SIZE
), 
ıkt
,

68 (
äcdrv_cmd_pkt_t
));

70 
si
->
ih
.
fsz
 = 16;

71 
si
->
ih
.
gty³
 = 
ORDERED_TAG
;

72 
si
->
ih
.
g
 = 0x11111111;

73 
si
->
ih
.
g½
 = 
FRC_CMD_GRP
;

74 
si
->
ih
.
¿w
 = 1;

75 
si
->
ih
.
rs
 = 1;

76 
si
->
œh
.
İcode
 = 
FRC_CMD_REQUEST_OP
;

77 
	`SET_SOFT_INSTR_DMA_MODE
(
si
, 
OCTEON_DMA_DIRECT
);

78 
	`SET_SOFT_INSTR_OCTEONID
(
si
, 
où
->
oùeÚ_id
);

79 
	`SET_SOFT_INSTR_IQ_NO
(
si
, 0);

80 
	`SET_SOFT_INSTR_CALLBACK
(
si
, 
äcdrv_cmd_ÿÎback
);

81 
	`SET_SOFT_INSTR_CALLBACK_ARG
(
si
, (*)si);

83 
d©a
 = (
ušt8_t
 *)
si
 + 
OCT_SOFT_INSTR_SIZE
 +

84 (
äcdrv_cmd_pkt_t
);

87 
	`ÿvium_memıy
(
d©a
, &
ıkt
->
cmd
, (
äcÜe_cmd_t
));

88 
	`oùeÚ_sw­_8B_d©a
((
ušt64_t
 *)
d©a
, ((
äcÜe_cmd_t
) >> 3));

90 ià(
ıkt
->
cmd
.
Ën
 && 
·¿m
)

92 
p
 = 
d©a
 + (
äcÜe_cmd_t
);

93 
	`ÿvium_memıy
(
p
, 
·¿m
, 
ıkt
->
cmd
.
Ën
);

94 
	`oùeÚ_sw­_8B_d©a
((
ušt64_t
 *)
p
, (
ıkt
->
cmd
.
Ën
 >> 3));

97 
si
->
d±r
 = 
d©a
;

98 
si
->
ih
.
dËngsz
 = (
äcÜe_cmd_t
è+ 
ıkt
->
cmd
.
Ën
;

102 if(
ıkt
->
wa™_time
) {

103 
si
->
½Œ
 = ((
ušt8_t
 *)si->
d±r
 + si->
ih
.
dËngsz
);

104 if(()
si
->
½Œ
 & 0x7) {

105 
si
->
½Œ
 = (*)((()si->rptr + 8) & ~0x7);

107 
si
->
œh
.
¾’ssz
 = 16;

108 
si
->
¡©us_wÜd
 = (
ušt64_t
 *)((
ušt8_t
 *)si->
½Œ
 + 8);

109 *(
si
->
¡©us_wÜd
èğ
COMPLETION_WORD_INIT
;

111 
	`SET_SOFT_INSTR_RESP_ORDER
(
si
, 
OCTEON_RESP_ORDERED
);

112 
	`SET_SOFT_INSTR_RESP_MODE
(
si
, 
OCTEON_RESP_NON_BLOCKING
);

113 
	`SET_SOFT_INSTR_TIMEOUT
(
si
, 
ıkt
->
wa™_time
);

115 
	`SET_SOFT_INSTR_RESP_ORDER
(
si
, 
OCTEON_RESP_NORESPONSE
);

118 
	`SET_SOFT_INSTR_ALLOCFLAGS
(
si
, 
OCTEON_SOFT_INSTR_DB_NOW
);

120 
	`ÿvium_´št
(
PRINT_FLOW
,

122 
__CVM_FUNCTION__
, 
si
, 
d©asize
, si->
d±r
, si->
½Œ
);

127  
si
;

128 
	}
}

132 
	$äcdrv_£nd_cmd_pkt
(
oùeÚ_deviû_t
 *
où
, 
äcdrv_cmd_pkt_t
 *
ıkt
, *
·¿m
)

134 
oùeÚ_š¡r_¡©us_t
 
»tv®
;

135 
oùeÚ_soá_š¡ruùiÚ_t
 *
si
 = 
NULL
;

137 ià(
ıkt
->
wa™_time
 == 0)

139 
ıkt
->
wa™_time
 = 6000;

142 
	`FRCDRV_DEBUG
("cpkt->cmd.type = 0x%.2x cpkt->cmd.cmd = 0x%.2x, cpkt->cmd.len = 0x%.4x\n",

143 
ıkt
->
cmd
.
ty³
, cpkt->cmd.cmd, cpkt->cmd.
Ën
);

144 #ifdeà
FRC_DEBUG_DRV


145 ià(
ıkt
->
cmd
.
Ën
 && 
·¿m
)

152 
si
 = 
	`äcdrv_®loc_cmd_si
(
où
, 
ıkt
, 
·¿m
);

153 if(
si
 =ğ
NULL
) {

154 
	`FRCDRV_ERROR
("soft instr‡lloc failed\n");

155  
FRE_FAIL
;

158 
»tv®
 = 
	`oùeÚ_´oûss_š¡ruùiÚ
(
où
, 
si
, 
NULL
);

159 if(
»tv®
.
u64
 =ğ
OCTEON_REQUEST_FAILED
) {

160 
	`FRCDRV_ERROR
("soft instr send failed\n");

161  
FRE_FAIL
;

164  
FRE_SUCCESS
;

165 
	}
}

169 
	gäcdrv_cmd_»¥Úd_by‹s
 = 0;

170 
	gäcdrv_cmd_»¥Úd_pkts
 = 0;

171 
	gäcdrv_cmd_»¥Úd_mš
 = 128;

172 
	gäcdrv_cmd_»¥Úd_max
 = 0;

174 
	gäcdrv_cmd_»¥Úd_´št_jiff›s
=0;

176 
	$äcdrv_cÜe_»¥Úd_di¥©ch
(
oùeÚ_»cv_šfo_t
 *
»cv_šfo
, *
¬g
)

178 
i
;

179 
oùeÚ_»cv_pkt_t
 *
»cv_pkt
 = 
»cv_šfo
->recv_pkt;

180 
ušt8_t
 *
p
, *
d©a
;

181 
ušt32_t
 
size
, 
sum
 = 0;

182 
äc_cmd_»¥Úd_t
 
»¥Úd
;

184 
	`FRCDRV_DEBUG
("»cv_šfØğ%p,‡rg = %p\n", 
»cv_šfo
, 
¬g
);

186 
	`mem£t
(&
»¥Úd
, 0, (respond));

188 
äcdrv_cmd_»¥Úd_by‹s
 +ğ
»cv_pkt
->
Ëngth
;

190 if(
»cv_pkt
->
Ëngth
 < 
äcdrv_cmd_»¥Úd_mš
)

191 
äcdrv_cmd_»¥Úd_mš
 = 
»cv_pkt
->
Ëngth
;

193 if(
»cv_pkt
->
Ëngth
 > 
äcdrv_cmd_»¥Úd_max
)

194 
äcdrv_cmd_»¥Úd_max
 = 
»cv_pkt
->
Ëngth
;

195 #ifdeà
FRCDRV_DUMP_RESPOND_STAT


196 
	`FRCDRV_DEBUG
("--- droq_di¥©ch…kˆ#%lu---\n", 
äcdrv_cmd_»¥Úd_pkts
);

197 
	`FRCDRV_DEBUG
("İcode: %x \n", 
»cv_pkt
->
»¥_hdr
.
İcode
);

198 
	`FRCDRV_DEBUG
("»que¡_id: %x \n", 
»cv_pkt
->
»¥_hdr
.
»que¡_id
);

199 
	`FRCDRV_DEBUG
("oùeÚ_id: %d \n", 
»cv_pkt
->
oùeÚ_id
);

200 
	`FRCDRV_DEBUG
("Ëngth: %d \n", 
»cv_pkt
->
Ëngth
);

201 
	`FRCDRV_DEBUG
("buf_couÁ: %d\n", 
»cv_pkt
->
bufãr_couÁ
);

205 if(
jiff›s
 <ğ(
äcdrv_cmd_»¥Úd_´št_jiff›s
 + 
HZ
)) {

206 
äcdrv_cmd_»¥Úd_´št_jiff›s
 = 
jiff›s
;

207 
	`´štk
("äcdrv_cmd_»¥Úd_by‹ ğ%d\n", 
äcdrv_cmd_»¥Úd_by‹s
);

208 
	`´štk
("äcdrv_cmd_»¥Úd_pkt  = %d\n", 
äcdrv_cmd_»¥Úd_pkts
);

209 
	`´štk
("äcdrv_cmd_»¥Úd_mš = %d\n", 
äcdrv_cmd_»¥Úd_mš
);

210 
	`´štk
("äcdrv_cmd_»¥Úd_max = %d\n", 
äcdrv_cmd_»¥Úd_max
);

217 #ifdeà
FRCDRV_DUMP_RESPOND_DATA


225 
i
 = 0 ; i < 
»cv_pkt
->
bufãr_couÁ
; i++) {

226 
d©a
 = (
ušt8_t
 *)(((
sk_buff
*)
»cv_pkt
->
bufãr_±r
[
i
])->data);

227 
size
 = 
»cv_pkt
->
bufãr_size
[
i
];

229 
	`´štk
("D©¨bufã¸#%d\n", 
i
);

230 
	`ÿvium_”rÜ_´št
(
d©a
, 
size
);

235 
p
 = (
ušt8_t
 *è&
»¥Úd
;

236 
sum
 = 0;

237 
i
 = 0 ; i < 
»cv_pkt
->
bufãr_couÁ
; i++) {

238 
d©a
 = (
ušt8_t
 *)(((
sk_buff
*)
»cv_pkt
->
bufãr_±r
[
i
])->data);

239 
size
 = 
»cv_pkt
->
bufãr_size
[
i
];

241 ià((
sum
 + 
size
è<ğ(
»¥Úd
))

243 
	`ÿvium_memıy
(
p
, 
d©a
, 
size
);

244 
p
 +ğ
size
;

245 
sum
 +ğ
size
;

251 
	`oùeÚ_sw­_8B_d©a
((
ušt64_t
 *è&
»¥Úd
, (respond) >> 3);

253 
	`oùeÚ_sw­_8B_d©a
((
ušt64_t
 *è&
»¥Úd
, 1);

256 ià(
	`äcdrv_cÜe_»q_»¥Úd
(&
»¥Úd
)) {

257 
	`FRCDRV_DEBUG
("RESPOND‡á”imeout: seq 0x%.8x.\n", 
»¥Úd
.
£q
);

260 
i
 = 0 ; i < 
»cv_pkt
->
bufãr_couÁ
; i++) {

261 
	`ä“_»cv_bufãr
(
»cv_pkt
->
bufãr_±r
[
i
]);

263 
	`ÿvium_ä“_dma
(
»cv_šfo
);

265 
äcdrv_cmd_»¥Úd_pkts
++;

267 
	}
}

269 
äc_li¡_t
 
	gäcdrv_cÜe_»q_h—d
;

270 
¥šlock_t
 
	gäcdrv_cÜe_»q_h—d_lock
 = 
SPIN_LOCK_UNLOCKED
;

271 
ušt32_t
 
	gäcdrv_cÜe_»qu£t_£q
 = 0;

273 
	$äcdrv_cÜe_»q_add
(
äcdrv_cÜe_»q_t
 *
cÜe_»q
)

275 
	`¥š_lock
(&
äcdrv_cÜe_»q_h—d_lock
);

276 
	`äc_li¡_add_
(&
cÜe_»q
->
node
, &
äcdrv_cÜe_»q_h—d
);

277 
äcdrv_cÜe_»qu£t_£q
++;

278 
cÜe_»q
->
£q
 = 
äcdrv_cÜe_»qu£t_£q
;

279 
cÜe_»q
->
¡©e
 = 
CORE_REQ_WAITING
;

280 
	`FRCDRV_DEBUG
("»¥Úd.ËÀğ%d\n", 
cÜe_»q
->
»¥Úd
.
Ën
);

281 
	`¥š_uÆock
(&
äcdrv_cÜe_»q_h—d_lock
);

282 
	}
}

284 
	$äcdrv_cÜe_»q_»move
(
äcdrv_cÜe_»q_t
 *
cÜe_»q
)

286 
	`¥š_lock
(&
äcdrv_cÜe_»q_h—d_lock
);

287 
	`äc_li¡_d–
(&
cÜe_»q
->
node
);

288 
	`¥š_uÆock
(&
äcdrv_cÜe_»q_h—d_lock
);

289 
	}
}

291 
	$äcdrv_cÜe_»q_»¥Úd
(
äc_cmd_»¥Úd_t
 *
»¥Úd
)

293 
äc_li¡_t
 *
node
;

294 
äcdrv_cÜe_»q_t
 *
cÜe_»q
;

295 
timeout
 = 1;

297 ià(
»¥Úd
 =ğ
NULL
) {

298 
	`FRCDRV_ERROR
("respond is NULL\n");

302 
	`¥š_lock
(&
äcdrv_cÜe_»q_h—d_lock
);

303 
	`äc_li¡_fÜ_—ch
(
node
, &
äcdrv_cÜe_»q_h—d
) {

304 
cÜe_»q
 = (
äcdrv_cÜe_»q_t
 *è
node
;

306 ià(
cÜe_»q
->
£q
 =ğ
»¥Úd
->seq)

308 
	`memıy
(&
cÜe_»q
->
»¥Úd
,„e¥Úd, (
äc_cmd_»¥Úd_t
));

309 
cÜe_»q
->
¡©e
 = 
CORE_REQ_RESPOND
;

310 
timeout
 = 0;

315 
	`¥š_uÆock
(&
äcdrv_cÜe_»q_h—d_lock
);

317  
timeout
;

318 
	}
}

321 
	$äcdrv_cÜe_»q_com¶‘iÚ
(*
pkt_±r
)

326 
	}
}

328 
	$äcdrv_cÜe_cmd
(
oùeÚ_deviû_t
 *
où
, 
ušt16_t
 
ty³
, ušt16_ˆ
cmd
, ušt16_ˆ
’
, *
šput
, ušt16_ˆ*
Ş’
, *
ouut
)

330 
rv
, 
i
;

331 
äcdrv_cmd_pkt_t
 *
ıkt
 = 
NULL
;

332 
äcdrv_cÜe_»q_t
 *
cÜe_»q
 = 
NULL
;

334 
out_Ën
 = 0;

335 ià(
’
 > 
FRC_CORE_CMD_ARG_MAX
)

337  
FRE_PARAM
;

340 
	`FRCDRV_DEBUG
("oct %p,ype %d, cmd %d, ilen %d, input %p, olen %p, output %p\n",

341 
où
, 
ty³
, 
cmd
, 
’
, 
šput
, 
Ş’
, 
ouut
);

343 ià(
Ş’
 !ğ
NULL
)

345 
out_Ën
 = *
Ş’
;

348 ià(
’
 > 
FRCORE_CMD_INPUT_MAX
)

350 
	`FRCDRV_ERROR
("’(%dè> FRCORE_CMD_INPUT_MAX(%d).\n", 
’
, 
FRCORE_CMD_INPUT_MAX
);

351  
FRE_PARAM
;

354 
cÜe_»q
 = 
	`äcdrv_m®loc
((
äcdrv_cÜe_»q_t
));

356 ià(
cÜe_»q
 =ğ
NULL
)

358 
	`FRCDRV_ERROR
("Can't malloc core_req.\n");

359 
rv
 = 
FRE_MEMORY
;

360 
äcdrv_cÜe_cmd_”rÜ
;

362 
	`mem£t
(
cÜe_»q
, 0, (
äcdrv_cÜe_»q_t
));

364 
ıkt
 = 
	`äcdrv_m®loc
((
äcdrv_cmd_pkt_t
));

365 ià(
ıkt
 =ğ
NULL
)

367 
	`FRCDRV_ERROR
("malloc frcdrv_cmd_pkt_t fail!\n");

368 
rv
 = 
FRE_MEMORY
;

369 
äcdrv_cÜe_cmd_”rÜ
;

371 
	`mem£t
(
ıkt
, 0, (
äcdrv_cmd_pkt_t
));

373 
	`äcdrv_cÜe_»q_add
(
cÜe_»q
);

374 
	`FRCDRV_DEBUG
("»¥Úd.ËÀğ%d\n", 
cÜe_»q
->
»¥Úd
.
Ën
);

375 
ıkt
->
cmd
.
ty³
 =ype;

376 
ıkt
->
wa™_time
 = 6000;

377 
ıkt
->
cb_â
 = 
NULL
;

379 
ıkt
->
cmd
.
£q
 = 
cÜe_»q
->seq;

380 
ıkt
->
cmd
.cmd = cmd;

382 
ıkt
->
cmd
.
Ën
 = 
’
;

384 
	`FRCDRV_DEBUG
("’ = %d, cpkt->cmd.ËÀğ%d\n", 
’
, 
ıkt
->
cmd
.
Ën
);

386 ià(
	`äcdrv_£nd_cmd_pkt
(
où
, 
ıkt
, 
šput
)) {

387 
	`FRCDRV_ERROR
("Send ssh DMA ctrl‡ddr fail!\n");

388 
rv
 = 
FRE_FAIL
;

389 
äcdrv_cÜe_cmd_”rÜ
;

392 
	`FRCDRV_DEBUG
("»¥Úd.ËÀğ%d\n", 
cÜe_»q
->
»¥Úd
.
Ën
);

394 
i
 = 0; i < 
FRCDRV_CORE_REQ_TIMEOUT
; i++)

396 
	`ÿvium_ud–ay
(
RECDRV_CORE_REQ_TIMEOUT_STEP
);

397 ià(
cÜe_»q
->
¡©e
 =ğ
CORE_REQ_RESPOND
)

403 
	`FRCDRV_DEBUG
("»¥Úd.ËÀğ%d\n", 
cÜe_»q
->
»¥Úd
.
Ën
);

404 ià(
i
 =ğ
FRCDRV_CORE_REQ_TIMEOUT
)

406 
	`FRCDRV_ERROR
("requestimeout\n");

407 
rv
 = 
FRE_TIMEOUT
;

408 
äcdrv_cÜe_cmd_”rÜ
;

411 
	`FRCDRV_DEBUG
("»¥Úd.ËÀğ%d\n", 
cÜe_»q
->
»¥Úd
.
Ën
);

413 ià(
out_Ën
 < 
cÜe_»q
->
»¥Úd
.
Ën
)

415 
rv
 = 
FRE_EXCEED
;

416 
äcdrv_cÜe_cmd_”rÜ
;

419 
rv
 = 
cÜe_»q
->
»¥Úd
.
»t
;

421 ià((
rv
 =ğ
FRE_SUCCESS
è&& (
Ş’
 !ğ
NULL
è&& (
ouut
 != NULL))

423 *
Ş’
 = 
cÜe_»q
->
»¥Úd
.
Ën
;

424 
	`memıy
(
ouut
, 
cÜe_»q
->
»¥Úd
.
d©a
, *
Ş’
);

427 
äcdrv_cÜe_cmd_”rÜ
:

428 ià(
cÜe_»q
 !ğ
NULL
)

430 
	`äcdrv_cÜe_»q_»move
(
cÜe_»q
);

431 
	`äcdrv_ä“
(
cÜe_»q
);

434 ià(
ıkt
 !ğ
NULL
)

436 
	`äcdrv_ä“
(
ıkt
);

439  
rv
;

440 
	}
}

443 
	$äcdrv_cmd_š™
(
oùeÚ_id
)

445 
	`FRCDRV_DEBUG
("äcdrv_cÜe_»¥Úd_di¥©ch = %p\n", 
äcdrv_cÜe_»¥Úd_di¥©ch
);

447 if(
	`oùeÚ_»gi¡”_di¥©ch_â
(
oùeÚ_id
, 
FRC_CMD_RESPOND_OP
, 
äcdrv_cÜe_»¥Úd_di¥©ch
, 
NULL
)) {

448 
	`FRCDRV_ERROR
("Registration failed for opcode: FRC_CMD_RESPOND_OP\n");

449  
FRE_FAIL
;

452 
	`FRC_INIT_LIST_HEAD
(&
äcdrv_cÜe_»q_h—d
);

454  
FRE_SUCCESS
;

455 
	}
}

458 
	$äcdrv_cmd_de¡roy
(
oùeÚ_id
)

460 
	`FRCDRV_DEBUG
("oùeÚ_id = %d.\n", 
oùeÚ_id
);

462 if(
	`oùeÚ_uÄegi¡”_di¥©ch_â
(
oùeÚ_id
, 
FRC_CMD_RESPOND_OP
)) {

463 
	`FRCDRV_ERROR
("Unregistration failed for opcode: FRC_CMD_RESPOND_OP\n");

464  
FRE_FAIL
;

467  
FRE_SUCCESS
;

468 
	}
}

	@frcdrv/frcdrv_cmd.h

1 #iâdeà
__FRCDRV_CMD_H__


2 
	#__FRCDRV_CMD_H__


	)

4 
	~"äc_cmd.h
"

5 
	~"äcÜe_ù¾.h
"

6 
	~"äc_li¡.h
"

8 
	#FRCDRV_CORE_REQ_TIMEOUT
 300

	)

9 
	#RECDRV_CORE_REQ_TIMEOUT_STEP
 10000

	)

11 (*
	täcdrv_cmd_pkt_cb_â_t
)(*);

18 
äcÜe_cmd_t
 
cmd
;

22 
wa™_time
;

26 
äcdrv_cmd_pkt_cb_â_t
 
cb_â
;

28 
rsvd
;

30 } 
	täcdrv_cmd_pkt_t
;

33 
äc_li¡_t
 
node
;

34 
ušt32_t
 
£q
;

35 
ušt32_t
 
¡©e
;

36 
äc_cmd_»¥Úd_t
 
»¥Úd
;

37 } 
	täcdrv_cÜe_»q_t
;

39 
	#CORE_REQ_WAITING
 0

	)

40 
	#CORE_REQ_RESPOND
 1

	)

42 
	#FRC_CTRL_CMD_SIZE
 ((
äcdrv_cmd_pkt_t
))

	)

44 
	`äcdrv_cmd_com¶‘iÚ
(*
ù¾_±r
);

46 
	`äcdrv_£nd_cmd_pkt
(
oùeÚ_deviû_t
 *
où
, 
äcdrv_cmd_pkt_t
 *
ıkt
, *
·¿m
);

47 
	`äcdrv_cmd_š™
(
oùeÚ_id
);

48 
	`äcdrv_cmd_de¡roy
(
oùeÚ_id
);

50 
	`äcdrv_cÜe_»q_»¥Úd
(
äc_cmd_»¥Úd_t
 *
»¥Úd
);

51 
	`äcdrv_cÜe_cmd
(
oùeÚ_deviû_t
 *
où
, 
ušt16_t
 
ty³
, ušt16_ˆ
cmd
, ušt16_ˆ
’
, *
šput
, ušt16_ˆ*
Ş’
, *
ouut
);

52 
	#äcÜe_£t
(
_où
, 
_ty³
, 
_cmd
, 
_’
, 
_šput
è
	`äcdrv_cÜe_cmd
(_où, _ty³, _cmd, _’, _šput, 
NULL
, NULL)

	)

	@frcdrv/frcdrv_dev.c

1 
	~"äcdrv.h
"

2 
	~"äc_ioùl.h
"

3 
	~"äcdrv_dev.h
"

4 
	~"äcdrv_dma.h
"

6 
	~"äcdrv_tı.h
"

7 
	~"äcdrv_udp.h
"

8 
	~"äcdrv_ruË.h
"

9 
	~"äcdrv_cmd.h
"

10 
	~"äcdrv_chª.h
"

12 
	gäc_deviû_majÜ
 = 0;

13 
äcdrv_v”siÚ_g‘
(*
v”siÚ
);

15 
	$äcdrv_pÜt_¡¬t
(
oùeÚ_deviû_t
 *
où
)

17 
rv
 = 
	`äcÜe_£t
(
où
, 
CMD_TYPE_CTRL
, 
CTRL_CMD_PORT_ENABLE
, 0, 
NULL
);

18 ià(
rv
 !ğ
FRE_SUCCESS
) {

19 
	`FRCDRV_ERROR
("CTRL_CMD_PORT_ENABLEƒxecu‹ fa:„v = %d.\n", 
rv
);

20  
rv
;

23  
FRE_SUCCESS
;

24 
	}
}

26 
	$äcdrv_¡¬t
(
oùeÚ_id
, 
oùeÚ_deviû_t
 *
oùeÚ_dev
)

28 
	`FRCDRV_DEBUG
("oùeÚ_id = %d, oùeÚ_dev = %p\n", 
oùeÚ_id
, 
oùeÚ_dev
);

30 ià(
	`äcdrv_cmd_š™
(
oùeÚ_id
))

32 
	`FRCDRV_ERROR
("CMD init fail!\n");

35 #ià
FRC_CONFIG_DMA_TEST


36 ià(
	`äcdrv_dma_¡¬t
(
oùeÚ_dev
))

38 
	`FRCDRV_ERROR
("start ssn fail!\n");

44 #ià
FRC_CONFIG_SIMPLE_PACKAGE


45 #ià
FRC_CONFIG_UDP


46 ià(
	`äcdrv_udp_chª_¡¬t
(
oùeÚ_dev
))

48 
	`FRCDRV_ERROR
("start udp fail!\n");

52 #ià
FRC_CONFIG_RULE


53 ià(
	`äcdrv_ruË_chª_¡¬t
(
oùeÚ_dev
))

55 
	`FRCDRV_ERROR
("start„ule fail!\n");

60 #ià
FRC_CONFIG_SSN_CHAN


61 #ià
FRC_CONFIG_SSN


62 ià(
	`äcdrv_s¢_¡¬t
(
oùeÚ_dev
))

64 
	`FRCDRV_ERROR
("start ssn fail!\n");

69 ià(
	`äcdrv_pÜt_¡¬t
(
oùeÚ_dev
))

71 
	`FRCDRV_ERROR
("start…ort fail!\n");

75 
	}
}

77 
	$äcdrv_»£t
(
oùeÚ_id
, *
oùeÚ_dev
)

79 
	`FRCDRV_DEBUG
("oùeÚ_id = %d, oùeÚ_dev = %p\n", 
oùeÚ_id
, 
oùeÚ_dev
);

82 
	}
}

84 
	$äcdrv_¡İ
(
oùeÚ_id
, *
oùeÚ_dev
)

86 
	`FRCDRV_DEBUG
("oùeÚ_id = %d, oùeÚ_dev = %p\n", 
oùeÚ_id
, 
oùeÚ_dev
);

88 
	`äcdrv_cmd_de¡roy
(
oùeÚ_id
);

90 
	}
}

102 
	$äcdrv_İ’
 (
šode
 *šode, 
fe
 *file)

104 
CVM_MOD_INC_USE_COUNT
;

106 
	}
}

110 
	$äcdrv_cmd_g‘_v”siÚ
(
äc_ioùl_t
 *
ioùl_¬g
)

112 
äc_v”siÚ_t
 
v”siÚ
;

114 ià(
ioùl_¬g
->
Ş’
 !ğ(
v”siÚ
))

116  
FRE_PARAM
;

118 
	`äcdrv_v”siÚ_g‘
(&
v”siÚ
);

120 
	`ÿvium_memıy
(
ioùl_¬g
->
ouut
, &
v”siÚ
, (version));

121 
ioùl_¬g
->
Ş’
 = (
v”siÚ
);

123  
FRE_SUCCESS
;

124 
	}
}

127 
	$äcdrv_cmd_g‘_ã©u»
(
äc_ioùl_t
 *
ioùl_¬g
)

129 
ušt64_t
 
ã©u»
 = 0;

132 ià(
ioùl_¬g
->
Ş’
 !ğ(
ušt64_t
))

134  
FRE_PARAM
;

137 
	#FEATURE_SUPPORT
(
_v®
, 
_ã©u»
) \

138 
_v®
 |ğ(1 << 
_ã©u»
)

	)

140 
	`FEATURE_SUPPORT
(
ã©u»
, 
FEATURE_TCP_SINGLE
);

141 
	`FEATURE_SUPPORT
(
ã©u»
, 
FEATURE_OCT1_NETNIC
);

142 #ià
FRC_CONFIG_LOCK_NET_XMIT


143 
	`FEATURE_SUPPORT
(
ã©u»
, 
REATURE_LOCK_XMIT
);

145 
	`ÿvium_memıy
(
ioùl_¬g
->
ouut
, &
ã©u»
, (
ušt64_t
));

146 
ioùl_¬g
->
Ş’
 = (
ušt64_t
);

148  
FRE_SUCCESS
;

149 
	}
}

152 
	$äcdrv_ioùl_äcdrv
(*
¬g
)

154 
»t
 = 0;

156 
äc_ioùl_t
 *
ioùl_¬g
 = (äc_ioùl_ˆ*è
¬g
;

157 
	`FRCDRV_DEBUG
("¬g = %p\n", 
¬g
);

158 
ioùl_¬g
->
cmd
)

160 
DRV_CMD_GET_VERSION
:

161 
»t
 = 
	`äcdrv_cmd_g‘_v”siÚ
(
ioùl_¬g
);

163 #ià
FRC_CONFIG_DMA_TEST


164 
DRV_CMD_DMA_LOOP_BUFF_GET
:

165 
»t
 = 
	`äcdrv_cmd_dma_loİ_buff_g‘
(
ioùl_¬g
);

168 
DRV_CMD_GET_FEATURE
:

169 
»t
 = 
	`äcdrv_cmd_g‘_ã©u»
(
ioùl_¬g
);

172 
DRV_CMD_GET_POOL_AND_RING_ADDR
:

173 
»t
 = 
	`äcdrv_cmd_poŞ_ªd_ršg_addr_g‘
(
ioùl_¬g
);

177 
	`FRCDRV_ERROR
("Unknown ioctlype\n");

178 
»t
 = -
ENOTTY
;

182 
ioùl_¬g
->
rv
 = 
»t
;

185 
	}
}

188 
	$äcdrv_ioùl_äcÜe
(
äc_ioùl_t
 *
¬g
)

190 
oùeÚ_deviû_t
 *
où
;

192 
	`FRCDRV_DEBUG
("did %d,ype %d, cmd %d, ilen %d, olen %d, input %p, output %p\n",

193 
¬g
->
did
,‡rg->
ty³
,‡rg->
cmd
,‡rg->
’
,‡rg->
Ş’
,‡rg->
šput
,‡rg->
ouut
);

195 
où
 = 
	`g‘_oùeÚ_deviû_±r
(
¬g
->
did
);

197 ià(
où
 =ğ
NULL
)

199  -
ENOTTY
;

202 
¬g
->
rv
 = 
	`äcdrv_cÜe_cmd
(
où
,‡rg->
ty³
,‡rg->
cmd
,‡rg->
’
,‡rg->
šput
, &¬g->
Ş’
,‡rg->
ouut
);

205 
	}
}

210 
	$äcdrv_ioùl
 (
šode
 *inode,

211 
fe
 *file,

212 
cmd
,

213 
¬g
)

215 
»tv®
=0;

217 
	`FRCDRV_DEBUG
("cmd = 0x%x.\n", 
cmd
);

218 
cmd
) {

219 
IOCTL_FRCDRV_REQUEST
:

220 
»tv®
 = 
	`äcdrv_ioùl_äcdrv
((*)
¬g
);

222 
IOCTL_FRCORE_REQUEST
:

223 
»tv®
 = 
	`äcdrv_ioùl_äcÜe
((*)
¬g
);

226 
	`FRCDRV_ERROR
("Unknown ioctl command\n");

227 
»tv®
 = -
ENOTTY
;

231  
»tv®
;

232 
	}
}

240 
	$äcdrv_»Ëa£
(
šode
 *šode, 
fe
 *file)

242 
CVM_MOD_DEC_USE_COUNT
;

244 
	}
}

246 
	$äc_com·t_ioùl
 (
fe
 *
f
, 
cmd
, 
¬g
)

248  (è
	`äcdrv_ioùl
 (
NULL
, 
f
, 
cmd
, 
¬g
);

249 
	}
}

253 
	$äc_uÆocked_ioùl
 (
fe
 *
f
,

254 
cmd
,

255 
¬g
)

257  (è
	`äcdrv_ioùl
 (
NULL
, 
f
, 
cmd
, 
¬g
);

258 
	}
}

261 
fe_İ”©iÚs
 
	gäcdrv_fİs
 =

263 
İ’
: 
äcdrv_İ’
,

264 
»Ëa£
: 
äcdrv_»Ëa£
,

265 
»ad
: 
NULL
,

266 
wr™e
: 
NULL
,

267 
ioùl
: 
äcdrv_ioùl
,

268 #ià
LINUX_VERSION_CODE
 > 
KERNEL_VERSION
(2,6,11)

269 
uÆocked_ioùl
: 
äc_uÆocked_ioùl
,

270 
com·t_ioùl
: 
äc_com·t_ioùl
,

272 
mm­
: 
NULL


275 
	$äcdrv_ba£_š™_moduË
()

277 
»t
 = 0;

279 
»t
 = 
	`»gi¡”_chrdev
(
äc_deviû_majÜ
, 
FRC_DEVICE_NAME
, &
äcdrv_fİs
);

280 if(
»t
 < 0) {

281 
	`FRCDRV_ERROR
("Deviû Regi¡¿tiÚ faed,ƒ¼Ü:%d\n", 
»t
);

283  
»t
;

285 ià(
äc_deviû_majÜ
 == 0)

287 
äc_deviû_majÜ
 = 
»t
;

290 #ià
FRC_CONFIG_DMA_TEST


291 ià(
	`äcdrv_dma_š™
())

293 
	`FRCDRV_ERROR
("DMA init fail!\n");

294 
äcdrv_ba£_š™_moduË_”r
;

299 #ià
FRC_CONFIG_SIMPLE_PACKAGE


300 ià(
	`äcdrv_sim¶e_·ckage_chª_š™
())

302 
	`FRCDRV_ERROR
("TCP init fail!\n");

303 
äcdrv_ba£_š™_moduË_”r
;

305 #ià
FRC_CONFIG_UDP


306 ià(
	`äcdrv_udp_chª_š™
())

308 
	`FRCDRV_ERROR
("UDP init fail!\n");

309 
»t
 = 1;

310 
äcdrv_ba£_š™_moduË_”r
;

313 #ià
FRC_CONFIG_RULE


314 ià(
	`äcdrv_ruË_chª_š™
())

316 
	`FRCDRV_ERROR
("UDP init fail!\n");

317 
»t
 = 1;

318 
äcdrv_ba£_š™_moduË_”r
;

323 #ià
FRC_CONFIG_SSN_CHAN


324 ià(
	`äcdrv_s¢_chª_š™
())

326 
	`FRCDRV_ERROR
("SSN chan init fail!\n");

327 
äcdrv_ba£_š™_moduË_”r
;

329 #ià
FRC_CONFIG_SSN


330 ià(
	`äcdrv_s¢_š™
())

332 
	`FRCDRV_ERROR
("ssn init fail!\n");

333 
»t
 = 1;

334 
äcdrv_ba£_š™_moduË_”r
;

338 
	`FRCDRV_DEBUG
("init success.\n");

341 
äcdrv_ba£_š™_moduË_”r
:

342 
	`uÄegi¡”_chrdev
(
äc_deviû_majÜ
, 
FRC_DEVICE_NAME
);

344 
	}
}

346 
	$äcdrv_ba£_ex™_moduË
()

348 
	`uÄegi¡”_chrdev
(
äc_deviû_majÜ
, 
FRC_DEVICE_NAME
);

350 #ià
FRC_CONFIG_DMA_TEST


351 
	`äcdrv_dma_de¡roy
();

354 #ià
FRC_CONFIG_SIMPLE_PACKAGE


355 
	`äcdrv_sim¶e_·ckage_chª_de¡roy
();

357 #ià
FRC_CONFIG_SSN_CHAN


358 
	`äcdrv_s¢_chª_de¡roy
();

360 
	`FRCDRV_DEBUG
("device unregister..done\n");

361 
	}
}

	@frcdrv/frcdrv_dev.h

1 #iâdeà
__FRCDRV_DEV_H__


2 
	#__FRCDRV_DEV_H__


	)

4 
äcdrv_¡¬t
(
oùeÚ_id
, 
oùeÚ_deviû_t
 *
oùeÚ_dev
);

5 
äcdrv_»£t
(
oùeÚ_id
, *
oùeÚ_dev
);

6 
äcdrv_¡İ
(
oùeÚ_id
, *
oùeÚ_dev
);

8 
äcdrv_ba£_š™_moduË
();

9 
äcdrv_ba£_ex™_moduË
();

	@frcdrv/frcdrv_dma.c

1 
	~<asm/·ge.h
>

2 
	~<lšux/¦ab.h
>

3 
	~<lšux/´oc_fs.h
>

5 
	~"äcdrv.h
"

7 
	~"äc_dma.h
"

8 
	~"äc_ioùl.h
"

9 
	~"äc_cmd.h
"

10 
	~"äcdrv_dma.h
"

11 
	~"äcdrv_cmd.h
"

14 
	$äcdrv_dma_block_ä“
(*
block_addr
)

16 
·ges
 = 0;

17 *
addr
;

18 
addr
 = (*è
block_addr
;

19 
·ges
 <ğ(
FRC_DMA_BUFF_PAGES
 -1))

21 
	`CË¬PageRe£rved
(
	`vœt_to_·ge
(
addr
));

23 
addr
 =‡dd¸+ 
PAGE_SIZE
;

24 
·ges
++;

26 
	`ä“_·ges
((è
block_addr
, 
FRC_DMA_BUFF_PAGES_ORDER
);

27 
	}
}

30 
	$äcdrv_dma_block_®loc
()

32 
·ges
 = 0;

33 *
addr
;

34 *
block_addr
;

36 
block_addr
 = (*è
	`__g‘_ä“_·ges
(
GFP_KERNEL
,
FRC_DMA_BUFF_PAGES_ORDER
);

38 ià(
block_addr
 == 0)

40  
NULL
;

43 
addr
 = (*)
block_addr
;

44 
·ges
 <ğ(
FRC_DMA_BUFF_PAGES
 - 1))

46 
	`S‘PageRe£rved
(
	`vœt_to_·ge
(
addr
));

47 
addr
 =‡dd¸+ 
PAGE_SIZE
;

48 
·ges
++;

51  
block_addr
;

52 
	}
}

56 
	$äcdrv_dma_poŞ_ä“
(*
poŞ_addr
)

58 
·ges
 = 0;

59 *
addr
;

60 
addr
 = (*è
poŞ_addr
;

61 
·ges
 <ğ(
FRC_DMA_BUFF_PAGES
 -1))

63 
	`CË¬PageRe£rved
(
	`vœt_to_·ge
(
addr
));

65 
addr
 =‡dd¸+ 
PAGE_SIZE
;

66 
·ges
++;

68 
	`ä“_·ges
((è
poŞ_addr
, 
FRC_DMA_BUFF_PAGES_ORDER
);

69 
	}
}

72 
	$äcdrv_dma_poŞ_®loc
()

74 
·ges
 = 0;

75 *
addr
;

76 *
block_addr
;

78 
block_addr
 = (*è
	`__g‘_ä“_·ges
(
GFP_KERNEL
,
FRC_DMA_BUFF_PAGES_ORDER
);

80 ià(
block_addr
 == 0)

82  
NULL
;

85 
addr
 = (*)
block_addr
;

86 
·ges
 <ğ(
FRC_DMA_BUFF_PAGES
 - 1))

88 
	`S‘PageRe£rved
(
	`vœt_to_·ge
(
addr
));

89 
addr
 =‡dd¸+ 
PAGE_SIZE
;

90 
·ges
++;

93  
block_addr
;

94 
	}
}

97 #ià
FRC_CONFIG_DMA_TEST


98 
äc_dma_loİ_buff_t
 *
	gdma_loİ_rx_buff
[
FRC_DAT_CORE_NUM
];

99 
äc_dma_loİ_buff_t
 *
	gdma_loİ_tx_buff
[
FRC_DAT_CORE_NUM
];

101 
	$äcdrv_cmd_dma_loİ_buff_g‘
(
äc_ioùl_t
 *
ioùl_¬g
)

103 
i
;

105 
äc_dma_loİ_¬g_t
 *
loİ_¬g
 = (äc_dma_loİ_¬g_ˆ*è
ioùl_¬g
->
ouut
;

107 
i
 = 0; i < 
FRC_DAT_CORE_NUM
; i++)

109 
loİ_¬g
->
rx_addr
[
i
] = 
	`__·
(
dma_loİ_rx_buff
[i]);

110 
loİ_¬g
->
tx_addr
[
i
] = 
	`__·
(
dma_loİ_tx_buff
[i]);

113 
ioùl_¬g
->
Ş’
 = (
äc_dma_loİ_¬g_t
);

115  
FRE_SUCCESS
;

116 
	}
}

120 
	$äcdrv_dma_¡¬t
(
oùeÚ_deviû_t
 *
où
)

122 #ià
FRC_CONFIG_DMA_TEST


123 
i
, 
rv
;

124 
äc_dma_loİ_buff_addr_t
 
buff_addr
;

127 
i
 = 0; i < 
FRC_DAT_CORE_NUM
; i++)

129 
buff_addr
.
cÜe_num
 = 
i
;

130 
buff_addr
.
rx_addr
 = (
ušt64_t
)
	`oùeÚ_pci_m­_sšgË
(
où
->
pci_dev
, 
dma_loİ_rx_buff
[
i
], 
FRC_DMA_BUFF_SIZE
, 
CAVIUM_PCI_DMA_TODEVICE
);

131 
buff_addr
.
tx_addr
 = (
ušt64_t
)
	`oùeÚ_pci_m­_sšgË
(
où
->
pci_dev
, 
dma_loİ_tx_buff
[
i
], 
FRC_DMA_BUFF_SIZE
, 
CAVIUM_PCI_DMA_TODEVICE
);

132 
	`FRCDRV_DEBUG
("%d:„x_add¸%Îx,x_add¸%Îx\n", 
i
, 
buff_addr
.
rx_addr
, buff_addr.
tx_addr
);

134 
rv
 = 
	`äcÜe_£t
(
où
, 
CMD_TYPE_CTRL
, 
CTRL_CMD_SETUP_DMA_LOOP_BUFF
, (
äc_dma_loİ_buff_addr_t
), &
buff_addr
);

135 ià(
rv
 !ğ
FRE_SUCCESS
) {

136 
	`FRCDRV_ERROR
("CTRL_CMD_SETUP_DMA_LOOP_BUFFƒxecu‹ fa:„v = %d.\n", 
rv
);

137  
rv
;

141  
FRE_SUCCESS
;

142 
	}
}

144 
	$äcdrv_dma_de¡roy
()

146 #ià
FRC_CONFIG_DMA_TEST


147 
i
;

148 
i
 = 0; i < 
FRC_DAT_CORE_NUM
; i++)

151 
	`FRCDRV_DEBUG
("%d: dma_loİ_rx_bufà%p, dma_loİ_tx_bufà%p\n", 
i
, 
dma_loİ_rx_buff
[i], 
dma_loİ_tx_buff
[i]);

152 ià(
dma_loİ_rx_buff
[
i
])

154 
	`äcdrv_dma_block_ä“
(
dma_loİ_rx_buff
[
i
]);

155 
dma_loİ_rx_buff
[
i
] = 
NULL
;

158 ià(
dma_loİ_tx_buff
[
i
])

160 
	`äcdrv_dma_block_ä“
(
dma_loİ_tx_buff
[
i
]);

161 
dma_loİ_tx_buff
[
i
] = 
NULL
;

167 
	}
}

169 
	$äcdrv_dma_š™
()

171 #ià
FRC_CONFIG_DMA_TEST


172 
i
;

173 
i
 = 0; i < 
FRC_DAT_CORE_NUM
; i++)

175 
dma_loİ_rx_buff
[
i
] = 
	`äcdrv_dma_block_®loc
();

176 ià(
dma_loİ_rx_buff
[
i
] =ğ
NULL
)

178 
	`FRCDRV_ERROR
("AÎoødm¨loİ„x bufà%d fa!\n", 
i
);

179  
FRE_MEMORY
;

181 
	`mem£t
(
dma_loİ_rx_buff
[
i
], 0, 
FRC_DMA_BUFF_SIZE
);

182 
dma_loİ_tx_buff
[
i
] = 
	`äcdrv_dma_block_®loc
();

183 ià(
dma_loİ_tx_buff
[
i
] =ğ
NULL
)

185 
	`FRCDRV_ERROR
("AÎoødm¨loİx bufà%d fa!\n", 
i
);

186  
FRE_MEMORY
;

188 
	`mem£t
(
dma_loİ_tx_buff
[
i
], 0, 
FRC_DMA_BUFF_SIZE
);

189 
	`FRCDRV_DEBUG
("%d: dma_loİ_rx_bufà%p, dma_loİ_tx_bufà%p\n", 
i
, 
dma_loİ_rx_buff
[i], 
dma_loİ_tx_buff
[i]);

192  
FRE_SUCCESS
;

193 
	}
}

	@frcdrv/frcdrv_dma.h

1 #iâdeà
__FRCDRV_DMA_H__


2 
	#__FRCDRV_DMA_H__


	)

4 
äcdrv_dma_block_ä“
(*
block_addr
);

5 * 
äcdrv_dma_block_®loc
();

6 
äcdrv_dma_poŞ_ä“
(*
block_addr
);

7 * 
äcdrv_dma_poŞ_®loc
();

8 
äcdrv_dma_¡¬t
(
oùeÚ_deviû_t
 *
où
);

9 
äcdrv_dma_š™
();

10 
äcdrv_dma_de¡roy
();

11 
äcdrv_cmd_dma_loİ_buff_g‘
(
äc_ioùl_t
 *
ioùl_¬g
);

	@frcdrv/frcdrv_intr.c

1 
	~"äc.h
"

2 
	~"äc.h
"

5 
skËt_¡ruù
 
	gäc_skËt
;

6 
ušt64_t
 
	gäc_skËt_couÁ
 = 0;

11 
	$äcdrv_bh
(
pdev
)

13 
oùeÚ_útq_t
 *
útq
;

14 
ušt32_t
 
q_no
, 
ssh_³ndšg
=0, 
ssh_´oûs£d
=0;

15 
oùeÚ_deviû_t
 *
oùeÚ_dev
 = (oùeÚ_deviû_ˆ*)
pdev
;

19 
	`´oûss_Üd”ed_li¡
(
oùeÚ_dev
);

20 
äc_skËt_couÁ
++;

22 
q_no
 = 0; q_nØ< 
MAX_OCTEON_DMA_QUEUES
; q_no++) {

23 
útq
 = (
oùeÚ_útq_t
 *)
oùeÚ_dev
->útq[
q_no
];

24 
ssh_³ndšg
 = 
	`ÿvium_©omic_»ad
(&
útq
->ssh_pending);

26 if(
ssh_³ndšg
) {

27 
	`ÿvium_¥š_lock
(&
útq
->
lock
);

28 
ssh_´oûs£d
 = 
	`äc_´oûss_ssh
(
oùeÚ_dev
, 
útq
);

29 
	`ÿvium_¥š_uÆock
(&
útq
->
lock
);

32 if(
ssh_´oûs£d
 < 
ssh_³ndšg
) {

33 
	`´oûss_Üd”ed_li¡
(
oùeÚ_dev
);

34 
	`ÿvium_skËt_scheduË
(&
äc_skËt
);

37 
	}
}

45 
	$äcdrv_šŒ_hªdËr
(*
dev
, 
ušt64_t
 
šŒ
)

47 
oùeÚ_útq_t
 *
útq
;

48 
oùeÚ_deviû_t
 *
oùeÚ_dev
 = (oùeÚ_deviû_ˆ*)
dev
;

49 
ušt32_t
 
q_no
, 
pkt_couÁ
, 
scheduË
=0;

50 
ušt64_t
 
mask
;

52 if(
oùeÚ_dev
->
ch_id
 <ğ
OCTEON_CN58XX
) {

53 
mask
 = 
PCI_INT_DMA0_MASK
;

55 if(
oùeÚ_dev
->
ch_id
 <ğ
OCTEON_CN56XX_PASS2
)

56 
mask
 = 
CN56XX_INTR_DMA0_DATA
;

58 
mask
 = 
CN63XX_INTR_DMA0_DATA
;

62 
q_no
 = 0; q_nØ< 
MAX_OCTEON_DMA_QUEUES
; q_no++, 
mask
 <<= 1) {

63 if(
šŒ
 & 
mask
) {

64 
útq
 = (
oùeÚ_útq_t
 *)
oùeÚ_dev
->útq[
q_no
];

65 
pkt_couÁ
 = 
	`OCTEON_READ32
(
útq
->
dma_út_»g
);

66 if(
pkt_couÁ
) {

67 
	`ÿvium_©omic_add
(
pkt_couÁ
, &
útq
->
ssh_³ndšg
);

68 
	`OCTEON_WRITE32
(
útq
->
dma_út_»g
, 
pkt_couÁ
);

69 
scheduË
=1;

71 
	`ÿvium_”rÜ
("OCTCNTQ: IÁ”ru± 0x%Îx w™h‚ØCNTQ[%d]…ack‘s\n", 
	`CVM_CAST64
(
šŒ
), 
q_no
);

74 if(
scheduË
)

75 
	`ÿvium_skËt_scheduË
(&
äc_skËt
);

77 
	}
}

81 
	$äcdrv_šŒ_š™
(
oùeÚ_id
)

83 
oùeÚ_deviû_t
 *
oùeÚ_dev
 = 
	`g‘_oùeÚ_deviû_±r
(
oùeÚ_id
);

85 
	`´štk
("%s.%d: oùeÚ_id=%d.\n", 
__func__
, 
__LINE__
, 
oùeÚ_id
);

86 if(
oùeÚ_dev
 =ğ
NULL
) {

87 
	`ÿvium_”rÜ
("OCTCNTQ: Unknown Octeon device %d in %s\n",

88 
oùeÚ_id
, 
__CVM_FUNCTION__
);

89  
ENODEV
;

91 
	`ÿvium_skËt_š™
(&
äc_skËt
, 
äc_bh
, ()
oùeÚ_dev
);

92 
oùeÚ_dev
->
dam_İs
.
bh
 = 
äc_bh
;

93 
oùeÚ_dev
->
dma_İs
.
šŒ_hªdËr
 = 
äc_šŒ_hªdËr
;

94 
oùeÚ_dev
->
dma_İs
.
»ad_¡©s
 = 
NULL
;

95 
oùeÚ_dev
->
dma_İs
.
»ad_¡©sb
 = 
NULL
;

98 
	}
}

	@frcdrv/frcdrv_intr.h

1 #iâdeà
__FRCDRV_INTR_H__


2 
	#__FRCDRV_INTR_H__


	)

4 
äcdrv_šŒ_š™
(
oùeÚ_id
);

	@frcdrv/frcdrv_main.c

27 
	~"ÿvium_sysd•.h
"

28 
	~"ÿvium_»Ëa£.h
"

29 
	~"äcdrv_ÃtwÜk.h
"

30 
	~"oùeÚ_maüos.h
"

31 
	~"oùeÚ_nic.h
"

33 
	~"äcdrv.h
"

34 
	~"äcdrv_dev.h
"

36 
MODULE_AUTHOR
("Cavium Networks");

37 
MODULE_DESCRIPTION
("Octeon Host PCI Nic Driver");

38 
MODULE_LICENSE
("Cavium Networks");

40 
äú‘_Çpi_drv_ÿÎback
(
où_id
, 
oq_no
, 
ev’t
);

42 
äcdev_´İs_t
 *
	gäırİs
[
MAX_OCTEON_DEVICES
];

47 
	#LINK_STATUS_REQUESTED
 1

	)

48 
	#LINK_STATUS_FETCHED
 2

	)

52 
šlše
 
äú‘_os_dev±r_t
 *

53 
	$äú‘_®loc_Ãtdev
(
sizeof_´iv
)

55  
	`®loc_Ãtdev
(
sizeof_´iv
, "où%d", 
‘h”_£tup
);

56 
	}
}

58 
šlše
 

59 
	$äú‘_ä“_Ãtdev
(
äú‘_os_dev±r_t
 *
dev
)

61  
	`ä“_Ãtdev
(
dev
);

62 
	}
}

66 #ià
defšed
(
OCTEON_EXCLUDE_BASE_LOAD
)

67 
g‘_ba£_compe_İtiÚs
(*
cİts
);

72 
	$g‘_nic_compe_İtiÚs
(*
cİts
)

74 #ià
	`defšed
(
OCTEON_EXCLUDE_BASE_LOAD
)

75 
	`g‘_ba£_compe_İtiÚs
(
cİts
);

78 if(
OCT_NIC_USE_NAPI
)

79 
	`¡rÿt
(
cİts
, "NAPI");

80 
	}
}

86 
	$äú‘_´št_lšk_šfo
(
äú‘_os_dev±r_t
 *
²dev
)

88 
äú‘_´iv_t
 *
´iv
 = 
	`GET_NETDEV_PRIV
(
²dev
);

90 if(
	`ÿvium_©omic_»ad
(&
´iv
->
if¡©e
è& 
OCT_NIC_IFSTATE_REGISTERED
) {

91 
où_lšk_šfo_t
 *
lšfo
 = &(
´iv
->linfo);

92 if(
lšfo
->
lšk
.
s
.
¡©us
)

93 
	`ÿvium_´št_msg
("FRCDRV: %s -> %d Mbps %s Duplex UP\n",

94 
	`äú‘_g‘_devÇme
(
²dev
), 
lšfo
->
lšk
.
s
.
¥“d
,

95 (
lšfo
->
lšk
.
s
.
du¶ex
)?"Full":"Half");

97 
	`ÿvium_´št_msg
("FRCDRV: %s Link Down\n",

98 
	`äú‘_g‘_devÇme
(
²dev
));

100 
	}
}

113 
šlše
 

114 
	$äú‘_upd©e_lšk_¡©us
(
äú‘_os_dev±r_t
 *
²dev
,

115 
où_lšk_¡©us_t
 *
ls
)

117 
äú‘_´iv_t
 *
´iv
 = 
	`GET_NETDEV_PRIV
(
²dev
);

118 
où_lšk_¡©us_t
 
´ev_¡
;

120 
´ev_¡
.
u64
 = 
´iv
->
lšfo
.
lšk
.u64;

121 
´iv
->
lšfo
.
lšk
.
u64
 = 
ls
->u64;

123 if(
´ev_¡
.
u64
 !ğ
ls
->u64) {

124 
	`äú‘_´št_lšk_šfo
(
²dev
);

125 if(
´iv
->
lšfo
.
lšk
.
s
.
¡©us
) {

126 
	`Ãtif_ÿ¼›r_Ú
(
²dev
);

127 
	`äú‘_¡¬t_txqueue
(
²dev
);

129 
	`Ãtif_ÿ¼›r_off
(
²dev
);

130 
	`äú‘_¡İ_txqueue
(
²dev
);

133 
	}
}

148 
	$äú‘_lšk_chªge_ÿÎback
(
oùeÚ_»q_¡©us_t
 
¡©us
, *
´İs_±r
)

150 
äcdev_´İs_t
 *
´İs
;

151 
où_lšk_¡©us_»¥_t
 *
ls
;

152 
ifidx
;

154 
´İs
 = (
äcdev_´İs_t
 *)
´İs_±r
;

155 
ls
 = 
´İs
->ls;

158 if(
ls
->
¡©us
) {

159 
	`ÿvium_©omic_£t
(&
´İs
->
ls_æag
, 
LINK_STATUS_FETCHED
);

164 
	`oùeÚ_sw­_8B_d©a
(&(
ls
->
lšk_couÁ
), 1);

167 
	`oùeÚ_sw­_8B_d©a
((
ušt64_t
 *)
ls
->
lšk_šfo
,

168 (
ls
->
lšk_couÁ
 * (
OCT_LINK_INFO_SIZE
 >> 3)));

170 
ifidx
 = 0; ifidx < 
ls
->
lšk_couÁ
; ifidx++) {

171 
	`äú‘_upd©e_lšk_¡©us
(
´İs
->
²dev
[
ifidx
],

172 &
ls
->
lšk_šfo
[
ifidx
].
lšk
);

175 
	`ÿvium_©omic_£t
(&
´İs
->
ls_æag
, 
LINK_STATUS_FETCHED
);

176 
	}
}

187 
	$äú‘_š™time_ls_ÿÎback
(
oùeÚ_»q_¡©us_t
 
¡©us
, *
buf
)

189 
où_lšk_¡©us_»¥_t
 *
lšk_¡©us
;

191 
lšk_¡©us
 = (
où_lšk_¡©us_»¥_t
 *)
buf
;

192 if(
lšk_¡©us
->
¡©us
)

193 
	`ÿvium_”rÜ
("FRCDRV: Lšk stu š¡ruùiÚ faed. Stus: %Îx\n", 
	`CVM_CAST64
(
lšk_¡©us
->
¡©us
));

194 
lšk_¡©us
->
s
.
cÚd
 = 1;

195 
	`ÿvium_wakeup
(&
lšk_¡©us
->
s
.
wc
);

196 
	}
}

209 
	$äú‘_g‘_š™time_lšk_¡©us
(*
où
,

210 *
´İs_±r
)

212 
äcdev_´İs_t
 *
´İs
;

213 
oùeÚ_soá_š¡ruùiÚ_t
 *
si
;

214 
où_lšk_¡©us_»¥_t
 *
ls
;

215 
oùeÚ_š¡r_¡©us_t
 
»tv®
;

217 
´İs
 = (
äcdev_´İs_t
 *)
´İs_±r
;

221 
si
 = 
´İs
->
si_lšk_¡©us
;

224 
ls
 = 
´İs
->ls;

225 
	`ÿvium_mem£t
(
ls
, 0, 
OCT_LINK_STATUS_RESP_SIZE
);

227 
	`ÿvium_š™_wa™_chªÃl
(&
ls
->
s
.
wc
);

228 
si
->
½Œ
 = &(
ls
->
»¥_hdr
);

229 
si
->
œh
.
¾’ssz
 = ( 
OCT_LINK_STATUS_RESP_SIZE
 - (
ls
->
s
) );

230 
si
->
¡©us_wÜd
 = (
ušt64_t
 *)&(
ls
->
¡©us
);

231 *(
si
->
¡©us_wÜd
èğ
COMPLETION_WORD_INIT
;

232 
ls
->
s
.
cÚd
 = 0;

233 
ls
->
s
.
oùeÚ_id
 = 
	`g‘_oùeÚ_deviû_id
(
où
);

234 
	`SET_SOFT_INSTR_OCTEONID
(
si
, 
ls
->
s
.
oùeÚ_id
);

235 
	`SET_SOFT_INSTR_CALLBACK
(
si
, 
äú‘_š™time_ls_ÿÎback
);

236 
	`SET_SOFT_INSTR_CALLBACK_ARG
(
si
, (*)
ls
);

240 
»tv®
 = 
	`oùeÚ_´oûss_š¡ruùiÚ
(
où
, 
si
, 
NULL
);

241 if(
»tv®
.
u64
 =ğ
OCTEON_REQUEST_FAILED
) {

242 
	`ÿvium_”rÜ
("FRCDRV: Link status instruction failed\n");

244  
EBUSY
;

249 
	`ÿvium_¦“p_timeout_cÚd
(&
ls
->
s
.
wc
, (*)&ls->s.
cÚd
, 1000);

251 (
ls
->
¡©us
);

252 
	}
}

264 
où_pŞl_â_¡©us_t


265 
	$äú‘_g‘_ruÁime_lšk_¡©us
(*
où
,

266 
´İs_±r
)

268 
äcdev_´İs_t
 *
´İs
;

269 
oùeÚ_soá_š¡ruùiÚ_t
 *
si
;

270 
où_lšk_¡©us_»¥_t
 *
ls
;

271 
oùeÚ_š¡r_¡©us_t
 
»tv®
;

274 
´İs
 = (
äcdev_´İs_t
 *)
´İs_±r
;

276 
si
 = 
´İs
->
si_lšk_¡©us
;

277 
ls
 = 
´İs
->ls;

280 if(
	`ÿvium_©omic_»ad
(&
´İs
->
ls_æag
è!ğ
LINK_STATUS_FETCHED
)

281  
OCT_POLL_FN_CONTINUE
;

283 
	`ÿvium_mem£t
(
ls
, 0, 
OCT_LINK_STATUS_RESP_SIZE
);

286 
si
->
½Œ
 = &(
ls
->
»¥_hdr
);

287 
si
->
œh
.
¾’ssz
 = ( 
OCT_LINK_STATUS_RESP_SIZE
 - (
ls
->
s
) );

288 
si
->
¡©us_wÜd
 = (
ušt64_t
 *)&(
ls
->
¡©us
);

289 *(
si
->
¡©us_wÜd
èğ
COMPLETION_WORD_INIT
;

290 
ls
->
s
.
cÚd
 = 0;

291 
ls
->
s
.
oùeÚ_id
 = 
	`g‘_oùeÚ_deviû_id
(
où
);

292 
	`SET_SOFT_INSTR_OCTEONID
(
si
, 
ls
->
s
.
oùeÚ_id
);

293 
	`SET_SOFT_INSTR_CALLBACK
(
si
, 
äú‘_lšk_chªge_ÿÎback
);

294 
	`SET_SOFT_INSTR_CALLBACK_ARG
(
si
, (*)
´İs
);

296 
	`ÿvium_©omic_£t
(&
´İs
->
ls_æag
, 
LINK_STATUS_REQUESTED
);

298 
»tv®
 = 
	`oùeÚ_´oûss_š¡ruùiÚ
(
où
, 
si
, 
NULL
);

299 if(
»tv®
.
u64
 =ğ
OCTEON_REQUEST_FAILED
) {

302 
	`ÿvium_©omic_£t
(&
´İs
->
ls_æag
, 
LINK_STATUS_FETCHED
);

304 
´İs
->
Ï¡_check
 = 
ÿvium_jiff›s
;

306  
OCT_POLL_FN_CONTINUE
;

307 
	}
}

315 #ifdeà
ETHERPCI


320 
	$äú‘_´•¬e_‘h”pci_lšks
(
où_lšk_¡©us_»¥_t
 *
lšk_¡©us
,

321 
couÁ
)

323 
i
;

325 
lšk_¡©us
->
lšk_couÁ
 = 
couÁ
;

327 
i
 = 0; i < 
couÁ
; i++) {

328 
ušt8_t
 *
hw_addr
;

330 
lšk_¡©us
->
lšk_šfo
[
i
].
lšk
.
u64
 = 0;

331 
lšk_¡©us
->
lšk_šfo
[
i
].
lšk
.
s
.
¥“d
 = 1000;

332 
lšk_¡©us
->
lšk_šfo
[
i
].
lšk
.
s
.
du¶ex
 = 1;

333 
lšk_¡©us
->
lšk_šfo
[
i
].
lšk
.
s
.
¡©us
 = 1;

334 
lšk_¡©us
->
lšk_šfo
[
i
].
lšk
.
s
.
mtu
 = 1500;

335 
hw_addr
 = (
ušt8_t
 *)&
lšk_¡©us
->
lšk_šfo
[
i
].hw_addr;

336 
hw_addr
[2] = 0x00;

337 
hw_addr
[3] = 0x01;

338 
hw_addr
[4] = 0x02;

339 
hw_addr
[5] = 0x03;

340 
hw_addr
[6] = 0x04;

341 
hw_addr
[7] = 0x05 + 
i
;

342 #ià 
__CAVIUM_BYTE_ORDER
 =ğ
__CAVIUM_LITTLE_ENDIAN


345 
lšk_¡©us
->
lšk_šfo
[
i
].
hw_addr
 =

346 
	`ENDIAN_SWAP_8_BYTE
(
lšk_¡©us
->
lšk_šfo
[
i
].
hw_addr
);

348 
lšk_¡©us
->
lšk_šfo
[
i
].
gmxpÜt
 = 16 + i;

349 
lšk_¡©us
->
lšk_šfo
[
i
].
pcÜt
 = 32 + i;

351 
	}
}

366 
	$äú‘_£tup_Ãt_queues
(
oùeÚ_id
, 
äú‘_´iv_t
 *
´iv
)

368 
oùeÚ_droq_İs_t
 
droq_İs
;

370 
	`mem£t
(&
droq_İs
, 0, (
oùeÚ_droq_İs_t
));

372 
droq_İs
.
åŒ
 = 
äú‘_push_·ck‘
;

374 if(
OCT_NIC_USE_NAPI
) {

375 
droq_İs
.
pŞl_mode
 = 1;

376 
droq_İs
.
Çpi_â
 = 
äú‘_Çpi_drv_ÿÎback
;

378 
droq_İs
.
drİ_Ú_max
 = 1;

382 
droq_İs
.
İ_mask
 = 0x1401;

383 
droq_İs
.
İ_majÜ
 = 0x1401;

386 
	`ÿvium_´št
(
PRINT_DEBUG
, "S‘tšg droq op fÜ q %d…Şl_mode: %d‚­i_â: %°åŒ: %°drİ: %d\n", 
´iv
->
rxq
, 
droq_İs
.
pŞl_mode
, droq_İs.
Çpi_â
, droq_İs.
åŒ
,

387 
droq_İs
.
drİ_Ú_max
);

391 if(
	`oùeÚ_»gi¡”_droq_İs
(
oùeÚ_id
, 
´iv
->
rxq
, &
droq_İs
)) {

392 
	`ÿvium_”rÜ
("FRCDRV: Failedo„egister DROQ function\n");

393  -
ENODEV
;

397 
	}
}

406 
	$äú‘_d–‘e_gli¡
(
äú‘_´iv_t
 *
´iv
)

408 
oùnic_g©h”
 *
g
;

411 
g
 = (
oùnic_g©h”
 *è
	`ÿvium_li¡_d–‘e_h—d
(&
´iv
->
gli¡
);

412 if(
g
) {

413 if(
g
->
sg
) {

414 
	`ÿvium_ä“_dma
Ğ(*)(()
g
->
sg
 - g->
adju¡
) );

416 
	`ÿvium_ä“_dma
(
g
);

418 }
g
);

419 
	}
}

426 
	$äú‘_£tup_gli¡
(
äú‘_´iv_t
 *
´iv
)

428 
i
;

429 
oùnic_g©h”
 *
g
;

431 
	`CAVIUM_INIT_LIST_HEAD
(&
´iv
->
gli¡
);

433 
i
 = 0; i < 
´iv
->
tx_qsize
; i++) {

434 
g
 = 
	`ÿvium_m®loc_dma
((
oùnic_g©h”
),

435 
__CAVIUM_MEM_GENERAL
);

436 if(
g
 =ğ
NULL
)

438 
	`mem£t
(
g
, 0, (
oùnic_g©h”
));

440 
g
->
sg_size
 = ((
	`ROUNDUP4
(
OCTNIC_MAX_SG
è>> 2)* 
OCT_SG_ENTRY_SIZE
);

442 
g
->
sg
 = 
	`ÿvium_m®loc_dma
(g->
sg_size
 + 8, 
__CAVIUM_MEM_GENERAL
);

443 if(
g
->
sg
 =ğ
NULL
) {

444 
	`ÿvium_ä“_dma
(
g
);

449 ifĞ(()
g
->
sg
) & 7) {

450 
g
->
adju¡
 = 8 - ( (()g->
sg
) & 7);

451 
g
->
sg
 = (
oùeÚ_sg_’Œy_t
 *)(()g->sg + g->
adju¡
);

453 
	`ÿvium_li¡_add_
(&
g
->
li¡
, &
´iv
->
gli¡
);

457 if(
i
 =ğ
´iv
->
tx_qsize
)

460 
	`äú‘_d–‘e_gli¡
(
´iv
);

462 
	}
}

468 
	$äú‘_£nd_rx_ù¾_cmd
(
äú‘_´iv_t
 *
´iv
, 
¡¬t_¡İ
)

470 
oùnic_ù¾_pkt_t
 
nù¾
;

472 
	`mem£t
(&
nù¾
, 0, (
oùnic_ù¾_pkt_t
));

474 
nù¾
.
ncmd
.
s
.
cmd
 = 
OCTNET_CMD_RX_CTL
;

475 
nù¾
.
ncmd
.
s
.
·¿m1
 = 
´iv
->
lšfo
.
gmxpÜt
;

476 
nù¾
.
ncmd
.
s
.
·¿m2
 = 
¡¬t_¡İ
;

477 
nù¾
.
Ãndev
 = ()
´iv
->
²dev
;

479 #ià !
	`defšed
(
ETHERPCI
)

480 if(
	`oùÃt_£nd_nic_ù¾_pkt
(
´iv
->
où_dev
, &
nù¾
)) {

481 
	`ÿvium_”rÜ
("FRCDRV: Failedo send RX Control message\n");

486 
	}
}

499 
	$äú‘_de¡roy_nic_deviû
(
oùeÚ_id
, 
ifidx
)

501 
äú‘_os_dev±r_t
 *
²dev
 = 
äırİs
[
oùeÚ_id
]->²dev[
ifidx
];

502 
äú‘_´iv_t
 *
´iv
;

503 
»tv®
 = 0;

505 if(
²dev
 =ğ
NULL
) {

506 
	`ÿvium_”rÜ
("FRCDRV: %s No‚etdevice…tr for index %d\n",

507 
__CVM_FUNCTION__
, 
ifidx
);

511 
´iv
 = 
	`GET_NETDEV_PRIV
(
²dev
);

513 
	`äú‘_£nd_rx_ù¾_cmd
(
´iv
, 0);

515 if(
	`ÿvium_©omic_»ad
(&
´iv
->
if¡©e
è& 
OCT_NIC_IFSTATE_DROQ_OPS
) {

516 
»tv®
 = 
	`oùeÚ_uÄegi¡”_droq_İs
(
oùeÚ_id
, 
ifidx
);

517 if(
»tv®
) {

518 
	`ÿvium_”rÜ
("FRCDRV: Failedo unregister DROQ function\n");

522 if(
	`ÿvium_©omic_»ad
(&
´iv
->
if¡©e
è& 
OCT_NIC_IFSTATE_RUNNING
)

523 
	`Ãtif_¡İ_queue
(
²dev
);

525 if(
	`ÿvium_©omic_»ad
(&
´iv
->
if¡©e
è& 
OCT_NIC_IFSTATE_REGISTERED
)

526 
	`uÄegi¡”_Ãtdev
(
²dev
);

528 
	`äú‘_d–‘e_gli¡
(
´iv
);

530 
	`äú‘_ä“_Ãtdev
(
²dev
);

532 
äırİs
[
oùeÚ_id
]->
²dev
[
ifidx
] = 
NULL
;

533 
	}
}

538 
	$äú‘_£tup_Çpi
(
äú‘_´iv_t
 *
´iv
)

540 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2,6,24)

541 
	`Ãtif_Çpi_add
(
´iv
->
²dev
, &´iv->
Çpi
, 
äú‘_Çpi_pŞl
, 64);

543 
´iv
->
²dev
->
pŞl
 = 
äú‘_Çpi_pŞl
;

544 
´iv
->
²dev
->
weight
 = 64;

545 
	`£t_b™
(
__LINK_STATE_START
, &
´iv
->
²dev
->
¡©e
);

547 
	}
}

551 #ià 
LINUX_VERSION_CODE
 >ğ
KERNEL_VERSION
(2,6,29)

552 cÚ¡ 
Ãt_deviû_İs
 
	goùÃtdevİs
 = {

553 .
ndo_İ’
 = 
äú‘_İ’
,

554 .
	gndo_¡İ
 = 
äú‘_¡İ
,

555 .
	gndo_¡¬t_xm™
 = 
äú‘_xm™
,

556 .
	gndo_g‘_¡©s
 = 
äú‘_¡©s
,

557 .
	gndo_£t_mac_add»ss
 = 
äú‘_£t_mac
,

558 .
	gndo_£t_muÉiÿ¡_li¡
 = 
äú‘_£t_mÿ¡_li¡
,

559 .
	gndo_tx_timeout
 = 
äú‘_tx_timeout
,

560 .
	gndo_chªge_mtu
 = 
äú‘_chªge_mtu
,

566 
äú‘_Çpi_’abË
(
äú‘_´iv_t
 *
´iv
);

575 
	$äú‘_£tup_nic_deviû
(
oùeÚ_id
, 
où_lšk_šfo_t
 *
lšk_šfo
, 
ifidx
)

577 
äú‘_´iv_t
 *
´iv
;

578 
äú‘_os_dev±r_t
 *
²dev
;

579 
ušt8_t
 
maÿddr
[6], 
i
;

581 
²dev
 = 
	`äú‘_®loc_Ãtdev
(
OCTNET_PRIV_SIZE
);

582 if(!
²dev
) {

583 
	`ÿvium_”rÜ
("FRCDRV: Device‡llocation failed\n");

584  -
ENOMEM
;

587 
äırİs
[
oùeÚ_id
]->
²dev
[
ifidx
] =…ndev;

590 #ià 
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2,6,29)

591 
²dev
->
Ãtdev_İs
 = &
oùÃtdevİs
;

593 
²dev
->
İ’
 = 
äú‘_İ’
;

594 
²dev
->
¡İ
 = 
äú‘_¡İ
;

595 
²dev
->
h¬d_¡¬t_xm™
 = 
äú‘_xm™
;

596 
²dev
->
g‘_¡©s
 = 
äú‘_¡©s
;

597 
²dev
->
£t_mac_add»ss
 = 
äú‘_£t_mac
;

598 
²dev
->
£t_muÉiÿ¡_li¡
 = 
äú‘_£t_mÿ¡_li¡
;

599 
²dev
->
tx_timeout
 = 
äú‘_tx_timeout
;

600 
²dev
->
chªge_mtu
 = 
äú‘_chªge_mtu
;

603 #ià!
	`defšed
(
ETHERPCI
)

604 
²dev
->
ã©u»s
 = 
NETIF_F_HW_CSUM
;

605 
²dev
->
ã©u»s
 |ğ
NETIF_F_SG
;

608 
´iv
 = 
	`GET_NETDEV_PRIV
(
²dev
);

609 
	`ÿvium_mem£t
(
´iv
, 0, (
äú‘_´iv_t
));

611 
´iv
->
ifidx
 = ifidx;

615 
´iv
->
où_dev
 = 
	`g‘_oùeÚ_deviû_±r
(
oùeÚ_id
);

616 
´iv
->
äırİs
 = frırİs[
oùeÚ_id
];

617 
´iv
->
²dev
 =…ndev;

618 
	`ÿvium_¥š_lock_š™
(&(
´iv
->
lock
));

619 #ià
FRC_CONFIG_LOCK_NET_XMIT


620 
	`ÿvium_¥š_lock_š™
(&(
´iv
->
xm™_lock
));

625 
´iv
->
lšfo
.
gmxpÜt
 = 
lšk_šfo
->gmxport;

629 
´iv
->
lšfo
.
pcÜt
 = 
lšk_šfo
->pciport;

631 
´iv
->
lšfo
.
hw_addr
 = 
lšk_šfo
->hw_addr;

633 if(
OCT_NIC_USE_NAPI
) {

634 
	`äú‘_£tup_Çpi
(
´iv
);

637 
	`ÿvium_´št
(
PRINT_DEBUG
, "FRCDRV: if%d gmx: %d…ci: %d hw_addr: 0x%llx\n",

638 
ifidx
, 
´iv
->
lšfo
.
gmxpÜt
,…riv->lšfo.
pcÜt
,

639 
	`CVM_CAST64
(
´iv
->
lšfo
.
hw_addr
));

642 
	`oùeÚ_sw­_8B_d©a
(&
´iv
->
lšfo
.
hw_addr
, 1);

643 
i
 = 0; i < 6; i++)

644 
maÿddr
[
i
] = *((
ušt8_t
 *)(((ušt8_ˆ*)&
´iv
->
lšfo
.
hw_addr
) + 2 + i));

647 
	`ÿvium_memıy
(
²dev
->
dev_addr
, &
maÿddr
, 
ETH_ALEN
);

649 
´iv
->
lšfo
.
lšk
.
u64
 = 
lšk_šfo
->link.u64;

652 
´iv
->
tx_qsize
 = 
	`oùeÚ_g‘_tx_qsize
(
oùeÚ_id
,…riv->
txq
);

653 
´iv
->
rx_qsize
 = 
	`oùeÚ_g‘_rx_qsize
(
oùeÚ_id
,…riv->
rxq
);

655 if(
	`äú‘_£tup_gli¡
(
´iv
)) {

656 
	`ÿvium_”rÜ
("FRCDRV: Gather†ist‡llocation failed\n");

657 
£tup_nic_dev_ç
;

660 
	`OCTNET_IFSTATE_SET
(
´iv
, 
OCT_NIC_IFSTATE_DROQ_OPS
);

663 if(
	`»gi¡”_Ãtdev
(
²dev
)) {

664 
	`ÿvium_”rÜ
("FRCDRV: Device„egistration failed\n");

665 
£tup_nic_dev_ç
;

668 
	`Ãtif_ÿ¼›r_off
(
²dev
);

670 if(
´iv
->
lšfo
.
lšk
.
s
.
¡©us
) {

671 
	`Ãtif_ÿ¼›r_Ú
(
²dev
);

672 
	`äú‘_¡¬t_txqueue
(
²dev
);

674 
	`Ãtif_ÿ¼›r_off
(
²dev
);

680 #ifdeà
ETHERPCI


681 
´iv
->
txq
 = 
ifidx
;…riv->
rxq
 = ifidx;

682 if(
	`äú‘_£tup_Ãt_queues
(
oùeÚ_id
, 
´iv
))

683 
£tup_nic_dev_ç
;

687 
´iv
->
txq
 =…riv->
rxq
 = (´iv->
lšfo
.
pcÜt
 - 32);

688 if(
	`äú‘_£tup_Ãt_queues
(
oùeÚ_id
, 
´iv
))

689 
£tup_nic_dev_ç
;

690 if(
OCT_NIC_USE_NAPI
)

691 
	`äú‘_Çpi_’abË
(
´iv
);

694 
	`OCTNET_IFSTATE_SET
(
´iv
, 
OCT_NIC_IFSTATE_REGISTERED
);

696 
	`äú‘_£nd_rx_ù¾_cmd
(
´iv
, 1);

698 
	`äú‘_´št_lšk_šfo
(
²dev
);

702 
£tup_nic_dev_ç
:

703 
	`äú‘_de¡roy_nic_deviû
(
oùeÚ_id
, 
ifidx
);

704  -
ENODEV
;

706 
	}
}

712 #ià!
defšed
(
ETHERPCI
)

715 
	$äú‘_´•¬e_ls_soá_š¡r
(*
où
, 
oùeÚ_soá_š¡ruùiÚ_t
 *
si
)

718 
	`ÿvium_mem£t
(
si
, 0, 
OCT_SOFT_INSTR_SIZE
);

720 
si
->
ih
.
fsz
 = 16;

721 
si
->
ih
.
gty³
 = 
ORDERED_TAG
;

722 
si
->
ih
.
g
 = 0x11111111;

723 
si
->
ih
.
¿w
 = 1;

724 
si
->
ih
.
g½
 = 
FRC_CMD_GRP
;

725 
si
->
œh
.
İcode
 = 
HOST_NW_INFO_OP
;

726 
si
->
œh
.
·¿m
 = 32;

727 
	`SET_SOFT_INSTR_DMA_MODE
(
si
, 
OCTEON_DMA_DIRECT
);

728 
	`SET_SOFT_INSTR_RESP_ORDER
(
si
, 
OCTEON_RESP_ORDERED
);

729 
	`SET_SOFT_INSTR_RESP_MODE
(
si
, 
OCTEON_RESP_NON_BLOCKING
);

730 
	`SET_SOFT_INSTR_IQ_NO
(
si
, 0);

731 
	`SET_SOFT_INSTR_TIMEOUT
(
si
, 100);

737 
	`SET_SOFT_INSTR_ALLOCFLAGS
(
si
, 
OCTEON_SOFT_INSTR_DB_NOW
);

738 
si
->
d±r
 = 
NULL
;

739 
si
->
ih
.
dËngsz
 = 0;

740 
	}
}

755 
	$äú‘_š™_nic_moduË
(
oùeÚ_id
, *
oùeÚ_dev
)

757 
où_lšk_¡©us_»¥_t
 *
ls
 = 
NULL
;

758 
oùeÚ_soá_š¡ruùiÚ_t
 *
si
 = 
NULL
;

759 
ifidx
, 
»tv®
 = 0;

761 
	`ÿvium_´št_msg
("FRCDRV: Initializing‚etwork interfaces for Octeon %d\n",

762 
oùeÚ_id
);

765 
äırİs
[
oùeÚ_id
] = 
	`ÿvium_®loc_vœt
((
äcdev_´İs_t
));

766 if(
äırİs
[
oùeÚ_id
] =ğ
NULL
) {

767 
	`ÿvium_”rÜ
("FRCDRV: AÎoøçed‡ˆ%s:%d\n", 
__CVM_FUNCTION__
, 
__CVM_LINE__
);

768  -
ENOMEM
;

770 
	`ÿvium_mem£t
(
äırİs
[
oùeÚ_id
], 0, (
äcdev_´İs_t
));

773 
ls
 = 
	`ÿvium_m®loc_dma
((
où_lšk_¡©us_»¥_t
),

774 
__CAVIUM_MEM_GENERAL
);

775 if(
ls
 =ğ
NULL
) {

776 
	`ÿvium_”rÜ
("FRCDRV: AÎoøçed‡ˆ%s:%d\n", 
__CVM_FUNCTION__
, 
__CVM_LINE__
);

777 
	`ÿvium_ä“_vœt
(
äırİs
[
oùeÚ_id
]);

778 
äırİs
[
oùeÚ_id
] = 
NULL
;

779  -
ENOMEM
;

782 
äırİs
[
oùeÚ_id
]->
ls
 =†s;

787 
si
 = (
oùeÚ_soá_š¡ruùiÚ_t
 *)

788 
	`ÿvium_®loc_bufãr
(
oùeÚ_dev
, 
OCT_SOFT_INSTR_SIZE
);

789 if(
si
 =ğ
NULL
) {

790 
	`ÿvium_”rÜ
("FRCDRV: soft instr‡llocation failed in‚et setup\n");

791 
	`ÿvium_ä“_dma
(
ls
);

792 
	`ÿvium_ä“_vœt
(
äırİs
[
oùeÚ_id
]);

793 
äırİs
[
oùeÚ_id
] = 
NULL
;

794  
ENOMEM
;

797 
äırİs
[
oùeÚ_id
]->
si_lšk_¡©us
 = 
si
;

800 #ifdeà 
ETHERPCI


803 
	`äú‘_´•¬e_‘h”pci_lšks
(
ls
, 
MAX_OCTEON_LINKS
);

807 
	`äú‘_´•¬e_ls_soá_š¡r
(
oùeÚ_dev
, 
si
);

810 if(
	`äú‘_g‘_š™time_lšk_¡©us
(
oùeÚ_dev
, 
äırİs
[
oùeÚ_id
])) {

811 
	`ÿvium_”rÜ
("FRCDRV: Link initialization failed\n");

812 
äú‘_š™_çu»
;

816 
	`oùeÚ_sw­_8B_d©a
(&(
ls
->
lšk_couÁ
), 1);

818 
	`oùeÚ_sw­_8B_d©a
((
ušt64_t
 *)
ls
->
lšk_šfo
,

819 (
ls
->
lšk_couÁ
 * (
OCT_LINK_INFO_SIZE
 >> 3)));

823 
äırİs
[
oùeÚ_id
]->
ifcouÁ
 = 
ls
->
lšk_couÁ
;

825 
	`oùeÚ_»gi¡”_nÜe¥_buf_ä“_â
(
oùeÚ_id
, 
NORESP_BUFTYPE_NET
,

826 
oùnic_ä“_Ãtbuf
);

828 
	`oùeÚ_»gi¡”_nÜe¥_buf_ä“_â
(
oùeÚ_id
, 
NORESP_BUFTYPE_NET_SG
,

829 
oùnic_ä“_Ãtsgbuf
);

834 
ifidx
 = 0; ifidx < 
ls
->
lšk_couÁ
; ifidx++) {

835 
»tv®
 =

836 
	`äú‘_£tup_nic_deviû
(
oùeÚ_id
, &
ls
->
lšk_šfo
[
ifidx
], ifidx);

837 if(
»tv®
) {

838 
ifidx
--) {

839 
	`äú‘_de¡roy_nic_deviû
(
oùeÚ_id
, 
ifidx
);

840 
äú‘_š™_çu»
;

845 
	`ÿvium_©omic_£t
(&
äırİs
[
oùeÚ_id
]->
ls_æag
, 
LINK_STATUS_FETCHED
);

846 
äırİs
[
oùeÚ_id
]->
Ï¡_check
 = 
ÿvium_jiff›s
;

848 #ià!
	`defšed
(
ETHERPCI
)

852 
oùeÚ_pŞl_İs_t
 
pŞl_İs
;

853 
pŞl_İs
.
â
 = 
äú‘_g‘_ruÁime_lšk_¡©us
;

854 
pŞl_İs
.
â_¬g
 = ()
äırİs
[
oùeÚ_id
];

855 
pŞl_İs
.
ticks
 = 
CAVIUM_TICKS_PER_SEC
;

856 
	`¡rıy
(
pŞl_İs
.
Çme
, "NIC Link Status");

857 
	`oùeÚ_»gi¡”_pŞl_â
(
oùeÚ_id
, &
pŞl_İs
);

861 
	`ÿvium_´št_msg
("FRCDRV: Network interfaces„eady for Octeon %d\n",

862 
oùeÚ_id
);

864  
»tv®
;

866 
äú‘_š™_çu»
:

867 
	`ÿvium_”rÜ
("FRCDRV: Initialization Failed\n");

868 if(
si
)

869 
	`ÿvium_ä“_bufãr
(
oùeÚ_dev
, 
si
);

870 if(
ls
)

871 
	`ÿvium_ä“_dma
(
ls
);

872 
	`ÿvium_ä“_vœt
(
äırİs
[
oùeÚ_id
]);

873 
äırİs
[
oùeÚ_id
] = 
NULL
;

875  
»tv®
;

876 
	}
}

891 
	$äú‘_¡İ_nic_moduË
(
oùeÚ_id
, *
oùeÚ_dev
)

893 
i
;

895 
	`ÿvium_´št_msg
("FRCDRV: Stİpšg‚‘wÜk iÁ”çû fÜ OùeÚ deviû %d\n", 
oùeÚ_id
 );

896 if(
äırİs
[
oùeÚ_id
] =ğ
NULL
) {

897 
	`ÿvium_”rÜ
("FRCDRV: In™ fÜ OùeÚ%d wa nÙ com¶‘ed\n",
oùeÚ_id
);

901 
	`oùeÚ_uÄegi¡”_pŞl_â
(
oùeÚ_id
, 
äú‘_g‘_ruÁime_lšk_¡©us
,

902 ()
äırİs
[
oùeÚ_id
]);

904 
i
 = 0; i < 
äırİs
[
oùeÚ_id
]->
ifcouÁ
; i++) {

905 
	`äú‘_de¡roy_nic_deviû
(
oùeÚ_id
, 
i
);

910 if(
äırİs
[
oùeÚ_id
]->
ls
) {

911 
	`ÿvium_ä“_dma
(
äırİs
[
oùeÚ_id
]->
ls
);

915 
	`ÿvium_ä“_vœt
(
äırİs
[
oùeÚ_id
]);

917 
äırİs
[
oùeÚ_id
] = 
NULL
;

919 
	`ÿvium_´št_msg
("FRCDRV: Network interfaces stopped for Octeon %d\n",

920 
oùeÚ_id
);

922 
	}
}

928 
	$äcdrv_¡İ_moduË
(
oùeÚ_id
, *
oùeÚ_dev
)

930 
»tv®
;

931 #ifdeà
FRC_CONFIG_NIC


932 
	`FRCDRV_DEBUG
("Support NIC.\n");

933 
»tv®
 = 
	`äú‘_¡İ_nic_moduË
(
oùeÚ_id
, 
oùeÚ_dev
);

935 ià(
»tv®
)

937  
»tv®
;

940 
	`FRCDRV_DEBUG
("Unsupport NIC.\n");

943 #ifdeà
FRC_CONFIG_FR


944 
	`FRCDRV_DEBUG
("Support flow„estoration.\n");

945 
»tv®
 = 
	`äcdrv_¡İ
(
oùeÚ_id
, 
oùeÚ_dev
);

947 
	`FRCDRV_DEBUG
("Unsupport flow„estoration.\n");

950 
	`ş—nup_moduË
();

951  
»tv®
;

952 
	}
}

955 
	$äcdrv_¡¬t_moduË
(
oùeÚ_id
, *
oùeÚ_dev
)

957 
»tv®
 = 0;

958 
	`FRCDRV_DEBUG
("==========ğoùeÚ_id = %d\n", 
oùeÚ_id
);

959 #ifdeà
FRC_CONFIG_NIC


960 
	`FRCDRV_DEBUG
("Support NIC.\n");

961 
»tv®
 = 
	`äú‘_š™_nic_moduË
(
oùeÚ_id
, 
oùeÚ_dev
);

962 ià(
»tv®
)

964 
	`äcdrv_¡İ_moduË
(
oùeÚ_id
,
oùeÚ_dev
);

965  
»tv®
;

968 
	`FRCDRV_DEBUG
("Unsupport NIC.\n");

971 #ifdeà
FRC_CONFIG_FR


972 
	`FRCDRV_DEBUG
("Support flow„estoration.\n");

973 
»tv®
 = 
	`äcdrv_¡¬t
(
oùeÚ_id
, 
oùeÚ_dev
);

975 if(
»tv®
) {

976 
	`äcdrv_¡İ_moduË
(
oùeÚ_id
, 
oùeÚ_dev
);

977  
»tv®
;

980 
	`FRCDRV_DEBUG
("Unsupport flow„estoration.\n");

982  
FRE_SUCCESS
;

983 
	}
}

991 
	$äú‘_»£t_nic_moduË
(
oùeÚ_id
, *
oùeÚ_dev
)

993 if(
CVM_MOD_IN_USE
)

995  
	`äú‘_¡İ_nic_moduË
(
oùeÚ_id
, 
oùeÚ_dev
);

996 
	}
}

998 
	$äcdrv_»£t_moduË
(
oùeÚ_id
, *
oùeÚ_dev
)

1000 
»tv®
 = 0;

1001 #ifdeà
FRC_CONFIG_NIC


1002 
	`FRCDRV_DEBUG
("Support NIC.\n");

1003 
»tv®
 = 
	`äú‘_»£t_nic_moduË
(
oùeÚ_id
, 
oùeÚ_dev
);

1005 ià(
»tv®
)

1007  
»tv®
;

1010 
	`FRCDRV_DEBUG
("Unsupport NIC.\n");

1013 #ifdeà
FRC_CONFIG_FR


1014 
	`FRCDRV_DEBUG
("Support flow„estoration.\n");

1015 
»tv®
 = 
	`äcdrv_»£t
(
oùeÚ_id
, 
oùeÚ_dev
);

1017 
	`FRCDRV_DEBUG
("Unsupport flow„estoration.\n");

1019  
»tv®
;

1020 
	}
}

1023 #ià
defšed
(
OCTEON_EXCLUDE_BASE_LOAD
)

1024 
oùeÚ_ba£_š™_moduË
();

1025 
oùeÚ_ba£_ex™_moduË
();

1029 
	$š™_moduË
()

1031 cÚ¡ *
nic_cvs_g
 = "$Name: PCI_NIC_RELEASE_2_0_0_build_73 ";

1032 
nic_v”siÚ
[80];

1033 
cİts
[160];

1034 
oùeÚ_moduË_hªdËr_t
 
ächªdËr
;

1036 
	`ÿvium_´št_msg
("-- FRCDRV: Starting module for FRC\n");

1037 
	`ÿvium_·r£_cvs_¡ršg
(
nic_cvs_g
, 
nic_v”siÚ
, 80);

1038 
	`ÿvium_´št_msg
("V”siÚ: %s\n", 
nic_v”siÚ
);

1040 
cİts
[0] = '\0';

1041 
	`g‘_nic_compe_İtiÚs
(
cİts
);

1042 if(
	`¡¾’
(
cİts
))

1043 
	`ÿvium_´št_msg
("FRCDRV: Driv” compİtiÚs: %s\n", 
cİts
);

1045 
	`ÿvium_´št_msg
("FRCDRV: Driver compile options: NONE\n");

1048 
	`ÿvium_mem£t
(
äırİs
, 0, (*è* 
MAX_OCTEON_DEVICES
);

1050 #ià
	`defšed
(
OCTEON_EXCLUDE_BASE_LOAD
)

1052 if(
	`oùeÚ_ba£_š™_moduË
()) {

1053 
	`ÿvium_”rÜ
("FRCDRV: Octeon initialization failed\n");

1054  -
EINVAL
;

1057 ià(
	`äcdrv_ba£_š™_moduË
()) {

1058 
	`ÿvium_”rÜ
("FRCDRV: Octeon initialization failed\n");

1059  -
EINVAL
;

1068 
ächªdËr
.
¡¬Œ
 = 
äcdrv_¡¬t_moduË
;

1069 
ächªdËr
.
»£Œ
 = 
äcdrv_»£t_moduË
;

1070 
ächªdËr
.
¡İ±r
 = 
äcdrv_¡İ_moduË
;

1071 
ächªdËr
.
­p_ty³
 = 
FRC_DRV_APP
;

1072 if(
	`oùeÚ_»gi¡”_moduË_hªdËr
(&
ächªdËr
))

1073  -
EINVAL
;

1075 
	`ÿvium_´št_msg
("-- FRCDRV: module†oaded for FRC.\n");

1077 
	}
}

1088 
	$ş—nup_moduË
()

1090 
	`ÿvium_´št_msg
("-- FRCDRV: Stopping Octeon Network module\n");

1091 
	`oùeÚ_uÄegi¡”_moduË_hªdËr
(
FRC_DRV_APP
);

1092 #ià
	`defšed
(
OCTEON_EXCLUDE_BASE_LOAD
)

1094 
	`oùeÚ_ba£_ex™_moduË
();

1096 
	`äcdrv_ba£_ex™_moduË
();

1098 
	`ÿvium_´št_msg
("-- FRCDRV: Octeon Network module is‚ow unloaded\n");

1099 
	}
}

	@frcdrv/frcdrv_network.c

26 
	~"ÿvium_sysd•.h
"

27 
	~"ÿvium_defs.h
"

28 
	~"äcdrv_ÃtwÜk.h
"

29 
	~"oùeÚ_maüos.h
"

30 
	~"oùeÚ_nic.h
"

32 
äcdev_´İs_t
 *
äırİs
[
MAX_OCTEON_DEVICES
];

34 
	#OCT_NIC_TX_OK
 
NETDEV_TX_OK


	)

35 
	#OCT_NIC_TX_BUSY
 
NETDEV_TX_BUSY


	)

42 
où_Ãt_£tup_if
(
oùeÚ_»cv_šfo_t
 *
»cv_šfo
, *
buf
);

43 
oùeÚ_ÃtwÜk_ä“_tx_buf
(
oùeÚ_»q_¡©us_t
 
¡©us
, *
¬g
);

51 
äú‘_Çpi_’abË
(
äú‘_´iv_t
 *
´iv
);

52 
äú‘_Çpi_di§bË
(
äú‘_´iv_t
 *
´iv
);

54 
où_pŞl_â_¡©us_t
 
äú‘_check_txq_¡©us
(*
où
,
´İs_±r
);

65 
šlše
 

66 
	$__äú‘_¡İ_txqueue
(
äú‘_os_dev±r_t
 *
²dev
)

68 
äú‘_´iv_t
 *
´iv
 = 
	`GET_NETDEV_PRIV
(
²dev
);

70 
	`Ãtif_¡İ_queue
(
²dev
);

71 
	`OCTNET_IFSTATE_RESET
(
´iv
, 
OCT_NIC_IFSTATE_TXENABLED
);

72 
	}
}

80 
šlše
 

81 
	$__äú‘_¡¬t_txqueue
(
äú‘_os_dev±r_t
 *
²dev
, 
»¡¬t
)

83 
äú‘_´iv_t
 *
´iv
 = 
	`GET_NETDEV_PRIV
(
²dev
);

85 if(
	`OCTNET_IFSTATE_CHECK
(
´iv
, 
OCT_NIC_IFSTATE_TXENABLED
))

88 if(
´iv
->
lšfo
.
lšk
.
s
.
¡©us
) {

89 if(
»¡¬t
) {

90 
	`Ãtif_wake_queue
(
²dev
);

92 
	`Ãtif_¡¬t_queue
(
²dev
);

94 
	`OCTNET_IFSTATE_SET
(
´iv
, 
OCT_NIC_IFSTATE_TXENABLED
);

99 
	}
}

107 
	$äú‘_¡İ_txqueue
(
äú‘_os_dev±r_t
 *
²dev
)

109 
	`__äú‘_¡İ_txqueue
(
²dev
);

110 
	}
}

115 
	$äú‘_¡¬t_txqueue
(
äú‘_os_dev±r_t
 *
²dev
)

117 
	`__äú‘_¡¬t_txqueue
((
²dev
), 0);

118 
	}
}

122 
	$äú‘_»¡¬t_txqueue
(
äú‘_os_dev±r_t
 *
²dev
)

124 
	`__äú‘_¡¬t_txqueue
((
²dev
), 1);

125 
	}
}

131 
šlše
 

132 
	$__check_txq_¡©e
(
äú‘_´iv_t
 *
´iv
)

134 if(
	`OCTNET_IFSTATE_CHECK
(
´iv
, 
OCT_NIC_IFSTATE_TXENABLED
))

137 if(
	`oùÃt_iq_is_fuÎ
(
´iv
->
où_dev
,…riv->
txq
))

140 if(
	`oùÃt_iq_bp_Ú
(
´iv
->
où_dev
,…riv->
txq
))

143 
	`OCTNET_IFSTATE_SET
(
´iv
, 
OCT_NIC_IFSTATE_TXENABLED
);

144 
	`Ãtif_wake_queue
(
´iv
->
²dev
);

147 
	}
}

152 
où_pŞl_â_¡©us_t


153 
	$äú‘_pŞl_check_txq_¡©us
(*
où
,

154 
ul_´iv
)

156 if(!
	`OCTNET_IFSTATE_CHECK
((
äú‘_´iv_t
 *)
ul_´iv
, 
OCT_NIC_IFSTATE_RUNNING
))

157  
OCT_POLL_FN_FINISHED
;

159 
	`__check_txq_¡©e
((
äú‘_´iv_t
 *)
ul_´iv
);

161  
OCT_POLL_FN_CONTINUE
;

162 
	}
}

169 
	$__£tup_tx_pŞl_â
(
äú‘_os_dev±r_t
 *
²dev
)

171 
oùeÚ_pŞl_İs_t
 
pŞl_İs
;

172 
äú‘_´iv_t
 *
´iv
 = 
	`GET_NETDEV_PRIV
(
²dev
);

174 
pŞl_İs
.
â
 = 
äú‘_pŞl_check_txq_¡©us
;

175 
pŞl_İs
.
â_¬g
 = ()
´iv
;

176 
pŞl_İs
.
ticks
 = 1;

177 
pŞl_İs
.
rsvd
 = 0xff;

178 
	`oùeÚ_»gi¡”_pŞl_â
(
	`g‘_oùeÚ_deviû_id
(
´iv
->
où_dev
), &
pŞl_İs
);

179 
	}
}

186 
	$äú‘_İ’
(
Ãt_deviû
 *
²dev
)

188 
äú‘_´iv_t
 *
´iv
 = 
	`GET_NETDEV_PRIV
(
²dev
);

190 
	`Ãtif_¡¬t_queue
(
²dev
);

192 
	`OCTNET_IFSTATE_SET
(
´iv
, 
OCT_NIC_IFSTATE_RUNNING
);

194 
	`__£tup_tx_pŞl_â
(
²dev
);

196 
CVM_MOD_INC_USE_COUNT
;

199 
	}
}

206 
	$äú‘_¡İ
(
Ãt_deviû
 *
²dev
)

208 
äú‘_´iv_t
 *
´iv
 = 
	`GET_NETDEV_PRIV
(
²dev
);

210 
	`OCTNET_IFSTATE_RESET
(
´iv
, 
OCT_NIC_IFSTATE_RUNNING
);

212 if(
OCT_NIC_USE_NAPI
) {

213 
	`£t_b™
(
__LINK_STATE_START
, &
´iv
->
²dev
->
¡©e
);

215 
	`Ãtif_¡İ_queue
(
²dev
);

217 
CVM_MOD_DEC_USE_COUNT
;

220 
	}
}

235 
	$äú‘_lšk_ù¾_cmd_com¶‘iÚ
(*
nù¾_±r
)

237 
oùnic_ù¾_pkt_t
 *
nù¾
 = (oùnic_ù¾_pkt_ˆ*)
nù¾_±r
;

238 
äú‘_os_dev±r_t
 *
²dev
;

239 
äú‘_´iv_t
 *
´iv
;

241 
²dev
 = (
äú‘_os_dev±r_t
 *)
nù¾
->
Ãndev
;

242 
´iv
 = 
	`GET_NETDEV_PRIV
(
²dev
);

244 
nù¾
->
ncmd
.
s
.
cmd
) {

245 
OCTNET_CMD_CHANGE_DEVFLAGS
:

247 
´iv
->
cÜe_æags
 = 
nù¾
->
udd
[0];

250 
OCTNET_CMD_CHANGE_MACADDR
:

252 
	`ÿvium_´št_msg
("OCTNIC: %s MACAddr changedo 0x%llx\n",

253 
	`äú‘_g‘_devÇme
(
²dev
),

254 
	`CVM_CAST64
(
nù¾
->
udd
[0]));

255 
	`ÿvium_memıy
(
²dev
->
dev_addr
, ((
ušt8_t
 *)&
nù¾
->
udd
[0]è+ 2, 
ETH_ALEN
);

258 
OCTNET_CMD_CHANGE_MTU
:

260 
	`ÿvium_´št_msg
("OCTNIC: %s MTU Changed from %do %d\n",

261 
	`äú‘_g‘_devÇme
(
²dev
),…ndev->
mtu
,

262 
nù¾
->
ncmd
.
s
.
·¿m2
);

263 
²dev
->
mtu
 = 
nù¾
->
ncmd
.
s
.
·¿m2
;

267 
	`ÿvium_”rÜ
("OCTNIC: % UnknowÀcmd: %d\n", 
__CVM_FUNCTION__
,

268 
nù¾
->
ncmd
.
s
.
cmd
);

271 
	}
}

280 
šlše
 
oùÃt_ifæags_t


281 
	$äú‘_g‘_Ãw_æags
(
äú‘_os_dev±r_t
 *
²dev
)

283 
oùÃt_ifæags_t
 
f
 = 0;

285 if(
²dev
->
æags
 & 
IFF_PROMISC
) {

286 
f
 |ğ
OCTNET_IFFLAG_PROMISC
;

289 if(
²dev
->
æags
 & 
IFF_ALLMULTI
) {

290 
f
 |ğ
OCTNET_IFFLAG_ALLMULTI
;

293 if(
²dev
->
æags
 & 
IFF_MULTICAST
) {

294 
f
 |ğ
OCTNET_IFFLAG_MULTICAST
;

297  
f
;

298 
	}
}

309 
	$äú‘_£t_mÿ¡_li¡
(
äú‘_os_dev±r_t
 *
²dev
)

311 
äú‘_´iv_t
 *
´iv
 = 
	`GET_NETDEV_PRIV
(
²dev
);

312 
oùnic_ù¾_pkt_t
 
nù¾
;

313 
»t
;

315 if(
²dev
->
æags
 =ğ
´iv
->
²dev_æags
)

319 
´iv
->
²dev_æags
 = 
²dev
->
æags
;

322 
nù¾
.
ncmd
.
u64
 = 0;

323 
nù¾
.
ncmd
.
s
.
cmd
 = 
OCTNET_CMD_CHANGE_DEVFLAGS
;

324 
nù¾
.
ncmd
.
s
.
·¿m1
 = 
´iv
->
lšfo
.
gmxpÜt
;

325 
nù¾
.
ncmd
.
s
.
·¿m2
 = 0;

326 
nù¾
.
ncmd
.
s
.
mÜe
 = 1;

327 
nù¾
.
Ãndev
 = ()
²dev
;

328 
nù¾
.
cb_â
 = 
äú‘_lšk_ù¾_cmd_com¶‘iÚ
;

330 
nù¾
.
udd
[0] = (
ušt64_t
)
	`äú‘_g‘_Ãw_æags
(
²dev
);

331 
	`oùeÚ_sw­_8B_d©a
(&
nù¾
.
udd
[0], 1);

335 
nù¾
.
wa™_time
 = 0;

337 #ià!
	`defšed
(
ETHERPCI
)

339 
»t
 = 
	`oùÃt_£nd_nic_ù¾_pkt
(
´iv
->
où_dev
, &
nù¾
);

340 if(
»t
) {

341 
	`ÿvium_”rÜ
("OCTNIC: DevFlags change failed in core (ret: 0x%x)\n",

342 
»t
);

346 
	`äú‘_lšk_ù¾_cmd_com¶‘iÚ
Ğ(*)&
nù¾
);

347 
»t
 = 0;

349 
	}
}

361 
	$äú‘_£t_mac
(
Ãt_deviû
 *
²dev
, *
addr
)

363 
»t
 = 0;

364 
äú‘_´iv_t
 *
´iv
;

365 
sockaddr
 *
p_sockaddr
 = (sockadd¸*)
addr
;

366 
oùnic_ù¾_pkt_t
 
nù¾
;

368 
´iv
 = 
	`GET_NETDEV_PRIV
(
²dev
);

370 
nù¾
.
ncmd
.
u64
 = 0;

371 
nù¾
.
ncmd
.
s
.
cmd
 = 
OCTNET_CMD_CHANGE_MACADDR
;

372 
nù¾
.
ncmd
.
s
.
·¿m1
 = 
´iv
->
lšfo
.
gmxpÜt
;

373 
nù¾
.
ncmd
.
s
.
·¿m2
 = 0;

374 
nù¾
.
ncmd
.
s
.
mÜe
 = 1;

375 
nù¾
.
Ãndev
 = ()
²dev
;

376 
nù¾
.
cb_â
 = 
äú‘_lšk_ù¾_cmd_com¶‘iÚ
;

377 
nù¾
.
wa™_time
 = 100;

379 
nù¾
.
udd
[0] = 0;

381 
	`ÿvium_memıy
((
ušt8_t
 *)&
nù¾
.
udd
[0] + 2, 
p_sockaddr
->
§_d©a
, 
ETH_ALEN
);

383 #ià !
	`defšed
(
ETHERPCI
)

384 
»t
 = 
	`oùÃt_£nd_nic_ù¾_pkt
(
´iv
->
où_dev
, &
nù¾
);

385 if(
»t
) {

386 
	`ÿvium_”rÜ
("OCTNIC: MAC Address change failed\n");

387 
»t
 = -
EBUSY
;

390 
	`äú‘_lšk_ù¾_cmd_com¶‘iÚ
Ğ(*)&
nù¾
);

391 
»t
 = 0;

394  
»t
;

395 
	}
}

403 
	$äú‘_chªge_mtu
(
Ãt_deviû
 *
²dev
, 
Ãw_mtu
)

405 
äú‘_´iv_t
 *
´iv
;

406 
oùnic_ù¾_pkt_t
 
nù¾
;

407 
»t
 = 0, 
max_äm_size
 = 
Ãw_mtu
 + 18;

409 
	`ÿvium_´št
(
PRINT_FLOW
,"OCTNIC: % ÿÎed\n", 
__CVM_FUNCTION__
);

413 iàĞ(
max_äm_size
 < 
OCTNET_MIN_FRM_SIZE
)

414 || (
max_äm_size
 > 
OCTNET_MAX_FRM_SIZE
)) {

415 
	`ÿvium_”rÜ
("OCTNIC: Invalid MTU: %d (Valid values‡re between %d‡nd %d)\n",

416 
Ãw_mtu
, (
OCTNET_MIN_FRM_SIZE
 - 18),

417 (
OCTNET_MAX_FRM_SIZE
 - 18));

418  -
EINVAL
;

422 
´iv
 = 
	`GET_NETDEV_PRIV
(
²dev
);

425 if(
	`oùeÚ_»£t_oq_bufsize
(
	`g‘_oùeÚ_deviû_id
(
´iv
->
où_dev
),…riv->
rxq
, 
Ãw_mtu
)) {

426 
	`ÿvium_”rÜ
("Error changing output queue buffer size\n");

427 
»t
 = -
EINVAL
;

428 
chªge_mtu_fšish
;

432 
nù¾
.
ncmd
.
u64
 = 0;

433 
nù¾
.
ncmd
.
s
.
cmd
 = 
OCTNET_CMD_CHANGE_MTU
;

434 
nù¾
.
ncmd
.
s
.
·¿m1
 = 
´iv
->
lšfo
.
gmxpÜt
;

435 
nù¾
.
ncmd
.
s
.
·¿m2
 = 
Ãw_mtu
;

436 
nù¾
.
wa™_time
 = 100;

437 
nù¾
.
Ãndev
 = ()
²dev
;

438 
nù¾
.
cb_â
 = 
äú‘_lšk_ù¾_cmd_com¶‘iÚ
;

440 #ià !
	`defšed
(
ETHERPCI
)

441 
»t
 = 
	`oùÃt_£nd_nic_ù¾_pkt
(
´iv
->
où_dev
, &
nù¾
);

442 if(
»t
) {

443 
	`ÿvium_”rÜ
("OCTNIC: Failedo set MTU\n");

444 
»t
 = -
EINVAL
;

447 
	`äú‘_lšk_ù¾_cmd_com¶‘iÚ
Ğ(*)&
nù¾
);

448 
»t
 = 0;

451  
»t
;

452 
	}
}

470 
	$äú‘_push_·ck‘
(
oùeÚ_id
,

471 *
skbuff
,

472 
ušt32_t
 
Ën
,

473 
oùeÚ_»¥_hdr_t
 *
»¥_hdr
)

475 
sk_buff
 *
skb
 = (sk_bufà*)
skbuff
;

476 
äú‘_os_dev±r_t
 *
²dev
 = (äú‘_os_dev±r_ˆ*)
äırİs
[
oùeÚ_id
]->²dev[
»¥_hdr
->
de¡_qpÜt
];

478 if(
²dev
) {

479 
äú‘_´iv_t
 *
´iv
 = 
	`GET_NETDEV_PRIV
(
²dev
);

482 ifĞ!(
	`ÿvium_©omic_»ad
(&
´iv
->
if¡©e
è& 
OCT_NIC_IFSTATE_RUNNING
)) {

483 
	`ä“_»cv_bufãr
(
skb
);

484 
´iv
->
¡©s
.
rx_drİ³d
++;

488 
skb
->
dev
 = 
²dev
;

489 
skb
->
´ÙocŞ
 = 
	`‘h_ty³_Œªs
(skb, skb->
dev
);

490 
skb
->
_summed
 = 
CHECKSUM_NONE
;

492 if(
	`Ãtif_rx
(
skb
è!ğ
NET_RX_DROP
) {

493 
´iv
->
¡©s
.
rx_by‹s
 +ğ
Ën
;

494 
´iv
->
¡©s
.
rx_·ck‘s
++;

495 
²dev
->
Ï¡_rx
 = 
jiff›s
;

497 
´iv
->
¡©s
.
rx_drİ³d
++;

502 
	`ä“_»cv_bufãr
(
skb
);

505 
	}
}

517 
	$oùnic_ä“_Ãtbuf
(*
buf
)

519 
sk_buff
 *
skb
;

520 
äú‘_buf_ä“_šfo
 *
fšfo
;

521 
äú‘_´iv_t
 *
´iv
;

523 
fšfo
 = (
äú‘_buf_ä“_šfo
 *)
buf
;

524 
skb
 = 
fšfo
->skb;

525 
´iv
 = 
fšfo
->priv;

527 
	`oùeÚ_unm­_sšgË_bufãr
(
	`g‘_oùeÚ_deviû_id
(
´iv
->
où_dev
),

528 
fšfo
->
d±r
, 
skb
->
Ën
,

529 
CAVIUM_PCI_DMA_TODEVICE
);

530 
	`ä“_»cv_bufãr
((
ÿvium_Ãtbuf_t
 *)
skb
);

532 
	`__check_txq_¡©e
(
´iv
);

533 
	}
}

539 
	$oùnic_ä“_Ãtsgbuf
(*
buf
)

541 
äú‘_buf_ä“_šfo
 *
fšfo
;

542 
sk_buff
 *
skb
;

543 
äú‘_´iv_t
 *
´iv
;

544 
oùnic_g©h”
 *
g
;

545 
i
, 
äags
;

548 
fšfo
 = (
äú‘_buf_ä“_šfo
 *)
buf
;

549 
skb
 = 
fšfo
->skb;

550 
´iv
 = 
fšfo
->priv;

551 
g
 = 
fšfo
->g;

552 
äags
 = 
	`skb_shšfo
(
skb
)->
Ä_äags
;

555 
	`oùeÚ_unm­_sšgË_bufãr
(
	`g‘_oùeÚ_deviû_id
(
´iv
->
où_dev
),

556 
g
->
sg
[0].
±r
[0], (
skb
->
Ën
 - skb->
d©a_Ën
),

557 
CAVIUM_PCI_DMA_TODEVICE
);

559 
i
 = 1;

560 
äags
--) {

561 
skb_äag_¡ruù
 *
äag
 = &
	`skb_shšfo
(
skb
)->
äags
[
i
-1];

563 
	`oùeÚ_unm­_·ge
(
	`g‘_oùeÚ_deviû_id
(
´iv
->
où_dev
),

564 
g
->
sg
[(
i
 >> 2)].
±r
[(i&3)],

565 
äag
->
size
, 
CAVIUM_PCI_DMA_TODEVICE
);

566 
i
++;

569 
	`oùeÚ_unm­_sšgË_bufãr
(
	`g‘_oùeÚ_deviû_id
(
´iv
->
où_dev
),

570 
fšfo
->
d±r
, 
g
->
sg_size
,

571 
CAVIUM_PCI_DMA_TODEVICE
);

573 
	`ÿvium_¥š_lock
(&
´iv
->
lock
);

574 
	`ÿvium_li¡_add_
(&
g
->
li¡
, &
´iv
->
gli¡
);

575 
	`ÿvium_¥š_uÆock
(&
´iv
->
lock
);

577 
	`ä“_»cv_bufãr
((
ÿvium_Ãtbuf_t
 *)
skb
);

579 
	`__check_txq_¡©e
(
´iv
);

580 
	}
}

588 
	$´št__h—d”
(
hdr
 *

)

590 
	`ÿvium_´št_msg
(":os: %xÙ_Ën: %x id: %x f¿g_off: %x: %x…rÙo: %x\n", 

->
tos
, ip->
tÙ_Ën
, ip->
id
, ip->
äag_off
, ip->
‰l
, ip->
´ÙocŞ
);

591 
	}
}

596 
šlše
 

597 
	$is_v4
(
sk_buff
 *
skb
)

599  ( (
skb
->
´ÙocŞ
 =ğ
	`htÚs
(
ETH_P_IP
))

600 && (
	`cvm__hdr
(
skb
)->
v”siÚ
 == 4)

601 && (
	`cvm__hdr
(
skb
)->
ihl
 == 5));

602 
	}
}

606 
šlše
 

607 
	$is__äagm’‹d
(
sk_buff
 *
skb
)

614  ( 
	`htÚs
(
	`cvm__hdr
(
skb
)->
äag_off
) & 0x3fff);

615 
	}
}

620 
šlše
 

621 
	$is_v6
(
sk_buff
 *
skb
)

623  ( (
skb
->
´ÙocŞ
 =ğ
	`htÚs
(
ETH_P_IPV6
))

624 && (
	`cvm_6_hdr
(
skb
)->
v”siÚ
 == 6));

625 
	}
}

630 
šlše
 

631 
	$is_wo_exŠ_hdr
(
sk_buff
 *
skb
)

633  ( (
	`cvm_6_hdr
(
skb
)->
Ãxthdr
 =ğ
IPPROTO_TCP
) ||

634 (
	`cvm_6_hdr
(
skb
)->
Ãxthdr
 =ğ
IPPROTO_UDP
));

635 
	}
}

639 
šlše
 

640 
	$is_tıudp
(
sk_buff
 *
skb
)

642  ( (
	`cvm__hdr
(
skb
)->
´ÙocŞ
 =ğ
IPPROTO_TCP
)

643 || (
	`cvm__hdr
(
skb
)->
´ÙocŞ
 =ğ
IPPROTO_UDP
));

644 
	}
}

648 
	$äú‘_xm™
(
sk_buff
 *
skb
, 
Ãt_deviû
 *
²dev
)

650 
äú‘_´iv_t
 *
´iv
;

651 
äú‘_buf_ä“_šfo
 *
fšfo
;

652 
oùnic_cmd_£tup_t
 
cmd£tup
;

653 
oùnic_d©a_pkt_t
 
nd©a
;

654 
¡©us
 = 0;

659 
	`ÿvium_´št
(
PRINT_FLOW
,"OCTNIC:‚etwork xmit called\n");

661 
´iv
 = 
	`GET_NETDEV_PRIV
(
²dev
);

662 
´iv
->
¡©s
.
tx_·ck‘s
++;

663 
´iv
->
¡©s
.
tx_by‹s
 +ğ
skb
->
Ën
;

665 if(!
	`OCTNET_IFSTATE_CHECK
(
´iv
, 
OCT_NIC_IFSTATE_TXENABLED
)) {

666  
OCT_NIC_TX_BUSY
;

668 #ià
FRC_CONFIG_LOCK_NET_XMIT


669 
	`ÿvium_¥š_lock
(&
´iv
->
xm™_lock
);

673 ifĞ!(
	`ÿvium_©omic_»ad
(&
´iv
->
if¡©e
è& 
OCT_NIC_IFSTATE_RUNNING
)

674 || (!
´iv
->
lšfo
.
lšk
.
s
.
¡©us
)

675 || (
	`oùÃt_iq_is_fuÎ
(
´iv
->
où_dev
,…riv->
txq
))

676 || (
skb
->
Ën
 <= 0) ) {

677 
où_xm™_çed
;

681 
fšfo
 = (
äú‘_buf_ä“_šfo
 *)
skb
->
cb
;

682 
fšfo
->
´iv
 =…riv;

683 
fšfo
->
skb
 = skb;

686 
nd©a
.
buf
 = (*)
fšfo
;

687 
nd©a
.
q_no
 = 
´iv
->
txq
;

688 
nd©a
.
d©asize
 = 
skb
->
Ën
;

690 
cmd£tup
.
u64
 = 0;

691 
cmd£tup
.
s
.
gmxpÜt
 = 
´iv
->
lšfo
.gmxport;

694 ifĞ(
	`is_v4
(
skb
è&& !
	`is__äagm’‹d
(skbè&& 
	`is_tıudp
(skb)) ||

695 (
	`is_v6
(
skb
è&& 
	`is_wo_exŠ_hdr
(skb)) ) {

696 
cmd£tup
.
s
.
cksum_off£t
 = (
‘hhdr
) + 1;

702 if(
	`skb_shšfo
(
skb
)->
Ä_äags
 == 0) {

704 
cmd£tup
.
s
.
u
.
d©asize
 = 
skb
->
Ën
;

706 
	`oùÃt_´•¬e_pci_cmd
(&(
nd©a
.
cmd
), &
cmd£tup
);

709 
nd©a
.
cmd
.
d±r
 =

710 
	`oùeÚ_m­_sšgË_bufãr
(
	`g‘_oùeÚ_deviû_id
(
´iv
->
où_dev
),

711 
skb
->
d©a
, skb->
Ën
, 
CAVIUM_PCI_DMA_TODEVICE
);

713 
fšfo
->
d±r
 = 
nd©a
.
cmd
.dptr;

715 
nd©a
.
buáy³
 = 
NORESP_BUFTYPE_NET
;

718 
i
, 
äags
;

719 
skb_äag_¡ruù
 *
äag
;

720 
oùnic_g©h”
 *
g
;

722 
	`ÿvium_¥š_lock
(&
´iv
->
lock
);

723 
g
 = (
oùnic_g©h”
 *)
	`ÿvium_li¡_d–‘e_h—d
(&
´iv
->
gli¡
);

724 
	`ÿvium_¥š_uÆock
(&
´iv
->
lock
);

726 if(
g
 =ğ
NULL
)

727 
où_xm™_çed
;

729 
cmd£tup
.
s
.
g©h”
 = 1;

730 
cmd£tup
.
s
.
u
.
g©h”±rs
 = (
	`skb_shšfo
(
skb
)->
Ä_äags
 + 1);

731 
	`oùÃt_´•¬e_pci_cmd
(&(
nd©a
.
cmd
), &
cmd£tup
);

733 
	`mem£t
(
g
->
sg
, 0, g->
sg_size
);

735 
g
->
sg
[0].
±r
[0] =

736 
	`oùeÚ_m­_sšgË_bufãr
(
	`g‘_oùeÚ_deviû_id
(
´iv
->
où_dev
),

737 
skb
->
d©a
, (skb->
Ën
 - skb->
d©a_Ën
),

738 
CAVIUM_PCI_DMA_TODEVICE
);

739 
	`CAVIUM_ADD_SG_SIZE
(&(
g
->
sg
[0]), (
skb
->
Ën
 - skb->
d©a_Ën
), 0);

742 
äags
 = 
	`skb_shšfo
(
skb
)->
Ä_äags
;

743 
i
 = 1;

744 
äags
--) {

745 
äag
 = &
	`skb_shšfo
(
skb
)->
äags
[
i
-1];

747 
g
->
sg
[(
i
 >> 2)].
±r
[(i&3)] =

748 
	`oùeÚ_m­_·ge
(
	`g‘_oùeÚ_deviû_id
(
´iv
->
où_dev
), 
äag
->
·ge
, f¿g->
·ge_off£t
,

749 
äag
->
size
,
CAVIUM_PCI_DMA_TODEVICE
);

750 
	`CAVIUM_ADD_SG_SIZE
(&(
g
->
sg
[(
i
 >> 2)]), 
äag
->
size
, (i&3));

751 
i
++;

755 
nd©a
.
cmd
.
d±r
 =

756 
	`oùeÚ_m­_sšgË_bufãr
(
	`g‘_oùeÚ_deviû_id
(
´iv
->
où_dev
),

757 
g
->
sg
, g->
sg_size
, 
CAVIUM_PCI_DMA_TODEVICE
);

759 
fšfo
->
d±r
 = 
nd©a
.
cmd
.dptr;

760 
fšfo
->
g
 = g;

762 
nd©a
.
buáy³
 = 
NORESP_BUFTYPE_NET_SG
;

765 
¡©us
 = 
	`oùÃt_£nd_nic_d©a_pkt
(
´iv
->
où_dev
, &
nd©a
);

766 if(
¡©us
 =ğ
NORESP_SEND_FAILED
)

767 
où_xm™_çed
;

769 if(
¡©us
 =ğ
NORESP_SEND_STOP
) {

770 
	`Ãtif_¡İ_queue
(
²dev
);

771 
	`OCTNET_IFSTATE_RESET
(
´iv
, 
OCT_NIC_IFSTATE_TXENABLED
);

774 
²dev
->
Œªs_¡¬t
 = 
jiff›s
;

775 #ià
FRC_CONFIG_LOCK_NET_XMIT


776 
	`ÿvium_¥š_uÆock
(&
´iv
->
xm™_lock
);

778  
OCT_NIC_TX_OK
;

780 
où_xm™_çed
:

781 
´iv
->
¡©s
.
tx_drİ³d
++;

782 
	`ä“_»cv_bufãr
(
skb
);

783 #ià
FRC_CONFIG_LOCK_NET_XMIT


784 
	`ÿvium_¥š_uÆock
(&
´iv
->
xm™_lock
);

786  
OCT_NIC_TX_OK
;

787 
	}
}

795 
	$äú‘_Çpi_’abË
(
äú‘_´iv_t
 *
´iv
)

797 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2,6,24)

798 
	`Çpi_’abË
(&
´iv
->
Çpi
);

800 
	`Ãtif_pŞl_’abË
(
´iv
->
²dev
);

802 
	}
}

806 
	$äú‘_Çpi_di§bË
(
äú‘_´iv_t
 *
´iv
)

808 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2,6,24)

809 
	`Çpi_di§bË
(&
´iv
->
Çpi
);

811 
	`Ãtif_pŞl_di§bË
(
´iv
->
²dev
);

813 
	}
}

819 
	$äú‘_nÙify_Çpi_com¶‘e
(
äú‘_´iv_t
 *
´iv
)

821 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2,6,29)

822 
	`Çpi_com¶‘e
(&
´iv
->
Çpi
);

823 #–ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2,6,24)

824 
	`Ãtif_rx_com¶‘e
(
´iv
->
²dev
, &´iv->
Çpi
);

826 
	`Ãtif_rx_com¶‘e
(
´iv
->
²dev
);

828 
	}
}

832 
	$äú‘_nÙify_Çpi_¡¬t
(
äú‘_´iv_t
 *
´iv
)

834 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2,6,29)

835 
	`Çpi_scheduË
(&
´iv
->
Çpi
);

836 #–ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2,6,24)

837 
	`Ãtif_rx_scheduË
(
´iv
->
²dev
, &´iv->
Çpi
);

839 
	`Ãtif_rx_scheduË
(
´iv
->
²dev
);

841 
	}
}

848 
	$äú‘_Çpi_drv_ÿÎback
(
où_id
, 
oq_no
, 
ev’t
)

850 
äú‘_´iv_t
 *
´iv
 = 
	`GET_NETDEV_PRIV
(
äırİs
[
où_id
]->
²dev
[
oq_no
]);

851 if(
ev’t
 =ğ
POLL_EVENT_INTR_ARRIVED
) {

852 
	`äú‘_nÙify_Çpi_¡¬t
(
´iv
);

854 
	}
}

860 
	$äú‘_Çpi_do_rx
(
äú‘_´iv_t
 *
´iv
, 
budg‘
)

862 
wÜk_dÚe
, 
où_id
;

864 
où_id
 = 
	`g‘_oùeÚ_deviû_id
(
´iv
->
où_dev
);

866 
wÜk_dÚe
 = 
	`oùeÚ_´oûss_droq_pŞl_cmd
(
où_id
, 
´iv
->
rxq
,

867 
POLL_EVENT_PROCESS_PKTS
, 
budg‘
);

868 if(
wÜk_dÚe
 < 0) {

869 
	`ÿvium_”rÜ
("\À%s: CHECK THE OCTEON DEVICE ID OR DROQ NUMBER\n", 
__FUNCTION__
);

870 
äú‘_Çpi_fšish
;

873 if(
wÜk_dÚe
 > 
budg‘
) {

874 
	`ÿvium_”rÜ
(">>>> % wÜk_dÚe: %d budg‘: %d\n", 
__FUNCTION__
, 
wÜk_dÚe
,

875 
budg‘
);

878  
wÜk_dÚe
;

880 
äú‘_Çpi_fšish
:

881 
	`äú‘_nÙify_Çpi_com¶‘e
(
´iv
);

882 
	`oùeÚ_´oûss_droq_pŞl_cmd
(
où_id
, 
´iv
->
rxq
, 
POLL_EVENT_ENABLE_INTR
, 0);

884 
	}
}

891 #ià
LINUX_VERSION_CODE
 >ğ
KERNEL_VERSION
(2,6,24)

894 
	$äú‘_Çpi_pŞl
(
Çpi_¡ruù
 *
Çpi
, 
budg‘
)

896 
Ãt_deviû
 *
²dev
 = 
Çpi
->
dev
;

897 
äú‘_´iv_t
 *
´iv
 = 
	`GET_NETDEV_PRIV
(
²dev
);

898 
wÜk_dÚe
;

900 
wÜk_dÚe
 = 
	`äú‘_Çpi_do_rx
(
´iv
, 
budg‘
);

902 if(
wÜk_dÚe
 < 
budg‘
) {

903 
où_id
 = 
	`g‘_oùeÚ_deviû_id
(
´iv
->
où_dev
);

904 
	`äú‘_nÙify_Çpi_com¶‘e
(
´iv
);

905 
	`oùeÚ_´oûss_droq_pŞl_cmd
(
où_id
, 
´iv
->
rxq
, 
POLL_EVENT_ENABLE_INTR
, 0);

909  
wÜk_dÚe
;

910 
	}
}

915 
	$äú‘_Çpi_pŞl
(
Ãt_deviû
 *
²dev
, *
budg‘
)

917 
wÜk_dÚe
 = 0;

918 
äú‘_´iv_t
 *
´iv
 = 
	`GET_NETDEV_PRIV
(
²dev
);

920 
wÜk_dÚe
 = 
	`äú‘_Çpi_do_rx
(
´iv
, *
budg‘
);

922 *
budg‘
 -ğ
wÜk_dÚe
;

923 
²dev
->
quÙa
 -ğ
wÜk_dÚe
;

925 if(
wÜk_dÚe
 < *
budg‘
) {

926 
où_id
 = 
	`g‘_oùeÚ_deviû_id
(
´iv
->
où_dev
);

927 
	`äú‘_nÙify_Çpi_com¶‘e
(
´iv
);

928 
	`oùeÚ_´oûss_droq_pŞl_cmd
(
où_id
, 
´iv
->
rxq
, 
POLL_EVENT_ENABLE_INTR
, 0);

933 
	}
}

939 
Ãt_deviû_¡©s
 *

940 
	$äú‘_¡©s
(
Ãt_deviû
 *
²dev
)

942 
	`ÿvium_´št
(
PRINT_FLOW
,"frcnet_stats:‚etwork stats called\n");

943  &(
	`GET_NETDEV_PRIV
(
²dev
)->
¡©s
);

944 
	}
}

949 
	$äú‘_tx_timeout
(
Ãt_deviû
 *
²dev
)

951 
	`ÿvium_”rÜ
("OCTNIC:ximeouˆfÜ %s\n", 
	`äú‘_g‘_devÇme
(
²dev
));

952 
²dev
->
Œªs_¡¬t
 = 
jiff›s
;

953 
	`Ãtif_wake_queue
(
²dev
);

954 
	}
}

	@frcdrv/frcdrv_network.h

30 #iâdeà
__FRC_NETWORK_H__


31 
	#__FRC_NETWORK_H__


	)

33 
	~<lšux/‘h”deviû.h
>

34 
	~<lšux/.h
>

35 
	~<lšux/š.h
>

36 
	~"oùeÚ_maš.h
"

37 
	~"oùeÚ_nic.h
"

39 
	~"äc.h
"

41 
Ãt_deviû
 
	täú‘_os_dev±r_t
;

44 
	#OCT_NIC_IFSTATE_DROQ_OPS
 1

	)

45 
	#OCT_NIC_IFSTATE_REGISTERED
 2

	)

46 
	#OCT_NIC_IFSTATE_RUNNING
 4

	)

47 
	#OCT_NIC_IFSTATE_TXENABLED
 8

	)

52 
	#OCT_NIC_USE_NAPI
 0

	)

59 
	moùeÚ_id
;

61 
ÿvium_wa™_chªÃl
 
	mwc
;

63 
	mcÚd
;

64 } 
	ms
;

67 
ušt64_t
 
	m»¥_hdr
;

69 
ušt64_t
 
	mlšk_couÁ
;

71 
où_lšk_šfo_t
 
	mlšk_šfo
[
MAX_OCTEON_LINKS
];

73 
ušt64_t
 
	m¡©us
;

75 } 
	toù_lšk_¡©us_»¥_t
;

77 
	#OCT_LINK_STATUS_RESP_SIZE
 ((
où_lšk_¡©us_»¥_t
))

	)

86 
	säcdev_´İs_t
 {

89 
	mifcouÁ
;

93 
où_lšk_¡©us_»¥_t
 *
	mls
;

97 
oùeÚ_soá_š¡ruùiÚ_t
 *
	msi_lšk_¡©us
;

101 
ÿvium_©omic_t
 
	mls_æag
;

105 
	mÏ¡_check
;

109 
äú‘_os_dev±r_t
 *
	m²dev
[
MAX_OCTEON_LINKS
];

121 
ÿvium_¥šlock_t
 
	mlock
;

124 
©omic_t
 
	mif¡©e
;

128 
	mifidx
;

131 
	mtxq
;

134 
	mrxq
;

137 
ÿvium_li¡_t
 
	mgli¡
;

141 
äcdev_´İs_t
 *
	mäırİs
;

144 *
	moù_dev
;

146 
äú‘_os_dev±r_t
 *
	m²dev
;

148 #ià
LINUX_VERSION_CODE
 >ğ
KERNEL_VERSION
(2,6,24)

149 
Çpi_¡ruù
 
	mÇpi
;

153 
où_lšk_šfo_t
 
	mlšfo
;

156 
Ãt_deviû_¡©s
 
	m¡©s
;

160 
ušt32_t
 
	mtx_qsize
;

163 
ušt32_t
 
	mrx_qsize
;

166 
ušt32_t
 
	m²dev_æags
;

169 
oùÃt_ifæags_t
 
	mcÜe_æags
;

170 #ià
FRC_CONFIG_LOCK_NET_XMIT


171 
ÿvium_¥šlock_t
 
	mxm™_lock
;

173 } 
	täú‘_´iv_t
;

174 
	#OCTNET_PRIV_SIZE
 ((
äú‘_´iv_t
))

	)

181 
	#OCTNIC_MAX_SG
 (
	`ROUNDUP4
(
MAX_SKB_FRAGS
è>> 2)

	)

185 
	soùnic_g©h”
 {

188 
ÿvium_li¡_t
 
	mli¡
;

191 
	msg_size
;

194 
	madju¡
;

198 
oùeÚ_sg_’Œy_t
 *
	msg
;

210 
	säú‘_buf_ä“_šfo
 {

213 
äú‘_´iv_t
 *
	m´iv
;

216 
sk_buff
 *
	mskb
;

219 
oùnic_g©h”
 *
	mg
;

222 
ušt64_t
 
	md±r
;

232 
šlše
 

233 
	$OCTNET_IFSTATE_CHECK
(
äú‘_´iv_t
 *
´iv
, 
¡©e_æag
)

235  (
	`ÿvium_©omic_»ad
(&
´iv
->
if¡©e
è& 
¡©e_æag
);

236 
	}
}

239 
šlše
 

240 
	$OCTNET_IFSTATE_SET
(
äú‘_´iv_t
 *
´iv
, 
¡©e_æag
)

242 
	`ÿvium_©omic_£t
(&
´iv
->
if¡©e
,

243 (
	`ÿvium_©omic_»ad
(&
´iv
->
if¡©e
è| 
¡©e_æag
) );

244 
	}
}

246 
šlše
 

247 
	$OCTNET_IFSTATE_RESET
(
äú‘_´iv_t
 *
´iv
, 
¡©e_æag
)

249 
	`ÿvium_©omic_£t
(&
´iv
->
if¡©e
,

250 (
	`ÿvium_©omic_»ad
(&
´iv
->
if¡©e
è& ~(
¡©e_æag
)) );

251 
	}
}

258 
oùnic_ä“_Ãtbuf
(*
buf
);

261 
oùnic_ä“_Ãtsgbuf
(*
buf
);

267 
äú‘_ä“_tx_buf
(
oùeÚ_»q_¡©us_t
 
¡©us
, *
¬g
);

270 
äú‘_İ’
(
äú‘_os_dev±r_t
 *
²dev
);

273 
äú‘_¡İ
(
äú‘_os_dev±r_t
 *
²dev
);

277 
äú‘_£t_mÿ¡_li¡
(
äú‘_os_dev±r_t
 *
²dev
);

281 
äú‘_£t_mac
(
äú‘_os_dev±r_t
 *
²dev
, *
addr
);

284 
äú‘_chªge_mtu
(
äú‘_os_dev±r_t
 *
²dev
, 
Ãw_mtu
);

287 
äú‘_xm™
(
sk_buff
 *
skb
, 
äú‘_os_dev±r_t
 *
²dev
);

289 
Ãt_deviû_¡©s
 *

290 
äú‘_¡©s
(
äú‘_os_dev±r_t
 *
²dev
);

293 
äú‘_tx_timeout
(
äú‘_os_dev±r_t
 *
²dev
);

296 
äú‘_£tup_š¡r
(
oùeÚ_id
, 
äú‘_´iv_t
 *
´iv
, 
pÜt
);

299 
äú‘_push_·ck‘
(
oùeÚ_id
, *
skbuff
, 
ušt32_t
 
Ën
, 
oùeÚ_»¥_hdr_t
 *
»¥_hdr
);

303 
šlše
 *

304 
	$äú‘_g‘_devÇme
(
äú‘_os_dev±r_t
 *
dev
)

306 
Ãt_deviû
 *
ldev
 = (Ãt_deviû *)
dev
;

308  
ldev
->
Çme
;

309 
	}
}

313 
	#GET_NETDEV_PRIV
(
²dev
è((
äú‘_´iv_t
 *)
	`Ãtdev_´iv
Õndev))

	)

318 #ià
LINUX_VERSION_CODE
 >ğ
KERNEL_VERSION
(2,6,24)

319 
äú‘_Çpi_pŞl
(
Çpi_¡ruù
 *
Çpi
, 
budg‘
);

321 
äú‘_Çpi_pŞl
(
Ãt_deviû
 *
²dev
, *
budg‘
);

330 
äú‘_¡İ_txqueue
(
äú‘_os_dev±r_t
 *
²dev
);

333 
äú‘_¡¬t_txqueue
(
äú‘_os_dev±r_t
 *
²dev
);

336 
äú‘_»¡¬t_txqueue
(
äú‘_os_dev±r_t
 *
²dev
);

	@frcdrv/frcdrv_rule.c

2 
	~<asm/·ge.h
>

3 
	~<lšux/¦ab.h
>

4 
	~<lšux/´oc_fs.h
>

5 
	~"äcdrv.h
"

6 
	~"äcdrv_udp.h
"

7 
	~"äc_·ck.h
"

8 
	~"äc_dma.h
"

9 
	~"äcdrv_cmd.h
"

10 
	~"äcdrv_ÃtwÜk.h
"

11 
	~"äcdrv_dma.h
"

12 
	~"äcdrv_chª.h
"

14 #ià
FRC_CONFIG_RULE


15 
	$äcdrv_ruË_chª_š™
()

17 
äc_dma_sim¶e_·ckage_chª_t
 *
chª
;

18 
chª
 = 
	`äcdrv_sim¶e_·kÿge_chª_g‘
(
FRC_WORK_RULE
);

20 ià(
chª
 =ğ
NULL
)

22 
	`FRCDRV_ERROR
("RULE chan init fail!\n");

23  
FRE_FAIL
;

26 if(
	`äcdrv_sim¶e_·ckage_chª_£tup
(
chª
, 
FRC_WORK_RULE
, 
FRC_DMA_SIMPLE_PACKAGE_POOL_NUM_MAX
))

28 
	`FRCDRV_ERROR
("RULE chan init fail!\n");

29  
FRE_FAIL
;

32  
FRE_SUCCESS
;

33 
	}
}

35 
	$äcdrv_ruË_chª_¡¬t
(
oùeÚ_deviû_t
 *
où
)

37 
äc_dma_sim¶e_·ckage_chª_t
 *
chª
;

40 
chª
 = 
	`äcdrv_sim¶e_·kÿge_chª_g‘
(
FRC_WORK_RULE
);

41 ià(
chª
 =ğ
NULL
)

43 
	`FRCDRV_ERROR
("RULE chan set core fail!\n");

44  
FRE_FAIL
;

46 ià(
	`äcdrv_sim¶e_·ckage_chª_£t_cÜe
(
où
, 
chª
)) {

47 
	`FRCDRV_ERROR
("RULE chan set core fail!\n");

48  
FRE_FAIL
;

51  
FRE_SUCCESS
;

52 
	}
}

	@frcdrv/frcdrv_rule.h

1 #iâdeà
__FRCDRV_RULE_H__


2 
	#__FRCDRV_RULE_H__


	)

4 
	~"äc.h
"

5 
	~"äcdrv.h
"

6 
	~"äc_li¡.h
"

7 
	~"äc_ioùl.h
"

9 #ià
FRC_CONFIG_RULE


10 
äcdrv_ruË_chª_š™
();

11 
äcdrv_ruË_chª_¡¬t
(
oùeÚ_deviû_t
 *
oùeÚ_dev
);

	@frcdrv/frcdrv_tcp.c

2 
	~<asm/·ge.h
>

3 
	~<lšux/¦ab.h
>

4 
	~<lšux/´oc_fs.h
>

5 
	~"äcdrv.h
"

6 
	~"äcdrv_tı.h
"

9 
	~"äc_·ck.h
"

10 
	~"äc_dma.h
"

12 
	~"äcdrv_cmd.h
"

13 
	~"äcdrv_ÃtwÜk.h
"

14 
	~"äcdrv_dma.h
"

15 
	~"äcdrv_chª.h
"

17 #ià
FRC_CONFIG_SSN


18 
	$äcdrv_s¢_š™
()

20 
äc_dma_s¢_chª_t
 *
chª
;

21 
chª
 = 
	`äcdrv_s¢_chª_g‘
(
FRC_WORK_SSN
);

23 ià(
chª
 =ğ
NULL
)

25 
	`FRCDRV_ERROR
("SSN chan init fail!\n");

26  
FRE_FAIL
;

29 if(
	`äcdrv_s¢_chª_£tup
(
chª
, 
FRC_WORK_SSN
, 
FRC_DMA_SSN_POOL_NUM_MAX
))

31 
	`FRCDRV_ERROR
("SSN chan init fail!\n");

32  
FRE_FAIL
;

35  
FRE_SUCCESS
;

36 
	}
}

38 
	$äcdrv_s¢_¡¬t
(
oùeÚ_deviû_t
 *
où
)

40 
äc_dma_s¢_chª_t
 *
chª
;

43 
chª
 = 
	`äcdrv_s¢_chª_g‘
(
FRC_WORK_SSN
);

45 ià(
chª
 =ğ
NULL
)

47 
	`FRCDRV_ERROR
("SSN chan set core fail!\n");

48  
FRE_FAIL
;

50 ià(
	`äcdrv_s¢_chª_£t_cÜe
(
où
, 
chª
)) {

51 
	`FRCDRV_ERROR
("SSN chan set core fail!\n");

52  
FRE_FAIL
;

55  
FRE_SUCCESS
;

56 
	}
}

	@frcdrv/frcdrv_tcp.h

1 #iâdeà
__FRCDRV_TCP_H__


2 
	#__FRCDRV_TCP_H__


	)

4 
	~"äc.h
"

5 
	~"äcdrv.h
"

6 
	~"äc_li¡.h
"

7 
	~"äc_ioùl.h
"

9 #ià
FRC_CONFIG_SSN_CHAN


10 #ià
FRC_CONFIG_SSN


11 
äcdrv_s¢_š™
();

12 
äcdrv_s¢_¡¬t
(
oùeÚ_deviû_t
 *
où
);

	@frcdrv/frcdrv_udp.c

2 
	~<asm/·ge.h
>

3 
	~<lšux/¦ab.h
>

4 
	~<lšux/´oc_fs.h
>

5 
	~"äcdrv.h
"

6 
	~"äcdrv_udp.h
"

9 
	~"äc_·ck.h
"

10 
	~"äc_dma.h
"

12 
	~"äcdrv_cmd.h
"

13 
	~"äcdrv_ÃtwÜk.h
"

14 
	~"äcdrv_dma.h
"

15 
	~"äcdrv_chª.h
"

18 #ià
FRC_CONFIG_SIMPLE_PACKAGE


19 
	$äcdrv_udp_chª_š™
()

21 
äc_dma_sim¶e_·ckage_chª_t
 *
chª
;

22 
chª
 = 
	`äcdrv_sim¶e_·kÿge_chª_g‘
(
FRC_WORK_UDP
);

24 ià(
chª
 =ğ
NULL
)

26 
	`FRCDRV_ERROR
("UDP chan init fail!\n");

27  
FRE_FAIL
;

30 if(
	`äcdrv_sim¶e_·ckage_chª_£tup
(
chª
, 
FRC_WORK_UDP
, 
FRC_DMA_SIMPLE_PACKAGE_POOL_NUM_MAX
))

32 
	`FRCDRV_ERROR
("UDP chan init fail!\n");

33  
FRE_FAIL
;

36  
FRE_SUCCESS
;

37 
	}
}

39 
	$äcdrv_udp_chª_¡¬t
(
oùeÚ_deviû_t
 *
où
)

41 
äc_dma_sim¶e_·ckage_chª_t
 *
chª
;

44 
chª
 = 
	`äcdrv_sim¶e_·kÿge_chª_g‘
(
FRC_WORK_UDP
);

46 ià(
chª
 =ğ
NULL
)

48 
	`FRCDRV_ERROR
("UDP chan set core fail!\n");

49  
FRE_FAIL
;

51 ià(
	`äcdrv_sim¶e_·ckage_chª_£t_cÜe
(
où
, 
chª
)) {

52 
	`FRCDRV_ERROR
("UDP chan set core fail!\n");

53  
FRE_FAIL
;

56  
FRE_SUCCESS
;

57 
	}
}

	@frcdrv/frcdrv_udp.h

1 #iâdeà
__FRCDRV_UDP_H__


2 
	#__FRCDRV_UDP_H__


	)

4 
	~"äc.h
"

5 
	~"äcdrv.h
"

6 
	~"äc_li¡.h
"

7 
	~"äc_ioùl.h
"

9 #ià
FRC_CONFIG_SIMPLE_PACKAGE


10 
äcdrv_udp_chª_š™
();

11 
äcdrv_udp_chª_¡¬t
(
oùeÚ_deviû_t
 *
oùeÚ_dev
);

	@frcdrv/octeon_nic.c

26 
	~"ÿvium_sysd•.h
"

27 
	~"ú3xxx_deviû.h
"

28 
	~"ú56xx_deviû.h
"

29 
	~"oùeÚ_maüos.h
"

30 
	~"oùeÚ_nic.h
"

35 
	$oùÃt_£nd_nic_d©a_pkt
(
oùeÚ_deviû_t
 *
où
, 
oùnic_d©a_pkt_t
 *
nd©a
)

37  
	`oùeÚ_£nd_nÜe¥Ú£_commªd
(
où
, 
nd©a
->
q_no
, 1, &nd©a->
cmd
,

38 
nd©a
->
buf
,‚d©a->
d©asize
,‚d©a->
buáy³
);

39 
	}
}

47 
	$oùÃt_lšk_ù¾_ÿÎback
(
oùeÚ_»q_¡©us_t
 
¡©us
, *
sif_±r
)

49 
oùeÚ_soá_š¡ruùiÚ_t
 *
si
 = (oùeÚ_soá_š¡ruùiÚ_ˆ*)
sif_±r
;

50 
oùnic_ù¾_pkt_t
 *
nù¾
;

52 
nù¾
 = (
oùnic_ù¾_pkt_t
 *)((
ušt8_t
 *)
si
 + 
OCT_SOFT_INSTR_SIZE
);

58 if(!
¡©us
 && 
nù¾
->
cb_â
)

59 
nù¾
->
	`cb_â
(nctrl);

61 
	`ÿvium_ä“_dma
(
si
);

62 
	}
}

69 
šlše
 
oùeÚ_soá_š¡ruùiÚ_t
 *

70 
	$oùnic_®loc_ù¾_pkt_si
(
oùeÚ_deviû_t
 *
où
, 
oùnic_ù¾_pkt_t
 *
nù¾
)

72 
oùeÚ_soá_š¡ruùiÚ_t
 *
si
 = 
NULL
;

73 
ušt8_t
 *
d©a
;

74 
ušt32_t
 
uddsize
 = 0, 
d©asize
 = 0;

76 
uddsize
 = (
nù¾
->
ncmd
.
s
.
mÜe
 * 8);

78 
d©asize
 = 
OCTNET_CMD_SIZE
 + 
uddsize
 + (
nù¾
->
wa™_time
?16:0);

81 
d©asize
 +ğ(
oùnic_ù¾_pkt_t
) + 8;

83 
si
 = 
	`ÿvium_m®loc_dma
Ğ(
OCT_SOFT_INSTR_SIZE
 + 
d©asize
),

84 
__CAVIUM_MEM_ATOMIC
);

85 if(
si
 =ğ
NULL
)

86  
NULL
;

88 
	`ÿvium_mem£t
(
si
, 0, (
OCT_SOFT_INSTR_SIZE
 + 
d©asize
) );

90 
	`ÿvium_memıy
(((
ušt8_t
 *)
si
 + 
OCT_SOFT_INSTR_SIZE
), 
nù¾
,

91 (
oùnic_ù¾_pkt_t
));

93 
si
->
ih
.
fsz
 = 16;

94 
si
->
ih
.
gty³
 = 
ORDERED_TAG
;

95 
si
->
ih
.
g
 = 0x11111111;

96 
si
->
ih
.
¿w
 = 1;

97 
si
->
ih
.
rs
 = 1;

98 
si
->
ih
.
g½
 = 
FRC_CMD_GRP
;

99 
si
->
œh
.
İcode
 = 
OCT_NW_CMD_OP
;

100 
	`SET_SOFT_INSTR_DMA_MODE
(
si
, 
OCTEON_DMA_DIRECT
);

101 
	`SET_SOFT_INSTR_OCTEONID
(
si
, 
où
->
oùeÚ_id
);

102 
	`SET_SOFT_INSTR_IQ_NO
(
si
, 0);

103 
	`SET_SOFT_INSTR_CALLBACK
(
si
, 
oùÃt_lšk_ù¾_ÿÎback
);

104 
	`SET_SOFT_INSTR_CALLBACK_ARG
(
si
, (*)si);

106 
d©a
 = (
ušt8_t
 *)
si
 + 
OCT_SOFT_INSTR_SIZE
 +

107 (
oùnic_ù¾_pkt_t
);

108 
si
->
d±r
 = 
d©a
;

109 
si
->
ih
.
dËngsz
 = 
OCTNET_CMD_SIZE
 + 
uddsize
;

111 
	`ÿvium_memıy
(
d©a
, &
nù¾
->
ncmd
, 
OCTNET_CMD_SIZE
);

112 
	`oùeÚ_sw­_8B_d©a
Ğ(
ušt64_t
 *)
d©a
, (
OCTNET_CMD_SIZE
 >> 3));

114 if(
uddsize
) {

116 
	`ÿvium_memıy
(
d©a
 + 
OCTNET_CMD_SIZE
, 
nù¾
->
udd
, 
uddsize
);

119 if(
nù¾
->
wa™_time
) {

120 
si
->
½Œ
 = ((
ušt8_t
 *)si->
d±r
 + si->
ih
.
dËngsz
);

121 if(()
si
->
½Œ
 & 0x7) {

122 
si
->
½Œ
 = (*)((()si->rptr + 8) & ~0x7);

124 
si
->
œh
.
¾’ssz
 = 16;

125 
si
->
¡©us_wÜd
 = (
ušt64_t
 *)((
ušt8_t
 *)si->
½Œ
 + 8);

126 *(
si
->
¡©us_wÜd
èğ
COMPLETION_WORD_INIT
;

128 
	`SET_SOFT_INSTR_RESP_ORDER
(
si
, 
OCTEON_RESP_ORDERED
);

129 
	`SET_SOFT_INSTR_RESP_MODE
(
si
, 
OCTEON_RESP_NON_BLOCKING
);

130 
	`SET_SOFT_INSTR_TIMEOUT
(
si
, 
nù¾
->
wa™_time
);

132 
	`SET_SOFT_INSTR_RESP_ORDER
(
si
, 
OCTEON_RESP_NORESPONSE
);

135 
	`SET_SOFT_INSTR_ALLOCFLAGS
(
si
, 
OCTEON_SOFT_INSTR_DB_NOW
);

137 
	`ÿvium_´št
(
PRINT_FLOW
,

139 
__CVM_FUNCTION__
, 
si
, 
uddsize
, 
d©asize
, si->
d±r
, si->
½Œ
);

141  
si
;

142 
	}
}

151 
	$oùÃt_£nd_nic_ù¾_pkt
(
oùeÚ_deviû_t
 *
où
, 
oùnic_ù¾_pkt_t
 *
nù¾
)

153 
oùeÚ_š¡r_¡©us_t
 
»tv®
;

154 
oùeÚ_soá_š¡ruùiÚ_t
 *
si
 = 
NULL
;

156 
si
 = 
	`oùnic_®loc_ù¾_pkt_si
(
où
, 
nù¾
);

157 if(
si
 =ğ
NULL
) {

158 
	`ÿvium_”rÜ
("OCTNIC: % soá in¡¸®loøçed\n", 
__CVM_FUNCTION__
);

162 
»tv®
 = 
	`oùeÚ_´oûss_š¡ruùiÚ
(
où
, 
si
, 
NULL
);

163 if(
»tv®
.
u64
 =ğ
OCTEON_REQUEST_FAILED
) {

164 
	`ÿvium_”rÜ
("OCTNIC: % soá in¡¸£nd faed\n", 
__CVM_FUNCTION__
);

169 
	}
}

	@frcdrv/octeon_nic.h

29 #iâdeà 
__CAVIUM_NIC_H__


30 
	#__CAVIUM_NIC_H__


	)

32 
	~"äc.h
"

33 
	~"ÿvium-li¡.h
"

34 
	~"oùeÚ_deviû.h
"

35 
	~"oùeÚ-nic-commÚ.h
"

41 
	#MAX_NCTRL_UDD
 1

	)

46 (*
	toùnic_ù¾_pkt_cb_â_t
)(*);

54 
oùÃt_cmd_t
 
ncmd
;

57 
ušt64_t
 
udd
[
MAX_NCTRL_UDD
];

61 
wa™_time
;

64 
Ãndev
;

68 
oùnic_ù¾_pkt_cb_â_t
 
cb_â
;

70 
rsvd
;

72 } 
	toùnic_ù¾_pkt_t
;

83 *
buf
;

86 
buáy³
;

89 
d©asize
;

92 
oùeÚ_š¡r_32B_t
 
cmd
;

95 
q_no
;

97 } 
	toùnic_d©a_pkt_t
;

108 
ušt32_t
 
gmxpÜt
:8;

109 
ušt32_t
 
cksum_off£t
:7;

110 
ušt32_t
 
g©h”
:1;

111 
ušt32_t
 
rsvd
:16;

113 
ušt32_t
 
d©asize
;

114 
ušt32_t
 
g©h”±rs
;

115 }
u
;

116 }
s
;

118 
ušt64_t
 
u64
;

120 } 
	toùnic_cmd_£tup_t
;

129 
šlše
 

130 
	$oùÃt_iq_is_fuÎ
(
oùeÚ_deviû_t
 *
où
, 
q_no
)

132  (
	`ÿvium_©omic_»ad
(&
où
->
š¡r_queue
[
q_no
]->
š¡r_³ndšg
)

133 >ğ(
où
->
š¡r_queue
[
q_no
]->
max_couÁ
 - 2));

134 
	}
}

137 
šlše
 

138 
	$oùÃt_iq_bp_Ú
(
oùeÚ_deviû_t
 *
où
, 
q_no
)

140  
	`IQ_CHECK_BP_ON
((
oùeÚ_iq_t
 *)&
où
->
š¡r_queue
[
q_no
]);

141 
	}
}

146 
šlše
 

147 
	$oùÃt_´•¬e_pci_cmd
(
oùeÚ_š¡r_32B_t
 *
cmd
,

148 
oùnic_cmd_£tup_t
 *
£tup
)

150 vŞ©
oùeÚ_š¡r_ih_t
 *
ih
;

151 vŞ©
oùeÚ_š¡r_œh_t
 *
œh
;

153 
cmd
->
ih
 = 0;

154 
ih
 = (
oùeÚ_š¡r_ih_t
 *)&
cmd
->ih;

156 
ih
->
fsz
 = 16;

157 
ih
->
gty³
 = 
ORDERED_TAG
;

158 #ià
FRC_CONFIG_NIC_GRP


159 
ih
->
g½
 = 
FRC_PKT_GRP
;

161 
ih
->
g½
 = 
OCTNET_POW_GRP
;

163 
ih
->
g
 = 0x11111111 + 
£tup
->
s
.
gmxpÜt
;

164 
ih
->
¿w
 = 1;

167 if(!
£tup
->
s
.
g©h”
) {

168 
ih
->
dËngsz
 = 
£tup
->
s
.
u
.
d©asize
;

170 
ih
->
g©h”
 = 1;

171 
ih
->
dËngsz
 = 
£tup
->
s
.
u
.
g©h”±rs
;

174 
cmd
->
½Œ
 = 0;

175 
cmd
->
œh
 = 0;

176 
œh
 = (
oùeÚ_š¡r_œh_t
 *)&
cmd
->irh;

178 if(
£tup
->
s
.
cksum_off£t
)

179 
œh
->
¾’ssz
 = 
£tup
->
s
.
cksum_off£t
;

181 
œh
->
İcode
 = 
OCT_NW_PKT_OP
;

182 
œh
->
·¿m
 = 
£tup
->
s
.
gmxpÜt
;

183 
	}
}

188 
oùÃt_£nd_nic_d©a_pkt
(
oùeÚ_deviû_t
 *
où
, 
oùnic_d©a_pkt_t
 *
nd©a
);

192 
oùÃt_£nd_nic_ù¾_pkt
(
oùeÚ_deviû_t
 *
où
, 
oùnic_ù¾_pkt_t
 *
nù¾
);

	@frcdrv/zerocp.c

1 
	ga
. 8139
	gtoo
.
	gc
ÖĞ¼ÓÈëµÄ´úÂë

3 
	~<lšux/w¿µ”.h
>

4 
	~<asm/·ge.h
>

5 
	~<lšux/¦ab.h
>

6 
	~<lšux/´oc_fs.h
>

7 
	#PAGES_ORDER
 9

	)

8 
	#PAGES
 512

	)

9 
	#MEM_WIDTH
 1500

	)

12 
	sMEM_DATA


15 
	mwidth
;

16 
	mËngth
;

19 
	mwi
;

20 
	mri
;

21 } * 
	gmem_d©a
;

22 
	sMEM_PACKET


24 
	mËn
;

25 
	m·ck‘p
[
MEM_WIDTH
 - 4];

27 
	gsu1_2
;

31 
	$d–_mem
()

33 
·ges
 = 0;

34 *
addr
;

35 
addr
 = (*)
su1_2
;

36 
·ges
 <=
PAGES
 -1)

38 
	`mem_m­_uÄe£rve
(
	`vœt_to_·ge
(
addr
));

39 
addr
 =‡dd¸+ 
PAGE_SIZE
;

40 
·ges
++;

42 
	`ä“_·ges
(
su1_2
,
PAGES_ORDER
);

43 
	}
}

44 
	$š™_mem
()

52 
i
;

53 
·ges
 = 0;

54 *
addr
;

55 *
buf
;

56 
MEM_PACKET
 * 
cu¼_·ck
;

58 
su1_2
 = 
	`__g‘_ä“_·ges
(
GFP_KERNEL
,
PAGES_ORDER
);

59 
	`´štk
("[%x]\n",
su1_2
);

60 
addr
 = (*)
su1_2
;

61 
·ges
 <ğ
PAGES
 -1)

63 
	`mem_m­_»£rve
(
	`vœt_to_·ge
(
addr
));

64 
addr
 =‡dd¸+ 
PAGE_SIZE
;

65 
·ges
++;

67 
mem_d©a
 = (
MEM_DATA
 *)
su1_2
;

68 
mem_d©a
[0].
ri
 = 1;

69 
mem_d©a
[0].
wi
 = 1;

70 
mem_d©a
[0].
Ëngth
 = 
PAGES
*4*1024 / 
MEM_WIDTH
;

71 
mem_d©a
[0].
width
 = 
MEM_WIDTH
;

73 
i
=1;i<=
mem_d©a
[0].
Ëngth
;i++)

75 
buf
 = (*)((*)
su1_2
 + 
MEM_WIDTH
 * 
i
);

76 
cu¼_·ck
 = (
MEM_PACKET
 *)
buf
;

77 
cu¼_·ck
->
Ën
 = 0;

79 
	}
}

82 
	$put_mem
(*
aBuf
,
·ck_size
)

91 
s
,
i
,
width
,
Ëngth
,
mem_i
;

92 *
buf
;

93 
MEM_PACKET
 * 
cu¼_·ck
;

94 
s
 = 0;

95 
mem_d©a
 = (
MEM_DATA
 *)
su1_2
;

96 
width
 = 
mem_d©a
[0].width;

97 
Ëngth
 = 
mem_d©a
[0].length;

98 
mem_i
 = 
mem_d©a
[0].
wi
;

99 
buf
 = (*)((*)
su1_2
 + 
width
 * 
mem_i
);

100 
i
=1;i<
Ëngth
;i++){

101 
cu¼_·ck
 = (
MEM_PACKET
 *)
buf
;

102 ià(
cu¼_·ck
->
Ën
 == 0){

103 
	`memıy
(
cu¼_·ck
->
·ck‘p
,
aBuf
,
·ck_size
);

104 
cu¼_·ck
->
Ën
 = 
·ck_size
;;

105 
s
 = 
mem_i
;

106 
mem_i
++;

107 ià(
mem_i
 >ğ
Ëngth
)

108 
mem_i
 = 1;

109 
mem_d©a
[0].
wi
 = 
mem_i
;

112 
mem_i
++;

113 ià(
mem_i
 >ğ
Ëngth
){

114 
mem_i
 = 1;

115 
buf
 = (*)((*)
su1_2
 + 
width
);

117 
buf
 = (*)
su1_2
 + 
width
*
mem_i
;

119 if(
i
 >ğ
Ëngth
)

120 
s
 = 0;

121  
s
;

122 
	}
}

124 
	$»ad_´oÿddr
(*
buf
,**
¡¬t
,
off_t
 
off£t
,
couÁ
,*
eof
,*
d©a
)

126 
	`¥rštf
(
buf
,"%u\n",
	`__·
(
su1_2
));

127 *
eof
 = 1;

129 
	}
}

131 ÔÚ8139
	gtoo
.
	gc
µÄ
¹l8139_š™_moduË
()º¯ÊıÖĞ¼ÓÈëÒÔÏÂ´úÂë£º

133 
	gput_pkt2mem_n
 = 0;

134 
š™_mem
();

135 
put_mem
("data1dfadfaserty",16);

136 
put_mem
("data2zcvbnm",11);

137 
put_mem
("data39876543210poiuyt",21);

138 
ü—‹_´oc_»ad_’Œy
("nf_addr",0,
NULL
,
»ad_´oÿddr
,NULL);

140 ÔÚ8139
	gtoo
.
	gc
µÄ
¹l8139_ş—nup_moduË
()º¯ÊıÖĞ¼ÓÈëÒÔÏÂ´úÂë£º

142 
d–_mem
();

143 
»move_´oc_’Œy
("nf_addr",
NULL
);

145 
	gb
£®ÓÃ»§¿Õ¼ä¶ÁÈ¡»º´æ´úÂë

146 
	~<¡dio.h
>

147 
	~<uni¡d.h
>

148 
	~<sys/¡©.h
>

149 
	~<sys/mmª.h
>

150 
	~<fú.h
>

151 
	#PAGES
 512

	)

152 
	#MEM_WIDTH
 1500

	)

153 
	sMEM_DATA


156 
	mwidth
;

157 
	mËngth
;

160 
	mwi
;

161 
	mri
;

162 } * 
	gmem_d©a
;

163 
	sMEM_PACKET


165 
	mËn
;

166 
	m·ck‘p
[
MEM_WIDTH
 - 4];

168 
	$g‘_mem
(*
aMem
,*
aBuf
,*
size
)

178 
i
,
s
,
width
,
Ëngth
,
mem_i
;

179 *
buf
;

180 
MEM_PACKET
 * 
cu¼_·ck
;

181 
s
 = 0;

182 
mem_d©a
 = (*)
aMem
;

183 
width
 = 
mem_d©a
[0].width;

184 
Ëngth
 = 
mem_d©a
[0].length;

185 
mem_i
 = 
mem_d©a
[0].
ri
;

186 
buf
 = (*)(
aMem
 + 
width
 * 
mem_i
);

187 
cu¼_·ck
 = (
MEM_PACKET
 *)
buf
;

188 ià(
cu¼_·ck
->
Ën
 != 0){

189 
	`memıy
(
aBuf
,
cu¼_·ck
->
·ck‘p
,cu¼_·ck->
Ën
);

190 *
size
 = 
cu¼_·ck
->
Ën
;

191 
cu¼_·ck
->
Ën
 = 0;

192 
s
 = 
mem_d©a
[0].
ri
;

193 
mem_d©a
[0].
ri
++;

194 if(
mem_d©a
[0].
ri
 >ğ
Ëngth
)

195 
mem_d©a
[0].
ri
 = 1;

196 
»t
;

199 
i
=1;i<
Ëngth
;i++){

200 
mem_i
++;

201 ià(
mem_i
 >ğ
Ëngth
)

202 
mem_i
 = 1;

203 
buf
 = (*)(
aMem
 + 
width
*
mem_i
);

204 
cu¼_·ck
 = (
MEM_PACKET
 *)
buf
;

205 ià(
cu¼_·ck
->
Ën
 == 0)

207 
	`memıy
(
aBuf
,
cu¼_·ck
->
·ck‘p
,cu¼_·ck->
Ën
);

208 *
size
 = 
cu¼_·ck
->
Ën
;

209 
cu¼_·ck
->
Ën
 = 0;

210 
s
 = 
mem_d©a
[0].
ri
 = 
mem_i
;

211 
mem_d©a
[0].
ri
++;

212 if(
mem_d©a
[0].
ri
 >ğ
Ëngth
)

213 
mem_d©a
[0].
ri
 = 1;

216 
»t
:

217  
s
;

218 
	}
}

219 
	$maš
()

221 *
su1_2
;

222 
»ûive
[1500];

223 
i
,
j
;

224 
fd
;

225 
fd_´oÿddr
;

226 
size
;

227 
addr
[9];

228 
ADDR
;

230 
j
 = 0;

232 
fd
=
	`İ’
("/dev/mem",
O_RDWR
);

233 
fd_´oÿddr
 = 
	`İ’
("/´oc/nf_addr",
O_RDONLY
);

234 
	`»ad
(
fd_´oÿddr
,
addr
,9);

235 
ADDR
 = 
	`©Ş
(
addr
);

236 
	`şo£
(
fd_´oÿddr
);

237 
	`´štf
("%u[%8lx]\n",
ADDR
,ADDR);

239 
su1_2
 = 
	`mm­
(0,
PAGES
*4*1024, 
PROT_READ
|
PROT_WRITE
, 
MAP_SHARED
, 
fd
, 
ADDR
);

240 
	`³¼Ü
("mmap");

243 
	`bz”o
(
»ûive
,1500);

244 
i
 = 
	`g‘_mem
(
su1_2
,
»ûive
,&
size
);

245 ià(
i
 != 0)

247 
j
++;

248 
	`´štf
("%d:%s[sizğ%d]\n",
j
,
»ûive
,
size
);

252 
	`´štf
("there have‚o data\n");

253 
	`munm­
(
su1_2
,
PAGES
*4*1024);

254 
	`şo£
(
fd
);

259 
	}
}

	@frcore/config/cvmcs-test-config.h

27 #iâdeà
__CVMCS_TEST_CONFIG_H__


28 
	#__CVMCS_TEST_CONFIG_H__


	)

35 #ifdeà
CAVIUM_COMPONENT_REQUIREMENT


38 
	gcvmxcÚfig


40 
åa
 
CVM_FPA_TEST_POOL


41 
	gsize
 = 16

42 
´iÜ™y
 = 1

43 
desütiÚ
 = "Test buffer…ool";

45 
sü©ch
 
CVMCS_TEST_BUF_PTR


46 
	gsize
 = 8

47 
iobdma
 = 
Œue


48 
³rmª’t
 = 
Œue


49 
desütiÚ
 = "Scratch…ad†ocation forest buffer";

	@frcore/config/cvmx-config.h

1 #iâdeà
__CVMX_CONFIG_H__


2 
	#__CVMX_CONFIG_H__


	)

12 
	#CVMX_LLM_NUM_PORTS
 1

	)

13 
	#CVMX_NULL_POINTER_PROTECT
 1

	)

14 
	#CVMX_ENABLE_DEBUG_PRINTS
 1

	)

15 
	#CVMX_PKO_QUEUES_PER_PORT_INTERFACE0
 1

	)

16 
	#CVMX_PKO_QUEUES_PER_PORT_INTERFACE1
 1

	)

17 
	#CVMX_PKO_MAX_PORTS_INTERFACE0
 
CVMX_HELPER_PKO_MAX_PORTS_INTERFACE0


	)

18 
	#CVMX_PKO_MAX_PORTS_INTERFACE1
 
CVMX_HELPER_PKO_MAX_PORTS_INTERFACE1


	)

19 
	#CVMX_PKO_QUEUES_PER_PORT_PCI
 1

	)

20 
	#CVMX_PKO_QUEUES_PER_PORT_LOOP
 1

	)

21 
	#CVMX_PKO_QUEUES_PER_PORT_SRIO0
 2

	)

22 
	#CVMX_PKO_QUEUES_PER_PORT_SRIO1
 2

	)

23 
	#CVMX_IPD_DRAM_MODE
 
CVMX_HELPER_IPD_DRAM_MODE


	)

27 
	#CVMX_FPA_POOL_0_SIZE
 (16* 
CVMX_CACHE_LINE_SIZE
)

	)

28 
	#CVMX_FPA_POOL_1_SIZE
 (16 * 
CVMX_CACHE_LINE_SIZE
)

	)

29 
	#CVMX_FPA_POOL_2_SIZE
 (1 * 
CVMX_CACHE_LINE_SIZE
)

	)

30 
	#CVMX_FPA_POOL_3_SIZE
 (8 * 
CVMX_CACHE_LINE_SIZE
)

	)

31 
	#CVMX_FPA_POOL_4_SIZE
 (8 * 
CVMX_CACHE_LINE_SIZE
)

	)

32 
	#CVMX_FPA_POOL_5_SIZE
 (0 * 
CVMX_CACHE_LINE_SIZE
)

	)

33 
	#CVMX_FPA_POOL_6_SIZE
 (0 * 
CVMX_CACHE_LINE_SIZE
)

	)

34 
	#CVMX_FPA_POOL_7_SIZE
 (0 * 
CVMX_CACHE_LINE_SIZE
)

	)

37 
	#CVMX_FPA_PACKET_POOL
 (0è

	)

38 
	#CVMX_FPA_PACKET_POOL_SIZE
 
CVMX_FPA_POOL_0_SIZE


	)

39 
	#CVM_FPA_TEST_POOL
 (1è

	)

40 
	#CVM_FPA_TEST_POOL_SIZE
 
CVMX_FPA_POOL_1_SIZE


	)

41 
	#CVMX_FPA_WQE_POOL
 (2è

	)

42 
	#CVMX_FPA_WQE_POOL_SIZE
 
CVMX_FPA_POOL_2_SIZE


	)

43 
	#CVMX_FPA_OUTPUT_BUFFER_POOL
 (3è

	)

44 
	#CVMX_FPA_OUTPUT_BUFFER_POOL_SIZE
 
CVMX_FPA_POOL_3_SIZE


	)

45 
	#CVMX_FPA_TIMER_POOL
 (4è

	)

46 
	#CVMX_FPA_TIMER_POOL_SIZE
 
CVMX_FPA_POOL_4_SIZE


	)

58 
	#CVMX_FAU_REG_64_ADDR
(
x
è((x <<3è+ 
CVMX_FAU_REG_64_START
)

	)

61 
	mCVMX_FAU_REG_64_START
 = 0,

62 
	mCVMX_FAU_REG_64_END
 = 
CVMX_FAU_REG_64_ADDR
(0),

63 } 
	tcvmx_çu_»g_64_t
;

65 
	#CVMX_FAU_REG_32_ADDR
(
x
è((x <<2è+ 
CVMX_FAU_REG_32_START
)

	)

68 
	mCVMX_FAU_REG_32_START
 = 
CVMX_FAU_REG_64_END
,

69 
	mCVM_FAU_REG_FPA_OOB_COUNT
 = 
CVMX_FAU_REG_32_ADDR
(0),

71 
	mCVM_FAU_REG_POOL_0_USE_COUNT
 = 
CVMX_FAU_REG_32_ADDR
(8),

72 
	mCVM_FAU_REG_POOL_1_USE_COUNT
 = 
CVMX_FAU_REG_32_ADDR
(9),

73 
	mCVM_FAU_REG_POOL_2_USE_COUNT
 = 
CVMX_FAU_REG_32_ADDR
(10),

74 
	mCVM_FAU_REG_POOL_3_USE_COUNT
 = 
CVMX_FAU_REG_32_ADDR
(11),

75 
	mCVM_FAU_REG_POOL_4_USE_COUNT
 = 
CVMX_FAU_REG_32_ADDR
(12),

76 
	mCVM_FAU_REG_POOL_5_USE_COUNT
 = 
CVMX_FAU_REG_32_ADDR
(13),

77 
	mCVM_FAU_REG_POOL_6_USE_COUNT
 = 
CVMX_FAU_REG_32_ADDR
(14),

78 
	mCVM_FAU_REG_POOL_7_USE_COUNT
 = 
CVMX_FAU_REG_32_ADDR
(15),

79 
	mCVMX_FAU_REG_32_END
 = 
CVMX_FAU_REG_32_ADDR
(16),

80 } 
	tcvmx_çu_»g_32_t
;

82 
	#CVMX_FAU_REG_16_ADDR
(
x
è((x <<1è+ 
CVMX_FAU_REG_16_START
)

	)

85 
	mCVMX_FAU_REG_16_START
 = 
CVMX_FAU_REG_32_END
,

86 
	mCVMX_FAU_REG_16_END
 = 
CVMX_FAU_REG_16_ADDR
(0),

87 } 
	tcvmx_çu_»g_16_t
;

89 
	#CVMX_FAU_REG_8_ADDR
(
x
è((xè+ 
CVMX_FAU_REG_8_START
)

	)

91 
	mCVMX_FAU_REG_8_START
 = 
CVMX_FAU_REG_16_END
,

92 
	mCVMX_FAU_REG_8_END
 = 
CVMX_FAU_REG_8_ADDR
(0),

93 } 
	tcvmx_çu_»g_8_t
;

97 
	#CVMX_FAU_REG_AVAIL_BASE
 ((
CVMX_FAU_REG_8_END
 + 0x7è& (~0x7ULL))

	)

98 
	#CVMX_FAU_REG_END
 (2048)

	)

105 
	#CVMCS_TEST_BUF_PTR
 (0è

	)

106 
	#CVM_SCR_MBUFF_INFO_PTR
 (8è

	)

107 
	#CVM_DRV_SCR_WQE_BUF_PTR
 (16è

	)

108 
	#CVM_DRV_SCR_PACKET_BUF_PTR
 (24è

	)

109 
	#CVMX_SCR_SCRATCH
 (32è

	)

110 
	#CVMX_SCR_REG_AVAIL_BASE
 (40è

	)

	@frcore/config/executive-config.h

43 #iâdeà
__EXECUTIVE_CONFIG_H__


44 
	#__EXECUTIVE_CONFIG_H__


	)

52 
	#CVMX_ENABLE_PKO_FUNCTIONS


	)

57 
	#CVMX_ENABLE_TIMER_FUNCTIONS


	)

63 
	#CVMX_ENABLE_HELPER_FUNCTIONS


	)

69 
	#CVMX_HELPER_FIRST_MBUFF_SKIP
 0

	)

73 
	#CVMX_HELPER_NOT_FIRST_MBUFF_SKIP
 0

	)

77 
	#CVMX_HELPER_ENABLE_BACK_PRESSURE
 1

	)

83 
	#CVMX_HELPER_ENABLE_IPD
 1

	)

87 
	#CVMX_HELPER_INPUT_TAG_TYPE
 
CVMX_POW_TAG_TYPE_ORDERED


	)

93 
	#CVMX_HELPER_INPUT_TAG_IPV6_SRC_IP
 0

	)

94 
	#CVMX_HELPER_INPUT_TAG_IPV6_DST_IP
 0

	)

95 
	#CVMX_HELPER_INPUT_TAG_IPV6_SRC_PORT
 0

	)

96 
	#CVMX_HELPER_INPUT_TAG_IPV6_DST_PORT
 0

	)

97 
	#CVMX_HELPER_INPUT_TAG_IPV6_NEXT_HEADER
 0

	)

98 
	#CVMX_HELPER_INPUT_TAG_IPV4_SRC_IP
 1

	)

99 
	#CVMX_HELPER_INPUT_TAG_IPV4_DST_IP
 1

	)

100 
	#CVMX_HELPER_INPUT_TAG_IPV4_SRC_PORT
 1

	)

101 
	#CVMX_HELPER_INPUT_TAG_IPV4_DST_PORT
 1

	)

102 
	#CVMX_HELPER_INPUT_TAG_IPV4_PROTOCOL
 1

	)

103 
	#CVMX_HELPER_INPUT_TAG_INPUT_PORT
 1

	)

106 
	#CVMX_HELPER_INPUT_PORT_SKIP_MODE
 
CVMX_PIP_PORT_CFG_MODE_SKIPL2


	)

109 
	#CVMX_HELPER_PKO_QUEUES_PER_PORT_INTERFACE0
 1

	)

110 
	#CVMX_HELPER_PKO_QUEUES_PER_PORT_INTERFACE1
 1

	)

114 
	#CVMX_HELPER_DISABLE_RGMII_BACKPRESSURE
 0

	)

119 
	#CVMX_LLM_CONFIG_NUM_PORTS
 1

	)

121 #ià
defšed
(
CVMX_ENABLE_HELPER_FUNCTIONS
è&& !defšed(
CVMX_ENABLE_PKO_FUNCTIONS
)

122 
	#CVMX_ENABLE_PKO_FUNCTIONS


	)

126 
	~"cvmx-»sourûs.cÚfig
"

129 
	~"commÚ-cÚfig.h
"

132 
	~"cvm-drv-»sourûs.h
"

	@frcore/config/global-config.h

26 #iâdeà
__GLOBAL_CONFIG_H__


27 
	#__GLOBAL_CONFIG_H__


	)

	@frcore/frcore.c

28 
	~<¡dio.h
>

29 
	~<¡ršg.h
>

31 
	~"äcÜe.h
"

32 
	~"cvmx-h–³r.h
"

33 
	~"cvm-pci-lßd¡Üe.h
"

39 
ušt32_t
 
cÜe_id
;

41 
CVMX_SHARED
 
ušt32_t
 
	gcvm_fœ¡_buf_size_aá”_sk
;

42 
CVMX_SHARED
 
ušt32_t
 
	gcvm_subs_buf_size_aá”_sk
;

50 
	$äcÜe_pÜt_aùive
(
p_num
)

52 if(
p_num
 < 
MAX_OCTEON_ETH_PORTS
)

53  (
oùnic
->
pÜt
[
p_num
].
¡©e
 & 
CVM_NIC_IF_STATE_ACTIVE
);

56 
	}
}

64 
	$äcÜe_´št_lšk_¡©us
(
où_lšk_¡©us_t
 *
¡
, 
pÜt
)

66 
	`´štf
("PÜˆ%d: %d Mbp % du¶ex %s\n", 
pÜt
, 
¡
->
s
.
¥“d
,

67 (
¡
->
s
.
du¶ex
)?"FuÎ":"H®f", (¡->s.
¡©us
)?"UP":"DOWN");

68 
	}
}

77 
ušt64_t


78 
	$äcÜe_upd©e_lšk_¡©us
(
pÜt
)

80 
cvmx_h–³r_lšk_šfo_t
 
lšk
 = 
	`cvmx_h–³r_lšk_autocÚf
(
pÜt
);

81 
où_lšk_¡©us_t
 
¡
;

83 
¡
.
s
.
du¶ex
 = 
lšk
.s.
fuÎ_du¶ex
;

84 
¡
.
s
.
¡©us
 = 
lšk
.s.
lšk_up
;

85 
¡
.
s
.
¥“d
 = 
lšk
.s.speed;

87  
¡
.
u64
;

88 
	}
}

97 
	$äcÜe_chªge_muÉiÿ¡_li¡
(
pÜt
)

99 
cvmx_gmxx_´tx_cfg_t
 
gmx_cfg
;

100 
š‹rçû
 = 
	`INTERFACE
(
pÜt
);

101 
šdex
 = 
	`INDEX
(
pÜt
);

102 
oùÃt_ifæags_t
 
æags
 = 
oùnic
->
pÜt
[pÜt].
ifæags
;

104 
	`´štf
("% pÜt: %d fÏgs: 0x%x\n", 
__FUNCTION__
, 
pÜt
, 
æags
);

106 ià((
š‹rçû
 < 2)

107 && (
	`cvmx_h–³r_š‹rçû_g‘_mode
(
š‹rçû
è!ğ
CVMX_HELPER_INTERFACE_MODE_SPI
)) {

109 
cvmx_gmxx_rxx_adr_ùl_t
 
cÚŒŞ
;

110 
cÚŒŞ
.
u64
 = 0;

111 
cÚŒŞ
.
s
.
bc¡
 = 1;

114 
cÚŒŞ
.
s
.
mc¡
 = 2;

116 ià(
æags
 & 
OCTNET_IFFLAG_PROMISC
)

117 
cÚŒŞ
.
s
.
ÿm_mode
 = 0;

119 
cÚŒŞ
.
s
.
ÿm_mode
 = 1;

121 
gmx_cfg
.
u64
 = 
	`cvmx_»ad_c¤
(
	`CVMX_GMXX_PRTX_CFG
(
šdex
, 
š‹rçû
));

122 
	`cvmx_wr™e_c¤
(
	`CVMX_GMXX_PRTX_CFG
(
šdex
, 
š‹rçû
), 
gmx_cfg
.
u64
 & ~1ull);

124 
	`cvmx_wr™e_c¤
(
	`CVMX_GMXX_RXX_ADR_CTL
(
šdex
, 
š‹rçû
), 
cÚŒŞ
.
u64
);

126 ià(
æags
 & 
OCTNET_IFFLAG_PROMISC
)

127 
	`cvmx_wr™e_c¤
(
	`CVMX_GMXX_RXX_ADR_CAM_EN
(
šdex
, 
š‹rçû
), 0);

129 
	`cvmx_wr™e_c¤
(
	`CVMX_GMXX_RXX_ADR_CAM_EN
(
šdex
, 
š‹rçû
), 1);

131 
	`cvmx_wr™e_c¤
(
	`CVMX_GMXX_PRTX_CFG
(
šdex
, 
š‹rçû
), 
gmx_cfg
.
u64
);

140 
	}
}

147 
	$äcÜe_chªge_mac_add»ss
(
ušt8_t
 *
addr
, 
pÜt
)

149 
ušt8_t
 *
±r
 = (ušt8_ˆ*)
addr
 + 2;

150 
ušt64_t
 
mac
 = 0;

151 
cvmx_gmxx_´tx_cfg_t
 
gmx_cfg
;

152 
i
;

153 
š‹rçû
 = 
	`INTERFACE
(
pÜt
);

154 
šdex
 = 
	`INDEX
(
pÜt
);

157 
i
=0; i < 6; i++) {

158 
mac
 = (mac<<8è| (
ušt64_t
)(
±r
[
i
]);

159 
	`´štf
(" %02x ", 
±r
[
i
]);

161 
	`´štf
("\n");

163 
gmx_cfg
.
u64
 = 
	`cvmx_»ad_c¤
(
	`CVMX_GMXX_PRTX_CFG
(
šdex
, 
š‹rçû
));

165 
	`cvmx_wr™e_c¤
(
	`CVMX_GMXX_PRTX_CFG
(
šdex
, 
š‹rçû
), 
gmx_cfg
.
u64
 & ~1ull);

166 
	`cvmx_wr™e_c¤
(
	`CVMX_GMXX_SMACX
(
šdex
, 
š‹rçû
), 
mac
);

167 
	`cvmx_wr™e_c¤
(
	`CVMX_GMXX_RXX_ADR_CAM0
(
šdex
, 
š‹rçû
), 
±r
[0]);

168 
	`cvmx_wr™e_c¤
(
	`CVMX_GMXX_RXX_ADR_CAM1
(
šdex
, 
š‹rçû
), 
±r
[1]);

169 
	`cvmx_wr™e_c¤
(
	`CVMX_GMXX_RXX_ADR_CAM2
(
šdex
, 
š‹rçû
), 
±r
[2]);

170 
	`cvmx_wr™e_c¤
(
	`CVMX_GMXX_RXX_ADR_CAM3
(
šdex
, 
š‹rçû
), 
±r
[3]);

171 
	`cvmx_wr™e_c¤
(
	`CVMX_GMXX_RXX_ADR_CAM4
(
šdex
, 
š‹rçû
), 
±r
[4]);

172 
	`cvmx_wr™e_c¤
(
	`CVMX_GMXX_RXX_ADR_CAM5
(
šdex
, 
š‹rçû
), 
±r
[5]);

173 
	`cvmx_wr™e_c¤
(
	`CVMX_GMXX_PRTX_CFG
(
šdex
, 
š‹rçû
), 
gmx_cfg
.
u64
);

176 
	}
}

186 
	$äcÜe_chªge_mtu
(
pÜt
, 
Ãw_mtu
)

188 
max_äm_size
 = 
Ãw_mtu
 + 18;

189 
š‹rçû
 = 
	`INTERFACE
(
pÜt
);

190 
šdex
 = 
	`INDEX
(
pÜt
);

194 iàĞ(
max_äm_size
 < 
OCTNET_MIN_FRM_SIZE
)

195 || (
max_äm_size
 > 
OCTNET_MAX_FRM_SIZE
)) {

196 
	`´štf
("MTU mu¡ bb‘w“À%d‡nd %d.\n", 
OCTNET_MIN_FRM_SIZE
 - 18,

197 
OCTNET_MAX_FRM_SIZE
 - 18);

201 ià((
š‹rçû
 < 2è&& (
	`cvmx_h–³r_š‹rçû_g‘_mode
(š‹rçûè!ğ
CVMX_HELPER_INTERFACE_MODE_SPI
)) {

203 ià(
	`OCTEON_IS_MODEL
(
OCTEON_CN3XXX
è|| OCTEON_IS_MODEL(
OCTEON_CN58XX
)) {

205 
	`cvmx_wr™e_c¤
(
	`CVMX_GMXX_RXX_FRM_MAX
(
šdex
, 
š‹rçû
), 
max_äm_size
);

209 
	`cvmx_wr™e_c¤
(
	`CVMX_GMXX_RXX_JABBER
(
šdex
, 
š‹rçû
), (
max_äm_size
 + 7) & ~7u);

210 
	`´štf
("MTU fÜ…Üˆ%d chªgedØ%d\n\n", 
pÜt
, 
Ãw_mtu
);

214 
	}
}

228 
	$äcÜe_´•¬e_lšk_šfo_pkt
(
ušt64_t
 *
buf
)

230 
i
, 
size
 = 0;

231 
où_lšk_šfo_t
 *
lšfo
;

234 if(
oùnic
->
ÅÜts
 == 0)

239 
buf
[0] = 
oùnic
->
ÅÜts
;

241 
lšfo
 = (
où_lšk_šfo_t
 *)&
buf
[1];

243 
i
 = 0; i < 
MAX_OCTEON_ETH_PORTS
; i++) {

244 if(
	`äcÜe_pÜt_aùive
(
i
)) {

245 
lšfo
->
lšk
.
u64
 = 
	`äcÜe_upd©e_lšk_¡©us
(
i
);

246 
lšfo
->
gmxpÜt
 = 
i
;

247 
lšfo
->
pcÜt
 = 
oùnic
->
pÜt
[
i
].linfo.pciport;

248 
lšfo
->
hw_addr
 = 
oùnic
->
pÜt
[
i
].linfo.hw_addr;

249 
lšfo
++;

253 
size
 = (
OCT_LINK_INFO_SIZE
 * 
oùnic
->
ÅÜts
) + 8;

255 
CVMX_SYNCWS
;

256  
size
;

257 
	}
}

267 
	$äcÜe_£nd_lšk_šfo
(
cvmx_wqe_t
 *
wqe
)

269 
cvm_pci_dma_cmd_t
 
cmd
;

270 
cvmx_buf_±r_t
 
ÍŒ
;

271 
cvm_dma_»mÙe_±r_t
 
½Œ
;

272 
cvmx_¿w_š¡_äÚt_t
 
f
;

273 
ušt64_t
 *
buf
;

275 
cmd
.
u64
 = 0;

276 
ÍŒ
.
u64
 = 0;

279 
	`memıy
(&
f
, 
wqe
->
·ck‘_d©a
, (
cvmx_¿w_š¡_äÚt_t
) );

281 
½Œ
.
s
.
addr
 = 
f
.rptr;

282 
½Œ
.
s
.
size
 = 
f
.
œh
.s.
¾’ssz
;

284 if(
	`cvmx_uÆik–y
(
½Œ
.
s
.
size
 > 
CVMX_FPA_WQE_POOL_SIZE
)) {

285 
	`´štf
("[ DRV ] Cannot use WQE…ool buf for sending†ink info\n");

289 
ÍŒ
.
s
.
size
 = 
½Œ
.s.size;

292 
	`cvm_ä“_wqe_·ck‘_bufs
(
wqe
);

295 
buf
 = (
ušt64_t
 *)
wqe
;

298 
	`mem£t
(
buf
, 0, 
½Œ
.
s
.
size
);

300 
ÍŒ
.
s
.
addr
 = 
	`CVM_DRV_GET_PHYS
(
buf
);

304 if(
	`äcÜe_´•¬e_lšk_šfo_pkt
(&
buf
[1]) == 0) {

305 
	`´štf
("[ DRV ]…repare†ink info…kt failed\n");

309 
ÍŒ
.
s
.
i
 = 1;

310 
ÍŒ
.
s
.
poŞ
 = 
CVMX_FPA_WQE_POOL
;

312 
cmd
.
s
.
Æ
 = cmd.s.
Ä
 = 1;

314  
	`cvm_pci_dma_£nd_d©a
(&
cmd
, &
ÍŒ
, &
½Œ
);

315 
	}
}

318 
	$äcÜe_check_lšk_¡©us
()

320 
i
;

321 
où_lšk_¡©us_t
 
lšk
;

323 
i
 = 0 ; i < 
MAX_OCTEON_ETH_PORTS
; i++) {

325 if(!
	`äcÜe_pÜt_aùive
(
i
))

328 
lšk
.
u64
 = 
	`äcÜe_upd©e_lšk_¡©us
(
i
);

330 if(
lšk
.
u64
 !ğ
oùnic
->
pÜt
[
i
].
lšfo
.link.u64) {

332 
oùnic
->
pÜt
[
i
].
lšfo
.
lšk
.
u64
 =†ink.u64;

333 
CVMX_SYNCW
;

335 
	`äcÜe_´št_lšk_¡©us
(&
lšk
, 
i
);

338 
	}
}

341 
	$äcÜe_ÿl_où_¥“d
()

343 
i
;

345 
i
 = 0 ; i < 
MAX_OCTEON_ETH_PORTS
; i++) {

346 if(!
	`äcÜe_pÜt_aùive
(
i
))

348 
oùnic
->
pÜt
[
i
].
¡©s
.
äomho¡
.
Ï¡_tÙ®_rcvd
 =

349 
oùnic
->
pÜt
[
i
].
¡©s
.
äomho¡
.
tÙ®_rcvd
;

350 
oùnic
->
pÜt
[
i
].
¡©s
.
äomho¡
.
Ï¡_tÙ®_by‹s
 =

351 
oùnic
->
pÜt
[
i
].
¡©s
.
äomho¡
.
tÙ®_by‹s
;

352 
oùnic
->
pÜt
[
i
].
¡©s
.
äomwœe
.
Ï¡_tÙ®_rcvd
 =

353 
oùnic
->
pÜt
[
i
].
¡©s
.
äomwœe
.
tÙ®_rcvd
;

354 
oùnic
->
pÜt
[
i
].
¡©s
.
äomwœe
.
Ï¡_tÙ®_by‹s
 =

355 
oùnic
->
pÜt
[
i
].
¡©s
.
äomwœe
.
tÙ®_by‹s
;

357 
	}
}

360 
	$äcÜe_´oûss_nic_cmd
(
cvmx_wqe_t
 *
wqe
)

362 
cvmx_¿w_š¡_äÚt_t
 *
f
 = (cvmx_¿w_š¡_äÚt_ˆ*)
wqe
->
·ck‘_d©a
;

363 
oùÃt_cmd_t
 *
ncmd
;

364 
ušt64_t
 
»ddr
 = 0, 
»t
 = -1ULL;

366 
ncmd
 = (
oùÃt_cmd_t
 *è((
ušt8_t
 *)
f
 + 
CVM_RAW_FRONT_SIZE
);

368 
	`DBG
("NW Commªd…ack‘„eûived (0x%016lx)\n", 
ncmd
->
u64
);

370 
ncmd
->
s
.
cmd
) {

371 
OCTNET_CMD_RX_CTL
:

372 
	`´štf
("Command for RX Control: (Port %d Command: %s)\n",

373 
ncmd
->
s
.
·¿m1
, (ncmd->s.
·¿m2
?"Start":"Stop"));

374 if(
	`äcÜe_pÜt_aùive
(
ncmd
->
s
.
·¿m1
))

375 
oùnic
->
pÜt
[
ncmd
->
s
.
·¿m1
].
rx_Ú
 =‚cmd->s.
·¿m2
;

376 
CVMX_SYNCWS
;

379 
OCTNET_CMD_CHANGE_MTU
:

380 
	`´štf
("Commando change MTU (port %d‚ew_mtu %d)\n",

381 
ncmd
->
s
.
·¿m1
,‚cmd->s.
·¿m2
);

382 
»t
 = 
	`äcÜe_chªge_mtu
(
ncmd
->
s
.
·¿m1
,‚cmd->s.
·¿m2
);

383 if(
f
->
½Œ
)

384 
»ddr
 = 
f
->
½Œ
 + 8;

387 
OCTNET_CMD_CHANGE_MACADDR
:

389 
ušt64_t
 *
maÿddr
;

391 
maÿddr
 = (
ušt64_t
 *)((
ušt8_t
 *)
ncmd
 + (
oùÃt_cmd_t
));

392 
	`´štf
("Commando change MAC Addr (port %d MAC 0x%lx)\n",

393 
ncmd
->
s
.
·¿m1
, *
maÿddr
);

394 
»t
 = 
	`äcÜe_chªge_mac_add»ss
((
ušt8_t
 *)
maÿddr
, 
ncmd
->
s
.
·¿m1
);

395 if(
f
->
½Œ
)

396 
»ddr
 = 
f
->
½Œ
 + 8;

400 
OCTNET_CMD_CHANGE_DEVFLAGS
:

402 
oùÃt_ifæags_t
 
æags
;

403 
pÜt
;

405 
æags
 = (
oùÃt_ifæags_t
)

406 *((
ušt64_t
 *)((
ušt8_t
 *)
ncmd
 + (
oùÃt_cmd_t
)));

407 
pÜt
 = 
ncmd
->
s
.
·¿m1
;

408 ià(
pÜt
 == 0) {

409 
æags
 |ğ
OCTNET_IFFLAG_PROMISC
;

411 
	`´štf
("Commando change Flags (port %d Flags 0x%lx)\n",

412 
pÜt
, ()
æags
);

413 
»t
 = 0;

414 if(
	`äcÜe_pÜt_aùive
(
pÜt
)) {

415 if(
oùnic
->
pÜt
[pÜt].
ifæags
 !ğ
æags
) {

416 
oùnic
->
pÜt
[pÜt].
ifæags
 = 
æags
;

417 
»t
 = 
	`äcÜe_chªge_muÉiÿ¡_li¡
(
pÜt
);

420 if(
f
->
½Œ
)

421 
»ddr
 = 
f
->
½Œ
 + 8;

426 
	`´štf
("UnknowÀNIC Commªd 0x%08x\n", 
ncmd
->
s
.
cmd
);

427 
»ddr
 = 0;

432 if(
»ddr
)

433 
	`cvm_pci_mem_wr™–l
(
»ddr
, 
»t
);

435 
	`cvm_ä“_ho¡_š¡r
(
wqe
);

436 
	}
}

438 
ušt64_t
 
	$äcÜe_g‘timeofday
()

440 
ušt64_t
 
cyşe
;

441 
cyşe
 = 
	`cvmx_g‘_cyşe
();

443  
cyşe
;

444 
	}
}

446 
	$äcÜe_¦“p
(
ušt64_t
 
cyşe
)

448 
ušt64_t
 
¡¬t_cyşe
, 
cur_cyşe
;

450 
¡¬t_cyşe
 = 
	`cvmx_g‘_cyşe
();

453 
cur_cyşe
 = 
	`cvmx_g‘_cyşe
();

454 ià((
cur_cyşe
 - 
¡¬t_cyşe
è>ğ
cyşe
)

459 
	}
}

462 
	$äcÜe_dump_±rs
(
cvmx_buf_±r_t
 *
±r
, 
numbufs
)

464 
i
, 
tÙ®
=0;

465 
cvmx_buf_±r_t
 *
Ãxt
;

467 
i
 = 0; i < 
numbufs
; i++) {

468 
Ãxt
 = (
cvmx_buf_±r_t
 *)
	`CVM_DRV_GET_PTR
(
±r
->
s
.
addr
 - 8);

469 
	`´štf
("±r[%d]: 0x%016Îx size: %d…oŞ %d\n", 
i
, 
	`CAST64
(
±r
->
s
.
addr
),

470 
±r
->
s
.
size
,…Œ->s.
poŞ
);

471 
tÙ®
 +ğ
±r
->
s
.
size
;

472 
±r
 = 
Ãxt
;

475 
	`´štf
("TÙ® By‹s: %d\n", 
tÙ®
);

476 
	}
}

	@frcore/frcore.h

26 #iâdeà
__FRCORE_H__


27 
	#__FRCORE_H__


	)

29 
	~<¡dio.h
>

30 
	~<¡ršg.h
>

32 
	~"cvmx-cÚfig.h
"

33 
	~"cvmx.h
"

34 
	~"cvmx-sw­.h
"

35 
	~"cvmx-sysšfo.h
"

37 
	~"cvm-driv”-defs.h
"

38 
	~"cvm-drv.h
"

39 
	~"cvm-drv-debug.h
"

40 
	~"oùeÚ-nic-commÚ.h
"

41 
	~"oùeÚ-İcodes.h
"

43 
	~"äc.h
"

45 
	~"äcÜe_defs.h
"

46 
	~"äcÜe_debug.h
"

47 
	~"äcÜe_cÚfig.h
"

51 
	#MAX_OCTEON_ETH_PORTS
 32

	)

53 
	#CVM_NIC_IF_STATE_INACTIVE
 0

	)

54 
	#CVM_NIC_IF_STATE_ACTIVE
 1

	)

67 
	snic_¡©s_t
 {

69 
št64_t
 
	mtÙ®_wqe
;

71 
št64_t
 
	mtÙ®_rcvd
;

72 
št64_t
 
	mtÙ®_by‹s
;

73 
št64_t
 
	mÏ¡_tÙ®_rcvd
;

74 
št64_t
 
	mÏ¡_tÙ®_by‹s
;

75 
št64_t
 
	mtÙ®_‹¡
;

77 
št64_t
 
	mtÙ®_fwd
;

79 
št64_t
 
	m”r_pko
;

81 
št64_t
 
	m”r_lšk
;

83 
št64_t
 
	m”r_drİ
;

93 
nic_¡©s_t
 
	mäomwœe
;

94 
nic_¡©s_t
 
	mäomho¡
;

96 } 
	toù_lšk_¡©s_t
;

98 
	#OCT_LINK_STATS_SIZE
 ((
où_lšk_¡©s_t
))

	)

104 
ušt64_t
 
	m¡©e
:8;

105 
ušt64_t
 
	mifidx
:8;

106 
ušt64_t
 
	m´e£Á
:8;

107 
ušt64_t
 
	mrx_Ú
:8;

108 
ušt64_t
 
	mifæags
:16;

109 
ušt64_t
 
	mrsvd
:16;

111 
où_lšk_šfo_t
 
	mlšfo
;

113 
où_lšk_¡©s_t
 
	m¡©s
;

115 } 
	toùnic_pÜt_šfo_t
;

122 
ušt64_t
 
	mbßrd_ty³
:16;

123 
ušt64_t
 
	mÅÜts
:16;

124 
ušt64_t
 
	mnumpciqs
:8;

125 
ušt64_t
 
	mrsvd
:24;

126 
ušt64_t
 
	mmaÿddrba£
;

128 
oùnic_pÜt_šfo_t
 
	mpÜt
[
MAX_OCTEON_ETH_PORTS
];

131 } 
	toùnic_dev_t
;

135 
CVMX_SHARED
 
oùnic_dev_t
 *
oùnic
;

138 
	#COREMASK_BOOT
 
	`cvmx_cÜemask_cÜe
(0è

	)

139 
	#INTERFACE
(
pÜt
èÕÜˆ>> 4)

	)

141 
	#INDEX
(
pÜt
èÕÜˆ& 0xf)

	)

144 
šlše
 
ušt64_t


145 
	$äcÜe_mac_to_64b™
(
ušt8_t
 *
mac
)

147 
ušt64_t
 
maÿddr
=0;

148 
i
;

149 
i
 = 0; i < 6; i++)

150 
maÿddr
 = (maÿdd¸<< 8è| 
mac
[
i
];

151  
maÿddr
;

152 
	}
}

156 
	#NUMBER_OUTPUT_QUEUES
 8

	)

160 
	#GET_QUEUE
(
a
è(× < 4è?‡ :‡-12)

	)

164 
äcÜe_pÜt_aùive
(
p_num
);

169 
äcÜe_£nd_lšk_šfo
(
cvmx_wqe_t
 *
wqe
);

172 
äcÜe_check_lšk_¡©us
();

175 
äcÜe_ÿl_où_¥“d
();

178 
äcÜe_chªge_muÉiÿ¡_li¡
(
pÜt
);

182 
äcÜe_chªge_mac_add»ss
(
ušt8_t
 *
addr
, 
pÜt
);

186 
äcÜe_´oûss_nic_cmd
(
cvmx_wqe_t
 *
wqe
);

190 
äcÜe_£tup_š‹rçûs
();

196 
äcÜe_´oûss_äc_cmd
(
cvmx_wqe_t
 *
wqe
);

199 
ušt64_t
 
äcÜe_g‘timeofday
();

201 
	#äcÜe_memıy
 
memıy


	)

203 
äcÜe_¦“p
(
ušt64_t
 
cyşe
);

205 
	#PREPROC_STAGING
 ((
ušt32_t
)(0x01<<28))

	)

206 
	#SESSION_STAGING
 ((
ušt32_t
)(0x02<<28))

	)

207 
	#CONTROL_STAGING
 ((
ušt32_t
)(0x03<<28))

	)

209 
	#STAGING_MASK
 ((
ušt32_t
)(0xff<<28))

	)

211 
	#¡agšg_g
(
x
, 
y
è((x)|(y))

	)

212 
	#g_is_¡agšg
(
x
, 
y
è(((x)&
STAGING_MASK
è=ğ(y))

	)

215 
	smµ_tu¶e
{

218 
ušt32_t
 
	ms
, 
	md
;

219 
ušt16_t
 
	m¥
, 
	mdp
;

220 
ušt8_t
 
	m´Ùo
;

221 
ušt8_t
 
	m£ssiÚ_ty³
:3;

222 
ušt8_t
 
	mif
:5;

223 
ušt16_t
 
	mrsv
;

225 
ušt64_t
 
	md©a
[2];

226 
ušt32_t
 
	md©a_32
[4];

234 
	smµ_cÚŒŞ
{

236 
ušt8_t
 *
	m·ck‘
;

238 
ušt8_t
 
	mif
;

239 
ušt8_t
 
	mËn_h—d”
;

240 
št16_t
 
	m»v0
;

241 
	#SSN_INDEX_INVALID
 0xffffffff

	)

242 
ušt32_t
 
	ms¢_šdex
;

245 
mµ_s¢
 *
	ms¢
;

248 
udphdr
 *
	mudph
;

251 
ušt8_t
 
	m£ssiÚ_ty³
;

252 
ušt8_t
 
	mvÏn_aù
;

253 
	#MPP_VLAN_DO_NOTHING
 0xe0

	)

254 
	#MPP_VLAN_ADD
 0xc0

	)

255 
	#MPP_VLAN_DEL
 0xa0

	)

256 
	#MPP_VLAN_TAG_MASK
 0x1f

	)

257 
ušt8_t
 
	mmœrif
;

258 
ušt8_t
 
	mif
;

259 
št32_t
 
	mdu¶_num
;

263 
ušt32_t
 
	msvr_£q
;

264 
ušt32_t
 
	msyn_cook›
;

267 
ušt32_t
 
	mg
;

268 
št32_t
 
	m»v
;

272 
äcÜe_fÜw¬d_·ck‘_to_wœe
(
cvmx_wqe_t
 *
wqe
, 
p_num
, 
ofæßd
);

273 
äcÜe_dump_±rs
(
cvmx_buf_±r_t
 *
±r
, 
numbufs
);

	@frcore/frcore_acl.c

2 
	~<¡dio.h
>

3 
	~<¡ršg.h
>

4 
	~<¡dlib.h
>

5 
	~<¡dšt.h
>

6 
	~<¡ddef.h
>

8 
	~<cvmx.h
>

9 
	~<cvmx-©omic.h
>

10 
	~"äcÜe_aş.h
"

11 
	~"äc_ty³s.h
"

12 
	~"äcÜe_aş.h
"

14 
	#FILTERFIRST
 0

	)

15 #iâdeà
FRCORE_ACL_API_INTERFACE


16 
	$g‘f‘”
(
ušt8_t
 
gid
, 
ušt16_t
 
ruËid
, *
s
, *
d
, *
¥
, *
dp
, *
´ÙocŞ
)

18 
FILTSET
 *
ft£t
 = &
gsd©a
.
aş
->
aş_d©a
[
gid
].filtset;

19 
	`¥rštf
(
s
, "%u.%u.%u.%u - %u.%u.%u.%u",

20 (
ft£t
->
ftA¼
[
ruËid
].
dim
[0][0] >> 8) & 0xFF,

21 
ft£t
->
ftA¼
[
ruËid
].
dim
[0][0] & 0xFF,

22 (
ft£t
->
ftA¼
[
ruËid
].
dim
[1][0] >> 8) & 0xFF,

23 
ft£t
->
ftA¼
[
ruËid
].
dim
[1][0] & 0xFF,

24 (
ft£t
->
ftA¼
[
ruËid
].
dim
[0][1] >> 8) & 0xFF,

25 
ft£t
->
ftA¼
[
ruËid
].
dim
[0][1] & 0xFF,

26 (
ft£t
->
ftA¼
[
ruËid
].
dim
[1][1] >> 8) & 0xFF,

27 
ft£t
->
ftA¼
[
ruËid
].
dim
[1][1] & 0xFF);

28 
	`¥rštf
(
d
, "%u.%u.%u.%u - %u.%u.%u.%u",

29 (
ft£t
->
ftA¼
[
ruËid
].
dim
[2][0] >> 8) & 0xFF,

30 
ft£t
->
ftA¼
[
ruËid
].
dim
[2][0] & 0xFF,

31 (
ft£t
->
ftA¼
[
ruËid
].
dim
[3][0] >> 8) & 0xFF,

32 
ft£t
->
ftA¼
[
ruËid
].
dim
[3][0] & 0xFF,

33 (
ft£t
->
ftA¼
[
ruËid
].
dim
[2][1] >> 8) & 0xFF,

34 
ft£t
->
ftA¼
[
ruËid
].
dim
[2][1] & 0xFF,

35 (
ft£t
->
ftA¼
[
ruËid
].
dim
[3][1] >> 8) & 0xFF,

36 
ft£t
->
ftA¼
[
ruËid
].
dim
[3][1] & 0xFF);

38 if(
ft£t
->
ftA¼
[
ruËid
].
dim
[4][0] == filtset->filtArr[ruleid].dim[4][1])

39 
	`¥rštf
(
¥
, "%u", 
ft£t
->
ftA¼
[
ruËid
].
dim
[4][0]);

41 
	`¥rštf
(
¥
, "%u-%u", 
ft£t
->
ftA¼
[
ruËid
].
dim
[4][0], filtset->filtArr[ruleid].dim[4][1]);

43 if(
ft£t
->
ftA¼
[
ruËid
].
dim
[5][0] == filtset->filtArr[ruleid].dim[5][1])

44 
	`¥rštf
(
dp
, "%u", 
ft£t
->
ftA¼
[
ruËid
].
dim
[5][0]);

46 
	`¥rštf
(
dp
, "%u-%u", 
ft£t
->
ftA¼
[
ruËid
].
dim
[5][0], filtset->filtArr[ruleid].dim[5][1]);

48 
ft£t
->
ftA¼
[
ruËid
].
dim
[6][0]){

49 
ACL_PROTOCOL_UDP
:

50 
	`¥rštf
(
´ÙocŞ
 , "%s", "udp");

52 
ACL_PROTOCOL_TCP
:

53 
	`¥rštf
(
´ÙocŞ
 , "%s", "tcp");

55 
ACL_PROTOCOL_ANY
:

56 
	`¥rštf
(
´ÙocŞ
 , "%s", "any");

59 
	`¥rštf
(
´ÙocŞ
 , "%s", "any");

63 
	}
}

65 
	$g‘f‘”
(
ušt8_t
 
gid
, 
ušt16_t
 
ruËid
,

66 
ušt32_t
 *
s
, ušt32_ˆ*
d
, 
ušt16_t
 *
¥
, ušt16_ˆ*
dp
, ušt16_ˆ*
´ÙocŞ
)

68 
FILTSET
 *
ft£t
 = &
gsd©a
.
aş
->
aş_d©a
[
gid
].filtset;

69 
ušt32_t
 

;

70 
ušt16_t
 
pÜt
, 
´Ùo
;

72 

 = ((
ft£t
->
ftA¼
[
ruËid
].
dim
[0][0] << 16) & 0xFFFF0000) |

73 ((
ft£t
->
ftA¼
[
ruËid
].
dim
[1][0] ) & 0x0000FFFF);

74 *
s
 = 

;

76 

 = ((
ft£t
->
ftA¼
[
ruËid
].
dim
[2][0] << 16) & 0xFFFF0000) |

77 ((
ft£t
->
ftA¼
[
ruËid
].
dim
[3][0] ) & 0x0000FFFF);

78 *
d
 = 

;

80 
pÜt
 = (
ft£t
->
ftA¼
[
ruËid
].
dim
[4][0] ) & 0x0000FFFF;

81 *
¥
 = 
pÜt
;

83 
pÜt
 = (
ft£t
->
ftA¼
[
ruËid
].
dim
[5][0] ) & 0x0000FFFF;

84 *
dp
 = 
pÜt
;

86 
´Ùo
 = (
ft£t
->
ftA¼
[
ruËid
].
dim
[6][0] ) & 0x0000FFFF;

87 *
´ÙocŞ
 = 
´Ùo
;

88 
	}
}

90 
	$aş_G‘OÃF‹r_Cmd
(
ušt8_t
 
gid
, 
ušt16_t
 
ruËid
, *
s
, *
d
, *
¥
, *
dp
, *
´ÙocŞ
)

92 
ušt8_t
 
smask
 = 32, 
dmask
 = 32;

93 
i
 = 0;

94 
ušt64_t
 
šdex
 = 1;

95 
FILTSET
 *
ft£t
 = &
gsd©a
.
aş
->
aş_d©a
[
gid
].filtset;

97 
ušt32_t
 
tmp
 = 
ft£t
->
ftA¼
[
ruËid
].
dim
[0][1] * 65536 + filtset->filtArr[ruleid].dim[1][1] - (filtset->filtArr[ruleid].dim[0][0] * 65536 + filtset->filtArr[ruleid].dim[1][0]);

98 
i
 = 0; i <= 32; i++){

99 if(
tmp
 =ğ((
šdex
 << 
i
) - 1)){

100 
smask
 = 32 -
i
;

104 
	`¥rštf
(
s
, "%u.%u.%u.%u/%u",

105 (
ft£t
->
ftA¼
[
ruËid
].
dim
[0][0] >> 8) & 0xFF,

106 
ft£t
->
ftA¼
[
ruËid
].
dim
[0][0] & 0xFF,

107 (
ft£t
->
ftA¼
[
ruËid
].
dim
[1][0] >> 8) & 0xFF,

108 
ft£t
->
ftA¼
[
ruËid
].
dim
[1][0] & 0xFF, 
smask
);

110 
tmp
 = 
ft£t
->
ftA¼
[
ruËid
].
dim
[2][1] * 65536 + filtset->filtArr[ruleid].dim[3][1] - (filtset->filtArr[ruleid].dim[2][0] * 65536 + filtset->filtArr[ruleid].dim[3][0]);

111 
i
 = 0; i <= 32; i++){

112 if(
tmp
 =ğ((
šdex
 << 
i
) - 1)){

113 
dmask
 = 32 -
i
;

117 
	`¥rštf
(
d
, "%u.%u.%u.%u/%u",

118 (
ft£t
->
ftA¼
[
ruËid
].
dim
[2][0] >> 8) & 0xFF,

119 
ft£t
->
ftA¼
[
ruËid
].
dim
[2][0] & 0xFF,

120 (
ft£t
->
ftA¼
[
ruËid
].
dim
[3][0] >> 8) & 0xFF,

121 
ft£t
->
ftA¼
[
ruËid
].
dim
[3][0] & 0xFF, 
dmask
);

123 if(
ft£t
->
ftA¼
[
ruËid
].
dim
[4][0] == filtset->filtArr[ruleid].dim[4][1])

124 
	`¥rštf
(
¥
, "%u", 
ft£t
->
ftA¼
[
ruËid
].
dim
[4][0]);

126 
	`¥rštf
(
¥
, "%u-%u", 
ft£t
->
ftA¼
[
ruËid
].
dim
[4][0], filtset->filtArr[ruleid].dim[4][1]);

128 if(
ft£t
->
ftA¼
[
ruËid
].
dim
[5][0] == filtset->filtArr[ruleid].dim[5][1])

129 
	`¥rštf
(
dp
, "%u", 
ft£t
->
ftA¼
[
ruËid
].
dim
[5][0]);

131 
	`¥rštf
(
dp
, "%u-%u", 
ft£t
->
ftA¼
[
ruËid
].
dim
[5][0], filtset->filtArr[ruleid].dim[5][1]);

133 
ft£t
->
ftA¼
[
ruËid
].
dim
[6][0]){

134 
ACL_PROTOCOL_UDP
:

135 
	`¥rštf
(
´ÙocŞ
 , "%s", "udp");

137 
ACL_PROTOCOL_TCP
:

138 
	`¥rštf
(
´ÙocŞ
 , "%s", "tcp");

140 
ACL_PROTOCOL_ANY
:

141 
	`¥rštf
(
´ÙocŞ
 , "%s", "any");

144 
	`¥rštf
(
´ÙocŞ
 , "%s", "any");

148 
	}
}

149 
	$sw­_ft_¡©i¡ics
(
FILTSET
 * 
ft£t
, 
¡ag_id
, 
dg_id
)

151 
ušt64_t
 
tmp
;

152 
tmp
 = 
ft£t
->
pkt_num
[
¡ag_id
];

153 
ft£t
->
pkt_num
[
¡ag_id
] = ft£t->pkt_num[
dg_id
];

154 
ft£t
->
pkt_num
[
dg_id
] = 
tmp
;

155 
	}
}

156 
ušt16_t
 
	$aş_g‘f‹r_couÁ
(
ušt8_t
 
gid
)

158 
FILTSET
 *
ft£t
 = &
gsd©a
.
aş
->
aş_d©a
[
gid
].filtset;

159  
ft£t
->
numF‹rs
;

160 
	}
}

161 
ušt8_t
 
	$aş_g‘f‹r_¡©e
(
ušt8_t
 
gid
, 
ušt16_t
 
rg‘id
)

163 
FILTSET
 *
ft£t
 = &
gsd©a
.
aş
->
aş_d©a
[
gid
].filtset;

164 
i
, 
couÁ
 = 
ft£t
->
numF‹rs
;

165 
i
 = 0; i < 
couÁ
; i++){

166 if(
rg‘id
 =ğ
ft£t
->
ftA¼
[
i
].
co¡
)

167  
ft£t
->
ftA¼
[
i
].
¡©e
;

169  
ACL_UNSET
;

170 
	}
}

171 
	$aş_g‘f‹r_ruËid_by_gid
(
ušt8_t
 
gid
, 
ušt16_t
 
gid
)

173 
FILTSET
 *
ft£t
 = &
gsd©a
.
aş
->
aş_d©a
[
gid
].filtset;

174 
i
, 
couÁ
 = 
ft£t
->
numF‹rs
;

175 
i
 = 0; i < 
couÁ
; i++){

176 if(
gid
 =ğ
ft£t
->
ftA¼
[
i
].
co¡
)

177  
i
;

179  
MC_ERROR
;

180 
	}
}

181 
šlše
 
ušt16_t
 
	$aş_g‘_gid_by_ruËid
(
ušt8_t
 
aşgid
, 
ušt16_t
 
ruËid
)

183  
gsd©a
.
aş
->
aş_d©a
[
aşgid
].
ft£t
.
ftA¼
[
ruËid
].
co¡
;

184 
	}
}

185 
ušt8_t
 
	$aş_’abË_Úe_f‹r_by_gid
(
ušt8_t
 
gid
, 
ušt16_t
 
rg‘id
, ušt8_ˆ
’abË
)

187 
FILTSET
 *
ft£t
 = &
gsd©a
.
aş
->
aş_d©a
[
gid
].filtset;

188 
i
, 
couÁ
 = 
ft£t
->
numF‹rs
;

189 
i
 = 0; i < 
couÁ
; i++){

190 if(
rg‘id
 =ğ
ft£t
->
ftA¼
[
i
].
co¡
){

191 
ft£t
->
ftA¼
[
i
].
¡©e
 = 
’abË
;

196 
	}
}

197 
ušt8_t
 
	$aş_’abË_®l_f‹r
(
ušt8_t
 
gid
, ušt8_ˆ
’abË
)

199 
FILTSET
 *
ft£t
 = &
gsd©a
.
aş
->
aş_d©a
[
gid
].filtset;

200 
i
, 
couÁ
 = 
ft£t
->
numF‹rs
;

201 
i
 = 0; i < 
couÁ
; i++){

202 
ft£t
->
ftA¼
[
i
].
¡©e
 = 
’abË
;

205 
	}
}

207 #iâdeà
FRCORE_ACL_API_INTERFACE


208 
	$aş_g‘f‹r_by_ruËid
(
ušt8_t
 
gid
, 
ušt16_t
 
ruËid
, 
isdump
, ušt16_ˆ*
gid
, ušt8_ˆ*
¡©e
, ušt8_ˆ*
sync
, *
s
, *
d
, *
¥
, *
dp
, *
´ÙocŞ
){

209 
FILTSET
 *
ft£t
 = &
gsd©a
.
aş
->
aş_d©a
[
gid
].filtset;

212 if(
ACL_UNSET
 =ğ
ft£t
->
ftA¼
[
ruËid
].
¡©e
)

215 *
gid
 = 
ft£t
->
ftA¼
[
ruËid
].
co¡
;

216 *
¡©e
 = 
ft£t
->
ftA¼
[
ruËid
].state;

217 *
sync
 = 
ft£t
->
ftA¼
[
ruËid
].sync;

218 if(
isdump
)

219 
	`aş_G‘OÃF‹r_Cmd
(
gid
, 
ruËid
, 
s
, 
d
, 
¥
, 
dp
, 
´ÙocŞ
);

221 
	`g‘f‘”
(
gid
, 
ruËid
, 
s
, 
d
, 
¥
, 
dp
, 
´ÙocŞ
);

224 
	}
}

225 
	$aş_g‘f‹r_by_gid
(
ušt8_t
 
gid
, 
ušt16_t
 
gid
, ušt16_ˆ*
ruËnum
,ušt8_ˆ*
¡©e
, ušt8_ˆ*
sync
,

226 *
s
, *
d
, *
¥
, *
dp
, *
´ÙocŞ
)

228 
FILTSET
 *
ft£t
 = &
gsd©a
.
aş
->
aş_d©a
[
gid
].filtset;

229 
i
, 
couÁ
 = 
ft£t
->
numF‹rs
;

230 
ruËid
 = -1;

231 
i
 = 0; i < 
couÁ
; i++){

232 if(
gid
 =ğ
ft£t
->
ftA¼
[
i
].
co¡
){

233 
ruËid
 = 
i
;

237 if(-1 =ğ
ruËid
)

240 *
ruËnum
 = 
ruËid
;

241 *
¡©e
 = 
ft£t
->
ftA¼
[
ruËid
].state;

242 *
sync
 = 
ft£t
->
ftA¼
[
ruËid
].sync;

243 
	`g‘f‘”
(
gid
, 
ruËid
, 
s
, 
d
, 
¥
, 
dp
, 
´ÙocŞ
);

245 
	}
}

247 
	$aş_g‘f‹r_by_gid
(
ušt8_t
 
gid
, 
ušt16_t
 
gid
, ušt16_ˆ*
ruËnum
,ušt8_ˆ*
¡©e
, ušt8_ˆ*
sync
,

248 
ušt32_t
 *
s
, ušt32_ˆ*
d
, 
ušt16_t
 *
¥
, ušt16_ˆ*
dp
, ušt16_ˆ*
´ÙocŞ
,

249 
ušt32_t
 *
pkts
, ušt32_ˆ*
by‹s
, 
ušt16_t
 *
İ
, ušt16_ˆ*
aùiÚ
, ušt16_ˆ*
ruË_ty³
,

250 
ušt16_t
 *
ruË_sourû
)

252 
FILTSET
 *
ft£t
 = &
gsd©a
.
aş
->
aş_d©a
[
gid
].filtset;

253 
i
, 
couÁ
 = 
ft£t
->
numF‹rs
;

254 
ruËid
 = -1;

255 
i
 = 0; i < 
couÁ
; i++){

256 if(
gid
 =ğ
ft£t
->
ftA¼
[
i
].
co¡
){

257 
ruËid
 = 
i
;

261 if(-1 =ğ
ruËid
)

262  
FRE_FAIL
;

264 *
ruËnum
 = 
ruËid
;

265 *
¡©e
 = 
ft£t
->
ftA¼
[
ruËid
].state;

266 *
sync
 = 
ft£t
->
ftA¼
[
ruËid
].sync;

267 *
İ
 = 
ft£t
->
ftA¼
[
ruËid
].op;

268 *
aùiÚ
 = 
ft£t
->
ftA¼
[
ruËid
].action;

269 *
ruË_ty³
 = 
ft£t
->
ftA¼
[
ruËid
].rule_type;

270 *
ruË_sourû
 = 
ft£t
->
ftA¼
[
ruËid
].rule_source;

271 *
pkts
 = 
	`aş_g‘_¡©i¡ic_h™
(0, 
gid
);

272 *
by‹s
 = 
	`aş_g‘_pkt_by‹s
(0, 
gid
);

273 
	`g‘f‘”
(
gid
, 
ruËid
, 
s
, 
d
, 
¥
, 
dp
, 
´ÙocŞ
);

274  
FRE_SUCCESS
;

275 
	}
}

277 
	$aş_š™f‹r_¡©i¡ics_by_gid
(
ušt8_t
 
gid
, 
ušt16_t
 
gid
)

279 
	`aş_š™_¡©i¡ic_h™
(
gid
, 
gid
);

280 
	`aş_š™_pkt_by‹s
(
gid
, 
gid
);

281 
	}
}

284 
	$move_FÜw¬d_F‹r_äom_šdex
(
ušt8_t
 
gid
, 
šdex
)

286 
FILTSET
 *
ft£t
 = &
gsd©a
.
aş
->
aş_d©a
[
gid
].filtset;

287 
j
, 
m
, 
couÁ
 = 
ft£t
->
numF‹rs
;

288 
j
 = 
šdex
; j < 
couÁ
 - 1; j++){

289 
ft£t
->
ftA¼
[
j
].
¡©e
 = filtset->filtArr[j+1].state;

290 
ft£t
->
ftA¼
[
j
].
sync
 = filtset->filtArr[j+1].sync;

291 
ft£t
->
pkt_num
[ft£t->
ftA¼
[
j
].
co¡
] = filtset->pkt_num[filtset->filtArr[j+1].cost];

292 
ft£t
->
pkt_by‹s
[ft£t->
ftA¼
[
j
].
co¡
] = filtset->pkt_bytes[filtset->filtArr[j+1].cost];

294 
ft£t
->
ftA¼
[
j
].
co¡
 = filtset->filtArr[j+1].cost;

295 
ft£t
->
ftA¼
[
j
].
İ
 = filtset->filtArr[j+1].op;

296 
ft£t
->
ftA¼
[
j
].
aùiÚ
 = filtset->filtArr[j+1].action;

297 
ft£t
->
ftA¼
[
j
].
ruË_ty³
 = filtset->filtArr[j+1].rule_type;

298 
ft£t
->
ftA¼
[
j
].
ruË_sourû
 = filtset->filtArr[j+1].rule_source;

299 
m
 = 0; m < 7; m++){

300 
ft£t
->
ftA¼
[
j
].
dim
[
m
][0] = filtset->filtArr[j+1].dim[m][0];

301 
ft£t
->
ftA¼
[
j
].
dim
[
m
][1] = filtset->filtArr[j+1].dim[m][1];

304 
	`aş_š™OÃF‹r_by_šdex
(
gid
, 
couÁ
 - 1);

307 
	}
}

308 
	$move_Back_F‹r_äom_šdex
(
ušt8_t
 
gid
, 
šdex
)

310 
FILTSET
 *
ft£t
 = &
gsd©a
.
aş
->
aş_d©a
[
gid
].filtset;

311 
j
, 
m
, 
couÁ
 = 
ft£t
->
numF‹rs
;

312 
j
 = 
couÁ
 - 1; j >ğ
šdex
; j--){

313 
ft£t
->
ftA¼
[
j
 + 1].
¡©e
 = filtset->filtArr[j].state;

314 
ft£t
->
ftA¼
[
j
 + 1].
sync
 = filtset->filtArr[j].sync;

315 
ft£t
->
ftA¼
[
j
 + 1].
İ
 = filtset->filtArr[j].op;

316 
ft£t
->
ftA¼
[
j
 + 1].
aùiÚ
 = filtset->filtArr[j].action;

317 
ft£t
->
ftA¼
[
j
 + 1].
ruË_ty³
 = filtset->filtArr[j].rule_type;

318 
ft£t
->
ftA¼
[
j
 + 1].
ruË_sourû
 = filtset->filtArr[j].rule_source;

320 
ft£t
->
pkt_num
[ft£t->
ftA¼
[
j
+1].
co¡
] = filtset->pkt_num[filtset->filtArr[j].cost];

321 
ft£t
->
pkt_by‹s
[ft£t->
ftA¼
[
j
+1].
co¡
] = filtset->pkt_bytes[filtset->filtArr[j].cost];

322 
ft£t
->
ftA¼
[
j
 + 1].
co¡
 = filtset->filtArr[j].cost;

323 
m
 = 0; m < 7; m++){

324 
ft£t
->
ftA¼
[
j
 + 1].
dim
[
m
][0] = filtset->filtArr[j].dim[m][0];

325 
ft£t
->
ftA¼
[
j
 + 1].
dim
[
m
][1] = filtset->filtArr[j].dim[m][1];

329 
	}
}

330 
	$aş_š™OÃF‹r_by_šdex
(
ušt8_t
 
gid
, 
šdex
)

332 
FILTSET
 *
ft£t
 = &
gsd©a
.
aş
->
aş_d©a
[
gid
].filtset;

333 
m
 = 0;

334 
ft£t
->
ftA¼
[
šdex
].
¡©e
 = 
ACL_UNSET
;

335 
ft£t
->
ftA¼
[
šdex
].
sync
 = 
ACL_NOSYNC
;

336 
ft£t
->
pkt_num
[ft£t->
ftA¼
[
šdex
].
co¡
] = 0;

337 
ft£t
->
pkt_by‹s
[ft£t->
ftA¼
[
šdex
].
co¡
] = 0;

338 
ft£t
->
ftA¼
[
šdex
].
co¡
 = 0;

339 
ft£t
->
ftA¼
[
šdex
].
İ
 = 0;

340 
ft£t
->
ftA¼
[
šdex
].
aùiÚ
 = 0;

341 
ft£t
->
ftA¼
[
šdex
].
ruË_ty³
 = 0;

342 
ft£t
->
ftA¼
[
šdex
].
ruË_sourû
 = 0;

344 
m
 = 0; m < 7; m++){

345 
ft£t
->
ftA¼
[
šdex
].
dim
[
m
][0] = 0;

346 
ft£t
->
ftA¼
[
šdex
].
dim
[
m
][1] = 0;

350 
	}
}

352 
	$aş_š™_Úe_buck‘
(
gid
, 
šdex
)

354 
i
=0;

355 
gsd©a
.
aş
->
aş_
[
gid
].
¤c_út
[
šdex
]=0;

356 
gsd©a
.
aş
->
aş_
[
gid
].
de¡_út
[
šdex
]=0;

357 
gsd©a
.
aş
->
aş_
[
gid
].
g
[
šdex
]=0;

358 
gsd©a
.
aş
->
aş_
[
gid
].
æag
[
šdex
]=0;

360 
i
=0; i<
MAX_ACL_IP_HASH_BUCKET_LEN
; i++) {

361 
gsd©a
.
aş
->
aş_
[
gid
].
¤c
[
šdex
][
i
].
d©a
=0;

362 
gsd©a
.
aş
->
aş_
[
gid
].
de¡
[
šdex
][
i
].
d©a
=0;

364 
	}
}

366 
	$aş_š™_Úe_aş_sm
(
gid
, 
gid
)

368 
couÁ
 = 
gsd©a
.
aş
->
aş_sm
[
gid
][
gid
].count;

369 
gsd©a
.
aş
->
aş_sm
[
gid
][
gid
].
couÁ
 = 0;

370 
couÁ
--){

371 
gsd©a
.
aş
->
aş_sm
[
gid
][
gid
].
sm
[
couÁ
] = 
MPP_ACL_SM_DEFAULT_VALUE
;

373 
	}
}

374 
	$aş_š™
()

376 
i
, 
j
, 
gid
, 
gid
;

377 
i
 = 0; i < 
MPP_MAX_ACL_NUM
; i++){

378 
j
 = 0; j < 
MPP_MAX_FILTERS
; j++){

379 
	`aş_š™_Úe_aş_sm
(
i
, 
j
);

381 
j
 = 0; j < 
MAX_ACL_IP_NUM
; j++){

382 
	`aş_š™_Úe_buck‘
(
i
, 
j
);

384 
	`aş_š™OÃF‹r_by_šdex
(
i
, 
MPP_MAX_FILTERS
 - 1);

387 
gid
 = 0; gid < 
MPP_MAX_ACL_NUM
; gid++){

388 
gid
 = 0;agid < 
MPP_MAX_FILTERS
;agid++){

389 
	`aş_D–‘eOÃF‹r_by_gid
(
gid
, 
gid
);

391 
gid
=0;agid<
MAX_ACL_IP_NUM
;agid++){

392 
	`mµ_d–_
(
gid
,
gid
);

395 
	}
}

397 
	$aş_D–‘eOÃF‹r_by_gid
(
ušt8_t
 
gid
, 
ušt16_t
 
gid
)

399 
FILTSET
 *
ft£t
 = &
gsd©a
.
aş
->
aş_d©a
[
gid
].filtset;

400 
i
, 
couÁ
 = 
ft£t
->
numF‹rs
;

401 
i
 = 0; i < 
couÁ
; i++){

402 if(
gid
 =ğ
ft£t
->
ftA¼
[
i
].
co¡
){

403 if(
i
 =ğ
couÁ
 -1)

404 
	`aş_š™OÃF‹r_by_šdex
(
gid
, 
i
);

406 
	`move_FÜw¬d_F‹r_äom_šdex
(
gid
, 
i
);

407 
ft£t
->
numF‹rs
--;

408  
FRE_SUCCESS
;

411  
FRE_NOTFOUND
;

412 
	}
}

413 
	$cİy_Úe_f‹r
(
FILTER
 *
ft
, 
gid
, 
šdex
){

414 
FILTSET
 *
ft£t
 = &
gsd©a
.
aş
->
aş_d©a
[
gid
].filtset;

415 
m
;

417 
ft
->
¡©e
 = 
ft£t
->
ftA¼
[
šdex
].state;

418 
ft
->
sync
 = 
ft£t
->
ftA¼
[
šdex
].sync;

420 
ft
->
co¡
 = 
ft£t
->
ftA¼
[
šdex
].cost;

421 
m
 = 0; m < 7; m++){

422 
ft
->
dim
[
m
][0] = 
ft£t
->
ftA¼
[
šdex
].dim[m][0];

423 
ft
->
dim
[
m
][1] = 
ft£t
->
ftA¼
[
šdex
].dim[m][1];

425 
	}
}

426 
	$»¡Üe_Úe_f‹r
(
gid
, 
šdex
, 
FILTER
 *
ft
)

428 
FILTSET
 *
ft£t
 = &
gsd©a
.
aş
->
aş_d©a
[
gid
].filtset;

429 
m
;

431 
ft£t
->
ftA¼
[
šdex
].
¡©e
 = 
ft
->state;

432 
ft£t
->
ftA¼
[
šdex
].
sync
 = 
ft
->sync;

434 
ft£t
->
ftA¼
[
šdex
].
co¡
 = 
ft
->cost;

435 
m
 = 0; m < 7; m++){

436 
ft£t
->
ftA¼
[
šdex
].
dim
[
m
][0] = 
ft
->dim[m][0];

437 
ft£t
->
ftA¼
[
šdex
].
dim
[
m
][1] = 
ft
->dim[m][1];

440 
	}
}

441 
	$cov”_Úe_f‹r
(
gid
, 
sšdex
, 
dšdex
)

443 
FILTSET
 *
ft£t
 = &
gsd©a
.
aş
->
aş_d©a
[
gid
].filtset;

444 
m
;

445 
ft£t
->
ftA¼
[
sšdex
].
¡©e
 = ft£t->ftA¼[
dšdex
].state;

446 
ft£t
->
ftA¼
[
sšdex
].
sync
 = ft£t->ftA¼[
dšdex
].sync;

449 
ft£t
->
ftA¼
[
sšdex
].
co¡
 = ft£t->ftA¼[
dšdex
].cost;

450 
m
 = 0; m < 7; m++){

451 
ft£t
->
ftA¼
[
sšdex
].
dim
[
m
][0] = ft£t->ftA¼[
dšdex
].dim[m][0] ;

452 
ft£t
->
ftA¼
[
sšdex
].
dim
[
m
][1] = ft£t->ftA¼[
dšdex
].dim[m][1];

454 
	}
}

455 
	$upd©ef‹¹agid_by_¡agid
(
ušt8_t
 
gid
, 
ušt16_t
 
¡agid
, ušt16_ˆ
dgid
)

457 
FILTSET
 *
ft£t
 = &
gsd©a
.
aş
->
aş_d©a
[
gid
].filtset;

458 
i
, 
couÁ
 = 
ft£t
->
numF‹rs
;

459 
sšdex
 = 0, 
dšdex
 = 0;

460 
FILTER
 
ft
;

461 
	`mem£t
(&
ft
, 0, (
FILTER
));

462 if(
ACL_UNSET
!ğ
	`aş_g‘f‹r_¡©e
(
gid
, 
¡agid
è&& ACL_UNSET !÷ş_g‘f‹r_¡©e(gid, 
dgid
)){

463 
i
 = 0; i < 
couÁ
; i++){

464 if(
¡agid
 =ğ
ft£t
->
ftA¼
[
i
].
co¡
){

465 
	`cİy_Úe_f‹r
(&
ft
, 
gid
, 
i
);

466 
sšdex
 = 
i
;

468 if(
dgid
 =ğ
ft£t
->
ftA¼
[
i
].
co¡
){

469 
dšdex
 = 
i
;

472 
	`cov”_Úe_f‹r
(
gid
, 
sšdex
, 
dšdex
);

473 
	`»¡Üe_Úe_f‹r
(
gid
, 
dšdex
, &
ft
);

474 
ft£t
->
ftA¼
[
sšdex
].
co¡
 = 
¡agid
;

475 
ft£t
->
ftA¼
[
dšdex
].
co¡
 = 
dgid
;

476 
	`sw­_ft_¡©i¡ics
(
ft£t
, 
¡agid
, 
dgid
);

480 
	}
}

481 
	$aş_upd©ef‹¹agid_by_¡agid
(
ušt8_t
 
gid
, 
ušt16_t
 
¡agid
, ušt16_ˆ
dgid
)

483 
FILTSET
 *
ft£t
 = &
gsd©a
.
aş
->
aş_d©a
[
gid
].filtset;

484 
i
, 
couÁ
 = 
ft£t
->
numF‹rs
;

485 
šdex
 = 0;

486 
FILTER
 
ft
;

487 
	`mem£t
(&
ft
,0, (
FILTER
));

488 if(
	`upd©ef‹¹agid_by_¡agid
(
gid
, 
¡agid
, 
dgid
))

491 
i
 = 0; i < 
couÁ
; i++){

492 if(
¡agid
 =ğ
ft£t
->
ftA¼
[
i
].
co¡
){

493 
	`cİy_Úe_f‹r
(&
ft
, 
gid
, 
i
);

494 
ft
.
co¡
 = 
dgid
;

496 if(
i
 =ğ
couÁ
 -1)

497 
	`aş_š™OÃF‹r_by_šdex
(
gid
, 
i
);

499 
	`move_FÜw¬d_F‹r_äom_šdex
(
gid
, 
i
);

500 
ft£t
->
numF‹rs
--;

505 
couÁ
 = 
ft£t
->
numF‹rs
;

506 
i
 = 0; i < 
couÁ
; i++){

507 if(
dgid
 < 
ft£t
->
ftA¼
[
i
].
co¡
){

509 
	`move_Back_F‹r_äom_šdex
(
gid
, 
šdex
);

511 
	`»¡Üe_Úe_f‹r
(
gid
, 
i
, &
ft
);

513 
ft£t
->
numF‹rs
++;

518 
	`»¡Üe_Úe_f‹r
(
gid
, 
couÁ
, &
ft
);

520 
ft£t
->
numF‹rs
++;

522 
	}
}

587 #iâdeà
FRCORE_ACL_API_INTERFACE


588 
	$£tf‹r
(
ušt8_t
 
gid
, 
ušt16_t
 
šdex
, ušt16_ˆ
rg‘id
, *
s
, *
d
, *
¥
, *
dp
, *
´ÙocŞ
)

590 
FILTSET
 *
ft£t
 = &
gsd©a
.
aş
->
aş_d©a
[
gid
].filtset;

594 
	`aş_»ad¿nge
(
s
, 
ft£t
->
ftA¼
[
šdex
].
dim
[0] ,filtset->filtArr[index].dim[1]);

595 
	`aş_»ad¿nge
(
d
, 
ft£t
->
ftA¼
[
šdex
].
dim
[2] ,filtset->filtArr[index].dim[3]);

596 
	`aş_R—dPÜt
(
¥
, &(
ft£t
->
ftA¼
[
šdex
].
dim
[4][0]), &(filtset->filtArr[index].dim[4][1]));

597 
	`aş_R—dPÜt
(
dp
, &(
ft£t
->
ftA¼
[
šdex
].
dim
[5][0]), &(filtset->filtArr[index].dim[5][1]));

598 
	`aş_R—dPrÙocŞ
(
´ÙocŞ
,&(
ft£t
->
ftA¼
[
šdex
].
dim
[6][0]), &(filtset->filtArr[index].dim[6][1]));

600 
ft£t
->
ftA¼
[
šdex
].
¡©e
 = 
ACL_ENABLE
;

601 
ft£t
->
ftA¼
[
šdex
].
sync
 = 
ACL_NOSYNC
;

602 
ft£t
->
ftA¼
[
šdex
].
co¡
 = 
rg‘id
;

604 
ft£t
->
pkt_num
[
rg‘id
] = 0;

605 
ft£t
->
numF‹rs
++;

606 
i
;

607 
	`´štf
("šdex:%d\n", 
šdex
);

608 
i
 = 0; i < 7; i++) {

609 
	`´štf
("dim[%d][0]=0x%4x dim[%d][1]=0x%4x\n", 
i
,

610 
ft£t
->
ftA¼
[
šdex
].
dim
[
i
][0], i, filtset->filtArr[index].dim[i][1]);

612 
	}
}

615 
	$aş_š£¹Tİf‹r
(
ušt8_t
 
gid
, 
ušt16_t
 
rg‘id
, *
s
, *
d
, *
¥
, *
dp
, *
´ÙocŞ
)

617 
FILTSET
 *
ft£t
 = &
gsd©a
.
aş
->
aş_d©a
[
gid
].filtset;

618 
m
, 
j
, 
couÁ
 = 
ft£t
->
numF‹rs
;

619 
j
 = 
couÁ
 - 1; j >= 0; j--){

620 
ft£t
->
ftA¼
[
j
 + 1].
¡©e
 = filtset->filtArr[j].state;

621 
ft£t
->
ftA¼
[
j
 + 1].
sync
 = filtset->filtArr[j].sync;

622 
ft£t
->
pkt_num
[ft£t->
ftA¼
[
j
+1].
co¡
] = filtset->pkt_num[filtset->filtArr[j].cost];

624 
ft£t
->
ftA¼
[
j
 + 1].
co¡
 = filtset->filtArr[j].cost + 1;

625 
m
 = 0; m < 7; m++){

626 
ft£t
->
ftA¼
[
j
 + 1].
dim
[
m
][0] = filtset->filtArr[j].dim[m][0];

627 
ft£t
->
ftA¼
[
j
 + 1].
dim
[
m
][1] = filtset->filtArr[j].dim[m][1];

630 
	`£tf‹r
(
gid
, 0, 0, 
s
, 
d
, 
¥
, 
dp
, 
´ÙocŞ
);

633 
	}
}

635 
	$aş_£tf‹r
(
ušt8_t
 
gid
, 
ušt16_t
 
rg‘id
, *
s
, *
d
, *
¥
, *
dp
, *
´ÙocŞ
)

637 
FILTSET
 *
ft£t
 = &
gsd©a
.
aş
->
aş_d©a
[
gid
].filtset;

638 
i
, 
j
, 
m
, 
couÁ
 = 
ft£t
->
numF‹rs
;

640 
	`´štf
("couÁ=%d\n", 
couÁ
);

641 
i
 = 0; i < 
couÁ
; i++){

642 if(
rg‘id
 < 
ft£t
->
ftA¼
[
i
].
co¡
){

643 
j
 = 
couÁ
 - 1; j >ğ
i
; j--){

644 
ft£t
->
ftA¼
[
j
 + 1].
¡©e
 = filtset->filtArr[j].state;

645 
ft£t
->
ftA¼
[
j
 + 1].
sync
 = filtset->filtArr[j].sync;

646 
ft£t
->
pkt_num
[ft£t->
ftA¼
[
j
+1].
co¡
] = filtset->pkt_num[filtset->filtArr[j].cost];

647 
ft£t
->
ftA¼
[
j
 + 1].
co¡
 = filtset->filtArr[j].cost;

649 
m
 = 0; m < 7; m++){

650 
ft£t
->
ftA¼
[
j
 + 1].
dim
[
m
][0] = filtset->filtArr[j].dim[m][0];

651 
ft£t
->
ftA¼
[
j
 + 1].
dim
[
m
][1] = filtset->filtArr[j].dim[m][1];

654 
	`£tf‹r
(
gid
, 
i
, 
rg‘id
, 
s
, 
d
, 
¥
, 
dp
, 
´ÙocŞ
);

658 
	`£tf‹r
(
gid
, 
couÁ
, 
rg‘id
, 
s
, 
d
, 
¥
, 
dp
, 
´ÙocŞ
);

660 
	}
}

662 
	$aş_»ad¿nge
(*
å
,* 
highRªge
,* 
lowRªge
)

666 
Œªge
[4];

667 
mask
;

668 
v®id¦ash
;

671 
	`ssÿnf
(
å
, "%d.%d.%d.%d%c%d", &
Œªge
[0], &Œªge[1], &Œªge[2], &Œªge[3], &
v®id¦ash
, &
mask
);

675 if(
v®id¦ash
 != '/')

676 
mask
 = 32;

680 
maskl™1
;

681 
maskl™2
,
maskl™3
;

682 
mask
 = 32 - mask;

683 
maskl™1
 = 
mask
 / 8;

684 
maskl™2
 = 
mask
 % 8;

686 
±¿nge
[4];

687 
i
;

688 
i
=0;i<4;i++)

689 
±¿nge
[
i
] = 
Œªge
[i];

692 
i
=3;i>3-
maskl™1
;i--)

693 
±¿nge
[
i
] = 0;

694 if(
maskl™2
 != 0){

695 
maskl™3
 = 1;

696 
maskl™3
 <<ğ
maskl™2
;

697 
maskl™3
 -= 1;

698 
maskl™3
 = ~masklit3;

699 
±¿nge
[3-
maskl™1
] &ğ
maskl™3
;

702 
highRªge
[0] = 
±¿nge
[0];

703 
highRªge
[0] <<= 8;

704 
highRªge
[0] +ğ
±¿nge
[1];

705 
lowRªge
[0] = 
±¿nge
[2];

706 
lowRªge
[0] <<= 8;

707 
lowRªge
[0] +ğ
±¿nge
[3];

710 
i
=3;i>3-
maskl™1
;i--)

711 
±¿nge
[
i
] = 255;

712 if(
maskl™2
 != 0){

713 
maskl™3
 = 1;

714 
maskl™3
 <<ğ
maskl™2
;

715 
maskl™3
 -= 1;

716 
±¿nge
[3-
maskl™1
] |ğ
maskl™3
;

719 
highRªge
[1] = 
±¿nge
[0];

720 
highRªge
[1] <<= 8;

721 
highRªge
[1] +ğ
±¿nge
[1];

722 
lowRªge
[1] = 
±¿nge
[2];

723 
lowRªge
[1] <<= 8;

724 
lowRªge
[1] +ğ
±¿nge
[3];

725 
	}
}

731 
	$aş_R—dPrÙocŞ
(*
å
, *
äom
, *
to
)

733 
täom
, 
‰o
;

734 
	`ssÿnf
(
å
, "%u", &
täom
);

735 if(
ACL_PROTOCOL_ANY
 =ğ
täom
){

736 
täom
 = 0;

737 
‰o
 = 255;

740 
‰o
 = 
täom
;

742 *
äom
 = 
täom
;

743 *
to
 = 
‰o
;

744 
	}
}

751 
	$aş_R—dPÜt
(*
å
, *
äom
, *
to
)

753 
täom
;

754 
‰o
;

755 if(
	`¡rchr
(
å
, '-'))

756 
	`ssÿnf
(
å
,"%d-%d",&
täom
, &
‰o
);

758 
	`ssÿnf
(
å
, "%d", &
täom
);

759 
‰o
 = 
täom
;

762 *
äom
 = 
täom
;

763 *
to
 = 
‰o
;

764 
	}
}

769 
	$£tf‹r
(
ušt8_t
 
gid
, 
ušt16_t
 
šdex
, ušt16_ˆ
rg‘id
, 
ušt32_t
 
s
, ušt32_ˆ
d
, ušt16_ˆ
¥
,

770 
ušt16_t
 
dp
, ušt16_ˆ
´ÙocŞ
, ušt16_ˆ
İ
, ušt16_ˆ
aùiÚ
, ušt16_ˆ
ruË_ty³
,

771 
ušt16_t
 
ruË_sourû
, 
ušt8_t
 
cov”
)

773 
FILTSET
 *
ft£t
 = &
gsd©a
.
aş
->
aş_d©a
[
gid
].filtset;

777 
	`aş_»ad¿nge
(
s
, 
ft£t
->
ftA¼
[
šdex
].
dim
[0] ,filtset->filtArr[index].dim[1]);

778 
	`aş_»ad¿nge
(
d
, 
ft£t
->
ftA¼
[
šdex
].
dim
[2] ,filtset->filtArr[index].dim[3]);

779 
	`aş_R—dPÜt
(
¥
, &(
ft£t
->
ftA¼
[
šdex
].
dim
[4][0]), &(filtset->filtArr[index].dim[4][1]));

780 
	`aş_R—dPÜt
(
dp
, &(
ft£t
->
ftA¼
[
šdex
].
dim
[5][0]), &(filtset->filtArr[index].dim[5][1]));

781 
	`aş_R—dPrÙocŞ
(
´ÙocŞ
,&(
ft£t
->
ftA¼
[
šdex
].
dim
[6][0]), &(filtset->filtArr[index].dim[6][1]));

783 
ft£t
->
ftA¼
[
šdex
].
¡©e
 = 
ACL_ENABLE
;

784 
ft£t
->
ftA¼
[
šdex
].
sync
 = 
ACL_NOSYNC
;

785 
ft£t
->
ftA¼
[
šdex
].
co¡
 = 
rg‘id
;

786 
ft£t
->
ftA¼
[
šdex
].
İ
 = op;

787 
ft£t
->
ftA¼
[
šdex
].
aùiÚ
 =‡ction;

788 
ft£t
->
ftA¼
[
šdex
].
ruË_ty³
 =„ule_type;

789 
ft£t
->
ftA¼
[
šdex
].
ruË_sourû
 =„ule_source;

791 
ft£t
->
pkt_num
[
rg‘id
] = 0;

792 
ft£t
->
pkt_by‹s
[
rg‘id
] = 0;

793 if(!
cov”
) {

794 
ft£t
->
numF‹rs
++;

796 
i
;

797 
	`FRCORE_RULE
("šdex:%d\n", 
šdex
);

798 
i
 = 0; i < 7; i++) {

799 
	`FRCORE_RULE
("dim[%d][0]=0x%4x dim[%d][1]=0x%4x\n", 
i
,

800 
ft£t
->
ftA¼
[
šdex
].
dim
[
i
][0], i, filtset->filtArr[index].dim[i][1]);

802 
	}
}

804 
	$aş_£tf‹r
(
ušt8_t
 
gid
, 
ušt16_t
 
rg‘id
, 
ušt32_t
 
s
, ušt32_ˆ
d
, ušt16_ˆ
¥
, ušt16_ˆ
dp
, ušt16_ˆ
´ÙocŞ
,

805 
ušt16_t
 
İ
, ušt16_ˆ
aùiÚ
, ušt16_ˆ
ruË_ty³
, ušt16_ˆ
ruË_sourû
)

807 
FILTSET
 *
ft£t
 = &
gsd©a
.
aş
->
aş_d©a
[
gid
].filtset;

808 
i
, 
j
, 
m
, 
couÁ
 = 
ft£t
->
numF‹rs
;

810 
	`FRCORE_RULE
("couÁ=%d\n", 
couÁ
);

811 
i
 = 0; i < 
couÁ
; i++){

812 if(
rg‘id
 < 
ft£t
->
ftA¼
[
i
].
co¡
){

813 
j
 = 
couÁ
 - 1; j >ğ
i
; j--){

814 
ft£t
->
ftA¼
[
j
 + 1].
¡©e
 = filtset->filtArr[j].state;

815 
ft£t
->
ftA¼
[
j
 + 1].
sync
 = filtset->filtArr[j].sync;

816 
ft£t
->
pkt_num
[ft£t->
ftA¼
[
j
+1].
co¡
] = filtset->pkt_num[filtset->filtArr[j].cost];

817 
ft£t
->
pkt_by‹s
[ft£t->
ftA¼
[
j
+1].
co¡
] = filtset->pkt_bytes[filtset->filtArr[j].cost];

818 
ft£t
->
ftA¼
[
j
 + 1].
co¡
 = filtset->filtArr[j].cost;

819 
ft£t
->
ftA¼
[
j
 + 1].
İ
 = filtset->filtArr[j].op;

820 
ft£t
->
ftA¼
[
j
 + 1].
aùiÚ
 = filtset->filtArr[j].action;

821 
ft£t
->
ftA¼
[
j
 + 1].
ruË_ty³
 = filtset->filtArr[j].rule_type;

822 
ft£t
->
ftA¼
[
j
 + 1].
ruË_sourû
 = filtset->filtArr[j].rule_source;

824 
m
 = 0; m < 7; m++){

825 
ft£t
->
ftA¼
[
j
 + 1].
dim
[
m
][0] = filtset->filtArr[j].dim[m][0];

826 
ft£t
->
ftA¼
[
j
 + 1].
dim
[
m
][1] = filtset->filtArr[j].dim[m][1];

829 
	`£tf‹r
(
gid
, 
i
, 
rg‘id
, 
s
, 
d
, 
¥
, 
dp
, 
´ÙocŞ
, 
İ
, 
aùiÚ
, 
ruË_ty³
, 
ruË_sourû
, 0);

831 }if(
rg‘id
 =ğ
ft£t
->
ftA¼
[
i
].
co¡
) {

832 
	`£tf‹r
(
gid
, 
i
, 
rg‘id
, 
s
, 
d
, 
¥
, 
dp
, 
´ÙocŞ
, 
İ
, 
aùiÚ
, 
ruË_ty³
, 
ruË_sourû
, 1);

836 
	`£tf‹r
(
gid
, 
couÁ
, 
rg‘id
, 
s
, 
d
, 
¥
, 
dp
, 
´ÙocŞ
, 
İ
, 
aùiÚ
, 
ruË_ty³
, 
ruË_sourû
, 0);

838 
	}
}

840 
	$aş_»ad¿nge
(
ušt32_t
 

,* 
highRªge
,* 
lowRªge
)

844 
Œªge
[4];

845 
mask
;

846 
i
;

848 if(

) {

849 
mask
 = 32;

851 
mask
 = 0;

854 
i
 = 0; i < 4; i++) {

855 
Œªge
[
i
] = (

 >> ((3-i)*8)) & 0xff;

856 
	`FRCORE_RULE
("Œªge[%d]=0x%2x\n", 
i
, 
Œªge
[i]);

859 
maskl™1
;

860 
maskl™2
,
maskl™3
;

861 
mask
 = 32 - mask;

862 
maskl™1
 = 
mask
 / 8;

863 
maskl™2
 = 
mask
 % 8;

865 
±¿nge
[4];

866 
i
=0;i<4;i++)

867 
±¿nge
[
i
] = 
Œªge
[i];

870 
i
=3;i>3-
maskl™1
;i--)

871 
±¿nge
[
i
] = 0;

872 if(
maskl™2
 != 0){

873 
maskl™3
 = 1;

874 
maskl™3
 <<ğ
maskl™2
;

875 
maskl™3
 -= 1;

876 
maskl™3
 = ~masklit3;

877 
±¿nge
[3-
maskl™1
] &ğ
maskl™3
;

880 
highRªge
[0] = 
±¿nge
[0];

881 
highRªge
[0] <<= 8;

882 
highRªge
[0] +ğ
±¿nge
[1];

883 
lowRªge
[0] = 
±¿nge
[2];

884 
lowRªge
[0] <<= 8;

885 
lowRªge
[0] +ğ
±¿nge
[3];

888 
i
=3;i>3-
maskl™1
;i--)

889 
±¿nge
[
i
] = 255;

890 if(
maskl™2
 != 0){

891 
maskl™3
 = 1;

892 
maskl™3
 <<ğ
maskl™2
;

893 
maskl™3
 -= 1;

894 
±¿nge
[3-
maskl™1
] |ğ
maskl™3
;

897 
highRªge
[1] = 
±¿nge
[0];

898 
highRªge
[1] <<= 8;

899 
highRªge
[1] +ğ
±¿nge
[1];

900 
lowRªge
[1] = 
±¿nge
[2];

901 
lowRªge
[1] <<= 8;

902 
lowRªge
[1] +ğ
±¿nge
[3];

903 
	}
}

909 
	$aş_R—dPrÙocŞ
(
ušt16_t
 
´Ùo
, *
äom
, *
to
)

911 
täom
, 
‰o
;

912 
täom
 = 
´Ùo
;

913 if(
ACL_PROTOCOL_ANY
 =ğ
täom
){

914 
täom
 = 0;

915 
‰o
 = 255;

918 
‰o
 = 
täom
;

920 *
äom
 = 
täom
;

921 *
to
 = 
‰o
;

922 
	}
}

929 
	$aş_R—dPÜt
(
ušt16_t
 
pÜt
, *
äom
, *
to
)

931 
täom
;

932 
‰o
;

934 if(
pÜt
) {

935 
täom
 = 
pÜt
;

936 
‰o
 = 
täom
;

938 
täom
 = 0;

939 
‰o
 = 65535;

942 *
äom
 = 
täom
;

943 *
to
 = 
‰o
;

944 
	}
}

947 #ifdeà
RFC3_DEBUG


948 
	$´e_aş_lookup_by_tu¶e
(
ušt8_t
 
aşgid
)

950 
	`S‘Pha£0_C–l
(
gsd©a
.
aş
->
aş_d©a
[
aşgid
].
pha£0_Nodes
, &gsd©a.aş->aş_d©a[aşgid].
ft£t
);

951 
	`S‘Pha£1_C–l
(
gsd©a
.
aş
->
aş_d©a
[
aşgid
].
pha£0_Nodes
, gsd©a.aş->aş_d©a[aşgid].
pha£1_Nodes
, gsd©a.aş->aş_d©a[aşgid].
dÙ
);

952 
	`S‘Pha£2_C–l
(
gsd©a
.
aş
->
aş_d©a
[
aşgid
].
pha£1_Nodes
, &gsd©a.aş->aş_d©a[aşgid].
pha£2_Node
);

954 
Pnode
 *
pha£0_Nodes
 = 
gsd©a
.
aş
->
aş_d©a
[
aşgid
].phase0_Nodes;

955 
Pnod”
 *
pha£1_Nodes
 = 
gsd©a
.
aş
->
aş_d©a
[
aşgid
].phase1_Nodes;

956 
Pnod”
 *
pha£2_Node
 = &
gsd©a
.
aş
->
aş_d©a
[
aşgid
].phase2_Node;

958 
ušt8_t
 *
dÙ
 = 
gsd©a
.
aş
->
aş_d©a
[
aşgid
].dot;

960 
pha£0nûs
[7];

962 
pha£0nûs
[0] = 
pha£0_Nodes
[
dÙ
[0]].
li¡Eqs
.
nCES
;

963 
pha£0nûs
[1] = 
pha£0_Nodes
[
dÙ
[1]].
li¡Eqs
.
nCES
;

964 
pha£0nûs
[2] = 
pha£0_Nodes
[
dÙ
[2]].
li¡Eqs
.
nCES
;

965 
pha£0nûs
[3] = 
pha£0_Nodes
[
dÙ
[3]].
li¡Eqs
.
nCES
;

966 
pha£0nûs
[4] = 
pha£0_Nodes
[
dÙ
[4]].
li¡Eqs
.
nCES
;

967 
pha£0nûs
[5] = 
pha£0_Nodes
[
dÙ
[5]].
li¡Eqs
.
nCES
;

968 
pha£0nûs
[6] = 
pha£0_Nodes
[6].
li¡Eqs
.
nCES
;

969 
i
 = 0;

970 
i
 = 0; i < 7; i++)

971 
	`´štf
("pha£0nûs[%u] : %u\n", 
i
, 
pha£0nûs
[i]);

973 
	`´štf
("pha£1_Nodes[0].li¡Eqs.nCES : %u\n", 
pha£1_Nodes
[0].
li¡Eqs
.
nCES
);

974 
	`´štf
("pha£1_Nodes[1].li¡Eqs.nCES : %u\n", 
pha£1_Nodes
[1].
li¡Eqs
.
nCES
);

976 
gsd©a
.
aş
->
aş_d©a
[
aşgid
].
šdx0a
 = 
pha£0nûs
[1] *…hase0nces[2] *…hase0nces[6];

977 
gsd©a
.
aş
->
aş_d©a
[
aşgid
].
šdx0b
 = 
pha£0nûs
[2] *…hase0nces[6];

981 
gsd©a
.
aş
->
aş_d©a
[
aşgid
].
šdex1a
 = 
pha£0nûs
[4] *…hase0nces[5];

983 
	}
}

985 
	$aş_lookup_by_tu¶e
(
Pnode
 *
pha£0_Nodes
, 
Pnod”
 *
pha£1_Nodes
, Pnod” *
pha£2_Node
, 
ušt8_t
 *
dÙ
,

986 
ušt16_t
 
sh
, ušt16_ˆ
sl
, ušt16_ˆ
dh
, ušt16_ˆ
dl
, ušt16_ˆ
¥
, ušt16_ˆ
dp
 ,
ušt8_t
 
´Ùo
)

992 
cid
[9];

993 
šdx
[3];

998 
cid
[0] = 
pha£0_Nodes
[0].
ûÎ
[
sh
];

999 
cid
[1] = 
pha£0_Nodes
[1].
ûÎ
[
sl
];

1000 
cid
[2] = 
pha£0_Nodes
[2].
ûÎ
[
dh
];

1001 
cid
[3] = 
pha£0_Nodes
[3].
ûÎ
[
dl
];

1002 
cid
[4] = 
pha£0_Nodes
[4].
ûÎ
[
¥
];

1003 
cid
[5] = 
pha£0_Nodes
[5].
ûÎ
[
dp
];

1004 
cid
[6] = 
pha£0_Nodes
[6].
ûÎ
[
´Ùo
];

1007 
šdx
[0] = 
cid
[
dÙ
[0]] * 
gsd©a
.
aş
->
aş_d©a
[0].
šdx0a


1008 + 
cid
[
dÙ
[1]] * 
gsd©a
.
aş
->
aş_d©a
[0].
šdx0b


1009 + 
cid
[
dÙ
[2]] * 
pha£0_Nodes
[6].
li¡Eqs
.
nCES


1010 + 
cid
[6];

1011 
šdx
[1] = 
cid
[
dÙ
[3]] * 
gsd©a
.
aş
->
aş_d©a
[0].
šdex1a


1012 + 
cid
[
dÙ
[4]] * 
pha£0_Nodes
[dÙ[5]].
li¡Eqs
.
nCES


1013 + 
cid
[
dÙ
[5]];

1015 
cid
[7] = 
pha£1_Nodes
[0].
ûÎ
[
šdx
[0]];

1016 
cid
[8] = 
pha£1_Nodes
[1].
ûÎ
[
šdx
[1]];

1018 
šdx
[2] = 
cid
[7] * 
pha£1_Nodes
[1].
li¡Eqs
.
nCES


1019 + 
cid
[8];

1021  
pha£2_Node
->
ûÎ
[
šdx
[2]];

1023 
	}
}

1025 #ifdeà
RFC4_DEBUG


1026 
	$´e_aş_lookup_by_tu¶e
(
ušt8_t
 
aşgid
)

1028 
»t
 = 
ACL_OK
;

1029 
»t
 = 
	`S‘Pha£0_C–l
(
gsd©a
.
aş
->
aş_d©a
[
aşgid
].
pha£0_Nodes
, &gsd©a.aş->aş_d©a[aşgid].
ft£t
);

1030 if(
ACL_ERROR
 =ğ
»t
)

1031  
MC_ERROR
;

1032 
»t
 = 
	`S‘Pha£1_C–l
(
gsd©a
.
aş
->
aş_d©a
[
aşgid
].
pha£0_Nodes
, gsd©a.aş->aş_d©a[aşgid].
pha£1_Nodes
);

1033 if(
ACL_ERROR
 =ğ
»t
)

1034  
MC_ERROR
;

1035 
»t
 = 
	`S‘Pha£2_C–l
(
gsd©a
.
aş
->
aş_d©a
[
aşgid
].
pha£0_Nodes
, gsd©a.aş->aş_d©a[aşgid].
pha£1_Nodes
, gsd©a.aş->aş_d©a[aşgid].
pha£2_Nodes
);

1036 if(
ACL_ERROR
 =ğ
»t
)

1037  
MC_ERROR
;

1038 
»t
 = 
	`S‘Pha£3_C–l
(
aşgid
, 
gsd©a
.
aş
->
aş_d©a
[aşgid].
pha£2_Nodes
, &gsd©a.aş->aş_d©a[aşgid].
pha£3_Node
);

1039 if(
ACL_ERROR
 =ğ
»t
)

1040  
MC_ERROR
;

1042  
FRE_SUCCESS
;

1043 
	}
}

1044 
ušt16_t
 
	$aş_lookup_by_tu¶e
(
Pnode
 *
pha£0_Nodes
, 
Pnod”
 *
pha£1_Nodes
, Pnod” *
pha£2_Nodes
, Pnod” *
pha£3_Node
,

1045 
ušt16_t
 
sh
, ušt16_ˆ
sl
, ušt16_ˆ
dh
, ušt16_ˆ
dl
, ušt16_ˆ
¥
, ušt16_ˆ
dp
 ,
ušt8_t
 
´Ùo
)

1048 
cid
[12];

1049 
šdx
[6];

1068 
cid
[0] = 
pha£0_Nodes
[0].
ûÎ
[
sh
];

1069 
cid
[1] = 
pha£0_Nodes
[1].
ûÎ
[
sl
];

1070 
cid
[2] = 
pha£0_Nodes
[2].
ûÎ
[
dh
];

1071 
cid
[3] = 
pha£0_Nodes
[3].
ûÎ
[
dl
];

1072 
cid
[4] = 
pha£0_Nodes
[4].
ûÎ
[
¥
];

1073 
cid
[5] = 
pha£0_Nodes
[5].
ûÎ
[
dp
];

1074 
cid
[6] = 
pha£0_Nodes
[6].
ûÎ
[
´Ùo
];

1081 
šdx
[0] = 
cid
[0] * 
pha£0_Nodes
[1].
li¡Eqs
.
nCES
 + cid[1];

1082 
šdx
[1] = 
cid
[2] * 
pha£0_Nodes
[3].
li¡Eqs
.
nCES
 + cid[3];

1083 
šdx
[2] = 
cid
[4] * 
pha£0_Nodes
[5].
li¡Eqs
.
nCES
 + cid[5];

1086 
cid
[7] = 
pha£1_Nodes
[0].
ûÎ
[
šdx
[0]];

1087 
cid
[8] = 
pha£1_Nodes
[1].
ûÎ
[
šdx
[1]];

1088 
cid
[9] = 
pha£1_Nodes
[2].
ûÎ
[
šdx
[2]];

1091 
šdx
[3] = 
cid
[7] * 
pha£1_Nodes
[1].
li¡Eqs
.
nCES
 + cid[8];

1092 
šdx
[4] = 
cid
[9] * 
pha£0_Nodes
[6].
li¡Eqs
.
nCES
 + cid[6];

1095 
cid
[10] = 
pha£2_Nodes
[0].
ûÎ
[
šdx
[3]];

1096 
cid
[11] = 
pha£2_Nodes
[1].
ûÎ
[
šdx
[4]];

1098 
šdx
[5] = 
cid
[10] * 
pha£2_Nodes
[1].
li¡Eqs
.
nCES
 + cid[11];

1108  
pha£3_Node
->
ûÎ
[
šdx
[5]];

1109 
	}
}

	@frcore/frcore_acl.h

2 #iâdeà
_FRCORE_ACL_H


3 
	#_FRCORE_ACL_H


	)

5 
	~"cvmx-cÚfig.h
"

6 
	~"cvmx.h
"

7 
	~"cvmx-wqe.h
"

8 
	~"cvmx-çu.h
"

9 
	~"cvmx-©omic.h
"

10 
	~"cvmx-¥šlock.h
"

12 
	~"äcÜe_š™.h
"

13 
	~"äcÜe_cÚfig.h
"

15 
	~"äcÜe_debug.h
"

18 
	~"äcÜe_rfc.h
"

20 
	#ACL_PROTOCOL_UDP
 17

	)

21 
	#ACL_PROTOCOL_TCP
 6

	)

22 
	#ACL_PROTOCOL_ANY
 0

	)

24 
	#FRCORE_ACL_API_INTERFACE


	)

26 
	smµ_aş_ft£t
{

27 
FILTSET
 
	mft£t
;

28 
Pnode
 
	mpha£0_Nodes
[7];

29 #ifdeà
RFC3_DEBUG


30 
Pnod”
 
	mpha£1_Nodes
[2];

31 
Pnod”
 
	mpha£2_Node
;

32 
ušt8_t
 
	mdÙ
[7];

33 
	mšdx0a
 ;

34 
	mšdx0b
 ;

35 
	mšdex1a
 ;

37 #ifdeà
RFC4_DEBUG


38 
Pnod”
 
	mpha£1_Nodes
[3];

39 
Pnod”
 
	mpha£2_Nodes
[2];

40 
Pnod”
 
	mpha£3_Node
;

43 }
	tmµ_aş_ft£t
;

45 
LßdF‹rs
(
FILE
 *
å
, 
FILTSET
 * 
ft£t
);

46 #iâdeà
FRCORE_ACL_API_INTERFACE


47 
aş_»ad¿nge
(*
å
,* 
highRªge
,* 
lowRªge
);

48 
aş_R—dPrÙocŞ
(*
å
, *
äom
, *
to
);

49 
aş_R—dPÜt
(*
å
, *
äom
, *
to
);

51 
aş_»ad¿nge
(
ušt32_t
 

,* 
highRªge
,* 
lowRªge
);

56 
aş_R—dPrÙocŞ
(
ušt16_t
 
´Ùo
, *
äom
, *
to
);

61 
aş_R—dPÜt
(
ušt16_t
 
pÜt
, *
äom
, *
to
);

63 
	smµ_aş_hash
{

66 
ušt32_t
 
	m
;

67 
ušt32_t
 
	mg
;

69 
ušt64_t
 
	md©a
;

71 }
	tmµ_aş_hash
;

73 
	smµ_aş_
{

74 
cvmx_¥šlock_t
 
	mlock
;

75 
ušt32_t
 
	m¤c_út
[
MAX_ACL_IP_NUM
];

76 
ušt32_t
 
	mde¡_út
[
MAX_ACL_IP_NUM
];

77 
mµ_aş_hash
 
	m¤c
[
MAX_ACL_IP_NUM
][
MAX_ACL_IP_HASH_BUCKET_LEN
];

78 
mµ_aş_hash
 
	mde¡
[
MAX_ACL_IP_NUM
][
MAX_ACL_IP_HASH_BUCKET_LEN
];

79 
ušt32_t
 
	mg
[
MAX_ACL_IP_NUM
];

80 
	#FLAG_SRC_IP
 1

	)

81 
	#FLAG_DEST_IP
 2

	)

82 
ušt32_t
 
	mæag
[
MAX_ACL_IP_NUM
];

83 }
	tmµ_aş_
;

85 
	smµ_m©ch_group
{

86 
št16_t
 
	mcouÁ
;

87 
št16_t
 
	msm
[
MPP_MAX_ACSM_NUM
];

88 }
	tmµ_m©ch_group
;

89 
	smµ_aş
{

90 
mµ_aş_ft£t
 
	maş_d©a
[
MPP_MAX_ACL_NUM
];

92 
mµ_m©ch_group
 
	maş_sm
[
MPP_MAX_ACL_NUM
][
MPP_MAX_FILTERS
];

93 
mµ_aş_
 
	maş_
[
MPP_MAX_ACL_NUM
];

94 }
	tmµ_aş
;

96 
ušt8_t
 
g‘_s¢_¡©e
();

97 
ušt8_t
 
g‘_aş_¡©e
();

98 
ušt16_t
 
aş_g‘f‹r_couÁ
(
ušt8_t
 
gid
);

99 
ušt8_t
 
aş_g‘f‹r_¡©e
(ušt8_ˆ
gid
, 
ušt16_t
 
gid
);

100 
aş_g‘f‹r_ruËid_by_gid
(
ušt8_t
 
gid
, 
ušt16_t
 
gid
);

101 
šlše
 
ušt16_t
 
aş_g‘_gid_by_ruËid
(
ušt8_t
 
aşgid
, ušt16_ˆ
ruËid
);

102 
aş_G‘OÃF‹r_Cmd
(
ušt8_t
 
gid
, 
ušt16_t
 
ruËid
, *
s
, *
d
, *
¥
, *
dp
, *
´ÙocŞ
);

103 #iâdeà
FRCORE_ACL_API_INTERFACE


104 
aş_g‘f‹r_by_ruËid
(
ušt8_t
 
gid
, 
ušt16_t
 
ruËid
, 
isdump
, ušt16_ˆ*
gid
, ušt8_ˆ*
¡©e
, ušt8_ˆ*
sync
, *
s
, *
d
, *
¥
, *
dp
, *
´ÙocŞ
);

105 
aş_g‘f‹r_by_gid
(
ušt8_t
 
gid
, 
ušt16_t
 
gid
, ušt16_ˆ*
ruËnum
,ušt8_ˆ*
¡©e
, ušt8_ˆ*
sync
,

106 *
s
, *
d
, *
¥
, *
dp
, *
´ÙocŞ
);

108 
aş_g‘f‹r_by_gid
(
ušt8_t
 
gid
, 
ušt16_t
 
gid
, ušt16_ˆ*
ruËnum
,ušt8_ˆ*
¡©e
, ušt8_ˆ*
sync
,

109 
ušt32_t
 *
s
, ušt32_ˆ*
d
, 
ušt16_t
 *
¥
, ušt16_ˆ*
dp
, ušt16_ˆ*
´ÙocŞ
,

110 
ušt32_t
 *
pkts
, ušt32_ˆ*
by‹s
, 
ušt16_t
 *
İ
, ušt16_ˆ*
aùiÚ
, ušt16_ˆ*
ruË_ty³
,

111 
ušt16_t
 *
ruË_sourû
);

112 
aş_š™f‹r_¡©i¡ics_by_gid
(
ušt8_t
 
gid
, 
ušt16_t
 
gid
);

114 
ušt8_t
 
aş_’abË_Úe_f‹r_by_gid
(ušt8_ˆ
gid
, 
ušt16_t
 
rg‘id
, ušt8_ˆ
’abË
);

115 
ušt8_t
 
aş_’abË_®l_f‹r
(ušt8_ˆ
gid
, ušt8_ˆ
’abË
);

117 
aş_š™OÃF‹r_by_šdex
(
ušt8_t
 
gid
, 
šdex
);

118 
aş_š™_Úe_aş_sm
();

119 
aş_š™
();

120 
aş_D–‘eOÃF‹r_by_gid
(
ušt8_t
 
gid
, 
ušt16_t
 
gid
);

121 
aş_upd©ef‹¹agid_by_¡agid
(
ušt8_t
 
gid
, 
ušt16_t
 
¡agid
, ušt16_ˆ
dgid
);

122 #iâdeà
FRCORE_ACL_API_INTERFACE


123 
aş_£tf‹r
(
ušt8_t
 
gid
, 
ušt16_t
 
rg‘id
, *
s
, *
d
, *
¥
, *
dp
, *
´ÙocŞ
);

125 
aş_£tf‹r
(
ušt8_t
 
gid
, 
ušt16_t
 
rg‘id
, 
ušt32_t
 
s
, ušt32_ˆ
d
, ušt16_ˆ
¥
, ušt16_ˆ
dp
, ušt16_ˆ
´ÙocŞ
,

126 
ušt16_t
 
İ
, ušt16_ˆ
aùiÚ
, ušt16_ˆ
ruË_ty³
, ušt16_ˆ
ruË_sourû
);

128 
´e_aş_lookup_by_tu¶e
(
ušt8_t
 
aşgid
);

129 #ifdeà
RFC3_DEBUG


130 
aş_lookup_by_tu¶e
(
Pnode
 *
pha£0_Nodes
, 
Pnod”
 *
pha£1_Nodes
, Pnod” *
pha£2_Node
, 
ušt8_t
 *
dÙ
, 
ušt16_t
 
sh
, ušt16_ˆ
sl
, ušt16_ˆ
dh
, ušt16_ˆ
dl
, ušt16_ˆ
¥
, ušt16_ˆ
dp
 ,ušt8_ˆ
´Ùo
);

132 #ifdeà
RFC4_DEBUG


133 
ušt16_t
 
aş_lookup_by_tu¶e
(
Pnode
 *
pha£0_Nodes
, 
Pnod”
 *
pha£1_Nodes
, Pnod” *
pha£2_Nodes
, Pnod” *
pha£3_Node
, ušt16_ˆ
sh
, ušt16_ˆ
sl
, ušt16_ˆ
dh
, ušt16_ˆ
dl
, ušt16_ˆ
¥
, ušt16_ˆ
dp
 ,
ušt8_t
 
´Ùo
);

136 
šlše
 
	$aş_¡©i¡ic_h™
(
ušt8_t
 
aşgid
, 
št32_t
 
gid
)

138 
	`cvmx_©omic_ãtch_ªd_add64
(&
gsd©a
.
aş
->
aş_d©a
[
aşgid
].
ft£t
.
pkt_num
[
gid
], 1);

139 
	}
}

140 
šlše
 
	$aş_š™_¡©i¡ic_h™
(
ušt8_t
 
aşgid
, 
št32_t
 
gid
)

142 
	`cvmx_©omic_£t64
(&
gsd©a
.
aş
->
aş_d©a
[
aşgid
].
ft£t
.
pkt_num
[
gid
], 0);

143 
	}
}

144 
šlše
 
ušt64_t
 
	$aş_g‘_¡©i¡ic_h™
(
ušt8_t
 
aşgid
, 
št32_t
 
gid
)

146  
	`cvmx_©omic_ãtch_ªd_add64
(&
gsd©a
.
aş
->
aş_d©a
[
aşgid
].
ft£t
.
pkt_num
[
gid
], 0);

147 
	}
}

149 
šlše
 
	$aş_pkt_by‹s_add
(
ušt8_t
 
aşgid
, 
št32_t
 
gid
, 
ušt16_t
 
pkt_Ën
)

151 
	`cvmx_©omic_ãtch_ªd_add64
(&
gsd©a
.
aş
->
aş_d©a
[
aşgid
].
ft£t
.
pkt_by‹s
[
gid
], 
pkt_Ën
);

152 
	}
}

153 
šlše
 
	$aş_š™_pkt_by‹s
(
ušt8_t
 
aşgid
, 
št32_t
 
gid
)

155 
	`cvmx_©omic_£t64
(&
gsd©a
.
aş
->
aş_d©a
[
aşgid
].
ft£t
.
pkt_by‹s
[
gid
], 0);

156 
	}
}

157 
šlše
 
ušt64_t
 
	$aş_g‘_pkt_by‹s
(
ušt8_t
 
aşgid
, 
št32_t
 
gid
)

159  
	`cvmx_©omic_ãtch_ªd_add64
(&
gsd©a
.
aş
->
aş_d©a
[
aşgid
].
ft£t
.
pkt_by‹s
[
gid
], 0);

160 
	}
}

166 
šlše
 
ušt32_t
 
	$mµ_aş__hash_üc
(
ušt32_t
 

){

167 
idx
;

168 
	`CVMX_MT_CRC_POLYNOMIAL
 (0x1edc6f41);

169 
	`CVMX_MT_CRC_IV
 (0);

170 
	`CVMX_MT_CRC_WORD
 (

);

171 
	`CVMX_MF_CRC_IV
 (
idx
);

172  
idx
&
MAX_ACL_IP_NUM_MASK
;

173 
	}
}

178 
šlše
 
	$mµ_cmp_¤c_
(
ušt8_t
 
gid
, 
ušt32_t
 

, ušt32_ˆ*
g
){

179 
i
;

180 
ušt32_t
 
šdex
 = 
	`mµ_aş__hash_üc
(

);

181 
i
=0; i<
MAX_ACL_IP_HASH_BUCKET_LEN
; i++) {

182 if(
	`cvmx_lik–y
(
gsd©a
.
aş
->
aş_
[
gid
].
¤c
[
šdex
][
i
].

==ip)) {

183 
	`MC_PRINTF_DEBUG
("successedo findhe source ip\n");

184 *
g
 = 
gsd©a
.
aş
->
aş_
[
gid
].
¤c
[
šdex
][
i
].tag;

189 
	}
}

195 
šlše
 
	$mµ_cmp_de¡_
(
ušt8_t
 
gid
, 
ušt32_t
 

, ušt32_ˆ*
g
){

196 
i
;

197 
ušt32_t
 
šdex
 = 
	`mµ_aş__hash_üc
(

);

198 
i
=0; i<
MAX_ACL_IP_HASH_BUCKET_LEN
; i++) {

199 if(
	`cvmx_lik–y
(
gsd©a
.
aş
->
aş_
[
gid
].
de¡
[
šdex
][
i
].

==ip)) {

200 
	`MC_PRINTF_DEBUG
("successedo findhe destination ip\n");

201 *
g
 = 
gsd©a
.
aş
->
aş_
[
gid
].
de¡
[
šdex
][
i
].tag;

206 
	}
}

211 
šlše
 
	$mµ_š£¹_¤c_
(
ušt8_t
 
gid
, 
ušt32_t
 
gid
, ušt32_ˆ

){

212 
i
;

213 
ušt32_t
 
šdex
 = 
	`mµ_aş__hash_üc
(

);

214 
	`cvmx_¥šlock_lock
(&
gsd©a
.
aş
->
aş_
[
gid
].
lock
);

215 
i
=0; i<
MAX_ACL_IP_HASH_BUCKET_LEN
; i++) {

216 if(
	`cvmx_lik–y
(
gsd©a
.
aş
->
aş_
[
gid
].
¤c
[
šdex
][
i
].

==0)) {

217 
gsd©a
.
aş
->
aş_
[
gid
].
g
[
gid
] = 

;

218 
gsd©a
.
aş
->
aş_
[
gid
].
æag
[
gid
] = 
FLAG_SRC_IP
;

219 
gsd©a
.
aş
->
aş_
[
gid
].
¤c
[
šdex
][
i
].

 = ip;

220 
gsd©a
.
aş
->
aş_
[
gid
].
¤c
[
šdex
][
i
].
g
 = 
gid
+
MPP_ACL_IP_START
;

221 
gsd©a
.
aş
->
aş_
[
gid
].
¤c_út
[
šdex
]++;

222 
	`cvmx_¥šlock_uÆock
(&
gsd©a
.
aş
->
aş_
[
gid
].
lock
);

223 
	`MC_PRINTF_DEBUG
("successedo insert‚ew destn ip inhe destip bucket\n");

225 }if(
gsd©a
.
aş
->
aş_
[
gid
].
¤c
[
šdex
][
i
].

==ip){

226 
	`cvmx_¥šlock_uÆock
(&
gsd©a
.
aş
->
aş_
[
gid
].
lock
);

232 
i
=
gsd©a
.
aş
->
aş_
[
gid
].
¤c_út
[
šdex
]%
MAX_ACL_IP_HASH_BUCKET_LEN
;

233 
gsd©a
.
aş
->
aş_
[
gid
].
g
[
gid
] = 

;

234 
gsd©a
.
aş
->
aş_
[
gid
].
æag
[
gid
] = 
FLAG_SRC_IP
;

235 
gsd©a
.
aş
->
aş_
[
gid
].
¤c
[
šdex
][
i
].

 = ip;

236 
gsd©a
.
aş
->
aş_
[
gid
].
¤c
[
šdex
][
i
].
g
 = 
gid
+
MPP_ACL_IP_START
;

237 
gsd©a
.
aş
->
aş_
[
gid
].
¤c_út
[
šdex
]++;

238 
	`cvmx_¥šlock_uÆock
(&
gsd©a
.
aş
->
aş_
[
gid
].
lock
);

242 
	}
}

248 
šlše
 
	$mµ_š£¹_de¡_
(
ušt8_t
 
gid
, 
ušt32_t
 
gid
, ušt32_ˆ

){

249 
i
;

250 
ušt32_t
 
šdex
 = 
	`mµ_aş__hash_üc
(

);

251 
	`cvmx_¥šlock_lock
(&
gsd©a
.
aş
->
aş_
[
gid
].
lock
);

252 
i
=0; i<
MAX_ACL_IP_HASH_BUCKET_LEN
; i++) {

253 if(
gsd©a
.
aş
->
aş_
[
gid
].
de¡
[
šdex
][
i
].

==0) {

254 
gsd©a
.
aş
->
aş_
[
gid
].
g
[
gid
] = 

;

255 
gsd©a
.
aş
->
aş_
[
gid
].
æag
[
gid
] = 
FLAG_DEST_IP
;

256 
gsd©a
.
aş
->
aş_
[
gid
].
de¡
[
šdex
][
i
].

 = ip;

257 
gsd©a
.
aş
->
aş_
[
gid
].
de¡
[
šdex
][
i
].
g
 = 
gid
+
MPP_ACL_IP_START
;

258 
gsd©a
.
aş
->
aş_
[
gid
].
de¡_út
[
šdex
]++;

259 
	`cvmx_¥šlock_uÆock
(&
gsd©a
.
aş
->
aş_
[
gid
].
lock
);

260 
	`MC_PRINTF_DEBUG
("successedo insert‚ew src ip inhe srcip bucket\n");

262 }if(
gsd©a
.
aş
->
aş_
[
gid
].
de¡
[
šdex
][
i
].

==ip){

263 
	`cvmx_¥šlock_uÆock
(&
gsd©a
.
aş
->
aş_
[
gid
].
lock
);

264 
	`MC_PRINTF_DEBUG
("the ip is inhe src ip bucket\n");

269 
i
 = 
gsd©a
.
aş
->
aş_
[
gid
].
de¡_út
[
šdex
]%
MAX_ACL_IP_HASH_BUCKET_LEN
;

270 
gsd©a
.
aş
->
aş_
[
gid
].
g
[
gid
] = 

;

271 
gsd©a
.
aş
->
aş_
[
gid
].
æag
[
gid
] = 
FLAG_DEST_IP
;

272 
gsd©a
.
aş
->
aş_
[
gid
].
de¡
[
šdex
][
i
].

 = ip;

273 
gsd©a
.
aş
->
aş_
[
gid
].
de¡
[
šdex
][
i
].
g
 = 
gid
+
MPP_ACL_IP_START
;

274 
gsd©a
.
aş
->
aş_
[
gid
].
de¡_út
[
šdex
]++;

275 
	`cvmx_¥šlock_uÆock
(&
gsd©a
.
aş
->
aş_
[
gid
].
lock
);

281 
	}
}

283 
šlše
 
	$mµ_d–_¤c_
(
ušt8_t
 
gid
, 
ušt32_t
 
gid
, ušt32_ˆ

){

284 
i
;

285 
ušt32_t
 
šdex
 = 
	`mµ_aş__hash_üc
(

);

286 
	`cvmx_¥šlock_lock
(&
gsd©a
.
aş
->
aş_
[
gid
].
lock
);

287 
i
=0; i<
MAX_ACL_IP_HASH_BUCKET_LEN
; i++) {

288 if(
	`cvmx_lik–y
(
gsd©a
.
aş
->
aş_
[
gid
].
¤c
[
šdex
][
i
].

==ip)){

289 
gsd©a
.
aş
->
aş_
[
gid
].
g
[
gid
] = 0;

290 
gsd©a
.
aş
->
aş_
[
gid
].
æag
[
gid
] = 0;

291 
gsd©a
.
aş
->
aş_
[
gid
].
¤c
[
šdex
][
i
].
d©a
 = 0;

292 
gsd©a
.
aş
->
aş_
[
gid
].
¤c
[
šdex
][
i
].
g
 = 0;

293 
gsd©a
.
aş
->
aş_
[
gid
].
¤c_út
[
šdex
]--;

294 
	`cvmx_¥šlock_uÆock
(&
gsd©a
.
aş
->
aş_
[
gid
].
lock
);

295 
	`MC_PRINTF_DEBUG
("the ip is inhe srcip bucket, delete it\n");

299 
	`MC_PRINTF_INFO
("the ip isn't inhe srcip bucket\n");

300 
	`cvmx_¥šlock_uÆock
(&
gsd©a
.
aş
->
aş_
[
gid
].
lock
);

302 
	}
}

304 
šlše
 
	$mµ_d–_de¡_
(
ušt8_t
 
gid
, 
ušt32_t
 
gid
, ušt32_ˆ

){

305 
i
;

306 
ušt32_t
 
šdex
 = 
	`mµ_aş__hash_üc
(

);

307 
	`cvmx_¥šlock_lock
(&
gsd©a
.
aş
->
aş_
[
gid
].
lock
);

308 
i
=0; i<
MAX_ACL_IP_HASH_BUCKET_LEN
; i++) {

309 if(
	`cvmx_lik–y
(
gsd©a
.
aş
->
aş_
[
gid
].
de¡
[
šdex
][
i
].

==ip)){

310 
gsd©a
.
aş
->
aş_
[
gid
].
g
[
gid
] = 0;

311 
gsd©a
.
aş
->
aş_
[
gid
].
æag
[
gid
] = 0;

312 
gsd©a
.
aş
->
aş_
[
gid
].
de¡
[
šdex
][
i
].
d©a
 = 0;

313 
gsd©a
.
aş
->
aş_
[
gid
].
de¡
[
šdex
][
i
].
g
 = 0;

314 
gsd©a
.
aş
->
aş_
[
gid
].
de¡_út
[
šdex
]--;

315 
	`cvmx_¥šlock_uÆock
(&
gsd©a
.
aş
->
aş_
[
gid
].
lock
);

316 
	`MC_PRINTF_DEBUG
("the ip is inhe destip bucket, delete it\n");

320 
	`MC_PRINTF_INFO
("the ip isn't inhe destip bucket\n");

321 
	`cvmx_¥šlock_uÆock
(&
gsd©a
.
aş
->
aş_
[
gid
].
lock
);

323 
	}
}

325 
šlše
 
ušt32_t
 
	$aş__g‘_æag
(
ušt8_t
 
gid
, 
ušt32_t
 
gid
){

326  
gsd©a
.
aş
->
aş_
[
gid
].
æag
[
gid
];

327 
	}
}

329 
šlše
 
ušt32_t
 
	$aş__g‘
(
ušt8_t
 
gid
, 
ušt32_t
 
gid
){

330  
gsd©a
.
aş
->
aş_
[
gid
].
g
[
gid
];

331 
	}
}

333 
šlše
 
	$mµ_d–_
(
ušt8_t
 
gid
, 
ušt32_t
 
gid
){

334 
ušt32_t
 

;

335 if(
gid
>=
MAX_ACL_IP_NUM
) ;

336 if((

=
gsd©a
.
aş
->
aş_
[
gid
].
g
[
gid
])==0) ;

338 
ušt32_t
 
æag
=
gsd©a
.
aş
->
aş_
[
gid
].
æag
[
gid
];

339 
æag
) {

340 
FLAG_SRC_IP
:

341 
	`mµ_d–_¤c_
(
gid
, 
gid
, 

);

343 
FLAG_DEST_IP
:

344 
	`mµ_d–_de¡_
(
gid
, 
gid
, 

);

350 
	}
}

	@frcore/frcore_alg.c

1 
	~"äcÜe_®g.h
"

3 #ià
FRC_CONFIG_VLAN_CHECK


4 
	g4b8
[8] = {0, 2, 4, 6, 8, 12, 16, 24};

5 
	g4b4
[4] = {0, 4, 8, 16};

6 
	g6b8
[8] = {0, 2, 4, 8, 16, 24, 32, 48};

7 
	g6b4
[4] = {0, 4, 8, 16};

9 
	#SDIP_MAX_NUM
 256

	)

269 
ušt16_t
 
	gsd_vÏn_šdex
[
SDIP_MAX_NUM
] = {

724 
ušt32_t
 
	$6_to_eid
(
6_pkt_t
 *
6_pkt
, 
HASH_EM
 
hash
)

726 
eid
 = 0, 
i
;

727 
ušt32_t
 *
32
 = 
NULL
;

728 
bcm_6_t
 
s_d©a
 = {}, 
d_d©a
 = {};

730 
	`memıy
(
s_d©a
, 
6_pkt
->
s6_d©a
, (sip_data));

731 
	`memıy
(
d_d©a
, 
6_pkt
->
d6_d©a
, (dip_data));

743 
hash
)

745 
FS_HSEL_NULL
:

746 
eid
 = -1;

749 
FS_HSEL_SIP
:

751 
32
 = (
ušt32_t
*)
s_d©a
;

761 
i
 = 0; i < 7; i++)

763 
	`BIT_SET
(
eid
, 
i
, 
	`BIT_GET
(
32
[3 - 
6b8
[i] / 32], ip6b8[i]%32));

769 
FS_HSEL_DIP
:

771 
32
 = (
ušt32_t
*)
d_d©a
;

772 
i
 = 0; i < 7; i++)

774 
	`BIT_SET
(
eid
, 
i
, 
	`BIT_GET
(
32
[3 - 
6b8
[i] / 32], ip6b8[i]%32));

779 
FS_HSEL_SDIP
:

781 
32
 = (
ušt32_t
*)
s_d©a
;

782 
i
 = 0; i < 4; i++)

784 
	`BIT_SET
(
eid
, 
i
, 
	`BIT_GET
(
32
[3 - 
6b4
[i] / 32], ip6b4[i]%32));

786 
eid
 <<= 4;

787 
32
 = (
ušt32_t
*)
d_d©a
;

788 
i
 = 0; i < 4; i++)

790 
	`BIT_SET
(
eid
, 
i
, 
	`BIT_GET
(
32
[3 - 
6b4
[i] / 32], ip6b4[i]%32));

792 
eid
 = 
sd_vÏn_šdex
[eid % 
SDIP_MAX_NUM
];

800  
eid
;

801 
	}
}

804 #ià
FRC_CONFIG_VLAN_IV


805 
CVMX_SHARED
 
ušt32_t
 
hash_s4_mask
;

806 
CVMX_SHARED
 
ušt32_t
 
hash_d4_mask
;

807 
CVMX_SHARED
 
bcm_6_t
 
hash_s6_mask
;

808 
CVMX_SHARED
 
bcm_6_t
 
hash_d6_mask
;

810 
ušt32_t
 
	$6_to_eid_Ãw
(
6_pkt_t
 *
6_pkt
, 
HASH_EM
 
hash
)

812 
eid
 = 0, 
i
;

813 
bcm__t
 
sw_s
 = 0, 
sw_d
 = 0;

814 
ušt32_t
 
s32
[4] = {}, 
d32
[4] = {};

815 
bcm_6_t
 
s_d©a
 = {}, 
d_d©a
 = {};

816 *
p
 = 
NULL
 , *
q
 = NULL;

818 
	`memıy
(
s_d©a
, 
6_pkt
->
s6_d©a
, (sip_data));

819 
	`memıy
(
d_d©a
, 
6_pkt
->
d6_d©a
, (dip_data));

820 
i
 = 0; i < 16; i++)

822 
s_d©a
[
i
] &ğ
hash_s6_mask
[i];

823 
d_d©a
[
i
] &ğ
hash_d6_mask
[i];

826 
p
 = (*)
s_d©a
;

827 
q
 = (*)
d_d©a
;

829 
i
 = 0; i < 4; i++)

831 
	`UNPACK_U32
(
p
, 
s32
[
i
]);

832 
	`UNPACK_U32
(
q
, 
d32
[
i
]);

833 ià(
i
)

835 
s32
[
i
] ^= sip32[i-1];

836 
d32
[
i
] ^= dip32[i-1];

839 
sw_s
 = 
s32
[
i
-1];

840 
sw_d
 = 
d32
[
i
-1];

843 
hash
)

845 
FS_HSEL_NULL
:

846 
eid
 = -1;

849 
FS_HSEL_SIP
:

851 
eid
 = 
sw_s
;

855 
FS_HSEL_DIP
:

857 
eid
 = 
sw_d
;

861 
FS_HSEL_SDIP
:

863 
eid
 = 
sw_s
 + 
sw_d
;

871  
eid
;

872 
	}
}

875 
ušt32_t
 
	$4_to_eid_Ãw
(
4_pkt_t
 *
4_pkt
, 
HASH_EM
 
hash
)

877 
eid
 = 0;

878 
bcm__t
 
s_d©a
 = 
4_pkt
->sip_data;

879 
bcm__t
 
d_d©a
 = 
4_pkt
->dip_data;

884 
s_d©a
 &ğ
hash_s4_mask
;

885 
d_d©a
 &ğ
hash_d4_mask
;

886 
hash
)

888 
FS_HSEL_NULL
:

889 
eid
 = -1;

892 
FS_HSEL_SIP
:

894 
eid
 = 
s_d©a
;

898 
FS_HSEL_DIP
:

900 
eid
 = 
d_d©a
;

904 
FS_HSEL_SDIP
:

906 
eid
 = 
s_d©a
 + 
d_d©a
;

914  
eid
;

915 
	}
}

918 
ušt32_t
 
	$4_to_eid
(
4_pkt_t
 *
4_pkt
, 
HASH_EM
 
hash
)

920 
eid
 = 0, 
i
;

921 
bcm__t
 
s_d©a
 = 
4_pkt
->sip_data;

922 
bcm__t
 
d_d©a
 = 
4_pkt
->dip_data;

924 
hash
)

926 
FS_HSEL_NULL
:

927 
eid
 = -1;

930 
FS_HSEL_SIP
:

932 
i
 = 0; i < 7; i++)

934 
	`BIT_SET
(
eid
, 
i
, 
	`BIT_GET
(
s_d©a
, 
4b8
[i]));

939 
FS_HSEL_DIP
:

941 
i
 = 0; i < 7; i++)

943 
	`BIT_SET
(
eid
, 
i
, 
	`BIT_GET
(
d_d©a
, 
4b8
[i]));

948 
FS_HSEL_SDIP
:

950 
i
 = 0; i < 4; i++)

952 
	`BIT_SET
(
eid
, 
i
, 
	`BIT_GET
(
s_d©a
, 
4b4
[i]));

954 
eid
 <<= 4;

955 
i
 = 0; i < 4; i++)

957 
	`BIT_SET
(
eid
, 
i
, 
	`BIT_GET
(
d_d©a
, 
4b4
[i]));

959 
eid
 = 
sd_vÏn_šdex
[eid % 
SDIP_MAX_NUM
];

967  
eid
;

968 
	}
}

972 
	$eid_to_vÏn_Ãw
(
ušt32_t
 
eid
, 
IP_TYPE
 
IPTP
, ušt32_ˆ
vÏn_n
, ušt32_ˆ
vÏn_0
, 
HASH_EM
 
hash
)

974 
ušt32_t
 
vÏnid
 = -1;

976 
vÏnid
 = 
eid
 % 
vÏn_n
 + 
vÏn_0
;

977  
vÏnid
;

978 
	}
}

981 
	$eid_to_vÏn
(
ušt32_t
 
eid
, 
IP_TYPE
 
IPTP
, ušt32_ˆ
vÏn_n
, ušt32_ˆ
vÏn_0
, 
HASH_EM
 
hash
)

983 
ušt32_t
 
vÏnid
 = -1;

984 if(
FS_HSEL_SDIP
 =ğ
hash
)

986 
vÏnid
 = 
eid
 % 
vÏn_n
 + 
vÏn_0
;

987  
vÏnid
;

990 ià(
IPV4
 =ğ
IPTP
)

992 
vÏnid
 = (
eid
 + 
E0
è% 
vÏn_n
 + 
vÏn_0
;

994 ià(
IPV6
 =ğ
IPTP
)

996 
vÏnid
 = (
eid
 + 
E0
 + 
EMAX4
è% 
vÏn_n
 + 
vÏn_0
;

999  
vÏnid
;

1000 
	}
}

1002 
ušt32_t
 
	$4_ÿlc_vÏn
(
4_pkt_t
 *
4_pkt
, 
HASH_EM
 
hash
, 
ušt32_t
 
vÏn_n
, ušt32_ˆ
vÏn_0
)

1004 
eid
, 
vÏnid
;

1005 #ià
FRC_CONFIG_VLAN_IV


1006 
eid
 = 
	`4_to_eid_Ãw
(
4_pkt
, 
hash
);

1008 
eid
 = 
	`4_to_eid
(
4_pkt
, 
hash
);

1010 ià(-1 =ğ
eid
)

1014 #ià
FRC_CONFIG_VLAN_IV


1015 
vÏnid
 = 
	`eid_to_vÏn_Ãw
(
eid
, 
IPV4
, 
vÏn_n
, 
vÏn_0
, 
hash
);

1017 
vÏnid
 = 
	`eid_to_vÏn
(
eid
, 
IPV4
, 
vÏn_n
, 
vÏn_0
, 
hash
);

1019 ià(
vÏnid
 > 4095)

1024  
vÏnid
;

1025 
	}
}

1027 
ušt32_t
 
	$6_ÿlc_vÏn
(
6_pkt_t
 *
6_pkt
, 
HASH_EM
 
hash
, 
ušt32_t
 
vÏn_n
, ušt32_ˆ
vÏn_0
)

1029 
eid
, 
vÏnid
;

1031 #ià
FRC_CONFIG_VLAN_IV


1032 
eid
 = 
	`6_to_eid_Ãw
(
6_pkt
, 
hash
);

1034 
eid
 = 
	`6_to_eid
(
6_pkt
, 
hash
);

1036 ià(-1 =ğ
eid
)

1040 #ià
FRC_CONFIG_VLAN_IV


1041 
vÏnid
 = 
	`eid_to_vÏn_Ãw
(
eid
, 
IPV6
, 
vÏn_n
, 
vÏn_0
, 
hash
);

1043 
vÏnid
 = 
	`eid_to_vÏn
(
eid
, 
IPV6
, 
vÏn_n
, 
vÏn_0
, 
hash
);

1046 ià(
vÏnid
 > 4095)

1051  
vÏnid
;

1052 
	}
}

	@frcore/frcore_alg.h

1 #iâdeà
__TYPES_H__


2 
	#__TYPES_H__


	)

4 
	~"cvmx-cÚfig.h
"

5 
	~"cvmx.h
"

6 
	~"cvmx-wqe.h
"

7 
	~"cvmx-çu.h
"

8 
	~"cvmx-©omic.h
"

9 
	~"cvmx-¥šlock.h
"

11 
	~"äcÜe_š™.h
"

12 
	~"äcÜe_cÚfig.h
"

14 
	~"äcÜe_debug.h
"

15 
	~"äc_·ck.h
"

17 #ià
FRC_CONFIG_VLAN_CHECK


18 
	#E0
 2001

	)

19 
	#EMAX4
 256

	)

20 
	#EMAX6
 256

	)

22 
	tbcm__t
 ;

23 
	tbcm_6_t
[16] ;

25 
	#BIT
(
b
è(1ULL<<b)

	)

26 
	#BIT_GET
(
v
,
b
è(!!(v & 
	`BIT
(b)))

	)

27 
	#BIT_SET
(
v
,
b
,
v®
) \

30 ià(
v®
è
v
 |ğ
	`BIT
(
b
); \

31 
v
 &ğ(~(
	`BIT
(
b
))); \

32 }0)

	)

36 
	mFS_HSEL_NULL
,

37 
	mFS_HSEL_SIP
,

38 
	mFS_HSEL_DIP
,

39 
	mFS_HSEL_SDIP


40 }
	tHASH_EM
;

44 
	mIPV4
,

45 
	mIPV6


46 }
	tIP_TYPE
;

48 
	s4_pkt


50 
bcm__t
 
	ms_d©a
;

51 
bcm__t
 
	md_d©a
;

52 
bcm__t
 
	ms_mask
;

53 
bcm__t
 
	md_mask
;

54 }
	t4_pkt_t
;

56 
	s6_pkt


58 
bcm_6_t
 
	ms6_d©a
;

59 
bcm_6_t
 
	md6_d©a
;

60 
bcm_6_t
 
	ms6_mask
;

61 
bcm_6_t
 
	md6_mask
;

62 }
	t6_pkt_t
;

64 
ušt32_t
 
4_ÿlc_vÏn
(
4_pkt_t
 *
4_pkt
, 
HASH_EM
 
hash
, ušt32_ˆ
vÏn_n
, ušt32_ˆ
vÏn_0
);

65 
ušt32_t
 
6_ÿlc_vÏn
(
6_pkt_t
 *
6_pkt
, 
HASH_EM
 
hash
, ušt32_ˆ
vÏn_n
, ušt32_ˆ
vÏn_0
);

	@frcore/frcore_bmm.c

1 
	~"äcÜe.h
"

2 
	~"äcÜe_cmd.h
"

3 
	~"äcÜe_misc.h
"

4 
	~"äcÜe_s¢.h
"

6 
	~"cvmx-mdio.h
"

7 
	~"cvmx-twsi.h
"

9 
äcÜe_v”siÚ_g‘
();

12 
ušt8_t
 
	gdma_block_size
 = 8;

13 
ušt8_t
 
	gloİback_où0
 = 0;

14 
ušt8_t
 
	gloİback_où1
 = 0;

15 
CVMX_SHARED
 
ušt8_t
 
	gwÜk_mode_où0
 = 0;

16 
CVMX_SHARED
 
ušt8_t
 
	gwÜk_mode_où1
 = 0;

18 
	$loİback_´oûss
(
ušt8_t
 
pÜt
, ušt8_ˆ
mode
)

20 
rv
;

21 
ušt16_t
 
phyid
 = 0 ,
v®ue
;

22 ià(
pÜt
 == 0)

24 
phyid
 = 0;

26 ià(
pÜt
 == 16)

28 
phyid
 = 1;

30 
mode
)

33 
v®ue
 = 
	`cvmx_mdio_45_»ad
(0, 
phyid
, 1, 0xc80a);

34 
v®ue
 |= 1;

35 
rv
 = 
	`cvmx_mdio_45_wr™e
(0, 
phyid
, 1, 0xc80a, 
v®ue
);

38 
rv
 = 
FRE_SUCCESS
;

41 
v®ue
 = 
	`cvmx_mdio_45_»ad
(0, 
phyid
, 1, 0);

42 
v®ue
 |= 1;

43 
rv
 = 
	`cvmx_mdio_45_wr™e
(0, 
phyid
, 1, 0, 
v®ue
);

46 
rv
 = 
FRE_SUCCESS
;

49 
v®ue
 = 
	`cvmx_mdio_45_»ad
(0, 
phyid
, 1, 0xc80a);

50 
v®ue
 &= 0xfffe;

51 
rv
 = 
	`cvmx_mdio_45_wr™e
(0, 
phyid
, 1, 0xc80a, 
v®ue
);

52 
v®ue
 = 
	`cvmx_mdio_45_»ad
(0, 
phyid
, 1, 0);

53 
v®ue
 &= 0xffe;

54 
rv
 = 
	`cvmx_mdio_45_wr™e
(0, 
phyid
, 1, 0, 
v®ue
);

57 
rv
 = 
FRE_FAIL
;

60  
rv
;

61 
	}
}

63 
	$dma_mem_d©a_»ad
(
äc_bdd_dma_»ad_š_t
 *
¿nge
, 
ušt8_t
 *
d©a
)

66 
	}
}

68 
	$äcÜe_cmd_bdd_¡©us_g‘
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

70 
rv
;

71 
v®ue
;

72 
ušt64_t
 
loÿl
, 
»mÙe
;

73 
äc_bdd_¡©us_out_t
 
bdd_¡©us
;

74 
	`mem£t
(&
bdd_¡©us
, 0 ,(
äc_bdd_¡©us_out_t
));

76 
rv
 = 
	`cvmx_twsix_»ad_Ÿ
(1, 0x4d, 0, 1, 1, &
loÿl
);

77 
	`FRCORE_CMD
("RV = %d.\n", 
rv
);

78 
rv
 = 
	`cvmx_twsix_»ad_Ÿ
(1, 0x4d, 1, 1, 1, &
»mÙe
);

79 
	`FRCORE_CMD
("RV = %d.\n", 
rv
);

81 
bdd_¡©us
.
‹mp
.
loÿl
 =†ocal;

82 
bdd_¡©us
.
‹mp
.
»mÙe
 =„emote;

85 
v®ue
 = 
	`cvmx_mdio_»ad
(1, 11, 0x4);

87 
bdd_¡©us
.
où0
.
lšk
 = (
v®ue
 & 4)?1:0;;

88 
bdd_¡©us
.
où0
.
’abË
 = 1;

89 
bdd_¡©us
.
où0
.
wÜk_mode
 = 
wÜk_mode_où0
;

90 
bdd_¡©us
.
où0
.
loİback_mode
 = 
loİback_où0
;

91 
bdd_¡©us
.
où0
.
İtiÿl_¡©us
 = (
v®ue
 & 1)?1:0;;

92 
bdd_¡©us
.
où0
.
İtiÿl
 = 20;

93 
bdd_¡©us
.
où0
.
rx_pkts_¿‹
 = 10;

94 
bdd_¡©us
.
où0
.
rx_by‹s_¿‹
 = 1000;

95 
bdd_¡©us
.
où0
.
tx_pkts_¿‹
 = 5;

96 
bdd_¡©us
.
où0
.
tx_by‹s_¿‹
 = 500;

98 
bdd_¡©us
.
où1
.
lšk
 = (
v®ue
 & 8)?1:0;;

99 
bdd_¡©us
.
où1
.
’abË
 = 1;

100 
bdd_¡©us
.
où1
.
wÜk_mode
 = 
wÜk_mode_où1
;

101 
bdd_¡©us
.
où1
.
loİback_mode
 = 
loİback_où1
;

102 
bdd_¡©us
.
où1
.
İtiÿl_¡©us
 = (
v®ue
 & 2)?1:0;;

103 
bdd_¡©us
.
où1
.
İtiÿl
 = 10;

104 
bdd_¡©us
.
où1
.
rx_pkts_¿‹
 = 50;

105 
bdd_¡©us
.
où1
.
rx_by‹s_¿‹
 = 5000;

106 
bdd_¡©us
.
où1
.
tx_pkts_¿‹
 = 10;

107 
bdd_¡©us
.
où1
.
tx_by‹s_¿‹
 = 2000;

110 
bdd_¡©us
.
dma_block_size
 = dma_block_size;

111 #ià
FRC_CONFIG_RULE


112 
bdd_¡©us
.
ruË_max
 = 
RULE_MAX
;

114 #ià
FRC_CONFIG_SSN


115 
bdd_¡©us
.
s¢_max
 = 
SSN_TOTAL_NUM
;

117 
bdd_¡©us
.
ruÂšg_¡©us
 = 1;

119 
	`memıy
(
outbuf
, &
bdd_¡©us
, (
äc_bdd_¡©us_out_t
));

120 *
Ş’
 = (
äc_bdd_¡©us_out_t
);

127  
FRE_SUCCESS
;

129 
	}
}

132 
	$äcÜe_cmd_bdd_šfo_g‘
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

134 
äc_bdd_šfo_out_t
 
bdd_šfo
;

135 
	`mem£t
(&
bdd_šfo
, 0 ,(
äc_bdd_šfo_out_t
));

137 
	`äcÜe_v”siÚ_g‘
(&
bdd_šfo
.
äcÜe_v”siÚ
);

139 
bdd_šfo
.
oùdrv_v”siÚ
.
majÜ
 = 1;

140 
bdd_šfo
.
oùdrv_v”siÚ
.
mšÜ
 = 5;

141 
bdd_šfo
.
oùdrv_v”siÚ
.
bud
 = 100;

143 
bdd_šfo
.
oùnic_v”siÚ
.
majÜ
 = 1;

144 
bdd_šfo
.
oùnic_v”siÚ
.
mšÜ
 = 7;

145 
bdd_šfo
.
oùnic_v”siÚ
.
bud
 = 101;

147 
bdd_šfo
.
ıld_v”siÚ
 = 0x18;

148 
bdd_šfo
.
pÜt_numb”
 = 2;

150 
	`memıy
(
outbuf
, &
bdd_šfo
, (
äc_bdd_šfo_out_t
));

151 *
Ş’
 = (
äc_bdd_šfo_out_t
);

153  
FRE_SUCCESS
;

156 
	}
}

161 
	$äcÜe_cmd_£t_loİback_mode
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

163 
äc_bdd_£t_loİback_š_t
 *
mode
 = (äc_bdd_£t_loİback_š_ˆ*è
·¿m
;

165 ià(
mode
->
pÜt
 == 0)

167 
loİback_où0
 = 
mode
->
loİback
;

170 ià(
mode
->
pÜt
 == 16)

172 
loİback_où1
 = 
mode
->
loİback
;

177  
FRE_FAIL
;

180 ià(
	`loİback_´oûss
(
mode
->
pÜt
, mode->
loİback
))

182  
FRE_FAIL
;

185 
	`´štf
("$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$\n");

186 
	`´štf
("pÜˆğ%d,†oİback_modğ%d \n", 
mode
->
pÜt
, mode->
loİback
);

187 
	`´štf
("$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$\n");

189  
FRE_SUCCESS
;

190 
	}
}

193 
	$äcÜe_cmd_£t_wÜk_mode
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

195 
äc_bdd_wÜkmode_£t_š_t
 *
wÜk_mode
 = (äc_bdd_wÜkmode_£t_š_ˆ*)
·¿m
;

197 ià(
wÜk_mode
->
où
 == 0)

199 
wÜk_mode_où0
 = 
wÜk_mode
->
mode
;

202 ià(
wÜk_mode
->
où
 == 16)

204 
wÜk_mode_où1
 = 
wÜk_mode
->
mode
;

209  
FRE_FAIL
;

212 
	`´štf
("$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$\n");

213 
	`´štf
("pÜˆğ%d, modğ%d \n", 
wÜk_mode
->
où
, wÜk_mode->
mode
);

214 
	`´štf
("$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$\n");

216  
FRE_SUCCESS
;

217 
	}
}

220 
	$äcÜe_cmd_’abË_pÜt
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

222 
äc_bdd_£t_pÜt_š_t
 *
pÜt_’abË
 = (äc_bdd_£t_pÜt_š_ˆ*)
·¿m
;

224 
	`´štf
("$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$\n");

225 
	`´štf
("pÜˆğ%d,ƒÇbË = %d \n", 
pÜt_’abË
->
pÜt
,…Üt_’abË->
’abË
);

226 
	`´štf
("$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$\n");

227 ià(
pÜt_’abË
->
pÜt
 == 0 ||…ort_enable->port == 16)

229 
oùnic
->
pÜt
[
pÜt_’abË
->pÜt].
rx_Ú
 =…Üt_’abË->
’abË
;

231  
FRE_FAIL
;

234  
FRE_SUCCESS
;

236 
	}
}

239 
	$äcÜe_cmd_fÜû_lšk
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

241 
äc_bdd_fÜû_lšk_š_t
 *
fÜû_lšk
 = (äc_bdd_fÜû_lšk_š_ˆ*)
·¿m
;

243 
	`´štf
("$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$\n");

244 
	`´štf
("pÜˆğ%d,†šk = %d \n", 
fÜû_lšk
->
où
, fÜû_lšk->
lšk
);

245 
	`´štf
("$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$\n");

247  
FRE_SUCCESS
;

248 
	}
}

251 
	$äcÜe_cmd_log_£t
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

253 
äc_bdd_log_š_t
 *
log_šfo
 = (äc_bdd_log_š_ˆ*)
·¿m
;

255 
	`´štf
("$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$\n");

256 
	`´štf
("log = %d,ƒÇbË = %d \n", 
log_šfo
->
log
,†og_šfo->
’abË
);

257 
	`´štf
("$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$\n");

259  
FRE_SUCCESS
;

260 
	}
}

263 
	$äcÜe_cmd_pow”off
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

265 
rv
;

266 
rv
 = 
	`cvmx_mdio_wr™e
(1, 11, 0xd, 2);

267 ià(0 !ğ
rv
)

269 
	`FRCORE_ERROR
("Poweroffhe frc card fail!\n");

270  
FRE_FAIL
;

273  
FRE_SUCCESS
;

274 
	}
}

277 
	$äcÜe_cmd_dma_block_£t
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

279 
ušt8_t
 *
size
 = (ušt8_ˆ*)
·¿m
;

281 
dma_block_size
 = *
size
;

283  
FRE_SUCCESS
;

284 
	}
}

287 
	$äcÜe_cmd_dma_d©a_»ad
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

289 
i
;

290 
äc_bdd_dma_»ad_š_t
 *
¿nge
 = (äc_bdd_dma_»ad_š_ˆ*)
·¿m
;

291 
ušt8_t
 
d©a
[256];

294 
	`´štf
("sizğ%d ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n", 
¿nge
->
size
);

296 
i
 = 0; i<()
¿nge
->
size
;i++)

298 
d©a
[
i
] = i +1;

301 
	`memıy
(
outbuf
, 
d©a
, 
¿nge
->
size
);

302 *
Ş’
 = 
¿nge
->
size
;

304 
i
 = 0; i < ()
¿nge
->
size
; i++)

306 
	`´štf
("0x%.2x\n", ((
ušt8_t
 *)
outbuf
)[
i
]);

309  
FRE_SUCCESS
;

310 
	}
}

314 
	$äcÜe_bmm_š™
()

316 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_GET_BDD_STATUS
, 
äcÜe_cmd_bdd_¡©us_g‘
);

317 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_GET_BDD_INFO
, 
äcÜe_cmd_bdd_šfo_g‘
);

318 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_SET_LOOPBACK_MODE
, 
äcÜe_cmd_£t_loİback_mode
);

319 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_SET_WORK_MODE
, 
äcÜe_cmd_£t_wÜk_mode
);

320 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_BDD_PORT_ENABLE
, 
äcÜe_cmd_’abË_pÜt
);

321 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_FORCE_LINK
, 
äcÜe_cmd_fÜû_lšk
);

322 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_CONFIG_LOG_SW
, 
äcÜe_cmd_log_£t
);

323 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_POWEROFF
, 
äcÜe_cmd_pow”off
);

324 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_SET_DMA_BLOCK_SIZE
, 
äcÜe_cmd_dma_block_£t
);

325 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_READ_DMA
, 
äcÜe_cmd_dma_d©a_»ad
);

328 
	}
}

	@frcore/frcore_bmm.h

1 #iâdeà
__FRCORE_BMM_H__


2 
	#__FRCORE_BMM_H__


	)

4 
äcÜe_bmm_š™
();

	@frcore/frcore_chan.c

1 
	~"äcÜe_pkt.h
"

2 
	~"äcÜe_cmd.h
"

3 
	~"äcÜe_dma.h
"

5 
	~"äc_dma.h
"

6 
	~"äc_ut.h
"

8 
	~"äcÜe_¡©.h
"

9 
	~"äc_üc8.h
"

11 #ià
FRC_CONFIG_SIMPLE_PACKAGE


12 
CVMX_SHARED
 
äcÜe_sim¶e_·ckage_chª_t
 *
	gäcÜe_sim¶e_·ckage_chªs
 = 
NULL
;

13 
CVMX_SHARED
 
äcÜe_sim¶e_·ckage_fifo_t
 *
	gäcÜe_sim¶e_·ckage_fifos
 = 
NULL
;

15 
CVMX_SHARED
 
ušt64_t
 
ıu_äeq
;

16 
ušt8_t
 
	gudp_block_exhau¡
[
FRC_SIMPLE_PACKAGE_SIMPLE_CHAN_FIFO_NUM
] = {0};

17 
ušt64_t
 
	gudp_Ï¡_di¥Ïy
[
FRC_SIMPLE_PACKAGE_SIMPLE_CHAN_FIFO_NUM
] = {0};

18 
ušt8_t
 
	gruË_block_exhau¡
[
FRC_SIMPLE_PACKAGE_SIMPLE_CHAN_FIFO_NUM
] = {0};

19 
ušt64_t
 
	gruË_Ï¡_di¥Ïy
[
FRC_SIMPLE_PACKAGE_SIMPLE_CHAN_FIFO_NUM
] = {0};

21 #ià
FRC_CONFIG_SIMPLE_PACKAGE


22 
	#FRCORE_SIMPLE_PACKAGE_CHAN_AVAIL_LOCK
(
_chª
è
	`cvmx_¥šlock_lock
(&((_chª)->
ava_lock
))

	)

23 
	#FRCORE_SIMPLE_PACKAGE_CHAN_AVAIL_UNLOCK
(
_chª
è
	`cvmx_¥šlock_uÆock
(&((_chª)->
ava_lock
))

	)

24 
	#FRCORE_SIMPLE_PACKAGE_CHAN_COMPL_LOCK
(
_chª
è
	`cvmx_¥šlock_lock
(&((_chª)->
com¶_lock
))

	)

25 
	#FRCORE_SIMPLE_PACKAGE_CHAN_COMPL_UNLOCK
(
_chª
è
	`cvmx_¥šlock_uÆock
(&((_chª)->
com¶_lock
))

	)

28 
	$äcÜe_cmd_£tup_sim¶e_·ckage_chªs
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

30 
i
;

31 
äcÜe_sim¶e_·ckage_chª_t
 *
chª
 = 
NULL
;

32 
äcÜe_sim¶e_·ckage_fifo_t
 *
fifo
 = 
NULL
;

33 
äc_dma_chª_desc_t
 *
desc
;

34 *
Ş’
 = 0;

36 
desc
 = (
äc_dma_chª_desc_t
 *è
·¿m
;

38 
	`FRCORE_CMD
("chan_id %lld, ctrl_size %llx, ctrl_addr 0x%llx.\n",

39 (
ULL
è
desc
->
ty³
, (ULLèdesc->
ù¾_size
, (ULLèdesc->
ù¾_addr
);

41 ià(
äcÜe_sim¶e_·ckage_chªs
 =ğ
NULL
) {

42 
	`FRCORE_ERROR
("\n");

43  
FRE_INIT
;

46 ià(
desc
->
ty³
 >ğ
FRC_DMA_SIMPLE_PACKAGE_CHAN_NUM
) {

47 
	`FRCORE_ERROR
("desc->ty³(%Îdè>ğFRC_DMA_SIMPLE_PACKAGE_CHAN_NUM(%d)\n", (
ULL
è
desc
->
ty³
, 
FRC_DMA_SIMPLE_PACKAGE_CHAN_NUM
);

48  
FRE_EXCEED
;

51 ià((
desc
->
ty³
 !ğ
FRC_WORK_UDP
è&& (desc->ty³ !ğ
FRC_WORK_RULE
))

53 
	`FRCORE_ERROR
("UnkowÀty³ %Îd!\n", (
ULL
)
desc
->
ty³
);

54  
FRE_PARAM
;

57 
chª
 = &
äcÜe_sim¶e_·ckage_chªs
[
desc
->
ty³
];

60 
äcÜe_dma_sÿ‰”_desc_t
 
dma_¬g
;

62 
	`mem£t
(&
dma_¬g
, 0, (
äcÜe_dma_sÿ‰”_desc_t
));

64 
dma_¬g
.
loÿl_±r
[0] = (
ušt8_t
 *è&
chª
->
ava_widx
;

65 
dma_¬g
.
»mÙe_addr
[0] = 
desc
->
ù¾_addr
 + 
FRC_DMA_SIMPLE_CHAN_AVAIL_WIDX_OFFSET
;

66 
dma_¬g
.
size
[0] = (
chª
->
ava_widx
);

68 
dma_¬g
.
loÿl_±r
[1] = (
ušt8_t
 *è&
chª
->
ava_ridx
;

69 
dma_¬g
.
»mÙe_addr
[1] = 
desc
->
ù¾_addr
 + 
FRC_DMA_SIMPLE_CHAN_AVAIL_RIDX_OFFSET
;

70 
dma_¬g
.
size
[1] = (
chª
->
ava_ridx
);

72 
dma_¬g
.
loÿl_±r
[2] = (
ušt8_t
 *è&
chª
->
com¶_widx
;

73 
dma_¬g
.
»mÙe_addr
[2] = 
desc
->
ù¾_addr
 + 
FRC_DMA_SIMPLE_CHAN_COMPL_WIDX_OFFSET
;

74 
dma_¬g
.
size
[2] = (
chª
->
com¶_widx
);

76 
dma_¬g
.
loÿl_±r
[3] = (
ušt8_t
 *è&
chª
->
com¶_ridx
;

77 
dma_¬g
.
»mÙe_addr
[3] = 
desc
->
ù¾_addr
 + 
FRC_DMA_SIMPLE_CHAN_COMPL_RIDX_OFFSET
;

78 
dma_¬g
.
size
[3] = (
chª
->
com¶_ridx
);

79 
dma_¬g
.
numb”
 = 4;

81 ifĞ
	`äcÜe_dma_sÿ‰”
(
DMA_DIR_RECV
, &
dma_¬g
)) {

82 
	`FRCORE_ERROR
("Copy ctrl‡rg from„emote fail!\n");

83 
	`FRCORE_STAT_INC
(
¡©_dma_”rÜs
);

84  
FRE_DMA
;

86 
chª
->
ù¾_addr
 = 
desc
->ctrl_addr;

87 
chª
->
ty³
 = 
desc
->type;

89 
	`FRCORE_CMD
("CHAN %lld(%s): CTRL_ADDR 0x%llx; AVAIL RIDX 0x%llX, WIDX 0x%llX; COMPL RIDX 0x%llX, WIDX 0x%llX.\n",

90 (
ULL
è
chª
->
ty³
, (ULLè(chª->ty³ =ğ
FRC_WORK_UDP
è? "UDP" : "RULE", (ULLèchª->
ù¾_addr
,

91 (
ULL
è(
chª
->
ava_ridx
), (ULLè(chª->
ava_widx
),

92 (
ULL
è(
chª
->
com¶_ridx
), (ULLè(chª->
com¶_widx
));

96 
	`cvmx_¥šlock_š™
(&
chª
->
ava_lock
);

97 
	`cvmx_¥šlock_š™
(&
chª
->
com¶_lock
);

98 
fifo
 = &
äcÜe_sim¶e_·ckage_fifos
[
desc
->
ty³
 * 
FRC_SIMPLE_PACKAGE_SIMPLE_CHAN_FIFO_NUM
];

99 
	`FRCORE_CMD
("fifo=%p\n", 
fifo
);

101 
i
 = 0; i < 
FRC_SIMPLE_PACKAGE_SIMPLE_CHAN_FIFO_NUM
; i++)

103 
	`cvmx_¥šlock_š™
(&
fifo
[
i
].
lock
);

104 
cvmx_wqe_t
 *
wqe
 = &
fifo
[
i
].wqe;

105 
	`mem£t
(
wqe
, 0, (
cvmx_wqe_t
));

106 
wqe
->
unu£d
 = 
FRCORE_WORK_CHAN
;

107 
wqe
->
´t
 = 0;

108 
wqe
->
g½
 = 
i
 + 1;

110 
wqe
->
g
 = wqe->
g½
;

111 
wqe
->
g_ty³
 = 
CVMX_POW_TAG_TYPE_ATOMIC
;

112 
wqe
->
·ck‘_d©a
[0] = (
ušt8_t
)
desc
->
ty³
;

113 
wqe
->
·ck‘_d©a
[1] = 
i
;

114 ià(
	`cvmx_tim_add_’Œy
(
wqe
, 
FRCORE_CHAN_TIMEOUT
, 
NULL
è!ğ
CVMX_TIM_STATUS_SUCCESS
) {

115 
	`FRCORE_ERROR
("dma chan fifoimer‡dd fail!\n");

116  
FRE_FAIL
;

121  
FRE_SUCCESS
;

122 
	}
}

124 
	$äcÜe_cmd_£tup_sim¶e_·ckage_chªs_‹¡
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

126 
i
;

127 
ušt64_t
 *
ty³
;

128 *
Ş’
 = 0;

130 
ty³
 = (
ušt64_t
 *è
·¿m
;

131 
	`´štf
("% %dy³=%d\n", 
__func__
, 
__LINE__
, ()*
ty³
);

133 
i
 = 0; i < 1; i++)

136 
cvmx_wqe_t
 *
wqe
 = 
	`cvmx_boÙmem_®loc
((cvmx_wqe_t), 0);;

137 
	`mem£t
(
wqe
, 0, (
cvmx_wqe_t
));

139 
wqe
->
unu£d
 = 
FRCORE_WORK_CHAN_TEST
;

140 
wqe
->
´t
 = 0;

141 
wqe
->
g½
 = 
i
 + 1;

143 
wqe
->
g
 = wqe->
g½
;

144 
wqe
->
g_ty³
 = 
CVMX_POW_TAG_TYPE_ATOMIC
;

145 
wqe
->
·ck‘_d©a
[0] = (
ušt8_t
)*
ty³
;

146 
wqe
->
·ck‘_d©a
[1] = 
i
;

148 ià(
	`cvmx_tim_add_’Œy
(
wqe
, 
FRCORE_CHAN_TIMEOUT
, 
NULL
è!ğ
CVMX_TIM_STATUS_SUCCESS
) {

149 
	`FRCORE_ERROR
("dma chanest fifoimer‡dd fail!\n");

150  
FRE_FAIL
;

154  
FRE_SUCCESS
;

155 
	}
}

158 
	$äcÜe_sim¶e_·ckage_chª_š™
()

160 
äcÜe_sim¶e_·ckage_chªs
 = 
	`cvmx_boÙmem_®loc
((
äcÜe_sim¶e_·ckage_chª_t
è* 
FRC_DMA_SIMPLE_PACKAGE_CHAN_NUM
, 0);

161 ià(
äcÜe_sim¶e_·ckage_chªs
 =ğ
NULL
)

163 
	`FRCORE_ERROR
("Alloccp dma queues fail!\n");

164  
FRE_MEMORY
;

167 
	`mem£t
(
äcÜe_sim¶e_·ckage_chªs
, 0, (
äcÜe_sim¶e_·ckage_chª_t
è* 
FRC_DMA_SIMPLE_PACKAGE_CHAN_NUM
);

168 
äcÜe_sim¶e_·ckage_chªs
[0].
ty³
 = 
FRC_WORK_UDP
;

169 
äcÜe_sim¶e_·ckage_chªs
[1].
ty³
 = 
FRC_WORK_RULE
;

171 
	`FRCORE_INIT
("CHAN[%Îd]‡ddr=%p\n", (
ULL
)
äcÜe_sim¶e_·ckage_chªs
[0].
ty³
, &frcore_simple_package_chans[0]);

172 
	`FRCORE_INIT
("CHAN[%Îd]‡ddr=%p\n", (
ULL
)
äcÜe_sim¶e_·ckage_chªs
[1].
ty³
, &frcore_simple_package_chans[1]);

173 
	`´štf
("Sim¶·ck‘ chªÃÈaddr=%p, size=0x%Îx\n", 
äcÜe_sim¶e_·ckage_chªs
,

174 (
ULL
)((
äcÜe_sim¶e_·ckage_chª_t
è* 
FRC_DMA_SIMPLE_PACKAGE_CHAN_NUM
));

175 
äcÜe_sim¶e_·ckage_fifos
 = 
	`cvmx_boÙmem_®loc
((
äcÜe_sim¶e_·ckage_fifo_t
è* 
FRC_SIMPLE_PACKAGE_FIFO_NUM
, 0);

176 ià(
äcÜe_sim¶e_·ckage_fifos
 =ğ
NULL
)

178 
	`FRCORE_ERROR
("Alloc simple…ackage fifo fail!\n");

179  
FRE_MEMORY
;

181 
	`mem£t
(
äcÜe_sim¶e_·ckage_fifos
, 0, (
äcÜe_sim¶e_·ckage_fifo_t
è* 
FRC_SIMPLE_PACKAGE_FIFO_NUM
);

182 
	`´štf
("Sim¶·ck‘ FIFO‡ddr=%°size=0x%Îx\n", 
äcÜe_sim¶e_·ckage_fifos
,

183 (
ULL
)((
äcÜe_sim¶e_·ckage_fifo_t
è* 
FRC_SIMPLE_PACKAGE_FIFO_NUM
));

184 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_CTRL
, 
CTRL_CMD_SETUP_SIMPLE_PACKAGE_CHAN
, 
äcÜe_cmd_£tup_sim¶e_·ckage_chªs
);

185 #ià
FRC_CONFIG_SIMPLE_PACKET_TEST
 || 
FRC_CONFIG_SSN_CHAN_TEST


186 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_TEST
, 
TEST_CMD_SIMPLE_PACKET_CHAN
, 
äcÜe_cmd_£tup_sim¶e_·ckage_chªs_‹¡
);

190 
	}
}

192 
äcÜe_sim¶e_·ckage_chª_t
 *

193 
	$äcÜe_sim¶e_·ckage_chª_g‘
(
ušt32_t
 
idx
)

195 
äcÜe_sim¶e_·ckage_chª_t
 *
chª
;

197 
chª
 = &
äcÜe_sim¶e_·ckage_chªs
[
idx
];

199  
chª
;

200 
	}
}

202 
äcÜe_sim¶e_·ckage_fifo_t
 *

203 
	$äcÜe_sim¶e_·ckage_fifo_g‘
(
ušt8_t
 
ty³
, ušt8_ˆ
idx
)

205 
äcÜe_sim¶e_·ckage_fifo_t
 *
fifo
;

206 
fifo
 = &
äcÜe_sim¶e_·ckage_fifos
[
ty³
 * 
FRC_SIMPLE_PACKAGE_SIMPLE_CHAN_FIFO_NUM
 + 
idx
];

207  
fifo
;

208 
	}
}

210 
	$äcÜe_sim¶e_·ckage_chª_ava_g‘
(
äcÜe_sim¶e_·ckage_chª_t
 *
chª
, 
äcÜe_sim¶e_·ckage_fifo_t
 *
fifo
,

211 
ušt64_t
 
numb”
)

213 
ušt64_t
 
ridx
, 
widx
, 
off£t
, 
Ën
, 
Ën1
, 
Ën2
, 
®’
 = 0;

214 
ušt8_t
 *
loÿl
;

215 
ušt64_t
 
»mÙe_addr
;

217 
	`FRCORE_SIMPLE_PACKAGE_CHAN_AVAIL_LOCK
(
chª
);

218 
loÿl
 = (
ušt8_t
 *è&
chª
->
ava_widx
;

219 
»mÙe_addr
 = 
chª
->
ù¾_addr
 + 
FRC_DMA_SIMPLE_CHAN_AVAIL_WIDX_OFFSET
;

220 
	`FRCORE_CYCLE_RECORDING
();

221 if(
	`äcÜe_cİy_äom_»mÙe
((
chª
->
ava_widx
), 
loÿl
, 
»mÙe_addr
)) {

222 
	`FRCORE_ERROR
("SYNC„idx & widx of‡vail„ing from„emote fail!\n");

223 
	`FRCORE_STAT_INC
(
¡©_dma_”rÜs
);

224 
	`FRCORE_SIMPLE_PACKAGE_CHAN_AVAIL_UNLOCK
(
chª
);

225  
FRE_DMA
;

227 
	`FRCORE_CYCLE_RECORDING
();

228 
ridx
 = 
chª
->
ava_ridx
;

229 
widx
 = 
chª
->
ava_widx
;

231 
Ën
 = 
numb”
;

233 
®’
 = (
widx
 - 
ridx
);

234 ià(
®’
 < 
Ën
)

236 
	`FRCORE_CHAN
("widx %lld„idx %lld,‡len %lld,†en %lld.\n",

237 (
ULL
è
widx
, (ULLè
ridx
, (ULLè
®’
, (ULLè
Ën
);

238 
	`FRCORE_STAT_INC
(
¡©_ava_g‘_no_¥aû
);

239 
	`FRCORE_SIMPLE_PACKAGE_CHAN_AVAIL_UNLOCK
(
chª
);

240  
FRE_NOSPACE
;

243 
off£t
 = 
ridx
 % 
FRC_SIMPLE_RING_BUFF_SIZE
;

245 
Ën1
 = (
FRC_SIMPLE_RING_BUFF_SIZE
 - 
off£t
è< 
Ën
 ? (FRC_SIMPLE_RING_BUFF_SIZE - offset) :†en;

247 
loÿl
 = (
ušt8_t
 *)
fifo
->
idx_buff
;

248 
»mÙe_addr
 = 
chª
->
ù¾_addr
 + 
FRC_DMA_SIMPLE_CHAN_AVAIL_RING_OFFSET
 + 
off£t
 * 
RING_BUFF_CELL_SIZE
;

250 if(
	`äcÜe_cİy_äom_»mÙe
(
Ën1
 * 
RING_BUFF_CELL_SIZE
, 
loÿl
, 
»mÙe_addr
)) {

251 
	`FRCORE_ERROR
("Copy‡vail„ing buff from„emote fail!\n");

252 
	`FRCORE_STAT_INC
(
¡©_dma_”rÜs
);

253 
	`FRCORE_SIMPLE_PACKAGE_CHAN_AVAIL_UNLOCK
(
chª
);

254  
FRE_DMA
;

256 
	`FRCORE_CYCLE_RECORDING
();

257 ià(
Ën1
 < 
Ën
)

259 
Ën2
 = 
Ën
 - 
Ën1
;

260 
loÿl
 = (
ušt8_t
 *è
fifo
->
idx_buff
 + 
Ën1
 * 
RING_BUFF_CELL_SIZE
;

261 
»mÙe_addr
 = 
chª
->
ù¾_addr
 + 
FRC_DMA_SIMPLE_CHAN_AVAIL_RING_OFFSET
;

263 if(
	`äcÜe_cİy_äom_»mÙe
(
Ën2
* 
RING_BUFF_CELL_SIZE
, 
loÿl
, 
»mÙe_addr
)) {

264 
	`FRCORE_ERROR
("Copy‡vail„ing buff from„emote fail!\n");

265 
	`FRCORE_STAT_INC
(
¡©_dma_”rÜs
);

266 
	`FRCORE_SIMPLE_PACKAGE_CHAN_AVAIL_UNLOCK
(
chª
);

267  
FRE_DMA
;

270 
	`FRCORE_CYCLE_RECORDING
();

271 
ridx
 +ğ
Ën
;

274 
chª
->
ava_ridx
 = 
ridx
;

275 
loÿl
 = (
ušt8_t
 *è&
chª
->
ava_ridx
;

276 
»mÙe_addr
 = 
chª
->
ù¾_addr
 + 
FRC_DMA_SIMPLE_CHAN_AVAIL_RIDX_OFFSET
;

277 
	`FRCORE_CYCLE_RECORDING
();

278 if(
	`äcÜe_cİy_to_»mÙe
((
chª
->
ava_ridx
), 
loÿl
, 
»mÙe_addr
)) {

279 
	`FRCORE_ERROR
("Copy„idx of‡vail„ingo„emote fail!\n");

280 
	`FRCORE_STAT_INC
(
¡©_dma_”rÜs
);

281 
	`FRCORE_SIMPLE_PACKAGE_CHAN_AVAIL_UNLOCK
(
chª
);

282  
FRE_DMA
;

284 
	`FRCORE_CYCLE_RECORDING
();

285 
	`FRCORE_SIMPLE_PACKAGE_CHAN_AVAIL_UNLOCK
(
chª
);

287  
FRE_SUCCESS
;

288 
	}
}

290 
	$äcÜe_sim¶e_·ckage_chª_po¡_pkt
(
äcÜe_sim¶e_·ckage_fifo_t
 *
fifo
,

291 
ušt64_t
 
loÿl_num
)

293 
ušt64_t
 
cur
 = 0, 
cur_off£t
 = 0;

295 
äcÜe_dma_sÿ‰”_desc_t
 
dma_¬g
;

296 
ušt64_t
 
»mÙe_addr
;

297 
ušt64_t
 
pkt_»maš
 = 0, 
pkt_po¡ed
 = 0, 
pkt_numb
 = 0, 
dma_numb
 = 0, 
i
;

299 
	`mem£t
(&
dma_¬g
, 0, (
äcÜe_dma_sÿ‰”_desc_t
));

301 
pkt_»maš
 = 
loÿl_num
;

303 
pkt_»maš
)

305 ià(
pkt_»maš
 > 
FRCORE_MAX_DMA_POINTERS
)

307 
pkt_numb
 = 
FRCORE_MAX_DMA_POINTERS
;

311 
pkt_numb
 = 
pkt_»maš
;

313 
dma_numb
 = 0;

314 
i
 = 0; i < 
pkt_numb
; i++)

316 
cur_off£t
 = (
fifo
->
loÿl_ridx
 + 
cur
 ) % 
FRCORE_CORE_FIFO_NUM
;

317 
»mÙe_addr
 = 
fifo
->
idx_buff
[
cur
];

318 
dma_¬g
.
»mÙe_addr
[
dma_numb
] =„emÙe_add¸+ 
FRC_DMA_OFFSET
;

319 
dma_¬g
.
loÿl_±r
[
dma_numb
] = (
ušt8_t
 *è
fifo
->
fifo_ûÎ
[
cur_off£t
].
d©a
;

320 
dma_¬g
.
size
[
dma_numb
] = 
fifo
->
fifo_ûÎ
[
cur_off£t
].
pkt_size
;

321 
	`FRCORE_STAT_ADD
(
¡©_dma_by‹s
, (
dma_¬g
.
size
[
dma_numb
] - (
äc_dma_hdr_t
è- (
äc_dma_pkt_šfo_t
)));

322 
	`FRCORE_STAT_INC
(
¡©_dma_pkts
);

323 
	`FRCORE_STAT_INC
(
¡©_dma_pkt_šfos
);

325 
dma_numb
++;

326 
cur
++;

328 
dma_¬g
.
numb”
 = 
dma_numb
;

330 ià(
	`äcÜe_dma_sÿ‰”
(
DMA_DIR_SEND
, &
dma_¬g
))

332 
	`FRCORE_ERROR
("frcore_dma_scatter DMA_DIR_SEND fail!\n");

333 
	`FRCORE_STAT_INC
(
¡©_dma_”rÜs
);

334 
äcÜe_queue_po¡_pkt_”r
;

338 
	`FRCORE_STAT_ADD
(
¡©_dma_blocks
, 
dma_numb
);

341 
	`FRCORE_CYCLE_RECORDING
();

342 
pkt_»maš
 -ğ
pkt_numb
;

343 
pkt_po¡ed
 +ğ
pkt_numb
;

346 
äcÜe_queue_po¡_pkt_”r
:

347  
pkt_po¡ed
;

348 
	}
}

351 
	$äcÜe_sim¶e_·ckage_chª_com¶_put
(
äcÜe_sim¶e_·ckage_chª_t
 *
chª
, 
äcÜe_sim¶e_·ckage_fifo_t
 *
fifo
,

352 
ušt64_t
 
numb”
)

354 
ušt64_t
 
ridx
, 
widx
, 
off£t
, 
Ën
, 
Ën1
, 
Ën2
;

355 
ušt8_t
 *
loÿl
;

356 
ušt64_t
 
»mÙe_addr
;

358 
	`FRCORE_SIMPLE_PACKAGE_CHAN_COMPL_LOCK
(
chª
);

359 
loÿl
 = (
ušt8_t
 *è&
chª
->
com¶_ridx
;

360 
»mÙe_addr
 = 
chª
->
ù¾_addr
 + 
FRC_DMA_SIMPLE_CHAN_COMPL_RIDX_OFFSET
;

362 ià(
	`äcÜe_cİy_äom_»mÙe
((
chª
->
com¶_ridx
), 
loÿl
, 
»mÙe_addr
)) {

363 
	`FRCORE_ERROR
("SYNC„idx & widx of compl„ing from„emote fail!\n");

364 
	`FRCORE_STAT_INC
(
¡©_dma_”rÜs
);

365 
	`FRCORE_SIMPLE_PACKAGE_CHAN_COMPL_UNLOCK
(
chª
);

366  
FRE_DMA
;

369 
ridx
 = 
chª
->
com¶_ridx
;

370 
widx
 = 
chª
->
com¶_widx
;

372 
Ën
 = 
numb”
;

374 ià((
widx
 - 
ridx
è> (
FRC_SIMPLE_RING_BUFF_SIZE
 - 
Ën
))

376 
	`FRCORE_STAT_INC
(
¡©_com¶_put_no_¥aû
);

377 
	`FRCORE_SIMPLE_PACKAGE_CHAN_COMPL_UNLOCK
(
chª
);

378  
FRE_NOSPACE
;

381 
off£t
 = 
widx
 % 
FRC_SIMPLE_RING_BUFF_SIZE
;

383 
Ën1
 = (
FRC_SIMPLE_RING_BUFF_SIZE
 - 
off£t
è< 
Ën
 ? (FRC_SIMPLE_RING_BUFF_SIZE - offset) :†en;

385 
loÿl
 = (
ušt8_t
 *è
fifo
->
idx_buff
;

386 
»mÙe_addr
 = 
chª
->
ù¾_addr
 + 
FRC_DMA_SIMPLE_CHAN_COMPL_RING_OFFSET
 + 
off£t
 * 
RING_BUFF_CELL_SIZE
;

388 ià(
	`äcÜe_cİy_to_»mÙe
(
Ën1
*
RING_BUFF_CELL_SIZE
, 
loÿl
, 
»mÙe_addr
)) {

389 
	`FRCORE_ERROR
("Copy compl„ing buff from„emote fail!\n");

390 
	`FRCORE_STAT_INC
(
¡©_dma_”rÜs
);

391 
	`FRCORE_SIMPLE_PACKAGE_CHAN_COMPL_UNLOCK
(
chª
);

392  
FRE_DMA
;

395 ià(
Ën1
 < 
Ën
)

397 
Ën2
 = 
Ën
 - 
Ën1
;

398 
loÿl
 = (
ušt8_t
 *è
fifo
->
idx_buff
 + 
Ën1
*
RING_BUFF_CELL_SIZE
;

399 
»mÙe_addr
 = 
chª
->
ù¾_addr
 + 
FRC_DMA_SIMPLE_CHAN_COMPL_RING_OFFSET
;

401 if(
	`äcÜe_cİy_to_»mÙe
(
Ën2
*
RING_BUFF_CELL_SIZE
, 
loÿl
, 
»mÙe_addr
)) {

402 
	`FRCORE_ERROR
("Copy compl„ing buff from„emote fail!\n");

403 
	`FRCORE_STAT_INC
(
¡©_dma_”rÜs
);

404 
	`FRCORE_SIMPLE_PACKAGE_CHAN_COMPL_UNLOCK
(
chª
);

405  
FRE_DMA
;

409 
widx
 +ğ
Ën
;

412 
chª
->
com¶_widx
 = 
widx
;

413 
loÿl
 = (
ušt8_t
 *è&
chª
->
com¶_widx
;

414 
»mÙe_addr
 = 
chª
->
ù¾_addr
 + 
FRC_DMA_SIMPLE_CHAN_COMPL_WIDX_OFFSET
;

416 ià(
	`äcÜe_cİy_to_»mÙe
((
chª
->
com¶_widx
), 
loÿl
, 
»mÙe_addr
)) {

417 
	`FRCORE_ERROR
("Copy„idx of compl„ingo„emote fail!\n");

418 
	`FRCORE_STAT_INC
(
¡©_dma_”rÜs
);

419 
	`FRCORE_SIMPLE_PACKAGE_CHAN_COMPL_UNLOCK
(
chª
);

420  
FRE_DMA
;

422 
	`FRCORE_SIMPLE_PACKAGE_CHAN_COMPL_UNLOCK
(
chª
);

423  
FRE_SUCCESS
;

424 
	}
}

431 
	$äcÜe_sim¶e_·ckage_fifo_po¡
(
äcÜe_sim¶e_·ckage_chª_t
 *
chª
, 
äcÜe_sim¶e_·ckage_fifo_t
 *
fifo
,

432 
ušt32_t
 
cÜe_num
, 
ušt8_t
 
æag
)

434 
rv
;

436 
ušt64_t
 
loÿl_widx
, 
loÿl_ridx
, 
loÿl_num
, 
po¡ed_num
, 
po¡_num
;

438 
loÿl_widx
 = 
fifo
->local_widx;

439 
loÿl_ridx
 = 
fifo
->local_ridx;

440 
loÿl_num
 = 
loÿl_widx
 - 
loÿl_ridx
;

442 ià(
æag
)

444 ià(
loÿl_num
 !ğ
FRCORE_CHAN_POST_LWM
)

449 ià(
loÿl_num
 == 0)

455 
¥’d_cyşe
 = 
	`cvmx_g‘_cyşe
(è- 
fifo
->
po¡_cyşe
;

457 ià((
¥’d_cyşe
 < 
FRCORE_CHAN_POST_PERIOD
è&& (
loÿl_num
 < 
FRCORE_CHAN_POST_LWM
))

464 
	`FRCORE_CYCLE_RECORDER_INIT
();

465 
loÿl_num
)

468 ià(
loÿl_num
 < 
FRCORE_CHAN_POST_LWM
)

470 
po¡_num
 = 
loÿl_num
;

474 
po¡_num
 = 
FRCORE_CHAN_POST_LWM
;

477 
	`FRCORE_CYCLE_RECORDING
();

478 ià(
udp_block_exhau¡
[
cÜe_num
]) {

479 ià(
	`cvmx_g‘_cyşe
(è- 
udp_Ï¡_di¥Ïy
[
cÜe_num
]

480 < (
ıu_äeq
 / 
DMA_CHANNEL_REST_DIV
)) {

484 
rv
 = 
	`äcÜe_sim¶e_·ckage_chª_ava_g‘
(
chª
, 
fifo
, 
po¡_num
);

485 
	`FRCORE_CHAN
("CHAN %lld: frcore_simple_package_chan_avail_get„eturn %d,…ost_num %lld..\n",

486 (
ULL
)
chª
->
ty³
, 
rv
, (ULLè
po¡_num
);

487 ià(
FRE_NOSPACE
 =ğ
rv
)

489 
udp_block_exhau¡
[
cÜe_num
] = 1;

490 
udp_Ï¡_di¥Ïy
[
cÜe_num
] = 
	`cvmx_g‘_cyşe
();

493 ià(
rv
)

495 
	`FRCORE_STAT_INC
(
¡©_ava_g‘_”r
);

496 
äcÜe_queue_po¡_”r
;

500 
udp_block_exhau¡
[
cÜe_num
] = 0;

501 
	`FRCORE_STAT_INC
(
¡©_ava_g‘
);

503 
	`FRCORE_CYCLE_RECORDING
();

506 
po¡ed_num
 = 
	`äcÜe_sim¶e_·ckage_chª_po¡_pkt
(
fifo
, 
po¡_num
);

508 
	`FRCORE_QUEUE
("CHAN %lld: frcore_queue_post_pkt…osted_num %lld,…ost_num %lld.\n",

509 (
ULL
)
chª
->
ty³
, (ULLè
po¡ed_num
, (ULLè
po¡_num
);

510 ià(
po¡ed_num
 < 
po¡_num
)

512 
	`FRCORE_STAT_INC
(
¡©_pkt_po¡_”r
);

513 
	`FRCORE_STAT_ADD
(
¡©_po¡_”r_pkts
, (
po¡_num
 - 
po¡ed_num
));

517 
	`FRCORE_STAT_INC
(
¡©_pkt_po¡
);

520 
	`FRCORE_CYCLE_RECORDING
();

522 
rv
 = 
	`äcÜe_sim¶e_·ckage_chª_com¶_put
(
chª
, 
fifo
, 
po¡_num
);

523 
	`FRCORE_CHAN
("CHAN %lld: frcore_simple_package_chan_compl_put„eturn %d,…ost_num %lld.\n",

524 (
ULL
)
chª
->
ty³
, 
rv
, (ULLè
po¡_num
);

525 ià(
rv
) {

526 
	`FRCORE_STAT_INC
(
¡©_com¶_put_”r
);

527 
äcÜe_queue_po¡_”r
;

529 
	`FRCORE_STAT_INC
(
¡©_com¶_put
);

531 
fifo
->
loÿl_ridx
 +ğ
po¡_num
;

532 
fifo
->
po¡_cyşe
 = 
	`cvmx_g‘_cyşe
();

533 
loÿl_num
 -ğ
po¡_num
;

535 
	`FRCORE_CYCLE_RECORDING
();

537 
äcÜe_queue_po¡_”r
:

538 
	`FRCORE_CYCLE_RECORD_DUMP
();

539 
	}
}

542 
	$äcÜe_sim¶e_·ckage_fifo_add
(
äcÜe_sim¶e_·ckage_fifo_t
 *
fifo
, 
äc_dma_hdr_t
 *
hdr
,

543 
äc_dma_pkt_šfo_t
 *
šfo
, *
·ylßd
)

545 
rv
 = 0;

546 
ušt8_t
 *
buff
 = 
NULL
;

547 
hdr_size
, 
šfo_size
, 
·yËn
;

548 
ušt64_t
 
pkt_Ën
;

549 
ušt64_t
 
idx_off£t
 = 0;

551 
hdr_size
 = (
äc_dma_hdr_t
);

552 
šfo_size
 = (
äc_dma_pkt_šfo_t
);

554 
·yËn
 = 
hdr
->
tÙ®_·yËn
;

556 
pkt_Ën
 = 
hdr_size
 + 
šfo_size
 + 
·yËn
;

557 ià(
pkt_Ën
 > 2048)

559 
	`FRCORE_ERROR
("pkt_len %lld > 2048, hdr_size %d, info_size %d,…aylen %d!\n",

560 (
ULL
è
pkt_Ën
, 
hdr_size
, 
šfo_size
, 
·yËn
);

561 
	`FRCORE_STAT_INC
(
¡©_pkt_ov”size
);

562  
FRE_EXCEED
;

566 ià((
fifo
->
loÿl_widx
 - fifo->
loÿl_ridx
è>ğ
FRCORE_CORE_FIFO_NUM
)

568 
rv
 = 
FRE_NOSPACE
;

569 
	`FRCORE_STAT_INC
(
¡©_queue_no_¥aû
);

570 
äcÜe_sim¶e_·ckage_fifo_add_”r
;

573 
idx_off£t
 = 
fifo
->
loÿl_widx
 % 
FRCORE_CORE_FIFO_NUM
;

575 
fifo
->
fifo_ûÎ
[
idx_off£t
].
pkt_size
 = 
pkt_Ën
;

576 
buff
 = 
fifo
->
fifo_ûÎ
[
idx_off£t
].
d©a
;

578 
	`FRCORE_CYCLE_RECORDING
();

579 
	`memıy
(
buff
, 
hdr
, 
hdr_size
);

580 
	`memıy
(
buff
+
hdr_size
, 
·ylßd
, 
·yËn
);

581 
	`memıy
(
buff
+
hdr_size
+
·yËn
, 
šfo
, 
šfo_size
);

582 
	`FRCORE_CYCLE_RECORDING
();

584 
fifo
->
loÿl_widx
++;

586 
äcÜe_sim¶e_·ckage_fifo_add_”r
:

588  
rv
;

589 
	}
}

592 
	$äcÜe_fÜw¬d_sim¶e_pkt_to_fifo
(
ušt32_t
 
ty³
, 
äc_dma_hdr_t
 *
hdr
, 
äc_dma_pkt_šfo_t
 *
šfo
, *
·ylßd
)

594 #ià
FRC_CONFIG_UDP_CLOSE_SUBMIT_DATA


595  
FRE_SUCCESS
;

597 
num
, 
rv
;

598 
äcÜe_sim¶e_·ckage_chª_t
 *
chª
 = 
NULL
;

599 
äcÜe_sim¶e_·ckage_fifo_t
 *
fifo
;

600 
ušt32_t
 
fifo_id
 = 0;

602 
chª
 = 
	`äcÜe_sim¶e_·ckage_chª_g‘
(
ty³
);

603 ià(
chª
 =ğ
NULL
)

605 
	`FRCORE_ERROR
("Invad chª_id %d.\n", 
ty³
);

606  
FRE_INIT
;

609 
fifo_id
 = 
	`cvmx_g‘_cÜe_num
();

610 
fifo
 = 
	`äcÜe_sim¶e_·ckage_fifo_g‘
(
ty³
, 
fifo_id
);

611 ià(
fifo
 =ğ
NULL
)

613 
	`FRCORE_ERROR
("Invady³ %d fifo_id %d.\n", 
ty³
, 
fifo_id
);

614  
FRE_INIT
;

618 
	`äcÜe_sim¶e_·ckage_fifo_po¡
(
chª
, 
fifo
, 
fifo_id
, 1);

620 
	`FRCORE_CYCLE_RECORDING
();

621 
num
 = 
	`äcÜe_sim¶e_·ckage_fifo_add
(
fifo
, 
hdr
, 
šfo
, 
·ylßd
);

622 ià(
num
 != 0)

624 
	`FRCORE_ERROR
("Simple Package fifoƒxceed!\n");

625 
	`FRCORE_STAT_INC
(
¡©_dma_’queue_”rs
);

626 
rv
 = 
FRE_EXCEED
;

627 
äcÜe_fÜw¬d_pkt_to_ho¡_”r
;

631 
	`FRCORE_STAT_INC
(
¡©_dma_’queue_pkts
);

634 
rv
 = 
FRE_SUCCESS
;

636 
äcÜe_fÜw¬d_pkt_to_ho¡_”r
:

637  
rv
;

639 
	}
}

641 #ià
FRC_CONFIG_RULE


647 
	$äcÜe_ruË_fifo_po¡
(
äcÜe_sim¶e_·ckage_chª_t
 *
chª
, 
äcÜe_sim¶e_·ckage_fifo_t
 *
fifo
,

648 
ušt32_t
 
cÜe_num
, 
ušt8_t
 
æag
)

650 
rv
;

652 
ušt64_t
 
loÿl_widx
, 
loÿl_ridx
, 
loÿl_num
, 
po¡ed_num
, 
po¡_num
;

654 
loÿl_widx
 = 
fifo
->local_widx;

655 
loÿl_ridx
 = 
fifo
->local_ridx;

656 
loÿl_num
 = 
loÿl_widx
 - 
loÿl_ridx
;

658 ià(
æag
)

660 ià(
loÿl_num
 !ğ
FRCORE_CHAN_POST_LWM
)

665 ià(
loÿl_num
 == 0)

671 
¥’d_cyşe
 = 
	`cvmx_g‘_cyşe
(è- 
fifo
->
po¡_cyşe
;

673 ià((
¥’d_cyşe
 < 
FRCORE_CHAN_POST_PERIOD
è&& (
loÿl_num
 < 
FRCORE_CHAN_POST_LWM
))

680 
	`FRCORE_CYCLE_RECORDER_INIT
();

681 
loÿl_num
)

684 ià(
loÿl_num
 < 
FRCORE_CHAN_POST_LWM
)

686 
po¡_num
 = 
loÿl_num
;

690 
po¡_num
 = 
FRCORE_CHAN_POST_LWM
;

693 
	`FRCORE_CYCLE_RECORDING
();

694 ià(
ruË_block_exhau¡
[
cÜe_num
]) {

695 ià(
	`cvmx_g‘_cyşe
(è- 
ruË_Ï¡_di¥Ïy
[
cÜe_num
]

696 < (
ıu_äeq
 / 
DMA_CHANNEL_REST_DIV
)) {

700 
rv
 = 
	`äcÜe_sim¶e_·ckage_chª_ava_g‘
(
chª
, 
fifo
, 
po¡_num
);

701 
	`FRCORE_CHAN
("CHAN %lld: frcore_simple_package_chan_avail_get„eturn %d,…ost_num %lld..\n",

702 (
ULL
)
chª
->
ty³
, 
rv
, (ULLè
po¡_num
);

703 ià(
FRE_NOSPACE
 =ğ
rv
)

705 
ruË_block_exhau¡
[
cÜe_num
] = 1;

706 
ruË_Ï¡_di¥Ïy
[
cÜe_num
] = 
	`cvmx_g‘_cyşe
();

709 ià(
rv
)

711 
	`FRCORE_STAT_INC
(
¡©_ava_g‘_”r
);

712 
äcÜe_queue_po¡_”r
;

716 
ruË_block_exhau¡
[
cÜe_num
] = 0;

717 
	`FRCORE_STAT_INC
(
¡©_ava_g‘
);

719 
	`FRCORE_CYCLE_RECORDING
();

722 
po¡ed_num
 = 
	`äcÜe_sim¶e_·ckage_chª_po¡_pkt
(
fifo
, 
po¡_num
);

724 
	`FRCORE_QUEUE
("CHAN %lld: frcore_queue_post_pkt…osted_num %lld,…ost_num %lld.\n",

725 (
ULL
)
chª
->
ty³
, (ULLè
po¡ed_num
, (ULLè
po¡_num
);

726 ià(
po¡ed_num
 < 
po¡_num
)

728 
	`FRCORE_STAT_INC
(
¡©_pkt_po¡_”r
);

729 
	`FRCORE_STAT_ADD
(
¡©_po¡_”r_pkts
, (
po¡_num
 - 
po¡ed_num
));

733 
	`FRCORE_STAT_INC
(
¡©_pkt_po¡
);

736 
	`FRCORE_CYCLE_RECORDING
();

738 
rv
 = 
	`äcÜe_sim¶e_·ckage_chª_com¶_put
(
chª
, 
fifo
, 
po¡_num
);

739 
	`FRCORE_CHAN
("CHAN %lld: frcore_simple_package_chan_compl_put„eturn %d,…ost_num %lld.\n",

740 (
ULL
)
chª
->
ty³
, 
rv
, (ULLè
po¡_num
);

741 ià(
rv
) {

742 
	`FRCORE_STAT_INC
(
¡©_com¶_put_”r
);

743 
äcÜe_queue_po¡_”r
;

745 
	`FRCORE_STAT_INC
(
¡©_com¶_put
);

747 
fifo
->
loÿl_ridx
 +ğ
po¡_num
;

748 
fifo
->
po¡_cyşe
 = 
	`cvmx_g‘_cyşe
();

749 
loÿl_num
 -ğ
po¡_num
;

751 
	`FRCORE_CYCLE_RECORDING
();

753 
äcÜe_queue_po¡_”r
:

754 
	`FRCORE_CYCLE_RECORD_DUMP
();

755 
	}
}

757 
	$äcÜe_ruË_·ck‘_fifo_add
(
äcÜe_sim¶e_·ckage_fifo_t
 *
fifo
, 
äc_dma_hdr_t
 *
hdr
, 
äc_dma_pkt_šfo_t
 *
šfo
, *
·ylßd
, 
ušt16_t
 *
gid
)

759 
rv
 = 0;

760 
ušt8_t
 *
buff
 = 
NULL
;

761 
hdr_size
, 
šfo_size
, 
·yËn
;

762 
ušt64_t
 
pkt_Ën
;

763 
ušt64_t
 
idx_off£t
 = 0;

765 
hdr_size
 = (
äc_dma_hdr_t
);

766 
šfo_size
 = (
äc_dma_pkt_šfo_t
);

768 
·yËn
 = 
hdr
->
tÙ®_·yËn
;

770 
pkt_Ën
 = 
hdr_size
 + 
šfo_size
 + 
·yËn
 +2;

771 ià(
pkt_Ën
 > 2048)

773 
	`FRCORE_ERROR
("pkt_len %lld > 2048, hdr_size %d, info_size %d,…aylen %d!\n",

774 (
ULL
è
pkt_Ën
, 
hdr_size
, 
šfo_size
, 
·yËn
);

775 
	`FRCORE_STAT_INC
(
¡©_pkt_ov”size
);

776  
FRE_EXCEED
;

780 ià((
fifo
->
loÿl_widx
 - fifo->
loÿl_ridx
è>ğ
FRCORE_CORE_FIFO_NUM
)

782 
rv
 = 
FRE_NOSPACE
;

783 
	`FRCORE_STAT_INC
(
¡©_queue_no_¥aû
);

784 
äcÜe_sim¶e_·ckage_fifo_add_”r
;

787 
idx_off£t
 = 
fifo
->
loÿl_widx
 % 
FRCORE_CORE_FIFO_NUM
;

789 
fifo
->
fifo_ûÎ
[
idx_off£t
].
pkt_size
 = 
pkt_Ën
;

790 
buff
 = 
fifo
->
fifo_ûÎ
[
idx_off£t
].
d©a
;

792 
	`FRCORE_CYCLE_RECORDING
();

793 
	`memıy
(
buff
, 
hdr
, 
hdr_size
);

794 
	`memıy
(
buff
+
hdr_size
, 
gid
, 2);

795 
	`memıy
(
buff
+
hdr_size
+2, 
·ylßd
, 
·yËn
);

796 
	`memıy
(
buff
+
hdr_size
+2+
·yËn
, 
šfo
, 
šfo_size
);

797 
	`FRCORE_CYCLE_RECORDING
();

799 
fifo
->
loÿl_widx
++;

801 
äcÜe_sim¶e_·ckage_fifo_add_”r
:

803  
rv
;

804 
	}
}

806 
	$äcÜe_fÜw¬d_ruË_pkt_to_fifo
(
ušt16_t
 *
gid
, 
äc_dma_hdr_t
 *
hdr
, 
äc_dma_pkt_šfo_t
 *
šfo
, *
·ylßd
)

808 
num
, 
rv
;

809 
äcÜe_sim¶e_·ckage_chª_t
 *
chª
 = 
NULL
;

810 
äcÜe_sim¶e_·ckage_fifo_t
 *
fifo
;

811 
ušt32_t
 
fifo_id
 = 0;

812 
ušt32_t
 
ty³
 = 
FRC_WORK_RULE
;

814 
chª
 = 
	`äcÜe_sim¶e_·ckage_chª_g‘
(
ty³
);

815 ià(
chª
 =ğ
NULL
)

817 
	`FRCORE_ERROR
("Invad chª_id %d.\n", 
ty³
);

818  
FRE_INIT
;

820 
fifo_id
 = 
	`cvmx_g‘_cÜe_num
();

821 
fifo
 = 
	`äcÜe_sim¶e_·ckage_fifo_g‘
(
ty³
, 
fifo_id
);

822 ià(
fifo
 =ğ
NULL
)

824 
	`FRCORE_ERROR
("Invady³ %d fifo_id %d.\n", 
ty³
, 
fifo_id
);

825  
FRE_INIT
;

828 
	`äcÜe_ruË_fifo_po¡
(
chª
, 
fifo
, 
fifo_id
, 1);

830 
	`FRCORE_CYCLE_RECORDING
();

831 
num
 = 
	`äcÜe_ruË_·ck‘_fifo_add
(
fifo
, 
hdr
, 
šfo
, 
·ylßd
, 
gid
);

832 ià(
num
 != 0)

834 
	`FRCORE_ERROR
("Simple Package fifoƒxceed!\n");

835 
	`FRCORE_STAT_INC
(
¡©_dma_’queue_”rs
);

836 
rv
 = 
FRE_EXCEED
;

837 
äcÜe_fÜw¬d_pkt_to_ho¡_”r
;

841 
	`FRCORE_STAT_INC
(
¡©_dma_’queue_pkts
);

844 
rv
 = 
FRE_SUCCESS
;

846 
äcÜe_fÜw¬d_pkt_to_ho¡_”r
:

847  
rv
;

848 
	}
}

854 #ià
FRC_CONFIG_SSN_CHAN


855 
CVMX_SHARED
 
äcÜe_s¢_chª_t
 *
	gäcÜe_s¢_chªs
 = 
NULL
;

856 
CVMX_SHARED
 
äcÜe_s¢_fifo_t
 *
	gäcÜe_s¢_fifos
 = 
NULL
;

859 
	#FRCORE_SSN_CHAN_AVAIL_LOCK
(
_chª
è
	`cvmx_¥šlock_lock
(&((_chª)->
ava_lock
))

	)

860 
	#FRCORE_SSN_CHAN_AVAIL_UNLOCK
(
_chª
è
	`cvmx_¥šlock_uÆock
(&((_chª)->
ava_lock
))

	)

861 
	#FRCORE_SSN_CHAN_COMPL_LOCK
(
_chª
è
	`cvmx_¥šlock_lock
(&((_chª)->
com¶_lock
))

	)

862 
	#FRCORE_SSN_CHAN_COMPL_UNLOCK
(
_chª
è
	`cvmx_¥šlock_uÆock
(&((_chª)->
com¶_lock
))

	)

863 
	#FRCORE_SSN_CHAN_FIFO_LOCK
(
_fifo
è
	`cvmx_¥šlock_lock
(&((_fifo)->
lock
));\

864 
	`FRCORE_STAT_INC
(
¡©_s¢_fifo_lock
)

	)

865 
	#FRCORE_SSN_CHAN_FIFO_UNLOCK
(
_fifo
è
	`cvmx_¥šlock_uÆock
(&((_fifo)->
lock
));\

866 
	`FRCORE_STAT_INC
(
¡©_s¢_fifo_uÆock
)

	)

868 
	#FRCORE_SSN_CHAN_AVAIL_LOCK
(
_chª
)

	)

869 
	#FRCORE_SSN_CHAN_AVAIL_UNLOCK
(
_chª
)

	)

870 
	#FRCORE_SSN_CHAN_COMPL_LOCK
(
_chª
)

	)

871 
	#FRCORE_SSN_CHAN_COMPL_UNLOCK
(
_chª
)

	)

874 
	$äcÜe_cmd_£tup_s¢_chªs
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

876 
i
;

877 
äcÜe_s¢_chª_t
 *
chª
 = 
NULL
;

878 
äcÜe_s¢_fifo_t
 *
fifo
 = 
NULL
;

879 
äc_dma_s¢_chª_desc_t
 *
desc
;

880 *
Ş’
 = 0;

882 
desc
 = (
äc_dma_s¢_chª_desc_t
 *è
·¿m
;

884 
	`FRCORE_CMD
("chan_id %lld,‡vail_size %llx,‡vail_addr 0x%llx, compl_size %llx,compl_addr 0x%llx.\n",

885 (
ULL
è
desc
->
ty³
, (ULLèdesc->
ava_size
, (ULLèdesc->
ava_addr
,

886 (
ULL
è
desc
->
com¶_size
, (ULLèdesc->
com¶_addr
);

888 ià(
äcÜe_s¢_chªs
 =ğ
NULL
) {

889 
	`FRCORE_ERROR
("\n");

890  
FRE_INIT
;

893 ià(
desc
->
ty³
 > 
FRC_WORK_SSN
) {

894 
	`FRCORE_ERROR
("desc->ty³(%Îdè> FRC_WORK_SSN(%d)\n", (
ULL
è
desc
->
ty³
, 
FRC_WORK_SSN
);

895  
FRE_EXCEED
;

898 ià(
desc
->
ty³
 !ğ
FRC_WORK_SSN
)

900 
	`FRCORE_ERROR
("UnkowÀty³ %Îd!\n", (
ULL
)
desc
->
ty³
);

901  
FRE_PARAM
;

904 
chª
 = &
äcÜe_s¢_chªs
[
desc
->
ty³
 - 
FRC_WORK_SSN
];

907 
äcÜe_dma_sÿ‰”_desc_t
 
dma_¬g
;

909 
	`mem£t
(&
dma_¬g
, 0, (
äcÜe_dma_sÿ‰”_desc_t
));

911 
dma_¬g
.
loÿl_±r
[0] = (
ušt8_t
 *è&
chª
->
ava_widx
;

912 
dma_¬g
.
»mÙe_addr
[0] = 
desc
->
ava_addr
 + 
FRC_DMA_SSN_AVAIL_WIDX_OFFSET
;

913 
dma_¬g
.
size
[0] = (
chª
->
ava_widx
);

915 
dma_¬g
.
loÿl_±r
[1] = (
ušt8_t
 *è&
chª
->
ava_ridx
;

916 
dma_¬g
.
»mÙe_addr
[1] = 
desc
->
ava_addr
 + 
FRC_DMA_SSN_AVAIL_RIDX_OFFSET
;

917 
dma_¬g
.
size
[1] = (
chª
->
ava_ridx
);

919 
dma_¬g
.
loÿl_±r
[2] = (
ušt8_t
 *è&
chª
->
com¶_widx
;

920 
dma_¬g
.
»mÙe_addr
[2] = 
desc
->
com¶_addr
 + 
FRC_DMA_SSN_COMPL_WIDX_OFFSET
;

921 
dma_¬g
.
size
[2] = (
chª
->
com¶_widx
);

923 
dma_¬g
.
loÿl_±r
[3] = (
ušt8_t
 *è&
chª
->
com¶_ridx
;

924 
dma_¬g
.
»mÙe_addr
[3] = 
desc
->
com¶_addr
 + 
FRC_DMA_SSN_COMPL_RIDX_OFFSET
;

925 
dma_¬g
.
size
[3] = (
chª
->
com¶_ridx
);

926 
dma_¬g
.
numb”
 = 4;

928 ifĞ
	`äcÜe_dma_sÿ‰”
(
DMA_DIR_RECV
, &
dma_¬g
)) {

929 
	`FRCORE_ERROR
("Copy ctrl‡rg from„emote fail!\n");

930 
	`FRCORE_STAT_INC
(
¡©_dma_”rÜs
);

931  
FRE_DMA
;

933 
chª
->
ava_addr
 = 
desc
->avail_addr;

934 
chª
->
com¶_addr
 = 
desc
->compl_addr;

935 
chª
->
ty³
 = 
desc
->type;

937 
	`FRCORE_CMD
("CHAN %lld(%s): AVAIL_ADDR 0x%llx;COMPL_ADDR 0x%llx; AVAIL RIDX 0x%llX, WIDX 0x%llX; COMPL RIDX 0x%llX, WIDX 0x%llX.\n",

938 (
ULL
è
chª
->
ty³
, (ULLè(chª->ty³ =ğ
FRC_WORK_SSN
è? "SSN" : "OTHERS", (ULLèchª->
ava_addr
,(ULLèchª->
com¶_addr
,

939 (
ULL
è(
chª
->
ava_ridx
), (ULLè(chª->
ava_widx
), (ULLè(chª->
com¶_ridx
), (ULLè(chª->
com¶_widx
));

942 
	`cvmx_¥šlock_š™
(&
chª
->
ava_lock
);

943 
	`cvmx_¥šlock_š™
(&
chª
->
com¶_lock
);

944 
fifo
 = &
äcÜe_s¢_fifos
[(
desc
->
ty³
 - 
FRC_WORK_SSN
è* 
FRC_SSN_SIMPLE_CHAN_FIFO_NUM
];

945 
	`FRCORE_CMD
("fifo=%p\n", 
fifo
);

947 
i
 = 0; i < 
FRC_SSN_FIFO_NUM
; i++)

949 
	`cvmx_¥šlock_š™
(&
fifo
[
i
].
lock
);

950 
cvmx_wqe_t
 *
wqe
 = &
fifo
[
i
].wqe;

951 
	`mem£t
(
wqe
, 0, (
cvmx_wqe_t
));

952 
wqe
->
unu£d
 = 
FRCORE_WORK_CHAN
;

953 
wqe
->
´t
 = 0;

954 
wqe
->
g½
 = 
i
 % 
FRC_DAT_CORE_NUM
 + 1;

956 
wqe
->
g
 = wqe->
g½
;

957 
wqe
->
g_ty³
 = 
CVMX_POW_TAG_TYPE_ATOMIC
;

958 
wqe
->
·ck‘_d©a
[0] = (
ušt8_t
)
desc
->
ty³
;

959 
wqe
->
·ck‘_d©a
[1] = 
i
;

960 ià(
	`cvmx_tim_add_’Œy
(
wqe
, 
FRCORE_CHAN_TIMEOUT
, 
NULL
è!ğ
CVMX_TIM_STATUS_SUCCESS
) {

961 
	`FRCORE_ERROR
("dma chan fifoimer‡dd fail!\n");

962  
FRE_FAIL
;

967  
FRE_SUCCESS
;

968 
	}
}

970 
	$äcÜe_s¢_chª_š™
()

972 
äcÜe_s¢_chªs
 = 
	`cvmx_boÙmem_®loc
((
äcÜe_s¢_chª_t
è* 
FRC_DMA_SSN_CHAN_NUM
, 0);

973 ià(
äcÜe_s¢_chªs
 =ğ
NULL
)

975 
	`FRCORE_ERROR
("Alloc ssn dma chan fail!\n");

976  
FRE_MEMORY
;

979 
	`mem£t
(
äcÜe_s¢_chªs
, 0, (
äcÜe_s¢_chª_t
è* 
FRC_DMA_SSN_CHAN_NUM
);

980 
äcÜe_s¢_chªs
[0].
ty³
 = 
FRC_WORK_SSN
;

982 
	`´štf
("CHAN[%Îd]‡ddr=%°size=0x%x\n", (
ULL
)
äcÜe_s¢_chªs
[0].
ty³
, &frcore_ssn_chans[0],

983 ()((
äcÜe_s¢_chª_t
è* 
FRC_DMA_SSN_CHAN_NUM
));

984 
äcÜe_s¢_fifos
 = 
	`cvmx_boÙmem_®loc
((
äcÜe_s¢_fifo_t
è* 
FRC_SSN_FIFO_NUM
, 0);

985 ià(
äcÜe_s¢_fifos
 =ğ
NULL
)

987 
	`FRCORE_ERROR
("Alloc ssn fifo fail!\n");

988  
FRE_MEMORY
;

990 
	`mem£t
(
äcÜe_s¢_fifos
, 0, (
äcÜe_s¢_fifo_t
è* 
FRC_SSN_FIFO_NUM
);

991 
	`´štf
("SSN FIFO‡ddr=%°size=0x%Îx\n", 
äcÜe_s¢_fifos
,

992 (
ULL
)((
äcÜe_s¢_fifo_t
è* 
FRC_SSN_FIFO_NUM
));

993 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_CTRL
, 
CTRL_CMD_SETUP_SSN_CHAN
, 
äcÜe_cmd_£tup_s¢_chªs
);

995 
	}
}

997 
äcÜe_s¢_chª_t
 *

998 
	$äcÜe_s¢_chª_g‘
(
ušt32_t
 
ty³
)

1000 
äcÜe_s¢_chª_t
 *
chª
;

1002 
chª
 = &
äcÜe_s¢_chªs
[
ty³
-
FRC_WORK_SSN
];

1004  
chª
;

1005 
	}
}

1007 
äcÜe_s¢_fifo_t
 *

1008 
	$äcÜe_s¢_fifo_g‘
(
ušt8_t
 
ty³
, ušt8_ˆ
idx
)

1010 
äcÜe_s¢_fifo_t
 *
fifo
;

1011 
fifo
 = &
äcÜe_s¢_fifos
[(
ty³
-
FRC_WORK_SSN
è* 
FRC_SSN_SIMPLE_CHAN_FIFO_NUM
 + 
idx
];

1012  
fifo
;

1013 
	}
}

1014 #ià
FRC_CONFIG_SSN_AVAIL_BUFF_GET


1015 
	$äcÜe_s¢_chª_ava_g‘
(
äcÜe_s¢_chª_t
 *
chª
, 
ušt64_t
 
numb”
, ušt64_ˆ*
buff
)

1017 
ušt64_t
 
ridx
, 
widx
, 
off£t
, 
Ën
, 
Ën1
, 
Ën2
, 
®’
 = 0;

1018 
ušt8_t
 *
loÿl
;

1019 
ušt64_t
 
»mÙe_addr
;

1020 
	`FRCORE_CHAN
("chª->ava_widx=%Îd, chª->ava_ridx=%Îd\n", (
ULL
)
chª
->
ava_widx
, (ULL)chª->
ava_ridx
);

1021 
	`FRCORE_SSN_CHAN_AVAIL_LOCK
(
chª
);

1022 
loÿl
 = (
ušt8_t
 *è&
chª
->
ava_widx
;

1023 
»mÙe_addr
 = 
chª
->
ava_addr
 + 
FRC_DMA_SSN_AVAIL_WIDX_OFFSET
;

1025 if(
	`äcÜe_cİy_äom_»mÙe
((
chª
->
ava_widx
), 
loÿl
, 
»mÙe_addr
)) {

1026 
	`FRCORE_ERROR
("SYNC„idx & widx of‡vail„ing from„emote fail!\n");

1027 
	`FRCORE_STAT_INC
(
¡©_s¢_dma_”rÜs
);

1028 
	`FRCORE_SSN_CHAN_AVAIL_UNLOCK
(
chª
);

1029  
FRE_DMA
;

1032 
ridx
 = 
chª
->
ava_ridx
;

1033 
widx
 = 
chª
->
ava_widx
;

1035 
Ën
 = 
numb”
;

1037 
®’
 = (
widx
 - 
ridx
);

1038 ià(
®’
 < 
Ën
)

1040 
	`FRCORE_CHAN
("widx %lld„idx %lld,‡len %lld,†en %lld.\n",

1041 (
ULL
è
widx
, (ULLè
ridx
, (ULLè
®’
, (ULLè
Ën
);

1042 
	`FRCORE_STAT_INC
(
¡©_s¢_ava_g‘_no_¥aû
);

1043 
	`FRCORE_SSN_CHAN_AVAIL_UNLOCK
(
chª
);

1044  
FRE_NOSPACE
;

1047 
off£t
 = 
ridx
 % 
FRC_DMA_SSN_RING_BUFF_SIZE
;

1049 
Ën1
 = (
FRC_DMA_SSN_RING_BUFF_SIZE
 - 
off£t
è< 
Ën
 ? (FRC_DMA_SSN_RING_BUFF_SIZE - offset) :†en;

1051 
loÿl
 = (
ušt8_t
 *)
chª
->
ava_buff
;

1052 
»mÙe_addr
 = 
chª
->
ava_addr
 + 
FRC_DMA_SSN_AVAIL_RING_OFFSET
 + 
off£t
 * 
RING_BUFF_CELL_SIZE
;

1054 if(
	`äcÜe_cİy_äom_»mÙe
(
Ën1
 * 
RING_BUFF_CELL_SIZE
, 
loÿl
, 
»mÙe_addr
)) {

1055 
	`FRCORE_ERROR
("Copy‡vail„ing buff from„emote fail!\n");

1056 
	`FRCORE_STAT_INC
(
¡©_s¢_dma_”rÜs
);

1057 
	`FRCORE_SSN_CHAN_AVAIL_UNLOCK
(
chª
);

1058  
FRE_DMA
;

1061 ià(
Ën1
 < 
Ën
)

1063 
Ën2
 = 
Ën
 - 
Ën1
;

1064 
loÿl
 = (
ušt8_t
 *è
chª
->
ava_buff
 + 
Ën1
 * 
RING_BUFF_CELL_SIZE
;

1065 
»mÙe_addr
 = 
chª
->
ava_addr
 + 
FRC_DMA_SSN_AVAIL_RING_OFFSET
;

1067 if(
	`äcÜe_cİy_äom_»mÙe
(
Ën2
* 
RING_BUFF_CELL_SIZE
, 
loÿl
, 
»mÙe_addr
)) {

1068 
	`FRCORE_ERROR
("Copy‡vail„ing buff from„emote fail!\n");

1069 
	`FRCORE_STAT_INC
(
¡©_s¢_dma_”rÜs
);

1070 
	`FRCORE_SSN_CHAN_AVAIL_UNLOCK
(
chª
);

1071  
FRE_DMA
;

1075 
ridx
 +ğ
Ën
;

1076 
	`FRCORE_STAT_ADD
(
¡©_s¢_ava_g‘
, 
Ën
);

1078 
chª
->
ava_ridx
 = 
ridx
;

1079 
loÿl
 = (
ušt8_t
 *è&
chª
->
ava_ridx
;

1080 
»mÙe_addr
 = 
chª
->
ava_addr
 + 
FRC_DMA_SSN_AVAIL_RIDX_OFFSET
;

1082 if(
	`äcÜe_cİy_to_»mÙe
((
chª
->
ava_ridx
), 
loÿl
, 
»mÙe_addr
)) {

1083 
	`FRCORE_ERROR
("Copy„idx of‡vail„ingo„emote fail!\n");

1084 
	`FRCORE_STAT_INC
(
¡©_s¢_dma_”rÜs
);

1085 
	`FRCORE_SSN_CHAN_AVAIL_UNLOCK
(
chª
);

1086  
FRE_DMA
;

1089 
	`memıy
(
buff
, 
chª
->
ava_buff
, 
Ën
* 
RING_BUFF_CELL_SIZE
);

1090 
	`FRCORE_SSN_CHAN_AVAIL_UNLOCK
(
chª
);

1091  
FRE_SUCCESS
;

1092 
	}
}

1094 
	$äcÜe_s¢_g‘_Úe_block_addr
(
ušt64_t
 *
buff
, 
ušt32_t
 
fifo_id
)

1096 
rv
;

1097 
äcÜe_s¢_chª_t
 *
chª
 = 
NULL
;

1098 
äcÜe_s¢_fifo_t
 *
fifo
 = 
NULL
;

1099 
ušt64_t
 
block_addr
 = 0;

1100 
ušt32_t
 
ty³
 = 
FRC_WORK_SSN
;

1104 
chª
 = 
	`äcÜe_s¢_chª_g‘
(
ty³
);

1105 ià(
chª
 =ğ
NULL
)

1107 
	`FRCORE_ERROR
("Invady³ %d.\n", 
ty³
);

1108  
FRE_INIT
;

1110 
fifo
 = 
	`äcÜe_s¢_fifo_g‘
(
ty³
, 
fifo_id
);

1111 ià(
fifo
 =ğ
NULL
)

1113 
	`FRCORE_ERROR
("Invady³ %d fifo_id %d.\n", 
ty³
, 
fifo_id
);

1114  
FRE_INIT
;

1117 
	`FRCORE_SSN_CHAN_FIFO_LOCK
(
fifo
);

1118 ià(
fifo
->
ava_rdx
 <= 0)

1123 ià(
	`äcÜe_s¢_chª_ava_g‘
(
chª
, 
FRCORE_SSN_AVAIL_BUFF_GET_SIZE
, 
fifo
->
ava_buff
è=ğ
FRE_SUCCESS
)

1125 
fifo
->
ava_rdx
 = 
FRCORE_SSN_AVAIL_BUFF_GET_SIZE
;

1126 }ià(
	`äcÜe_s¢_chª_ava_g‘
(
chª
, 100, 
fifo
->
ava_buff
è=ğ
FRE_SUCCESS
)

1128 
fifo
->
ava_rdx
 = 100;

1129 }ià(
	`äcÜe_s¢_chª_ava_g‘
(
chª
, 1, 
fifo
->
ava_buff
è=ğ
FRE_SUCCESS
)

1131 
fifo
->
ava_rdx
 = 1;

1133 
	`FRCORE_ERROR
("frcore_ssn_chan_avail_get failed!\n");

1134 
rv
 = 
FRE_NOSPACE
;

1135 
äcÜe_s¢_g‘_Úe_block_addr_”r
;

1139 
block_addr
 = 
fifo
->
ava_buff
[fifo->
ava_rdx
-1];

1140 
fifo
->
ava_rdx
 -= 1;

1141 
CVMX_SYNCWS
;

1143 *
buff
 = 
block_addr
;

1144 
rv
 = 
FRE_SUCCESS
;

1146 
äcÜe_s¢_g‘_Úe_block_addr_”r
:

1147 
	`FRCORE_SSN_CHAN_FIFO_UNLOCK
(
fifo
);

1148  
rv
;

1149 
	}
}

1151 
	$äcÜe_s¢_chª_ava_g‘
(
äcÜe_s¢_chª_t
 *
chª
, 
ušt64_t
 
numb”
, ušt64_ˆ*
buff
)

1153 
ušt64_t
 
ridx
, 
widx
, 
off£t
, 
Ën
, 
Ën1
, 
Ën2
, 
®’
 = 0;

1154 
ušt8_t
 *
loÿl
;

1155 
ušt64_t
 
»mÙe_addr
;

1156 
	`FRCORE_CHAN
("chª->ava_widx=%Îd, chª->ava_ridx=%Îd\n", (
ULL
)
chª
->
ava_widx
, (ULL)chª->
ava_ridx
);

1157 
	`FRCORE_SSN_CHAN_AVAIL_LOCK
(
chª
);

1158 
loÿl
 = (
ušt8_t
 *è&
chª
->
ava_widx
;

1159 
»mÙe_addr
 = 
chª
->
ava_addr
 + 
FRC_DMA_SSN_AVAIL_WIDX_OFFSET
;

1161 if(
	`äcÜe_cİy_äom_»mÙe
((
chª
->
ava_widx
), 
loÿl
, 
»mÙe_addr
)) {

1162 
	`FRCORE_ERROR
("SYNC„idx & widx of‡vail„ing from„emote fail!\n");

1163 
	`FRCORE_STAT_INC
(
¡©_s¢_dma_”rÜs
);

1164 
	`FRCORE_SSN_CHAN_AVAIL_UNLOCK
(
chª
);

1165  
FRE_DMA
;

1168 
ridx
 = 
chª
->
ava_ridx
;

1169 
widx
 = 
chª
->
ava_widx
;

1171 
Ën
 = 
numb”
;

1173 
®’
 = (
widx
 - 
ridx
);

1174 ià(
®’
 < 
Ën
)

1176 
	`FRCORE_CHAN
("widx %lld„idx %lld,‡len %lld,†en %lld.\n",

1177 (
ULL
è
widx
, (ULLè
ridx
, (ULLè
®’
, (ULLè
Ën
);

1178 
	`FRCORE_STAT_INC
(
¡©_s¢_ava_g‘_no_¥aû
);

1179 
	`FRCORE_SSN_CHAN_AVAIL_UNLOCK
(
chª
);

1180  
FRE_NOSPACE
;

1183 
off£t
 = 
ridx
 % 
FRC_DMA_SSN_RING_BUFF_SIZE
;

1185 
Ën1
 = (
FRC_DMA_SSN_RING_BUFF_SIZE
 - 
off£t
è< 
Ën
 ? (FRC_DMA_SSN_RING_BUFF_SIZE - offset) :†en;

1187 
loÿl
 = (
ušt8_t
 *)
chª
->
ava_buff
;

1188 
»mÙe_addr
 = 
chª
->
ava_addr
 + 
FRC_DMA_SSN_AVAIL_RING_OFFSET
 + 
off£t
 * 
RING_BUFF_CELL_SIZE
;

1190 if(
	`äcÜe_cİy_äom_»mÙe
(
Ën1
 * 
RING_BUFF_CELL_SIZE
, 
loÿl
, 
»mÙe_addr
)) {

1191 
	`FRCORE_ERROR
("Copy‡vail„ing buff from„emote fail!\n");

1192 
	`FRCORE_STAT_INC
(
¡©_s¢_dma_”rÜs
);

1193 
	`FRCORE_SSN_CHAN_AVAIL_UNLOCK
(
chª
);

1194  
FRE_DMA
;

1197 ià(
Ën1
 < 
Ën
)

1199 
Ën2
 = 
Ën
 - 
Ën1
;

1200 
loÿl
 = (
ušt8_t
 *è
chª
->
ava_buff
 + 
Ën1
 * 
RING_BUFF_CELL_SIZE
;

1201 
»mÙe_addr
 = 
chª
->
ava_addr
 + 
FRC_DMA_SSN_AVAIL_RING_OFFSET
;

1203 if(
	`äcÜe_cİy_äom_»mÙe
(
Ën2
* 
RING_BUFF_CELL_SIZE
, 
loÿl
, 
»mÙe_addr
)) {

1204 
	`FRCORE_ERROR
("Copy‡vail„ing buff from„emote fail!\n");

1205 
	`FRCORE_STAT_INC
(
¡©_s¢_dma_”rÜs
);

1206 
	`FRCORE_SSN_CHAN_AVAIL_UNLOCK
(
chª
);

1207  
FRE_DMA
;

1211 
ridx
 +ğ
Ën
;

1212 
	`FRCORE_STAT_ADD
(
¡©_s¢_ava_g‘
, 
Ën
);

1214 
chª
->
ava_ridx
 = 
ridx
;

1215 
loÿl
 = (
ušt8_t
 *è&
chª
->
ava_ridx
;

1216 
»mÙe_addr
 = 
chª
->
ava_addr
 + 
FRC_DMA_SSN_AVAIL_RIDX_OFFSET
;

1218 if(
	`äcÜe_cİy_to_»mÙe
((
chª
->
ava_ridx
), 
loÿl
, 
»mÙe_addr
)) {

1219 
	`FRCORE_ERROR
("Copy„idx of‡vail„ingo„emote fail!\n");

1220 
	`FRCORE_STAT_INC
(
¡©_s¢_dma_”rÜs
);

1221 
	`FRCORE_SSN_CHAN_AVAIL_UNLOCK
(
chª
);

1222  
FRE_DMA
;

1225 
	`FRCORE_SSN_CHAN_AVAIL_UNLOCK
(
chª
);

1226 
	`memıy
(
buff
, 
chª
->
ava_buff
, 
Ën
* 
RING_BUFF_CELL_SIZE
);

1227  
FRE_SUCCESS
;

1228 
	}
}

1230 
	$äcÜe_s¢_g‘_Úe_block_addr
(
ušt64_t
 *
buff
)

1232 
rv
;

1233 
äcÜe_s¢_chª_t
 *
chª
 = 
NULL
;

1234 
ušt64_t
 
block_addr
 = 0;

1235 
ušt32_t
 
ty³
 = 
FRC_WORK_SSN
;

1238 
chª
 = 
	`äcÜe_s¢_chª_g‘
(
ty³
);

1239 ià(
chª
 =ğ
NULL
)

1241 
	`FRCORE_ERROR
("Invady³ %d.\n", 
ty³
);

1242  
FRE_INIT
;

1246 ià(
	`äcÜe_s¢_chª_ava_g‘
(
chª
, 1, &
block_addr
))

1248 
	`FRCORE_ERROR
("frcore_ssn_chan_avail_get failed!\n");

1249  
FRE_NOSPACE
;

1251 *
buff
 = 
block_addr
;

1253 
rv
 = 
FRE_SUCCESS
;

1254  
rv
;

1255 
	}
}

1258 
	$äcÜe_s¢_chª_com¶_put
(
äcÜe_s¢_chª_t
 *
chª
, 
ušt64_t
 
numb”
, ušt64_ˆ*
buff
)

1260 
ušt64_t
 
ridx
, 
widx
, 
off£t
, 
Ën
, 
Ën1
, 
Ën2
;

1261 
ušt8_t
 *
loÿl
;

1262 
ušt64_t
 
»mÙe_addr
;

1264 
	`FRCORE_CHAN
("chª->com¶_widx=%Îd, chª->com¶_ridx=%Îd\n", (
ULL
)
chª
->
com¶_widx
, (ULL)chª->
com¶_ridx
);

1265 
	`FRCORE_SSN_CHAN_COMPL_LOCK
(
chª
);

1266 
loÿl
 = (
ušt8_t
 *è&
chª
->
com¶_ridx
;

1267 
»mÙe_addr
 = 
chª
->
com¶_addr
 + 
FRC_DMA_SSN_COMPL_RIDX_OFFSET
;

1269 ià(
	`äcÜe_cİy_äom_»mÙe
((
chª
->
com¶_ridx
), 
loÿl
, 
»mÙe_addr
)) {

1270 
	`FRCORE_ERROR
("SYNC„idx & widx of compl„ing from„emote fail!\n");

1271 
	`FRCORE_STAT_INC
(
¡©_s¢_dma_”rÜs
);

1272 
	`FRCORE_SSN_CHAN_COMPL_UNLOCK
(
chª
);

1273  
FRE_DMA
;

1276 
ridx
 = 
chª
->
com¶_ridx
;

1277 
widx
 = 
chª
->
com¶_widx
;

1279 
Ën
 = 
numb”
;

1281 ià((
widx
 - 
ridx
è> (
FRC_DMA_SSN_RING_BUFF_SIZE
 - 
Ën
))

1283 
	`FRCORE_STAT_INC
(
¡©_s¢_com¶_put_no_¥aû
);

1284 
	`FRCORE_SSN_CHAN_COMPL_UNLOCK
(
chª
);

1285  
FRE_NOSPACE
;

1288 
	`memıy
(
chª
->
com¶_buff
, 
buff
, 
Ën
*
RING_BUFF_CELL_SIZE
);

1289 
off£t
 = 
widx
 % 
FRC_DMA_SSN_RING_BUFF_SIZE
;

1291 
Ën1
 = (
FRC_DMA_SSN_RING_BUFF_SIZE
 - 
off£t
è< 
Ën
 ? (FRC_DMA_SSN_RING_BUFF_SIZE - offset) :†en;

1293 
loÿl
 = (
ušt8_t
 *è
chª
->
com¶_buff
;

1294 
»mÙe_addr
 = 
chª
->
com¶_addr
 + 
FRC_DMA_SSN_COMPL_RING_OFFSET
 + 
off£t
 * 
RING_BUFF_CELL_SIZE
;

1296 ià(
	`äcÜe_cİy_to_»mÙe
(
Ën1
*
RING_BUFF_CELL_SIZE
, 
loÿl
, 
»mÙe_addr
)) {

1297 
	`FRCORE_ERROR
("Copy compl„ing buff from„emote fail!\n");

1298 
	`FRCORE_STAT_INC
(
¡©_s¢_dma_”rÜs
);

1299 
	`FRCORE_SSN_CHAN_COMPL_UNLOCK
(
chª
);

1300  
FRE_DMA
;

1303 ià(
Ën1
 < 
Ën
)

1305 
Ën2
 = 
Ën
 - 
Ën1
;

1306 
loÿl
 = (
ušt8_t
 *è
chª
->
com¶_buff
 + 
Ën1
*
RING_BUFF_CELL_SIZE
;

1307 
»mÙe_addr
 = 
chª
->
com¶_addr
 + 
FRC_DMA_SSN_COMPL_RING_OFFSET
;

1309 if(
	`äcÜe_cİy_to_»mÙe
(
Ën2
*
RING_BUFF_CELL_SIZE
, 
loÿl
, 
»mÙe_addr
)) {

1310 
	`FRCORE_ERROR
("Copy compl„ing buff from„emote fail!\n");

1311 
	`FRCORE_STAT_INC
(
¡©_s¢_dma_”rÜs
);

1312 
	`FRCORE_SSN_CHAN_COMPL_UNLOCK
(
chª
);

1313  
FRE_DMA
;

1317 
widx
 +ğ
Ën
;

1318 
	`FRCORE_STAT_ADD
(
¡©_s¢_com¶_put
, 
Ën
);

1320 
chª
->
com¶_widx
 = 
widx
;

1321 
loÿl
 = (
ušt8_t
 *è&
chª
->
com¶_widx
;

1322 
»mÙe_addr
 = 
chª
->
com¶_addr
 + 
FRC_DMA_SSN_COMPL_WIDX_OFFSET
;

1324 ià(
	`äcÜe_cİy_to_»mÙe
((
chª
->
com¶_widx
), 
loÿl
, 
»mÙe_addr
)) {

1325 
	`FRCORE_ERROR
("Copy„idx of compl„ingo„emote fail!\n");

1326 
	`FRCORE_STAT_INC
(
¡©_s¢_dma_”rÜs
);

1327 
	`FRCORE_SSN_CHAN_COMPL_UNLOCK
(
chª
);

1328  
FRE_DMA
;

1330 
	`FRCORE_SSN_CHAN_COMPL_UNLOCK
(
chª
);

1331  
FRE_SUCCESS
;

1332 
	}
}

1334 
	$äcÜe_s¢_chª_po¡_pkt
(
äcÜe_s¢_chª_t
 *
chª
, 
äcÜe_s¢_fifo_t
 *
fifo
, 
ušt64_t
 
loÿl_num
)

1336 
ušt64_t
 
cur
 = 0, 
cur_off£t
 = 0;

1337 
äcÜe_dma_sÿ‰”_desc_t
 
dma_¬g
;

1338 
ušt64_t
 
»mÙe_addr
;

1339 
ušt64_t
 
pkt_»maš
 = 0, 
pkt_po¡ed
 = 0, 
dma_numb
 = 0;

1340 
	`mem£t
(&
dma_¬g
, 0, (
äcÜe_dma_sÿ‰”_desc_t
));

1342 
pkt_»maš
 = 
loÿl_num
;

1344 
dma_numb
 = 0;

1345 
pkt_»maš
)

1347 
cur_off£t
 = (
fifo
->
loÿl_ridx
 + 
cur
 ) % 
FRCORE_CORE_FIFO_NUM
;

1348 ià(
fifo
->
fifo_ûÎ
[
cur_off£t
].
ty³
 =ğ
FRC_SSN_DMA_HEAD
)

1351 
»mÙe_addr
 = 
fifo
->
fifo_ûÎ
[
cur_off£t
].
block_addr
;

1352 
dma_¬g
.
»mÙe_addr
[
dma_numb
] =„emÙe_add¸+ 
FRC_DMA_OFFSET
;

1353 
dma_¬g
.
loÿl_±r
[
dma_numb
] = (
ušt8_t
 *è&(
fifo
->
fifo_ûÎ
[
cur_off£t
].
h—d
);

1354 
dma_¬g
.
size
[
dma_numb
] = (
äc_dma_hdr_t
);

1355 
	`FRCORE_STAT_INC
(
¡©_dma_blocks
);

1356 
dma_numb
++;

1359 
dma_¬g
.
numb”
 = 
dma_numb
;

1360 ià(
	`äcÜe_dma_sÿ‰”
(
DMA_DIR_SEND
, &
dma_¬g
))

1362 
	`FRCORE_ERROR
("frcore_dma_scatter DMA_DIR_SEND fail!\n");

1363 
	`FRCORE_STAT_INC
(
¡©_dma_”rÜs
);

1364 
äcÜe_queue_po¡_pkt_”r
;

1368 
dma_numb
 = 0;

1371 ià(
	`äcÜe_s¢_chª_com¶_put
(
chª
, 1, &
»mÙe_addr
))

1373 
	`FRCORE_ERROR
("put‡ddro compl„ing failed!\n");

1374 
äcÜe_queue_po¡_pkt_”r
;

1377 } ià(
fifo
->
fifo_ûÎ
[
cur_off£t
].
ty³
 =ğ
FRC_SSN_DMA_PAYLOAD
)

1381 
»mÙe_addr
 = 
fifo
->
fifo_ûÎ
[
cur_off£t
].
block_addr
;

1382 
dma_¬g
.
»mÙe_addr
[
dma_numb
] =„emÙe_add¸+ 
fifo
->
fifo_ûÎ
[
cur_off£t
].
·ylßd_off£t
;

1383 
dma_¬g
.
loÿl_±r
[
dma_numb
] = (
ušt8_t
 *è
fifo
->
fifo_ûÎ
[
cur_off£t
].
·ylßd
;

1384 
dma_¬g
.
size
[
dma_numb
] = 
fifo
->
fifo_ûÎ
[
cur_off£t
].
·ylßd_size
;

1385 
	`FRCORE_STAT_INC
(
¡©_dma_pkts
);

1386 
dma_numb
++;

1388 ià(
dma_numb
 =ğ
FRCORE_MAX_DMA_POINTERS
)

1390 
dma_¬g
.
numb”
 = 
dma_numb
;

1391 ià(
	`äcÜe_dma_sÿ‰”
(
DMA_DIR_SEND
, &
dma_¬g
))

1393 
	`FRCORE_ERROR
("frcore_dma_scatter DMA_DIR_SEND fail!\n");

1394 
	`FRCORE_STAT_INC
(
¡©_dma_”rÜs
);

1395 
äcÜe_queue_po¡_pkt_”r
;

1398 
dma_numb
 = 0;

1402 
dma_¬g
.
»mÙe_addr
[
dma_numb
] =„emÙe_add¸+ 
fifo
->
fifo_ûÎ
[
cur_off£t
].
šfo_off£t
;

1403 
dma_¬g
.
loÿl_±r
[
dma_numb
] = (
ušt8_t
 *è&(
fifo
->
fifo_ûÎ
[
cur_off£t
].
šfo
);

1404 
dma_¬g
.
size
[
dma_numb
] = (
äc_dma_pkt_šfo_t
);

1405 
	`FRCORE_STAT_INC
(
¡©_dma_pkt_šfos
);

1406 
dma_numb
++;

1408 ià(
dma_numb
 =ğ
FRCORE_MAX_DMA_POINTERS
)

1410 
dma_¬g
.
numb”
 = 
dma_numb
;

1411 ià(
	`äcÜe_dma_sÿ‰”
(
DMA_DIR_SEND
, &
dma_¬g
))

1413 
	`FRCORE_ERROR
("frcore_dma_scatter DMA_DIR_SEND fail!\n");

1414 
	`FRCORE_STAT_INC
(
¡©_dma_”rÜs
);

1415 
äcÜe_queue_po¡_pkt_”r
;

1418 
dma_numb
 = 0;

1422 
	`FRCORE_ERROR
("FIFO cellƒrrorype!\n");

1423 
äcÜe_queue_po¡_pkt_”r
;

1426 
pkt_»maš
 -= 1;

1428 ià(
pkt_»maš
 == 0)

1430 ià(
dma_numb
 > 0)

1432 
dma_¬g
.
numb”
 = 
dma_numb
;

1433 ià(
	`äcÜe_dma_sÿ‰”
(
DMA_DIR_SEND
, &
dma_¬g
))

1435 
	`FRCORE_ERROR
("frcore_dma_scatter DMA_DIR_SEND fail!\n");

1436 
	`FRCORE_STAT_INC
(
¡©_dma_”rÜs
);

1437 
äcÜe_queue_po¡_pkt_”r
;

1440 
dma_numb
 = 0;

1444 
cur
++;

1445 
pkt_po¡ed
 += 1;

1448 
äcÜe_queue_po¡_pkt_”r
:

1449  
pkt_po¡ed
;

1450 
	}
}

1452 
	$äcÜe_s¢_fifo_po¡
(
äcÜe_s¢_chª_t
 *
chª
, 
äcÜe_s¢_fifo_t
 *
fifo
)

1454 
ušt64_t
 
¥’d_cyşe
;

1455 
ušt64_t
 
loÿl_widx
, 
loÿl_ridx
, 
loÿl_num
, 
po¡ed_num
, 
po¡_num
;

1457 
loÿl_widx
 = 
fifo
->local_widx;

1458 
loÿl_ridx
 = 
fifo
->local_ridx;

1459 
loÿl_num
 = 
loÿl_widx
 - 
loÿl_ridx
;

1461 ià(
loÿl_num
 == 0)

1465 
¥’d_cyşe
 = 
	`cvmx_g‘_cyşe
(è- 
fifo
->
po¡_cyşe
;

1467 ià((
¥’d_cyşe
 < 
FRCORE_CHAN_POST_PERIOD
è&& (
loÿl_num
 < 
FRCORE_CHAN_POST_LWM
))

1472 
	`FRCORE_CHAN
("CHAN %lld: SPEND %lld cycles, %lld…kts in†ocal buffer„ing.\n",

1473 (
ULL
)
chª
->
ty³
, (ULLè
¥’d_cyşe
, (ULLè
loÿl_num
);

1475 
	`FRCORE_CYCLE_RECORDER_INIT
();

1476 
loÿl_num
)

1478 ià(
loÿl_num
 < 
FRCORE_CHAN_POST_LWM
)

1480 
po¡_num
 = 
loÿl_num
;

1484 
po¡_num
 = 
FRCORE_CHAN_POST_LWM
;

1486 
	`FRCORE_CYCLE_RECORDING
();

1488 
po¡ed_num
 = 
	`äcÜe_s¢_chª_po¡_pkt
(
chª
, 
fifo
, 
po¡_num
);

1489 
	`FRCORE_CHAN
("CHAN %lld: frcore_queue_post_pkt…osted_num %lld,…ost_num %lld.\n",

1490 (
ULL
)
chª
->
ty³
, (ULLè
po¡ed_num
, (ULLè
po¡_num
);

1491 ià(
po¡ed_num
 < 
po¡_num
)

1493 
	`FRCORE_STAT_INC
(
¡©_pkt_po¡_”r
);

1494 
	`FRCORE_STAT_ADD
(
¡©_po¡_”r_pkts
, (
po¡_num
 - 
po¡ed_num
));

1498 
	`FRCORE_STAT_INC
(
¡©_pkt_po¡
);

1500 
	`FRCORE_CYCLE_RECORDING
();

1501 
fifo
->
loÿl_ridx
 +ğ
po¡ed_num
;

1502 
fifo
->
po¡_cyşe
 = 
	`cvmx_g‘_cyşe
();

1503 
loÿl_num
 -ğ
po¡ed_num
;

1505 
	`FRCORE_CYCLE_RECORDING
();

1506 
	`FRCORE_CYCLE_RECORD_DUMP
();

1507 
	}
}

1514 
	$äcÜe_s¢_chª_po¡_pkt
(
äcÜe_s¢_chª_t
 *
chª
, 
äcÜe_s¢_fifo_t
 *
fifo
, 
ušt64_t
 
loÿl_num
,

1515 
ušt64_t
 *
block_num
, ušt64_ˆ*
block_addr
)

1517 
ušt64_t
 
cur
 = 0, 
cur_off£t
 = 0;

1518 
äcÜe_dma_sÿ‰”_desc_t
 
dma_¬g
;

1519 
ušt64_t
 
»mÙe_addr
;

1520 
ušt64_t
 
pkt_»maš
 = 0, 
pkt_po¡ed
 = 0, 
dma_numb
 = 0;

1521 
ušt64_t
 
block_numb
 = 0;

1522 
ušt64_t
 *
add»ss
 = 
block_addr
;

1523 #ià
FRC_CONFIG_SSN_WQE_TEST


1524 
cvmx_wqe_t
 *
wqe
[
FRCORE_MAX_DMA_POINTERS
];

1525 
ušt8_t
 
wqe_num
 = 0;

1527 
	`mem£t
(&
dma_¬g
, 0, (
äcÜe_dma_sÿ‰”_desc_t
));

1529 
pkt_»maš
 = 
loÿl_num
;

1531 
dma_numb
 = 0;

1532 
pkt_»maš
)

1534 
cur_off£t
 = (
fifo
->
loÿl_ridx
 + 
cur
 ) % 
FRCORE_CORE_FIFO_NUM
;

1535 ià(
fifo
->
fifo_ûÎ
[
cur_off£t
].
ty³
 =ğ
FRC_SSN_DMA_HEAD
)

1538 
»mÙe_addr
 = 
fifo
->
fifo_ûÎ
[
cur_off£t
].
block_addr
;

1539 
dma_¬g
.
»mÙe_addr
[
dma_numb
] =„emÙe_add¸+ 
FRC_DMA_OFFSET
;

1542 
dma_¬g
.
loÿl_±r
[
dma_numb
] = (
ušt8_t
 *è
fifo
->
fifo_ûÎ
[
cur_off£t
].
·ylßd
;

1543 
dma_¬g
.
size
[
dma_numb
] = 
fifo
->
fifo_ûÎ
[
cur_off£t
].
·ylßd_size
;

1545 
dma_¬g
.
loÿl_±r
[
dma_numb
] = (
ušt8_t
 *è&(
fifo
->
fifo_ûÎ
[
cur_off£t
].
h—d
);

1546 
dma_¬g
.
size
[
dma_numb
] = (
äc_dma_hdr_t
);

1551 
dma_numb
++;

1554 ià(
dma_numb
 =ğ
FRCORE_MAX_DMA_POINTERS
)

1556 
dma_¬g
.
numb”
 = 
dma_numb
;

1557 ià(
	`äcÜe_dma_sÿ‰”
(
DMA_DIR_SEND
, &
dma_¬g
))

1559 
	`FRCORE_ERROR
("frcore_dma_scatter DMA_DIR_SEND fail!\n");

1560 
	`FRCORE_STAT_INC
(
¡©_s¢_dma_”rÜs
);

1561 
äcÜe_queue_po¡_pkt_”r
;

1564 #ià
FRC_CONFIG_SSN_WQE_TEST


1565 
i
 = 0; i < 
wqe_num
; i++)

1567 
	`äcÜe_wÜk_ä“
(
wqe
[
i
]);

1570 
wqe_num
 = 0;

1572 
dma_numb
 = 0;

1594 
add»ss
[
block_numb
++] = 
»mÙe_addr
;

1596 } ià(
fifo
->
fifo_ûÎ
[
cur_off£t
].
ty³
 =ğ
FRC_SSN_DMA_PAYLOAD
)

1600 
»mÙe_addr
 = 
fifo
->
fifo_ûÎ
[
cur_off£t
].
block_addr
;

1601 
dma_¬g
.
»mÙe_addr
[
dma_numb
] =„emÙe_add¸+ 
fifo
->
fifo_ûÎ
[
cur_off£t
].
·ylßd_off£t
;

1602 
dma_¬g
.
loÿl_±r
[
dma_numb
] = (
ušt8_t
 *è
fifo
->
fifo_ûÎ
[
cur_off£t
].
·ylßd
;

1603 
dma_¬g
.
size
[
dma_numb
] = 
fifo
->
fifo_ûÎ
[
cur_off£t
].
·ylßd_size
;

1604 
	`FRCORE_STAT_INC
(
¡©_s¢_dma_pkts
);

1605 
	`FRCORE_STAT_ADD
(
¡©_s¢_dma_by‹s
, 
dma_¬g
.
size
[
dma_numb
]);

1606 
dma_numb
++;

1607 #ià
FRC_CONFIG_SSN_WQE_TEST


1609 
wqe
[
wqe_num
++] = 
fifo
->
fifo_ûÎ
[
cur_off£t
].wqe;

1612 ià(
dma_numb
 =ğ
FRCORE_MAX_DMA_POINTERS
)

1614 
dma_¬g
.
numb”
 = 
dma_numb
;

1615 ià(
	`äcÜe_dma_sÿ‰”
(
DMA_DIR_SEND
, &
dma_¬g
))

1617 
	`FRCORE_ERROR
("frcore_dma_scatter DMA_DIR_SEND fail!\n");

1618 
	`FRCORE_STAT_INC
(
¡©_s¢_dma_”rÜs
);

1619 
äcÜe_queue_po¡_pkt_”r
;

1622 #ià
FRC_CONFIG_SSN_WQE_TEST


1623 
i
 = 0; i < 
wqe_num
; i++)

1625 
	`äcÜe_wÜk_ä“
(
wqe
[
i
]);

1628 
wqe_num
 = 0;

1630 
dma_numb
 = 0;

1634 
dma_¬g
.
»mÙe_addr
[
dma_numb
] =„emÙe_add¸+ 
fifo
->
fifo_ûÎ
[
cur_off£t
].
šfo_off£t
;

1635 
dma_¬g
.
loÿl_±r
[
dma_numb
] = (
ušt8_t
 *è&(
fifo
->
fifo_ûÎ
[
cur_off£t
].
šfo
);

1636 
dma_¬g
.
size
[
dma_numb
] = (
äc_dma_pkt_šfo_t
);

1637 
	`FRCORE_STAT_INC
(
¡©_s¢_dma_pkt_šfos
);

1638 
dma_numb
++;

1640 ià(
dma_numb
 =ğ
FRCORE_MAX_DMA_POINTERS
)

1642 
dma_¬g
.
numb”
 = 
dma_numb
;

1643 ià(
	`äcÜe_dma_sÿ‰”
(
DMA_DIR_SEND
, &
dma_¬g
))

1645 
	`FRCORE_ERROR
("frcore_dma_scatter DMA_DIR_SEND fail!\n");

1646 
	`FRCORE_STAT_INC
(
¡©_s¢_dma_”rÜs
);

1647 
äcÜe_queue_po¡_pkt_”r
;

1650 #ià
FRC_CONFIG_SSN_WQE_TEST


1651 
i
 = 0; i < 
wqe_num
; i++)

1653 
	`äcÜe_wÜk_ä“
(
wqe
[
i
]);

1656 
wqe_num
 = 0;

1658 
dma_numb
 = 0;

1662 
	`´štf
("FIFO cellƒrrorype!\n");

1663 
äcÜe_queue_po¡_pkt_”r
;

1666 
pkt_»maš
 -= 1;

1668 ià(
pkt_»maš
 == 0)

1670 ià(
dma_numb
 > 0)

1672 
dma_¬g
.
numb”
 = 
dma_numb
;

1673 ià(
	`äcÜe_dma_sÿ‰”
(
DMA_DIR_SEND
, &
dma_¬g
))

1675 
	`FRCORE_ERROR
("frcore_dma_scatter DMA_DIR_SEND fail!\n");

1676 
	`FRCORE_STAT_INC
(
¡©_s¢_dma_”rÜs
);

1677 
äcÜe_queue_po¡_pkt_”r
;

1680 #ià
FRC_CONFIG_SSN_WQE_TEST


1681 
i
 = 0; i < 
wqe_num
; i++)

1683 
	`äcÜe_wÜk_ä“
(
wqe
[
i
]);

1686 
wqe_num
 = 0;

1688 
dma_numb
 = 0;

1692 
cur
++;

1693 
pkt_po¡ed
 += 1;

1696 
äcÜe_queue_po¡_pkt_”r
:

1697 *
block_num
 = 
block_numb
;

1698  
pkt_po¡ed
;

1699 
	}
}

1705 
	$äcÜe_s¢_fifo_po¡
(
äcÜe_s¢_chª_t
 *
chª
, 
äcÜe_s¢_fifo_t
 *
fifo
, 
ušt8_t
 
æag
)

1707 
ušt64_t
 
loÿl_widx
, 
loÿl_ridx
, 
loÿl_num
, 
po¡ed_num
, 
po¡_num
;

1708 
ušt64_t
 
block_addr
[
FRCORE_CHAN_POST_LWM
], 
block_num
;

1710 
	`FRCORE_SSN_CHAN_FIFO_LOCK
(
fifo
);

1711 
loÿl_widx
 = 
fifo
->local_widx;

1712 
loÿl_ridx
 = 
fifo
->local_ridx;

1713 
loÿl_num
 = 
loÿl_widx
 - 
loÿl_ridx
;

1715 ià(
æag
)

1717 ià(
loÿl_num
 !ğ
FRCORE_CHAN_POST_LWM
)

1719 
äcÜe_s¢_po¡_pkt_”r
;

1722 ià(
loÿl_num
 == 0)

1724 
äcÜe_s¢_po¡_pkt_”r
;

1730 
loÿl_num
)

1732 ià(
loÿl_num
 < 
FRCORE_CHAN_POST_LWM
)

1734 
po¡_num
 = 
loÿl_num
;

1738 
po¡_num
 = 
FRCORE_CHAN_POST_LWM
;

1742 
po¡ed_num
 = 
	`äcÜe_s¢_chª_po¡_pkt
(
chª
, 
fifo
, 
po¡_num
, &
block_num
, 
block_addr
);

1743 
	`FRCORE_CHAN
("CHAN %lld: frcore_queue_post_pkt…osted_num %lld,…ost_num %lld.\n",

1744 (
ULL
)
chª
->
ty³
, (ULLè
po¡ed_num
, (ULLè
po¡_num
);

1745 ià(
po¡ed_num
 < 
po¡_num
)

1747 
	`FRCORE_STAT_INC
(
¡©_s¢_pkt_po¡_”r
);

1748 
	`FRCORE_STAT_ADD
(
¡©_s¢_po¡_”r_pkts
, (
po¡_num
 - 
po¡ed_num
));

1752 
	`FRCORE_STAT_INC
(
¡©_s¢_pkt_po¡
);

1756 ià(
	`äcÜe_s¢_chª_com¶_put
(
chª
, 
block_num
, 
block_addr
))

1758 
	`FRCORE_ERROR
("put‡ddro compl„ing failed!\n");

1759 
äcÜe_s¢_po¡_pkt_”r
;

1761 
fifo
->
loÿl_ridx
 +ğ
po¡ed_num
;

1762 
CVMX_SYNCWS
;

1763 
fifo
->
po¡_cyşe
 = 
	`cvmx_g‘_cyşe
();

1764 
loÿl_num
 -ğ
po¡ed_num
;

1767 
äcÜe_s¢_po¡_pkt_”r
:

1768 
	`FRCORE_SSN_CHAN_FIFO_UNLOCK
(
fifo
);

1773 
	}
}

1779 
	$äcÜe_s¢_fifo_po¡_no_lock
(
äcÜe_s¢_chª_t
 *
chª
, 
äcÜe_s¢_fifo_t
 *
fifo
, 
ušt8_t
 
æag
)

1781 
ušt64_t
 
loÿl_widx
, 
loÿl_ridx
, 
loÿl_num
, 
po¡ed_num
, 
po¡_num
;

1782 
ušt64_t
 
block_addr
[
FRCORE_CHAN_POST_LWM
], 
block_num
;

1785 
loÿl_widx
 = 
fifo
->local_widx;

1786 
loÿl_ridx
 = 
fifo
->local_ridx;

1787 
loÿl_num
 = 
loÿl_widx
 - 
loÿl_ridx
;

1789 ià(
æag
)

1791 ià(
loÿl_num
 !ğ
FRCORE_CHAN_POST_LWM
)

1793 
äcÜe_s¢_po¡_pkt_”r
;

1796 ià(
loÿl_num
 == 0)

1798 
äcÜe_s¢_po¡_pkt_”r
;

1804 
loÿl_num
)

1806 ià(
loÿl_num
 < 
FRCORE_CHAN_POST_LWM
)

1808 
po¡_num
 = 
loÿl_num
;

1812 
po¡_num
 = 
FRCORE_CHAN_POST_LWM
;

1816 
po¡ed_num
 = 
	`äcÜe_s¢_chª_po¡_pkt
(
chª
, 
fifo
, 
po¡_num
, &
block_num
, 
block_addr
);

1817 
	`FRCORE_CHAN
("CHAN %lld: frcore_queue_post_pkt…osted_num %lld,…ost_num %lld.\n",

1818 (
ULL
)
chª
->
ty³
, (ULLè
po¡ed_num
, (ULLè
po¡_num
);

1819 ià(
po¡ed_num
 < 
po¡_num
)

1821 
	`FRCORE_STAT_INC
(
¡©_s¢_pkt_po¡_”r
);

1822 
	`FRCORE_STAT_ADD
(
¡©_s¢_po¡_”r_pkts
, (
po¡_num
 - 
po¡ed_num
));

1826 
	`FRCORE_STAT_INC
(
¡©_s¢_pkt_po¡
);

1830 ià(
	`äcÜe_s¢_chª_com¶_put
(
chª
, 
block_num
, 
block_addr
))

1832 
	`FRCORE_ERROR
("put‡ddro compl„ing failed!\n");

1833 
äcÜe_s¢_po¡_pkt_”r
;

1835 
fifo
->
loÿl_ridx
 +ğ
po¡ed_num
;

1836 
CVMX_SYNCWS
;

1837 
fifo
->
po¡_cyşe
 = 
	`cvmx_g‘_cyşe
();

1838 
loÿl_num
 -ğ
po¡ed_num
;

1841 
äcÜe_s¢_po¡_pkt_”r
:

1847 
	}
}

1850 #ià!
FRC_CONFIG_SSN_CHAN_TEST


1851 
	$äcÜe_s¢_fifo_add
(
äcÜe_s¢_chª_t
 *
chª
,
äcÜe_s¢_fifo_t
 *
fifo
, 
ušt64_t
 
dma_ty³
,

1852 
äc_dma_hdr_t
 *
hdr
, 
äc_dma_pkt_šfo_t
 *
šfo
, *
·ylßd
,

1853 
ušt64_t
 
block_addr
, 
ušt16_t
 
šfo_off£t
, ušt16_ˆ
·ylßd_off£t
, 
cvmx_wqe_t
 *
wqe
)

1855 
rv
 = 0;

1856 
hdr_size
, 
šfo_size
, 
·yËn
;

1857 
ušt64_t
 
idx_off£t
 = 0;

1859 
hdr_size
 = (
äc_dma_hdr_t
);

1860 
šfo_size
 = (
äc_dma_pkt_šfo_t
);

1862 
	`FRCORE_SSN_CHAN_FIFO_LOCK
(
fifo
);

1864 
	`äcÜe_s¢_fifo_po¡_no_lock
(
chª
, 
fifo
, 1);

1866 ià((
fifo
->
loÿl_widx
 - fifo->
loÿl_ridx
è>ğ
FRCORE_CORE_FIFO_NUM
)

1868 
rv
 = 
FRE_NOSPACE
;

1869 
	`FRCORE_STAT_INC
(
¡©_s¢_queue_no_¥aû
);

1870 
äcÜe_s¢_fifo_add_”r
;

1873 
idx_off£t
 = 
fifo
->
loÿl_widx
 % 
FRCORE_CORE_FIFO_NUM
;

1875 ià(
dma_ty³
 =ğ
FRC_SSN_DMA_HEAD
)

1877 
	`memıy
(&
fifo
->
fifo_ûÎ
[
idx_off£t
].
h—d
, 
hdr
, 
hdr_size
);

1879 
·yËn
 = 
šfo
->
·ylßd_Ën
;

1880 
fifo
->
fifo_ûÎ
[
idx_off£t
].
šfo_off£t
 = info_offset;

1881 
fifo
->
fifo_ûÎ
[
idx_off£t
].
·ylßd_off£t
 =…ayload_offset;

1882 
fifo
->
fifo_ûÎ
[
idx_off£t
].
·ylßd_size
 = 
·yËn
;

1883 #ià
FRC_CONFIG_SSN_WQE_TEST


1884 
fifo
->
fifo_ûÎ
[
idx_off£t
].
·ylßd
 =…ayload;

1885 
fifo
->
fifo_ûÎ
[
idx_off£t
].
wqe
 = wqe;

1887 
	`memıy
(
fifo
->
fifo_ûÎ
[
idx_off£t
].
·ylßd
,…aylßd, 
·yËn
);

1888 
	`äcÜe_wÜk_ä“
(
wqe
);

1890 
	`memıy
(&
fifo
->
fifo_ûÎ
[
idx_off£t
].
šfo
, info, 
šfo_size
);

1892 
fifo
->
fifo_ûÎ
[
idx_off£t
].
block_addr
 = block_addr;

1893 
fifo
->
fifo_ûÎ
[
idx_off£t
].
ty³
 = 
dma_ty³
;

1897 
fifo
->
loÿl_widx
++;

1898 
CVMX_SYNCWS
;

1900 
äcÜe_s¢_fifo_add_”r
:

1901 
	`FRCORE_SSN_CHAN_FIFO_UNLOCK
(
fifo
);

1902  
rv
;

1903 
	}
}

1906 
	$äcÜe_fÜw¬d_s¢_pkt_to_fifo
(
ušt32_t
 
ty³
,ušt32_ˆ
šdex
, 
ušt64_t
 
dma_ty³
,

1907 
äc_dma_hdr_t
 *
hdr
, 
äc_dma_pkt_šfo_t
 *
šfo
,

1908 *
·ylßd
,
ušt64_t
 
block_addr
, 
ušt16_t
 
šfo_off£t
,

1909 
ušt16_t
 
·ylßd_off£t
, 
cvmx_wqe_t
 *
wqe
)

1911 
num
, 
rv
;

1912 
äcÜe_s¢_chª_t
 *
chª
;

1913 
äcÜe_s¢_fifo_t
 *
fifo
;

1914 
ušt32_t
 
fifo_id
 = 0;

1916 
chª
 = 
	`äcÜe_s¢_chª_g‘
(
ty³
);

1917 ià(
chª
 =ğ
NULL
)

1919 
	`FRCORE_ERROR
("Invad chª_id %d.\n", 
ty³
);

1920  
FRE_INIT
;

1923 
fifo_id
 = 
šdex
 % 
FRC_SSN_FIFO_NUM
;

1924 
fifo
 = 
	`äcÜe_s¢_fifo_g‘
(
ty³
, 
fifo_id
);

1925 ià(
fifo
 =ğ
NULL
)

1927 
	`FRCORE_ERROR
("Invady³ %d fifo_id %d.\n", 
ty³
, 
fifo_id
);

1928  
FRE_INIT
;

1934 
num
 = 
	`äcÜe_s¢_fifo_add
(
chª
, 
fifo
, 
dma_ty³
, 
hdr
, 
šfo
, 
·ylßd
, 
block_addr
,

1935 
šfo_off£t
, 
·ylßd_off£t
, 
wqe
);

1936 ià(
num
 != 0)

1938 
	`FRCORE_ERROR
("ssn fifoƒxceed!\n");

1939 
	`FRCORE_STAT_INC
(
¡©_s¢_dma_’queue_”rs
);

1940 
rv
 = 
FRE_EXCEED
;

1941 
äcÜe_fÜw¬d_pkt_to_ho¡_”r
;

1945 
	`FRCORE_STAT_INC
(
¡©_s¢_dma_’queue_pkts
);

1948 
rv
 = 
FRE_SUCCESS
;

1950 
äcÜe_fÜw¬d_pkt_to_ho¡_”r
:

1951  
rv
;

1952 
	}
}

1956 #ià
FRC_CONFIG_SSN_CHAN_TEST


1957 
	$äcÜe_s¢_chª_pkt_to_fifo_‹¡
(
ušt32_t
 
ty³
)

1959 
rv
;

1960 
äcÜe_s¢_chª_t
 *
chª
 = 
NULL
;

1961 
äcÜe_s¢_fifo_t
 *
fifo
 = 
NULL
;

1962 
ušt64_t
 
block_addr
 = 0;

1963 
ušt8_t
 
d©a
[
FRC_DMA_SSN_BLOCK_SIZE
];

1964 
ušt32_t
 
fifo_id
 = 0, 
idx_off£t
;

1965 
ušt32_t
 
i
;

1966 
ušt16_t
 
·ylßd_off£t
 = 
FRC_DMA_OFFSET
 + (
äc_dma_hdr_t
), 
šfo_off£t
 = 
FRC_DMA_SSN_BLOCK_SIZE
 - (
äc_dma_pkt_šfo_t
) ;

1967 #ià
FRC_CONFIG_SSN_CHAN_TEST_ONE_BLOCK_ONE_PAYLOD


1968 
ušt16_t
 
·yËn
 = 512;

1970 
ušt16_t
 
·yËn
 = (
FRC_DMA_SSN_BLOCK_SIZE
 - (
äc_dma_hdr_t
è- 
FRC_DMA_OFFSET
)/16 - (
äc_dma_pkt_šfo_t
);

1972 
fifo_id
 = 
	`cvmx_g‘_cÜe_num
();

1974 
chª
 = 
	`äcÜe_s¢_chª_g‘
(
ty³
);

1975 ià(
chª
 =ğ
NULL
)

1977 
	`FRCORE_ERROR
("Invady³ %d.\n", 
ty³
);

1978  
FRE_INIT
;

1981 
fifo
 = 
	`äcÜe_s¢_fifo_g‘
(
ty³
, 
fifo_id
);

1982 ià(
fifo
 =ğ
NULL
)

1984 
	`FRCORE_ERROR
("Invady³ %d fifo_id %d.\n", 
ty³
, 
fifo_id
);

1985  
FRE_INIT
;

1989 ià(
	`äcÜe_s¢_g‘_Úe_block_addr
(&
block_addr
))

1991 
	`FRCORE_ERROR
("frcore_ssn_chan_avail_get failed!\n");

1992  
FRE_NOSPACE
;

1997 ià((
fifo
->
loÿl_widx
 - fifo->
loÿl_ridx
è> 
FRCORE_CORE_FIFO_NUM
 - 9)

1999 
	`FRCORE_TEST
("FIFO‚oƒnough space\n");

2000  
FRE_NOSPACE
;

2004 
	`¤ªd
((
ušt32_t
è
	`cvmx_g‘_cyşe
());

2005 
i
 = 0; i < 
FRC_DMA_SSN_DATA_SIZE
 - 1; i++)

2007 
d©a
[
i
 + 
FRC_DMA_OFFSET
] = (
ušt8_t
)
	`¿nd
();

2009 
d©a
[
i
+ 
FRC_DMA_OFFSET
] = 
	`ÿl_üc
(&d©a[FRC_DMA_OFFSET], 
FRC_DMA_SSN_DATA_SIZE
 -1);

2018 #ià
FRC_CONFIG_SSN_CHAN_TEST


2019 #ià
FRC_CONFIG_SSN_CHAN_TEST_ONE_BLOCK_ONE_PAYLOD


2020 
idx_off£t
 = 
fifo
->
loÿl_widx
 % 
FRCORE_CORE_FIFO_NUM
;

2021 
fifo
->
fifo_ûÎ
[
idx_off£t
].
ty³
 = 
FRC_SSN_DMA_PAYLOAD
;

2022 
fifo
->
fifo_ûÎ
[
idx_off£t
].
block_addr
 = block_addr;

2023 
	`memıy
(
fifo
->
fifo_ûÎ
[
idx_off£t
].
·ylßd
, &
d©a
[
·ylßd_off£t
], 
·yËn
);

2024 
fifo
->
fifo_ûÎ
[
idx_off£t
].
·ylßd_size
 = 
·yËn
;

2025 
fifo
->
fifo_ûÎ
[
idx_off£t
].
·ylßd_off£t
 =…ayload_offset;

2026 
	`memıy
(&
fifo
->
fifo_ûÎ
[
idx_off£t
].
šfo
, &
d©a
[
šfo_off£t
], (
äc_dma_pkt_šfo_t
));

2027 
fifo
->
fifo_ûÎ
[
idx_off£t
].
šfo_off£t
 = info_offset;

2028 
fifo
->
loÿl_widx
++;

2031 
i
 = 0; i < 16; i++ )

2033 
idx_off£t
 = 
fifo
->
loÿl_widx
 % 
FRCORE_CORE_FIFO_NUM
;

2034 
fifo
->
fifo_ûÎ
[
idx_off£t
].
ty³
 = 
FRC_SSN_DMA_PAYLOAD
;

2035 
fifo
->
fifo_ûÎ
[
idx_off£t
].
block_addr
 = block_addr;

2036 
	`memıy
(
fifo
->
fifo_ûÎ
[
idx_off£t
].
·ylßd
, &
d©a
[
·ylßd_off£t
], 
·yËn
);

2037 
fifo
->
fifo_ûÎ
[
idx_off£t
].
·ylßd_size
 = 
·yËn
;

2038 
fifo
->
fifo_ûÎ
[
idx_off£t
].
·ylßd_off£t
 =…ayload_offset;

2039 
	`memıy
(&
fifo
->
fifo_ûÎ
[
idx_off£t
].
šfo
, &
d©a
[
šfo_off£t
], (
äc_dma_pkt_šfo_t
));

2040 
fifo
->
fifo_ûÎ
[
idx_off£t
].
šfo_off£t
 = info_offset;

2041 
fifo
->
loÿl_widx
++;

2044 
·ylßd_off£t
 +ğ
·yËn
;

2045 
šfo_off£t
 -ğ(
äc_dma_pkt_šfo_t
);

2051 
idx_off£t
 = 
fifo
->
loÿl_widx
 % 
FRCORE_CORE_FIFO_NUM
;

2052 
fifo
->
fifo_ûÎ
[
idx_off£t
].
ty³
 = 
FRC_SSN_DMA_HEAD
;

2053 
fifo
->
fifo_ûÎ
[
idx_off£t
].
block_addr
 = block_addr;

2054 
	`memıy
(&
fifo
->
fifo_ûÎ
[
idx_off£t
].
h—d
, &
d©a
[
FRC_DMA_OFFSET
], (
äc_dma_hdr_t
));

2055 
fifo
->
loÿl_widx
++;

2058 
idx_off£t
 = 
fifo
->
loÿl_widx
 % 
FRCORE_CORE_FIFO_NUM
;

2059 
fifo
->
fifo_ûÎ
[
idx_off£t
].
ty³
 = 
FRC_SSN_DMA_HEAD
;

2060 
fifo
->
fifo_ûÎ
[
idx_off£t
].
block_addr
 = block_addr;

2061 
	`memıy
(
fifo
->
fifo_ûÎ
[
idx_off£t
].
·ylßd
, &
d©a
[
FRC_DMA_OFFSET
], 
FRC_DMA_SSN_BLOCK_SIZE
-FRC_DMA_OFFSET);

2062 
fifo
->
fifo_ûÎ
[
idx_off£t
].
·ylßd_size
 = 
FRC_DMA_SSN_BLOCK_SIZE
-
FRC_DMA_OFFSET
;

2063 
fifo
->
loÿl_widx
++;

2066 
rv
 = 
FRE_SUCCESS
;

2067  
rv
;

2068 
	}
}

2070 
	$äcÜe_fÜw¬d_s¢_pkt_to_fifos_‹¡
(
ušt32_t
 
ty³
)

2072 
num
, 
rv
;

2073 
äcÜe_s¢_fifo_t
 *
fifo
;

2074 
ušt32_t
 
fifo_id
 = 0;

2075 
fifo_id
 = 
	`cvmx_g‘_cÜe_num
();

2077 
fifo
 = 
	`äcÜe_s¢_fifo_g‘
(
ty³
, 
fifo_id
);

2078 ià(
fifo
 =ğ
NULL
)

2080 
	`FRCORE_ERROR
("Invady³ %d fifo_id %d.\n", 
ty³
, 
fifo_id
);

2081  
FRE_INIT
;

2083 
num
 = 0;‚um < 100;‚um++)

2085 ià((
fifo
->
loÿl_widx
 - fifo->
loÿl_ridx
è> 
FRCORE_CORE_FIFO_NUM
 - 9)

2089 
	`äcÜe_s¢_chª_pkt_to_fifo_‹¡
(
ty³
);

2092 
rv
 = 
FRE_SUCCESS
;

2093  
rv
;

2094 
	}
}

2102 #ià
FRC_CONFIG_SIMPLE_PACKET_TEST


2103 
	$äcÜe_fÜw¬d_sim¶e_pkt_to_fifo_‹¡
(
ušt32_t
 
ty³
)

2105 
num
, 
rv
;

2106 
äcÜe_sim¶e_·ckage_fifo_t
 *
fifo
;

2107 
ušt32_t
 
fifo_id
 = 0, 
idx_off£t
;

2108 
ušt32_t
 
i
;

2109 
fifo_id
 = 
	`cvmx_g‘_cÜe_num
();

2111 
fifo
 = 
	`äcÜe_sim¶e_·ckage_fifo_g‘
(
ty³
, 
fifo_id
);

2112 ià(
fifo
 =ğ
NULL
)

2114 
	`FRCORE_ERROR
("Invady³ %d fifo_id %d.\n", 
ty³
, 
fifo_id
);

2115  
FRE_INIT
;

2117 
num
 = 0;‚um < 10000;‚um++)

2119 ià((
fifo
->
loÿl_widx
 - fifo->
loÿl_ridx
è>ğ
FRCORE_CORE_FIFO_NUM
)

2123 
	`¤ªd
((
ušt32_t
è
	`cvmx_g‘_cyşe
());

2124 
idx_off£t
 = 
fifo
->
loÿl_widx
 % 
FRCORE_CORE_FIFO_NUM
;

2125 
fifo
->
fifo_ûÎ
[
idx_off£t
].
pkt_size
 = 
FRC_DMA_SIMPLE_PACKAGE_DATA_SIZE
;

2126 
i
 = 0; i < 
FRC_DMA_SIMPLE_PACKAGE_DATA_SIZE
-1; i++)

2128 
fifo
->
fifo_ûÎ
[
idx_off£t
].
d©a
[
i
] = (
ušt8_t
)
	`¿nd
();

2130 
fifo
->
fifo_ûÎ
[
idx_off£t
].
d©a
[
i
] = 
	`ÿl_üc
(fifo->fifo_ûÎ[idx_off£t].d©a, 
FRC_DMA_SIMPLE_PACKAGE_DATA_SIZE
-1);

2131 
fifo
->
loÿl_widx
++;

2135 
rv
 = 
FRE_SUCCESS
;

2136  
rv
;

2137 
	}
}

2140 #ià
FRC_CONFIG_SIMPLE_PACKET_TEST
 || 
FRC_CONFIG_SSN_CHAN_TEST


2141 
	$äcÜe_chª_‹¡_´oûss
(
cvmx_wqe_t
 *
wqe
)

2143 
ušt8_t
 
fifo_id
, 
ty³
;

2144 
cÜe_num
;

2145 
ty³
 = 
wqe
->
·ck‘_d©a
[0];

2146 
fifo_id
 = 
wqe
->
·ck‘_d©a
[1];

2148 
cÜe_num
 = 
	`cvmx_g‘_cÜe_num
();

2149 ià(
cÜe_num
 !ğ
fifo_id
)

2151 
	`FRCORE_ERROR
("CHAN %Îd(%sècÜe_num(%dè!ğfifo_id(%d).\n", (
ULL
)
ty³
,

2152 (
ty³
 =ğ
FRC_WORK_UDP
 ? "UDP":Ñy³==
FRC_WORK_RULE
 ? "RULE":"SSN")),

2153 
cÜe_num
, 
fifo_id
);

2155 ià(
ty³
 !ğ
FRC_WORK_UDP
 &&y³ !ğ
FRC_WORK_RULE
 &&y³ !ğ
FRC_WORK_SSN
)

2157 
	`FRCORE_ERROR
("CHAN %Îd(%s)\n", (
ULL
)
ty³
,

2158 (
ty³
 =ğ
FRC_WORK_UDP
 ? "UDP":Ñy³==
FRC_WORK_RULE
 ? "RULE":Ñy³==
FRC_WORK_SSN
)?"SSN":"OTHERS")));

2161 ià(
ty³
 =ğ
FRC_WORK_UDP
 ||y³ =ğ
FRC_WORK_RULE
)

2163 #ià
FRC_CONFIG_SIMPLE_PACKET_TEST


2164 
	`äcÜe_fÜw¬d_sim¶e_pkt_to_fifo_‹¡
(
ty³
);

2166 }ià(
ty³
 =ğ
FRC_WORK_SSN
)

2168 #ià
FRC_CONFIG_SSN_CHAN_TEST


2169 
	`äcÜe_fÜw¬d_s¢_pkt_to_fifos_‹¡
(
ty³
);

2173 ià(
	`cvmx_tim_add_’Œy
(
wqe
, 
FRCORE_CHAN_TIMEOUT
, 
NULL
è!ğ
CVMX_TIM_STATUS_SUCCESS
) {

2174 
	`FRCORE_ERROR
("dma chanimer‡dd fail!\n");

2175  
FRE_FAIL
;

2177  
FRCORE_ACT_UNFREE
;

2178 
	}
}

2181 
	$äcÜe_chª_´oûss
(
cvmx_wqe_t
 *
wqe
)

2183 
ušt8_t
 
fifo_id
, 
ty³
;

2184 
äcÜe_sim¶e_·ckage_chª_t
 *
sim¶e_chª
 = 
NULL
;

2185 
äcÜe_sim¶e_·ckage_fifo_t
 *
sim¶e_fifo
 = 
NULL
;

2186 
äcÜe_s¢_chª_t
 *
s¢_chª
 = 
NULL
;

2187 
äcÜe_s¢_fifo_t
 *
s¢_fifo
 = 
NULL
;

2188 
cÜe_num
;

2189 
ty³
 = 
wqe
->
·ck‘_d©a
[0];

2190 
fifo_id
 = 
wqe
->
·ck‘_d©a
[1];

2192 
cÜe_num
 = 
	`cvmx_g‘_cÜe_num
();

2193 ià(
cÜe_num
 !ğ
fifo_id
%
FRC_DAT_CORE_NUM
)

2195 
	`´štf
("CHAN %Îd(%sècÜe_num(%dè!ğfifo_id(%d).\n", (
ULL
)
ty³
,

2196 (
ty³
 =ğ
FRC_WORK_UDP
 ? "UDP":Ñy³==
FRC_WORK_RULE
 ? "RULE":"SSN")),

2197 
cÜe_num
, 
fifo_id
);

2199 ià(
ty³
 !ğ
FRC_WORK_UDP
 &&y³ !ğ
FRC_WORK_RULE
 &&y³ !ğ
FRC_WORK_SSN
)

2201 
	`´štf
("CHAN %Îd(%s)\n", (
ULL
)
ty³
,

2202 (
ty³
 =ğ
FRC_WORK_UDP
 ? "UDP":Ñy³==
FRC_WORK_RULE
 ? "RULE":Ñy³==
FRC_WORK_SSN
)?"SSN":"OTHERS")));

2205 ià(
ty³
 =ğ
FRC_WORK_UDP
 )

2207 #ià
FRC_CONFIG_SIMPLE_PACKAGE


2208 
sim¶e_chª
 = 
	`äcÜe_sim¶e_·ckage_chª_g‘
(
ty³
);

2209 ià(
sim¶e_chª
 =ğ
NULL
)

2211 
	`´štf
("Invad chª_id %d.\n", 
ty³
);

2212  
FRE_FAIL
;

2215 
sim¶e_fifo
 = 
	`äcÜe_sim¶e_·ckage_fifo_g‘
(
ty³
, 
fifo_id
%
FRC_DAT_CORE_NUM
);

2216 ià(
sim¶e_fifo
 =ğ
NULL
)

2218 
	`´štf
("Invad fifo_id %d.\n", 
fifo_id
%
FRC_DAT_CORE_NUM
);

2219  
FRE_FAIL
;

2223 
	`äcÜe_sim¶e_·ckage_fifo_po¡
(
sim¶e_chª
,
sim¶e_fifo
, 
fifo_id
%
FRC_DAT_CORE_NUM
, 0);

2225 }ià(
ty³
 =ğ
FRC_WORK_RULE
)

2227 #ià
FRC_CONFIG_SIMPLE_PACKAGE


2228 
sim¶e_chª
 = 
	`äcÜe_sim¶e_·ckage_chª_g‘
(
ty³
);

2229 ià(
sim¶e_chª
 =ğ
NULL
)

2231 
	`´štf
("Invad chª_id %d.\n", 
ty³
);

2232  
FRE_FAIL
;

2235 
sim¶e_fifo
 = 
	`äcÜe_sim¶e_·ckage_fifo_g‘
(
ty³
, 
fifo_id
%
FRC_DAT_CORE_NUM
);

2236 ià(
sim¶e_fifo
 =ğ
NULL
)

2238 
	`´štf
("Invad fifo_id %d.\n", 
fifo_id
%
FRC_DAT_CORE_NUM
);

2239  
FRE_FAIL
;

2243 
	`äcÜe_ruË_fifo_po¡
(
sim¶e_chª
,
sim¶e_fifo
, 
fifo_id
%
FRC_DAT_CORE_NUM
, 0);

2245 }ià(
ty³
 =ğ
FRC_WORK_SSN
)

2247 #ià
FRC_CONFIG_SSN_CHAN


2248 
s¢_chª
 = 
	`äcÜe_s¢_chª_g‘
(
ty³
);

2249 ià(
s¢_chª
 =ğ
NULL
)

2251 
	`´štf
("Invad chª_id %d.\n", 
ty³
);

2252  
FRE_FAIL
;

2255 
s¢_fifo
 = 
	`äcÜe_s¢_fifo_g‘
(
ty³
, 
fifo_id
);

2256 ià(
s¢_fifo
 =ğ
NULL
)

2258 
	`´štf
("Invad fifo_id %d.\n", 
fifo_id
);

2259  
FRE_FAIL
;

2263 
	`äcÜe_s¢_fifo_po¡
(
s¢_chª
,
s¢_fifo
,0);

2268 ià(
	`cvmx_tim_add_’Œy
(
wqe
, 
FRCORE_CHAN_TIMEOUT
, 
NULL
è!ğ
CVMX_TIM_STATUS_SUCCESS
) {

2269 
	`´štf
("dma chanimer‡dd fail!\n");

2270  
FRE_FAIL
;

2272  
FRCORE_ACT_DEBUG
;

2273 
	}
}

2275 
	$äcÜe_´št_block_u§ge
()

2277 
ušt64_t
 
ava_widx
, 
ava_ridx
;

2278 
ušt64_t
 
com¶_widx
, 
com¶_ridx
;

2279 
i
;

2280 
äcÜe_sim¶e_·ckage_chª_t
 *
sim¶e_chª
 = 
NULL
;

2281 
äcÜe_s¢_chª_t
 *
s¢_chª
 = 
NULL
;

2284 
i
 = 0; i < 2; i++) {

2285 #ià
FRC_CONFIG_SIMPLE_PACKAGE


2286 
sim¶e_chª
 = 
	`äcÜe_sim¶e_·ckage_chª_g‘
(
i
);

2287 
	`FRCORE_SIMPLE_PACKAGE_CHAN_AVAIL_LOCK
(
sim¶e_chª
);

2288 
ava_widx
 = 
sim¶e_chª
->avail_widx;

2289 
ava_ridx
 = 
sim¶e_chª
->avail_ridx;

2290 
	`FRCORE_SIMPLE_PACKAGE_CHAN_AVAIL_UNLOCK
(
sim¶e_chª
);

2295 
	`´štf
("%-4s: %6d blocks, %6d us, %6d id\n", (
i
==0)?"UDP":"RULE", 
FRC_SIMPLE_RING_BUFF_SIZE
,

2296 
FRC_SIMPLE_RING_BUFF_SIZE
-(
ava_widx
 - 
ava_ridx
),‡vail_widx-avail_ridx);

2300 #ià
FRC_CONFIG_SSN_CHAN


2302 
s¢_chª
 = 
	`äcÜe_s¢_chª_g‘
(
FRC_WORK_SSN
);

2303 
	`FRCORE_SSN_CHAN_AVAIL_LOCK
(
s¢_chª
);

2304 
ava_widx
 = 
s¢_chª
->avail_widx;

2305 
ava_ridx
 = 
s¢_chª
->avail_ridx;

2306 
	`FRCORE_SSN_CHAN_AVAIL_UNLOCK
(
s¢_chª
);

2307 
	`´štf
("SSN : %6d blocks, %6u us, %6u id\n", 
FRC_DMA_SSN_RING_BUFF_SIZE
,

2308 
FRC_DMA_SSN_RING_BUFF_SIZE
-(
ava_widx
 - 
ava_ridx
),‡vail_widx-avail_ridx);

2317 
	}
}

	@frcore/frcore_chan.h

1 #iâdeà
__FRCORE_QUEUE_H__


2 
	#__FRCORE_QUEUE_H__


	)

4 #ià
FRC_CONFIG_SIMPLE_PACKAGE


5 
äcÜe_sim¶e_·ckage_chª_š™
();

6 
äcÜe_fÜw¬d_sim¶e_pkt_to_fifo
(
ušt32_t
 
ty³
, 
äc_dma_hdr_t
 *
hdr
, 
äc_dma_pkt_šfo_t
 *
šfo
, *
·ylßd
);

7 #ià
FRC_CONFIG_RULE


8 
äcÜe_fÜw¬d_ruË_pkt_to_fifo
(
ušt16_t
 *
gid
, 
äc_dma_hdr_t
 *
hdr
, 
äc_dma_pkt_šfo_t
 *
šfo
, *
·ylßd
);

12 #ià
FRC_CONFIG_SSN_CHAN


13 
äcÜe_s¢_chª_š™
();

14 
äcÜe_fÜw¬d_s¢_pkt_to_fifo
(
ušt32_t
 
ty³
,ušt32_ˆ
šdex
, 
ušt64_t
 
dma_ty³
,

15 
äc_dma_hdr_t
 *
hdr
, 
äc_dma_pkt_šfo_t
 *
šfo
,

16 *
·ylßd
,
ušt64_t
 
block_addr
, 
ušt16_t
 
šfo_off£t
,

17 
ušt16_t
 
·ylßd_off£t
, 
cvmx_wqe_t
 *
wqe
);

18 
äcÜe_s¢_g‘_Úe_block_addr
(
ušt64_t
 *
buff
, 
ušt32_t
 
fifo_id
);

21 #ià
FRC_CONFIG_SIMPLE_PACKET_TEST


22 
äcÜe_fÜw¬d_sim¶e_pkt_to_fifo_‹¡
(
ušt32_t
 
ty³
);

23 
äcÜe_chª_‹¡_´oûss
(
cvmx_wqe_t
 *
wqe
);

26 
äcÜe_chª_´oûss
(
cvmx_wqe_t
 *
wqe
);

27 
äcÜe_´št_block_u§ge
();

	@frcore/frcore_cmd.c

1 
	~"cvmcs-commÚ.h
"

2 
	~<cvmx-©omic.h
>

3 
	~"äc.h
"

4 
	~"äcÜe.h
"

5 
	~"äcÜe_dma.h
"

6 
	~"äcÜe_cmd.h
"

7 
	~"äc_ut.h
"

9 
CVMX_SHARED
 
äcÜe_cmd_£t_t
 *
	gäcÜe_cmd£t
;

10 
CVMX_SHARED
 
äcÜe_»¥Úd_buf_t
 *
	gäcÜe_cmd_»¥Úd_buf
 = 
NULL
;

12 
	#FRCORE_RESPOND_BUF_GET
(
_cÜe_id
è
äcÜe_cmd_»¥Úd_buf
 + (
FRC_CMD_RESPOND_BUF_SZ
 * (_cÜe_id))

	)

15 
	$äcÜe_cmd_š™
()

17 
äcÜe_cmd£t
 = 
	`cvmx_boÙmem_®loc
((
äcÜe_cmd_£t_t
è* 
CMD_TYPE_MAX
, (frcore_cmd_set_t));

18 ià(
äcÜe_cmd£t
 =ğ
NULL
)

20 
	`FRCORE_ERROR
("Alloc cmd set fail!\n");

21  
FRE_FAIL
;

23 
	`mem£t
(
äcÜe_cmd£t
, 0, ((
äcÜe_cmd_£t_t
è* 
CMD_TYPE_MAX
));

27 
äcÜe_cmd£t
[
CMD_TYPE_TEST
].
veùÜ
 = 
	`cvmx_boÙmem_®loc
((
äcÜe_cmd_cb_t
è* 
TEST_CMD_MAX
, (frcore_cmd_cb_t));

28 ià(
äcÜe_cmd£t
[
CMD_TYPE_TEST
].
veùÜ
 =ğ
NULL
)

30 
	`FRCORE_ERROR
("Allocest cmd vector fail!\n");

31  
FRE_FAIL
;

33 
	`mem£t
(
äcÜe_cmd£t
[
CMD_TYPE_TEST
].
veùÜ
, 0, (
äcÜe_cmd_cb_t
è* 
TEST_CMD_MAX
);

34 
äcÜe_cmd£t
[
CMD_TYPE_TEST
].
max
 = 
TEST_CMD_MAX
;

35 
äcÜe_cmd£t
[
CMD_TYPE_TEST
].
num
 = 0;

38 
äcÜe_cmd£t
[
CMD_TYPE_CTRL
].
veùÜ
 = 
	`cvmx_boÙmem_®loc
((
äcÜe_cmd_cb_t
è* 
CTRL_CMD_MAX
, (frcore_cmd_cb_t));

39 ià(
äcÜe_cmd£t
[
CMD_TYPE_CTRL
].
veùÜ
 =ğ
NULL
)

41 
	`FRCORE_ERROR
("Allocest cmd vector fail!\n");

42  
FRE_FAIL
;

44 
	`mem£t
(
äcÜe_cmd£t
[
CMD_TYPE_CTRL
].
veùÜ
, 0, (
äcÜe_cmd_cb_t
è* 
CTRL_CMD_MAX
);

45 
äcÜe_cmd£t
[
CMD_TYPE_CTRL
].
max
 = 
CTRL_CMD_MAX
;

46 
äcÜe_cmd£t
[
CMD_TYPE_CTRL
].
num
 = 0;

49 
äcÜe_cmd£t
[
CMD_TYPE_USER
].
veùÜ
 = 
	`cvmx_boÙmem_®loc
((
äcÜe_cmd_cb_t
è* 
USER_CMD_MAX
, (frcore_cmd_cb_t));

50 ià(
äcÜe_cmd£t
[
CMD_TYPE_USER
].
veùÜ
 =ğ
NULL
)

52 
	`FRCORE_ERROR
("Allocest cmd vector fail!\n");

53  
FRE_FAIL
;

55 
	`mem£t
(
äcÜe_cmd£t
[
CMD_TYPE_USER
].
veùÜ
, 0, (
äcÜe_cmd_cb_t
è* 
USER_CMD_MAX
);

56 
äcÜe_cmd£t
[
CMD_TYPE_USER
].
max
 = 
USER_CMD_MAX
;

57 
äcÜe_cmd£t
[
CMD_TYPE_USER
].
num
 = 0;

60 
äcÜe_cmd_»¥Úd_buf
 = 
	`cvmx_boÙmem_®loc
((
äcÜe_»¥Úd_buf_t
è* 
FRC_CORE_MAX
, 0);

62 ià(
äcÜe_cmd_»¥Úd_buf
 =ğ
NULL
)

64 
	`FRCORE_ERROR
("Alloc cmd„espond buffer fail!\n");

65  
FRE_FAIL
;

68  
FRE_SUCCESS
;

69 
	}
}

72 
	$äcÜe_cmd_»gi¡”
(
ušt16_t
 
ty³
, ušt16_ˆ
cmd
, 
äcÜe_cmd_â_t
 
â
)

74 
äcÜe_cmd_£t_t
 *
cmd_£t
;

75 
äcÜe_cmd_cb_t
 *
cb
;

77 ià(
ty³
 >ğ
CMD_TYPE_MAX
)

79  
FRE_UNSUPPORT
;

82 
cmd_£t
 = &
äcÜe_cmd£t
[
ty³
];

84 ià(
cmd
 >ğ
cmd_£t
->
max
)

86  
FRE_UNSUPPORT
;

89 
cb
 = &
cmd_£t
->
veùÜ
[
cmd
];

91 ià(
cb
->
â
)

93  
FRE_EXIST
;

96 
cb
->
ty³
 =ype;

97 
cb
->
cmd
 = cmd;

98 
cb
->
â
 = fn;

99 
cmd_£t
->
num
++;

101  
FRE_SUCCESS
;

102 
	}
}

105 
	$äcÜe_´oûss_äc_cmd
(
cvmx_wqe_t
 *
wqe
)

108 
cvmx_¿w_š¡_äÚt_t
 *
f
 = (cvmx_¿w_š¡_äÚt_ˆ*)
wqe
->
·ck‘_d©a
;

109 
äcÜe_cmd_£t_t
 *
cmd_£t
;

110 
äcÜe_cmd_cb_t
 *
cb
;

111 
äcÜe_cmd_t
 *
cmd
;

112 
ušt8_t
 *
·¿m
 = 
NULL
;

114 
äcÜe_»¥Úd_buf_t
 *
»¥_buf
;

115 
»tv®
;

117 
ušt32_t
 
pÜt
 = 32;

118 
cvmx_buf_±r_t
 
ÍŒ
;

119 
ušt16_t
 
Ş’
 = 0;

121 if(
	`oùdev_g‘_pko_¡©e
(è!ğ
CVM_DRV_PKO_READY
){

122 
	`FRCORE_ERROR
("PKO‚ot„eady!\n");

126 ià(
äcÜe_cmd_»¥Úd_buf
 =ğ
NULL
)

128 
	`FRCORE_ERROR
("frcore_cmd_respond_buf is NLL\n");

132 
»¥_buf
 = &
äcÜe_cmd_»¥Úd_buf
[
	`cvmx_g‘_cÜe_num
()];

134 
	`mem£t
(
»¥_buf
, 0, (
äcÜe_»¥Úd_buf_t
));

138 
cmd
 = (
äcÜe_cmd_t
 *è((
ušt8_t
 *)
f
 + 
CVM_RAW_FRONT_SIZE
);

140 
	`FRCORE_CMD
("============cmd->£q = %d cmd->ty³ = %d, cmd->cmd = %d, cmd->ËÀğ%d\n", 
cmd
->
£q
, cmd->
ty³
, cmd->cmd, cmd->
Ën
);

141 
»¥_buf
->
»¥Úd
.
£q
 = 
cmd
->seq;

143 ià(
cmd
->
Ën
)

145 
·¿m
 = (
ušt8_t
 *è
cmd
 + (
äcÜe_cmd_t
);

149 ià(
cmd
->
ty³
 >ğ
CMD_TYPE_MAX
)

151 
»tv®
 = 
FRE_UNSUPPORT
;

152 
£nd_”rÜ
;

155 
cmd_£t
 = &
äcÜe_cmd£t
[
cmd
->
ty³
];

157 ià(
cmd
->cmd >ğ
cmd_£t
->
max
)

159 
»tv®
 = 
FRE_UNSUPPORT
;

160 
£nd_”rÜ
;

163 
cb
 = &
cmd_£t
->
veùÜ
[
cmd
->cmd];

165 ià(
cb
->
â
)

167 
»tv®
 = 
cb
->
	`â
(
cmd
->
Ën
, 
·¿m
, &
Ş’
, (*è
»¥_buf
->
»¥Úd
.
d©a
);

171 
»tv®
 = 
FRE_UNREGISTER
;

174 
£nd_”rÜ
:

175 
ÍŒ
.
u64
 = 0;

176 
ÍŒ
.
s
.
addr
 = 
	`CVM_DRV_GET_PHYS
(
»¥_buf
);

177 
ÍŒ
.
s
.
size
 = (
äcÜe_»¥Úd_buf_t
);

183 
»¥_buf
->
hdr
.
u64
 = 0;

184 
»¥_buf
->
hdr
.
s
.
İcode
 = 
FRC_CMD_RESPOND_OP
;

185 
»¥_buf
->
hdr
.
s
.
¥Üt
 = 
pÜt
;

186 
»¥_buf
->
hdr
.
s
.
de¡qpÜt
 = (
pÜt
 - 32);

188 
»¥_buf
->
»¥Úd
.
»t
 = 
»tv®
;

189 
»¥_buf
->
»¥Úd
.
Ën
 = 
Ş’
;

193 ià(
	`cvm_pko_£nd_dœeù
(
ÍŒ
, 
CVM_DIRECT_DATA
, 1, (
äcÜe_»¥Úd_buf_t
), 
pÜt
)) {

194 
	`FRCORE_ERROR
("Send„espond…kt fail!\n");

199 
	}
}

	@frcore/frcore_cmd.h

1 #iâdeà
__FRCORE_CMD_H__


2 
	#__FRCORE_CMD_H__


	)

4 
	~"äc_cmd.h
"

5 
	~"äcÜe_ù¾.h
"

9 (*
	täcÜe_cmd_â_t
)(
	tušt16_t
 
	t¶’
, *
	t·¿m
, ušt16_ˆ*
	tŞ’
, *
	toutbuf
);

11 
	säcÜe_cmd
 {

12 
ušt32_t
 
»ig¡”
;

13 
ušt16_t
 
ty³
;

14 
ušt16_t
 
cmd
;

15 
äcÜe_cmd_â_t
 
â
;

16 } 
	täcÜe_cmd_cb_t
;

18 
	säcÜe_cmd_£t
 {

19 
ušt32_t
 
max
;

20 
ušt32_t
 
num
;

21 
äcÜe_cmd_cb_t
 *
veùÜ
;

22 } 
	täcÜe_cmd_£t_t
;

25 
cvmx_»¥_hdr_t
 
hdr
;

26 
äc_cmd_»¥Úd_t
 
»¥Úd
;

27 } 
	täcÜe_»¥Úd_buf_t
;

29 
	`äcÜe_cmd_»gi¡”
(
ušt16_t
 
ty³
, ušt16_ˆ
cmd
, 
äcÜe_cmd_â_t
 
â
);

30 
	`äcÜe_cmd_»¥Úd
(
rv
, 
size
, *
»¥_buf
);

33 
	#FRCORE_REGISTER_CMD
(
_ty³
, 
_cmd
, 
_â
) \

35 
_rv
; \

36 
_rv
 = 
	`äcÜe_cmd_»gi¡”
(
_ty³
, 
_cmd
, 
_â
); \

37 ià(
_rv
) \

39 
	`FRCORE_ERROR
("REGISTER COMMAND %s %s fail!\n", #_type, #_cmd); \

40  
_rv
; \

42 
	}

	)
}

45 
äcÜe_cmd_š™
();

	@frcore/frcore_config.h

1 #iâdeà
__FRCORE_CONFIG_H__


2 
	#__FRCORE_CONFIG_H__


	)

4 
	#FRCORE_CFG_DUMP_CYCLE
 0

	)

5 
	#FRCORE_CFG_FREE_WORK
 1

	)

7 
	#MC_HW_TIMER_BUCKET_TICK
 1000

8 
	#MC_SSN_TTL_UNIT
 (10000000/
MC_HW_TIMER_BUCKET_TICK
è

	)

11 
	#FRCORE_SSN_AGE_MIN
 1

	)

12 
	#FRCORE_SSN_AGE_MAX
 250

	)

15 
	#MPP_MAX_ACSM_NUM_BITS
 0

	)

16 
	#MPP_MAX_ACSM_NUM
 (1<<
MPP_MAX_ACSM_NUM_BITS
)

	)

17 
	#MAX_ACL_IP_NUM
 0x40

18 
	#MAX_ACL_IP_NUM_MASK
 0x3f

	)

19 
	#MAX_ACL_IP_HASH_BUCKET_LEN
 4

	)

21 
	#MPP_MAX_ACL_NUM
 1

	)

22 
	#MPP_MAX_FILTERS_BITS
 11

	)

23 
	#MPP_MAX_FILTERS
 (1<< 
MPP_MAX_FILTERS_BITS
)

24 
	#MPP_ACL_IP_START
 (
MPP_MAX_FILTERS
 * 
MPP_MAX_ACSM_NUM
)

	)

25 
	#MPP_MAX_CRSLK_ENTRY
 (
MPP_ACL_IP_START
+ 
MAX_ACL_IP_NUM
)

26 

	)

	@frcore/frcore_debug.h

1 #iâdeà
__FRCORE_DEBUG_H__


2 
	#__FRCORE_DEBUG_H__


	)

4 
	~"äc_debug.h
"

6 
	#FRCORE_DUMP
(
_fmt
, 
_¬gs
...è
	`´štf
("%s.%d : " _fmt, 
__func__
, 
__LINE__
, ##_¬gs)

	)

8 #ià
FRC_DEBUG_CORE


10 
	#FRCORE_WARN
(
_fmt
, 
_¬gs
...è
	`´štf
("[WARN] %s.%d : " _fmt, 
__func__
, 
__LINE__
, ##_¬gs)

	)

11 
	#FRCORE_ERROR
(
_fmt
, 
_¬gs
...è
	`´štf
("[ERROR] %s.%d : " _fmt, 
__func__
, 
__LINE__
, ##_¬gs)

	)

12 
	#FRCORE_INFO
(
_fmt
, 
_¬gs
...è
	`´štf
("[INFO] %s.%d : " _fmt, 
__func__
, 
__LINE__
, ##_¬gs)

	)

13 
	#MC_PRINTF_DEBUG
(
fmt
, 
¬g
...è
	`´štf
("[DEBUG] %12s[%18s][%4d]:" fmˆ, 
__FILE__
, 
__FUNCTION__
, 
__LINE__
, ##¬g)

	)

14 
	#MC_PRINTF_ERR
(
fmt
, 
¬g
...è
	`´štf
("[ERR] %12s[%18s][%4d]:" fmˆ, 
__FILE__
, 
__FUNCTION__
, 
__LINE__
, ##¬g)

	)

15 
	#MC_PRINTF_INFO
(
fmt
, 
¬g
...è
	`´štf
("[INFO] %12s[%18s][%4d]:" fmˆ, 
__FILE__
, 
__FUNCTION__
, 
__LINE__
, ##¬g)

	)

16 
	#MC_PRINTF
(
fmt
, 
¬g
...è
	`´štf
("[INFO] %12s[%18s][%4d]:" fmˆ, 
__FILE__
, 
__FUNCTION__
, 
__LINE__
, ##¬g)

	)

18 
	#FRCORE_WARN
(
_fmt
, 
_¬gs
...è{}

	)

19 
	#FRCORE_ERROR
(
_fmt
, 
_¬gs
...è{}

	)

20 
	#FRCORE_INFO
(
_fmt
, 
_¬gs
...è{}

	)

21 
	#MC_PRINTF_DEBUG
(
fmt
, 
¬g
...è{}

	)

22 
	#MC_PRINTF_ERR
(
fmt
, 
¬g
...è
	`´štf
("[ERR] %12s[%18s][%4d]:" fmˆ, 
__FILE__
, 
__FUNCTION__
, 
__LINE__
, ##¬g)

	)

23 
	#MC_PRINTF_INFO
(
fmt
, 
¬g
...è{}

	)

24 
	#MC_PRINTF
(
fmt
, 
¬g
...è{}

	)

27 
	#FRCORE_DEBUG_NONE
 0x00000

	)

28 
	#FRCORE_DEBUG_INIT
 0x00001

	)

29 
	#FRCORE_DEBUG_TEST
 0x00002

	)

30 
	#FRCORE_DEBUG_CMD
 0x00004

	)

31 
	#FRCORE_DEBUG_DMA
 0x00008

	)

32 
	#FRCORE_DEBUG_TCP
 0x00010

	)

33 
	#FRCORE_DEBUG_UDP
 0x00020

	)

34 
	#FRCORE_DEBUG_QUEUE
 0x00080

	)

35 
	#FRCORE_DEBUG_RING
 0x00100

	)

36 
	#FRCORE_DEBUG_LOOP
 0x00200

	)

37 
	#FRCORE_DEBUG_WQE
 0x00400

	)

38 
	#FRCORE_DEBUG_PKT
 0x00800

	)

39 
	#FRCORE_DEBUG_PHY
 0x01000

	)

40 
	#FRCORE_DEBUG_LEN
 0x02000

	)

41 
	#FRCORE_DEBUG_CHAN
 0x04000

	)

42 
	#FRCORE_DEBUG_SSN
 0x08000

	)

43 
	#FRCORE_DEBUG_RULE
 0x10000

	)

44 
	#FRCORE_DEBUG_TwoTu¶e
 0x20000

	)

45 
	#FRCORE_DEBUG_VLAN_CHECK
 0x40000

	)

46 
	#FRCORE_DEBUG_TIMESTAMP_CHECK
 0x80000

	)

48 
	#FRCORE_DEBUG_FLAGS
 0x80000

	)

50 #ià
FRCORE_CONFIG_FRCORE_DEBUG


51 
	#FRCORE_DBUF
(
_buf
, 
_Ën
è
	`äcÜe_buf_dump
(_buf, _Ën)

	)

54 
	#FRCORE_DBUF
(
_buf
, 
_Ën
)

	)

58 #ià(
FRC_DEBUG_CORE
)

60 
	#FRCORE_DEBUG
(
_Ëv–
, 
_fmt
, 
_¬gs
...) \

62 ià(
FRCORE_DEBUG_FLAGS
 & 
_Ëv–
) \

64 
	`´štf
("[%s] %12s[%18s][%4d]: " 
_fmt
, #_Ëv–, 
__FILE__
, 
__func__
, 
__LINE__
, ##
_¬gs
); \

66 }

	)

70 
	#FRCORE_DEBUG
(
_Ëv–
, 
_fmt
, 
_¬gs
...)

	)

74 
	#FRCORE_INIT
(
_fmt
, 
_¬gs
...è
	`FRCORE_DEBUG
(
FRCORE_DEBUG_INIT
, _fmt, ##_¬gs)

	)

75 
	#FRCORE_TEST
(
_fmt
, 
_¬gs
...è
	`FRCORE_DEBUG
(
FRCORE_DEBUG_TEST
, _fmt, ##_¬gs)

	)

76 
	#FRCORE_CMD
(
_fmt
, 
_¬gs
...è
	`FRCORE_DEBUG
(
FRCORE_DEBUG_CMD
, _fmt, ##_¬gs)

	)

77 
	#FRCORE_DMA
(
_fmt
, 
_¬gs
...è
	`FRCORE_DEBUG
(
FRCORE_DEBUG_DMA
, _fmt, ##_¬gs)

	)

78 
	#FRCORE_TCP
(
_fmt
, 
_¬gs
...è
	`FRCORE_DEBUG
(
FRCORE_DEBUG_TCP
, _fmt, ##_¬gs)

	)

79 
	#FRCORE_UDP
(
_fmt
, 
_¬gs
...è
	`FRCORE_DEBUG
(
FRCORE_DEBUG_UDP
, _fmt, ##_¬gs)

	)

80 
	#FRCORE_QUEUE
(
_fmt
, 
_¬gs
...è
	`FRCORE_DEBUG
(
FRCORE_DEBUG_QUEUE
, _fmt, ##_¬gs)

	)

81 
	#FRCORE_RING
(
_fmt
, 
_¬gs
...è
	`FRCORE_DEBUG
(
FRCORE_DEBUG_RING
, _fmt, ##_¬gs)

	)

82 
	#FRCORE_LOOP
(
_fmt
, 
_¬gs
...è
	`FRCORE_DEBUG
(
FRCORE_DEBUG_LOOP
, _fmt, ##_¬gs)

	)

83 
	#FRCORE_WQE
(
_fmt
, 
_¬gs
...è
	`FRCORE_DEBUG
(
FRCORE_DEBUG_WQE
, _fmt, ##_¬gs)

	)

84 
	#FRCORE_PKT
(
_fmt
, 
_¬gs
...è
	`FRCORE_DEBUG
(
FRCORE_DEBUG_PKT
, _fmt, ##_¬gs)

	)

85 
	#FRCORE_PHY
(
_fmt
, 
_¬gs
...è
	`FRCORE_DEBUG
(
FRCORE_DEBUG_PHY
, _fmt, ##_¬gs)

	)

86 
	#FRCORE_LEN
(
_fmt
, 
_¬gs
...è
	`FRCORE_DEBUG
(
FRCORE_DEBUG_LEN
, _fmt, ##_¬gs)

	)

87 
	#FRCORE_CHAN
(
_fmt
, 
_¬gs
...è
	`FRCORE_DEBUG
(
FRCORE_DEBUG_CHAN
, _fmt, ##_¬gs)

	)

88 
	#FRCORE_SSN
(
_fmt
, 
_¬gs
...è
	`FRCORE_DEBUG
(
FRCORE_DEBUG_SSN
, _fmt, ##_¬gs)

	)

89 
	#FRCORE_RULE
(
_fmt
, 
_¬gs
...è
	`FRCORE_DEBUG
(
FRCORE_DEBUG_RULE
, _fmt, ##_¬gs)

	)

90 
	#FRCORE_TwoTu¶e
(
_fmt
, 
_¬gs
...è
	`FRCORE_DEBUG
(
FRCORE_DEBUG_TwoTu¶e
, _fmt, ##_¬gs)

	)

91 
	#FRCORE_VLAN_CHECK
(
_fmt
, 
_¬gs
...è
	`FRCORE_DEBUG
(
FRCORE_DEBUG_VLAN_CHECK
, _fmt, ##_¬gs)

	)

92 
	#FRCORE_TIMESTAMP_CHECK
(
_fmt
, 
_¬gs
...è
	`FRCORE_DEBUG
(
FRCORE_DEBUG_TIMESTAMP_CHECK
, _fmt, ##_¬gs)

	)

	@frcore/frcore_defs.h

26 #iâdeà 
__FRCORE_DEFS_H__


27 
	#__FRCORE_DEFS_H__


	)

30 
	~<¡dio.h
>

31 
	~<¡dšt.h
>

32 
	~<¡dlib.h
>

34 
	~"cvmx.h
"

35 
	~"cvmx-wqe.h
"

37 
	~"äc.h
"

41 
	#CVMCS_DUTY_CYCLE


	)

44 
	#DMA_CHANNEL_REST_DIV
 10

	)

47 
	#DISPLAY_INTERVAL
 15

	)

49 
	#LINK_CHECK_INTERVAL
 1

	)

53 
	#MAX_CORES
 16

	)

59 
	#INIT_PACKET_COUNT
 (1 * 1024)

	)

63 
	#FPA_PACKET_POOL_COUNT
 (1467 * 
INIT_PACKET_COUNT
)

	)

65 
	#FPA_WQE_POOL_COUNT
 (1467 * 
INIT_PACKET_COUNT
)

	)

68 
	#FPA_OQ_POOL_COUNT
 (4 * 
INIT_PACKET_COUNT
)

	)

69 
	#FPA_TIMER_POOL_COUNT
 (301024)

	)

74 #ifdeà
OCTEON_DEBUG_LEVEL


75 
	#DBG
 
´štf


	)

77 
	#DBG
(
fÜm©
, 
¬gs
...èdo{ }0)

	)

	@frcore/frcore_dma.c

1 
	~"cvmcs-commÚ.h
"

2 
	~<cvmx-©omic.h
>

3 
	~"äc.h
"

4 
	~"äcÜe.h
"

5 
	~"äcÜe_cÚfig.h
"

7 
	~"äcÜe_¡©.h
"

8 
	~"äcÜe_dma.h
"

9 
	~"äcÜe_cmd.h
"

10 
	~"äc_ut.h
"

11 
	~"äc_cmd.h
"

12 
	~"äc_dma.h
"

13 #ià
FRC_CONFIG_SIMPLE_PACKAGE
 || 
FRC_CONFIG_SSN_CHAN


15 
	$äcÜe_dma_sÿ‰”
(
dœ
, 
äcÜe_dma_sÿ‰”_desc_t
 *
desc
)

17 
rv
;

19 
i
;

21 
cvm_pci_dma_cmd_t
 
cmd
;

22 
cvmx_buf_±r_t
 
ÍŒ
[
CN3XXX_MAX_DMA_LOCAL_POINTERS
];

23 
cvm_dma_»mÙe_±r_t
 
½Œ
[
CN3XXX_MAX_DMA_REMOTE_POINTERS
];

25 #ià
	`defšed
(
DMA_USE_COMPLETION_WORD
)

26 
cvm_dma_comp_±r_t
 *
comp_±r
 = 
NULL
;

27 
ušt8_t
 *
wÜd_to_check
ğ
NULL
;

32 ià(
desc
->
numb”
 == 0)

34 
	`FRCORE_ERROR
("desc->number == 0.\n");

35 
	`FRCORE_STAT_INC
(
¡©_dma_”rÜs
);

36  
FRE_PARAM
;

39 ià(
desc
->
numb”
 > 
FRCORE_MAX_DMA_POINTERS
)

41 
	`FRCORE_ERROR
("desc->numb”(%dè> FRCORE_MAX_DMA_POINTERS(%d).\n", 
desc
->
numb”
, 
FRCORE_MAX_DMA_POINTERS
);

42 
	`FRCORE_STAT_INC
(
¡©_dma_”rÜs
);

43  
FRE_PARAM
;

46 #ià
	`defšed
(
DMA_USE_COMPLETION_WORD
)

50 
comp_±r
 = 
	`cvm_g‘_dma_comp_±r
();

51 if(
comp_±r
 =ğ
NULL
) {

52 
	`FRCORE_ERROR
("Discard. No comp_ptr‡llocated\n");

53 
	`FRCORE_STAT_INC
(
¡©_dma_”rÜs
);

54  
FRE_MEMORY
;

56 
wÜd_to_check
 = &
comp_±r
->
comp_by‹
;

57 *
wÜd_to_check
 = 0xff;

60 
i
 = 0; i < 
desc
->
numb”
; i++)

62 ià(
desc
->
size
[
i
] == 0)

64 
	`FRCORE_ERROR
("desc->size[%d] =ğ0)\n", 
i
);

65 
rv
 = 
FRE_PARAM
;

66 
äcÜe_dma_”r
;

69 ià(
desc
->
size
[
i
] > 
MAX_PCI_DMA_LOCAL_BUF_SIZE
)

71 
	`FRCORE_ERROR
("desc->size[%d](%dè> MAX_PCI_DMA_LOCAL_BUF_SIZE(%d)\n", 
i
, 
desc
->
size
[i], 
MAX_PCI_DMA_LOCAL_BUF_SIZE
);

72 
rv
 = 
FRE_PARAM
;

73 
äcÜe_dma_”r
;

76 
ÍŒ
[
i
].
u64
 = 0;

77 
½Œ
[
i
].
u64
 = 0;

78 
ÍŒ
[
i
].
s
.i = 0;

79 
ÍŒ
[
i
].
s
.
addr
 = 
	`CVM_DRV_GET_PHYS
(
desc
->
loÿl_±r
[i]);

80 
½Œ
[
i
].
s
.
addr
 = 
desc
->
»mÙe_addr
[i];

81 
ÍŒ
[
i
].
s
.
size
 = 
½Œ
[i].s.sizğ
desc
->size[i];

84 
cmd
.
u64
 = 0;

85 
cmd
.
s
.
Æ
 = cmd.s.
Ä
 = 
i
;

87 #ià
	`defšed
(
DMA_USE_COMPLETION_WORD
)

88 
cmd
.
s
.
æags
 |ğ
PCI_DMA_PUTWORD
;

89 
cmd
.
s
.
±r
 = 
	`cvmx_±r_to_phys
(
wÜd_to_check
);

92 if(
dœ
 =ğ
DMA_DIR_RECV
)

94 
rv
 = 
	`cvm_pci_dma_»cv_d©a
(&
cmd
, 
ÍŒ
, 
½Œ
);

98 
rv
 = 
	`cvm_pci_dma_£nd_d©a
(&
cmd
, 
ÍŒ
, 
½Œ
);

101 if(
rv
) {

102 
	`FRCORE_STAT_INC
(
¡©_dma_”rÜs
);

103 
rv
 = 
FRE_DMA
;

104 
äcÜe_dma_”r
;

107 #ià
	`defšed
(
DMA_USE_COMPLETION_WORD
)

108 
i
 = 0;

109 (*
wÜd_to_check
 =ğ0xffè&& (++
i
 < 
DMA_WAIT_INTERVAL
)) {

110 
	`cvmx_wa™
(10);

111 
CVMX_SYNCWS
;

114 if(
i
 =ğ
DMA_WAIT_INTERVAL
) {

115 
	`´štf
("DMA FAILED iÁ”v®: %d Com¶‘iÚ WÜd v®ue: %x\n", 
i
,

116 *
wÜd_to_check
);

119 
äcÜe_dma_”r
:

121 #ià
	`defšed
(
DMA_USE_COMPLETION_WORD
)

122 if(
comp_±r
)

123 
	`cvm_»Ëa£_dma_comp_±r
(
comp_±r
);

125  
rv
;

126 
	}
}

129 
	$_äcÜe_dma_g©h”
(
size
, *
loÿl
, 
ušt64_t
 
»mÙe_addr
, 
dœ
)

131 
cur
 = 0, 
rv
;

132 
ušt64_t
 
loÿl_phy_addr
, 
»mÙe_phy_addr
;

133 
ušt32_t
 
i
;

135 
cvm_pci_dma_cmd_t
 
cmd
;

136 
cvmx_buf_±r_t
 
ÍŒ
[
CN3XXX_MAX_DMA_LOCAL_POINTERS
];

137 
cvm_dma_»mÙe_±r_t
 
½Œ
[
CN3XXX_MAX_DMA_REMOTE_POINTERS
];

139 #ià
	`defšed
(
DMA_USE_COMPLETION_WORD
)

140 
cvm_dma_comp_±r_t
 *
comp_±r
 = 
NULL
;

141 
ušt8_t
 *
wÜd_to_check
ğ
NULL
;

147 ià(
size
 == 0)

149 
	`FRCORE_ERROR
("size == 0!\n");

150  
FRE_PARAM
;

153 ià(
size
 > (
FRCORE_DMA_BUFF_MAX
))

155 
	`FRCORE_ERROR
("size(%dè> FRCORE_DMA_BUFF_MAX(%d).\n", 
size
, 
FRCORE_DMA_BUFF_MAX
);

156  
FRE_PARAM
;

159 #ià
	`defšed
(
DMA_USE_COMPLETION_WORD
)

164 
comp_±r
 = 
	`cvm_g‘_dma_comp_±r
();

165 if(
comp_±r
 =ğ
NULL
) {

166 
	`FRCORE_ERROR
("Discard. No comp_ptr‡llocated\n");

167  
FRE_MEMORY
;

169 
wÜd_to_check
 = &
comp_±r
->
comp_by‹
;

170 *
wÜd_to_check
 = 0xff;

173 
i
 = 0;

174 
loÿl_phy_addr
 = 
	`CVM_DRV_GET_PHYS
(
loÿl
);

175 
»mÙe_phy_addr
 = 
»mÙe_addr
;

176 
size
)

178 ià(
size
 > 
MAX_PCI_DMA_LOCAL_BUF_SIZE
)

180 
cur
 = 
MAX_PCI_DMA_LOCAL_BUF_SIZE
;

182 
cur
 = 
size
;

184 
ÍŒ
[
i
].
u64
 = 0;

185 
½Œ
[
i
].
u64
 = 0;

186 
ÍŒ
[
i
].
s
.i = 0;

187 
ÍŒ
[
i
].
s
.
addr
 = 
loÿl_phy_addr
;

188 
½Œ
[
i
].
s
.
addr
 = 
»mÙe_phy_addr
;

189 
ÍŒ
[
i
].
s
.
size
 = 
½Œ
[i].s.sizğ
cur
;

190 
loÿl_phy_addr
 +ğ
cur
;

191 
»mÙe_phy_addr
 +ğ
cur
;

192 
size
 -ğ
cur
;

193 
i
++;

198 
cmd
.
u64
 = 0;

199 
cmd
.
s
.
Æ
 = cmd.s.
Ä
 = 
i
;

201 #ià
	`defšed
(
DMA_USE_COMPLETION_WORD
)

202 
cmd
.
s
.
æags
 |ğ
PCI_DMA_PUTWORD
;

203 
cmd
.
s
.
±r
 = 
	`cvmx_±r_to_phys
(
wÜd_to_check
);

206 if(
dœ
 =ğ
DMA_DIR_RECV
)

208 
rv
 = 
	`cvm_pci_dma_»cv_d©a
(&
cmd
, 
ÍŒ
, 
½Œ
);

212 
rv
 = 
	`cvm_pci_dma_£nd_d©a
(&
cmd
, 
ÍŒ
, 
½Œ
);

215 if(
rv
) {

216 
rv
 = 
FRE_DMA
;

217 
dma_g©h”_”r
;

220 #ià
	`defšed
(
DMA_USE_COMPLETION_WORD
)

221 
i
 = 0;

222 (*
wÜd_to_check
 =ğ0xffè&& (++
i
 < 
DMA_WAIT_INTERVAL
)) {

223 
	`cvmx_wa™
(10);

224 
CVMX_SYNCWS
;

227 if(
i
 =ğ
DMA_WAIT_INTERVAL
) {

228 
	`´štf
("DMA FAILED iÁ”v®: %d Com¶‘iÚ WÜd v®ue: %x\n", 
i
,

229 *
wÜd_to_check
);

233 
dma_g©h”_”r
:

235 #ià
	`defšed
(
DMA_USE_COMPLETION_WORD
)

236 if(
comp_±r
)

237 
	`cvm_»Ëa£_dma_comp_±r
(
comp_±r
);

239  
rv
;

240 
	}
}

243 
	$äcÜe_dma_g©h”
(
dœ
, *
loÿl
, 
ušt64_t
 
»mÙe_addr
, 
size
)

245 
cur
, 
rv
;

246 
size
)

248 ià(
size
 > 
FRCORE_DMA_BUFF_MAX
)

250 
cur
 = 
FRCORE_DMA_BUFF_MAX
;

254 
cur
 = 
size
;

258 
rv
 = 
	`_äcÜe_dma_g©h”
(
cur
, 
loÿl
, 
»mÙe_addr
, 
dœ
);

260 ià(
rv
)

262 
	`FRCORE_ERROR
("_äcÜe_cİy_to_»mÙç:„v %d\n", 
rv
);

263  
rv
;

265 
size
 -ğ
cur
;

266 
loÿl
 +ğ
cur
;

267 
»mÙe_addr
 +ğ
cur
;

270  
FRE_SUCCESS
;

271 
	}
}

273 
	$äcÜe_cİy_äom_»mÙe
(
size
, *
loÿl
, 
ušt64_t
 
»mÙe_addr
)

275 
	`FRCORE_DMA
("SIZE %d, LOCAL %p, REMOTE_ADDR %Îx.\n", 
size
, 
loÿl
, (
ULL
è
»mÙe_addr
);

276  
	`äcÜe_dma_g©h”
(
DMA_DIR_RECV
, 
loÿl
, 
»mÙe_addr
, 
size
);

277 
	}
}

279 
	$äcÜe_cİy_to_»mÙe
(
size
, *
loÿl
, 
ušt64_t
 
»mÙe_addr
)

281 
	`FRCORE_DMA
("SIZE %d, LOCAL %p, REMOTE_ADDR %Îx.\n", 
size
, 
loÿl
, (
ULL
è
»mÙe_addr
);

282  
	`äcÜe_dma_g©h”
(
DMA_DIR_SEND
, 
loÿl
, 
»mÙe_addr
, 
size
);

283 
	}
}

285 #ià
FRC_CONFIG_DMA_TEST


286 
CVMX_SHARED
 
ušt64_t
 
	g»mÙe_dma_loİ_rx_addr
[
FRC_DAT_CORE_NUM
], 
	g»mÙe_dma_loİ_tx_addr
[FRC_DAT_CORE_NUM];

287 
CVMX_SHARED
 
äc_dma_loİ_buff_t
 *
	gäcÜe_dma_loİ_rx_buff
[
FRC_DAT_CORE_NUM
];

288 
CVMX_SHARED
 
äc_dma_loİ_buff_t
 *
	gäcÜe_dma_loİ_tx_buff
[
FRC_DAT_CORE_NUM
];

289 
CVMX_SHARED
 
ušt8_t
 *
	gäcÜe_dma_loİ_‹mp_buff
[
FRC_DAT_CORE_NUM
];

290 
CVMX_SHARED
 
cvmx_wqe_t
 *
	gäcÜe_dma_loİ_wqe
;

291 
	$äcÜe_cmd_dma_loİ_¡¬t
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

293 
g½
;

294 
ušt64_t
 
cÜe_num
 = *((ušt64_ˆ*è
·¿m
);

295 
cvmx_wqe_t
 *
wqe
;

296 *
Ş’
 = 0;

298 
wqe
 = &
äcÜe_dma_loİ_wqe
[
cÜe_num
];

299 
g½
 = 
cÜe_num
 + 1;

300 
	`FRCORE_CMD
("WQE[%Îd] = %p.\n", (
ULL
è
cÜe_num
, 
wqe
);

301 
	`mem£t
(
wqe
, 0, (
cvmx_wqe_t
));

302 
wqe
->
unu£d
 = 
FRCORE_WORK_DMA_LOOP
;

303 
wqe
->
´t
 = 0;

304 
wqe
->
g½
 = grp;

305 
wqe
->
g
 = 
g½
;

306 
wqe
->
g_ty³
 = 
CVMX_POW_TAG_TYPE_ATOMIC
;

307 
wqe
->
·ck‘_d©a
[0] = 
g½
;

308 if(
	`cvmx_tim_add_’Œy
(
wqe
, 
FRCORE_DMA_LOOP_TIMEOUT
, 
NULL
)) {

309 
	`FRCORE_ERROR
("Add dma†oopimer fail!.\n");

310  
FRE_FAIL
;

313  
FRE_SUCCESS
;

314 
	}
}

316 
	#FRCORE_DMA_LOOP_SLEEP
 100000

	)

317 
	$äcÜe_dma_loİ
(
cvmx_wqe_t
 *
wÜk
)

319 
cÜe_num
;

320 
rv
;

321 
äc_dma_loİ_buff_t
 *
rx_buff
, *
tx_buff
;

322 
ušt8_t
 *
‹mp_buff
;

323 
ušt64_t
 
»mÙe_rx_addr
, 
»mÙe_tx_addr
;

324 
ušt64_t
 
rx_ridx
, 
rx_widx
, 
tx_ridx
, 
tx_widx
;

325 
ušt64_t
 
rx_off£t
, 
tx_off£t
;

326 
ušt64_t
 
tx_Ën
 = 0, 
’1
 = 0, 
’2
 = 0;

327 
cÜe_num
 = 
	`cvmx_g‘_cÜe_num
();

328 
út
 = 0;

330 
rx_buff
 = 
äcÜe_dma_loİ_rx_buff
[
cÜe_num
];

331 
tx_buff
 = 
äcÜe_dma_loİ_tx_buff
[
cÜe_num
];

332 
‹mp_buff
 = 
äcÜe_dma_loİ_‹mp_buff
[
cÜe_num
];

333 
»mÙe_rx_addr
 = 
»mÙe_dma_loİ_rx_addr
[
cÜe_num
];

334 
»mÙe_tx_addr
 = 
»mÙe_dma_loİ_tx_addr
[
cÜe_num
];

342 
	`FRCORE_CYCLE_RECORDER_INIT
();

343 
rv
 = 
	`äcÜe_dma_g©h”
(
DMA_DIR_RECV
, &
tx_buff
->
widx
, 
»mÙe_tx_addr
 + 0, (tx_buff->widx));

344 ià(
rv
)

346 
	`FRCORE_ERROR
("DMA„idx oàtx bufà%d from„emÙç.\n", 
cÜe_num
);

347 
	`FRCORE_STAT_INC
(
¡©_dma_”rÜs
);

348 
rv
 = 
FRE_DMA
;

349 
äcÜe_dma_loİ_”r
;

351 
	`FRCORE_CYCLE_RECORDING
();

352 
tx_ridx
 = 
tx_buff
->
ridx
;

353 
tx_widx
 = 
tx_buff
->
widx
;

355 
	`sw­_buff
(1, &
tx_ridx
);

356 
	`sw­_buff
(1, &
tx_widx
);

358 
tx_Ën
 = 
tx_widx
 - 
tx_ridx
;

359 
	`FRCORE_CYCLE_RECORDING
();

360 ià(
tx_Ën
 == 0)

362 
	`äcÜe_¦“p
(
FRCORE_DMA_LOOP_SLEEP
);

363 
út
 = 0;

367 ià((
út
 < 10è&& (
tx_Ën
 < 
FRCORE_DMA_BUFF_MAX
)) {

369 
	`äcÜe_¦“p
(
FRCORE_DMA_LOOP_SLEEP
);

370 
út
++;

373 ià(
tx_Ën
 > 
FRCORE_DMA_BUFF_MAX
)

375 
tx_Ën
 = 
FRCORE_DMA_BUFF_MAX
;

382 
rv
 = 
	`äcÜe_dma_g©h”
(
DMA_DIR_RECV
, &
rx_buff
->
ridx
, 
»mÙe_rx_addr
 + 8, (rx_buff->ridx));

383 ià(
rv
)

385 
	`FRCORE_ERROR
("DMA„idx oà£nd bufà%d from„emÙç.\n", 
cÜe_num
);

386 
	`FRCORE_STAT_INC
(
¡©_dma_”rÜs
);

387 
rv
 = 
FRE_DMA
;

388 
äcÜe_dma_loİ_”r
;

390 
	`FRCORE_CYCLE_RECORDING
();

391 
rx_ridx
 = 
rx_buff
->
ridx
;

392 
rx_widx
 = 
rx_buff
->
widx
;

394 
	`sw­_buff
(1, &
rx_ridx
);

395 
	`sw­_buff
(1, &
rx_widx
);

397 
	`FRCORE_CYCLE_RECORDING
();

400 ià((
rx_widx
 - 
rx_ridx
è<ğ(
FRC_DMA_LOOP_BUFF_SIZE
 - 
tx_Ën
))

403 
tx_off£t
 = 
tx_ridx
 % 
FRC_DMA_LOOP_BUFF_SIZE
;

404 ià((
tx_off£t
 + 
tx_Ën
è> 
FRC_DMA_LOOP_BUFF_SIZE
)

406 
’1
 = 
FRC_DMA_LOOP_BUFF_SIZE
 - 
tx_off£t
;

407 
rv
 = 
	`äcÜe_dma_g©h”
(
DMA_DIR_RECV
, 
‹mp_buff
, 
»mÙe_tx_addr
 + 
FRC_DMA_LOOP_HD_SIZE
 + 
tx_off£t
, 
’1
);

408 ià(
rv
)

410 
	`FRCORE_ERROR
("DMAx buff fail.\n");

411 
äcÜe_dma_loİ_”r
;

414 
’2
 = 
tx_Ën
 - 
’1
;

415 
rv
 = 
	`äcÜe_dma_g©h”
(
DMA_DIR_RECV
, 
‹mp_buff
 + 
’1
, 
»mÙe_tx_addr
 + 
FRC_DMA_LOOP_HD_SIZE
, 
’2
);

416 ià(
rv
)

418 
	`FRCORE_ERROR
("DMAx buff fail.\n");

419 
äcÜe_dma_loİ_”r
;

424 
rv
 = 
	`äcÜe_dma_g©h”
(
DMA_DIR_RECV
, 
‹mp_buff
, 
»mÙe_tx_addr
 + 
FRC_DMA_LOOP_HD_SIZE
 + 
tx_off£t
, 
tx_Ën
);

425 ià(
rv
)

427 
	`FRCORE_ERROR
("DMAx buff fail.\n");

428 
äcÜe_dma_loİ_”r
;

433 
	`FRCORE_CYCLE_RECORDING
();

434 
rx_off£t
 = 
rx_widx
 % 
FRC_DMA_LOOP_BUFF_SIZE
;

435 ià((
rx_off£t
 + 
tx_Ën
è> 
FRC_DMA_LOOP_BUFF_SIZE
)

437 
’1
 = 
FRC_DMA_LOOP_BUFF_SIZE
 - 
rx_off£t
;

438 
rv
 = 
	`äcÜe_dma_g©h”
(
DMA_DIR_SEND
, 
‹mp_buff
, 
»mÙe_rx_addr
 + 
FRC_DMA_LOOP_HD_SIZE
 + 
rx_off£t
, 
’1
);

439 ià(
rv
)

441 
	`FRCORE_ERROR
("DMA send buff fail.\n");

442 
	`FRCORE_STAT_INC
(
¡©_dma_”rÜs
);

443 
rv
 = 
FRE_DMA
;

444 
äcÜe_dma_loİ_”r
;

447 
’2
 = 
tx_Ën
 - 
’1
;

448 
rv
 = 
	`äcÜe_dma_g©h”
(
DMA_DIR_SEND
, 
‹mp_buff
 + 
’1
, 
»mÙe_rx_addr
 + 
FRC_DMA_LOOP_HD_SIZE
 + 0, 
’2
);

449 ià(
rv
)

451 
	`FRCORE_ERROR
("DMA send buff fail.\n");

452 
	`FRCORE_STAT_INC
(
¡©_dma_”rÜs
);

453 
rv
 = 
FRE_DMA
;

454 
äcÜe_dma_loİ_”r
;

459 
rv
 = 
	`äcÜe_dma_g©h”
(
DMA_DIR_SEND
, 
‹mp_buff
, 
»mÙe_rx_addr
 + 
FRC_DMA_LOOP_HD_SIZE
 + 
rx_off£t
, 
tx_Ën
);

460 ià(
rv
)

462 
	`FRCORE_ERROR
("DMA send buff fail.\n");

463 
	`FRCORE_STAT_INC
(
¡©_dma_”rÜs
);

464 
rv
 = 
FRE_DMA
;

465 
äcÜe_dma_loİ_”r
;

468 
	`FRCORE_CYCLE_RECORDING
();

469 
tx_ridx
 +ğ
tx_Ën
;

470 
rx_widx
 +ğ
tx_Ën
;

471 
	`sw­_buff
(1, &
tx_ridx
);

472 
	`sw­_buff
(1, &
rx_widx
);

473 
tx_buff
->
ridx
 = 
tx_ridx
;

474 
rx_buff
->
widx
 = 
rx_widx
;

475 
	`FRCORE_CYCLE_RECORDING
();

476 
rv
 = 
	`äcÜe_dma_g©h”
(
DMA_DIR_SEND
, &
tx_buff
->
ridx
, 
»mÙe_tx_addr
 + 8, (tx_buff->ridx));

477 ià(
rv
)

479 
	`FRCORE_ERROR
("DMA„idx oàtx bufà%dØ»mÙç.\n", 
cÜe_num
);

480 
	`FRCORE_STAT_INC
(
¡©_dma_”rÜs
);

481 
rv
 = 
FRE_DMA
;

482 
äcÜe_dma_loİ_”r
;

484 
	`FRCORE_CYCLE_RECORDING
();

485 
rv
 = 
	`äcÜe_dma_g©h”
(
DMA_DIR_SEND
, &
rx_buff
->
widx
, 
»mÙe_rx_addr
 + 0, (rx_buff->widx));

486 ià(
rv
)

488 
	`FRCORE_ERROR
("DMA widx oàtx bufà%dØ»mÙç.\n", 
cÜe_num
);

489 
	`FRCORE_STAT_INC
(
¡©_dma_”rÜs
);

490 
rv
 = 
FRE_DMA
;

491 
äcÜe_dma_loİ_”r
;

493 
	`FRCORE_CYCLE_RECORDING
();

494 
	`FRCORE_STAT_ADD
(
¡©_dma_loİ_by‹s
, 
tx_Ën
);

496 
	`FRCORE_STAT_INC
(
¡©_dma_loİ_’Œ›s
);

501 
	`äcÜe_¦“p
(
FRCORE_DMA_LOOP_SLEEP
);

504 
	`FRCORE_CYCLE_RECORD_DUMP
();

507 
äcÜe_dma_loİ_”r
:

508 ià(
rv
)

510 
	`FRCORE_STAT_INC
(
¡©_dma_loİ_”rs
);

511  
FRCORE_ACT_UNFREE
;

515 if(
	`cvmx_tim_add_’Œy
(
wÜk
, 
FRCORE_DMA_LOOP_TIMEOUT
, 
NULL
) ) {

516 
	`FRCORE_ERROR
("Add dma†oopimer fail.\n");

517  
FRCORE_ACT_UNFREE
;

520  
FRCORE_ACT_UNFREE
;

521 
	}
}

523 
	$äcÜe_cmd_£tup_dma_loİ_buff
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

525 *
Ş’
 = 0;

526 
äc_dma_loİ_buff_addr_t
 *
buff_addr
 = (äc_dma_loİ_buff_addr_ˆ*è
·¿m
;

528 
	`FRCORE_CMD
("cÜe_num %Îd:„x_add¸0x%Îx,x_add¸0x%Îx\n", (
ULL
è
buff_addr
->
cÜe_num
, (ULLèbuff_addr->
rx_addr
, (ULLèbuff_addr->
tx_addr
);

530 
»mÙe_dma_loİ_rx_addr
[
buff_addr
->
cÜe_num
] = buff_addr->
rx_addr
;

532 
»mÙe_dma_loİ_tx_addr
[
buff_addr
->
cÜe_num
] = buff_addr->
tx_addr
;

534 
rv
;

535 
rv
 = 
	`äcÜe_dma_g©h”
(
DMA_DIR_RECV
, 
äcÜe_dma_loİ_rx_buff
[
buff_addr
->
cÜe_num
], 
»mÙe_dma_loİ_rx_addr
[buff_addr->cÜe_num], 
FRC_DMA_BUFF_SIZE
);

536 ià(
rv
)

538 
	`FRCORE_ERROR
("DMA†oİ„ecv bufàfÜm„emÙç:„v = %d.!\n", 
rv
);

539 
	`FRCORE_STAT_INC
(
¡©_dma_”rÜs
);

540  
FRE_DMA
;

543 
rv
 = 
	`äcÜe_dma_g©h”
(
DMA_DIR_RECV
, 
äcÜe_dma_loİ_tx_buff
[
buff_addr
->
cÜe_num
], 
»mÙe_dma_loİ_tx_addr
[buff_addr->cÜe_num], 
FRC_DMA_BUFF_SIZE
);

544 ià(
rv
)

546 
	`FRCORE_ERROR
("DMA†oİ„ecv bufàfÜm„emÙç:„v = %d.!\n", 
rv
);

547 
	`FRCORE_STAT_INC
(
¡©_dma_”rÜs
);

548  
FRE_DMA
;

553  
FRE_SUCCESS
;

554 
	}
}

556 
	$äcÜe_dma_š™
()

558 #ià
FRC_CONFIG_DMA_TEST


559 
äcÜe_dma_loİ_wqe
 = 
	`cvmx_boÙmem_®loc
((
cvmx_wqe_t
è* 
FRC_DAT_CORE_NUM
, 128);

560 ià(
äcÜe_dma_loİ_wqe
 =ğ
NULL
)

562 
	`FRCORE_ERROR
("Alloc frcore_dma_loop_wqe from bootmem fail!\n");

563  
FRE_MEMORY
;

566 
	`FRCORE_INIT
("äcÜe_dma_loİ_wqğ%p.\n", 
äcÜe_dma_loİ_wqe
);

568 
i
;

570 
i
 = 0; i < 
FRC_DAT_CORE_NUM
; i++)

572 
»mÙe_dma_loİ_rx_addr
[
i
] = 0;

573 
»mÙe_dma_loİ_tx_addr
[
i
] = 0;

574 
äcÜe_dma_loİ_rx_buff
[
i
] = 
	`cvmx_boÙmem_®loc
(
FRC_DMA_BUFF_SIZE
, 0);

575 ià(
äcÜe_dma_loİ_rx_buff
[
i
] =ğ
NULL
)

577 
	`FRCORE_ERROR
("AÎoødm¨loİ„ecv bufà%d fa.\n", 
i
);

578  
FRE_MEMORY
;

581 
äcÜe_dma_loİ_tx_buff
[
i
] = 
	`cvmx_boÙmem_®loc
(
FRC_DMA_BUFF_SIZE
, 0);

582 ià(
äcÜe_dma_loİ_tx_buff
[
i
]=ğ
NULL
)

584 
	`FRCORE_ERROR
("AÎoødm¨loİ s’d bufà%d fa.\n", 
i
);

585  
FRE_MEMORY
;

588 
äcÜe_dma_loİ_‹mp_buff
[
i
] = 
	`cvmx_boÙmem_®loc
(
FRC_DMA_BUFF_SIZE
, 0);

589 ià(
äcÜe_dma_loİ_‹mp_buff
[
i
]=ğ
NULL
)

591 
	`FRCORE_ERROR
("AÎoødm¨loİ s’d bufà%d fa.\n", 
i
);

592  
FRE_MEMORY
;

594 
	`mem£t
(
äcÜe_dma_loİ_‹mp_buff
[
i
], 0, 
FRC_DMA_BUFF_SIZE
);

598 
	`FRCORE_INIT
("AÎoødm¨loİ„ecv/£nd bufàsucûss. Bufã¸siz%ld.\n", (
äc_dma_loİ_buff_t
));

600 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_TEST
, 
TEST_CMD_DMA_LOOP_START
, 
äcÜe_cmd_dma_loİ_¡¬t
);

601 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_CTRL
, 
CTRL_CMD_SETUP_DMA_LOOP_BUFF
, 
äcÜe_cmd_£tup_dma_loİ_buff
);

604 
	}
}

	@frcore/frcore_dma.h

1 #iâdeà
__FRCORE_DMA_H__


2 
	#__FRCORE_DMA_H__


	)

4 
	~"äc_dma.h
"

5 
	~"äcÜe.h
"

7 
	#DMA_USE_COMPLETION_WORD


	)

8 
	#DMA_WAIT_INTERVAL
 100000

	)

10 
	#FRCORE_MAX_DMA_POINTERS
 
CN56XX_PASS2_MAX_DMA_LOCAL_POINTERS


	)

11 
	#FRCORE_DMA_BUFF_MAX
 (
FRCORE_MAX_DMA_POINTERS
 * 
MAX_PCI_DMA_LOCAL_BUF_SIZE
)

	)

13 
	#DMA_DIR_RECV
 0

	)

14 
	#DMA_DIR_SEND
 1

	)

16 
	#FRCORE_QUEUE_RING_SIZE
 (
FRCORE_MAX_DMA_POINTERS
 * 1024)

	)

17 
	#FRCORE_QUEUE_TIMEOUT
 (
FRCORE_TIM_TICKS_PSEC
 / 100)

	)

18 
	#FRCORE_QUEUE_POST_PERIOD
 (
	`cvmx_sysšfo_g‘
()->
ıu_şock_hz
 / 10)

	)

19 
	#FRCORE_QUEUE_POST_LWM
 (
FRCORE_MAX_DMA_POINTERS
 * 16)

	)

21 
	#FRCORE_CHAN_TIMEOUT
 (
FRCORE_TIM_TICKS_PSEC
 / 100è

	)

23 
	#FRCORE_CHAN_POST_PERIOD
 (
	`cvmx_sysšfo_g‘
()->
ıu_şock_hz
 / 10)

	)

24 
	#FRCORE_CHAN_POST_LWM
 (
FRCORE_MAX_DMA_POINTERS
 * 16)

	)

26 
	#FRCORE_DMA_LOOP_TIMEOUT
 
FRCORE_TIM_TICKS
 * 10

	)

29 
	mnumb”
;

30 
	msize
[
FRCORE_MAX_DMA_POINTERS
];

31 
ušt8_t
 *
	mloÿl_±r
[
FRCORE_MAX_DMA_POINTERS
];

32 
ušt64_t
 
	m»mÙe_addr
[
FRCORE_MAX_DMA_POINTERS
];

33 } 
	täcÜe_dma_sÿ‰”_desc_t
;

36 
cvmx_¥šlock_t
 
	mlock
;

38 
ušt32_t
 
	mty³
;

39 
ušt32_t
 
	mqueue_id
;

40 
ušt64_t
 
	mù¾_addr
;

41 
ušt64_t
 
	mava_size
;

42 
ušt64_t
 
	mava_widx
;

43 
ušt64_t
 
	mava_ridx
;

44 
ušt64_t
 
	mcom¶_size
;

45 
ušt64_t
 
	mcom¶_widx
;

46 
ušt64_t
 
	mcom¶_ridx
;

47 
ušt64_t
 
	mloÿl_widx
;

48 
ušt64_t
 
	mloÿl_ridx
;

49 
ušt64_t
 
	mrx_pkts
;

50 
ušt64_t
 
	mtx_pkts
;

51 
ušt64_t
 
	mpo¡_cyşe
;

52 
ušt64_t
 
	midx_buff
[
RING_BUFF_SIZE
];

53 
ušt64_t
 
	mpkt_size
[
FRCORE_QUEUE_RING_SIZE
];

54 
äc_dma_pkt_t
 
	mpkts
[
FRCORE_QUEUE_RING_SIZE
];

55 
cvmx_wqe_t
 
	mwqe
;

56 
äc_dma_buff_poŞ_t
 
	mpoŞ
;

57 } 
	täcÜe_queue_t
;

61 
cvmx_¥šlock_t
 
	mlock
;

62 
äc_dma_ù¾_t
 
	mù¾
;

63 
äc_dma_queue_desc_t
 
	mdesc
;

64 
ušt64_t
 
	mrx_pkts
;

65 
ušt64_t
 
	mtx_pkts
;

66 
cvmx_wqe_t
 
	mwqe
;

67 } 
	täcÜe_dma_s¢_queue_t
;

70 
cvmx_¥šlock_t
 
	mava_lock
;

71 
cvmx_¥šlock_t
 
	mcom¶_lock
;

72 
ušt64_t
 
	mty³
;

73 
ušt64_t
 
	mù¾_addr
;

74 
ušt64_t
 
	mava_widx
;

75 
ušt64_t
 
	mava_ridx
;

76 
ušt64_t
 
	mcom¶_widx
;

77 
ušt64_t
 
	mcom¶_ridx
;

78 
ušt64_t
 
	mrx_pkts
;

79 
ušt64_t
 
	mtx_pkts
;

80 } 
	täcÜe_sim¶e_·ckage_chª_t
;

82 
	#FRCORE_CORE_FIFO_NUM
 (
FRCORE_MAX_DMA_POINTERS
 * 16)

	)

84 
	säcÜe_sim¶e_·ckage_fifo_ûÎ
{

85 
ušt16_t
 
	mpkt_size
;

86 
ušt8_t
 
	md©a
[
FRC_DMA_SIMPLE_PACKAGE_DATA_SIZE
];

87 } 
	täcÜe_sim¶e_·ckage_fifo_ûÎ_t
;

88 
	säcÜe_sim¶e_·ckage_fifo
{

89 
cvmx_¥šlock_t
 
	mlock
;

90 
ušt64_t
 
	mrx_pkts
;

91 
ušt64_t
 
	mtx_pkts
;

92 
ušt64_t
 
	mloÿl_widx
;

93 
ušt64_t
 
	mloÿl_ridx
;

94 
ušt64_t
 
	mpo¡_cyşe
;

95 
cvmx_wqe_t
 
	mwqe
;

96 
ušt64_t
 
	midx_buff
[
FRCORE_CORE_FIFO_NUM
];

97 
äcÜe_sim¶e_·ckage_fifo_ûÎ_t
 
	mfifo_ûÎ
[
FRCORE_CORE_FIFO_NUM
];

98 }
	täcÜe_sim¶e_·ckage_fifo_t
;

100 
	#FRC_SIMPLE_PACKAGE_SIMPLE_CHAN_FIFO_NUM
 10

	)

101 
	#FRC_SIMPLE_PACKAGE_FIFO_NUM
 (
FRC_SIMPLE_PACKAGE_SIMPLE_CHAN_FIFO_NUM
 + FRC_SIMPLE_PACKAGE_SIMPLE_CHAN_FIFO_NUM)

	)

103 
	#FRC_SSN_SIMPLE_CHAN_FIFO_NUM
 10

	)

104 
	#FRC_SSN_FIFO_NUM
 (
FRC_SSN_SIMPLE_CHAN_FIFO_NUM
 * 5)

	)

105 
	#FRCORE_SSN_AVAIL_BUFF_GET_SIZE
 1000

	)

107 
cvmx_¥šlock_t
 
	mava_lock
;

108 
cvmx_¥šlock_t
 
	mcom¶_lock
;

109 
ušt64_t
 
	mty³
;

110 
ušt64_t
 
	mava_addr
;

111 
ušt64_t
 
	mcom¶_addr
;

112 
ušt64_t
 
	mava_widx
;

113 
ušt64_t
 
	mava_ridx
;

114 
ušt64_t
 
	mcom¶_widx
;

115 
ušt64_t
 
	mcom¶_ridx
;

116 
ušt64_t
 
	mrx_pkts
;

117 
ušt64_t
 
	mtx_pkts
;

118 
ušt64_t
 
	mava_buff
[
FRCORE_SSN_AVAIL_BUFF_GET_SIZE
];

119 
ušt64_t
 
	mcom¶_buff
[
FRCORE_SSN_AVAIL_BUFF_GET_SIZE
];

120 } 
	täcÜe_s¢_chª_t
;

123 
	mFRC_SSN_RESV
,

124 
	mFRC_SSN_DMA_HEAD
,

125 
	mFRC_SSN_DMA_PAYLOAD
,

126 
	mFRC_SSN_DMA_MAX
,

127 } 
	täc_s¢_dma_ty³_e
;

129 #ià
FRC_CONFIG_SSN_CHAN_TEST


130 
	#FRC_PAYLOAD_LEN_MAX
 8192

	)

131 
	säcÜe_s¢_fifo_ûÎ
{

133 
äc_s¢_dma_ty³_e
 
	mty³
;

134 
äc_dma_hdr_t
 
	mh—d
;

135 
äc_dma_pkt_šfo_t
 
	mšfo
;

136 
ušt8_t
 
	m·ylßd
[
FRC_PAYLOAD_LEN_MAX
];

137 
ušt16_t
 
	m·ylßd_size
;

138 
ušt64_t
 
	mblock_addr
;

139 
ušt16_t
 
	mšfo_off£t
;

140 
ušt16_t
 
	m·ylßd_off£t
;

141 } 
	täcÜe_s¢_fifo_ûÎ_t
;

143 
	#FRC_PAYLOAD_LEN_MAX
 1600

	)

144 
	säcÜe_s¢_fifo_ûÎ
{

146 
äc_s¢_dma_ty³_e
 
	mty³
;

147 
äc_dma_hdr_t
 
	mh—d
;

148 
äc_dma_pkt_šfo_t
 
	mšfo
;

149 #ià
FRC_CONFIG_SSN_WQE_TEST


150 
ušt8_t
 *
	m·ylßd
;

152 
ušt8_t
 
	m·ylßd
[
FRC_PAYLOAD_LEN_MAX
];

154 
ušt16_t
 
	m·ylßd_size
;

155 
ušt64_t
 
	mblock_addr
;

156 
ušt16_t
 
	mšfo_off£t
;

157 
ušt16_t
 
	m·ylßd_off£t
;

158 
cvmx_wqe_t
 *
	mwqe
;

159 } 
	täcÜe_s¢_fifo_ûÎ_t
;

161 
	säcÜe_s¢_fifo
{

162 
cvmx_¥šlock_t
 
	mlock
;

163 
ušt64_t
 
	mrx_pkts
;

164 
ušt64_t
 
	mtx_pkts
;

165 
ušt64_t
 
	mloÿl_widx
;

166 
ušt64_t
 
	mloÿl_ridx
;

167 
ušt64_t
 
	mpo¡_cyşe
;

168 
cvmx_wqe_t
 
	mwqe
;

169 #ià
FRC_CONFIG_SSN_AVAIL_BUFF_GET


170 
ušt64_t
 
	mava_rdx
;

171 
ušt64_t
 
	mava_buff
[
FRCORE_SSN_AVAIL_BUFF_GET_SIZE
];

173 
äcÜe_s¢_fifo_ûÎ_t
 
	mfifo_ûÎ
[
FRCORE_CORE_FIFO_NUM
];

174 }
	täcÜe_s¢_fifo_t
;

176 #ià
FRC_CONFIG_SIMPLE_PACKAGE
 || 
FRC_CONFIG_SSN_CHAN


177 
äcÜe_dma_sÿ‰”
(
dœ
, 
äcÜe_dma_sÿ‰”_desc_t
 *
desc
);

178 
äcÜe_dma_g©h”
(
dœ
, *
loÿl
, 
ušt64_t
 
»mÙe_addr
, 
size
);

179 
äcÜe_cİy_äom_»mÙe
(
size
, *
loÿl
, 
ušt64_t
 
»mÙe_addr
);

180 
äcÜe_cİy_to_»mÙe
(
size
, *
loÿl
, 
ušt64_t
 
»mÙe_addr
);

182 #ià
FRC_CONFIG_DMA_TEST


183 
äcÜe_dma_š™
();

186 
äcÜe_fÜw¬d_tı_pkt_to_ho¡
(
äc_dma_hdr_t
 *
hdr
, 
äc_dma_pkt_šfo_t
 *
šfo
, *
·ylßd
);

187 
äcÜe_fÜw¬d_udp_pkt_to_ho¡
(
äc_dma_hdr_t
 *
hdr
, 
äc_dma_pkt_šfo_t
 *
šfo
, *
·ylßd
);

190 
äcÜe_tı_dma_queue_´oûss
(
cvmx_wqe_t
 *
wqe
);

191 
äcÜe_udp_dma_queue_´oûss
(
cvmx_wqe_t
 *
wqe
);

193 
äcÜe_dma_loİ
(
cvmx_wqe_t
 *
wqe
);

	@frcore/frcore_filter.c

1 
	~"äcÜe.h
"

2 
	~"äcÜe_cmd.h
"

3 
	~"äcÜe_misc.h
"

4 
	~"äc_·ck.h
"

5 
	~"äcÜe_´Ùo.h
"

6 
	~"cvmx-mdio.h
"

7 
	~"äcÜe_š™.h
"

8 
	~"äcÜe_aş.h
"

9 
	~"äcÜe_pkt.h
"

10 
	~"äc_ty³s.h
"

11 
	~"äcÜe_¡©.h
"

12 
	~"äcÜe_chª.h
"

13 
	~"äcÜe_f‹r.h
"

15 #ià
FRC_CONFIG_TWO_TUPLE


16 
CVMX_SHARED
 
mµ_sh¬ed_d©a
 
gsd©a
;

18 
	#INDEX_ET
(
a
,
b
è(×è=ğ(b))

	)

20 
	#FRCORE_ACL_HASH_TABLE_LOCK
(
_hash_bË
è
	`cvmx_¥šlock_lock
(&((_hash_bË)->
lock
));\

21 
	`FRCORE_INFO
("lock‡ş hashabË\n")

	)

22 
	#FRCORE_ACL_HASH_TABLE_UNLOCK
(
_hash_bË
è
	`cvmx_¥šlock_uÆock
(&((_hash_bË)->
lock
));\

23 
	`FRCORE_INFO
("uÆock‡ş hashabË\n")

	)

32 
äcÜe_aş
* 
	$aş_g‘_aş_¬¿y
()

34  
gsd©a
.
two_tu¶e_aş
;

35 
	}
}

48 
äcÜe_aş_hash_bË_t
 *
	$aş_g‘_hash_bË
(
ušt16_t
 
aş_ty³
, 
ušt32_t
 
hash
)

50 
äcÜe_aş_hash_bË_t
 *
hash_bË
 = 
NULL
;

52 if(
aş_ty³
 <ğ
FRC_ACL_UNKNOWN
 ||‡ş_ty³ > 
FRC_ACL_DP
) {

54 
	`FRCORE_STAT_INC
(
¡©_aş_ty³_”rÜ
);

55  
hash_bË
;

58 if(
hash
 >ğ
FRCORE_MAX_FILTERS
) {

60 
	`FRCORE_STAT_INC
(
¡©_aş_hash_”rÜ
);

61  
hash_bË
;

64 
hash_bË
 = &
gsd©a
.
aş_hash_bË
[
FRCORE_MAX_FILTERS
 * (
aş_ty³
 - 1è+ 
hash
];

65  
hash_bË
;

66 
	}
}

78 
šlše
 
ušt32_t
 
	$aş_hash_üc
(
ušt32_t
 
Úe_tu¶e
, 
ušt16_t
 
´Ùo
)

80 
idx
;

81 
	`CVMX_MT_CRC_POLYNOMIAL
 (0x1edc6f41);

82 
	`CVMX_MT_CRC_IV
 (0);

83 
	`CVMX_MT_CRC_WORD
 (
Úe_tu¶e
);

84 
	`CVMX_MT_CRC_HALF
 (
´Ùo
);

85 
	`CVMX_MF_CRC_IV
 (
idx
);

86  
idx
 & 
FRCORE_ACL_HASH_MASK
;

87 
	}
}

95 
	$äcÜe_f‹r_š™
()

97 
i
;

100 
äcÜe_aş
 *
aş
 = 
	`aş_g‘_aş_¬¿y
();

101 
aş
->
aş_d©a
.
numF‹rs
 = 0;

102 
i
 = 0; i < 
FRCORE_MAX_FILTERS
; i++) {

103 
aş
->
aş_d©a
.
f‹rA¼
[
i
].
’abË
 = 0;

104 
aş
->
aş_d©a
.
f‹rA¼
[
i
].
aş_ty³
 = 0;

105 
aş
->
aş_d©a
.
f‹rA¼
[
i
].
aùiÚ
 = 0;

106 
aş
->
aş_d©a
.
f‹rA¼
[
i
].
İ
 = 0;

107 
aş
->
aş_d©a
.
f‹rA¼
[
i
].
aş_sourû
 = 0;

108 
aş
->
aş_d©a
.
f‹rA¼
[
i
].
´Ùo
 = 0;

109 
aş
->
aş_d©a
.
f‹rA¼
[
i
].
Úe_tu¶e
 = 0;

110 
aş
->
aş_d©a
.
f‹rA¼
[
i
].
šdex
 = 0;

111 
aş
->
aş_d©a
.
f‹rA¼
[
i
].
hash
 = 0;

112 
aş
->
aş_d©a
.
f‹rA¼
[
i
].
pkt_num
 = 0;

113 
aş
->
aş_d©a
.
f‹rA¼
[
i
].
pkt_by‹s
 = 0;

115 
	`´štf
("twouple‡cl init finished!\n");

118 
äcÜe_aş_hash_bË_t
 *
aş_hash_bË
;

119 
aş_hash_bË
 = 
gsd©a
.acl_hash_table;

120 
i
 = 0; i < 
FRCORE_ACL_HASH_TABLE_SIZE
; i++) {

121 
aş_hash_bË
[
i
].
h—d
.
lh_fœ¡
 = 
NULL
;

122 
aş_hash_bË
[
i
].
buck‘_d•th
 = 0;

123 
aş_hash_bË
[
i
].
tÙ®_ûÎ
 = 0;

124 
aş_hash_bË
[
i
].
d–_ûÎ
 = 0;

125 
	`cvmx_¥šlock_š™
(&
aş_hash_bË
[
i
].
lock
);

126 
aş_hash_bË
[
i
].
»£rved
 = 0;

128 
	`´štf
("twouple‡cl hashable init finished!\n");

130  
FRE_SUCCESS
;

131 
	}
}

133 
šlše
 
	$f‹r_¡©i¡ic_h™
(
ušt16_t
 
šdex
)

135 
	`cvmx_©omic_ãtch_ªd_add64
((
št64_t
 *)(&
gsd©a
.
two_tu¶e_aş
->
aş_d©a
.
f‹rA¼
[
šdex
-1].
pkt_num
), 1);

136 
	}
}

138 
šlše
 
	$f‹r_š™_¡©i¡ic_h™
(
ušt16_t
 
šdex
)

140 
	`cvmx_©omic_£t64
((
št64_t
 *)(&
gsd©a
.
two_tu¶e_aş
->
aş_d©a
.
f‹rA¼
[
šdex
-1].
pkt_num
), 0);

141 
	}
}

143 
šlše
 
ušt64_t
 
	$f‹r_g‘_¡©i¡ic_h™
(
ušt16_t
 
šdex
)

145  
	`cvmx_©omic_ãtch_ªd_add64
((
št64_t
 *)(&
gsd©a
.
two_tu¶e_aş
->
aş_d©a
.
f‹rA¼
[
šdex
-1].
pkt_num
),

147 
	}
}

149 
šlše
 
	$f‹r_pkt_by‹s_add
(
ušt16_t
 
šdex
, ušt16_ˆ
pkt_Ën
)

151 
	`cvmx_©omic_ãtch_ªd_add64
((
št64_t
 *)(&
gsd©a
.
two_tu¶e_aş
->
aş_d©a
.
f‹rA¼
[
šdex
-1].
pkt_by‹s
),

152 
pkt_Ën
);

153 
	}
}

155 
šlše
 
	$f‹r_š™_pkt_by‹s
(
ušt16_t
 
šdex
)

157 
	`cvmx_©omic_£t64
((
št64_t
 *)(&
gsd©a
.
two_tu¶e_aş
->
aş_d©a
.
f‹rA¼
[
šdex
-1].
pkt_by‹s
), 0);

158 
	}
}

160 
šlše
 
ušt64_t
 
	$f‹r_g‘_pkt_by‹s
(
ušt16_t
 
šdex
)

162  
	`cvmx_©omic_ãtch_ªd_add64
((
št64_t
 *)(&
gsd©a
.
two_tu¶e_aş
->
aş_d©a
.
f‹rA¼
[
šdex
-1].
pkt_by‹s
),

164 
	}
}

173 
	$f‹r_š™_f‹r_¡©i¡ics
(
ušt16_t
 
šdex
)

175 
	`f‹r_š™_¡©i¡ic_h™
(
šdex
);

176 
	`f‹r_š™_pkt_by‹s
(
šdex
);

177 
	}
}

187 
ušt16_t
 
	$aş_g‘_f‹r_couÁ
(
ušt16_t
 *
aş_num
)

189 
ušt16_t
 
num
;

190 
äcÜe_aş
 *
aş_’Œy
 = 
NULL
;

193 
aş_’Œy
 = 
	`aş_g‘_aş_¬¿y
();

194 if(
aş_’Œy
 =ğ
NULL
) {

195  
FRE_FAIL
;

198 
num
 = (
ušt16_t
è(
aş_’Œy
->
aş_d©a
.
numF‹rs
);

200 *
aş_num
 = 
num
;

201  
FRE_SUCCESS
;

202 
	}
}

213 
	$aş_g‘_hash
(
ušt16_t
 
šdex
, 
ušt32_t
 * 
hash
)

215 
äcÜe_aş
 *
aş_’Œy
 = 
NULL
;

218 
aş_’Œy
 = 
	`aş_g‘_aş_¬¿y
();

219 if(
aş_’Œy
 =ğ
NULL
) {

220  
FRE_FAIL
;

224 *
hash
 = 
aş_’Œy
->
aş_d©a
.
f‹rA¼
[
šdex
 -1].hash;

226  
FRE_SUCCESS
;

227 
	}
}

239 
	$aş_g‘_ty³
(
ušt16_t
 
šdex
, ušt16_ˆ* 
aş_ty³
)

241 
äcÜe_aş
 *
aş_’Œy
 = 
NULL
;

244 
aş_’Œy
 = 
	`aş_g‘_aş_¬¿y
();

245 if(
aş_’Œy
 =ğ
NULL
) {

246  
FRE_FAIL
;

250 *
aş_ty³
 = 
aş_’Œy
->
aş_d©a
.
f‹rA¼
[
šdex
 -1].acl_type;

252  
FRE_SUCCESS
;

253 
	}
}

264 
	$aş_g‘_¡©us
(
ušt16_t
 
šdex
, ušt16_ˆ* 
aş_¡©us
)

266 
äcÜe_aş
 *
aş_’Œy
 = 
NULL
;

269 
aş_’Œy
 = 
	`aş_g‘_aş_¬¿y
();

270 if(
aş_’Œy
 =ğ
NULL
) {

271  
FRE_FAIL
;

275 *
aş_¡©us
 = 
aş_’Œy
->
aş_d©a
.
f‹rA¼
[
šdex
 -1].
’abË
;

277  
FRE_SUCCESS
;

278 
	}
}

289 
	$aş_d–‘e_Úe_f‹r
(
ušt16_t
 
šdex
)

291 
äcÜe_aş
 *
aş_’Œy
 = 
NULL
;

294 
aş_’Œy
 = 
	`aş_g‘_aş_¬¿y
();

295 if(
aş_’Œy
 =ğ
NULL
) {

296  
FRE_FAIL
;

300 
aş_’Œy
->
aş_d©a
.
numF‹rs
--;

301 
aş_’Œy
->
aş_d©a
.
f‹rA¼
[
šdex
-1].
’abË
 = 0;

302 
aş_’Œy
->
aş_d©a
.
f‹rA¼
[
šdex
-1].
aş_ty³
 = 
FRC_ACL_UNKNOWN
;

303 
aş_’Œy
->
aş_d©a
.
f‹rA¼
[
šdex
-1].
aùiÚ
 = 0;

304 
aş_’Œy
->
aş_d©a
.
f‹rA¼
[
šdex
-1].
İ
 = 0;

305 
aş_’Œy
->
aş_d©a
.
f‹rA¼
[
šdex
-1].
aş_sourû
 = 0;

306 
aş_’Œy
->
aş_d©a
.
f‹rA¼
[
šdex
-1].
´Ùo
 = 0;

307 
aş_’Œy
->
aş_d©a
.
f‹rA¼
[
šdex
-1].
Úe_tu¶e
 = 0;

308 
aş_’Œy
->
aş_d©a
.
f‹rA¼
[
šdex
-1].index = 0;

309 
aş_’Œy
->
aş_d©a
.
f‹rA¼
[
šdex
-1].
hash
 = 0;

312 
	`f‹r_š™_f‹r_¡©i¡ics
(
šdex
);

313 
	`FRCORE_STAT_INC
(
¡©_aş_d–_ruË_num
);

314  
FRE_SUCCESS
;

316 
	}
}

333 
	$aş_add_Úe_f‹r
(
ušt16_t
 
šdex
, 
ušt32_t
 
Úe_tu¶e
, ušt16_ˆ
´Ùo
,ušt16_ˆ
İ
,

334 
ušt16_t
 
aùiÚ
, ušt16_ˆ
aş_ty³
, ušt16_ˆ
aş_sourû
,

335 
ušt32_t
 
hash
)

337 
äcÜe_aş
 *
aş_’Œy
 = 
NULL
;

341 
aş_’Œy
 = 
	`aş_g‘_aş_¬¿y
();

342 if(
aş_’Œy
 =ğ
NULL
) {

343  
FRE_FAIL
;

347 
aş_’Œy
->
aş_d©a
.
f‹rA¼
[
šdex
 -1].
aş_ty³
 =‡cl_type;

348 
aş_’Œy
->
aş_d©a
.
f‹rA¼
[
šdex
 -1].
aùiÚ
 =‡ction;

349 
aş_’Œy
->
aş_d©a
.
f‹rA¼
[
šdex
 -1].
İ
 = op;

350 
aş_’Œy
->
aş_d©a
.
f‹rA¼
[
šdex
 -1].
aş_sourû
 =‡cl_source;

351 
aş_’Œy
->
aş_d©a
.
f‹rA¼
[
šdex
 -1].
´Ùo
 =…roto;

352 
aş_’Œy
->
aş_d©a
.
f‹rA¼
[
šdex
 -1].
Úe_tu¶e
 = one_tuple;

353 
aş_’Œy
->
aş_d©a
.
f‹rA¼
[
šdex
 -1].index = index;

354 
aş_’Œy
->
aş_d©a
.
f‹rA¼
[
šdex
 -1].
hash
 = hash;

355 
aş_’Œy
->
aş_d©a
.
f‹rA¼
[
šdex
 -1].
’abË
 = 1;

356 
aş_’Œy
->
aş_d©a
.
numF‹rs
++;

357 
	`FRCORE_STAT_INC
(
¡©_aş_add_ruË_num
);

359  
FRE_SUCCESS
;

360 
	}
}

377 
	$aş_g‘_Úe_f‹r
(
ušt16_t
 
šdex
, 
ušt32_t
 *
Úe_tu¶e
, ušt16_ˆ*
´Ùo
,ušt16_ˆ*
İ
,

378 
ušt16_t
 *
aùiÚ
,ušt16_ˆ*
aş_ty³
, ušt16_ˆ*
aş_sourû
,

379 
ušt32_t
 *
pkt_num
, ušt32_ˆ*
by‹s_num
, ušt32_ˆ*
hash_v®ue
)

381 
rv
;

382 
ušt32_t
 
hash
;

383 
ušt16_t
 
ty³
;

384 
äcÜe_aş_hash_bË_t
 *
hash_bË
 = 
NULL
;

385 
äcÜe_aş
 *
aş_’Œy
 = 
NULL
;

388 
aş_’Œy
 = 
	`aş_g‘_aş_¬¿y
();

389 if(
aş_’Œy
 =ğ
NULL
) {

390  
FRE_FAIL
;

393 if(
aş_’Œy
->
aş_d©a
.
f‹rA¼
[
šdex
 - 1].
’abË
 == 0) {

394  
FRE_INIT
;

398 
rv
 = 
	`aş_g‘_hash
(
šdex
, &
hash
);

399 if(
rv
) {

400 
	`FRCORE_ERROR
("acl_get_hash\n");

401  
rv
;

404 
	`FRCORE_INFO
("šdex:%d, hash:%d\n", 
šdex
, 
hash
);

406 
rv
 = 
	`aş_g‘_ty³
(
šdex
, &
ty³
);

407 if(
rv
) {

408 
	`FRCORE_ERROR
("acl_get_type\n");

409  
rv
;

413 
hash_bË
 = 
	`aş_g‘_hash_bË
(
ty³
, 
hash
);

414 if(
hash_bË
 =ğ
NULL
) {

416 
	`FRCORE_ERROR
("acl_get_hash_table");

417  
FRE_FAIL
;

421 
	`FRCORE_ACL_HASH_TABLE_LOCK
(
hash_bË
);

424 *
aş_ty³
 = 
aş_’Œy
->
aş_d©a
.
f‹rA¼
[
šdex
 -1].acl_type;

425 *
aùiÚ
 = 
aş_’Œy
->
aş_d©a
.
f‹rA¼
[
šdex
 -1].action;

426 *
İ
 = 
aş_’Œy
->
aş_d©a
.
f‹rA¼
[
šdex
 -1].op;

427 *
aş_sourû
 = 
aş_’Œy
->
aş_d©a
.
f‹rA¼
[
šdex
 -1].acl_source;

428 *
´Ùo
 = 
aş_’Œy
->
aş_d©a
.
f‹rA¼
[
šdex
 -1].proto;

429 *
Úe_tu¶e
 = 
aş_’Œy
->
aş_d©a
.
f‹rA¼
[
šdex
 -1].one_tuple;

430 *
hash_v®ue
 = 
aş_’Œy
->
aş_d©a
.
f‹rA¼
[
šdex
 -1].
hash
;

431 *
pkt_num
 = 
	`f‹r_g‘_¡©i¡ic_h™
(
šdex
);

432 *
by‹s_num
 = 
	`f‹r_g‘_pkt_by‹s
(
šdex
);

433 
	`FRCORE_ACL_HASH_TABLE_UNLOCK
(
hash_bË
);

435  
FRE_SUCCESS
;

436 
	}
}

451 
	$aş_g‘_Úe_hash_bË
(
ušt16_t
 
aş_ty³
, ušt16_ˆ
gid
, 
ušt32_t
 *
buck‘_d•th
,

452 
ušt32_t
 *
tÙ®_ûÎ
, ušt32_ˆ*
d–_ûÎ
)

454 
äcÜe_aş_hash_bË_t
 *
hash_bË
 = 
NULL
;

457 
hash_bË
 = 
	`aş_g‘_hash_bË
(
aş_ty³
, (
ušt32_t
)
gid
);

458 if(
hash_bË
 =ğ
NULL
) {

460 
	`FRCORE_ERROR
("acl_get_hash_table");

461  
FRE_FAIL
;

464 
	`FRCORE_ACL_HASH_TABLE_LOCK
(
hash_bË
);

465 *
buck‘_d•th
 = 
hash_bË
->bucket_depth;

466 *
tÙ®_ûÎ
 = 
hash_bË
->total_cell;

467 *
d–_ûÎ
 = 
hash_bË
->del_cell;

468 
	`FRCORE_ACL_HASH_TABLE_UNLOCK
(
hash_bË
);

469  
FRE_SUCCESS
;

470 
	}
}

481 
	$aş_d–‘e_Úe_f‹r_äom_hash_bË
(
ušt16_t
 
šdex
, 
äcÜe_aş_hash_bË_t
 *
hash_bË
)

484 
aş_hash_ûÎ
 *
q
;

487 if(
hash_bË
->
buck‘_d•th
 == 0 ||

488 
	`LIST_EMPTY
(&
hash_bË
->
h—d
)) {

489 
	`FRCORE_STAT_INC
(
¡©_aş_’Œy_exû±iÚ
);

490  
FRE_FAIL
;

494 
	`LIST_FOREACH
(
q
, &
hash_bË
->
h—d
, 
tqe_q
){

495 if(
	`INDEX_ET
(
q
->
aş_šdex
, 
šdex
)) {

500 if(
q
) {

502 
	`FRCORE_STAT_INC
(
¡©_aş_d–_hash_ûÎ
);

503 
	`LIST_REMOVE
(
q
, 
tqe_q
);

504 
	`cvmx_åa_ä“
(
q
, 
CVMX_FPA_ACL_HASH_CELL_POOL
, 0);

505 
hash_bË
->
buck‘_d•th
--;

506 
hash_bË
->
d–_ûÎ
++;

507 
CVMX_SYNCWS
;

510 
	`FRCORE_STAT_INC
(
¡©_aş_nÙ_found_šdex
);

511  
FRE_FAIL
;

514  
FRE_SUCCESS
;

515 
	}
}

526 
	$aş_add_Úe_f‹r_to_hash_bË
(
ušt16_t
 
šdex
)

529 
äcÜe_aş_hash_bË_t
 *
hash_bË
;

530 
ušt32_t
 
hash
;

531 
ušt16_t
 
aş_ty³
;

532 
aş_hash_ûÎ
 *
q
;

533 
aş_hash_ûÎ
 *
p
 = 
NULL
;

534 
aş_hash_ûÎ
 *
‹
 = 
NULL
;

535 
rv
;

538 
rv
 = 
	`aş_g‘_hash
(
šdex
, &
hash
);

539 if(
rv
) {

540 
	`FRCORE_ERROR
("acl_get_hash\n");

541  
rv
;

544 
rv
 = 
	`aş_g‘_ty³
(
šdex
, &
aş_ty³
);

545 if(
rv
) {

546 
	`FRCORE_ERROR
("acl_get_type\n");

547  
rv
;

551 
hash_bË
 = 
	`aş_g‘_hash_bË
(
aş_ty³
, 
hash
);

552 if(
hash_bË
 =ğ
NULL
) {

554 
	`FRCORE_ERROR
("acl_get_hash_table");

555  
FRE_FAIL
;

564 
‹
 = (
aş_hash_ûÎ
 *)
	`cvmx_åa_®loc
(
CVMX_FPA_ACL_HASH_CELL_POOL
);

565 ià(
‹
 =ğ
NULL
) {

566 
	`FRCORE_ERROR
("tcp„easseble‡lloc failed\n");

567 
	`FRCORE_STAT_INC
(
¡©_aş_hash_ûÎ_®loc_ç
);

568  
FRE_FAIL
;

570 
‹
->
d©a_64
[0] = 0;

571 
‹
->
d©a_64
[1] = 0;

572 
‹
->
d©a_64
[2] = 0;

576 
‹
->
aş_šdex
 = 
šdex
;

579 
	`LIST_FOREACH
(
q
, &
hash_bË
->
h—d
, 
tqe_q
){

580 
p
 = 
q
;

583 ià(
p
 =ğ
NULL
) {

584 
	`LIST_INSERT_HEAD
(&
hash_bË
->
h—d
, 
‹
, 
tqe_q
);

586 
	`LIST_INSERT_AFTER
(
p
, 
‹
, 
tqe_q
);

588 
hash_bË
->
buck‘_d•th
++;

589 
hash_bË
->
tÙ®_ûÎ
++;

590 
	`FRCORE_STAT_INC
(
¡©_aş_add_hash_ûÎ
);

591 
CVMX_SYNCWS
;

593  
FRE_SUCCESS
;

594 
	}
}

609 
	$aş_£t_f‹r
(
ušt16_t
 
šdex
, 
ušt32_t
 
Úe_tu¶e
, ušt16_ˆ
´Ùo
,ušt16_ˆ
İ
,

610 
ušt16_t
 
aùiÚ
, ušt16_ˆ
aş_ty³
, ušt16_ˆ
aş_sourû
)

612 
rv
;

613 
ušt32_t
 
hash
;

614 
ušt16_t
 
aş_ty³_Şd
;

615 
ušt16_t
 
aş_¡©us
 = 0;

616 
äcÜe_aş_hash_bË_t
 *
hash_bË
 = 
NULL
;

619 if(
šdex
 < 
ACL_INDEX_START
 || index > 
ACL_MAX
) {

620 
	`FRCORE_ERROR
("indexƒxceed!!\n");

621  
FRE_PARAM
;

624 if(
aş_ty³
 < 
FRC_ACL_SIP
 ||‡ş_ty³ > 
FRC_ACL_DP
) {

625 
	`FRCORE_ERROR
("acl_typeƒrror!!\n");

626  
FRE_PARAM
;

630 
rv
 = 
	`aş_g‘_¡©us
(
šdex
, &
aş_¡©us
);

631 if(
rv
) {

632 
	`FRCORE_ERROR
("acl_get_status\n");

633  
rv
;

636 if(
aş_¡©us
) {

639 
rv
 = 
	`aş_g‘_hash
(
šdex
, &
hash
);

640 if(
rv
) {

641 
	`FRCORE_ERROR
("acl_get_hash\n");

642  
rv
;

645 
rv
 = 
	`aş_g‘_ty³
(
šdex
, &
aş_ty³_Şd
);

646 if(
rv
) {

647 
	`FRCORE_ERROR
("acl_get_type\n");

648  
rv
;

652 
hash_bË
 = 
	`aş_g‘_hash_bË
(
aş_ty³_Şd
, 
hash
);

653 if(
hash_bË
 =ğ
NULL
) {

655 
	`FRCORE_ERROR
("acl_get_hash_table");

656  
FRE_FAIL
;

660 
	`FRCORE_ACL_HASH_TABLE_LOCK
(
hash_bË
);

663 
rv
 = 
	`aş_d–‘e_Úe_f‹r_äom_hash_bË
(
šdex
, 
hash_bË
);

664 if(
rv
){

665 
	`FRCORE_ERROR
("acl_delete_one_filter_from_hash_table\n");

666 
	`FRCORE_ACL_HASH_TABLE_UNLOCK
(
hash_bË
);

667  
rv
;

671 
rv
 = 
	`aş_d–‘e_Úe_f‹r
(
šdex
);

672 if(
rv
){

673 
	`FRCORE_ERROR
("acl_delete_one_filter\n");

674 
	`FRCORE_ACL_HASH_TABLE_UNLOCK
(
hash_bË
);

675  
rv
;

679 
	`FRCORE_ACL_HASH_TABLE_UNLOCK
(
hash_bË
);

683 
hash
 = 
	`aş_hash_üc
(
Úe_tu¶e
, 
´Ùo
);

685 
	`FRCORE_INFO
("šdex:%d, hash:%d\n", 
šdex
, 
hash
);

688 
hash_bË
 = 
	`aş_g‘_hash_bË
(
aş_ty³
, 
hash
);

689 if(
hash_bË
 =ğ
NULL
) {

691 
	`FRCORE_ERROR
("acl_get_hash_table");

692  
FRE_FAIL
;

696 
	`FRCORE_ACL_HASH_TABLE_LOCK
(
hash_bË
);

698 
rv
 = 
	`aş_add_Úe_f‹r
(
šdex
, 
Úe_tu¶e
, 
´Ùo
, 
İ
, 
aùiÚ
 , 
aş_ty³
, 
aş_sourû
, 
hash
);

699 if(
rv
){

701 
	`FRCORE_ERROR
("acl_add_one_filter\n");

702 
	`FRCORE_ACL_HASH_TABLE_UNLOCK
(
hash_bË
);

703  
rv
;

707 
rv
 = 
	`aş_add_Úe_f‹r_to_hash_bË
(
šdex
);

708 if(
rv
){

710 
	`FRCORE_ERROR
("acl_add_one_filter_to_hash_table\n");

711 
	`FRCORE_ACL_HASH_TABLE_UNLOCK
(
hash_bË
);

712  
rv
;

715 
	`FRCORE_ACL_HASH_TABLE_UNLOCK
(
hash_bË
);

717  
FRE_SUCCESS
;

718 
	}
}

729 
	$aş_d–_f‹r
(
ušt16_t
 
šdex
)

731 
ušt32_t
 
hash
;

732 
ušt16_t
 
aş_ty³
;

733 
ušt16_t
 
aş_¡©us
 = 0;

734 
äcÜe_aş_hash_bË_t
 *
hash_bË
 = 
NULL
;

735 
rv
;

738 if(
šdex
 < 
ACL_INDEX_START
 || index > 
ACL_MAX
) {

739 
	`FRCORE_ERROR
("indexƒxceed!!\n");

740  
FRE_PARAM
;

744 
rv
 = 
	`aş_g‘_¡©us
(
šdex
, &
aş_¡©us
);

745 if(
rv
) {

746 
	`FRCORE_ERROR
("acl_get_status\n");

747  
rv
;

750 if(!
aş_¡©us
) {

751  
FRE_INIT
;

755 
rv
 = 
	`aş_g‘_hash
(
šdex
, &
hash
);

756 if(
rv
) {

757 
	`FRCORE_ERROR
("acl_get_hash\n");

758  
rv
;

761 
	`FRCORE_INFO
("šdex:%d, hash:%d\n", 
šdex
, 
hash
);

763 
rv
 = 
	`aş_g‘_ty³
(
šdex
, &
aş_ty³
);

764 if(
rv
) {

765 
	`FRCORE_ERROR
("acl_get_type\n");

766  
rv
;

770 
hash_bË
 = 
	`aş_g‘_hash_bË
(
aş_ty³
, 
hash
);

771 if(
hash_bË
 =ğ
NULL
) {

773 
	`FRCORE_ERROR
("acl_get_hash_table");

774  
FRE_FAIL
;

778 
	`FRCORE_ACL_HASH_TABLE_LOCK
(
hash_bË
);

781 
rv
 = 
	`aş_d–‘e_Úe_f‹r_äom_hash_bË
(
šdex
, 
hash_bË
);

782 if(
rv
){

783 
	`FRCORE_ERROR
("acl_delete_one_filter_from_hash_table\n");

784 
	`FRCORE_ACL_HASH_TABLE_UNLOCK
(
hash_bË
);

785  
rv
;

789 
rv
 = 
	`aş_d–‘e_Úe_f‹r
(
šdex
);

790 if(
rv
){

791 
	`FRCORE_ERROR
("acl_delete_one_filter\n");

792 
	`FRCORE_ACL_HASH_TABLE_UNLOCK
(
hash_bË
);

793  
rv
;

797 
	`FRCORE_ACL_HASH_TABLE_UNLOCK
(
hash_bË
);

799  
FRE_SUCCESS
;

800 
	}
}

811 
ušt16_t
 
	$f‹r_lookup_by_tu¶e
(
mµ_tu¶e
 
tu¶e
)

813 
ušt32_t
 
Úe_tu¶e
[4] = {0};

814 
äcÜe_aş_hash_bË_t
 *
hash_bË
 = 
NULL
;

815 
ušt32_t
 
hash
;

816 
ušt16_t
 
aş_ty³
;

817 
aş_hash_ûÎ
 *
q
;

818 
i
;

820 
äcÜe_aş
 *
aş_’Œy
 = 
NULL
;

823 
aş_’Œy
 = 
	`aş_g‘_aş_¬¿y
();

824 if(
aş_’Œy
 =ğ
NULL
) {

825  
FRE_FAIL
;

829 
Úe_tu¶e
[0] = 
tu¶e
.
s
;

830 
Úe_tu¶e
[1] = 
tu¶e
.
d
;

831 
Úe_tu¶e
[2] = 
tu¶e
.
¥
;

832 
Úe_tu¶e
[3] = 
tu¶e
.
dp
;

835 
i
 = 0; i < 4; i++)

838 
hash
 = 
	`aş_hash_üc
(
Úe_tu¶e
[
i
], 
tu¶e
.
´Ùo
);

840 
aş_ty³
 = 
i
 + 1;

843 
hash_bË
 = 
	`aş_g‘_hash_bË
(
aş_ty³
, 
hash
);

844 if(
hash_bË
 =ğ
NULL
) {

846 
	`FRCORE_ERROR
("acl_get_hash_table");

847  
FRE_FAIL
;

851 
	`FRCORE_ACL_HASH_TABLE_LOCK
(
hash_bË
);

854 if(
	`LIST_EMPTY
(&
hash_bË
->
h—d
) &&

855 
hash_bË
->
buck‘_d•th
 == 0) {

856 
	`FRCORE_ACL_HASH_TABLE_UNLOCK
(
hash_bË
);

861 
	`LIST_FOREACH
(
q
, &
hash_bË
->
h—d
, 
tqe_q
){

863 if(
aş_’Œy
->
aş_d©a
.
f‹rA¼
[
q
->
aş_šdex
-1].
Úe_tu¶e
 =ğÚe_tu¶e[
i
] &&

864 
aş_’Œy
->
aş_d©a
.
f‹rA¼
[
q
->
aş_šdex
-1].
´Ùo
 =ğ
tu¶e
.proto ) {

865 
	`FRCORE_ACL_HASH_TABLE_UNLOCK
(
hash_bË
);

866  (
ušt16_t
è(
q
->
aş_šdex
);

871 
	`FRCORE_ACL_HASH_TABLE_UNLOCK
(
hash_bË
);

875 
	}
}

	@frcore/frcore_filter.h

1 #iâdeà
_FRCORE_FILTER_H


2 
	#_FRCORE_FILTER_H


	)

4 
	~"cvmx-cÚfig.h
"

5 
	~"cvmx.h
"

6 
	~"cvmx-wqe.h
"

7 
	~"cvmx-çu.h
"

8 
	~"cvmx-©omic.h
"

9 
	~"cvmx-¥šlock.h
"

11 
	~"äcÜe_š™.h
"

12 
	~"äcÜe_cÚfig.h
"

13 
	~"äcÜe_debug.h
"

14 
	~"äcÜe_queue.h
"

15 
	~"äc_ty³s.h
"

17 
	sTwoTu¶eF‹r


19 
ušt16_t
 
	m’abË
;

20 
ušt16_t
 
	maş_ty³
;

21 
ušt16_t
 
	maùiÚ
;

22 
ušt16_t
 
	mİ
;

23 
ušt16_t
 
	maş_sourû
;

24 
ušt16_t
 
	m´Ùo
;

25 
ušt32_t
 
	mÚe_tu¶e
;

26 
ušt32_t
 
	mšdex
;

27 
ušt32_t
 
	mhash
;

28 
ušt64_t
 
	mpkt_num
;

29 
ušt64_t
 
	mpkt_by‹s
;

32 
	#FRCORE_MAX_FILTERS
 (2*
K
)

33 

	)

34 
	sTwoTu¶eFtS‘


36 
	mnumF‹rs
;

37 
TwoTu¶eF‹r
 
	mf‹rA¼
[
FRCORE_MAX_FILTERS
];

40 
	säcÜe_aş
{

41 
TwoTu¶eFtS‘
 
	maş_d©a
;

42 }
	täcÜe_aş
;

46 
	#CVMX_FPA_ACL_HASH_CELL_POOL
 (7è

	)

47 
	#CVMX_FPA_ACL_HASH_CELL_POOL_SIZE
 
CVMX_CACHE_LINE_SIZE


	)

48 
	#FRCORE_ACL_HASH_CELL_BUF_NUMS
 
FRCORE_MAX_FILTERS


	)

49 
	#FRCORE_ACL_HASH_MASK
 (
FRCORE_ACL_HASH_CELL_BUF_NUMS
 - 1)

	)

50 
	#FRCORE_ACL_HASH_TABLE_SIZE
 (
FRCORE_ACL_HASH_CELL_BUF_NUMS
 * 4)

	)

53 
	saş_hash_ûÎ
 {

56 
LIST_ENTRY
(
aş_hash_ûÎ
è
	mtqe_q
;

57 
ušt64_t
 
	maş_šdex
;

59 
ušt64_t
 
	md©a_64
[3];

61 }
	taş_hash_ûÎ
;

63 
LIST_HEAD
(
buck‘_h—d
, 
aş_hash_ûÎ
);

64 
	säcÜe_aş_hash_bË_t
 {

67 
buck‘_h—d
 
	mh—d
;

68 
ušt64_t
 
	mbuck‘_d•th
;

69 
ušt64_t
 
	mtÙ®_ûÎ
;

70 
ušt64_t
 
	md–_ûÎ
;

71 
cvmx_¥šlock_t
 
	mlock
;

72 
ušt32_t
 
	m»£rved
;

74 
ušt64_t
 
	md©a_64
[5];

75 
ušt32_t
 
	md©a_32
[10];

77 }
	täcÜe_aş_hash_bË_t
;

79 
äcÜe_f‹r_š™
();

90 
ušt16_t
 
aş_g‘_f‹r_couÁ
(ušt16_ˆ*
aş_num
);

106 
aş_g‘_Úe_f‹r
(
ušt16_t
 
šdex
, 
ušt32_t
 *
Úe_tu¶e
, ušt16_ˆ*
´Ùo
,ušt16_ˆ*
İ
,

107 
ušt16_t
 *
aùiÚ
,ušt16_ˆ*
aş_ty³
, ušt16_ˆ*
aş_sourû
,

108 
ušt32_t
 *
pkt_num
, ušt32_ˆ*
by‹s_num
, ušt32_ˆ*
hash
);

123 
aş_g‘_Úe_hash_bË
(
ušt16_t
 
aş_ty³
, ušt16_ˆ
gid
, 
ušt32_t
 *
buck‘_d•th
,

124 
ušt32_t
 *
tÙ®_ûÎ
, ušt32_ˆ*
d–_ûÎ
);

139 
aş_£t_f‹r
(
ušt16_t
 
šdex
, 
ušt32_t
 
Úe_tu¶e
, ušt16_ˆ
´ÙocŞ
,ušt16_ˆ
İ
,

140 
ušt16_t
 
aùiÚ
, ušt16_ˆ
aş_ty³
, ušt16_ˆ
aş_sourû
);

151 
aş_d–_f‹r
(
ušt16_t
 
šdex
);

162 
ušt16_t
 
f‹r_lookup_by_tu¶e
(
mµ_tu¶e
 
tu¶e
);

164 
šlše
 
f‹r_¡©i¡ic_h™
(
ušt16_t
 
šdex
);

165 
šlše
 
f‹r_š™_¡©i¡ic_h™
(
ušt16_t
 
šdex
);

166 
šlše
 
ušt64_t
 
f‹r_g‘_¡©i¡ic_h™
(
ušt16_t
 
šdex
);

167 
šlše
 
f‹r_pkt_by‹s_add
(
ušt16_t
 
šdex
, ušt16_ˆ
pkt_Ën
);

168 
šlše
 
f‹r_š™_pkt_by‹s
(
ušt16_t
 
šdex
);

169 
šlše
 
ušt64_t
 
f‹r_g‘_pkt_by‹s
(
ušt16_t
 
šdex
);

178 
f‹r_š™_f‹r_¡©i¡ics
(
ušt16_t
 
šdex
);

	@frcore/frcore_fr.c

1 
	~"äcÜe.h
"

2 
	~"äcÜe_cmd.h
"

3 
	~"äcÜe_misc.h
"

4 
	~"äc_·ck.h
"

6 
	~"cvmx-mdio.h
"

7 
	~"äcÜe_ä.h
"

8 
	~"äcÜe_s¢.h
"

11 
ušt8_t
 
	g»Œªs_time
 = 2;

12 
CVMX_SHARED
 
ušt8_t
 
disÜd”_d•th
;

13 
CVMX_SHARED
 
ušt8_t
 
ä_’abË
;

15 #ià
FRC_CONFIG_SSN


17 
	$g‘_s¢_¡©_by_five_tu¶e
(
äc_ä_tu¶e_t
 *
tu¶e
, 
äc_ä_£ssiÚ_¡©_t
 *
¡©
)

20 
	}
}

22 
	$g‘_s¢_¡©_buck‘_by_hash
(
ušt32_t
 
hash
, 
äc_ä_hash_£ssiÚ_t
 *
hash_£ssiÚ
)

25 
	}
}

29 
	$äcÜe_cmd_£t_age_time
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

31 
rv
;

32 
ušt64_t
 
time
 ;

33 
time
 = (*((
ušt8_t
 *)
·¿m
));

34 
	`´štf
("timğ%d\n", ()
time
);

36 
rv
 = 
	`äcÜe_£t_s¢_age
((
ušt8_t
)
time
);

37  
rv
;

38 
	}
}

40 
	$äcÜe_cmd_£t_»Œªs_time
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

42 
ušt8_t
 *
time
 = (ušt8_ˆ*è
·¿m
;

44 
»Œªs_time
 = *
time
;

46  
FRE_SUCCESS
;

47 
	}
}

50 
	$äcÜe_cmd_£t_disÜd”_d•th
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

52 
ušt8_t
 *
¿nge
 = (ušt8_ˆ*è
·¿m
;

54 ià(*
¿nge
 < 
FRCORE_DISORDER_DEPTH_MIN
 ||

55 *
¿nge
 > 
FRCORE_DISORDER_DEPTH_MAX
)

57  
FRE_EXCEED
;

59 
disÜd”_d•th
 = *
¿nge
;

61  
FRE_SUCCESS
;

62 
	}
}

64 
	$äcÜe_cmd_ä_’abË
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

66 
ušt8_t
 *
¡¬t
 = (ušt8_ˆ*è
·¿m
;

68 
ä_’abË
 = *
¡¬t
;

70  
FRE_SUCCESS
;

71 
	}
}

74 
	$äcÜe_cmd_ä_¡©us_g‘
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

76 
äc_ä_¡©us_t
 
¡©us
;

77 
	`mem£t
(&
¡©us
, 0 , (
äc_ä_¡©us_t
));

79 
	`äcÜe_g‘_s¢_age
(&
¡©us
.
age_time
);

80 
¡©us
.
»Œªs_time
 =„etrans_time;

81 
¡©us
.
disÜd”_d•th
 = disorder_depth;

82 
¡©us
.
’abË
 = 
ä_’abË
;

83 
	`memıy
(
outbuf
, &
¡©us
, (
äc_ä_¡©us_t
));

84 *
Ş’
 = (
äc_ä_¡©us_t
);

86  
FRE_SUCCESS
;

88 
	}
}

90 
	$äcÜe_cmd_s¢_g‘_by_five_tu¶e
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

94 
äc_ä_tu¶e_t
 *
tu¶e
 = (äc_ä_tu¶e_ˆ*)
·¿m
;

96 
äc_ä_£ssiÚ_¡©_t
 
£ssiÚ_¡©
;

100 
	`mem£t
(&
£ssiÚ_¡©
, 0, (
äc_ä_£ssiÚ_¡©_t
));

104 
	`´štf
("===========================================================\n");

105 
	`´štf
("s = 0x%x\n", 
tu¶e
->
s
);

106 
	`´štf
("d = 0x%x\n", 
tu¶e
->
d
);

107 
	`´štf
("¥ = %d\n", 
tu¶e
->
¥
);

108 
	`´štf
("d°ğ%d\n", 
tu¶e
->
dp
);

109 
	`´štf
("´ÙØğ%d\n", 
tu¶e
->
´Ùo
);

110 
	`´štf
("»£rvğ%d\n", 
tu¶e
->
»£rve
);

114 
£ssiÚ_¡©
.
pkts
 = 100;

115 
£ssiÚ_¡©
.
by‹s
 = 8000;

119 
five
.
s
 = 0xc0000003;

120 
five
.
d
 = 0xc0000004;

121 
five
.
¥
 = 667;

122 
five
.
dp
 = 445;

123 
five
.
´Ùo
 = 0x11;

125 
	`memıy
(
outbuf
, &
£ssiÚ_¡©
, (
äc_ä_£ssiÚ_¡©_t
));

126 *
Ş’
 = (
äc_ä_£ssiÚ_¡©_t
);

129  
FRE_SUCCESS
;

131 
	}
}

134 
	$äcÜe_cmd_s¢_buck‘_g‘_by_hash
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

137 
ušt32_t
 *
v®ue
 = (ušt32_ˆ*è
·¿m
;

138 
äc_ä_hash_£ssiÚ_t
 
hash_£ssiÚ
;

139 
ušt32_t
 
hash
 = *
v®ue
;

141 
	`mem£t
(&
hash_£ssiÚ
, 0, (
äc_ä_hash_£ssiÚ_t
));

142 
	`g‘_s¢_¡©_buck‘_by_hash
(
hash
, &
hash_£ssiÚ
);

144 
hash_£ssiÚ
.
num
 = 2;

145 
hash_£ssiÚ
.
£ssiÚ
[0].
five_tu¶e
.
s
 = 0xca000001;

146 
hash_£ssiÚ
.
£ssiÚ
[0].
five_tu¶e
.
d
 = 0xca000002;

147 
hash_£ssiÚ
.
£ssiÚ
[0].
five_tu¶e
.
¥
 = 998;

148 
hash_£ssiÚ
.
£ssiÚ
[0].
five_tu¶e
.
dp
 = 999;

149 
hash_£ssiÚ
.
£ssiÚ
[0].
five_tu¶e
.
´Ùo
 = 0x11;

150 
hash_£ssiÚ
.
£ssiÚ
[0].
£ssiÚ_¡©
.
pkts
 = 200;

151 
hash_£ssiÚ
.
£ssiÚ
[0].
£ssiÚ_¡©
.
by‹s
 = 20000;

152 
hash_£ssiÚ
.
£ssiÚ
[1].
five_tu¶e
.
s
 = 0xc0000001;

153 
hash_£ssiÚ
.
£ssiÚ
[1].
five_tu¶e
.
d
 = 0xc0000002;

154 
hash_£ssiÚ
.
£ssiÚ
[1].
five_tu¶e
.
¥
 = 898;

155 
hash_£ssiÚ
.
£ssiÚ
[1].
five_tu¶e
.
dp
 = 899;

156 
hash_£ssiÚ
.
£ssiÚ
[1].
five_tu¶e
.
´Ùo
 = 0x6;

157 
hash_£ssiÚ
.
£ssiÚ
[1].
£ssiÚ_¡©
.
pkts
 = 500;

158 
hash_£ssiÚ
.
£ssiÚ
[1].
£ssiÚ_¡©
.
by‹s
 = 50000;

160 
	`memıy
(
outbuf
, &
hash_£ssiÚ
, (
äc_ä_hash_£ssiÚ_t
));

161 *
Ş’
 = (
äc_ä_hash_£ssiÚ_t
);

163 
	`´štf
("Ş’ = %d, outbuàËngth i %d\n", ()(*
Ş’
), ()(
äc_ä_hash_£ssiÚ_t
));

165 
i
 = 0; i < (
äc_ä_hash_£ssiÚ_t
); i ++)

167 
	`´štf
("0x%x\n", ((
ušt8_t
 *)
outbuf
)[
i
]);

170  
FRE_SUCCESS
;

172 
	}
}

175 
	$äcÜe_cmd_s¢_m©ch
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

177 
äc_s¢_m©ch_t
 *
s¢
 = (äc_s¢_m©ch_ˆ*è
·¿m
;

178 
rv
;

179 
ušt64_t
 
num
;

181 
rv
 = 
	`äcÜe_m©ch_s¢_by_tu¶e
(
s¢
->
tu¶e
.
s
, s¢->tu¶e.
d
, s¢->tu¶e.
¥
, s¢->tu¶e.
dp
, s¢->tu¶e.
´Ùo
);

183 
	`´štf
("===========================================================\n");

184 
	`´štf
("s = 0x%x\n", 
s¢
->
tu¶e
.
s
);

185 
	`´štf
("d = 0x%x\n", 
s¢
->
tu¶e
.
d
);

186 
	`´štf
("¥ = %d\n", 
s¢
->
tu¶e
.
¥
);

187 
	`´štf
("d°ğ%d\n", 
s¢
->
tu¶e
.
dp
);

188 
	`´štf
("´ÙØğ%d\n", 
s¢
->
tu¶e
.
´Ùo
);

189 
	`´štf
("»£rvğ%d\n", 
s¢
->
tu¶e
.
»£rve
);

191 ià(
rv
 !ğ
FRE_SUCCESS
)

193 
	`FRCORE_ERROR
("m©chhi s¢ fa! %d", 
rv
);

194  
rv
;

197 
num
 = 1;

199 
	`memıy
(
outbuf
, &
num
, 8);

201 *
Ş’
 = 8;

203  
FRE_SUCCESS
;

204 
	}
}

208 
	$äcÜe_ä_š™
()

210 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_SET_AGE_TIME
, 
äcÜe_cmd_£t_age_time
);

211 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_SET_RETRANS_TIME
, 
äcÜe_cmd_£t_»Œªs_time
);

212 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_SET_DISORDER_DEPTH
, 
äcÜe_cmd_£t_disÜd”_d•th
);

213 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_FR_ENABLE
, 
äcÜe_cmd_ä_’abË
);

214 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_GET_FR_STATUS
, 
äcÜe_cmd_ä_¡©us_g‘
);

215 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_SSN_GET_FIVETUPLE
, 
äcÜe_cmd_s¢_g‘_by_five_tu¶e
);

216 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_SSN_BUCKET_GET
, 
äcÜe_cmd_s¢_buck‘_g‘_by_hash
);

217 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_SSN_MATCH
, 
äcÜe_cmd_s¢_m©ch
);

220 
	}
}

	@frcore/frcore_fr.h

1 #iâdeà
__FRCORE_FR_H__


2 
	#__FRCORE_FR_H__


	)

3 
	#FRCORE_DISORDER_DEPTH_MIN
 1

	)

4 
	#FRCORE_DISORDER_DEPTH_MAX
 15

	)

5 #ià
FRC_CONFIG_SSN


6 
äcÜe_ä_š™
();

	@frcore/frcore_init.c

27 
	~"cvmcs-commÚ.h
"

28 
	~"äcÜe.h
"

29 
	~"cvmx-h–³r.h
"

30 
	~"cvm-pci-lßd¡Üe.h
"

31 
	~"äcÜe_š™.h
"

32 
	~"äcÜe_s¢.h
"

33 
	~"äcÜe_aş.h
"

35 
CVMX_SHARED
 
ušt32_t
 
cvm_fœ¡_buf_size_aá”_sk
;

36 
CVMX_SHARED
 
ušt32_t
 
cvm_subs_buf_size_aá”_sk
;

38 
CVMX_SHARED
 
cvmx_sysšfo_t
 *
­pšfo
;

39 
CVMX_SHARED
 
oùnic_dev_t
 *
oùnic
;

42 
	gpcÜt
 = 
FIRST_PCI_PORT
;

47 
	$äcÜe_š™_pkt_sk_sizes
()

49 
cvm_fœ¡_buf_size_aá”_sk
 = (((
	`cvmx_»ad_c¤
(
CVMX_IPD_PACKET_MBUFF_SIZE
è& 0xfffè- ((cvmx_»ad_c¤(
CVMX_IPD_1ST_MBUFF_SKIP
) & 0x3f) + 1) ) * 8);

50 
cvm_subs_buf_size_aá”_sk
 = ((
	`cvmx_»ad_c¤
(
CVMX_IPD_PACKET_MBUFF_SIZE
è& 0xfffè- ((cvmx_»ad_c¤(
CVMX_IPD_NOT_1ST_MBUFF_SKIP
) & 0x3f) + 1)) * 8;

52 
	`´štf
("Fœ¡ MBUF size: %u\ÀSub£qu’ˆMBUF size: %u\n", 
cvm_fœ¡_buf_size_aá”_sk
, 
cvm_subs_buf_size_aá”_sk
);

53 
	}
}

59 
	$__g‘_pcÜt
(
gmxpÜt
)

61 
pÜt_to_u£
 = 
pcÜt
;

63 if(
oùnic
->
numpciqs
 > 1) {

64 
pcÜt
++;

65 if(
pcÜt
 > 
LAST_PCI_PORT
)

66 
pcÜt
 = 
FIRST_PCI_PORT
;

69  
pÜt_to_u£
;

70 
	}
}

78 
	$__add_pÜt_to_nic
(
oùnic_dev_t
 *
nic
, 
fœ¡pÜt
, 
Ï¡pÜt
)

80 
i
;

82 
i
 = 
fœ¡pÜt
; i <ğ
Ï¡pÜt
; i++) {

83 
nic
->
pÜt
[
i
].
´e£Á
 = 1;

84 
nic
->
ÅÜts
++;

86 
	}
}

90 
	$pÜt_is_š_nic
(
oùnic_dev_t
 *
nic
, 
idx
)

92  
nic
->
pÜt
[
idx
].
´e£Á
;

93 
	}
}

97 
	$Ãxt_aùive_pÜt
(
oùnic_dev_t
 *
nic
, 
idx
)

99 
idx
 = (idx < 0)?0:(idx+1);

101 
idx
 < 
MAX_OCTEON_ETH_PORTS
) {

102 if(
	`äcÜe_pÜt_aùive
(
idx
)) {

103  
idx
;

106 
idx
++;

110 
	}
}

115 
	$__auto_fšd_pÜts
(
oùnic_dev_t
 *
nic
)

117 
i
, 
j
;

119 
i
 = 0; i < 
	`cvmx_h–³r_g‘_numb”_of_š‹rçûs
(); i++) {

120 
cvmx_h–³r_š‹rçû_mode_t
 
mode
;

121 
mode
 = 
	`cvmx_h–³r_š‹rçû_g‘_mode
(
i
);

122 if(!((
mode
 =ğ
CVMX_HELPER_INTERFACE_MODE_SGMII
) ||

123 (
mode
 =ğ
CVMX_HELPER_INTERFACE_MODE_XAUI
)))

126 
j
 = 0; j < 
	`cvmx_h–³r_pÜts_Ú_š‹rçû
(
i
); j++) {

127 
pÜt
;

128 
pÜt
 = 
	`cvmx_h–³r_g‘_d_pÜt
(
i
,
j
);

129 
	`__add_pÜt_to_nic
(
nic
, 
pÜt
,…ort);

132 
	}
}

137 
	$äcÜe_š™_bßrd_šfo
()

139 
i
, 
ifidx
=0;

140 
bßrd¡ršg
[32];

142 
oùnic
 = 
	`cvmx_boÙmem_®loc
((
oùnic_dev_t
), 
CVMX_CACHE_LINE_SIZE
);

143 if(
oùnic
 =ğ
NULL
) {

144 
	`´štf
("% AÎoÿtiÚ faed fÜ oùnic\n", 
__FUNCTION__
);

149 
	`mem£t
(
oùnic
, 0, (
oùnic_dev_t
));

151 if(
­pšfo
) {

152 
­pšfo
->
bßrd_ty³
) {

154 
CVMX_BOARD_TYPE_EBT3000
:

155 
	`¡rıy
(
bßrd¡ršg
, "EBT3000");

156 
	`__add_pÜt_to_nic
(
oùnic
, 16, 19);

158 
CVMX_BOARD_TYPE_EBT5800
:

159 
	`¡rıy
(
bßrd¡ršg
, "EBT5800");

160 
	`__add_pÜt_to_nic
(
oùnic
, 16, 19);

162 
CVMX_BOARD_TYPE_THUNDER
:

163 
	`¡rıy
(
bßrd¡ršg
, "THUNDER");

164 
	`__add_pÜt_to_nic
(
oùnic
, 16, 19);

166 
CVMX_BOARD_TYPE_NICPRO2
:

167 
	`¡rıy
(
bßrd¡ršg
, "NICPRO2");

168 
	`__add_pÜt_to_nic
(
oùnic
, 16, 19);

170 
CVMX_BOARD_TYPE_NIC_XLE_4G
:

171 
	`¡rıy
(
bßrd¡ršg
, "XLE_4G");

172 
	`__add_pÜt_to_nic
(
oùnic
, 16, 19);

174 
CVMX_BOARD_TYPE_NIC_XLE_10G
:

175 
	`¡rıy
(
bßrd¡ršg
, "XLE_10G");

176 
	`__add_pÜt_to_nic
(
oùnic
, 0, 0);

177 
	`__add_pÜt_to_nic
(
oùnic
, 16, 16);

180 
	`__auto_fšd_pÜts
(
oùnic
);

181 
	`¥rštf
(
bßrd¡ršg
, "UnknowÀ(bßrd_ty³: %d)", 
­pšfo
->
bßrd_ty³
);

186 
	`´štf
("\Àbßrdty³: % \n", 
bßrd¡ršg
);

188 #ifdeà
USE_MULTIPLE_OQ


189 
oùnic
->
numpciqs
 = 4;

191 
oùnic
->
numpciqs
 = 1;

194 
i
 = 0; i < 
MAX_OCTEON_ETH_PORTS
; i++) {

195 if(
	`pÜt_is_š_nic
(
oùnic
, 
i
)) {

196 
oùnic
->
pÜt
[
i
].
¡©e
 = 
CVM_NIC_IF_STATE_ACTIVE
;

197 
oùnic
->
pÜt
[
i
].
rx_Ú
 = 0;

198 
oùnic
->
pÜt
[
i
].
ifidx
 = ifidx++;

199 
oùnic
->
pÜt
[
i
].
lšfo
.
gmxpÜt
 = i;

200 
oùnic
->
pÜt
[
i
].
lšfo
.
pcÜt
 = 
	`__g‘_pcÜt
(i);

201 
	`´štf
("Packets from…ort %d will be sento PCI on…ort %d\n",

202 
oùnic
->
pÜt
[
i
].
lšfo
.
gmxpÜt
, oùnic->pÜt[i].lšfo.
pcÜt
);

204 
oùnic
->
pÜt
[
i
].
¡©e
 = 
CVM_NIC_IF_STATE_INACTIVE
;

209 
	}
}

212 
	$äcÜe_š™_mtu
()

214 
i
, 
Ï¡pÜt
 = -1, 
pÜt
 = -1;

216 
pÜt
 = 
	`Ãxt_aùive_pÜt
(
oùnic
,…ort);

218 if(
pÜt
 == -1) {

219 
	`´štf
("% NØaùivpÜt found\n", 
__FUNCTION__
);

223 ià(!
	`OCTEON_IS_MODEL
(
OCTEON_CN3XXX
è&& !OCTEON_IS_MODEL(
OCTEON_CN58XX
)) {

224 
cvmx_p_äm_Ën_chkx_t
 
äm_Ën_chk
;

228 
äm_Ën_chk
.
u64
 = 0;

229 
äm_Ën_chk
.
s
.
mšËn
 = 64;

230 
äm_Ën_chk
.
s
.
maxËn
 = 
OCTNET_MAX_FRM_SIZE
;

232 
	`cvmx_wr™e_c¤
(
	`CVMX_PIP_FRM_LEN_CHKX
(
	`INTERFACE
(
pÜt
)), 
äm_Ën_chk
.
u64
);

234 
Ï¡pÜt
 = 
pÜt
;

235 
pÜt
 = 
	`Ãxt_aùive_pÜt
(
oùnic
, 
Ï¡pÜt
);

236 
pÜt
 > 0) {

237 if(
	`INTERFACE
(
pÜt
è!ğINTERFACE(
Ï¡pÜt
)) {

238 
	`cvmx_wr™e_c¤
(
	`CVMX_PIP_FRM_LEN_CHKX
(
	`INTERFACE
(
pÜt
)),

239 
äm_Ën_chk
.
u64
);

241 
Ï¡pÜt
 = 
pÜt
;

242 
pÜt
 = 
	`Ãxt_aùive_pÜt
(
oùnic
, 
Ï¡pÜt
);

246 
i
 = 0 ; i < 
MAX_OCTEON_ETH_PORTS
; i++) {

247 if(
	`äcÜe_pÜt_aùive
(
i
)) {

248 
	`cvmx_wr™e_c¤
(
	`CVMX_GMXX_RXX_JABBER
(
	`INDEX
(
i
), 
	`INTERFACE
(i)),

249 ((
OCTNET_DEFAULT_FRM_SIZE
 + 7) & ~7));

252 
	}
}

255 
	$äcÜe_£tup_š‹rçûs
()

257 
i
, 
pÜt
;

258 
ušt8_t
 *
où_mac_addr_ba£
;

262 if(
	`äcÜe_š™_bßrd_šfo
()) {

263 
	`´štf
("% Bßrd In™ faed\n", 
__FUNCTION__
);

268 
	`äcÜe_š™_mtu
();

270 
où_mac_addr_ba£
 = 
	`cvmcs_­p_g‘_maÿddr_ba£
();

272 
oùnic
->
maÿddrba£
 = 0;

273 
i
 = 0; i < 6; i++, 
oùnic
->
maÿddrba£
 <<= 8)

274 
oùnic
->
maÿddrba£
 |ğ
où_mac_addr_ba£
[
i
];

276 
oùnic
->
maÿddrba£
 >>=8;

278 
pÜt
 = 0, 
i
 = 0;…Üˆ< 
MAX_OCTEON_ETH_PORTS
;…ort++) {

279 if(
	`äcÜe_pÜt_aùive
(
pÜt
)) {

280 
ušt64_t
 
hw_addr
;

281 
hw_addr
 = ((
oùnic
->
maÿddrba£
 & 0x0000ffffffffffffULLè+ (
i
++));

282 
oùnic
->
pÜt
[pÜt].
lšfo
.
hw_addr
 = hw_addr;

283 
	`äcÜe_chªge_mac_add»ss
((
ušt8_t
 *)&
hw_addr
, 
pÜt
);

284 
oùnic
->
pÜt
[pÜt].
ifæags
 = 
OCTNET_IFFLAG_MULTICAST
;

285 
	`äcÜe_chªge_muÉiÿ¡_li¡
(
pÜt
);

290 
	`äcÜe_š™_pkt_sk_sizes
();

292 
CVMX_SYNCW
;

295 
	}
}

310 *
	$g‘_sh¬ed_Çmed_block
(
ušt64_t
 
size
, *
Çme
)

312 *
±r
;

314 ià(
	`cvmx_boÙmem_fšd_Çmed_block
(
Çme
)){

315 
±r
 = 
	`cvmx_phys_to_±r
(
	`cvmx_boÙmem_fšd_Çmed_block
(
Çme
)->
ba£_addr
);

317 
±r
 = 
	`cvmx_boÙmem_®loc_Çmed
(
size
, 
CVMX_CACHE_LINE_SIZE
, 
Çme
);

318 if(
±r
) {

319 ià(
	`cvmx_sysšfo_g‘
()->
bßrd_ty³
 !ğ
CVMX_BOARD_TYPE_SIM
)

322 
	`mem£t
(
±r
, 0, 
size
);

326 (
±r
);

327 
	}
}

345 
	$äcÜe_s¢_š™_boÙmem
(
š™
)

348 
mµ_sh¬ed_d©a
 *
sd©a
 = &
gsd©a
;

349 
tÙ®_size
=0;

352 
sd©a
->
g·¿m
 = (
mµ_glob®_·¿m
*)
	`g‘_sh¬ed_Çmed_block
(

353 (
mµ_glob®_·¿m
),

354 
MC_BOOTMEM_SHARED_DATA_NAME
);

355 ià(!
sd©a
->
g·¿m
)

357 
	`MC_PRINTF_ERR
("Unableo‡llocate memory for %s\n",

358 
MC_BOOTMEM_SHARED_DATA_NAME
);

361 
	`MC_PRINTF_INFO
("Get shared block %s, size: 0x%lx,…tr: %p\n",

362 
MC_BOOTMEM_SHARED_DATA_NAME
,

363 (
mµ_glob®_·¿m
),

364 
sd©a
->
g·¿m
);

365 
tÙ®_size
 +ğ(
mµ_glob®_·¿m
);

367 if(
sd©a
->
g·¿m
->
·¿m_ù¾_sw
.
æag_¡¬t_md
 =ğ
MPP_SW_INIT_DONE
)

369 
	`MC_PRINTF_INFO
("Current bootmem blocks have been initialized, skipping...\n");

372 if(
š™
)

373 
sd©a
->
g·¿m
->
·¿m_ù¾_sw
.
æag_¡¬t_md
 = 
MPP_INIT
;

376 
sd©a
->
aş
 = (
mµ_aş
 *)
	`g‘_sh¬ed_Çmed_block
((mµ_aş), 
MC_BOOTMEM_ACL_RULE
);

377 ià(!
sd©a
->
aş
){

378 
	`MC_PRINTF_ERR
("UÇbËØ®loÿ‹ memÜy fÜ %s\n", 
MC_BOOTMEM_ACL_RULE
);

381 
	`´štf
("Get shared block %s, size: 0x%lx,…tr: %p\n",

382 
MC_BOOTMEM_ACL_RULE
,

383 (
mµ_aş
),

384 
sd©a
->
aş
);

385 
tÙ®_size
 +ğ(
mµ_aş
);

387 #ià
FRC_CONFIG_TWO_TUPLE


389 
sd©a
->
two_tu¶e_aş
 = (
äcÜe_aş
 *)
	`g‘_sh¬ed_Çmed_block
((frcore_acl),

390 
MC_BOOTMEM_TWO_TUPLE_ACL_RULE
);

391 ià(!
sd©a
->
two_tu¶e_aş
){

392 
	`MC_PRINTF_ERR
("UÇbËØ®loÿ‹ memÜy fÜ %s\n", 
MC_BOOTMEM_TWO_TUPLE_ACL_RULE
);

395 
	`´štf
("Get shared block %s, size: 0x%lx,…tr: %p\n",

396 
MC_BOOTMEM_TWO_TUPLE_ACL_RULE
,

397 (
äcÜe_aş
),

398 
sd©a
->
two_tu¶e_aş
);

399 
tÙ®_size
 +ğ(
äcÜe_aş
);

402 
sd©a
->
aş_hash_bË
 = (
äcÜe_aş_hash_bË_t
 *è
	`g‘_sh¬ed_Çmed_block
(

403 
FRCORE_ACL_HASH_TABLE_SIZE
 * (
äcÜe_aş_hash_bË_t
),

404 
MC_BOOTMEM_TWO_TUPLE_ACL_HASH_TABLE
);

405 ià(!
sd©a
->
aş_hash_bË
)

407 
	`MC_PRINTF_ERR
("Unableo‡llocate memory for %s, "

408 "tÙ® siz%lu\n", 
MC_BOOTMEM_TWO_TUPLE_ACL_HASH_TABLE
,

409 
FRCORE_ACL_HASH_TABLE_SIZE
 * (
äcÜe_aş_hash_bË_t
));

410 
	`MC_PRINTF_ERR
("Unableo‡llocate memory for %s, "

412 
MC_BOOTMEM_TWO_TUPLE_ACL_HASH_TABLE
, ()
FRCORE_ACL_HASH_TABLE_SIZE
,

413 (
ULL
)(
äcÜe_aş_hash_bË_t
));

416 
	`´štf
("Get shared block %s, unit size: 0x%lx, "

418 
MC_BOOTMEM_TWO_TUPLE_ACL_HASH_TABLE
,

419 (
äcÜe_aş_hash_bË_t
),

420 
FRCORE_ACL_HASH_TABLE_SIZE
 * (
äcÜe_aş_hash_bË_t
),

421 
sd©a
->
aş_hash_bË
);

422 
tÙ®_size
 +ğ
FRCORE_ACL_HASH_TABLE_SIZE
*(
äcÜe_aş_hash_bË_t
);

425 #ià
FRC_CONFIG_SSN


427 
sd©a
->
s¢
 = (
mµ_s¢
 *)
	`g‘_sh¬ed_Çmed_block
(

428 
SSN_HASH_BUCKET_SIZE
*(
mµ_s¢
),

429 
MC_BOOTMEM_SSN_NAME
);

430 ià(!
sd©a
->
s¢
)

432 
	`MC_PRINTF_ERR
("Unableo‡llocate memory for mpp_ssn, "

434 
SSN_HASH_BUCKET_SIZE
*(
mµ_s¢
));

435 
	`MC_PRINTF_ERR
("Unableo‡llocate memory for mpp_ssn, "

437 ()
SSN_HASH_BUCKET_SIZE_BITS
,

438 ()
SSN_HASH_BUCKET_SIZE
, (
ULL
)(
mµ_s¢
));

441 
	`´štf
("Get shared block %s, unit size: 0x%lx, "

443 
MC_BOOTMEM_SSN_NAME
,

444 (
mµ_s¢
),

445 
SSN_HASH_BUCKET_SIZE
*(
mµ_s¢
),

446 
sd©a
->
s¢
);

447 
tÙ®_size
 +ğ
SSN_HASH_BUCKET_SIZE
*(
mµ_s¢
);

492 if(
š™
){

495 
sd©a
->
g·¿m
->
·¿m_ù¾_sw
.
æag_¡¬t_md
 = 
MPP_SW_INIT_DONE
;

498 
	`MC_PRINTF
("TÙ® sizoà sh¬ed mem is: 0x%lx(%dèBy‹s!\n", 
tÙ®_size
,otal_size);

500 
	}
}

540 
	$äcÜe_s¢_š™_­p_åa_glob®
()

542 
»t
;

544 #ià
FRC_CONFIG_SSN


551 
»t
 = 
	`cvmcs_­p_mem_®loc
("SSN Command Buffers",

552 
CVMX_FPA_SSN_POOL
,

553 
CVMX_FPA_SSN_POOL_SIZE
,

554 
MC_FPA_SSN_BUF_NUMS
);

555 if(
»t
)

557 
	`´štf
("!!!!!!!!!!!!!!!!!!!!!!!!!Erroro…opulate FPA for SSN\n");

576 
»t
 = 
	`cvmcs_­p_mem_®loc
("Tcp Flow Recovery Queue Entry Buffers",

577 
CVMX_FPA_TCPFLOWREC_POOL
,

578 
CVMX_FPA_TCPFLOWREC_POOL_SIZE
,

579 
TCP_FLOW_REC_QE_MAX
);

580 ià(
»t
)

582 
	`´štf
("!!!!!!!!!!!!!!!!!!!!!!!!!Erroro…opulate FPA for TCP FLOW RECOVERY QUEUE ENTRY == %u\n",

583 
TCP_FLOW_REC_QE_MAX
);

587 
	`´štf
("===============SUCCESSo…opulate FPA for TCP FLOW RECOVERY QUEUE ENTRY == %u\n",

588 
TCP_FLOW_REC_QE_MAX
);

591 #ià
FRC_CONFIG_TWO_TUPLE


592 
»t
 = 
	`cvmcs_­p_mem_®loc
("Two Tuple ACL Hash Cell Entry Buffers",

593 
CVMX_FPA_ACL_HASH_CELL_POOL
,

594 
CVMX_FPA_ACL_HASH_CELL_POOL_SIZE
,

595 
FRCORE_ACL_HASH_CELL_BUF_NUMS
);

596 ià(
»t
)

598 
	`´štf
("!!!!!!!!!!!!!!!!!!Erroro…opulate FPA for Two Tuple ACL Hash Cell Entry == %u\n",

599 
FRCORE_ACL_HASH_CELL_BUF_NUMS
);

603 
	`´štf
("===============SUCCESSo…opulate FPA for Two Tuple ACL Hash Cell Entry == %u\n",

604 
FRCORE_ACL_HASH_CELL_BUF_NUMS
);

607 
	`MC_PRINTF_INFO
("successo init fpa buffer.\n");

610 
	}
}

613 
	$mc_¡¬t_glob®
()

617 
	`´štf
("start global...\n");

622 if(
	`äcÜe_s¢_š™_boÙmem
(1)){

623 
	`MC_PRINTF_ERR
("====================== boot mem initƒrror=================\n");

627 if(
	`äcÜe_s¢_š™_­p_åa_glob®
()) {

630 
	`´štf
("\tglobal shared memory‡llocated\n");

632 
	}
}

634 
	$mc_š™_·¿m
()

636 
mµ_glob®_·¿m
 *
pd©a
 = 
gsd©a
.
g·¿m
;

638 
pd©a
->
·¿m_ù¾_sw
.
s¢_¡©
 = 1;

640 
pd©a
->
·¿m_ù¾_sw
.
æag_pif_af
 = 0;

641 
pd©a
->
·¿m_ù¾_sw
.
æag_´oc_äag
 = 1;

642 
pd©a
->
·¿m_ù¾_sw
.
æag_š¥_3g_­p
 = 1;

643 
pd©a
->
·¿m_ù¾_sw
.
æag_3gµ_g¢_Ë¬n
 = 0;

644 
pd©a
->
·¿m_ù¾_sw
.
äag_pkt_š‹r
 = 1400;

645 
pd©a
->
·¿m_ù¾_sw
.
äag_pkt
 = 0;

646 
pd©a
->
·¿m_ù¾_sw
.
æag_Áp_time
 = 1;

647 
pd©a
->
Ás
.
cyşes_¡
 = 
	`cvmx_g‘_cyşe
();

648 
pd©a
->
Ás
.
ıu_hz
 = 
	`cvmx_sysšfo_g‘
()->
ıu_şock_hz
/10000000;

650 
	}
}

652 
	$mc_š™_d©a
(
mµ_š™_cÚfig
 
´ofe
)

654 
i
;

655 
gsd©a
.
g·¿m
->
TMP_MASK
 = 0x3f;

657 
mµ_s¢
 *
s¢
 = 
gsd©a
.ssn;

659 
	`mc_š™_·¿m
();

660 
gsd©a
.
g·¿m
->
·¿m_ù¾_sw
.
´ofe
 =…rofile;

662 #ià
FRC_CONFIG_SSN


663 
gsd©a
.
g·¿m
->
·¿m_ù¾_sw
.
s¢_max
 = 
SSN_TOTAL_NUM
;

666 
i
=0; i<
SSN_HASH_BUCKET_SIZE
; i++)

668 
s¢
[
i
].
s¢_šdex
 = 
SSN_INDEX_INVALID
;

669 
s¢
[
i
].
s¢_¡©us
 = 
SSN_STATUS_EMPTY
;

670 
s¢
[
i
].
g½
 = 
GROUP_TO_DATA_PLANE_AGING
;

671 
s¢
[
i
].
qos
 = 1;

672 
s¢
[
i
].
Ãxt_sc
 = 
NULL
;

673 
s¢
[
i
].
s¢_addr
.
addr_æag
 = 0;

674 
s¢
[
i
].
tı_æow_pos™ive_d©a
.
rcv_nxt
 = 0;

675 
s¢
[
i
].
tı_æow_pos™ive_d©a
.
t£gqe_Ën
 = 0;

676 
s¢
[
i
].
tı_æow_pos™ive_d©a
.
h—d
.
lh_fœ¡
 = 
NULL
;

677 
s¢
[
i
].
tı_æow_pos™ive_d©a
.
»v_æow_d©a
 = 
NULL
;

678 
s¢
[
i
].
tı_æow_pos™ive_d©a
.
’abË
 = 1;

679 
s¢
[
i
].
tı_æow_Ãg©ive_d©a
.
rcv_nxt
 = 0;

680 
s¢
[
i
].
tı_æow_Ãg©ive_d©a
.
t£gqe_Ën
 = 0;

681 
s¢
[
i
].
tı_æow_Ãg©ive_d©a
.
h—d
.
lh_fœ¡
 = 
NULL
;

682 
s¢
[
i
].
tı_æow_Ãg©ive_d©a
.
»v_æow_d©a
 = 
NULL
;

683 
s¢
[
i
].
tı_æow_Ãg©ive_d©a
.
’abË
 = 1;

693 
	`cvmx_¥šlock_š™
(&
s¢_¥šlock
);

713 #ià
FRC_CONFIG_RULE


715 
	`aş_š™
();

718 #ià
FRC_CONFIG_TWO_TUPLE


719 
	`äcÜe_f‹r_š™
();

721 
gsd©a
.
g·¿m
->
·¿m_ù¾_sw
.
æag_¡¬t_md
 = 
MPP_SW_START
;

723 
	`´štf
("\tglobal started\n");

726 
	}
}

729 
	$äcÜe_s¢_maš_´•¬e
()

731 
	`´štf
("ssn starting global...\n");

732 if(
	`mc_¡¬t_glob®
()) {

735 
	`´štf
("ssn starting global OK\n");

737 
	`´štf
("š™Ÿlizšg s¢ d©¨w™h…rof%d...\n", 
MPP_ACCELARATED_LINUX
);

738 
	`mc_š™_d©a
(
MPP_ACCELARATED_LINUX
);

739 
	`´štf
("s¢ d©¨š™Ÿlized w™h…rof%d\n", 
MPP_ACCELARATED_LINUX
);

742 
	}
}

	@frcore/frcore_init.h

9 #iâdeà
_FRCORE_INIT_H_


10 
	#_FRCORE_INIT_H_


	)

12 
	~"äcÜe_f‹r.h
"

14 
	#MC_ERROR
 -1

	)

15 
	#MC_OK
 1

	)

23 
	#MC_BOOTMEM_SHARED_DATA_NAME
 "sh¬ed_d©a"

	)

24 
	#MC_BOOTMEM_CROSSLINK_NAME
 "üos¦šk "

	)

25 
	#MC_BOOTMEM_SSN_NAME
 "£ssiÚ "

	)

26 
	#MC_BOOTMEM_SSN_ADDR_NAME
 "£ssiÚ_addr"

	)

27 
	#MC_BOOTMEM_BLC_NAME
 "b®ªû¸ "

	)

28 
	#MC_BOOTMEM_CPSER_NAME
 "cİyto£rv”"

	)

29 
	#MC_BOOTMEM_IP_TREE_NAME
 "_mac_Œ“"

	)

30 
	#MC_BOOTMEM_IP_TREE_CHILDREN_NAME
 "_mac_Œ“_chd»n"

	)

31 
	#MC_BOOTMEM_EPIF_NAME
 "eg»s  "

	)

32 
	#MC_BOOTMEM_VLAN_NAME
 "vÏÀ "

	)

33 
	#MC_BOOTMEM_IFSTAT_NAME
 "if¡© "

	)

34 
	#MC_BOOTMEM_IFSTAT_TIM_NAME
 "if¡©_tim "

	)

35 
	#MC_BOOTMEM_IF_QUEUE_TIM_NAME
 "if_queue_tim"

	)

36 
	#MC_BOOTMEM_QOS_QUEUE_TIM_NAME
 "qos_queue_tim"

	)

37 
	#MC_BOOTMEM_QOS_ID_NAME
 "qos_id "

	)

38 
	#MC_BOOTMEM_QOS_ID_WCQ_NAME
 "qos_id_wcq"

	)

39 
	#MC_BOOTMEM_TIM_NAME
 "tim” "

	)

40 
	#MC_BOOTMEM_IF_WORK_CQ_NAME
 "•if_wÜk_cq"

	)

41 
	#MC_BOOTMEM_SYNFLD_CTL
 "synæd_ùl"

	)

42 
	#MC_BOOTMEM_TCP_FLOW_REC
 "tı_æow_»cov”y"

	)

43 
	#MC_BOOTMEM_FPA_INFO_NAME
 "åa_šfo"

	)

45 
	#MC_BOOTMEM_DATA_NAME
 "d©a"

	)

46 
	#MC_BOOTMEM_IPFRAG_NAME
 "äag"

	)

47 
	#MC_BOOTMEM_NTPTS_NAME
 "Á±s"

	)

48 
	#MC_BOOTMEM_RFC_NAME
 "rfc_sh¬emem_d©a"

	)

49 
	#MC_BOOTMEM_SPI_CNTER_NAME
 "¥i_ú‹r"

	)

50 
	#MC_BOOTMEM_GSN_INFO_NAME
 "g¢_šfo"

	)

51 
	#MC_BOOTMEM_ACL_RULE
 "aş_ruË"

	)

52 
	#MC_BOOTMEM_TWO_TUPLE_ACL_RULE
 "two_tu¶e_aş_ruË"

	)

53 
	#MC_BOOTMEM_TWO_TUPLE_ACL_HASH_TABLE
 "two_tu¶e_aş_hash_bË"

	)

54 
	#MC_BOOTMEM_ACL_INDEX
 "aş_šdex"

	)

55 
	#MC_BOOTMEM_SM
 "sm"

	)

56 
	#MC_BOOTMEM_PORT_NAME
 "pÜt"

	)

57 
	#MC_BOOTMEM_PORT_MONITOR_NAME
 "pÜt_mÚ™Ü"

	)

58 
	#MC_BOOTMEM_IPFRAG_INFO_NAME
 "äag"

	)

60 
	emµ_ruÂšg_¡©us
{

61 
	mMPP_INIT
=0,

62 
	mMPP_SW_INIT_DONE
,

63 
	mMPP_SW_START
,

64 
	mMPP_SW_END


67 
	emµ_š™_cÚfig
{

68 
	mMPP_INTEGREATED_LINUX
=0,

69 
	mMPP_ACCELARATED_LINUX
,

70 
	mMPP_FCASTING
,

71 
	mMPP_TCASTING
,

74 
	smµ_Áp_tsync
{

77 
ušt64_t
 
	mtime_ns
;

78 
ušt64_t
 
	mcyşes_¡
;

79 
ušt64_t
 
	mıu_hz
;

80 
ušt64_t
 
	munu£d
;

82 
ušt64_t
 
	md©a_64
[4];

84 } 
	tmµ_Áp_tsync
;

86 
	smc_ù¾_sw
{

89 
ušt32_t
 
	m´ofe
;

90 
ušt32_t
 
	ms¢_max
;

91 
ušt32_t
 
	mrsv0
;

92 
ušt32_t
 
	mrsv
 : 16;

93 
ušt32_t
 
	mæag_¡¬t_md
: 2;

94 
ušt32_t
 
	ms¢_¡©
: 1;

95 
ušt32_t
 
	mæag_‹¡_max_pkŒ©e
:1;

96 
ušt32_t
 
	mæag_æow_sÿË
:1;

97 
ušt32_t
 
	mæag_3gµ_g¢_Ë¬n
:1;

98 
ušt32_t
 
	mæag_Áp_time
:1;

99 
ušt32_t
 
	mæag_mod_dmac
:1;

100 
ušt32_t
 
	mæag_´oc_äag
:1;

101 
ušt32_t
 
	mæag_š¥_3g_­p
:1;

102 
ušt32_t
 
	mæag_pif_af
:1;

103 
ušt32_t
 
	mæag_¥_qos_sw
 :1;

104 
ušt32_t
 
	mæag_pkt_mÚ™Ü_sw
 :1;

105 
ušt32_t
 
	mæag_pkt_¡©s_sw
 :1;

106 
ušt32_t
 
	mæag_¬p_Ë¬n
:1;

107 
ušt32_t
 
	mrsv1
 : 1;

108 
ušt64_t
 
	mäag_pkt
;

109 
ušt64_t
 
	mäag_pkt_š‹r
;

111 
ušt64_t
 
	md©a_64
[4];

113 }
	tmc_ù¾_sw
;

115 
	smµ_glob®_·¿m
{

116 
mc_ù¾_sw
 
	m·¿m_ù¾_sw
;

117 
mµ_Áp_tsync
 
	mÁs
;

118 
ušt16_t
 
	mTMP_MASK
;

119 }
	tmµ_glob®_·¿m
;

121 
	smµ_sh¬ed_d©a
{

122 
mµ_glob®_·¿m
 *
	mg·¿m
;

123 
mµ_aş
 *
	maş
;

124 #ià 
FRC_CONFIG_TWO_TUPLE


125 
äcÜe_aş
 *
	mtwo_tu¶e_aş
;

126 
äcÜe_aş_hash_bË_t
 *
	maş_hash_bË
;

147 
mµ_s¢
 *
	ms¢
;

154 }
	tCVMX_CACHE_LINE_ALIGNED
 
	tmµ_sh¬ed_d©a
;

160 
CVMX_SHARED
 
mµ_sh¬ed_d©a
 
gsd©a
;

161 
äcÜe_s¢_maš_´•¬e
();

	@frcore/frcore_ip.c

1 
	~"äcÜe_pkt.h
"

2 
	~"äcÜe_tı.h
"

3 
	~"äcÜe_udp.h
"

4 
	~"äcÜe_.h
"

5 
	~"äcÜe_¡©.h
"

6 
	~"äcÜe_´Ùo.h
"

7 
	~"äcÜe_ruË.h
"

8 
	~"äcÜe_twÙu¶e.h
"

9 
	~"äcÜe_vÏn_check.h
"

11 
CVMX_SHARED
 
ušt8_t
 
	gä_’abË
 = 1;

14 
	$äcÜe__İtiÚ_´oûss
(
cvmx_wqe_t
 *
wÜk
, 
ušt8_t
 *
_±r
)

16 
	`FRCORE_STAT_INC
(
¡©__İtiÚ
);

18 
	`FRCORE_DROP
(
¡©_drİ__İtiÚ
);

19 
	}
}

21 
	$äcÜe__äag_´oûss
(
cvmx_wqe_t
 *
wÜk
, 
ušt8_t
 *
_±r
)

24 
	`FRCORE_DROP
(
¡©_drİ__äag
);

25 
	}
}

27 
CVMX_SHARED
 
ušt64_t
 
	grx__pkts
 = 0;

30 
šlše
 
	$äcÜe__´oûss
(
cvmx_wqe_t
 *
wÜk
, 
ušt8_t
 *
‘h_±r
, ušt8_ˆ*
_±r
, 
ušt64_t
 
smac
, ušt64_ˆ
dmac
)

33 
ušt8_t
 
h—d”_Ën
;

34 
ušt16_t
 
tÙ®_Ën
;

35 
ušt8_t
 
´Ùo
;

36 #ià
FRC_CONFIG_VLAN_CHECK
 | 
FRC_CONFIG_TIMESTAMP_CHECK


37 
ušt8_t
 
_v”siÚ
;

38 
ušt8_t
 
vÏn_æag
 = 0;

40 
ušt16_t
 
·yËn
 = 0;

41 
ušt8_t
 *
·ylßd
 = 
NULL
;

42 
rv
;

44 
	`FRCORE_PKT
("==============ğrx__pkt %Îd.\n", (
ULL
è++
rx__pkts
);

46 
	`FRCORE_STAT_INC
(
¡©_
);

48 #ià
FRCORE_CONFIG_ADVANCED_IP


51 ià(
wÜk
->
wÜd2
.
s
.
is_v6
) {

52 
	`FRCORE_PKT
("wÜk->wÜd2.s.is_v6 = %d\n", 
wÜk
->
wÜd2
.
s
.
is_v6
);

53 
	`FRCORE_STAT_INC
(
¡©__v6
);

54 
	`FRCORE_DROP
(
¡©_drİ__v6
);

56 
	`FRCORE_STAT_INC
(
¡©__v4
);

62 ià(
wÜk
->
wÜd2
.
s
.
is_äag
) {

63 
	`FRCORE_PKT
("wÜk->wÜd2.s.is_äag = %d\n", 
wÜk
->
wÜd2
.
s
.
is_äag
);

64 
	`FRCORE_STAT_INC
(
¡©__äag
);

65  
	`äcÜe__äag_´oûss
(
wÜk
, 
_±r
);

68 ià(
wÜk
->
wÜd2
.
s
.
is_v6
) {

69 
	`FRCORE_PKT
("wÜk->wÜd2.s.is_v6 = %d\n", 
wÜk
->
wÜd2
.
s
.
is_v6
);

70 
	`FRCORE_STAT_INC
(
¡©__v6
);

71 #ià
FRC_CONFIG_VLAN_CHECK
 | 
FRC_CONFIG_TIMESTAMP_CHECK


72 
_v”siÚ
 = 
FRCORE_IPV6
;

74 
	`FRCORE_DROP
(
¡©_drİ__v6
);

77 
	`FRCORE_STAT_INC
(
¡©__v4
);

78 #ià
FRC_CONFIG_VLAN_CHECK
 | 
FRC_CONFIG_TIMESTAMP_CHECK


79 
_v”siÚ
 = 
FRCORE_IPV4
;

84 ià(
wÜk
->
wÜd2
.
s
.
vÏn_v®id
) {

85 
	`FRCORE_STAT_INC
(
¡©_vÏn
);

87 #ià
FRC_CONFIG_VLAN_CHECK
 | 
FRC_CONFIG_TIMESTAMP_CHECK


88 
vÏn_æag
 = 1;

92 ià(
wÜk
->
wÜd2
.
s
.
is_äag
) {

93 
	`FRCORE_PKT
("wÜk->wÜd2.s.is_äag = %d\n", 
wÜk
->
wÜd2
.
s
.
is_äag
);

94 
	`FRCORE_STAT_INC
(
¡©__äag
);

95 #ià!
FRC_CONFIG_VLAN_CHECK


96 
	`FRCORE_DROP
(
¡©_drİ__äag
);

102 ià(!
wÜk
->
wÜd2
.
s
.
tı_Ü_udp
) {

103 
	`FRCORE_PKT
("wÜk->wÜd2.s.tı_Ü_ud°ğ%d\n", 
wÜk
->
wÜd2
.
s
.
tı_Ü_udp
);

104 
	`FRCORE_STAT_INC
(
¡©__nÙ_tı_udp
);

105 
	`FRCORE_DROP
(
¡©_drİ__nÙ_tı_udp
);

108 #ià
FRC_CONFIG_VLAN_CHECK
 | 
FRC_CONFIG_TIMESTAMP_CHECK


109 ià(
_v”siÚ
 =ğ
FRCORE_IPV4
) {

110 
	`UP8
(
_±r
, 
h—d”_Ën
);

111 
h—d”_Ën
 = (header_len & 0x0F) * 4;

113 ià(
h—d”_Ën
 != 20) {

116 
	`FRCORE_STAT_INC
(
¡©__İtiÚ
);

119 
	`UP16
(
_±r
 + 2, 
tÙ®_Ën
);

120 
	`UP8
(
_±r
 + 9, 
´Ùo
);

123 
·yËn
 = 
tÙ®_Ën
 - 
h—d”_Ën
;

124 
	`FRCORE_PKT
("tÙ®_ËÀ%u h—d”_ËÀ%u.\n", 
tÙ®_Ën
, 
h—d”_Ën
);

126 
·ylßd
 = 
_±r
 + 
h—d”_Ën
;

127 ià(
tÙ®_Ën
 > 1582)

130 
	`FRCORE_STAT_INC
(
¡©__Ùh”
);

131 
	`FRCORE_DROP
(
¡©_drİ__Ùh”
);

134 ià(
·yËn
 == 0)

136 
	`FRCORE_ERROR
("paylen == 0.\n");

137 
	`FRCORE_STAT_INC
(
¡©__Ùh”
);

138 
	`FRCORE_DROP
(
¡©_drİ__Ùh”
);

143 #ià
FRC_CONFIG_RULE


144 
	`äcÜe_ruË_´oûss
(
wÜk
, 
‘h_±r
, 
_±r
, 
·ylßd
, 
·yËn
, 
smac
, 
dmac
);

147 #ià
FRC_CONFIG_TWO_TUPLE


148 
	`äcÜe_aş_´oûss
(
wÜk
, 
‘h_±r
, 
_±r
, 
·ylßd
, 
·yËn
, 
smac
, 
dmac
);

151 #ià
FRC_CONFIG_VLAN_CHECK
 | 
FRC_CONFIG_TIMESTAMP_CHECK


152 ià(
_v”siÚ
 =ğ
FRCORE_IPV4
) {

153 
´Ùo
) {

154 
PROTO_TCP
:

155 
	`FRCORE_STAT_INC
(
¡©_tı
);

156 #ià
FRC_CONFIG_TCP


157 ià(
ä_’abË
) {

158 
rv
 = 
	`äcÜe_tı_´oûss
(
wÜk
, 
‘h_±r
, 
_±r
, 
·ylßd
, 
·yËn
, 
smac
, 
dmac
);

161 
rv
 = 
FRCORE_ACT_DROP
;

163 
rv
 = 
FRCORE_ACT_DROP
;

166 
PROTO_UDP
:

167 
	`FRCORE_STAT_INC
(
¡©_udp
);

168 #ià
FRC_CONFIG_UDP


169 
rv
 = 
	`äcÜe_udp_´oûss
(
wÜk
, 
‘h_±r
, 
_±r
, 
·ylßd
, 
·yËn
, 
smac
, 
dmac
);

171 
rv
 = 
FRCORE_ACT_DROP
;

176 
	`FRCORE_STAT_INC
(
¡©__Ùh”
);

177 
	`FRCORE_DROP
(
¡©_drİ__Ùh”
);

178 
rv
 = 
FRCORE_ACT_DROP
;

184 #ià
FRC_CONFIG_VLAN_CHECK


185 ià(
vÏn_æag
) {

186 ià(
_v”siÚ
 =ğ
FRCORE_IPV4
) {

187 
rv
 = 
	`äcÜe_vÏn_check_v4
(
wÜk
, 
‘h_±r
, 
_±r
, 
smac
, 
dmac
);

188 } ià(
_v”siÚ
 =ğ
FRCORE_IPV6
) {

189 
rv
 = 
	`äcÜe_vÏn_check_v6
(
wÜk
, 
‘h_±r
, 
_±r
, 
smac
, 
dmac
);

195 #ià
FRC_CONFIG_TIMESTAMP_CHECK


196 ià(
_v”siÚ
 =ğ
FRCORE_IPV4
) {

197 
rv
 = 
	`äcÜe_time¡amp_check_v4
(
wÜk
, 
‘h_±r
, 
_±r
, 
smac
, 
dmac
);

198 } ià(
_v”siÚ
 =ğ
FRCORE_IPV6
) {

199 
rv
 = 
	`äcÜe_time¡amp_check_v6
(
wÜk
, 
‘h_±r
, 
_±r
, 
smac
, 
dmac
);

202  
rv
;

203 
	}
}

	@frcore/frcore_ip.h

1 #iâdeà
__FRCORE_IP_H__


2 
	#__FRCORE_IP_H__


	)

5 
šlše
 
äcÜe__´oûss
(
cvmx_wqe_t
 *
wÜk
, 
ušt8_t
 *
‘h_±r
, ušt8_ˆ*
_±r
, 
ušt64_t
 
smac
, ušt64_ˆ
dmac
);

	@frcore/frcore_ipc.c

1 
	~<¡ršg.h
>

3 
	~"äcÜe.h
"

4 
	~"äcÜe_c.h
"

5 
	~"äcÜe_´Ùo.h
"

6 
	~"äcÜe_¡©.h
"

7 
	~"äcÜe_vÏn_check.h
"

9 #ià
FRC_CONFIG_IPC


11 
	#MAX_MAC_NUM
 512

	)

13 
CVMX_SHARED
 
c_dpkt_hd_t
 
	gc_exp_d©a
;

14 
CVMX_SHARED
 
c_dpkt_hd_t
 
	gc_exp_mask
;

15 
CVMX_SHARED
 
c_cur_t
 
	gc_cur
;

16 
CVMX_SHARED
 
c_misc_t
 
	gc_misc
;

17 
CVMX_SHARED
 
c_š¡r_t
 
	gc_š¡r
;

19 
CVMX_SHARED
 
ušt64_t
 *
	govid_út
;

20 
CVMX_SHARED
 
ušt64_t
 *
	givid_út
;

22 
	$äcÜe_cmd_c_cur_£t
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

24 ià((
c_cur_t
è!ğ
¶’
)

26  
FRE_FAIL
;

29 
c_cur_t
 *
cu½
 = (c_cur_ˆ*è
·¿m
;

30 
	`´štf
("cu½->smaøğ%Îx,…ktid = %Îd\n", 
cu½
->
smac
, cu½->
pktid
);

32 
	`cvmx_©omic_£t64
(&
c_cur
.
smac
, 
cu½
->smac);

33 
	`cvmx_©omic_£t64
(&
c_cur
.
pktid
, 
cu½
->pktid);

35 *
Ş’
 = 0;

37  
FRE_SUCCESS
;

38 
	}
}

40 
	$äcÜe_cmd_c_cur_g‘
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

42 
c_cur_t
 *
cu½
 = (c_cur_t*è
outbuf
;

44 
cu½
->
smac
 = 
	`cvmx_©omic_g‘64
(&
c_cur
.smac);

45 
cu½
->
pktid
 = 
	`cvmx_©omic_g‘64
(&
c_cur
.pktid);

46 
	`´štf
("%s.%d: cu½->smac=0x%Îx, 0x%Îx\n", 
__func__
, 
__LINE__
, 
cu½
->
smac
, 
c_cur
.smac);

47 
	`´štf
("%s.%d: cu½->pktid=0x%Îd, 0x%Îd\n", 
__func__
, 
__LINE__
, 
cu½
->
pktid
, 
c_cur
.pktid);

49 *
Ş’
 = (
c_cur_t
);

51  
FRE_SUCCESS
;

52 
	}
}

54 
	$äcÜe_cmd_c_exp_£t
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

56 ià((
c_exp_t
è!ğ
¶’
)

58  
FRE_FAIL
;

61 
c_exp_t
 *
exµ
 = (c_exp_ˆ*)
·¿m
;

62 
	`´štf
("SET:ouid = %d, iifd = %d, ouim = %d, iifm = %d\n", 
exµ
->
ouid
,ƒxµ->
iifd
,ƒxµ->
ouim
,ƒxµ->
iifm
);

63 
	`´štf
("SET:pidd = 0x%Îx,…idm = 0x%Îx\n", 
exµ
->
pidd
,ƒxµ->
pidm
);

65 
c_exp_d©a
.
f›ld
.
pid_h
 = (
ušt16_t
)(
exµ
->
pidd
 >> 32 & 0xffff);

66 
c_exp_d©a
.
f›ld
.
pid_l
 = 
exµ
->
pidd
 >> 0 & 0xffffffff;

67 
c_exp_d©a
.
f›ld
.
Üi_vid
 = (
ušt16_t
)((
exµ
->
pidd
 >> 32 & 0xffff0000) >> 16);

68 
c_exp_d©a
.
f›ld
.
oui
 = 
exµ
->
ouid
;

69 
c_exp_d©a
.
f›ld
.
chassis
 = ((
ušt8_t
)(
exµ
->
iifd
 >> 8 & 0xf0)) >> 4;

70 
c_exp_d©a
.
f›ld
.
»sv
 = (
ušt8_t
)(
exµ
->
iifd
 >> 8 & 0xf);

72 
c_exp_d©a
.
f›ld
.
¦Ù
 = ((
ušt8_t
)(
exµ
->
iifd
 & 0xf8)) >> 3;

73 
c_exp_d©a
.
f›ld
.
ÿrd
 = ((
ušt8_t
)(
exµ
->
iifd
 & 0x4)) >> 2;

74 
c_exp_d©a
.
f›ld
.
ifid
 = (
ušt8_t
)(
exµ
->
iifd
 & 0x3);

76 
c_exp_mask
.
f›ld
.
pid_h
 = 
exµ
->
pidm
 >> 32 & 0xffffffff;

77 
c_exp_mask
.
f›ld
.
pid_l
 = 
exµ
->
pidm
 >> 0 & 0xffffffff;

78 
c_exp_mask
.
f›ld
.
oui
 = 
exµ
->
ouim
;

79 
c_exp_mask
.
f›ld
.
chassis
 = 
exµ
->
iifm
 >> 8 & 0x7;

80 
c_exp_mask
.
f›ld
.
¦Ù
 = 
exµ
->
iifm
 >> 3 & 0x1f;

81 
c_exp_mask
.
f›ld
.
ÿrd
 = 
exµ
->
iifm
 >> 2 & 0x1;

82 
c_exp_mask
.
f›ld
.
ifid
 = 
exµ
->
iifm
 >> 0 & 0x3;

85 
c_exp_mask
.
f›ld
.
pid_h
 = (
ušt16_t
)(
exµ
->
pidm
 >> 32 & 0xffff);

86 
c_exp_mask
.
f›ld
.
pid_l
 = 
exµ
->
pidm
 >> 0 & 0xffffffff;

87 
c_exp_mask
.
f›ld
.
Üi_vid
 = (
ušt16_t
)((
exµ
->
pidm
 >> 32 & 0xffff0000) >> 16);

88 
c_exp_mask
.
f›ld
.
oui
 = 
exµ
->
ouim
;

89 
c_exp_mask
.
f›ld
.
chassis
 = ((
ušt8_t
)(
exµ
->
iifm
 >> 8 & 0xf0)) >> 4;

90 
c_exp_mask
.
f›ld
.
»sv
 = (
ušt8_t
)(
exµ
->
iifm
 >> 8 & 0xf);

92 
c_exp_mask
.
f›ld
.
¦Ù
 = ((
ušt8_t
)(
exµ
->
iifm
 & 0xf8)) >> 3;

93 
c_exp_mask
.
f›ld
.
ÿrd
 = ((
ušt8_t
)(
exµ
->
iifm
 & 0x4)) >> 2;

94 
c_exp_mask
.
f›ld
.
ifid
 = (
ušt8_t
)(
exµ
->
iifm
 & 0x3);

95 *
Ş’
 = 0;

97 
	`´štf
("SETMASK:pid_h = 0x%x,…id_Èğ0x%x, vid = 0x%x\n", 
c_exp_mask
.
f›ld
.
pid_h
, ipc_exp_mask.f›ld.
pid_l
, ipc_exp_mask.f›ld.
Üi_vid
);

98 
	`´štf
("SETDATA:pid_h = 0x%x,…id_Èğ0x%x, vid = 0x%x\n", 
c_exp_d©a
.
f›ld
.
pid_h
, ipc_exp_d©a.f›ld.
pid_l
, ipc_exp_d©a.f›ld.
Üi_vid
);

99  
FRE_SUCCESS
;

100 
	}
}

102 
	$äcÜe_cmd_c_exp_g‘
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

105 
c_exp_t
 *
exµ
 = (c_exp_ˆ*)
outbuf
;

106 
	`´štf
("GETMASK:chassi ğ%x, slÙ = %x, c¬d = %x, ifid = %x\n", 
c_exp_mask
.
f›ld
.
chassis
, ipc_exp_mask.f›ld.
¦Ù
, ipc_exp_mask.f›ld.
ÿrd
, ipc_exp_mask.f›ld.
ifid
);

107 
	`´štf
("GETDATA:chassi ğ%x, slÙ = %x, c¬d = %x, ifid = %x\n", 
c_exp_d©a
.
f›ld
.
chassis
, ipc_exp_d©a.f›ld.
¦Ù
, ipc_exp_d©a.f›ld.
ÿrd
, ipc_exp_d©a.f›ld.
ifid
);

109 
exµ
->
pidd
 = ((
ušt64_t
)((
c_exp_d©a
.
f›ld
.
Üi_vid
 << 16è| ipc_exp_d©a.f›ld.
pid_h
è<< 32è| ipc_exp_d©a.f›ld.
pid_l
;

110 
exµ
->
ouid
 = 
c_exp_d©a
.
f›ld
.
oui
;

111 
exµ
->
iifd
 = (
c_exp_d©a
.
f›ld
.
chassis
 << 12è| (c_exp_d©a.f›ld.
»sv
 << 8è| (c_exp_d©a.f›ld.
¦Ù
 << 3) |

112 
c_exp_d©a
.
f›ld
.
ÿrd
 << 2 | ipc_exp_d©a.f›ld.
ifid
;

114 
exµ
->
pidm
 = ((
ušt64_t
)((
c_exp_mask
.
f›ld
.
Üi_vid
 << 16è| ipc_exp_mask.f›ld.
pid_h
è<< 32è| ipc_exp_mask.f›ld.
pid_l
;

115 
exµ
->
ouim
 = 
c_exp_mask
.
f›ld
.
oui
;

116 
exµ
->
iifm
 = (
c_exp_mask
.
f›ld
.
chassis
 << 12è| (c_exp_mask.f›ld.
»sv
 << 8è| (c_exp_mask.f›ld.
¦Ù
 << 3) |

117 (
c_exp_mask
.
f›ld
.
ÿrd
 << 2è| ipc_exp_mask.f›ld.
ifid
;

119 
	`´štf
("GETMASK:…idm = 0x%Îx\n", 
exµ
->
pidm
);

120 *
Ş’
 = (
c_exp_t
);

121 
	`´štf
("chassi ğ%x, slÙ = %x, c¬d = %x, ifid = %x\n", 
c_exp_mask
.
f›ld
.
chassis
, ipc_exp_mask.f›ld.
¦Ù
, ipc_exp_mask.f›ld.
ÿrd
, ipc_exp_mask.f›ld.
ifid
);

123  
FRE_SUCCESS
;

124 
	}
}

127 
	$äcÜe_cmd_c_misc_£t
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

129 ià((
c_misc_t
è!ğ
¶’
)

131  
FRE_FAIL
;

134 
c_misc_t
 *
misı
 = (c_misc_ˆ*)
·¿m
;

135 
	`´štf
("SET:smac_check = %d,…ktid_check = %d\n", 
misı
->
smac_check
, misı->
pktid_check
);

136 
	`´štf
("SET:exp_check = %d, inv®id_dum°ğ%d, in¡r_£nd=%d\n", 
misı
->
exp_check
, misı->
šv®id_dump
, misı->
š¡r_£nd
);

139 
c_misc
.
smac_check
 = 
misı
->smac_check;

140 
c_misc
.
pktid_check
 = 
misı
->pktid_check;

141 
c_misc
.
exp_check
 = 
misı
->exp_check;

142 
c_misc
.
šv®id_dump
 = 
misı
->invalid_dump;

143 
c_misc
.
š¡r_£nd
 = 
misı
->instr_send;

145 *
Ş’
 = 0;

147  
FRE_SUCCESS
;

148 
	}
}

150 
	$äcÜe_cmd_c_misc_g‘
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

152 
c_misc_t
 *
misı
 = (c_misc_ˆ*)
outbuf
;

154 
misı
->
smac_check
 = 
c_misc
.smac_check;

155 
misı
->
pktid_check
 = 
c_misc
.pktid_check;

156 
misı
->
exp_check
 = 
c_misc
.exp_check;

157 
misı
->
šv®id_dump
 = 
c_misc
.invalid_dump;

158 
misı
->
š¡r_£nd
 = 
c_misc
.instr_send;

159 
	`´štf
("smac_check = %d,…ktid_check = %d\n", 
c_misc
.
smac_check
, ipc_misc.
pktid_check
);

161 *
Ş’
 = (
c_misc_t
);

163  
FRE_SUCCESS
;

164 
	}
}

168 
	$äcÜe_cmd_c_š¡r_·ylßd_£t
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

170 
j
 = 0;

171 
ušt64_t
 
i
 = 0;

173 ià((
c_·ylßd_£t_š_t
è!ğ
¶’
)

175  
FRE_FAIL
;

178 
c_·ylßd_£t_š_t
 *
·ylßd_£t
 = (c_·ylßd_£t_š_ˆ*)
·¿m
;

179 
	`sw­_buff
(
INSTR_PAYLOAD_SZ
 >> 3, 
·ylßd_£t
->
d©a
);

180 
j
 = 0; j < 
INSTR_PAYLOAD_SZ
; j++)

184 
	`´štf
("šdex = %d\n", 
·ylßd_£t
->
šdex
);

185 
i
 = 
·ylßd_£t
->
šdex
;

186 
	`memıy
(&
c_š¡r
.
·ylßd
[
i
 * 
INSTR_PAYLOAD_SZ
], 
·ylßd_£t
->
d©a
, INSTR_PAYLOAD_SZ);

188 *
Ş’
 = 0;

190  
FRE_SUCCESS
;

191 
	}
}

194 
	$äcÜe_cmd_c_š¡r_£t
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

196 ià((
c_š¡r_cfg_t
è!ğ
¶’
)

198  
FRE_FAIL
;

201 
c_š¡r_cfg_t
 *
š¡½
 = (c_š¡r_cfg_ˆ*)
·¿m
;

202 
	`´štf
("sip_data = 0x%x, sip_mask=0x%x, dip_data = 0x%x, dip_mask=0x%x, ip_len = %d\n",

203 
š¡½
->
s_d©a
, in¡½->
s_mask
, in¡½->
d_d©a
, in¡½->
d_mask
,š¡½->
_Ën
);

205 ià(
š¡½
->
_Ën
 > 
IPC_IP_LEN_MAX
)

207  
FRE_PARAM
;

210 
c_š¡r
.
š¡r_cfg
.
d_d©a
 = 
š¡½
->dip_data;

211 
c_š¡r
.
š¡r_cfg
.
d_mask
 = 
š¡½
->dip_mask;

212 
c_š¡r
.
š¡r_cfg
.
s_d©a
 = 
š¡½
->sip_data;

213 
c_š¡r
.
š¡r_cfg
.
s_mask
 = 
š¡½
->sip_mask;

214 
c_š¡r
.
š¡r_cfg
.
ty³
 = 
š¡½
->type;

215 
c_š¡r
.
š¡r_cfg
.
_Ën
 = 
š¡½
->ip_len;

216 
c_š¡r
.
š¡r_cfg
.
tx_pÜt
 = 
š¡½
->tx_port;

217 
c_š¡r
.
š¡r_cfg
.
aùiÚ
 = 
š¡½
->action;

221 *
Ş’
 = 0;

223  
FRE_SUCCESS
;

224 
	}
}

226 
	$äcÜe_cmd_c_š¡r_g‘
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

228 
c_š¡r_cfg_t
 *
š¡½
 = (c_š¡r_cfg_ˆ*)
outbuf
;

230 
š¡½
->
d_d©a
 = 
c_š¡r
.
š¡r_cfg
.dip_data;

231 
š¡½
->
d_mask
 = 
c_š¡r
.
š¡r_cfg
.dip_mask;

232 
š¡½
->
s_d©a
 = 
c_š¡r
.
š¡r_cfg
.sip_data;

233 
š¡½
->
s_mask
 = 
c_š¡r
.
š¡r_cfg
.sip_mask;

234 
š¡½
->
ty³
 = 
c_š¡r
.
š¡r_cfg
.type ;

235 
š¡½
->
_Ën
 = 
c_š¡r
.
š¡r_cfg
.ip_len ;

236 
š¡½
->
tx_pÜt
 = 
c_š¡r
.
š¡r_cfg
.tx_port;

237 
š¡½
->
aùiÚ
 = 
c_š¡r
.
š¡r_cfg
.action;

241 *
Ş’
 = (
c_š¡r_cfg_t
);

243  
FRE_SUCCESS
;

244 
	}
}

248 
	$äcÜe_dump_buff
(cÚ¡ *
func
, 
lše_num
, 
Ën
, 
ušt8_t
 *
buff
)

250 
i
;

251 *
p
, 
lše
[
DUMP_LINE_SIZE
];

253 
p
 = 
lše
;

254 
	`´štf
("%s.%d: BUFF DUMP %d by‹s:\n", 
func
, 
lše_num
, 
Ën
);

255 
i
 = 0; i < 
Ën
; i++)

257 ià((
i
 % 16) == 0)

260 
	`mem£t
(
lše
, 0, 
DUMP_LINE_SIZE
);

261 
p
 = 
lše
;

262 
p
 +ğ
	`¥rštf
Õ, "%.6d:", 
i
);

265 ià((
i
 % 16) == 8)

267 
p
 +ğ
	`¥rštf
(p, " -");

269 
p
 +ğ
	`¥rštf
Õ, " %.2x", 
buff
[
i
]);

271 ià((
i
 % 16) == 15)

273 
lše
[
DUMP_LINE_SIZE
 - 1] = 0;

274 
	`´štf
("%s\n", 
lše
);

277 ià((
i
 % 16) != 0)

279 
lše
[
DUMP_LINE_SIZE
 - 1] = 0;

280 
	`´štf
("%s\n", 
lše
);

282 
	`´štf
("\n");

283 
	}
}

288 
	$äcÜe_c_dpkt_dump
(
c_dpkt_hd_t
 *
dpkt
)

290 ià(
NULL
 =ğ
dpkt
)

292 
	`FRCORE_ERROR
("Instr is NULL!\n");

295 
	`FRCORE_INFO
(" WORD: 0x%.8x 0x%.8x 0x%.8x\n", 
dpkt
->
wÜd
[0], dpkt->word[1], dpkt->word[2]);

297 
	`FRCORE_INFO
(" 16% : 0x%x", "oui(16)", 
dpkt
->
f›ld
.
oui
);

298 
	`FRCORE_INFO
(" 16% : 0x%x", "pid_h(32)", 
dpkt
->
f›ld
.
pid_h
);

299 
	`FRCORE_INFO
(" 16% : 0x%x", "pid_l(32)", 
dpkt
->
f›ld
.
pid_l
);

300 
	`FRCORE_INFO
(" 16% : 0x%x", "chassis(3)", 
dpkt
->
f›ld
.
chassis
);

301 
	`FRCORE_INFO
(" 16% : 0x%x", "»sv(5)", 
dpkt
->
f›ld
.
»sv
);

302 
	`FRCORE_INFO
(" 16% : 0x%x", "¦Ù(5)", 
dpkt
->
f›ld
.
¦Ù
);

303 
	`FRCORE_INFO
(" 16% : 0x%x", "ÿrd(1)", 
dpkt
->
f›ld
.
ÿrd
);

304 
	`FRCORE_INFO
(" 16% : 0x%x", "ifid(2)", 
dpkt
->
f›ld
.
ifid
);

305 
	}
}

308 
CVMX_SHARED
 
c_š¡r_’Œy_t
 *
	gc_š¡r_bË
 = 
NULL
;

309 
	$äcÜe_c_š¡r_bË_š™
()

311 
i
;

312 *
ouut_d©a
 = 
NULL
;

313 
c_š¡r_hd_t
 *
hd
 = 
NULL
;

314 
c_š¡r_’Œy_t
 *
’Œy
 = 
NULL
;

316 
	`´štf
("%s:%d\n",
__func__
, 
__LINE__
);

318 
c_š¡r_bË
 = 
	`cvmx_boÙmem_®loc
((
c_š¡r_’Œy_t
è* 
IPC_IIF_MAX
, 16);

320 
	`´štf
("%s:%d\n",
__func__
, 
__LINE__
);

321 ià(
NULL
 =ğ
c_š¡r_bË
)

323 
	`´štf
("% š¡abË‡Îoøç\n", 
__FUNCTION__
);

327 
	`mem£t
(
c_š¡r_bË
, 0, (
c_š¡r_’Œy_t
è* 
IPC_IIF_MAX
);

329 
i
 = 0; i < 
IPC_IIF_MAX
; i++)

331 
ouut_d©a
 = 
	`cvmx_boÙmem_®loc
(2048, 0);

332 ià(
ouut_d©a
 =ğ
NULL
)

334 
	`´štf
("netflow output buffer‡lloc fail!.\n");

338 
hd
 = (
c_š¡r_hd_t
 *è
ouut_d©a
;

340 
hd
->
oui
 = 
IPC_INSTR_OUI
;

342 
hd
->
´ÙocŞ
 = 
IPC_INSTR_PROTOCOL
;

344 
hd
->
iif
 = 
i
;

346 
’Œy
 = &
c_š¡r_bË
[
i
];

347 
’Œy
->
outbuf
 = 
ouut_d©a
;

348 
	`cvmx_¥šlock_š™
(&
’Œy
->
lock
);

352  
FRE_SUCCESS
;

356 
ouut_d©a
 = 
	`cvmx_boÙmem_®loc
(4096, 0);

357 ià(
ouut_d©a
 =ğ
NULL
)

359 
	`´štf
("netflow output buffer‡lloc fail!.\n");

362 
	}
}

365 
CVMX_SHARED
 
c_š¡r_’Œy_t
 *
	gc_š¡r_bË
 = 
NULL
;

367 
	$äcÜe_c_š¡r_bË_š™
()

369 
i
;

370 
c_š¡r_hd_t
 *
hd
 = 
NULL
;

371 
cvmx_wqe_t
 *
wqe
 = 
NULL
;

373 
	`´štf
("%s:%d\n",
__func__
, 
__LINE__
);

374 
	`cvmcs_­p_mem_®loc
("WQE OF IPC INSTR TABLE", 
IPC_INSTR_POOL
, 
CVMX_FPA_OUTPUT_BUFFER_POOL_SIZE
, 
IPC_IIF_MAX
);

376 
	`´štf
("%s:%d\n",
__func__
, 
__LINE__
);

377 
c_š¡r_bË
 = 
	`cvmx_boÙmem_®loc
((
c_š¡r_’Œy_t
è* 
IPC_IIF_MAX
, 16);

379 
	`´štf
("%s:%d\n",
__func__
, 
__LINE__
);

380 ià(
NULL
 =ğ
c_š¡r_bË
)

382 
	`´štf
("% š¡abË‡Îoøç\n", 
__FUNCTION__
);

386 
	`mem£t
(
c_š¡r_bË
, 0, (
c_š¡r_’Œy_t
è* 
IPC_IIF_MAX
);

388 
i
 = 0; i < 
IPC_IIF_MAX
; i++)

390 
	`´štf
("%s:%d\n",
__func__
, 
__LINE__
);

391 
wqe
 = 
	`cvmx_åa_®loc
(
IPC_INSTR_POOL
);

392 
	`´štf
("%s:%d\n",
__func__
, 
__LINE__
);

393 if(
	`cvmx_uÆik–y
(
wqe
 =ğ
NULL
))

395 
	`´štf
("% wq®loøçed\n", 
__FUNCTION__
);

399 
	`´štf
("%s:%d\n",
__func__
, 
__LINE__
);

400 
	`mem£t
(
wqe
, 0, (
cvmx_wqe_t
));

402 
	`´štf
("%s:%d\n",
__func__
, 
__LINE__
);

403 
wqe
->
g_ty³
 = 
CVMX_POW_TAG_TYPE_ORDERED
;

404 
	`´štf
("%s:%d\n",
__func__
, 
__LINE__
);

405 
hd
 = (
c_š¡r_hd_t
 *è
wqe
->
·ck‘_±r
.
±r
;

406 
	`´štf
("%s:%d\n",
__func__
, 
__LINE__
);

407 
hd
->
oui
 = 
IPC_INSTR_OUI
;

408 
	`´štf
("%s:%d\n",
__func__
, 
__LINE__
);

409 
hd
->
´ÙocŞ
 = 
IPC_INSTR_PROTOCOL
;

410 
	`´štf
("%s:%d\n",
__func__
, 
__LINE__
);

411 
hd
->
iif
 = 
i
;

413 
	`´štf
("%s:%d\n",
__func__
, 
__LINE__
);

414 
wqe
->
Ën
 = (
c_š¡r_hd_t
);

416 
c_š¡r_’Œy_t
 *
’Œy
 = 
NULL
;

417 
’Œy
 = &
c_š¡r_bË
[
i
];

418 
’Œy
->
wqe
 = wqe;

420 
wqe
->
·ck‘_±r
.
s
.
addr
 = 
buff
;

422 
	`cvmx_¥šlock_š™
(&
’Œy
->
lock
);

423 
	`´štf
("%s:%d\n",
__func__
, 
__LINE__
);

426  
FRE_SUCCESS
;

427 
	}
}

431 
	$äcÜe_£nd_š¡r_·ck‘
(
ušt64_t
 
ouut_Ën
, *
obuf
)

433 
ušt64_t
 
pÜt
 = 16;

434 
cvmx_buf_±r_t
 
·ck‘_±r
;

435 
cvmx_pko_commªd_wÜd0_t
 
pko_commªd
;

437 
	`´štf
("%s:%d\n",
__func__
, 
__LINE__
);

439 ià(
NULL
 =ğ
obuf
)

444 
	`´štf
("%s:%d\n",
__func__
, 
__LINE__
);

445 
queue
 = 
	`cvmx_pko_g‘_ba£_queue
(
pÜt
);

446 
	`cvmx_pko_£nd_·ck‘_´•¬e
(
pÜt
, 
queue
, 
CVMX_PKO_LOCK_ATOMIC_TAG
);

448 
	`´štf
("%s:%d\n",
__func__
, 
__LINE__
);

451 
pko_commªd
.
s
.
tÙ®_by‹s
 = 
ouut_Ën
;

452 
pko_commªd
.
s
.
dÚtä“
 =1;

453 
pko_commªd
.
s
.
£gs
 = 1;

455 
·ck‘_±r
.
u64
 = 0;

456 
·ck‘_±r
.
s
.
poŞ
 = 
CVMX_FPA_PACKET_POOL
;

457 
·ck‘_±r
.
s
.
size
 = 0xffff;

458 
·ck‘_±r
.
s
.
addr
 = 
	`cvmx_±r_to_phys
(
obuf
);

460 
	`´štf
("%s:%d\n",
__func__
, 
__LINE__
);

469 ià(
	`cvmx_pko_£nd_·ck‘_fšish
(
pÜt
, 
queue
, 
pko_commªd
, 
·ck‘_±r
, 
CVMX_PKO_LOCK_NONE
))

471 ià(
	`cvmx_pko_£nd_·ck‘_fšish
(
pÜt
, 
queue
, 
pko_commªd
, 
·ck‘_±r
, 
CVMX_PKO_LOCK_ATOMIC_TAG
))

474 
	`´štf
("%s:%d\n",
__func__
, 
__LINE__
);

479 
	`´štf
("%s:%d\n",
__func__
, 
__LINE__
);

485 
	`´štf
("%s:%d\n",
__func__
, 
__LINE__
);

487 
	}
}

491 
	$äcÜe_c_v4_š¡r_£nd
(
c_š¡r_’Œy_t
 *
’Œy
)

493 *
p
 = 
NULL
;

495 
	`äcÜe_fÜw¬d_·ck‘_to_wœe
(
’Œy
->
wqe
, 
c_š¡r
.
š¡r_cfg
.
tx_pÜt
, 0);

498 
p
 = 
’Œy
->
wqe
->
·ck‘_±r
.
±r
 + (
c_š¡r_hd_t
);

500 
	`mem£t
(
p
, 0, 
’Œy
->
wqe
->
Ën
 - (
c_š¡r_hd_t
));

502 
’Œy
->
wqe
->
Ën
 = (
c_š¡r_hd_t
);

503 
	}
}

507 
	$äcÜe_c_cmd_š£¹
(
ušt16_t
 
iif
 , 
c_cmd_t
 *
cmd
, 
ušt8_t
 *
·ylßd
)

509 *
p
 = 
NULL
;

510 
cmd_Ën
 = 0;

511 
ušt64_t
 
ouut_Ën
 = 0;

514 
c_š¡r_’Œy_t
 *
’Œy
 = &
c_š¡r_bË
[
iif
];

517 
	`cvmx_¥šlock_lock
(&
’Œy
->
lock
);

519 ià(0 =ğ
cmd
->
dty³
)

521 
cmd_Ën
 = 16;

525 
cmd_Ën
 = (
c_cmd_t
);

531 ià(
ouut_Ën
 > 
c_š¡r
.
š¡r_cfg
.
pkt_Ën
)

533 
	`´štf
("%s:%d\n",
__func__
, 
__LINE__
);

534 
	`äcÜe_£nd_š¡r_·ck‘
(
ouut_Ën
, 
’Œy
->
outbuf
);

538 
p
 = 
’Œy
->
outbuf
 + (
c_š¡r_hd_t
);

541 
	`memıy
(
p
, 
cmd
, 
cmd_Ën
);

543 
p
 =… + 
cmd_Ën
;

544 ià(
cmd
->
_Ën
 > 0)

546 
	`´štf
("%s:%d\n",
__func__
, 
__LINE__
);

547 
	`memıy
(
p
, 
·ylßd
, 
cmd
->
_Ën
);

548 
p
 =… + 
cmd
->
_Ën
;

551 
ouut_Ën
 = 
p
 - 
’Œy
->
outbuf
;

552 
	`äcÜe_£nd_š¡r_·ck‘
(
ouut_Ën
, 
’Œy
->
outbuf
);

555 
	`cvmx_¥šlock_uÆock
(&
’Œy
->
lock
);

557  
FRE_SUCCESS
;

558 
	}
}

560 
	$äcÜe_c_v4_š¡r_§m¶e
(
c_dpkt_hd_t
 *
dpkt
, 
ušt32_t
 
s
, ušt32_ˆ
d
)

563 
c_cmd_t
 
cmd
;

564 
ušt16_t
 
iif
 = 0;

565 iàĞ((
s
 & 
c_š¡r
.
š¡r_cfg
.
s_mask
è& (c_š¡r.š¡r_cfg.
s_d©a
 & ipc_instr.instr_cfg.sip_mask)) ||

566 ((
d
 & 
c_š¡r
.
š¡r_cfg
.
d_mask
è& (c_š¡r.š¡r_cfg.
d_d©a
 & ipc_instr.instr_cfg.dip_mask)) )

568 
	`´štf
("%s:%d\n",
__func__
, 
__LINE__
);

569 ià(
c_š¡r
.
š¡r_cfg
.
ty³
 & ipc_š¡r.š¡r_cfg.
aùiÚ
)

571 
cmd
.
pktid
 = 0xffffffffffffffff;

575 
cmd
.
pktid
 = ((
ušt64_t
)
dpkt
->
f›ld
.
pid_h
è<< 32 | dpkt->f›ld.
pid_l
;

577 
cmd
.
dty³
 = 
c_š¡r
.
š¡r_cfg
.
ty³
;

578 
cmd
.
_Ën
 = 
c_š¡r
.
š¡r_cfg
.ip_len;

579 
iif
 = (
dpkt
->
f›ld
.
chassis
 << 8è| (dpkt->f›ld.
¦Ù
 << 3) |

580 (
dpkt
->
f›ld
.
ÿrd
 << 2è| dpkt->f›ld.
ifid
;

582 
	`äcÜe_c_cmd_š£¹
(
iif
, &
cmd
, 
c_š¡r
.
·ylßd
);

585  
FRCORE_ACT_FREE
;

586 
	}
}

589 
	$äcÜe_c_v4_´oûss
(
c_dpkt_hd_t
 *
dpkt
, 
ušt8_t
 *
p
)

591 
c_v4_hd_t
 
hd
;

593 
	`mem£t
(&
hd
, 0, (
c_v4_hd_t
));

595 
	`UNPACK_U32
(
p
, 
hd
.
wÜd
[0]);

596 
	`UNPACK_U32
(
p
, 
hd
.
wÜd
[1]);

597 
	`UNPACK_U32
(
p
, 
hd
.
wÜd
[2]);

598 
	`UNPACK_U32
(
p
, 
hd
.
wÜd
[3]);

599 
	`UNPACK_U32
(
p
, 
hd
.
wÜd
[4]);

602 ià(
hd
.
f›ld
.
ih
 != 5)

605 
	`FRCORE_STAT_INC
(
¡©__İtiÚ
);

606 
	`FRCORE_DROP
(
¡©_drİ__İtiÚ
);

610 ià(
c_misc
.
š¡r_£nd
)

612  
	`äcÜe_c_v4_š¡r_§m¶e
(
dpkt
, 
hd
.
f›ld
.
§ddr
, hd.f›ld.
daddr
);

616  
FRCORE_ACT_FREE
;

618 
	}
}

620 
	$äcÜe_c_v6_´oûss
(
c_dpkt_hd_t
 *
dpkt
, 
ušt8_t
 *
p
)

622 
	`FRCORE_STAT_INC
(
¡©__v6
);

623 
	`FRCORE_DROP
(
¡©_drİ__v6
);

624 
	}
}

626 
	$äcÜe_c_wÜk_´oûss
(
cvmx_wqe_t
 *
wÜk
)

628 
ušt8_t
 *
_±r
, *
‘h”_±r
;

629 
rv
;

630 
ušt64_t
 
psmac
 = 0, 
pdmac
 = 0, 
csmac
 = 0;

631 
ušt8_t
 *
p
;

632 
ušt16_t
 
´ÙocŞ
;

634 
	`kšds_of_pkt_Ën_¡©
(
wÜk
);

636 if(!
oùnic
->
pÜt
[
wÜk
->
´t
].
rx_Ú
)

638 
	`FRCORE_DROP
(
¡©_drİ_pÜt_off
);

641 ià(
wÜk
->
wÜd2
.
s
.
rcv_”rÜ
)

643 
	`FRCORE_STAT_INC
(
¡©_rx_”rs
);

644 
	`FRCORE_DROP
(
¡©_drİ_rx_”rÜ
);

647 
	`FRCORE_STAT_INC
(
¡©_rx_pkts
);

648 
	`FRCORE_STAT_ADD
(
¡©_rx_by‹s
, (
wÜk
->
Ën
 + 4));

650 ià(
wÜk
->
wÜd2
.
s
.
bufs
 == 0)

652 
_±r
 = 
wÜk
->
·ck‘_d©a
 + wÜk->
wÜd2
.
s
.
_off£t
 + 6;

653 
‘h”_±r
 = 
wÜk
->
·ck‘_d©a
;

657 
‘h”_±r
 = 
	`cvmx_phys_to_±r
(
wÜk
->
·ck‘_±r
.
s
.
addr
);

658 
_±r
 = 
	`cvmx_phys_to_±r
(
wÜk
->
·ck‘_±r
.
s
.
addr
 + wÜk->
wÜd2
.s.
_off£t
);

661 
p
 = 
‘h”_±r
;

663 ià(
c_misc
.
šv®id_dump
 & 8)

665 
	`´štf
("Start capture: \n");

666 
	`FRCORE_INFO
(" PKT DATA:\n");

667 
	`äcÜe_dump_buff
(
__func__
, 
__LINE__
, 
wÜk
->
Ën
, 
p
);

670 ià(
c_misc
.
smac_check
)

672 
	`memıy
(&
pdmac
, 
‘h”_±r
 + 0, 6);

673 
	`memıy
(&
psmac
, 
‘h”_±r
 + 6, 6);

675 
	`sw­_buff
(1, &
pdmac
);

676 
	`sw­_buff
(1, &
psmac
);

678 ià(0 =ğ
psmac
)

680 
	`FRCORE_STAT_INC
(
¡©_rx_”rs
);

681 
	`FRCORE_DROP
(
¡©_c_drİ_smac_z”o
);

684 
csmac
 = 
	`cvmx_©omic_g‘64
(&
c_cur
.
smac
);

686 ià(0 =ğ
csmac
)

688 
	`cvmx_©omic_£t64
(&
c_cur
.
smac
, 
psmac
);

689 
	`FRCORE_STAT_INC
(
¡©_c_smac_Üd”ed
);

691 ià(
psmac
 =ğ(
csmac
 + 1))

693 
	`cvmx_©omic_£t64
(&
c_cur
.
smac
, 
psmac
);

694 
	`FRCORE_STAT_INC
(
¡©_c_smac_Üd”ed
);

698 
	`FRCORE_STAT_INC
(
¡©_c_smac_disÜd”
);

703 
c_dpkt_hd_t
 
dpkt
;

704 
ušt8_t
 
v¬e
 = 0, 
iifv
 = 0;

705 
	`mem£t
(&
dpkt
, 0, (
c_dpkt_hd_t
));

707 
	`UNPACK_U16
(
p
, 
dpkt
.
f›ld
.
oui
);

708 
	`UNPACK_U32
(
p
, 
dpkt
.
f›ld
.
pid_l
);

709 
	`UNPACK_U8
(
p
, 
v¬e
);

710 
	`UNPACK_U16
(
p
, 
dpkt
.
f›ld
.
Üi_vid
);

711 
	`UNPACK_U16
(
p
, 
dpkt
.
f›ld
.
pid_h
);

712 
	`UNPACK_U8
(
p
, 
iifv
);

714 
dpkt
.
f›ld
.
chassis
 = (
v¬e
 & 0xf0) >> 4;

715 
dpkt
.
f›ld
.
¦Ù
 = (
iifv
 & 0xf8) >> 3;

716 
dpkt
.
f›ld
.
ÿrd
 = (
iifv
 & 0x4) >> 2;

717 
dpkt
.
f›ld
.
ifid
 = 
iifv
 & 0x3;

726 ià(
c_misc
.
exp_check
)

728 
dpkt_v®id
 = 0;

729 ià((
c_exp_d©a
.
f›ld
.
oui
 & 
c_exp_mask
.field.oui) !=

730 (
dpkt
.
f›ld
.
oui
 & 
c_exp_mask
.field.oui) )

732 
	`FRCORE_STAT_INC
(
¡©_c_h—d_šv®id
);

734 ià((
c_exp_d©a
.
f›ld
.
chassis
 & 
c_exp_mask
.field.chassis) !=

735 (
dpkt
.
f›ld
.
chassis
 & 
c_exp_mask
.field.chassis) )

737 
	`FRCORE_STAT_INC
(
¡©_c_h—d_šv®id
);

739 ià((
c_exp_d©a
.
f›ld
.
pid_h
 & 
c_exp_mask
.field.pid_h) !=

740 (
dpkt
.
f›ld
.
pid_h
 & 
c_exp_mask
.field.pid_h) )

742 
	`FRCORE_STAT_INC
(
¡©_c_h—d_šv®id
);

744 ià((
c_exp_d©a
.
f›ld
.
pid_l
 & 
c_exp_mask
.field.pid_l) !=

745 (
dpkt
.
f›ld
.
pid_l
 & 
c_exp_mask
.field.pid_l) )

747 
	`FRCORE_STAT_INC
(
¡©_c_h—d_šv®id
);

749 ià((
c_exp_d©a
.
f›ld
.
¦Ù
 & 
c_exp_mask
.field.slot) !=

750 (
dpkt
.
f›ld
.
¦Ù
 & 
c_exp_mask
.field.slot) )

752 
	`FRCORE_STAT_INC
(
¡©_c_h—d_šv®id
);

754 ià((
c_exp_d©a
.
f›ld
.
ÿrd
 & 
c_exp_mask
.field.card) !=

755 (
dpkt
.
f›ld
.
ÿrd
 & 
c_exp_mask
.field.card) )

757 
	`FRCORE_STAT_INC
(
¡©_c_h—d_šv®id
);

759 ià((
c_exp_d©a
.
f›ld
.
ifid
 & 
c_exp_mask
.field.ifid) !=

760 (
dpkt
.
f›ld
.
ifid
 & 
c_exp_mask
.field.ifid) )

762 
	`FRCORE_STAT_INC
(
¡©_c_h—d_šv®id
);

764 ià((
c_exp_d©a
.
f›ld
.
Üi_vid
 & 
c_exp_mask
.field.ori_vid) !=

765 (
dpkt
.
f›ld
.
Üi_vid
 & 
c_exp_mask
.field.ori_vid))

767 
	`FRCORE_STAT_INC
(
¡©_c_h—d_šv®id
);

771 
	`FRCORE_STAT_INC
(
¡©_c_h—d_v®id
);

772 
dpkt_v®id
 = 1;

775 ià(0 =ğ
dpkt_v®id
)

777 ià(
c_misc
.
šv®id_dump
 & 1)

779 
	`FRCORE_INFO
(" PKT DPKT:\n");

780 
	`äcÜe_c_dpkt_dump
(&
dpkt
);

783 ià(
c_misc
.
šv®id_dump
 & 2)

785 
	`FRCORE_INFO
(" EXP DATA:\n");

786 
	`äcÜe_c_dpkt_dump
(&
c_exp_d©a
);

788 
	`FRCORE_INFO
(" EXP MASK:\n");

789 
	`äcÜe_c_dpkt_dump
(&
c_exp_mask
);

792 ià(
c_misc
.
šv®id_dump
 & 4)

794 
	`FRCORE_INFO
(" PKT DATA:\n");

795 
	`äcÜe_dump_±rs
(&
wÜk
->
·ck‘_±r
, wÜk->
Ën
);

802 ià(
c_misc
.
pktid_check
)

804 
ušt64_t
 
µid
 = 0, 
ıid
 = 0;

805 
µid
 = (((
ušt64_t
è
dpkt
.
f›ld
.
pid_h
 << 32è| dpkt.f›ld.
pid_l
);

807 
ıid
 = 
	`cvmx_©omic_g‘64
(&
c_cur
.
pktid
);

810 ià(0 =ğ
ıid
)

812 ià(
µid
 =ğ
ıid
)

814 
	`FRCORE_STAT_INC
(
¡©_c_pktid_»³©
);

818 
	`FRCORE_STAT_INC
(
¡©_c_pktid_Üd”ed
);

819 
	`cvmx_©omic_£t64
(&
c_cur
.
pktid
, 
µid
);

822 ià(
µid
 =ğ
ıid
)

824 
	`FRCORE_STAT_INC
(
¡©_c_pktid_»³©
);

826 ià(
µid
 > 
ıid
)

828 
	`cvmx_©omic_£t64
(&
c_cur
.
pktid
, 
µid
);

829 
	`FRCORE_STAT_INC
(
¡©_c_pktid_Üd”ed
);

833 
	`FRCORE_STAT_INC
(
¡©_c_pktid_disÜd”
);

837 
ušt16_t
 
ovid
, 
ivid
;

838 
vÏn_di¡
 = 0;

840 
p
 = 
‘h”_±r
 + 12;

841 
	`UNPACK_U16
(
p
, 
´ÙocŞ
);

844 
	`´štf
("%s.%d:…rØğ0x%x\n", 
´ÙocŞ
);

845 ià(
PROTO_VLAN
 =ğ
´ÙocŞ
)

847 
vÏn_di¡
 = 1;

848 
	`FRCORE_STAT_INC
(
¡©_vÏn
);

849 
	`UNPACK_U16
(
p
, 
ovid
);

850 
	`UNPACK_U16
(
p
, 
´ÙocŞ
);

852 ià(
PROTO_VLAN
 =ğ
´ÙocŞ
)

854 
	`UNPACK_U16
(
p
, 
ivid
);

855 
	`UNPACK_U16
(
p
, 
´ÙocŞ
);

861 
	`´štf
("vÏn_di¡ = %d,…rÙocŞ = %d\n", 
vÏn_di¡
, 
´ÙocŞ
);

862 
´ÙocŞ
)

864 
PROTO_IPV4
:

865 ià(
vÏn_di¡
)

867 
rv
 = 
	`äcÜe_vÏn_check_v4
(
wÜk
, 
‘h”_±r
, 
_±r
, 
psmac
, 
pdmac
);

869 
rv
 = 
	`äcÜe_c_v4_´oûss
(&
dpkt
, 
p
);

871 
PROTO_IPV6
:

872 ià(
vÏn_di¡
)

874 
rv
 = 
	`äcÜe_vÏn_check_v6
(
wÜk
, 
‘h”_±r
, 
_±r
, 
psmac
, 
pdmac
);

876 
rv
 = 
	`äcÜe_c_v6_´oûss
(&
dpkt
, 
p
);

879 
rv
 = 
FRCORE_ACT_FREE
;

883 
	`FRCORE_PKT
("smaø0x%Îx, dmaø0x%Îx\n", (
ULL
)
smac
, (ULL)
dmac
);

885  
rv
;

886 
	}
}

889 
	$äcÜe_c_š™
()

891 
	`´štf
("%s:%d\n",
__func__
, 
__LINE__
);

892 
	`äcÜe_c_š¡r_bË_š™
();

893 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_IPC_CUR_SET
, 
äcÜe_cmd_c_cur_£t
);

894 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_IPC_CUR_GET
, 
äcÜe_cmd_c_cur_g‘
);

896 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_IPC_MISC_SET
, 
äcÜe_cmd_c_misc_£t
);

897 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_IPC_MISC_GET
, 
äcÜe_cmd_c_misc_g‘
);

899 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_IPC_EXP_SET
, 
äcÜe_cmd_c_exp_£t
);

900 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_IPC_EXP_GET
, 
äcÜe_cmd_c_exp_g‘
);

902 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_IPC_INSTR_SET
, 
äcÜe_cmd_c_š¡r_£t
);

903 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_IPC_INSTR_PAYLOAD_SET
, 
äcÜe_cmd_c_š¡r_·ylßd_£t
);

904 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_IPC_INSTR_GET
, 
äcÜe_cmd_c_š¡r_g‘
);

906  
FRE_SUCCESS
;

907 
	}
}

	@frcore/frcore_ipc.h

1 #iâdeà
__FRCORE_IPC_H__


2 
	#__FRCORE_IPC_H__


	)

4 
	~"äcÜe_pkt.h
"

5 
	~"äcÜe_¡©.h
"

6 
	~"äc_dma.h
"

7 
	~"äcÜe_´Ùo.h
"

8 
	~"äcÜe_s¢.h
"

9 
	~"äcÜe_s¢_´iv.h
"

10 
	~"äcÜe.h
"

11 
	~"äcÜe_cmd.h
"

12 
	~"äcÜe_misc.h
"

13 
	~"äc_·ck.h
"

14 
	~"äcÜe_´Ùo.h
"

15 
	~"äcÜe_š™.h
"

16 
	~"äc_ty³s.h
"

17 
	~"äcÜe_¡©.h
"

18 
	~"äcÜe_®g.h
"

23 
ušt32_t
 
	moui
 : 24;

24 
ušt32_t
 
	m»sv0
 : 8;

25 
ušt16_t
 
	m»sv1
 : 5;

26 
ušt16_t
 
	miif
 : 11;

27 
ušt8_t
 
	msmac
[6];

28 
ušt16_t
 
	m´ÙocŞ
;

29 
ušt16_t
 
	mcmd_numb”
;

30 } 
	tc_š¡r_hd_t
;

35 
ušt16_t
 
	moui
;

36 
ušt32_t
 
	mpid_l
;

37 
ušt8_t
 
	mchassis
 : 4;

38 
ušt8_t
 
	m»sv
 : 4;

39 
ušt16_t
 
	mÜi_vid
;

40 
ušt16_t
 
	mpid_h
;

41 
ušt8_t
 
	m¦Ù
 : 5;

42 
ušt8_t
 
	mÿrd
 : 1;

43 
ušt8_t
 
	mifid
 : 2;

44 } 
	mf›ld
;

45 
ušt32_t
 
	mwÜd
[3];

46 } 
	tc_dpkt_hd_t
;

52 
cvmx_¥šlock_t
 
	mlock
;

53 *
	moutbuf
;

55 } 
	tc_š¡r_’Œy_t
;

61 
ušt64_t
 
	mpktid
;

62 
ušt16_t
 
	mdty³
 : 4;

63 
ušt16_t
 
	m_Ën
 : 12;

64 } 
	tc_cmd_t
;

69 
ušt32_t
 
	mv”siÚ
 : 4;

70 
ušt32_t
 
	mih
 : 4;

71 
ušt32_t
 
	mtos
 : 8;

72 
ušt32_t
 
	mtÙ_Ën
 : 16;

73 
ušt32_t
 
	mid
 : 16;

74 
ušt32_t
 
	mræag
 : 1;

75 
ušt32_t
 
	mdæag
 : 1;

76 
ušt32_t
 
	mmæag
 : 1;

77 
ušt32_t
 
	mäag_off£t
 : 13;

79 
ušt32_t
 
	m‰l
 : 8;

80 
ušt32_t
 
	m´ÙocŞ
 : 8;

81 
ušt32_t
 
	mcheck
 : 16;

82 
ušt32_t
 
	m§ddr
;

83 
ušt32_t
 
	mdaddr
;

84 } 
	mf›ld
;

85 
ušt32_t
 
	mwÜd
[5];

86 } 
	tc_v4_hd_t
;

88 
äcÜe_c_š™
();

	@frcore/frcore_mac_statistics.c

1 
	~"äcÜe_mac_¡©i¡ics.h
"

2 
	~"äcÜe_´Ùo.h
"

3 
	~<¡ršg.h
>

4 #ià
FRC_CONFIG_MAC_STATISTICS


6 
	#MAX_MAC_NUM
 512

	)

7 
CVMX_SHARED
 
ušt16_t
 
	gmac_num
 = 0;

8 
CVMX_SHARED
 
ušt16_t
 
	ghash_mode
 = 
HASH_SIP
;

9 
CVMX_SHARED
 
ušt16_t
 
	gh—¹_b—t
 = 
HEART_BEAT_ON
;

10 
CVMX_SHARED
 
äc_mac_¡©
 
	gglob®_mac_¡©
[
MAX_MAC_NUM
];

11 
CVMX_SHARED
 
št64_t
 
	g_tos
 = -1;

12 
CVMX_SHARED
 
št64_t
 
	g_‰l
 = -1;

14 
ušt16_t
 
	$äcÜe_mac_¡©i¡ics_hash
(
ušt32_t
 
s
, ušt32_ˆ
d
, 
ušt16_t
 
¥
, ušt16_ˆ
dp
, 
ušt8_t
 
´Ùo
)

16 
ušt16_t
 
hash
 = 
MAX_MAC_NUM
 + 1;

17 ià(
mac_num
 == 0)

19  
hash
;

21 
hash_mode
)

23 
HASH_SIP
:

24 
hash
 = ((
ušt16_t
)((
s
 >> 16è+ (s & 0xffff))è% 
mac_num
;

26 
HASH_DIP
:

27 
hash
 = ((
ušt16_t
)((
d
 >> 16è+ (d & 0xffff))è% 
mac_num
;

29 
HASH_SIP_DIP
:

30 
hash
 = ((((
ušt16_t
)((
s
 >> 16è+ (s & 0xffff)))è+ (((ušt16_t)((
d
 >> 16è+ (d & 0xffff))))è% 
mac_num
;

32 
HASH_FIVE_TUPLE
:

33 
hash
 = ((((
ušt16_t
)((
s
 >> 16è+ (s & 0xffff)))è+ (((ušt16_t)((
d
 >> 16è+ (d & 0xffff)))è+ 
¥
 + 
dp
 + 
´Ùo
è% 
mac_num
;

38  
hash
;

39 
	}
}

41 
	$äcÜe_mac_¡©i¡ics_add_mac
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

43 
äc_mac_¡©_š_t
 *
šput
 = (äc_mac_¡©_š_ˆ*è
·¿m
;

44 
ušt64_t
 
mac
 = 0;

45 
mac
 = 
šput
->mac;

46 ià(
mac
 == 0)

48  
FRE_FAIL
;

50 *
Ş’
 = 0;

51 ià(
mac_num
 =ğ
MAX_MAC_NUM
)

53  
FRE_NOSPACE
;

55 
glob®_mac_¡©
[
mac_num
].
mac
 = mac;

56 
glob®_mac_¡©
[
mac_num
].
tÙ®
 = 0;

57 
glob®_mac_¡©
[
mac_num
].
”rÜs
 = 0;

58 
mac_num
++;

59  
FRE_SUCCESS
;

60 
	}
}

62 
	$äcÜe_mac_¡©i¡ics_d–_mac
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

64 
äc_mac_¡©_š_t
 *
šput
 = (äc_mac_¡©_š_ˆ*è
·¿m
;

65 
ušt64_t
 
mac
 = 0;

66 
mac
 = 
šput
->mac;

67 *
Ş’
 = 0;

68 
ušt16_t
 
i
;

70 ià(
mac
 == 0)

72  
FRE_FAIL
;

75 
i
 = 0; i < 
mac_num
; i++)

77 ià(
glob®_mac_¡©
[
i
].
mac
 == mac)

79 
glob®_mac_¡©
[
i
].
mac
 == 0;

80 
glob®_mac_¡©
[
i
].
tÙ®
 = 0;

81 
glob®_mac_¡©
[
i
].
”rÜs
 = 0;

82 
mac_num
--;

84 ; 
i
 < 
mac_num
; i++)

86 
glob®_mac_¡©
[
i
].
mac
 = global_mac_stat[i+1].mac;

87 
glob®_mac_¡©
[
i
].
tÙ®
 = global_mac_stat[i+1].total;

88 
glob®_mac_¡©
[
i
].
”rÜs
 = global_mac_stat[i+1].errors;

90  
FRE_SUCCESS
;

94  
FRE_NOTFOUND
;

97  
FRE_FAIL
;

98 
	}
}

100 
	$äcÜe_mac_¡©i¡ics_d–_®l
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

102 
ušt16_t
 
i
;

103 
i
 = 0; i < 
mac_num
; i++)

105 
	`mem£t
(&(
glob®_mac_¡©
[
i
]), 0, (
äc_mac_¡©
));

107 
mac_num
 = 0;

108  
FRE_SUCCESS
;

109 
	}
}

111 
	$äcÜe_mac_¡©i¡ics_ş—r_couÁ”
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

113 
äc_mac_¡©_š_t
 *
šput
 = (äc_mac_¡©_š_ˆ*è
·¿m
;

114 
ušt64_t
 
mac
 = 0;

115 
mac
 = 
šput
->mac;

116 
ušt16_t
 
i
;

117 
i
 = 0; i < 
mac_num
; i++)

119 ià(
glob®_mac_¡©
[
i
].
mac
 == mac)

121 
glob®_mac_¡©
[
i
].
tÙ®
 = 0;

122 
glob®_mac_¡©
[
i
].
”rÜs
 = 0;

123  
FRE_SUCCESS
;

126  
FRE_NOTFOUND
;

127 
	}
}

129 
	$äcÜe_mac_¡©i¡ics_ş—r_®l_couÁ”
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

131 
ušt16_t
 
i
;

133 
i
 = 0; i < 
mac_num
; i++)

135 
glob®_mac_¡©
[
i
].
tÙ®
 = 0;

136 
glob®_mac_¡©
[
i
].
”rÜs
 = 0;

138  
FRE_SUCCESS
;

139 
	}
}

141 
	$äcÜe_mac_¡©i¡ics_show_by_mac
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

143 
äc_mac_¡©_š_t
 *
šput
 = (äc_mac_¡©_š_ˆ*è
·¿m
;

144 
ušt64_t
 
mac
 = 0;

145 
mac
 = 
šput
->mac;

146 *
Ş’
 = (
äc_mac_¡©_out_t
);

147 
äc_mac_¡©_out_t
 *
ouut
 = 
outbuf
;

149 ià(
mac
 == 0)

151  
FRE_PARAM
;

153 
ušt16_t
 
i
;

154 
i
 = 0; i < 
mac_num
; i++)

156 ià(
glob®_mac_¡©
[
i
].
mac
 == mac)

158 
ouut
->
mac
 = mac;

159 
ouut
->
tÙ®
 = 
glob®_mac_¡©
[
i
].total;

160 
ouut
->
”rÜs
 = 
glob®_mac_¡©
[
i
].errors;

161  
FRE_SUCCESS
;

164  
FRE_NOTFOUND
;

165 
	}
}

167 
	$äcÜe_mac_¡©i¡ics_show_by_šdex
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

169 
äc_mac_¡©_š_t
 *
šput
 = (äc_mac_¡©_š_ˆ*)
·¿m
;

170 
ušt64_t
 
šdex
 = 
šput
->
mac
;

171 
äc_mac_¡©_out_t
 *
out
 = 
outbuf
;

172 *
Ş’
 = (
äc_mac_¡©_out_t
);

174 ià(
šdex
 >ğ
mac_num
)

176  
FRE_FAIL
;

179 
out
->
mac
 = 
glob®_mac_¡©
[
šdex
].mac;

180 
out
->
tÙ®
 = 
glob®_mac_¡©
[
šdex
].total;

181 
out
->
”rÜs
 = 
glob®_mac_¡©
[
šdex
].errors;

182  
FRE_SUCCESS
;

183 
	}
}

185 
	$äcÜe_mac_¡©i¡ics_£t_hash_mode
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

187 
äc_mac_¡©_š_t
 *
šput
 = (äc_mac_¡©_š_ˆ*)
·¿m
;

188 
hash_mode
 = 
šput
->
mac
;

189  
FRE_SUCCESS
;

190 
	}
}

191 
	$äcÜe_mac_¡©i¡ics_£t_h—¹_b—t
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

193 
äc_mac_¡©_š_t
 *
šput
 = (äc_mac_¡©_š_ˆ*)
·¿m
;

194 
h—¹_b—t
 = (
ušt16_t
)(
šput
->
mac
);

195  
FRE_SUCCESS
;

196 
	}
}

198 
	$äcÜe_mac_¡©i¡ics_£t_
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

200 
äc_mac_¡©_š_t
 *
šput
 = (äc_mac_¡©_š_ˆ*)
·¿m
;

201 
ušt64_t
 
ty³
 = 
šput
->
mac
;

203 ià(
ty³
 =ğ
IP_TOS
)

205 
_tos
 = (
št64_t
)(
šput
->
couÁ”
);

207 ià(
ty³
 =ğ
IP_TTL
)

209 
_‰l
 = (
št64_t
)(
šput
->
couÁ”
);

213  
FRE_FAIL
;

215  
FRE_SUCCESS
;

216 
	}
}

218 
šlše
 
ušt16_t
 
	$check_sum
(
ušt8_t
 *
addr
, 
ušt16_t
 
couÁ
)

220 
ušt32_t
 
sum
 = 0;

222 
couÁ
 > 1)

224 
sum
 +ğ*(
ušt16_t
 *)
addr
++;

225 
couÁ
 -= 2;

228 ià(
couÁ
 > 0)

230 
sum
 +ğ*(
ušt16_t
 *è
addr
;

233 
sum
 = (sum & 0xffff) + (sum >> 16);

234 
sum
 += (sum >> 16);

235  ~
sum
;

236 
	}
}

238 
šlše
 
	$äcÜe_mac_¡©i¡ics_£t__pkt
(
hdr
 *
_h—d”
)

240 ià(
_tos
 >= 0)

242 
_h—d”
->
tos
 = 
_tos
;

244 ià(
_‰l
 >=0)

246 
_h—d”
->
‰l
 = 
_‰l
;

248 
_h—d”
->
check
 = 0;

249 
_h—d”
->
check
 = 
	`check_sum
((
ušt8_t
 *)_h—d”, ip_h—d”->
tÙ_Ën
);

250 
	}
}

252 
	$pkt_dump
(
ušt8_t
 *
‘h”
, 
Ëngth
)

254 
	`´štf
("Pack‘†’gth: %d\n", 
Ëngth
);

256 
i
;

257 
i
 = 0; i < 
Ëngth
; i++)

259 
	`´štf
(" %02x", 
‘h”
[
i
]);

260 ifĞ(
i
 + 1) % 16 == 0 )

262 
	`´štf
("\n");

265 
	`´štf
("\n\n");

266 
	}
}

268 
	$äcÜe_mac_¡©i¡ics_couÁ”_šc
(
ušt8_t
 *
‘h”
)

270 
ušt64_t
 
mac
 = (*(ušt64_ˆ*)(
‘h”
)) >> 16;

272 
‘hhdr
 *
‘h”_±r
 = (‘hhd¸*)(
‘h”
 + 16);

276 ià(
‘h”_±r
->
h_´Ùo
 !ğ
ETH_P_IP
)

278  
FRE_FAIL
;

282 
hdr
 *
_±r
 = (hd¸*)((
ušt8_t
 *)
‘h”_±r
 + (
‘hhdr
));

283 
	`äcÜe_mac_¡©i¡ics_£t__pkt
(
_±r
);

285 ià(
_±r
->
v”siÚ
 != 0x4)

287  
FRE_FAIL
;

289 
ušt32_t
 
s
 = 
_±r
->
§ddr
;

290 
ušt32_t
 
d
 = 
_±r
->
daddr
;

291 
ušt8_t
 
´Ùo
 = 
_±r
->
´ÙocŞ
;

292 
ušt16_t
 
¥
;

293 
ušt16_t
 
dp
;

294 ià(
´Ùo
 =ğ
IP_P_TCP
)

297 
tıhdr
 *
tı_±r
 = (tıhd¸*)((
ušt8_t
 *)
_±r
 + (_±r->
ihl
) * 4);

298 
¥
 = 
tı_±r
->
sourû
;

299 
dp
 = 
tı_±r
->
de¡
;

301 ià(
´Ùo
 =ğ
IP_P_UDP
)

304 
udphdr
 *
udp_±r
 = (
tıhdr
 *)((
ušt8_t
 *)
_±r
 + (_±r->
ihl
) * 4);

305 
¥
 = 
udp_±r
->
sourû
;

306 
dp
 = 
udp_±r
->
de¡
;

310  
FRE_FAIL
;

313 
ušt16_t
 
hash
 = 
	`äcÜe_mac_¡©i¡ics_hash
(
s
, 
d
, 
¥
, 
dp
, 
´Ùo
);

316 ià(
hash
 =ğ(
MAX_MAC_NUM
 + 1))

318  
FRE_FAIL
;

320 ià(
glob®_mac_¡©
[
hash
].
mac
 == 0)

322  
FRE_FAIL
;

324 ià(
glob®_mac_¡©
[
hash
].
mac
 == mac)

326 
	`cvmx_©omic_ãtch_ªd_add64
(&(
glob®_mac_¡©
[
hash
].
tÙ®
), 1);

330 
	`cvmx_©omic_ãtch_ªd_add64
(&(
glob®_mac_¡©
[
hash
].
tÙ®
), 1);

331 
	`cvmx_©omic_ãtch_ªd_add64
(&(
glob®_mac_¡©
[
hash
].
”rÜs
), 1);

333  
FRE_SUCCESS
;

334 
	}
}

336 
	$äcÜe_mac_¡©i¡ics_š™
()

338 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_MAC_STAT_ADD_MAC
, 
äcÜe_mac_¡©i¡ics_add_mac
);

339 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_MAC_STAT_DEL_MAC
, 
äcÜe_mac_¡©i¡ics_d–_mac
);

340 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_MAC_STAT_DEL_ALL
, 
äcÜe_mac_¡©i¡ics_d–_®l
);

341 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_MAC_STAT_CLEAR_COUNTER
, 
äcÜe_mac_¡©i¡ics_ş—r_couÁ”
);

342 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_MAC_STAT_CLEAR_ALL_COUNTER
, 
äcÜe_mac_¡©i¡ics_ş—r_®l_couÁ”
);

343 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_MAC_STAT_SHOW_COUNTER
, 
äcÜe_mac_¡©i¡ics_show_by_mac
);

344 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_MAC_STAT_SHOW_ALL_COUNTER
, 
äcÜe_mac_¡©i¡ics_show_by_šdex
);

345 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_MAC_STAT_SET_HASH_MODE
, 
äcÜe_mac_¡©i¡ics_£t_hash_mode
);

346 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_MAC_STAT_HEART_BEAT
, 
äcÜe_mac_¡©i¡ics_£t_h—¹_b—t
);

347 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_MAC_STAT_SET_IP
, 
äcÜe_mac_¡©i¡ics_£t_
);

348 
	}
}

	@frcore/frcore_mac_statistics.h

1 #iâdeà
_FRC_MAC_STATISTICS_H_


2 
	#_FRC_MAC_STATISTICS_H_


	)

3 
	~"äcÜe_pkt.h
"

4 
	~"äcÜe_¡©.h
"

5 
	~"äc_dma.h
"

6 
	~"äcÜe_´Ùo.h
"

7 
	~"äcÜe_s¢.h
"

8 
	~"äcÜe_s¢_´iv.h
"

9 
	~"äcÜe.h
"

10 
	~"äcÜe_cmd.h
"

11 
	~"äcÜe_misc.h
"

12 
	~"äc_·ck.h
"

13 
	~"äcÜe_´Ùo.h
"

14 
	~"äcÜe_š™.h
"

15 
	~"äc_ty³s.h
"

16 
	~"äcÜe_¡©.h
"

17 
	~"äcÜe_®g.h
"

19 #ià
FRC_CONFIG_MAC_STATISTICS


21 
	#HASH_SIP
 0

	)

22 
	#HASH_DIP
 1

	)

23 
	#HASH_SIP_DIP
 2

	)

24 
	#HASH_FIVE_TUPLE
 3

	)

26 
	#HEART_BEAT_OFF
 0

	)

27 
	#HEART_BEAT_ON
 1

	)

28 
	#HEART_BEAT_ON_WITH_DROP
 2

	)

30 
	#IP_TOS
 1

	)

31 
	#IP_TTL
 2

	)

33 
CVMX_SHARED
 
ušt16_t
 
h—¹_b—t
;

34 
	säc_mac_¡©
 {

35 
ušt64_t
 
	mmac
;

36 
ušt64_t
 
	mtÙ®
;

37 
ušt64_t
 
	m”rÜs
;

40 
äcÜe_mac_¡©i¡ics_add_mac
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
);

41 
äcÜe_mac_¡©i¡ics_d–_mac
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
);

42 
äcÜe_mac_¡©i¡ics_d–_®l
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
);

43 
äcÜe_mac_¡©i¡ics_ş—r_couÁ”
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
);

44 
äcÜe_mac_¡©i¡ics_ş—r_®l_couÁ”
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
);

45 
äcÜe_mac_¡©i¡ics_show_by_mac
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
);

46 
äcÜe_mac_¡©i¡ics_show_by_šdex
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
);

48 
äcÜe_mac_¡©i¡ics_£t_h—¹_b—t
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
);

49 
äcÜe_mac_¡©i¡ics_£t_hash_mode
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
);

50 
äcÜe_mac_¡©i¡ics_couÁ_šc
(
ušt8_t
 *
‘h”_±r
);

52 
pkt_dump
(
ušt8_t
 *
‘h”
, 
Ëngth
);

53 
äcÜe_mac_¡©i¡ics_š™
();

	@frcore/frcore_main.c

25 
	~"äcÜe.h
"

26 
	~"äcÜe_cmd.h
"

27 
	~"äcÜe_c.h
"

28 
	~"äcÜe_misc.h
"

29 
	~"äcÜe_phy.h
"

30 
	~"äcÜe_dma.h
"

31 
	~"äcÜe_chª.h
"

32 
	~"äcÜe_pkt.h
"

33 
	~"äcÜe_¡©.h
"

34 
	~"äcÜe_ä.h
"

35 
	~"äcÜe_bmm.h
"

36 
	~"äcÜe_ruË.h
"

37 
	~"äcÜe_š™.h
"

47 #ifdeà
ENABLE_NIC_PEER_TO_PEER


48 
	~"ú56xx_•_comm.h
"

52 
ušt32_t
 
cÜe_id
;

54 
CVMX_SHARED
 
ušt32_t
 
	gwqe_couÁ
[
MAX_CORES
] = {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0};

56 
CVMX_SHARED
 
oùnic_dev_t
 *
	goùnic
;

58 
CVMX_SHARED
 
ušt64_t
 
ıu_äeq
;

59 
CVMX_SHARED
 
ušt8_t
 
wÜk_mode_où0
;

60 
CVMX_SHARED
 
ušt8_t
 
wÜk_mode_où1
;

61 #ifdeà
__lšux__


62 (*
´ev_sig_hªdËr
)();

70 
	$cvmcs_´št_compe_İtiÚs
()

72 
	`´štf
("Application compiled with: ");

73 #ifdeà 
CVMCS_DUTY_CYCLE


74 
	`´štf
("[ DUTY CYCLE ] ");

76 #ifdeà
ENABLE_NIC_PEER_TO_PEER


77 
	`´štf
("[ PEER TO PEER ] ");

79 
	}
}

81 
šlše
 

82 
	$äcÜe_´št_¡©s
()

84 
i
;

85 
où_lšk_¡©s_t
 *
¡
;

86 
ušt64_t
 
·ck‘_num
;

87 
ušt64_t
 
by‹s_num
;

88 
ušt64_t
 
ass
;

90 
	`´štf
("-- RGMII driver stats --\n");

91 
	`´štf
(" (Rx…kts from wire; Tx…kts from host)\n");

92 
i
 = 0; i < 
MAX_OCTEON_ETH_PORTS
; i++) {

93 if(!
	`äcÜe_pÜt_aùive
(
i
))

96 
	`´štf
("PÜt%d: ", 
i
);

97 
¡
 = &
oùnic
->
pÜt
[
i
].
¡©s
;

98 
·ck‘_num
 = 
¡
->
äomwœe
.
tÙ®_rcvd
 - st->äomwœe.
Ï¡_tÙ®_rcvd
;

99 
by‹s_num
 = 
¡
->
äomwœe
.
tÙ®_by‹s
 - st->äomwœe.
Ï¡_tÙ®_by‹s
;

100 if(
·ck‘_num
) {

101 
ass
 = 
by‹s_num
 / 
·ck‘_num
;

103 
ass
 = 0;

106 
	`´štf
(" Rx : %Îu ", 
	`ÿ¡64
(
¡
->
äomwœe
.
tÙ®_rcvd
));

107 
	`´štf
("(bp %Îuè", 
	`ÿ¡64
((
by‹s_num
 * 8)) );

108 
	`´štf
("Õp %Îuè", 
	`ÿ¡64
(
·ck‘_num
) );

109 
	`´štf
("×s %Îuè", 
	`ÿ¡64
(
ass
));

110 if(
¡
->
äomwœe
.
”r_pko
)

111 
	`´štf
("(%Îu PKO E¼è", 
	`ÿ¡64
(
¡
->
äomwœe
.
”r_pko
));

112 if(
¡
->
äomwœe
.
”r_lšk
)

113 
	`´štf
("(%Îu Lšk E¼è", 
	`ÿ¡64
(
¡
->
äomwœe
.
”r_lšk
));

114 if(
¡
->
äomwœe
.
”r_drİ
)

115 
	`´štf
("(%Îu Drİsè", 
	`ÿ¡64
(
¡
->
äomwœe
.
”r_drİ
));

117 
·ck‘_num
 = 
¡
->
äomho¡
.
tÙ®_rcvd
 - st->äomho¡.
Ï¡_tÙ®_rcvd
;

118 
by‹s_num
 = 
¡
->
äomho¡
.
tÙ®_by‹s
 - st->äomho¡.
Ï¡_tÙ®_by‹s
;

119 if(
·ck‘_num
) {

120 
ass
 = 
by‹s_num
 / 
·ck‘_num
;

122 
ass
 = 0;

124 
	`´štf
(" Tx : %Îu ", 
	`ÿ¡64
(
¡
->
äomho¡
.
tÙ®_rcvd
));

125 
	`´štf
("(bp %Îuè", 
	`ÿ¡64
((
by‹s_num
 * 8)));

126 
	`´štf
("Õp %Îuè", 
	`ÿ¡64
(
·ck‘_num
));

127 
	`´štf
("×s %Îuè", 
	`ÿ¡64
(
ass
));

128 if(
¡
->
äomho¡
.
”r_pko
)

129 
	`´štf
("(%Îu PKO E¼è", 
	`ÿ¡64
(
¡
->
äomho¡
.
”r_pko
));

130 if(
¡
->
äomho¡
.
”r_lšk
)

131 
	`´štf
("(%Îu Lšk E¼è", 
	`ÿ¡64
(
¡
->
äomho¡
.
”r_lšk
));

132 if(
¡
->
äomho¡
.
”r_drİ
)

133 
	`´štf
("(%Îu Drİsè", 
	`ÿ¡64
(
¡
->
äomho¡
.
”r_drİ
));

134 
	`´štf
("\n");

136 
	}
}

144 
	$äcÜe_£tup_memÜy
()

165 if(
	`cvmx_h–³r_š™Ÿlize_åa
(
FPA_PACKET_POOL_COUNT
, 
FPA_WQE_POOL_COUNT
,

166 
FPA_OQ_POOL_COUNT
, 
FPA_TIMER_POOL_COUNT
, 0)) {

169 
	`´štf
("FPA_PACKET_POOL_COUNT=0x%x\n", 
FPA_PACKET_POOL_COUNT
);

170 
	`cvm_commÚ_åa_di¥Ïy_®l_poŞ_šfo
();

172 
	}
}

181 
	$äcÜe_š™_glob®
()

183 if(
	`äcÜe_£tup_memÜy
())

186 if(
	`cvmcs_­p_š™_glob®
())

189 
	`cvmx_h–³r_d_ªd_·ck‘_šput_’abË
();

192 
	`cvmx_d_di§bË
();

194  
	`äcÜe_£tup_š‹rçûs
();

196 
	}
}

204 
	$äcÜe_š™_loÿl
()

206 if(
	`cvmcs_­p_š™_loÿl
())

209 
CVMX_SYNCW
;

211 
	}
}

217 #ifdeà
ENABLE_NIC_PEER_TO_PEER


219 
	$äcÜe_fÜw¬d_pkt_to_•
(
cvmx_wqe_t
 *
wqe
)

221 
ú56xx_•_·ck‘_t
 
pkt
;

222 
»tv®
;

224 
	`cvmx_©omic_add64
(&
oùnic
->
pÜt
[
wqe
->
´t
].
¡©s
.
äomwœe
.
tÙ®_rcvd
, 1);

225 
	`cvmx_©omic_add64
(&
oùnic
->
pÜt
[
wqe
->
´t
].
¡©s
.
äomwœe
.
tÙ®_by‹s
, wqe->
Ën
);

227 
	`mem£t
(&
pkt
, 0, (
ú56xx_•_·ck‘_t
));

229 
pkt
.
bufcouÁ
 = 1;

231 
pkt
.
buf
[0].
s
.
addr
 = 
wqe
->
·ck‘_±r
.s.addr;

232 
pkt
.
buf
[0].
s
.
size
 = 
wqe
->
Ën
;

233 
pkt
.
buf
[0].
s
.
poŞ
 = 
CVMX_FPA_PACKET_POOL
;

234 
pkt
.
buf
[0].
s
.
i
 = 1;

236 
pkt
.
g
 = 0x11001100;

237 
pkt
.
gty³
 = 
CVMX_POW_TAG_TYPE_ORDERED
;

238 
pkt
.
·¿m
 = 
wqe
->
´t
;

239 
pkt
.
İcode
 = 
EP_TO_EP_OP
;

241 
	`DBG
("S’dšge¡…ack‘ w™h opcode: %x…¬am: %x\n", 
pkt
.
İcode
,…kt.
·¿m
);

244 
»tv®
 = 
	`ú56xx_£nd_•_·ck‘
(&
pkt
);

248 if(
»tv®
 == 0) {

249 
wqe
->
wÜd2
.
s
.
bufs
 = 0;

250 
wqe
->
·ck‘_±r
.
u64
 = 0;

251 
	`cvmx_©omic_add64
(&
oùnic
->
pÜt
[
wqe
->
´t
].
¡©s
.
äomwœe
.
tÙ®_fwd
, 1);

253 
	`cvmx_©omic_add64
(&
oùnic
->
pÜt
[
wqe
->
´t
].
¡©s
.
äomwœe
.
”r_drİ
, 1);

256 
	`cvm_ä“_ho¡_š¡r
(
wqe
);

258  
»tv®
;

259 
	}
}

268 
	$äcÜe_£nd_to_pko
(
cvmx_wqe_t
 *
wqe
, 
pÜt
, 
ofæßd
)

270 
rv
;

271 
cvmx_pko_commªd_wÜd0_t
 
pko_commªd
;

272 
CVMX_SYNCWS
;

274 
	`cvmx_pko_£nd_·ck‘_´•¬e
(
pÜt
, 
	`cvmx_pko_g‘_ba£_queue
(port), 1);

277 
pko_commªd
.
u64
 = 0;

279 
pko_commªd
.
s
.
ignÜe_i
 = 0;

280 
pko_commªd
.
s
.
dÚtä“
 = 0;

281 
pko_commªd
.
s
.
£gs
 = 
wqe
->
wÜd2
.s.
bufs
;

282 
pko_commªd
.
s
.
tÙ®_by‹s
 = 
wqe
->
Ën
;

283 if(
ofæßd
)

284 
pko_commªd
.
s
.
ofå1
 = 
ofæßd
;

286 
	`DBG_PRINT
(
DBG_FLOW
,"pko cmd: %016llx†ptr: %016llx PORT: %d Q: %d\n",

287 
	`ÿ¡64
(
pko_commªd
.
u64
), ca¡64(
wqe
->
·ck‘_±r
.u64), 
pÜt
,

288 
	`cvmx_pko_g‘_ba£_queue
(
pÜt
));

291 
rv
 = 
	`cvmx_pko_£nd_·ck‘_fšish
(
pÜt
, 
	`cvmx_pko_g‘_ba£_queue
(port),

292 
pko_commªd
, 
wqe
->
·ck‘_±r
, 1);

293 ià(
rv
) {

294 
	`FRCORE_ERROR
("RV %d.\n", 
rv
);

297  
rv
;

298 
	}
}

301 
	$äcÜe_fÜw¬d_·ck‘_to_ho¡
(
cvmx_wqe_t
 *
wqe
)

303 
cvmx_»¥_hdr_t
 *
»¥_±r
;

304 
cvmx_buf_±r_t
 *
ÍŒ
;

305 
oùnic_pÜt_šfo_t
 *
niıÜt
 = &
oùnic
->
pÜt
[
wqe
->
´t
];

308 
	`cvmx_©omic_add64
(&
niıÜt
->
¡©s
.
äomwœe
.
tÙ®_rcvd
, 1);

309 
	`cvmx_©omic_add64
(&
niıÜt
->
¡©s
.
äomwœe
.
tÙ®_by‹s
, 
wqe
->
Ën
);

311 if(!
oùnic
->
pÜt
[
wqe
->
´t
].
rx_Ú
) {

312 
	`cvm_ä“_wqe_ªd_pkt_bufs
(
wqe
);

317 
wqe
->
wÜd2
.
s
.
bufs
 += 1;

318 
wqe
->
Ën
 +ğ
CVMX_RESP_HDR_SIZE
;

323 
ÍŒ
 = (
cvmx_buf_±r_t
 *)&
wqe
->
·ck‘_d©a
[40];

324 
ÍŒ
->
u64
 = 
wqe
->
·ck‘_±r
.u64;

326 
»¥_±r
 = (
cvmx_»¥_hdr_t
 *)&
wqe
->
·ck‘_d©a
[48];

327 
»¥_±r
->
u64
 = 0;

328 
»¥_±r
->
s
.
İcode
 = 
CORE_NW_DATA_OP
;

329 
»¥_±r
->
s
.
de¡qpÜt
 = 
niıÜt
->
ifidx
;

332 
ÍŒ
 = &
wqe
->
·ck‘_±r
;

333 
ÍŒ
->
u64
 = 0;

334 
ÍŒ
->
s
.
addr
 = 
	`CVM_DRV_GET_PHYS
(
»¥_±r
);

335 
ÍŒ
->
s
.
size
 = 8;

336 
ÍŒ
->
s
.
poŞ
 = 
CVMX_FPA_WQE_POOL
;

338 
	`FRCORE_PKT
("wq@ %°wqbufs: %d†’: %d…kt_±¸@ %Îx\n", 
wqe
,

339 
wqe
->
wÜd2
.
s
.
bufs
, wqe->
Ën
, (
ULL
èwqe->
·ck‘_±r
.s.
addr
);

341 if(!
	`äcÜe_£nd_to_pko
(
wqe
, 
niıÜt
->
lšfo
.
pcÜt
, 0)) {

343 
	`cvmx_©omic_add64
(&
niıÜt
->
¡©s
.
äomwœe
.
tÙ®_fwd
, 1);

348 
	`cvmx_©omic_add64
(&
niıÜt
->
¡©s
.
äomwœe
.
”r_pko
, 1);

349 
	`cvm_ä“_wqe_ªd_pkt_bufs
(
wqe
);

351 
	}
}

355 
	$äcÜe_fÜw¬d_·ck‘_to_wœe
(
cvmx_wqe_t
 *
wqe
, 
p_num
, 
ofæßd
)

357 
ušt64_t
 
ÃxŒ
;

358 
oùnic_pÜt_šfo_t
 *
niıÜt
 = &
oùnic
->
pÜt
[
p_num
];

360 
	`cvmx_©omic_add64
(&
niıÜt
->
¡©s
.
äomho¡
.
tÙ®_rcvd
, 1);

361 
	`cvmx_©omic_add64
(&
niıÜt
->
¡©s
.
äomho¡
.
tÙ®_by‹s
, 
wqe
->
Ën
);

363 if(
	`cvmx_uÆik–y
(
niıÜt
->
lšfo
.
lšk
.
s
.
¡©us
 == 0) ) {

364 
	`cvmx_©omic_add64
(&
niıÜt
->
¡©s
.
äomho¡
.
”r_lšk
, 1);

365 
	`cvm_ä“_wqe_ªd_pkt_bufs
(
wqe
);

370 #iâdeà
FRC_CONFIG_MAC_STATISTICS


371 
ÃxŒ
 = *((
ušt64_t
 *)
	`CVM_DRV_GET_PTR
(
wqe
->
·ck‘_±r
.
s
.
addr
 - 8));

372 
wqe
->
·ck‘_±r
.
s
.
addr
 +ğ
CVM_RAW_FRONT_SIZE
;

373 
wqe
->
·ck‘_±r
.
s
.
size
 -ğ
CVM_RAW_FRONT_SIZE
;

374 
wqe
->
Ën
 -ğ
CVM_RAW_FRONT_SIZE
;

375 *((
ušt64_t
 *)
	`CVM_DRV_GET_PTR
(
wqe
->
·ck‘_±r
.
s
.
addr
 - 8)èğ
ÃxŒ
;

378 if(!
	`äcÜe_£nd_to_pko
(
wqe
, 
p_num
, 
ofæßd
)) {

379 ià(
p_num
 == 0)

381 
	`FRCORE_STAT_INC
(
¡©_p0_tx_pkts
);

385 
	`FRCORE_STAT_INC
(
¡©_p1_tx_pkts
);

387 
	`cvmx_©omic_add64
(&
niıÜt
->
¡©s
.
äomho¡
.
tÙ®_fwd
, 1);

389 
	`cvm_drv_åa_ä“
(
wqe
, 
CVMX_FPA_WQE_POOL
, 0);

392 
	`cvmx_©omic_add64
(&
niıÜt
->
¡©s
.
äomwœe
.
”r_pko
, 1);

393 
	`cvm_ä“_wqe_ªd_pkt_bufs
(
wqe
);

394 
	}
}

407 
šlše
 

408 
	$äcÜe_´oûss_wqe
(
cvmx_wqe_t
 *
wqe
)

410 
cvmx_¿w_š¡_äÚt_t
 *
äÚt
;

411 
ušt32_t
 
İcode
;

414 
äÚt
 = (
cvmx_¿w_š¡_äÚt_t
 *)
wqe
->
·ck‘_d©a
;

421 if(
wqe
->
g½
 =ğ
GROUP_TO_DATA_PLANE_AGING
) {

422 if(
	`äcÜe_pÜt_aùive
(
wqe
->
´t
)) {

423 
	`äcÜe_wÜk_´oûss
(
wqe
);

426 if(
wqe
->
wÜd2
.
s
.
soáw¬e
) {

428 
äÚt
 = (
cvmx_¿w_š¡_äÚt_t
 *)
wqe
->
·ck‘_d©a
;

429 
İcode
 = 
äÚt
->
œh
.
s
.opcode;

431 
İcode
) {

433 #ifdeà
ENABLE_NIC_PEER_TO_PEER


434 
EP_TO_EP_OP
:

435 
	`äcÜe_fÜw¬d_·ck‘_to_wœe
(
wqe
, 
äÚt
->
œh
.
s
.
·¿m
);

439 
OCT_NW_PKT_OP
:

440 
	`FRCORE_STAT_INC
(
¡©_wÜk_pkt
);

441 
	`äcÜe_fÜw¬d_·ck‘_to_wœe
(
wqe
, 
äÚt
->
œh
.
s
.
·¿m
,

442 
äÚt
->
œh
.
s
.
¾’ssz
);

444 
OCT_NW_CMD_OP
:

445 
	`FRCORE_STAT_INC
(
¡©_wÜk_cmd
);

446 
	`äcÜe_´oûss_nic_cmd
(
wqe
);

448 
HOST_NW_INFO_OP
:

449 
	`FRCORE_STAT_INC
(
¡©_wÜk_cmd
);

450 
	`äcÜe_£nd_lšk_šfo
(
wqe
);

452 
FRC_CMD_REQUEST_OP
:

453 
	`FRCORE_STAT_INC
(
¡©_wÜk_cmd
);

454 
	`äcÜe_´oûss_äc_cmd
(
wqe
);

457 
	`FRCORE_STAT_INC
(
¡©_wÜk_š¡r
);

458 if(
İcode
 >ğ
DRIVER_OP_START
 && opcod<ğ
DRIVER_OP_END
) {

459 
	`cvm_drv_´oûss_š¡r
(
wqe
);

461 
	`cvm_ä“_ho¡_š¡r
(
wqe
);

467 if(
	`äcÜe_pÜt_aùive
(
wqe
->
´t
)) {

469 if(
	`cvmx_lik–y
(!
wqe
->
wÜd2
.
¢o
.
rcv_”rÜ
))

471 
	`äcÜe_wÜk_´oûss
(
wqe
);

476 
oùnic
->
pÜt
[
wqe
->
´t
].
¡©s
.
äomwœe
.
”r_drİ
++;

478 
	`DBG
("L2/L1ƒrror from…ort %d. Error code=%x\n",

479 
wqe
->
´t
, wqe->
wÜd2
.
¢o
.
”r_code
);

480 ià(
wqe
->
´t
 == 0)

482 
	`FRCORE_STAT_INC
(
¡©_p0_rx_”rs
);

483 
wqe
->
wÜd2
.
¢o
.
”r_code
)

485 
CVMX_PIP_PARTIAL_ERR
:

486 
	`FRCORE_STAT_INC
(
¡©_p0_PARTIAL_ERR
);

488 
CVMX_PIP_JABBER_ERR
:

489 
	`FRCORE_STAT_INC
(
¡©_p0_JABBER_ERR
);

491 
CVMX_PIP_OVER_FCS_ERR
:

492 
	`FRCORE_STAT_INC
(
¡©_p0_OVER_FCS_ERR
);

494 
CVMX_PIP_OVER_ERR
:

495 
	`FRCORE_STAT_INC
(
¡©_p0_OVER_ERR
);

496 
	`FRCORE_STAT_INC
(
¡©_pkts_above_1600
);

497 
	`FRCORE_STAT_INC
(
¡©_v”y_lÚg_pkts
);

499 
CVMX_PIP_ALIGN_ERR
:

500 
	`FRCORE_STAT_INC
(
¡©_p0_ALIGN_ERR
);

502 
CVMX_PIP_UNDER_FCS_ERR
:

503 
	`FRCORE_STAT_INC
(
¡©_p0_UNDER_FCS_ERR
);

505 
CVMX_PIP_GMX_FCS_ERR
:

506 
	`FRCORE_STAT_INC
(
¡©_p0_GMX_FCS_ERR
);

508 
CVMX_PIP_UNDER_ERR
:

509 
	`FRCORE_STAT_INC
(
¡©_p0_UNDER_ERR
);

510 
	`FRCORE_STAT_INC
(
¡©_pkts_b–ow_64
);

511 
	`FRCORE_STAT_INC
(
¡©_v”y_shÜt_pkts
);

513 
CVMX_PIP_EXTEND_ERR
:

514 
	`FRCORE_STAT_INC
(
¡©_p0_EXTEND_ERR
);

516 
CVMX_PIP_LENGTH_ERR
:

517 
	`FRCORE_STAT_INC
(
¡©_p0_LENGTH_ERR
);

519 
CVMX_PIP_DAT_ERR
:

520 
	`FRCORE_STAT_INC
(
¡©_p0_DAT_ERR
);

522 
CVMX_PIP_SKIP_ERR
:

523 
	`FRCORE_STAT_INC
(
¡©_p0_SKIP_ERR
);

525 
CVMX_PIP_NIBBLE_ERR
:

526 
	`FRCORE_STAT_INC
(
¡©_p0_NIBBLE_ERR
);

528 
CVMX_PIP_PIP_FCS
:

529 
	`FRCORE_STAT_INC
(
¡©_p0_PIP_FCS
);

531 
CVMX_PIP_PIP_SKIP_ERR
:

532 
	`FRCORE_STAT_INC
(
¡©_p0_PIP_SKIP_ERR
);

534 
CVMX_PIP_PIP_L2_MAL_HDR
:

535 
	`FRCORE_STAT_INC
(
¡©_p0_PIP_L2_MAL_HDR
);

537 
CVMX_PIP_PUNY_ERR
:

538 
	`FRCORE_STAT_INC
(
¡©_p0_PUNY_ERR
);

541 
	`FRCORE_STAT_INC
(
¡©_p0_UNKNOWN_ERR
);

547 
	`FRCORE_STAT_INC
(
¡©_p1_rx_”rs
);

548 
wqe
->
wÜd2
.
¢o
.
”r_code
)

550 
CVMX_PIP_PARTIAL_ERR
:

551 
	`FRCORE_STAT_INC
(
¡©_p1_PARTIAL_ERR
);

553 
CVMX_PIP_JABBER_ERR
:

554 
	`FRCORE_STAT_INC
(
¡©_p1_JABBER_ERR
);

556 
CVMX_PIP_OVER_FCS_ERR
:

557 
	`FRCORE_STAT_INC
(
¡©_p1_OVER_FCS_ERR
);

559 
CVMX_PIP_OVER_ERR
:

560 
	`FRCORE_STAT_INC
(
¡©_p1_OVER_ERR
);

562 
CVMX_PIP_ALIGN_ERR
:

563 
	`FRCORE_STAT_INC
(
¡©_p1_ALIGN_ERR
);

565 
CVMX_PIP_UNDER_FCS_ERR
:

566 
	`FRCORE_STAT_INC
(
¡©_p1_UNDER_FCS_ERR
);

568 
CVMX_PIP_GMX_FCS_ERR
:

569 
	`FRCORE_STAT_INC
(
¡©_p1_GMX_FCS_ERR
);

571 
CVMX_PIP_UNDER_ERR
:

572 
	`FRCORE_STAT_INC
(
¡©_p1_UNDER_ERR
);

574 
CVMX_PIP_EXTEND_ERR
:

575 
	`FRCORE_STAT_INC
(
¡©_p1_EXTEND_ERR
);

577 
CVMX_PIP_LENGTH_ERR
:

578 
	`FRCORE_STAT_INC
(
¡©_p1_LENGTH_ERR
);

580 
CVMX_PIP_DAT_ERR
:

581 
	`FRCORE_STAT_INC
(
¡©_p1_DAT_ERR
);

583 
CVMX_PIP_SKIP_ERR
:

584 
	`FRCORE_STAT_INC
(
¡©_p1_SKIP_ERR
);

586 
CVMX_PIP_NIBBLE_ERR
:

587 
	`FRCORE_STAT_INC
(
¡©_p1_NIBBLE_ERR
);

589 
CVMX_PIP_PIP_FCS
:

590 
	`FRCORE_STAT_INC
(
¡©_p1_PIP_FCS
);

592 
CVMX_PIP_PIP_SKIP_ERR
:

593 
	`FRCORE_STAT_INC
(
¡©_p1_PIP_SKIP_ERR
);

595 
CVMX_PIP_PIP_L2_MAL_HDR
:

596 
	`FRCORE_STAT_INC
(
¡©_p1_PIP_L2_MAL_HDR
);

598 
CVMX_PIP_PUNY_ERR
:

599 
	`FRCORE_STAT_INC
(
¡©_p1_PUNY_ERR
);

602 
	`FRCORE_STAT_INC
(
¡©_p1_UNKNOWN_ERR
);

607 
	`cvm_ä“_ho¡_š¡r
(
wqe
);

612 
	`´štf
("UnsuµÜ‹d WQE fÜm© @ %p\n", 
wqe
);

613 
	`cvm_drv_´št_d©a
(
wqe
, 64);

614 
	`cvm_ä“_ho¡_š¡r
(
wqe
);

620 
	}
}

634 
	$äcÜe_d©a_loİ
()

636 
cvmx_wqe_t
 *
wqe
;

637 
ušt64_t
 
Ï¡_di¥Ïy
=0, 
Ï¡_lšk_check
=0;

638 
ušt64_t
 
idË_couÁ”
 = 0, 
pko_‹¡_couÁ”
=0;

640 
	`´štf
("# cvmcs: D©¨loİ s¹ed oÀcÜe[%d]\n", 
cÜe_id
);

643 #ià!
	`defšed
(
DISABLE_PCIE14425_ERRATAFIX
)

644 if(
	`is_di¥Ïy_cÜe
(
cÜe_id
)) {

645 
	`cvmcs_sw_iq_bp
();

649 ià(
	`cvmx_sysšfo_g‘
()->
bßrd_ty³
 =ğ
CVMX_BOARD_TYPE_SIM
)

651 
wqe
 = 
	`cvmx_pow_wÜk_»que¡_sync
(
CVMX_POW_NO_WAIT
);

652 ià(
wqe
 =ğ
NULL
) {

661 
wqe
 = 
	`cvmcs_­p_g‘_wÜk_sync
(0);

663 ià(
wqe
) {

664 
wqe_couÁ
[
cÜe_id
]++;

665 
	`äcÜe_´oûss_wqe
(
wqe
);

669 
idË_couÁ”
++;

670 
pko_‹¡_couÁ”
++;

672 ià(
	`cvmx_sysšfo_g‘
()->
bßrd_ty³
 =ğ
CVMX_BOARD_TYPE_SIM
)

684 #ià(
OCTEON_SDK_VERSION_NUM
 < 108010000ULL)

685 if(
	`OCTEON_IS_MODEL
(
OCTEON_CN56XX_PASS2
))

687 if(
	`OCTEON_IS_MODEL
(
OCTEON_CN56XX_PASS2_0
))

689 
	`cvm_56xx_·ss2_upd©e_pc›_»q_num
();

692 if(
	`is_di¥Ïy_cÜe
(
cÜe_id
)) {

694 ifĞ(
	`cvmx_g‘_cyşe
(è- 
Ï¡_lšk_check
)

695 >ğ(
ıu_äeq
 * 
LINK_CHECK_INTERVAL
)) {

696 
	`äcÜe_check_lšk_¡©us
();

697 
	`äcÜe_ÿl_où_¥“d
();

698 
Ï¡_lšk_check
 = 
	`cvmx_g‘_cyşe
();

701 #ifdeà 
CVMCS_DUTY_CYCLE


702 ifĞ(
	`cvmx_g‘_cyşe
(è- 
Ï¡_di¥Ïy
)

703 >ğ(
ıu_äeq
 * 
DISPLAY_INTERVAL
)) {

706 
	`äcÜe_cÜe_´št_pow
();

707 
	`äcÜe_cÜe_´št_p_pko_¡©
();

708 
	`äcÜe_´št_poŞ_couÁ_¡©s
();

709 
	`äcÜe_´št_block_u§ge
();

710 
	`äcÜe_´št_¡©s
();

711 
	`äcÜe_¡©_dump
();

712 
Ï¡_di¥Ïy
 = 
	`cvmx_g‘_cyşe
();

717 
	`´štf
("# cvmcs: CÜ%d Ex™ed from d©¨loİ\n", 
cÜe_id
);

721 
	}
}

723 #ifdeà
__lšux__


724 
	$sigÇl_hªdËr
(
x
)

726 
	`´štf
("# cvmcs: Reûived sigÇÈ%d, qu™tšg‚ow!!\n", 
x
);

727 
	`sigÇl
(
SIGINT
, 
´ev_sig_hªdËr
 );

728 
	`cvmcs_­p_shutdown
();

729 
	`ex™
(0);

730 
	}
}

734 
	$modify_d_£‰šgs
()

736 
cvmx_d_ùl_¡©us_t
 
d_»g
;

737 
d_»g
.
u64
 = 
	`cvmx_»ad_c¤
(
CVMX_IPD_CTL_STATUS
);

738 
d_»g
.
s
.
Ën_m8
 = 1;

739 
	`cvmx_wr™e_c¤
(
CVMX_IPD_CTL_STATUS
, 
d_»g
.
u64
);

740 
	}
}

742 
	$äcÜe_š™_äc
()

744 
	`äcÜe_cmd_š™
();

745 #ià
FRC_CONFIG_GET_SYSINFO


746 
	`äcÜe_misc_š™
();

748 #ià
FRC_CONFIG_DMA_TEST


749 
	`äcÜe_dma_š™
();

752 #ià
FRC_CONFIG_SIMPLE_PACKAGE


753 
	`äcÜe_sim¶e_·ckage_chª_š™
();

755 #ià
FRC_CONFIG_SSN_CHAN


756 
	`äcÜe_s¢_chª_š™
();

758 #ià
FRC_CONFIG_SSN


759 if(
	`äcÜe_s¢_maš_´•¬e
()) {

764 #ià
FRC_CONFIG_SSN


765 
	`äcÜe_ä_š™
();

768 
	`äcÜe_bmm_š™
();

770 
	`äcÜe_phy_š™
();

772 #ià
FRC_CONFIG_RULE


773 
	`äcÜe_ruË_š™
();

776 #ià
FRC_CONFIG_TWO_TUPLE


777 
	`äcÜe_aş_š™
();

780 #ià
FRC_CONFIG_UDP


781 
	`äcÜe_udp_š™
();

784 #ià
FRC_CONFIG_VLAN_CHECK


785 
	`äcÜe_vÏn_check_š™
();

788 #ià
FRC_CONFIG_MAC_STATISTICS


789 
	`äcÜe_mac_¡©i¡ics_š™
();

792 #ià
FRC_CONFIG_TIMESTAMP_CHECK


793 
	`äcÜe_time¡amp_check_š™
();

796 #ià
FRC_CONFIG_IPC


797 
	`äcÜe_c_š™
();

800 
	}
}

802 
	$sim_š™
()

806 ià(
	`cvmx_sysšfo_g‘
()->
bßrd_ty³
 =ğ
CVMX_BOARD_TYPE_SIM
)

811 
	}
}

813 
	#MTU_IPC_MAX
 4096

	)

815 
	$äcÜe_mtu_š™
(
Ãw_mtu
)

817 
	`äcÜe_chªge_mtu
(0, 
Ãw_mtu
);

818 
	`äcÜe_chªge_mtu
(16, 
Ãw_mtu
);

819 
	}
}

822 
	$maš
()

824 
·ck‘_‹rmš©iÚ_num
 = 8;

825 if(
	`cvmcs_­p_bršgup
())

828 if(
	`is_boÙ_cÜe
(
cÜe_id
)) {

830 
	`´štf
("SDK Bud Numb”: %s\n", 
SDKVER
);

831 
	`cvmcs_´št_compe_İtiÚs
();

832 
	`´štf
("\n# frcÜe: S¹šg glob® in™ oÀcÜ%d\n", 
cÜe_id
);

834 ià(
	`cvmx_sysšfo_g‘
()->
bßrd_ty³
 =ğ
CVMX_BOARD_TYPE_SIM
)

836 
	`sim_š™
();

839 if(
	`äcÜe_š™_glob®
())

842 ià(
	`äcÜe_š™_äc
())

847 
	`´štf
("# frcore: Global initialization completed\n\n");

850 
	`cvmcs_­p_b¬r›r
();

853 
	`äcÜe_š™_loÿl
();

855 if(
	`is_boÙ_cÜe
(
cÜe_id
)) {

857 #ifdeà
__lšux__


858 
´ev_sig_hªdËr
 = 
	`sigÇl
(
SIGINT
, 
sigÇl_hªdËr
);

861 
	`cvmx_h–³r_£tup_»d
(
RED_HIGH_WMARK
, 
RED_LOW_WMARK
);

863 
	`cvm_drv_£tup_­p_mode
(
FRC_DRV_APP
);

864 
	`cvm_drv_¡¬t
();

867 
	`modify_d_£‰šgs
();

870 
	`cvmx_d_’abË
();

872 
	`´št_poŞ_couÁ_¡©s
();

875 
	`cvmcs_­p_b¬r›r
();

877 
	`äcÜe_pkt_maš
();

879 
	`cvmcs_­p_b¬r›r
();

881 ià(
	`cvmx_sysšfo_g‘
()->
bßrd_ty³
 =ğ
CVMX_BOARD_TYPE_SIM
)

883 
cvmx_pow_iq_com_út_t
 
pow_iq_com_út
;

884 
	`´štf
("Waitingo give…acket input (~1Gbps)imeo„eadhe…ackets...\n");

887 
pow_iq_com_út
.
u64
 = 
	`cvmx_»ad_c¤
(
CVMX_POW_IQ_COM_CNT
);

888 } 
pow_iq_com_út
.
s
.
iq_út
 < 
·ck‘_‹rmš©iÚ_num
);

889 
	`´štf
("Done waiting\n");

891 
	`cvmcs_­p_b¬r›r
();

893 #ifdeà
FRC_CONFIG_IPC


894 
	`äcÜe_mtu_š™
(
MTU_IPC_MAX
);

897 
	`äcÜe_d©a_loİ
();

899 
	`cvmcs_­p_b¬r›r
();

901 if(
	`is_boÙ_cÜe
(
cÜe_id
))

902 
	`cvmcs_­p_shutdown
();

905 
	}
}

	@frcore/frcore_misc.c

1 
	~"äcÜe.h
"

2 
	~"äcÜe_cmd.h
"

3 
	~"äcÜe_misc.h
"

5 
	~"cvmx-twsi.h
"

6 
	~"äcÜe_s¢.h
"

8 #ià
FRC_CONFIG_GET_SYSINFO


9 
äcÜe_v”siÚ_g‘
();

12 
	$äcÜe_cmd_g‘_v”siÚ
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

14 
äc_v”siÚ_t
 
v”siÚ
;

16 
	`äcÜe_v”siÚ_g‘
(&
v”siÚ
);

17 *
Ş’
 = (
v”siÚ
);

18 
	`memıy
(
outbuf
, &
v”siÚ
, (version));

20  
FRE_SUCCESS
;

21 
	}
}

24 
	$äcÜe_cmd_g‘_sy¡em_šfo
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

26 
äc_sy¡em_šfo_t
 
sysšfo
;

28 
	`mem£t
(&
sysšfo
, 0, (
äc_sy¡em_šfo_t
));

30 
sysšfo
.
cÜe_num
 = 12;

31 
sysšfo
.
cÜe_mask
 = 
	`cvmx_sysšfo_g‘
()->core_mask;

32 
sysšfo
.
d©a_cÜe_num
 = 
FRC_DAT_CORE_NUM
;

33 
sysšfo
.
cÜe_äeq
 = 
	`cvmx_sysšfo_g‘
()->
ıu_şock_hz
;

35 
sysšfo
.
mem_size
 = 4096;

36 
sysšfo
.
mem_äeq
 = 
	`cvmx_sysšfo_g‘
()->
d¿m_d©a_¿‹_hz
;

38 
sysšfo
.
pcb_v”siÚ
 = 1;

39 
sysšfo
.
boÙ_ty³
 = 1;

41 
sysšfo
.
pc›_v”siÚ
 = 11;

42 
sysšfo
.
pc›_ÏÃ
 = 4;

44 
sysšfo
.
ıld_v”siÚ
 = 1;

45 
sysšfo
.
pÜt_num
 = 2;

46 
sysšfo
.
pÜt_¥“d
 = 10000;

47 
sysšfo
.
boÙ_cyşe
 = 
	`cvmx_g‘_cyşe
();

48 
	`memıy
(
outbuf
, &
sysšfo
, (
äc_sy¡em_šfo_t
));

49 *
Ş’
 = (
äc_sy¡em_šfo_t
);

51  
FRE_SUCCESS
;

52 
	}
}

56 
	$äcÜe_cmd_g‘_‹mp
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

58 
rv
;

59 
äc_‹mp_t
 
‹mp
;

60 
ušt64_t
 
loÿl
, 
»mÙe
;

62 *
Ş’
 = (
äc_‹mp_t
);

64 
rv
 = 
	`cvmx_twsix_»ad_Ÿ
(1, 0x4d, 0, 1, 1, &
loÿl
);

65 
	`FRCORE_CMD
("RV = %d.\n", 
rv
);

66 
rv
 = 
	`cvmx_twsix_»ad_Ÿ
(1, 0x4d, 1, 1, 1, &
»mÙe
);

67 
	`FRCORE_CMD
("RV = %d.\n", 
rv
);

69 
	`FRCORE_CMD
("loÿÈ%Îd,„emÙ%Îd.\n", (
ULL
è
loÿl
, (ULLè
»mÙe
);

70 
‹mp
.
loÿl
 =†ocal;

71 
‹mp
.
»mÙe
 =„emote;

73 
	`memıy
(
outbuf
, &
‹mp
, (
äc_‹mp_t
));

75  
FRE_SUCCESS
;

76 
	}
}

79 
	$äcÜe_cmd_g‘_s¢_age
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

81 
rv
;

82 
ušt64_t
 
s¢_age
;

84 *
Ş’
 = (
ušt64_t
);

86 
rv
 = 
	`äcÜe_g‘_s¢_age
(&
s¢_age
);

88 
	`memıy
(
outbuf
, &
s¢_age
, (
ušt64_t
));

90  
rv
;

91 
	}
}

94 
	$äcÜe_cmd_£t_s¢_age
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

96 
rv
;

97 
ušt64_t
 *
s¢_age
 = (ušt64_ˆ*)
·¿m
;

98 
rv
 = 
	`äcÜe_£t_s¢_age
(*
s¢_age
);

99  
rv
;

100 
	}
}

103 
	$äcÜe_misc_š™
()

106 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_GET_SYSINFO
, 
äcÜe_cmd_g‘_sy¡em_šfo
);

111 
	}
}

	@frcore/frcore_misc.h

1 #iâdeà
__FRCORE_MISC_H__


2 
	#__FRCORE_MISC_H__


	)

4 #ià
FRC_CONFIG_GET_SYSINFO


5 
äcÜe_misc_š™
();

	@frcore/frcore_phy.c

1 
	~"äcÜe.h
"

2 
	~"äcÜe_cmd.h
"

3 
	~"äcÜe_misc.h
"

5 
	~"cvmx-mdio.h
"

10 
	$äcÜe_ıld_»ad
(
ušt32_t
 
addr
, ušt32_ˆ*
v®ue
)

12 
v32
;

13 
v32
 = 
	`cvmx_mdio_»ad
(1, 11, 
addr
);

14 
	`´štf
("$$$$$$$$$$$$$$$$$$$$\n");

15 
	`´štf
("add¸0x%x v32 0x%x.\n", 
addr
, 
v32
);

16 ià(
v32
 < 0)

18 
	`FRCORE_ERROR
("C¶d„—d fa:‡dd¸0x%x.\n", 
addr
);

19  
FRE_FAIL
;

21 *
v®ue
 = 
v32
;

23  
FRE_SUCCESS
;

24 
	}
}

27 
	$äcÜe_ıld_wr™e
(
ušt32_t
 
addr
, ušt32_ˆ
v®ue
)

29 
rv
;

30 
rv
 = 
	`cvmx_mdio_wr™e
(1, 11, 
addr
, 
v®ue
);

31 
	`´štf
("$$$$$$$$$$$$$$$$$$$$\n");

32 
	`´štf
("add¸0x%x v®u0x%x„v %d.\n",
addr
, 
v®ue
, 
rv
);

33 ià(0 !ğ
rv
)

35 
	`FRCORE_ERROR
("C¶d wr™ç:‡dd¸0x%x v®u0x%8x.\n", 
addr
, 
v®ue
);

36  
FRE_FAIL
;

39  
FRE_SUCCESS
;

40 
	}
}

43 
	$äcÜe_phy_»ad
(
ušt16_t
 
pÜt
, ušt16_ˆ
devad
, ušt16_ˆ
addr
, ušt16_ˆ*
v®ue
)

45 
ušt16_t
 
phyid
;

46 
i32
;

48 ià(
pÜt
 == 0)

50 
phyid
 = 0;

52 ià(
pÜt
 == 16)

54 
phyid
 = 1;

58  
FRE_PARAM
;

60 
i32
 = 
	`cvmx_mdio_45_»ad
(0, 
phyid
, 
devad
, 
addr
);

61 
	`FRCORE_PHY
("phyid %d devad %d‡dd¸0x%.4x i32 0x%.8x.\n", 
phyid
, 
devad
, 
addr
, 
i32
);

62 ià(
i32
 < 0)

64 
	`FRCORE_ERROR
("PHY„ead fail:…hyid 0x%x devad 0x%x‡ddr 0x%x.\n",

65 
phyid
, 
devad
, 
addr
);

66  
FRE_FAIL
;

68 *
v®ue
 = 
i32
 & 0xFFFF;

70  
FRE_SUCCESS
;

71 
	}
}

74 
	$äcÜe_phy_wr™e
(
ušt16_t
 
pÜt
, ušt16_ˆ
devad
, ušt16_ˆ
addr
, ušt16_ˆ
v®ue
)

76 
rv
;

77 
ušt16_t
 
phyid
;

79 ià(
pÜt
 == 0)

81 
phyid
 = 0;

83 ià(
pÜt
 == 16)

85 
phyid
 = 1;

89  
FRE_PARAM
;

92 
rv
 = 
	`cvmx_mdio_45_wr™e
(0, 
phyid
, 
devad
, 
addr
, 
v®ue
);

93 
	`FRCORE_PHY
("phyid %d devad %d‡dd¸0x%.4x v®u0x%.4x„v %d.\n", 
phyid
, 
devad
, 
addr
, 
v®ue
, 
rv
);

94 ià(0 !ğ
rv
)

96 
	`FRCORE_ERROR
("PHY wr™ç:…hyid 0x%x devad 0x%x‡dd¸0x%x v®u0x%x.\n", 
phyid
, 
devad
, 
addr
, 
v®ue
);

97  
FRE_FAIL
;

100  
FRE_SUCCESS
;

101 
	}
}

105 
	$äcÜe_cmd_g‘_ıld
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

107 
äc_ıld_İ_t
 *
¬g
 = (äc_ıld_İ_ˆ*)
·¿m
;

108 *
Ş’
 = (
äc_ıld_İ_t
);

110 
	`´štf
("$$$$$$$$$$$$$$$$\n");

111 
	`´štf
("add¸0x%x v®u0x%x\n", 
¬g
->
addr
,‡rg->
d©a
);

114 ià(
	`äcÜe_ıld_»ad
(
¬g
->
addr
, &¬g->
d©a
)) {

115  
FRE_FAIL
;

117 
	`memıy
(
outbuf
, 
¬g
, (
äc_ıld_İ_t
));

119  
FRE_SUCCESS
;

121 
	}
}

125 
	$äcÜe_cmd_£t_ıld
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

127 
äc_ıld_İ_t
 *
¬g
 = (äc_ıld_İ_ˆ*)
·¿m
;

128 *
Ş’
 = 0;

130 
	`´štf
("$$$$$$$$$$$$$$$$\n");

131 
	`´štf
("add¸0x%x v®u0x%x\n",
¬g
->
addr
,‡rg->
d©a
);

134 ià(
	`äcÜe_ıld_wr™e
(
¬g
->
addr
,‡rg->
d©a
)) {

135  
FRE_FAIL
;

138  
FRE_SUCCESS
;

140 
	}
}

145 
	$äcÜe_cmd_g‘_phy
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

148 
äc_phy_İ_t
 *
¬g
 = (äc_phy_İ_ˆ*è
·¿m
;

149 *
Ş’
 = (
äc_phy_İ_t
);

151 
	`FRCORE_CMD
("pÜˆ%d, devad %d‡dd¸0x%.4x\n", 
¬g
->
pÜt
,‡rg->
devad
,‡rg->
addr
);

153 
	`´štf
("######################################\n");

154 
	`´štf
("pÜˆğ%d, devad = %d,‡dd¸ğ0x%.4x\n", 
¬g
->
pÜt
,‡rg->
devad
,‡rg->
addr
);

156 ià(
	`äcÜe_phy_»ad
(
¬g
->
pÜt
,‡rg->
devad
,‡rg->
addr
, &¬g->
v®ue
)) {

157  
FRE_FAIL
;

159 
	`memıy
(
outbuf
, 
¬g
, (
äc_phy_İ_t
));

161  
FRE_SUCCESS
;

162 
	}
}

165 
	$äcÜe_cmd_£t_phy
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

168 
äc_phy_İ_t
 *
¬g
 = (äc_phy_İ_ˆ*è
·¿m
;

169 *
Ş’
 = 0;

171 
	`FRCORE_CMD
("pÜˆ%d, devad %d‡dd¸0x%.4x v®u0x%.4x\n", 
¬g
->
pÜt
,‡rg->
devad
,‡rg->
addr
,‡rg->
v®ue
);

172 
	`´štf
("pÜˆ%d, devad %d,‡dd¸0x%.4x, vauË 0x%.4x\n", 
¬g
->
pÜt
,‡rg->
devad
,‡rg->
addr
,‡rg->
v®ue
);

174 ià(
	`äcÜe_phy_wr™e
(
¬g
->
pÜt
,‡rg->
devad
,‡rg->
addr
,‡rg->
v®ue
)) {

175  
FRE_FAIL
;

178  
FRE_SUCCESS
;

179 
	}
}

182 
	$äcÜe_cmd_pÜt_’abË
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

184 
	`FRCORE_CMD
("\n");

185 
ušt16_t
 
v0
 = 0, 
v1
 = 0;

186 ià(
	`äcÜe_phy_»ad
(0, 1, 0, &
v0
))

188 
	`FRCORE_ERROR
("Read…hy„egister of…ort0 fail!\n");

189  
FRE_FAIL
;

192 ià(
	`äcÜe_phy_»ad
(16, 1, 0, &
v1
))

194 
	`FRCORE_ERROR
("Read…hy„egister of…ort1 fail!\n");

195  
FRE_FAIL
;

198 
	`´štf
("PÜˆ0 , PHY CTRL„eig¡”: 0x%.4x\n", 
v0
);

199 
	`´štf
("PÜˆ16, PHY CTRL„eig¡”: 0x%.4x\n", 
v1
);

201 ià(
	`äcÜe_phy_wr™e
(0, 1, 0, 0x2040))

203 
	`FRCORE_ERROR
("Enable…ort 0 fail!\n");

204  
FRE_FAIL
;

207 ià(
	`äcÜe_phy_wr™e
(16, 1, 0, 0x2040))

209 
	`FRCORE_ERROR
("Enable…ort 16 fail!\n");

210  
FRE_FAIL
;

213  
FRE_SUCCESS
;

214 
	}
}

218 
	$äcÜe_phy_š™
()

220 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_CTRL
, 
CTRL_CMD_PORT_ENABLE
, 
äcÜe_cmd_pÜt_’abË
);

221 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_GET_PHY
, 
äcÜe_cmd_g‘_phy
);

222 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_SET_PHY
, 
äcÜe_cmd_£t_phy
);

223 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_GET_CPLD
, 
äcÜe_cmd_g‘_ıld
);

224 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_SET_CPLD
, 
äcÜe_cmd_£t_ıld
);

227 
	`äcÜe_phy_wr™e
(0, 1, 0xCA02, 0xCC10);

228 
	`äcÜe_phy_wr™e
(0, 1, 0xCA00, 0x7008);

229 
	`äcÜe_phy_wr™e
(16, 1, 0xCA02, 0xCC10);

230 
	`äcÜe_phy_wr™e
(16, 1, 0xCA00, 0x7008);

233 
	}
}

	@frcore/frcore_phy.h

1 #iâdeà
__FRCORE_PHY_H__


2 
	#__FRCORE_PHY_H__


	)

4 
äcÜe_phy_š™
();

	@frcore/frcore_pkt.c

28 
	~<¡dio.h
>

29 
	~<¡ršg.h
>

30 
	~"äcÜe_pkt.h
"

33 
	~"äcÜe_.h
"

35 
	~"äcÜe_¡©.h
"

36 
	~"äcÜe_cÚfig.h
"

37 
	~"äc_ut.h
"

38 
	~"äcÜe_dma.h
"

39 
	~"äcÜe_chª.h
"

40 
	~"äcÜe_tı.h
"

41 
	~"äcÜe_´Ùo.h
"

42 
	~"äcÜe_vÏn_check.h
"

43 
	~"äcÜe_mac_¡©i¡ics.h
"

47 
CVMX_SHARED
 
ušt64_t
 
	gnow_cyşe
;

48 
CVMX_SHARED
 
ušt64_t
 
	gmax_cyşe
 = 0;

51 
äcÜe_fÜw¬d_·ck‘_to_ho¡
(
cvmx_wqe_t
 *
wqe
);

53 
ušt32_t
 
cÜe_id
;

54 
CVMX_SHARED
 
ušt8_t
 
wÜk_mode_où0
;

55 
CVMX_SHARED
 
ušt8_t
 
wÜk_mode_où1
;

57 #ià
FRC_CONFIG_VLAN_CHECK


58 
CVMX_SHARED
 
št64_t
 
vÏn_id_¡©
[
¡©_vÏn_id_max
];

60 #ià
FRC_CONFIG_TIMESTAMP_CHECK


61 
CVMX_SHARED
 
št64_t
 
time¡amp_¡©
[
¡©_time¡amp_max
];

65 
	#FRCORE_INIT_DUMP
(
_func
) \

67 
	`´štf
("%-20 ...... %s.\n", #_func, 
	`_func
() ? "FAIL" : "DONE"); \

68 }

	)

71 
	$äcÜe_cmd_cÜe_š™
()

73 
cÜe_num
 = 
	`cvmx_g‘_cÜe_num
();

74 
ušt64_t
 
mask
 = 0;

76 
mask
 = 1 << 
FRC_CMD_GRP
;

78 
	`cvmx_pow_£t_group_mask
(
cÜe_num
, 
mask
);

80 
	`FRCORE_DUMP
("CMD CORE %d: MASK 0x%.16Îx\n", 
cÜe_num
, (è
mask
);

81 
	}
}

83 
	$äcÜe_pkt_cÜe_š™
()

85 
cÜe_num
 = 
	`cvmx_g‘_cÜe_num
();

86 
ušt64_t
 
mask
 = 0;

88 
mask
 = 1 << 
FRC_PKT_GRP
;

90 
	`cvmx_pow_£t_group_mask
(
cÜe_num
, 
mask
);

92 
	`FRCORE_DUMP
("PKT CORE %d: MASK 0x%.16Îx\n", 
cÜe_num
, (è
mask
);

93 
	}
}

95 
	$äcÜe_d©_cÜe_š™
()

97 
cÜe_num
 = 
	`cvmx_g‘_cÜe_num
();

99 
ušt64_t
 
mask
 = 0;

101 
mask
 = (1 << (
cÜe_num
 + 1)è| (1 << 
FRC_DAT_GRP
è| (1 << 
GROUP_TO_DATA_PLANE_AGING
);

103 
	`cvmx_pow_£t_group_mask
(
cÜe_num
, 
mask
);

105 
	`FRCORE_DUMP
("DATA CORE %d: MASK 0x%.16Îx\n", 
cÜe_num
, (è
mask
);

106 
	}
}

109 
	$äcÜe_tim_š™
()

111 if(
	`cvmx_tim_£tup
(
FRCORE_TIM_TICKS
, 
FRCORE_TIM_TICKS_PSEC
*3)) {

112  
SPTE_FAIL
;

115 
	`cvmx_tim_¡¬t
();

117  
SPTE_SUCCESS
;

118 
	}
}

120 
	$äcÜe_pkt_š™
()

124 
	`FRCORE_DUMP
("\n\nOcteon spt\n");

126 
	`FRCORE_DUMP
("Initializing...\n");

128 
	`FRCORE_INIT_DUMP
(
äcÜe_¡©_š™
);

130 
	`FRCORE_INIT_DUMP
(
äcÜe_tim_š™
);

132 
	`FRCORE_DUMP
("Initialization Completed.\n");

133 
	}
}

135 
	$äcÜe_wÜk_ä“
(
cvmx_wqe_t
 *
wÜk
)

137 
	`FRCORE_STAT_INC
(
¡©_wÜk_ä“
);

138 #ià
FRCORE_CFG_FREE_WORK


140 
	`cvm_ä“_ho¡_š¡r
(
wÜk
);

144 
	}
}

147 
	$kšds_of_pkt_Ën_¡©
(
cvmx_wqe_t
 *
wÜk
)

149 
ušt64_t
 
Ën
 = 
wÜk
->len;

150 if(
Ën
 < 60) {

151 
	`FRCORE_STAT_INC
(
¡©_pkts_b–ow_64
);

152 
	`FRCORE_STAT_INC
(
¡©_v”y_shÜt_pkts
);

153 }ià(
Ën
>=60 &&†en<124) {

154 
	`FRCORE_STAT_INC
(
¡©_pkts_b‘w“n_64_128
);

155 }ià(
Ën
>=124 &&†en<252) {

156 
	`FRCORE_STAT_INC
(
¡©_pkts_b‘w“n_128_256
);

157 }ià(
Ën
>=252 &&†en<508) {

158 
	`FRCORE_STAT_INC
(
¡©_pkts_b‘w“n_256_512
);

159 }ià(
Ën
>=508 &&†en<1020) {

160 
	`FRCORE_STAT_INC
(
¡©_pkts_b‘w“n_512_1024
);

161 }ià(
Ën
>=1020 &&†en<1496) {

162 
	`FRCORE_STAT_INC
(
¡©_pkts_b‘w“n_1024_1500
);

163 }ià(
Ën
>=1496 &&†en<=1596) {

164 
	`FRCORE_STAT_INC
(
¡©_pkts_b‘w“n_1500_1600
);

165 }ià(
Ën
>1596) {

166 
	`FRCORE_STAT_INC
(
¡©_pkts_above_1600
);

167 
	`FRCORE_STAT_INC
(
¡©_v”y_lÚg_pkts
);

170 ià(
Ën
>=60 &&†en<=1596) {

171 
	`FRCORE_STAT_INC
(
¡©_nÜm®_pkts
);

174 
	}
}

176 
	$äcÜe_£nd_to_pko
(
cvmx_wqe_t
 *
wqe
, 
pÜt
, 
ofæßd
)

178 
rv
;

179 
cvmx_buf_±r_t
 
·ck‘_±r
;

180 
cvmx_pko_commªd_wÜd0_t
 
pko_commªd
;

181 cÚ¡ 
u£_d_no_w±r
 = 
	`oùeÚ_has_ã©u»
(
OCTEON_FEATURE_NO_WPTR
);

183 
CVMX_SYNCWS
;

186 
	`cvmx_pko_£nd_·ck‘_´•¬e
(
pÜt
, 
	`cvmx_pko_g‘_ba£_queue
(port), 1);

191 ià(
wqe
->
wÜd2
.
s
.
bufs
 == 0)

195 
pko_commªd
.
s
.
tÙ®_by‹s
 = 
wqe
->
Ën
;

196 
pko_commªd
.
s
.
£gs
 = 1;

197 
·ck‘_±r
.
u64
 = 0;

198 ià(
u£_d_no_w±r
)

200 
·ck‘_±r
.
s
.
poŞ
 = 
CVMX_FPA_PACKET_POOL
;

201 
·ck‘_±r
.
s
.
size
 = 
CVMX_FPA_PACKET_POOL_SIZE
;

205 
·ck‘_±r
.
s
.
poŞ
 = 
CVMX_FPA_WQE_POOL
;

206 
·ck‘_±r
.
s
.
size
 = 
CVMX_FPA_WQE_POOL_SIZE
;

208 
·ck‘_±r
.
s
.
addr
 = 
	`cvmx_±r_to_phys
(
wqe
->
·ck‘_d©a
);

209 ià(
	`cvmx_lik–y
(!
wqe
->
wÜd2
.
s
.
nÙ_IP
))

212 ià(
wqe
->
wÜd2
.
s
.
is_v6
)

213 
·ck‘_±r
.
s
.
addr
 += 2;

215 
·ck‘_±r
.
s
.
addr
 += 6;

220 
pko_commªd
.
s
.
tÙ®_by‹s
 = 
wqe
->
Ën
;

221 
pko_commªd
.
s
.
£gs
 = 
wqe
->
wÜd2
.s.
bufs
;

222 
·ck‘_±r
 = 
wqe
->packet_ptr;

223 ià(!
u£_d_no_w±r
)

224 
	`cvmx_åa_ä“
(
wqe
, 
CVMX_FPA_WQE_POOL
, 0);

228 
rv
 = 
	`cvmx_pko_£nd_·ck‘_fšish
(
pÜt
, 
	`cvmx_pko_g‘_ba£_queue
(port),

229 
pko_commªd
, 
·ck‘_±r
, 1);

231 ià(
rv
) {

232 
	`cvmx_h–³r_ä“_·ck‘_d©a
(
wqe
);

233 
	`FRCORE_ERROR
("RV %d.\n", 
rv
);

238  
rv
;

239 
	}
}

241 
	$mac_´št
(
ušt8_t
 *
‘h”_±r
)

243 
ušt64_t
 
d¡
 = 0;

244 
ušt64_t
 
¤c
 = 0;

245 
d¡
 = *(
ušt64_t
 *)
‘h”_±r
;

246 
d¡
 = dst >> 16;

247 
¤c
 = *(
ušt64_t
 *)(
‘h”_±r
 + 6);

248 
¤c
 = src >> 16;

249 
	`´štf
("+++++++++++ d¡ = 0x%lx srøğ0x%lx +++++++++++\n", 
d¡
, 
¤c
);

250 
	}
}

252 
šlše
 
	$sw­_mac_addr
(
ušt64_t
 
pkt_±r
)

256 
ušt16_t
 
s
;

258 
ušt32_t
 
w
;

262 
s
 = *(
ušt16_t
*)
pkt_±r
;

263 
w
 = *(
ušt32_t
*)(
pkt_±r
+2);

264 *(
ušt16_t
*)
pkt_±r
 = *(uint16_t*)(pkt_ptr+6);

265 *(
ušt32_t
*)(
pkt_±r
+2) = *(uint32_t*)(pkt_ptr+8);

266 *(
ušt16_t
*)(
pkt_±r
+6èğ
s
;

267 *(
ušt32_t
*)(
pkt_±r
+8èğ
w
;

268 
	}
}

269 #ià
FRC_CONFIG_MAC_STATISTICS


270 
	$äcÜe_pkt_£ndback
(
cvmx_wqe_t
 *
wÜk
)

272 
ušt8_t
 
pÜt_num
 = 
wÜk
->
´t
;

273 
ušt8_t
 *
‘h”_±r
;

274 cÚ¡ 
u£_d_no_w±r
 = 
	`oùeÚ_has_ã©u»
(
OCTEON_FEATURE_NO_WPTR
);

276 ià((
wÜk
->
g½
 =ğ
FRC_PKT_GRP
è|| (wÜk->g½ =ğ
FRC_CMD_GRP
))

278 
	`cvmx_h–³r_ä“_·ck‘_d©a
(
wÜk
);

279 ià(
u£_d_no_w±r
)

280 
	`cvmx_åa_ä“
(
wÜk
, 
CVMX_FPA_PACKET_POOL
, 0);

282 
	`cvmx_åa_ä“
(
wÜk
, 
CVMX_FPA_WQE_POOL
, 0);

285 ià(
wÜk
->
wÜd2
.
s
.
bufs
 == 0)

287 
‘h”_±r
 = 
wÜk
->
·ck‘_d©a
;

289 
‘h”_±r
 = 
	`cvmx_phys_to_±r
(
wÜk
->
·ck‘_±r
.
s
.
addr
);

292 ià((*(
ušt16_t
 *)(
‘h”_±r
 + 12)) != 0x88a8)

296 
	`äcÜe_mac_¡©i¡ics_couÁ”_šc
(
‘h”_±r
);

298 
	`sw­_mac_addr
((
ušt64_t
)
‘h”_±r
);

299 
	`äcÜe_fÜw¬d_·ck‘_to_wœe
(
wÜk
, 
pÜt_num
, 0);

300 
	`FRCORE_STAT_INC
(
¡©_sw­_mac_£nd_pkts
);

301  
FRCORE_ACT_UNFREE
;

305 
	`FRCORE_STAT_INC
(
¡©_h—¹_b—t_pkt
);

306 ià(
h—¹_b—t
 =ğ
HEART_BEAT_ON_WITH_DROP
)

309 ià(((*(
‘h”_±r
 + 5)) % 64 != 0))

311 
	`FRCORE_STAT_INC
(
¡©_h—¹_b—t_£nd_back_pkt
);

313 
	`sw­_mac_addr
((
ušt64_t
)
‘h”_±r
);

314 
	`äcÜe_fÜw¬d_·ck‘_to_wœe
(
wÜk
, 
pÜt_num
, 0);

315  
FRCORE_ACT_UNFREE
;

319 
	`FRCORE_STAT_INC
(
¡©_h—¹_b—t_Ú_drİ_pkt
);

321  
FRCORE_ACT_DROP
;

324 ià(
h—¹_b—t
 =ğ
HEART_BEAT_ON
)

326 
	`FRCORE_STAT_INC
(
¡©_h—¹_b—t_£nd_back_pkt
);

328 
	`sw­_mac_addr
((
ušt64_t
)
‘h”_±r
);

329 
	`äcÜe_fÜw¬d_·ck‘_to_wœe
(
wÜk
, 
pÜt_num
, 0);

330  
FRCORE_ACT_UNFREE
;

334 
	`FRCORE_STAT_INC
(
¡©_h—¹_b—t_drİ_pkt
);

336  
FRCORE_ACT_DROP
;

339 
	}
}

342 
CVMX_SHARED
 
ušt64_t
 
	grx_pkts
 = 0;

343 
šlše
 
	$äcÜe_pkt_wÜk_´oûss
(
cvmx_wqe_t
 *
wÜk
)

345 
ušt8_t
 *
_±r
, *
‘h”_±r
;

346 
rv
;

347 
ušt64_t
 
smac
 = 0, 
dmac
 = 0;

348 
ušt8_t
 *
p
;

349 
ušt16_t
 
ty³
 = 0;

351 
	`kšds_of_pkt_Ën_¡©
(
wÜk
);

353 if(!
oùnic
->
pÜt
[
wÜk
->
´t
].
rx_Ú
) {

354 
	`FRCORE_DROP
(
¡©_drİ_pÜt_off
);

357 
	`FRCORE_PKT
("==============ğrx_pkt %Îd.\n", (
ULL
è++
rx_pkts
);

361 ià(
wÜk
->
wÜd2
.
s
.
rcv_”rÜ
) {

362 
	`FRCORE_STAT_INC
(
¡©_rx_”rs
);

363 
	`FRCORE_DROP
(
¡©_drİ_rx_”rÜ
);

366 
	`FRCORE_STAT_INC
(
¡©_rx_pkts
);

367 
	`FRCORE_STAT_ADD
(
¡©_rx_by‹s
, (
wÜk
->
Ën
 + 4));

369 #ià
FRC_CONFIG_VLAN_CHECK


370 
	`FRCORE_PORT_VLAN_STAT_INC
(
wÜk
->
´t
, 
xe0_¡©_rxx_pkts
);

371 
	`FRCORE_PORT_VLAN_STAT_ADD
(
wÜk
->
´t
, 
xe0_¡©_rxx_by‹s
, (wÜk->
Ën
 + 4));

373 #ià
FRC_CONFIG_MAC_STATISTICS


374  
	`äcÜe_pkt_£ndback
(
wÜk
);

378 ià(
wÜk
->
wÜd2
.
s
.
bufs
 == 0)

380 
	`´štf
("% wÜk->wÜd2.s.buf =ğ0\n", 
__func__
);

381 
_±r
 = 
wÜk
->
·ck‘_d©a
 + wÜk->
wÜd2
.
s
.
_off£t
 + 6;

382 
‘h”_±r
 = 
wÜk
->
·ck‘_d©a
;

384 
‘h”_±r
 = 
	`cvmx_phys_to_±r
(
wÜk
->
·ck‘_±r
.
s
.
addr
);

385 
_±r
 = 
	`cvmx_phys_to_±r
(
wÜk
->
·ck‘_±r
.
s
.
addr
 + wÜk->
wÜd2
.s.
_off£t
);

389 ià(
wÜk
->
wÜd2
.
s
.
nÙ_IP
) {

390 
	`FRCORE_STAT_INC
(
¡©_nÙ_
);

393 
	`UP16
(
‘h”_±r
 + 12, 
ty³
);

394 ià(
ty³
 =ğ
ETH_P_MPLS_UC
 ||y³ =ğ
ETH_P_MPLS_MC
) {

395 
	`FRCORE_STAT_INC
(
¡©_m¶s
);

398 ià(
ty³
 =ğ
ETH_P_PPP_DISC
 ||y³ =ğ
ETH_P_PPP_SES
) {

399 
	`FRCORE_STAT_INC
(
¡©_µpÛ
);

401 
	`FRCORE_DROP
(
¡©_drİ_nÙ_
);

406 
p
 = 
‘h”_±r
;

409 
	`memıy
(&
dmac
, 
‘h”_±r
 + 0, 6);

410 
	`memıy
(&
smac
, 
‘h”_±r
 + 6, 6);

411 
	`sw­_buff
(1, &
dmac
);

412 
	`sw­_buff
(1, &
smac
);

414 
	`FRCORE_PKT
("smaø0x%Îx, dmaø0x%Îx\n", (
ULL
è
smac
, (ULLè
dmac
);

419 #ià
FRC_DEBUG_PKT_LEN


421 ià(
wÜk
->
Ën
 != 1514)

423 
	`FRC_DEBUG
(
PKT_LEN
, "wÜk->wÜd2.s.buf %d\n", 
wÜk
->
wÜd2
.
s
.
bufs
);

424 
	`äc_dump_buff
(
wÜk
->
Ën
, 
‘h”_±r
);

427 
rv
 = 
	`äcÜe__´oûss
(
wÜk
, 
‘h”_±r
, 
_±r
, 
smac
, 
dmac
);

429  
rv
;

430 
	}
}

431 #ià
FRCORE_CFG_DUMP_CYCLE


432 
äcÜe_cyşe_»c_t
 
	gäcÜe_cyşe_»cod”
;

435 
šlše
 
	$äcÜe_d©_wÜk_´oûss
(
cvmx_wqe_t
 *
wÜk
)

437 
rv
;

438 #ià
FRC_CONFIG_IPC


439 
rv
 = 
	`äcÜe_c_wÜk_´oûss
(
wÜk
);

441 
rv
 = 
	`äcÜe_pkt_wÜk_´oûss
(
wÜk
);

443  
rv
;

444 
	}
}

446 
	$äcÜe_wÜk_´oûss
(
cvmx_wqe_t
 *
wÜk
)

448 
rv
;

452 
wÜk
->
unu£d
) {

453 
FRCORE_WORK_PKT
:

456 
oùnic_pÜt_šfo_t
 *
niıÜt
 = &
oùnic
->
pÜt
[
wÜk
->
´t
];

457 
	`FRCORE_STAT_INC
((
¡©_cÜe0_wqe
 + 
cÜe_id
));

458 
	`cvmx_©omic_add64
(&
niıÜt
->
¡©s
.
äomwœe
.
tÙ®_rcvd
, 1);

459 
	`cvmx_©omic_add64
(&
niıÜt
->
¡©s
.
äomwœe
.
tÙ®_by‹s
, 
wÜk
->
Ën
);

460 
	`FRCORE_STAT_INC
(
¡©_wÜk_d©a
);

462 ià(
wÜk
->
´t
 == 0) {

463 
	`FRCORE_STAT_INC
(
¡©_p0_rx_pkts
);

464 ià(!
wÜk_mode_où0
) {

465 
rv
 = 
	`äcÜe_d©_wÜk_´oûss
(
wÜk
);

467 #ifdeà
ENABLE_NIC_PEER_TO_PEER


468 
	`äcÜe_fÜw¬d_pkt_to_•
(
wÜk
);

470 
	`äcÜe_fÜw¬d_·ck‘_to_ho¡
(
wÜk
);

475 
	`FRCORE_STAT_INC
(
¡©_p1_rx_pkts
);

476 ià(!
wÜk_mode_où1
) {

477 
rv
 = 
	`äcÜe_d©_wÜk_´oûss
(
wÜk
);

479 #ifdeà
ENABLE_NIC_PEER_TO_PEER


480 
	`äcÜe_fÜw¬d_pkt_to_•
(
wÜk
);

482 
	`äcÜe_fÜw¬d_·ck‘_to_ho¡
(
wÜk
);

487 
	`FRCORE_WQE
("äcÜe_pkt_wÜk_´oûs »tuº %d.\n", 
rv
);

492 #ià
FRCORE_CONFIG_STAT_WQE


493 
FRCORE_WORK_STAT
:

494 
	`FRCORE_STAT_INC
(
¡©_wÜk_¡©
);

495 
rv
 = 
	`äcÜe_¡©_wÜk_´oûss
(
wÜk
);

496 
	`FRCORE_WQE
("äcÜe_¡©_wÜk_´oûs »tuº %d.\n", 
rv
);

500 #ià
FRC_CONFIG_DMA_TEST


501 
FRCORE_WORK_DMA_LOOP
:

502 
rv
 = 
	`äcÜe_dma_loİ
(
wÜk
);

503 
	`FRCORE_WQE
("äcÜe_dma_loİ„‘uº %d.\n", 
rv
);

506 #ià
FRC_CONFIG_SIMPLE_PACKAGE
 || 
FRC_CONFIG_SSN_CHAN


507 
FRCORE_WORK_CHAN
:

508 
	`FRCORE_STAT_INC
(
¡©_chª_tim”
);

509 
rv
 = 
	`äcÜe_chª_´oûss
(
wÜk
);

510 
	`FRCORE_WQE
("äcÜe_chª_´oûs »tuº %d.\n", 
rv
);

513 #ià
FRC_CONFIG_SIMPLE_PACKET_TEST
 || 
FRC_CONFIG_SSN_CHAN_TEST


514 
FRCORE_WORK_CHAN_TEST
:

515 
rv
 = 
	`äcÜe_chª_‹¡_´oûss
(
wÜk
);

516 
	`FRCORE_WQE
("äcÜe_chª_´oûs »tuº %d.\n", 
rv
);

520 
FRCORE_WORK_SSN_AGE
:

521 #ià
FRC_CONFIG_AGE


522 
	`FRCORE_STAT_INC
(
¡©_s¢_age_wqe
);

523 
rv
 = 
	`äcÜe_s¢_age_´oûss
(
wÜk
);

525 
rv
 = 
FRCORE_ACT_UNFREE
;

527 
	`FRCORE_WQE
("äcÜe_chª_´oûs »tuº %d.\n", 
rv
);

531 
	`FRCORE_STAT_INC
(
¡©_wÜk_unkown
);

532 
rv
 = 
FRCORE_ACT_DROP
;

533 
	`FRCORE_WQE
("wÜk_unkowÀ»tuº %d.\n", 
rv
);

537 
rv
) {

538 
FRCORE_ACT_DEBUG
:

539 
	`FRCORE_STAT_INC
(
¡©_aù_debug
);

541 
FRCORE_ACT_FREE
:

542 
	`FRCORE_STAT_INC
(
¡©_aù_ä“
);

543 
	`äcÜe_wÜk_ä“
(
wÜk
);

545 
FRCORE_ACT_DROP
:

546 
	`FRCORE_STAT_INC
(
¡©_aù_drİ
);

547 #ià
FRCORE_CONFIG_TX_DROP


549 
	`äcÜe_tx_wÜk
(
wÜk
);

551 
	`äcÜe_wÜk_ä“
(
wÜk
);

554 
FRCORE_ACT_FORWARD
:

555 
	`FRCORE_STAT_INC
(
¡©_aù_fÜw¬d
);

557 
	`äcÜe_wÜk_ä“
(
wÜk
);

558 
	`FRCORE_TEST
("\n");

560 
FRCORE_ACT_DELAY
:

561 
	`FRCORE_STAT_INC
(
¡©_aù_d–ay
);

563 
FRCORE_ACT_UNFREE
:

564 
	`FRCORE_STAT_INC
(
¡©_aù_unä“
);

567 
	`FRCORE_STAT_INC
(
¡©_aù_unkown
);

568 
	`äcÜe_wÜk_ä“
(
wÜk
);

572 
	}
}

576 
cvmx_p_pÜt_¡©us_t
 
	mšput_¡©i¡ics
;

577 
cvmx_h–³r_š‹rçû_mode_t
 
	mimode
;

578 
	mdi¥Ïy
;

579 
ušt64_t
 
	mlšk_¡©e
;

580 } 
	trx_pÜt_¡©e_t
;

590 
	#FRCORE_RESET_TIME
 10000

	)

593 
	$äcÜe_¡©e_dump
()

595 
ušt64_t
 
Ãxt_upd©e
 = 0;

596 
ušt64_t
 
upd©e_cyşe
 = 0;

597 
ušt64_t
 
Ãxt_dump
 = 0;

598 
ušt64_t
 
dump_cyşe
 = 0;

599 
ušt64_t
 
cyşe
;

600 
dump_út
 = 
FRCORE_RESET_TIME
;

601 
ušt64_t
 
ıu_şock_hz
 = 0;

603 ià(
	`cvmx_sysšfo_g‘
()->
bßrd_ty³
 =ğ
CVMX_BOARD_TYPE_SIM
) {

604 
ıu_şock_hz
 = 
FRCORE_SIM_CLOCK_HZ
;

605 
upd©e_cyşe
 = 
ıu_şock_hz
 * 5;

606 
dump_cyşe
 = 
ıu_şock_hz
;

608 
ıu_şock_hz
 = 
	`cvmx_sysšfo_g‘
()->cpu_clock_hz;

609 
upd©e_cyşe
 = 
ıu_şock_hz
;

610 
dump_cyşe
 = 
ıu_şock_hz
 * 5;

613 
cyşe
 = 
	`cvmx_g‘_cyşe
();

614 
Ãxt_upd©e
 +ğ
cyşe
 + 
upd©e_cyşe
;

615 
Ãxt_dump
 +ğ
cyşe
 + 
dump_cyşe
;

617 
	`FRCORE_WQE
("cycle %lld‚ext_update %lld‚ext_dump %lld\n",

618 (è
cyşe
,

619 (è
Ãxt_upd©e
,

620 (è
Ãxt_dump
);

622 
dump_út
) {

623 
cyşe
 = 
	`cvmx_g‘_cyşe
();

624 ià(
cyşe
 >ğ
Ãxt_upd©e
)

628 
Ãxt_upd©e
 = 
cyşe
 + 
upd©e_cyşe
;

632 ià(
cyşe
 >ğ
Ãxt_dump
)

636 
	`FRCORE_DUMP
("UPDATE CNT %d:\n", 
dump_út
--);

637 
	`äcÜe_¡©_dump
();

638 
Ãxt_dump
 = 
	`cvmx_g‘_cyşe
(è+ 
dump_cyşe
;

641 
	`´štf
("=== System„eset‚ow ===\n");

643 
	`cvmx_»£t_oùeÚ
();

644 
	}
}

646 
	$_¡ršg
(
ušt32_t
 

, 
¡r
[
IP_STR_LEN
])

648 
ušt8_t
 *
p
 = (ušt8_ˆ*)&

;

649 
	`mem£t
(
¡r
, 0, 
IP_STR_LEN
);

650 
	`¥rštf
(
¡r
, "%u.%u.%u.%u", 
p
[0],…[1],…[2],…[3]);

651 
¡r
[
IP_STR_LEN
 - 1] = 0;

652 
	}
}

660 
	#SWAP_MAC_ADDR


	)

661 
	#TCP_UDP_ONLY


	)

662 
	#DUMP_PKT_INFO


	)

670 
	$äcÜe_pkt_maš
()

672 
cvmx_sysšfo_t
 *
sysšfo
;

673 
cÜemask_äcÜe
;

674 
»suÉ
 = 0;

675 
cÜe_num
;

676 
sysšfo
 = 
	`cvmx_sysšfo_g‘
();

677 
cÜemask_äcÜe
 = 
sysšfo
->
cÜe_mask
;

683 ià(
	`cvmx_cÜemask_fœ¡_cÜe
(
cÜemask_äcÜe
)) {

684 
	`´štf
("V”siÚ: %s\n", 
	`cvmx_h–³r_g‘_v”siÚ
());

685 
	`äcÜe_pkt_š™
();

687 
	`cvmx_cÜemask_b¬r›r_sync
(
cÜemask_äcÜe
);

689 
cÜe_num
 = 
	`cvmx_g‘_cÜe_num
();

690 ià(
cÜe_num
 < 
FRC_DAT_CORE_MAX
) {

691 
	`äcÜe_d©_cÜe_š™
();

692 } ià(
cÜe_num
 < 
FRC_PKT_CORE_MAX
){

693 
	`äcÜe_pkt_cÜe_š™
();

695 
	`äcÜe_cmd_cÜe_š™
();

698 
	`cvmx_cÜemask_b¬r›r_sync
(
cÜemask_äcÜe
);

699 ià(
	`cvmx_cÜemask_fœ¡_cÜe
(
cÜemask_äcÜe
)) {

704 
	`cvmx_cÜemask_b¬r›r_sync
(
cÜemask_äcÜe
);

706  
»suÉ
;

707 
	}
}

	@frcore/frcore_pkt.h

1 #iâdeà
__FRCORE_PKT_H__


2 
	#__FRCORE_PKT_H__


	)

4 
	~"cvmx-cÚfig.h
"

5 
	~"cvmx.h
"

6 
	~"cvmx-higig.h
"

7 
	~"cvmx-¥šlock.h
"

8 
	~"cvmx-åa.h
"

9 
	~"cvmx-p.h
"

11 
	~"cvmx-d.h
"

12 
	~"cvmx-pko.h
"

13 
	~"cvmx-dç.h
"

14 
	~"cvmx-pow.h
"

15 
	~"cvmx-gmx.h
"

17 
	~"cvmx-u¬t.h
"

18 
	~"cvmx-sysšfo.h
"

19 
	~"cvmx-cÜemask.h
"

20 
	~"cvmx-boÙmem.h
"

21 
	~"cvmx-©omic.h
"

22 
	~"cvmx-h–³r.h
"

23 
	~"cvmx-h–³r-bßrd.h
"

24 
	~"cvmx-Åi.h
"

25 
	~"cvmx-ebt3000.h
"

26 
	~"cvmx-¥i.h
"

27 
	~"cvmx-tim.h
"

28 
	~"cvmx-c¤-db.h
"

31 
	~"cvmcs-commÚ.h
"

32 
	~<cvmx-©omic.h
>

37 
	~"äcÜe_cÚfig.h
"

39 
	~"äcÜe.h
"

42 
	#NUM_PACKET_BUFFERS
 4096

	)

43 
	#NUM_WORK_BUFFERS
 
NUM_PACKET_BUFFERS


	)

45 
	#FRCORE_SIM_CLOCK_HZ
 1000000

	)

47 
	#FRCORE_CORE_NUM
 12

	)

48 
	#FRCORE_PORT_NUM
 4

	)

49 
	#FRCORE_DMAC_NUM
 16

	)

51 
	#FRCORE_TIM_TICKS
 100

	)

52 
	#FRCORE_TIM_TICKS_PSEC
 (1000000 / 
FRCORE_TIM_TICKS
)

	)

55 
	#FRCORE_MTU
 1512

	)

57 
	#FRCORE_IP_HD_SZ
 20

	)

59 
	#FRCORE_TCP_HD_SZ
 20

	)

60 
	#FRCORE_TCP_OFFSET
 (
FRCORE_IP_HD_SZ
 + 
FRCORE_TCP_HD_SZ
)

	)

61 
	#FRCORE_TCP_MTU
 (
FRCORE_MTU
 - 
FRCORE_TCP_OFFSET
)

	)

63 
	#FRCORE_NUM_PKT_BUFS
 (
K
)

	)

64 
	#FRCORE_ETHERNET_CRC
 4

	)

65 
	#TCP_WINDOWS_SIZE
 65535

	)

70 
cvmx_p_pÜt_¡©us_t
 
	mšput_¡©i¡ics
;

71 
cvmx_h–³r_š‹rçû_mode_t
 
	mimode
;

72 
	mdi¥Ïy
;

73 
ušt64_t
 
	mlšk_¡©e
;

74 
	mlšk_up
;

75 } 
	täcÜe_pÜt_¡©e_t
;

78 
	mFRCORE_ACT_DEBUG
,

79 
	mFRCORE_ACT_DROP
,

80 
	mFRCORE_ACT_FORWARD
,

81 
	mFRCORE_ACT_DELAY
,

82 
	mFRCORE_ACT_UNFREE
,

83 
	mFRCORE_ACT_FREE
,

84 
	mFRCORE_ACT_MAX


85 } 
	täcÜe_aù_t
;

88 
	mSPTE_SUCCESS
,

89 
	mSPTE_FAIL
,

90 
	mSPTE_MEMORY
,

91 
	mSPTE_MAX


92 } 
	täcÜe_”r_t
;

95 
	mFRCORE_WORK_PKT
,

96 
	mFRCORE_WORK_STAT
,

97 
	mFRCORE_WORK_QUEUE
,

98 
	mFRCORE_WORK_DMA_LOOP
,

99 
	mFRCORE_WORK_CHAN
,

100 
	mFRCORE_WORK_CHAN_TEST
,

101 
	mFRCORE_WORK_SSN_AGE


102 } 
	täcÜe_wÜk_t
;

105 
	tmac_t
[6];

109 
	#UNPACK_U8
(
_buf
, 
_v¬
è\

	)

110 
	g_v¬
 = *
_buf
++ & 0xff

112 
	#UNPACK_U16
(
_buf
, 
_v¬
è\

	)

113 
	g_v¬
 = (*
_buf
++ & 0xff) << 8; \

114 
	g_v¬
 |ğ(*
_buf
++ & 0xff);

116 
	#UNPACK_U32
(
_buf
, 
_v¬
è\

	)

117 
	g_v¬
 = 0; \

118 
	g_v¬
 |ğ(*
_buf
++ & 0xff) << 24; \

119 
	g_v¬
 |ğ(*
_buf
++ & 0xff) << 16; \

120 
	g_v¬
 |ğ(*
_buf
++ & 0xff) << 8; \

121 
	g_v¬
 |ğ(*
_buf
++ & 0xff);

124 
	#UP8
(
_buf
, 
_v¬
è\

	)

125 
	g_v¬
 = *(
_buf
) & 0xff

127 
	#UP16
(
_buf
, 
_v¬
è\

	)

128 
	g_v¬
 = (*(
_buf
) & 0xff) << 8; \

129 
	g_v¬
 |ğ(*(
_buf
 + 1) & 0xff);

131 
	#UP32
(
_buf
, 
_v¬
è\

	)

132 
	g_v¬
 = 0; \

133 
	g_v¬
 |ğ(*(
_buf
) & 0xff) << 24; \

134 
	g_v¬
 |ğ(*(
_buf
 + 1) & 0xff) << 16; \

135 
	g_v¬
 |ğ(*(
_buf
 + 2) & 0xff) << 8; \

136 
	g_v¬
 |ğ(*(
_buf
 + 3) & 0xff);

138 
	#PACK_BYTES
(
_buf
, 
_v¬
, 
_Ën
è\

	)

140 
	gb
; \

141 
	gb
 = 0; b < 
	g_Ën
; b++) { \

142 
PACK_U8
(
_buf
, (
_v¬
)[
b
]); \

146 
	#UNPACK_BYTES
(
_buf
, 
_v¬
, 
_Ën
è\

	)

148 
	gb
; \

149 
	gb
 = 0; b < 
	g_Ën
; b++) { \

150 
UNPACK_U8
(
_buf
, (
_v¬
)[
b
]); \

154 
	#PACK_MAC
(
_buf
, 
_mac
è\

	)

155 *
	g_buf
++ = ((
ušt8_t
 *è&(
_mac
))[0] & 0xff; \

156 *
	g_buf
++ = ((
ušt8_t
 *è&(
_mac
))[1] & 0xff; \

157 *
	g_buf
++ = ((
ušt8_t
 *è&(
_mac
))[2] & 0xff; \

158 *
	g_buf
++ = ((
ušt8_t
 *è&(
_mac
))[3] & 0xff; \

159 *
	g_buf
++ = ((
ušt8_t
 *è&(
_mac
))[4] & 0xff; \

160 *
	g_buf
++ = ((
ušt8_t
 *è&(
_mac
))[5] & 0xff;

162 
	#UNPACK_MAC
(
_buf
, 
_mac
è\

	)

163 ((
	gušt8_t
 *è&(
	g_mac
))[0] = *
_buf
++ & 0xff; \

164 ((
	gušt8_t
 *è&(
	g_mac
))[1] = *
_buf
++ & 0xff; \

165 ((
	gušt8_t
 *è&(
	g_mac
))[2] = *
_buf
++ & 0xff; \

166 ((
	gušt8_t
 *è&(
	g_mac
))[3] = *
_buf
++ & 0xff; \

167 ((
	gušt8_t
 *è&(
	g_mac
))[4] = *
_buf
++ & 0xff; \

168 ((
	gušt8_t
 *è&(
	g_mac
))[5] = *
_buf
++ & 0xff;

171 
	#TRAFFICGEN_SCR_WORK
 (0è

	)

173 
šlše
 
äcÜe_tx_wÜk
(
cvmx_wqe_t
 *
wÜk
);

175 
	#IP_STR_LEN
 100

	)

177 
_¡ršg
(
ušt32_t
 

, 
¡r
[
IP_STR_LEN
]);

179 
	#FRCORE_DROP
(
_út
è\

	)

180 
FRCORE_STAT_INC
(
_út
); \

181  
	gFRCORE_ACT_DROP
;

183 
	#FRCORE_FREE
 \

	)

184  
FRCORE_ACT_FREE


188 
äcÜe_pkt_maš
();

189 
äcÜe_wÜk_´oûss
(
cvmx_wqe_t
 *
wqe
);

191 
äcÜe_wÜk_ä“
(
cvmx_wqe_t
 *
wÜk
);

193 
kšds_of_pkt_Ën_¡©
(
cvmx_wqe_t
 *
wÜk
);

	@frcore/frcore_proc.h

1 #iâdeà
_MPP_PROC_H


2 
	#_MPP_PROC_H


	)

4 
	~"cvmx-cÚfig.h
"

5 
	~"cvmx.h
"

6 
	~"cvmx-wqe.h
"

7 
	~"cvmx-pko.h
"

8 
	~"cvmx-h–³r.h
"

9 
	~"cvmx-©omic.h
"

10 
	~"cvmx-tim.h
"

11 
	~"cvmx-p.h
"

13 
	~"äcÜe.h
"

14 
	~"äcÜe_cÚfig.h
"

15 
	~"äcÜe_debug.h
"

18 
	~"äcÜe_´Ùo.h
"

26 
šlše
 
	$mµ_ä“_wqe_·ck‘_d©a
(
cvmx_wqe_t
 *
wÜk
)

28 
	`cvmx_h–³r_ä“_·ck‘_d©a
(
wÜk
);

29 
	`cvmx_åa_ä“
(
wÜk
, 
CVMX_FPA_WQE_POOL
, 0);

33 
	}
}

35 
šlše
 
	$mµ_ä“_wqe_·ck‘_d©a_ng‘wÜk
(
cvmx_wqe_t
 *
wÜk
)

37 
	`cvmx_h–³r_ä“_·ck‘_d©a
(
wÜk
);

38 
	`cvmx_åa_ä“
(
wÜk
, 
CVMX_FPA_WQE_POOL
, 0);

40 
	}
}

	@frcore/frcore_proto.h

1 #iâdeà
__FRCORE_PROTO_H__


2 
	#__FRCORE_PROTO_H__


	)

5 #iâdeà
_LINUX_IF_ETHER_H


11 
	#ETH_ALEN
 6

	)

12 
	#ETH_HLEN
 14

	)

13 
	#ETH_ZLEN
 60

	)

14 
	#ETH_DATA_LEN
 1500

	)

15 
	#ETH_FRAME_LEN
 1514

	)

16 
	#ETH_FCS_LEN
 4

	)

22 
	#ETH_P_LOOP
 0x0060

	)

23 
	#ETH_P_PUP
 0x0200

	)

24 
	#ETH_P_PUPAT
 0x0201

	)

25 
	#ETH_P_IP
 0x0800

	)

26 
	#ETH_P_X25
 0x0805

	)

27 
	#ETH_P_ARP
 0x0806

	)

28 
	#ETH_P_BPQ
 0x08FF

	)

29 
	#ETH_P_IEEEPUP
 0x0a00

	)

30 
	#ETH_P_IEEEPUPAT
 0x0a01

	)

31 
	#ETH_P_DEC
 0x6000

	)

32 
	#ETH_P_DNA_DL
 0x6001

	)

33 
	#ETH_P_DNA_RC
 0x6002

	)

34 
	#ETH_P_DNA_RT
 0x6003

	)

35 
	#ETH_P_LAT
 0x6004

	)

36 
	#ETH_P_DIAG
 0x6005

	)

37 
	#ETH_P_CUST
 0x6006

	)

38 
	#ETH_P_SCA
 0x6007

	)

39 
	#ETH_P_RARP
 0x8035

	)

40 
	#ETH_P_ATALK
 0x809B

	)

41 
	#ETH_P_AARP
 0x80F3

	)

42 
	#ETH_P_8021Q
 0x8100

	)

43 
	#ETH_P_IPX
 0x8137

	)

44 
	#ETH_P_IPV6
 0x86DD

	)

45 
	#ETH_P_PAUSE
 0x8808

	)

46 
	#ETH_P_SLOW
 0x8809

	)

47 
	#ETH_P_WCCP
 0x883E

	)

49 
	#ETH_P_PPP_DISC
 0x8863

	)

50 
	#ETH_P_PPP_SES
 0x8864

	)

51 
	#ETH_P_MPLS_UC
 0x8847

	)

52 
	#ETH_P_MPLS_MC
 0x8848

	)

53 
	#ETH_P_ATMMPOA
 0x884ø

	)

54 
	#ETH_P_ATMFATE
 0x8884

	)

57 
	#ETH_P_AOE
 0x88A2

	)

58 
	#ETH_P_TIPC
 0x88CA

	)

66 
	#ETH_P_802_3
 0x0001

	)

67 
	#ETH_P_AX25
 0x0002

	)

68 
	#ETH_P_ALL
 0x0003

	)

69 
	#ETH_P_802_2
 0x0004

	)

70 
	#ETH_P_SNAP
 0x0005

	)

71 
	#ETH_P_DDCMP
 0x0006

	)

72 
	#ETH_P_WAN_PPP
 0x0007

	)

73 
	#ETH_P_PPP_MP
 0x0008

	)

74 
	#ETH_P_LOCALTALK
 0x0009

	)

75 
	#ETH_P_CAN
 0x000C

	)

76 
	#ETH_P_PPPTALK
 0x0010

	)

77 
	#ETH_P_TR_802_2
 0x0011

	)

78 
	#ETH_P_MOBITEX
 0x0015

	)

79 
	#ETH_P_CONTROL
 0x0016

	)

80 
	#ETH_P_IRDA
 0x0017

	)

81 
	#ETH_P_ECONET
 0x0018

	)

82 
	#ETH_P_HDLC
 0x0019

	)

83 
	#ETH_P_ARCNET
 0x001A

	)

89 
	#ETH_PPP_IP
 0x0021

	)

90 
	#ETH_PPP_VJ_COMP
 0x002d

	)

91 
	#ETH_PPP_VJ_UNCOMP
 0x002f

	)

94 
	#IP_P_TCP
 0x6

	)

95 
	#IP_P_UDP
 0x11

	)

96 
	#IP_P_GRE
 0x2f

	)

97 
	#IP_P_SCTP
 0x84

	)

100 
	s‘hhdr
 {

101 
	mh_de¡
[
ETH_ALEN
];

102 
	mh_sourû
[
ETH_ALEN
];

103 
ušt16_t
 
	mh_´Ùo
;

104 } 
__©Œibu‹__
((
·cked
));

105 
	#PKT_ETHERNET_HEADER_LEN
 (
‘hhdr
)

	)

107 
	svÏn_h—d”
 {

108 
ušt8_t
 
	m‘h”_dho¡
[6];

109 
ušt8_t
 
	m‘h”_sho¡
[6];

110 
ušt16_t
 
	m‘h”_ty³
;

111 
ušt16_t
 
	mvÏn_tci
;

112 
ušt16_t
 
	mvÏn_’ty³
;

113 } 
__©Œibu‹__
((
·cked
));

115 
	svÏn_‘hhdr
 {

116 
	mh_de¡
[
ETH_ALEN
];

117 
	mh_sourû
[
ETH_ALEN
];

118 
ušt16_t
 
	mh_vÏn_´Ùo
;

119 
ušt16_t
 
	mh_vÏn_TCI
;

120 
ušt16_t
 
	mh_vÏn_’ÿpsuÏ‹d_´Ùo
;

121 }
__©Œibu‹__
((
·cked
));

124 #iâdeà
_LINUX_TCP_H


125 
	stıhdr
 {

126 
ušt16_t
 
	msourû
;

127 
ušt16_t
 
	mde¡
;

128 
ušt32_t
 
	m£q
;

129 
ušt32_t
 
	mack_£q
;

131 
ušt16_t
 
	mdoff
:4,

132 
	m»s1
:4,

133 
	mcwr
:1,

134 
	meû
:1,

135 
	murg
:1,

136 
	mack
:1,

137 
	mpsh
:1,

138 
	mr¡
:1,

139 
	msyn
:1,

140 
	mfš
:1;

141 
	#TH_FIN
 0x01

	)

142 
	#TH_SYN
 0x02

	)

143 
	#TH_RST
 0x04

	)

144 
	#TH_PUSH
 0x08

	)

145 
	#TH_ACK
 0x10

	)

146 
	#TH_URG
 0x20

	)

148 
ušt16_t
 
	mwšdow
;

149 
ušt16_t
 
	mcheck
;

150 
ušt16_t
 
	murg_±r
;

152 
	#PKT_TCP_HEADER_LEN
 (
tıhdr
)

	)

156 #ià!
defšed
(
_LINUX_IP_H
è&& !defšed(
__NETINET_IP_H
)

157 
	shdr
 {

158 #ià
defšed
(
__LITTLE_ENDIAN_BITFIELD
)

159 
ušt8_t
 
	mihl
:4,

160 
	mv”siÚ
:4;

161 #–ià
defšed
 (
__BIG_ENDIAN_BITFIELD
)

162 
ušt8_t
 
	mv”siÚ
:4,

163 
	mihl
:4;

165 
ušt8_t
 
	mv”siÚ
:4,

166 
	mihl
:4;

168 
ušt8_t
 
	mtos
;

169 
ušt16_t
 
	mtÙ_Ën
;

170 
ušt16_t
 
	mid
;

171 
ušt16_t
 
	mræag
:1;

172 
ušt16_t
 
	mdæag
:1;

173 
ušt16_t
 
	mmæag
:1;

174 
ušt16_t
 
	mäag_off£t
:13;

175 
ušt8_t
 
	m‰l
;

176 
ušt8_t
 
	m´ÙocŞ
;

177 
ušt16_t
 
	mcheck
;

178 
ušt32_t
 
	m§ddr
;

179 
ušt32_t
 
	mdaddr
;

184 #iâdeà
_LINUX_UDP_H


185 
	sudphdr
 {

186 
ušt16_t
 
	msourû
;

187 
ušt16_t
 
	mde¡
;

188 
ušt16_t
 
	mËn
;

189 
ušt16_t
 
	mcheck
;

192 
	#PKT_UDP_HEADER_LEN
 8

	)

195 #iâdeà
_LINUX_IN6_H


201 
	sš6_addr
 {

203 
ušt8_t
 
	mu6_addr8
[16];

204 
ušt16_t
 
	mu6_addr16
[8];

205 
ušt16_t
 
	mu6_addr32
[4];

206 } 
	mš6_u
;

207 
	#s6_addr
 
š6_u
.
u6_addr8


	)

208 
	#s6_addr16
 
š6_u
.
u6_addr16


	)

209 
	#s6_addr32
 
š6_u
.
u6_addr32


	)

214 #iâdeà
_IPV6_H


222 
	sv6hdr
 {

223 #ià
defšed
(
__LITTLE_ENDIAN_BITFIELD
)

224 
ušt8_t
 
	m´iÜ™y
:4,

225 
	mv”siÚ
:4;

226 #–ià
defšed
(
__BIG_ENDIAN_BITFIELD
)

227 
ušt8_t
 
	mv”siÚ
:4,

228 
	m´iÜ™y
:4;

230 
ušt8_t
 
	mv”siÚ
:4,

231 
	m´iÜ™y
:4;

233 
ušt8_t
 
	mæow_lbl
[3];

235 
ušt16_t
 
	m·ylßd_Ën
;

236 
ušt8_t
 
	mÃxthdr
;

237 
ušt8_t
 
	mhİ_lim™
;

239 
š6_addr
 
	m§ddr
;

240 
š6_addr
 
	mdaddr
;

	@frcore/frcore_queue.h

34 #iâdeà
_MPP_QUEUE_H_


35 
	#_MPP_QUEUE_H_


	)

38 
	~"äcÜe_debug.h
"

108 #iâdeà
QUEUE_MACRO_DEBUG


109 
	#QUEUE_MACRO_DEBUG
 1

	)

112 #ifdeà
QUEUE_MACRO_DEBUG


114 
	sqm_Œaû
 {

115 * 
	mÏ¡fe
;

116 
	mÏ¡lše
;

117 * 
	m´evfe
;

118 
	m´evlše
;

121 
	#TRACEBUF
 
qm_Œaû
 
Œaû
;

	)

122 
	#TRASHIT
(
x
èdØ{(xèğ(*)-1;} 0)

	)

123 
	#QMD_SAVELINK
(
Çme
, 
lšk
è**Çmğ(*)&Öšk)

	)

125 
	#QMD_TRACE_HEAD
(
h—d
) do { \

126 (
h—d
)->
Œaû
.
´evlše
 = (h—d)->Œaû.
Ï¡lše
; \

127 (
h—d
)->
Œaû
.
´evfe
 = (h—d)->Œaû.
Ï¡fe
; \

128 (
h—d
)->
Œaû
.
Ï¡lše
 = 
__LINE__
; \

129 (
h—d
)->
Œaû
.
Ï¡fe
 = 
__FILE__
; \

130 } 0)

	)

132 
	#QMD_TRACE_ELEM
(
–em
) do { \

133 (
–em
)->
Œaû
.
´evlše
 = (–em)->Œaû.
Ï¡lše
; \

134 (
–em
)->
Œaû
.
´evfe
 = (–em)->Œaû.
Ï¡fe
; \

135 (
–em
)->
Œaû
.
Ï¡lše
 = 
__LINE__
; \

136 (
–em
)->
Œaû
.
Ï¡fe
 = 
__FILE__
; \

137 } 0)

	)

140 
	#QMD_TRACE_ELEM
(
–em
)

	)

141 
	#QMD_TRACE_HEAD
(
h—d
)

	)

142 
	#QMD_SAVELINK
(
Çme
, 
lšk
)

	)

143 
	#TRACEBUF


	)

144 
	#TRASHIT
(
x
)

	)

150 
	#SLIST_HEAD
(
Çme
, 
ty³
) \

151 
	sÇme
 { \

152 
ty³
 *
¦h_fœ¡
; \

153 }

	)

155 
	#SLIST_HEAD_INITIALIZER
(
h—d
) \

156 { 
NULL
 }

	)

158 
	#SLIST_ENTRY
(
ty³
) \

160 
ty³
 *
¦e_Ãxt
; \

161 }

	)

166 
	#SLIST_EMPTY
(
h—d
è((h—d)->
¦h_fœ¡
 =ğ
NULL
)

	)

168 
	#SLIST_FIRST
(
h—d
è((h—d)->
¦h_fœ¡
)

	)

170 
	#SLIST_FOREACH
(
v¬
, 
h—d
, 
f›ld
) \

171 (
v¬
èğ
	`SLIST_FIRST
((
h—d
)); \

172 (
v¬
); \

173 (
v¬
èğ
	`SLIST_NEXT
((v¬), 
f›ld
))

	)

175 
	#SLIST_FOREACH_SAFE
(
v¬
, 
h—d
, 
f›ld
, 
tv¬
) \

176 (
v¬
èğ
	`SLIST_FIRST
((
h—d
)); \

177 (
v¬
è&& ((
tv¬
èğ
	`SLIST_NEXT
((v¬), 
f›ld
), 1); \

178 (
v¬
èğ(
tv¬
))

	)

180 
	#SLIST_FOREACH_PREVPTR
(
v¬
, 
v¬p
, 
h—d
, 
f›ld
) \

181 (
v¬p
èğ&
	`SLIST_FIRST
((
h—d
)); \

182 ((
v¬
èğ*(
v¬p
)è!ğ
NULL
; \

183 (
v¬p
èğ&
	`SLIST_NEXT
((
v¬
), 
f›ld
))

	)

185 
	#SLIST_INIT
(
h—d
) do { \

186 
	`SLIST_FIRST
((
h—d
)èğ
NULL
; \

187 } 0)

	)

189 
	#SLIST_INSERT_AFTER
(
¦i¡–m
, 
–m
, 
f›ld
) do { \

190 
	`SLIST_NEXT
((
–m
), 
f›ld
èğSLIST_NEXT((
¦i¡–m
), field); \

191 
	`SLIST_NEXT
((
¦i¡–m
), 
f›ld
èğ(
–m
); \

192 } 0)

	)

194 
	#SLIST_INSERT_HEAD
(
h—d
, 
–m
, 
f›ld
) do { \

195 
	`SLIST_NEXT
((
–m
), 
f›ld
èğ
	`SLIST_FIRST
((
h—d
)); \

196 
	`SLIST_FIRST
((
h—d
)èğ(
–m
); \

197 } 0)

	)

199 
	#SLIST_NEXT
(
–m
, 
f›ld
è(Ólm)->f›ld.
¦e_Ãxt
)

	)

201 
	#SLIST_REMOVE
(
h—d
, 
–m
, 
ty³
, 
f›ld
) do { \

202 
	`QMD_SAVELINK
(
ŞdÃxt
, (
–m
)->
f›ld
.
¦e_Ãxt
); \

203 ià(
	`SLIST_FIRST
((
h—d
)è=ğ(
–m
)) { \

204 
	`SLIST_REMOVE_HEAD
((
h—d
), 
f›ld
); \

207 
ty³
 *
cu»lm
 = 
	`SLIST_FIRST
((
h—d
)); \

208 
	`SLIST_NEXT
(
cu»lm
, 
f›ld
è!ğ(
–m
)) \

209 
cu»lm
 = 
	`SLIST_NEXT
(cu»lm, 
f›ld
); \

210 
	`SLIST_REMOVE_AFTER
(
cu»lm
, 
f›ld
); \

212 
	`TRASHIT
(*
ŞdÃxt
); \

213 } 0)

	)

215 
	#SLIST_REMOVE_AFTER
(
–m
, 
f›ld
) do { \

216 
	`SLIST_NEXT
(
–m
, 
f›ld
) = \

217 
	`SLIST_NEXT
(SLIST_NEXT(
–m
, 
f›ld
), field); \

218 } 0)

	)

220 
	#SLIST_REMOVE_HEAD
(
h—d
, 
f›ld
) do { \

221 
	`SLIST_FIRST
((
h—d
)èğ
	`SLIST_NEXT
(SLIST_FIRST((h—d)), 
f›ld
); \

222 } 0)

	)

224 
	#SLIST_SWAP
(
h—d1
, 
h—d2
, 
ty³
) do { \

225 
ty³
 *
sw­_fœ¡
 = 
	`SLIST_FIRST
(
h—d1
); \

226 
	`SLIST_FIRST
(
h—d1
èğSLIST_FIRST(
h—d2
); \

227 
	`SLIST_FIRST
(
h—d2
èğ
sw­_fœ¡
; \

228 } 0)

	)

233 
	#STAILQ_HEAD
(
Çme
, 
ty³
) \

234 
	sÇme
 { \

235 
ty³
 *
¡qh_fœ¡
; \

236 
ty³
 **
¡qh_Ï¡
; \

237 }

	)

239 
	#STAILQ_HEAD_INITIALIZER
(
h—d
) \

240 { 
NULL
, &(
h—d
).
¡qh_fœ¡
 }

	)

242 
	#STAILQ_ENTRY
(
ty³
) \

244 
ty³
 *
¡qe_Ãxt
; \

245 }

	)

250 
	#STAILQ_CONCAT
(
h—d1
, 
h—d2
) do { \

251 ià(!
	`STAILQ_EMPTY
((
h—d2
))) { \

252 *(
h—d1
)->
¡qh_Ï¡
 = (
h—d2
)->
¡qh_fœ¡
; \

253 (
h—d1
)->
¡qh_Ï¡
 = (
h—d2
)->stqh_last; \

254 
	`STAILQ_INIT
((
h—d2
)); \

256 } 0)

	)

258 
	#STAILQ_EMPTY
(
h—d
è((h—d)->
¡qh_fœ¡
 =ğ
NULL
)

	)

260 
	#STAILQ_FIRST
(
h—d
è((h—d)->
¡qh_fœ¡
)

	)

262 
	#STAILQ_FOREACH
(
v¬
, 
h—d
, 
f›ld
) \

263 (
v¬
èğ
	`STAILQ_FIRST
((
h—d
)); \

264 (
v¬
); \

265 (
v¬
èğ
	`STAILQ_NEXT
((v¬), 
f›ld
))

	)

268 
	#STAILQ_FOREACH_SAFE
(
v¬
, 
h—d
, 
f›ld
, 
tv¬
) \

269 (
v¬
èğ
	`STAILQ_FIRST
((
h—d
)); \

270 (
v¬
è&& ((
tv¬
èğ
	`STAILQ_NEXT
((v¬), 
f›ld
), 1); \

271 (
v¬
èğ(
tv¬
))

	)

273 
	#STAILQ_INIT
(
h—d
) do { \

274 
	`STAILQ_FIRST
((
h—d
)èğ
NULL
; \

275 (
h—d
)->
¡qh_Ï¡
 = &
	`STAILQ_FIRST
((head)); \

276 } 0)

	)

278 
	#STAILQ_INSERT_AFTER
(
h—d
, 
tq–m
, 
–m
, 
f›ld
) do { \

279 ià((
	`STAILQ_NEXT
((
–m
), 
f›ld
èğSTAILQ_NEXT((
tq–m
), f›ld)è=ğ
NULL
)\

280 (
h—d
)->
¡qh_Ï¡
 = &
	`STAILQ_NEXT
((
–m
), 
f›ld
); \

281 
	`STAILQ_NEXT
((
tq–m
), 
f›ld
èğ(
–m
); \

282 } 0)

	)

284 
	#STAILQ_INSERT_HEAD
(
h—d
, 
–m
, 
f›ld
) do { \

285 ià((
	`STAILQ_NEXT
((
–m
), 
f›ld
èğ
	`STAILQ_FIRST
((
h—d
))è=ğ
NULL
) \

286 (
h—d
)->
¡qh_Ï¡
 = &
	`STAILQ_NEXT
((
–m
), 
f›ld
); \

287 
	`STAILQ_FIRST
((
h—d
)èğ(
–m
); \

288 } 0)

	)

290 
	#STAILQ_INSERT_TAIL
(
h—d
, 
–m
, 
f›ld
) do { \

291 
	`STAILQ_NEXT
((
–m
), 
f›ld
èğ
NULL
; \

292 *(
h—d
)->
¡qh_Ï¡
 = (
–m
); \

293 (
h—d
)->
¡qh_Ï¡
 = &
	`STAILQ_NEXT
((
–m
), 
f›ld
); \

294 } 0)

	)

296 
	#STAILQ_LAST
(
h—d
, 
ty³
, 
f›ld
) \

297 (
	`STAILQ_EMPTY
((
h—d
)) ? \

298 
NULL
 : \

299 ((
ty³
 *)(*) \

300 ((*)((
h—d
)->
¡qh_Ï¡
è- 
	`__off£tof
(
ty³
, 
f›ld
))))

	)

302 
	#STAILQ_NEXT
(
–m
, 
f›ld
è(Ólm)->f›ld.
¡qe_Ãxt
)

	)

304 
	#STAILQ_REMOVE
(
h—d
, 
–m
, 
ty³
, 
f›ld
) do { \

305 
	`QMD_SAVELINK
(
ŞdÃxt
, (
–m
)->
f›ld
.
¡qe_Ãxt
); \

306 ià(
	`STAILQ_FIRST
((
h—d
)è=ğ(
–m
)) { \

307 
	`STAILQ_REMOVE_HEAD
((
h—d
), 
f›ld
); \

310 
ty³
 *
cu»lm
 = 
	`STAILQ_FIRST
((
h—d
)); \

311 
	`STAILQ_NEXT
(
cu»lm
, 
f›ld
è!ğ(
–m
)) \

312 
cu»lm
 = 
	`STAILQ_NEXT
(cu»lm, 
f›ld
); \

313 
	`STAILQ_REMOVE_AFTER
(
h—d
, 
cu»lm
, 
f›ld
); \

315 
	`TRASHIT
(*
ŞdÃxt
); \

316 } 0)

	)

318 
	#STAILQ_REMOVE_AFTER
(
h—d
, 
–m
, 
f›ld
) do { \

319 ià((
	`STAILQ_NEXT
(
–m
, 
f›ld
) = \

320 
	`STAILQ_NEXT
(STAILQ_NEXT(
–m
, 
f›ld
), f›ld)è=ğ
NULL
) \

321 (
h—d
)->
¡qh_Ï¡
 = &
	`STAILQ_NEXT
((
–m
), 
f›ld
); \

322 } 0)

	)

324 
	#STAILQ_REMOVE_HEAD
(
h—d
, 
f›ld
) do { \

325 ià((
	`STAILQ_FIRST
((
h—d
)) = \

326 
	`STAILQ_NEXT
(
	`STAILQ_FIRST
((
h—d
)), 
f›ld
)è=ğ
NULL
) \

327 (
h—d
)->
¡qh_Ï¡
 = &
	`STAILQ_FIRST
((head)); \

328 } 0)

	)

330 
	#STAILQ_SWAP
(
h—d1
, 
h—d2
, 
ty³
) do { \

331 
ty³
 *
sw­_fœ¡
 = 
	`STAILQ_FIRST
(
h—d1
); \

332 
ty³
 **
sw­_Ï¡
 = (
h—d1
)->
¡qh_Ï¡
; \

333 
	`STAILQ_FIRST
(
h—d1
èğSTAILQ_FIRST(
h—d2
); \

334 (
h—d1
)->
¡qh_Ï¡
 = (
h—d2
)->stqh_last; \

335 
	`STAILQ_FIRST
(
h—d2
èğ
sw­_fœ¡
; \

336 (
h—d2
)->
¡qh_Ï¡
 = 
sw­_Ï¡
; \

337 ià(
	`STAILQ_EMPTY
(
h—d1
)) \

338 (
h—d1
)->
¡qh_Ï¡
 = &
	`STAILQ_FIRST
(head1); \

339 ià(
	`STAILQ_EMPTY
(
h—d2
)) \

340 (
h—d2
)->
¡qh_Ï¡
 = &
	`STAILQ_FIRST
(head2); \

341 } 0)

	)

347 
	#LIST_HEAD
(
Çme
, 
ty³
) \

348 
	sÇme
 { \

349 
ty³
 *
lh_fœ¡
; \

350 }

	)

352 
	#LIST_HEAD_INITIALIZER
(
h—d
) \

353 { 
NULL
 }

	)

355 
	#LIST_ENTRY
(
ty³
) \

357 
ty³
 *
Ë_Ãxt
; \

358 
ty³
 **
Ë_´ev
; \

359 }

	)

366 #ià
QUEUE_MACRO_DEBUG


367 
	#QMD_LIST_CHECK_HEAD
(
h—d
, 
f›ld
) do { \

368 ià(
	`LIST_FIRST
((
h—d
)è!ğ
NULL
 && \

369 
	`LIST_FIRST
((
h—d
))->
f›ld
.
Ë_´ev
 != \

370 &
	`LIST_FIRST
((
h—d
))) \

371 
	`MC_PRINTF_ERR
("Bad†ist head %p first->prev %p first->prev != head\n", \

372 (
h—d
), 
	`LIST_FIRST
((h—d))->
f›ld
.
Ë_´ev
); \

373 } 0)

	)

375 
	#QMD_LIST_CHECK_NEXT
(
–m
, 
f›ld
) do { \

376 ià(
	`LIST_NEXT
((
–m
), 
f›ld
è!ğ
NULL
 && \

377 
	`LIST_NEXT
((
–m
), 
f›ld
)->f›ld.
Ë_´ev
 != \

378 &((
–m
)->
f›ld
.
Ë_Ãxt
)) \

379 
	`MC_PRINTF_ERR
("Bad†inkƒlm %p‚ext->prev %p‚ext->prev !=ƒlm\n" \

380 , (
–m
), 
	`LIST_NEXT
(Ólm), 
f›ld
)->f›ld.
Ë_´ev
); \

381 } 0)

	)

383 
	#QMD_LIST_CHECK_PREV
(
–m
, 
f›ld
) do { \

384 ià(*(
–m
)->
f›ld
.
Ë_´ev
 != (elm)) \

385 
	`MC_PRINTF_ERR
("Bad†škƒlm %°´ev->Ãxˆ!ğ–m\n", (
–m
)); \

386 } 0)

	)

388 
	#QMD_LIST_CHECK_HEAD
(
h—d
, 
f›ld
)

	)

389 
	#QMD_LIST_CHECK_NEXT
(
–m
, 
f›ld
)

	)

390 
	#QMD_LIST_CHECK_PREV
(
–m
, 
f›ld
)

	)

393 
	#LIST_EMPTY
(
h—d
è((h—d)->
lh_fœ¡
 =ğ
NULL
)

	)

395 
	#LIST_FIRST
(
h—d
è((h—d)->
lh_fœ¡
)

	)

397 
	#LIST_FOREACH
(
v¬
, 
h—d
, 
f›ld
) \

398 (
v¬
èğ
	`LIST_FIRST
((
h—d
)); \

399 (
v¬
); \

400 (
v¬
èğ
	`LIST_NEXT
((v¬), 
f›ld
))

	)

402 
	#LIST_FOREACH_SAFE
(
v¬
, 
h—d
, 
f›ld
, 
tv¬
) \

403 (
v¬
èğ
	`LIST_FIRST
((
h—d
)); \

404 (
v¬
è&& ((
tv¬
èğ
	`LIST_NEXT
((v¬), 
f›ld
), 1); \

405 (
v¬
èğ(
tv¬
))

	)

407 
	#LIST_INIT
(
h—d
) do { \

408 
	`LIST_FIRST
((
h—d
)èğ
NULL
; \

409 } 0)

	)

411 
	#LIST_INSERT_AFTER
(
li¡–m
, 
–m
, 
f›ld
) do { \

412 
	`QMD_LIST_CHECK_NEXT
(
li¡–m
, 
f›ld
); \

413 ià((
	`LIST_NEXT
((
–m
), 
f›ld
èğLIST_NEXT((
li¡–m
), f›ld)è!ğ
NULL
)\

414 
	`LIST_NEXT
((
li¡–m
), 
f›ld
)->f›ld.
Ë_´ev
 = \

415 &
	`LIST_NEXT
((
–m
), 
f›ld
); \

416 
	`LIST_NEXT
((
li¡–m
), 
f›ld
èğ(
–m
); \

417 (
–m
)->
f›ld
.
Ë_´ev
 = &
	`LIST_NEXT
((
li¡–m
), field); \

418 } 0)

	)

420 
	#LIST_INSERT_BEFORE
(
li¡–m
, 
–m
, 
f›ld
) do { \

421 
	`QMD_LIST_CHECK_PREV
(
li¡–m
, 
f›ld
); \

422 (
–m
)->
f›ld
.
Ë_´ev
 = (
li¡–m
)->field.le_prev; \

423 
	`LIST_NEXT
((
–m
), 
f›ld
èğ(
li¡–m
); \

424 *(
li¡–m
)->
f›ld
.
Ë_´ev
 = (
–m
); \

425 (
li¡–m
)->
f›ld
.
Ë_´ev
 = &
	`LIST_NEXT
((
–m
), field); \

426 } 0)

	)

428 
	#LIST_INSERT_HEAD
(
h—d
, 
–m
, 
f›ld
) do { \

429 
	`QMD_LIST_CHECK_HEAD
((
h—d
), 
f›ld
); \

430 ià((
	`LIST_NEXT
((
–m
), 
f›ld
èğ
	`LIST_FIRST
((
h—d
))è!ğ
NULL
) \

431 
	`LIST_FIRST
((
h—d
))->
f›ld
.
Ë_´ev
 = &
	`LIST_NEXT
((
–m
), field);\

432 
	`LIST_FIRST
((
h—d
)èğ(
–m
); \

433 (
–m
)->
f›ld
.
Ë_´ev
 = &
	`LIST_FIRST
((
h—d
)); \

434 } 0)

	)

436 
	#LIST_NEXT
(
–m
, 
f›ld
è(Ólm)->f›ld.
Ë_Ãxt
)

	)

438 
	#LIST_REMOVE
(
–m
, 
f›ld
) do { \

439 
	`QMD_SAVELINK
(
ŞdÃxt
, (
–m
)->
f›ld
.
Ë_Ãxt
); \

440 
	`QMD_SAVELINK
(
Şd´ev
, (
–m
)->
f›ld
.
Ë_´ev
); \

441 
	`QMD_LIST_CHECK_NEXT
(
–m
, 
f›ld
); \

442 
	`QMD_LIST_CHECK_PREV
(
–m
, 
f›ld
); \

443 ià(
	`LIST_NEXT
((
–m
), 
f›ld
è!ğ
NULL
) \

444 
	`LIST_NEXT
((
–m
), 
f›ld
)->f›ld.
Ë_´ev
 = \

445 (
–m
)->
f›ld
.
Ë_´ev
; \

446 *(
–m
)->
f›ld
.
Ë_´ev
 = 
	`LIST_NEXT
((elm), field); \

447 
	`TRASHIT
(*
ŞdÃxt
); \

448 
	`TRASHIT
(*
Şd´ev
); \

449 } 0)

	)

452 
	#LIST_REMOVE
(
–m
, 
f›ld
) do { \

453 ià((
–m
)->
f›ld
.
Ë_Ãxt
 !ğ
NULL
) \

454 (
–m
)->
f›ld
.
Ë_Ãxt
->f›ld.
Ë_´ev
 = \

455 (
–m
)->
f›ld
.
Ë_´ev
; \

456 *(
–m
)->
f›ld
.
Ë_´ev
 = (–m)->f›ld.
Ë_Ãxt
; \

457 } 0)

	)

461 
	#LIST_SWAP
(
h—d1
, 
h—d2
, 
ty³
, 
f›ld
) do { \

462 
ty³
 *
sw­_tmp
 = 
	`LIST_FIRST
((
h—d1
)); \

463 
	`LIST_FIRST
((
h—d1
)èğLIST_FIRST((
h—d2
)); \

464 
	`LIST_FIRST
((
h—d2
)èğ
sw­_tmp
; \

465 ià((
sw­_tmp
 = 
	`LIST_FIRST
((
h—d1
))è!ğ
NULL
) \

466 
sw­_tmp
->
f›ld
.
Ë_´ev
 = &
	`LIST_FIRST
((
h—d1
)); \

467 ià((
sw­_tmp
 = 
	`LIST_FIRST
((
h—d2
))è!ğ
NULL
) \

468 
sw­_tmp
->
f›ld
.
Ë_´ev
 = &
	`LIST_FIRST
((
h—d2
)); \

469 } 0)

	)

474 
	#TAILQ_HEAD
(
Çme
, 
ty³
) \

475 
	sÇme
 { \

476 
ty³
 *
tqh_fœ¡
; \

477 
ty³
 **
tqh_Ï¡
; \

478 
TRACEBUF
 \

479 }

	)

481 
	#TAILQ_HEAD_INITIALIZER
(
h—d
) \

482 { 
NULL
, &(
h—d
).
tqh_fœ¡
 }

	)

484 
	#TAILQ_ENTRY
(
ty³
) \

486 
ty³
 *
tqe_Ãxt
; \

487 
ty³
 **
tqe_´ev
; \

488 
TRACEBUF
 \

489 }

	)

495 #ià
QUEUE_MACRO_DEBUG


496 
	#QMD_TAILQ_CHECK_HEAD
(
h—d
, 
f›ld
) do { \

497 ià(!
	`TAILQ_EMPTY
(
h—d
) && \

498 
	`TAILQ_FIRST
((
h—d
))->
f›ld
.
tqe_´ev
 != \

499 &
	`TAILQ_FIRST
((
h—d
))) \

500 
	`MC_PRINTF_ERR
("Badaq h—d %°fœ¡->´ev !ğh—d", (
h—d
)); \

501 } 0)

	)

503 
	#QMD_TAILQ_CHECK_TAIL
(
h—d
, 
f›ld
) do { \

504 ià(*(
h—d
)->
tqh_Ï¡
 !ğ
NULL
) \

505 
	`MC_PRINTF_ERR
("Badaq NEXT(%p->tqh_Ï¡è!ğNULL", (
h—d
)); \

506 } 0)

	)

508 
	#QMD_TAILQ_CHECK_NEXT
(
–m
, 
f›ld
) do { \

509 ià(
	`TAILQ_NEXT
((
–m
), 
f›ld
è!ğ
NULL
 && \

510 
	`TAILQ_NEXT
((
–m
), 
f›ld
)->f›ld.
tqe_´ev
 != \

511 &((
–m
)->
f›ld
.
tqe_Ãxt
)) \

512 
	`MC_PRINTF_ERR
("Bad†škƒlm %°Ãxt->´ev !ğ–m", (
–m
)); \

513 } 0)

	)

515 
	#QMD_TAILQ_CHECK_PREV
(
–m
, 
f›ld
) do { \

516 ià(*(
–m
)->
f›ld
.
tqe_´ev
 != (elm)) \

517 
	`MC_PRINTF_ERR
("Bad†škƒlm %°´ev->Ãxˆ!ğ–m", (
–m
)); \

518 } 0)

	)

520 
	#QMD_TAILQ_CHECK_HEAD
(
h—d
, 
f›ld
)

	)

521 
	#QMD_TAILQ_CHECK_TAIL
(
h—d
, 
h—dÇme
)

	)

522 
	#QMD_TAILQ_CHECK_NEXT
(
–m
, 
f›ld
)

	)

523 
	#QMD_TAILQ_CHECK_PREV
(
–m
, 
f›ld
)

	)

526 
	#TAILQ_CONCAT
(
h—d1
, 
h—d2
, 
f›ld
) do { \

527 ià(!
	`TAILQ_EMPTY
(
h—d2
)) { \

528 *(
h—d1
)->
tqh_Ï¡
 = (
h—d2
)->
tqh_fœ¡
; \

529 (
h—d2
)->
tqh_fœ¡
->
f›ld
.
tqe_´ev
 = (
h—d1
)->
tqh_Ï¡
; \

530 (
h—d1
)->
tqh_Ï¡
 = (
h—d2
)->tqh_last; \

531 
	`TAILQ_INIT
((
h—d2
)); \

532 
	`QMD_TRACE_HEAD
(
h—d1
); \

533 
	`QMD_TRACE_HEAD
(
h—d2
); \

535 } 0)

	)

537 
	#TAILQ_EMPTY
(
h—d
è((h—d)->
tqh_fœ¡
 =ğ
NULL
)

	)

539 
	#TAILQ_FIRST
(
h—d
è((h—d)->
tqh_fœ¡
)

	)

541 
	#TAILQ_FOREACH
(
v¬
, 
h—d
, 
f›ld
) \

542 (
v¬
èğ
	`TAILQ_FIRST
((
h—d
)); \

543 (
v¬
); \

544 (
v¬
èğ
	`TAILQ_NEXT
((v¬), 
f›ld
))

	)

546 
	#TAILQ_FOREACH_SAFE
(
v¬
, 
h—d
, 
f›ld
, 
tv¬
) \

547 (
v¬
èğ
	`TAILQ_FIRST
((
h—d
)); \

548 (
v¬
è&& ((
tv¬
èğ
	`TAILQ_NEXT
((v¬), 
f›ld
), 1); \

549 (
v¬
èğ(
tv¬
))

	)

551 
	#TAILQ_FOREACH_REVERSE
(
v¬
, 
h—d
, 
h—dÇme
, 
f›ld
) \

552 (
v¬
èğ
	`TAILQ_LAST
((
h—d
), 
h—dÇme
); \

553 (
v¬
); \

554 (
v¬
èğ
	`TAILQ_PREV
((v¬), 
h—dÇme
, 
f›ld
))

	)

556 
	#TAILQ_FOREACH_REVERSE_SAFE
(
v¬
, 
h—d
, 
h—dÇme
, 
f›ld
, 
tv¬
) \

557 (
v¬
èğ
	`TAILQ_LAST
((
h—d
), 
h—dÇme
); \

558 (
v¬
è&& ((
tv¬
èğ
	`TAILQ_PREV
((v¬), 
h—dÇme
, 
f›ld
), 1); \

559 (
v¬
èğ(
tv¬
))

	)

561 
	#TAILQ_INIT
(
h—d
) do { \

562 
	`TAILQ_FIRST
((
h—d
)èğ
NULL
; \

563 (
h—d
)->
tqh_Ï¡
 = &
	`TAILQ_FIRST
((head)); \

564 
	`QMD_TRACE_HEAD
(
h—d
); \

565 } 0)

	)

567 
	#TAILQ_INSERT_AFTER
(
h—d
, 
li¡–m
, 
–m
, 
f›ld
) do { \

568 
	`QMD_TAILQ_CHECK_NEXT
(
li¡–m
, 
f›ld
); \

569 ià((
	`TAILQ_NEXT
((
–m
), 
f›ld
èğTAILQ_NEXT((
li¡–m
), f›ld)è!ğ
NULL
)\

570 
	`TAILQ_NEXT
((
–m
), 
f›ld
)->f›ld.
tqe_´ev
 = \

571 &
	`TAILQ_NEXT
((
–m
), 
f›ld
); \

573 (
h—d
)->
tqh_Ï¡
 = &
	`TAILQ_NEXT
((
–m
), 
f›ld
); \

574 
	`QMD_TRACE_HEAD
(
h—d
); \

576 
	`TAILQ_NEXT
((
li¡–m
), 
f›ld
èğ(
–m
); \

577 (
–m
)->
f›ld
.
tqe_´ev
 = &
	`TAILQ_NEXT
((
li¡–m
), field); \

578 
	`QMD_TRACE_ELEM
(&(
–m
)->
f›ld
); \

579 
	`QMD_TRACE_ELEM
(&
li¡–m
->
f›ld
); \

580 } 0)

	)

582 
	#TAILQ_INSERT_BEFORE
(
li¡–m
, 
–m
, 
f›ld
) do { \

583 
	`QMD_TAILQ_CHECK_PREV
(
li¡–m
, 
f›ld
); \

584 (
–m
)->
f›ld
.
tqe_´ev
 = (
li¡–m
)->field.tqe_prev; \

585 
	`TAILQ_NEXT
((
–m
), 
f›ld
èğ(
li¡–m
); \

586 *(
li¡–m
)->
f›ld
.
tqe_´ev
 = (
–m
); \

587 (
li¡–m
)->
f›ld
.
tqe_´ev
 = &
	`TAILQ_NEXT
((
–m
), field); \

588 
	`QMD_TRACE_ELEM
(&(
–m
)->
f›ld
); \

589 
	`QMD_TRACE_ELEM
(&
li¡–m
->
f›ld
); \

590 } 0)

	)

592 
	#TAILQ_INSERT_HEAD
(
h—d
, 
–m
, 
f›ld
) do { \

593 
	`QMD_TAILQ_CHECK_HEAD
(
h—d
, 
f›ld
); \

594 ià((
	`TAILQ_NEXT
((
–m
), 
f›ld
èğ
	`TAILQ_FIRST
((
h—d
))è!ğ
NULL
) \

595 
	`TAILQ_FIRST
((
h—d
))->
f›ld
.
tqe_´ev
 = \

596 &
	`TAILQ_NEXT
((
–m
), 
f›ld
); \

598 (
h—d
)->
tqh_Ï¡
 = &
	`TAILQ_NEXT
((
–m
), 
f›ld
); \

599 
	`TAILQ_FIRST
((
h—d
)èğ(
–m
); \

600 (
–m
)->
f›ld
.
tqe_´ev
 = &
	`TAILQ_FIRST
((
h—d
)); \

601 
	`QMD_TRACE_HEAD
(
h—d
); \

602 
	`QMD_TRACE_ELEM
(&(
–m
)->
f›ld
); \

603 } 0)

	)

605 
	#TAILQ_INSERT_TAIL
(
h—d
, 
–m
, 
f›ld
) do { \

606 
	`QMD_TAILQ_CHECK_TAIL
(
h—d
, 
f›ld
); \

607 
	`TAILQ_NEXT
((
–m
), 
f›ld
èğ
NULL
; \

608 (
–m
)->
f›ld
.
tqe_´ev
 = (
h—d
)->
tqh_Ï¡
; \

609 *(
h—d
)->
tqh_Ï¡
 = (
–m
); \

610 (
h—d
)->
tqh_Ï¡
 = &
	`TAILQ_NEXT
((
–m
), 
f›ld
); \

611 
	`QMD_TRACE_HEAD
(
h—d
); \

612 
	`QMD_TRACE_ELEM
(&(
–m
)->
f›ld
); \

613 } 0)

	)

615 
	#TAILQ_LAST
(
h—d
, 
h—dÇme
) \

616 (*(((
h—dÇme
 *)((
h—d
)->
tqh_Ï¡
))->tqh_Ï¡))

	)

618 
	#TAILQ_NEXT
(
–m
, 
f›ld
è(Ólm)->f›ld.
tqe_Ãxt
)

	)

620 
	#TAILQ_PREV
(
–m
, 
h—dÇme
, 
f›ld
) \

621 (*(((
h—dÇme
 *)((
–m
)->
f›ld
.
tqe_´ev
))->
tqh_Ï¡
))

	)

623 
	#TAILQ_REMOVE
(
h—d
, 
–m
, 
f›ld
) do { \

624 
	`QMD_SAVELINK
(
ŞdÃxt
, (
–m
)->
f›ld
.
tqe_Ãxt
); \

625 
	`QMD_SAVELINK
(
Şd´ev
, (
–m
)->
f›ld
.
tqe_´ev
); \

626 
	`QMD_TAILQ_CHECK_NEXT
(
–m
, 
f›ld
); \

627 
	`QMD_TAILQ_CHECK_PREV
(
–m
, 
f›ld
); \

628 ià((
	`TAILQ_NEXT
((
–m
), 
f›ld
)è!ğ
NULL
) \

629 
	`TAILQ_NEXT
((
–m
), 
f›ld
)->f›ld.
tqe_´ev
 = \

630 (
–m
)->
f›ld
.
tqe_´ev
; \

632 (
h—d
)->
tqh_Ï¡
 = (
–m
)->
f›ld
.
tqe_´ev
; \

633 
	`QMD_TRACE_HEAD
(
h—d
); \

635 *(
–m
)->
f›ld
.
tqe_´ev
 = 
	`TAILQ_NEXT
((elm), field); \

636 
	`TRASHIT
(*
ŞdÃxt
); \

637 
	`TRASHIT
(*
Şd´ev
); \

638 
	`QMD_TRACE_ELEM
(&(
–m
)->
f›ld
); \

639 } 0)

	)

641 
	#TAILQ_SWAP
(
h—d1
, 
h—d2
, 
ty³
, 
f›ld
) do { \

642 
ty³
 *
sw­_fœ¡
 = (
h—d1
)->
tqh_fœ¡
; \

643 
ty³
 **
sw­_Ï¡
 = (
h—d1
)->
tqh_Ï¡
; \

644 (
h—d1
)->
tqh_fœ¡
 = (
h—d2
)->tqh_first; \

645 (
h—d1
)->
tqh_Ï¡
 = (
h—d2
)->tqh_last; \

646 (
h—d2
)->
tqh_fœ¡
 = 
sw­_fœ¡
; \

647 (
h—d2
)->
tqh_Ï¡
 = 
sw­_Ï¡
; \

648 ià((
sw­_fœ¡
 = (
h—d1
)->
tqh_fœ¡
è!ğ
NULL
) \

649 
sw­_fœ¡
->
f›ld
.
tqe_´ev
 = &(
h—d1
)->
tqh_fœ¡
; \

651 (
h—d1
)->
tqh_Ï¡
 = &(h—d1)->
tqh_fœ¡
; \

652 ià((
sw­_fœ¡
 = (
h—d2
)->
tqh_fœ¡
è!ğ
NULL
) \

653 
sw­_fœ¡
->
f›ld
.
tqe_´ev
 = &(
h—d2
)->
tqh_fœ¡
; \

655 (
h—d2
)->
tqh_Ï¡
 = &(h—d2)->
tqh_fœ¡
; \

656 } 0)

	)

	@frcore/frcore_rfc.c

2 
	~<¡dlib.h
>

3 
	~<¡dio.h
>

4 
	~"äcÜe_rfc.h
"

6 
šlše
 
ušt16_t
 
aş_g‘_gid_by_ruËid
(
ušt8_t
 
aşgid
, ušt16_ˆ
ruËid
);

7 
acsm_g‘_aş_sm
(
aşgid
, 
gid
);

12 
	$S‘BmpB™
(*
tbmp
,
i
, 
rfcboŞ
 
v®ue
)

14 
k
,
pos
;

15 
k
 = 
SIZE
-1 - (
i
/
LENGTH
);

16 
pos
 = 
i
 % 
LENGTH
;

17 
‹mpIÁ
 = 1;

18 
‹mpIÁ
 <<ğ
pos
;

19 ià(
v®ue
 =ğ
RFCTRUE
)

20 
tbmp
[
k
] |ğ
‹mpIÁ
;

22 
‹mpIÁ
 = ~tempInt;

23 
tbmp
[
k
] &ğ
‹mpIÁ
;

25 
	}
}

30 
	$In™Li¡Eqs
(
LISTEqS
 *
±¾i¡Eqs
)

32 
±¾i¡Eqs
->
nCES
 = 0;

33 
	}
}

37 
rfcboŞ
 
	$Com·»Bmp
(*
abmp
, *
bbmp
)

39 
i
;

40 ifĞ(
abmp
 =ğ
NULL
è|| (
bbmp
 == NULL) )

41  
RFCFALSE
;

43 
i
=0;i<
SIZE
;i++)

44 ifĞ(*(
abmp
+
i
)è!ğ(*(
bbmp
+i)) )

45  
RFCFALSE
;

46  
RFCTRUE
;

47 
	}
}

53 
	$S—rchBmp
(
LISTEqS
 *
±¾i¡Eqs
,*
tbmp
)

55 
i
;

56 
CES
 *
tCES
;

58 
tCES
 = &
±¾i¡Eqs
->
ûs
[0];

59 
i
=0;i<
±¾i¡Eqs
->
nCES
;i++){

60 if(
	`Com·»Bmp
(
tCES
->
cbm
,
tbmp
)){

61  
i
;

65 
tCES
 = &
±¾i¡Eqs
->
ûs
[
i
 + 1];

68 
	}
}

73 
	$AddLi¡EqsCES
(
LISTEqS
 *
±¾i¡Eqs
,*
tbmp
)

75 
i
;

78 if(
±¾i¡Eqs
->
nCES
 == 0){

81 
±¾i¡Eqs
->
ûs
[0].
eqID
 = 0;

82 
i
=0;i<
SIZE
;i++)

83 
±¾i¡Eqs
->
ûs
[0].
cbm
[
i
] = 
tbmp
[i];

86 
±¾i¡Eqs
->
nCES
 = 1;

91 
±¾i¡Eqs
->
ûs
[±¾i¡Eqs->
nCES
].
eqID
 =…trlistEqs->nCES;

93 
i
=0;i<
SIZE
;i++)

94 
±¾i¡Eqs
->
ûs
[±¾i¡Eqs->
nCES
].
cbm
[
i
] = 
tbmp
[i];

97 
±¾i¡Eqs
->
nCES
++;

99  
±¾i¡Eqs
->
nCES
 -1 ;

100 
	}
}

106 
	$G‘RuËCo¡
(*
tbmp
)

108 
k
, 
pos
;

109 
‹mpIÁ
;

110 
‹mpV®ue
;

111 
k
=
SIZE
-1;k>=0;k--){

113 
‹mpIÁ
 = 1;

115 
pos
=0;…o < 
LENGTH
;…os++){

117 
‹mpV®ue
 = 
tbmp
[
k
] & 
‹mpIÁ
;

118 ifĞ
‹mpV®ue
 )

119  ( 
LENGTH
*(
SIZE
-1-
k
è+ 
pos
 );

120 
‹mpIÁ
 <<= 1;

125  
MPP_MAX_FILTERS
 - 1;

126 
	}
}

128 
	$£t_ft_sync
(
FILTSET
 *
ft£t
)

130 
i
;

131 
i
=0;i<()
ft£t
->
numF‹rs
;i++){

132 if(
ACL_ENABLE
 !ğ
ft£t
->
ftA¼
[
i
].
¡©e
)

133 
ft£t
->
ftA¼
[
i
].
sync
 = 
ACL_NOSYNC
;

135 
ft£t
->
ftA¼
[
i
].
sync
 = 
ACL_SYNC
;

137 
	}
}

140 
	$S‘Pha£0_C–l
(
Pnode
 *
pha£0_Nodes
, 
FILTSET
 *
ft£t
)

142 
i
, 
n
, 
com
;

143 
j
;

145 
com
=0;com<7;com++){

147 
bmp
[
SIZE
];

150 
j
=0;j<
SIZE
;j++)

151 
bmp
[
j
] = 0;

154 
	`In™Li¡Eqs
(&
pha£0_Nodes
[
com
].
li¡Eqs
);

157 
n
=0;n<65536;n++){

159 
‹mp¡¬t
,
‹m³nd
;

160 
‹m³qID
;

163 
i
=0;i<
ft£t
->
numF‹rs
;i++){

165 if(
ACL_ENABLE
 !ğ
ft£t
->
ftA¼
[
i
].
¡©e
)

168 
‹mp¡¬t
 = 
ft£t
->
ftA¼
[
i
].
dim
[
com
][0];

169 
‹m³nd
 = 
ft£t
->
ftA¼
[
i
].
dim
[
com
][1];

171 if(
‹mp¡¬t
 =ğ
n
)

172 
	`S‘BmpB™
(
bmp
,
i
,
RFCTRUE
);

173 ifĞ(
‹m³nd
+1è=ğ
n
)

174 
	`S‘BmpB™
(
bmp
,
i
,
RFCFALSE
);

179 
‹m³qID
 = 
	`S—rchBmp
(&
pha£0_Nodes
[
com
].
li¡Eqs
,
bmp
);

182 ià(-1 =ğ
‹m³qID
){

183 
‹m³qID
 = 
	`AddLi¡EqsCES
(&
pha£0_Nodes
[
com
].
li¡Eqs
,
bmp
);

187 
pha£0_Nodes
[
com
].
ûÎ
[
n
] = 
‹m³qID
;

190 
	`£t_ft_sync
(
ft£t
);

191  
ACL_OK
;

192 
	}
}

193 #ifdeà 
RFC3_DEBUG


195 
	$FšdOrd”
(
Pnode
 *
pha£0_Nodes
, 
ušt8_t
 *
dÙ
)

197 
rfcboŞ
 
æag
;

198 
i
, 
j
, 
m
;

199 
m
=0;m<6;m++)

200 
dÙ
[
m
] = m;

202 
tid
[6];

203 
tid
[0]=0;tid[0]<1;tid[0]++){

204 
tid
[1]=tid[0]+1;tid[1]<5;tid[1]++){

205 
tid
[2]=tid[1]+1;tid[2]<6;tid[2]++){

208 
i
=3;i<6;i++){

209 
tid
[
i
]=0;tid[i]<6;tid[i]++){

210 
æag
 = 1;

211 
j
=0;j<
i
;j++)

212 if(
tid
[
j
] =ğtid[
i
]){

213 
æag
 = 0;

216 if(
æag
 == 1)

222 ifĞ(
pha£0_Nodes
[
tid
[0]].
li¡Eqs
.
nCES
 *…hase0_Nodes[tid[1]].listEqs.nCES *…hase0_Nodes[tid[2]].listEqs.nCES

223 +
pha£0_Nodes
[
tid
[3]].
li¡Eqs
.
nCES
 *…hase0_Nodes[tid[4]].listEqs.nCES *…hase0_Nodes[tid[5]].listEqs.nCES)

224 < (
pha£0_Nodes
[
dÙ
[0]].
li¡Eqs
.
nCES
 *…hase0_Nodes[dot[1]].listEqs.nCES *…hase0_Nodes[dot[2]].listEqs.nCES

225 +
pha£0_Nodes
[
dÙ
[3]].
li¡Eqs
.
nCES
 *…hase0_Nodes[dot[4]].listEqs.nCES *…hase0_Nodes[dot[5]].listEqs.nCES) ){

227 
i
=0;i<6;i++)

228 
dÙ
[
i
] = 
tid
[i];

234 
	}
}

239 
	$S‘Pha£1_C–l
(
Pnode
 *
pha£0_Nodes
, 
Pnod”
 *
pha£1_Nodes
, 
ušt8_t
 *
dÙ
)

241 
Pnode
 *
Šode1
, *
Šode2
, *
Šode3
, *
Šode4
;

242 
com
, 
i
, 
j
, 
k
, 
m
, 
w
;

244 
	`FšdOrd”
(
pha£0_Nodes
, 
dÙ
);

253 
com
=0;com<2;com++){

254 
šdx
 = 0;

255 
‹m³qID
;

258 
	`In™Li¡Eqs
(&
pha£1_Nodes
[
com
].
li¡Eqs
);

261 
com
) {

263 
Šode1
 = &
pha£0_Nodes
[
dÙ
[0]];

264 
Šode2
 = &
pha£0_Nodes
[
dÙ
[1]];

265 
Šode3
 = &
pha£0_Nodes
[
dÙ
[2]];

266 
Šode4
 = &
pha£0_Nodes
[6];

269 
Šode1
 = &
pha£0_Nodes
[
dÙ
[3]];

270 
Šode2
 = &
pha£0_Nodes
[
dÙ
[4]];

271 
Šode3
 = &
pha£0_Nodes
[
dÙ
[5]];

278 
ûÎNum
;

279 if(
com
 == 0){

280 
ûÎNum
 = 
Šode1
->
li¡Eqs
.
nCES
 * 
Šode2
->li¡Eqs.nCES * 
Šode3
->li¡Eqs.nCES * 
Šode4
->listEqs.nCES;

281 
	`´štf
("Šode4->li¡Eqs.nCES = %u\n", 
Šode4
->
li¡Eqs
.
nCES
);

283 if(
com
 == 1)

284 
ûÎNum
 = 
Šode1
->
li¡Eqs
.
nCES
 * 
Šode2
->li¡Eqs.nCES * 
Šode3
->listEqs.nCES;

285 
pha£1_Nodes
[
com
].
nûÎs
 = 
ûÎNum
;

288 
CES
 *
tCES1
, *
tCES2
, *
tCES3
, *
tCES4
;

289 
š‹r£ùedBmp
[
SIZE
];

291 
i
=0;i<
Šode1
->
li¡Eqs
.
nCES
;i++){

292 
tCES1
 = &
Šode1
->
li¡Eqs
.
ûs
[
i
];

293 
j
=0;j<
Šode2
->
li¡Eqs
.
nCES
;j++){

294 
tCES2
 = &
Šode2
->
li¡Eqs
.
ûs
[
j
];

295 
k
=0;k<
Šode3
->
li¡Eqs
.
nCES
;k++){

296 
tCES3
 = &
Šode3
->
li¡Eqs
.
ûs
[
k
];

297 if(
com
 == 0)

299 
w
 = 0; w < 
Šode4
->
li¡Eqs
.
nCES
; w++)

301 
tCES4
 = &
Šode4
->
li¡Eqs
.
ûs
[
w
];

302 
m
=0;m<
SIZE
;m++)

303 
š‹r£ùedBmp
[
m
] = 
tCES1
->
cbm
[m] & 
tCES2
->cbm[m] & 
tCES3
->cbm[m] & 
tCES4
->cbm[m];

305 
‹m³qID
 = 
	`S—rchBmp
(&
pha£1_Nodes
[
com
].
li¡Eqs
,
š‹r£ùedBmp
);

306 ià(-1 =ğ
‹m³qID
)

307 
‹m³qID
 = 
	`AddLi¡EqsCES
(&
pha£1_Nodes
[
com
].
li¡Eqs
,
š‹r£ùedBmp
);

308 
pha£1_Nodes
[
com
].
ûÎ
[
šdx
] = 
‹m³qID
;

309 
šdx
++;

313 if(
com
 == 1)

316 
m
=0;m<
SIZE
;m++)

317 
š‹r£ùedBmp
[
m
] = 
tCES1
->
cbm
[m] & 
tCES2
->cbm[m] & 
tCES3
->cbm[m];

321 
‹m³qID
 = 
	`S—rchBmp
(&
pha£1_Nodes
[
com
].
li¡Eqs
,
š‹r£ùedBmp
);

323 ià(-1 =ğ
‹m³qID
){

324 
‹m³qID
 = 
	`AddLi¡EqsCES
(&
pha£1_Nodes
[
com
].
li¡Eqs
,
š‹r£ùedBmp
);

327 
pha£1_Nodes
[
com
].
ûÎ
[
šdx
] = 
‹m³qID
;

328 
šdx
++;

335 
	`´štf
("**************************pha£1_Nodes[%d].nûÎ ğ%d couÁ = %d\n", 
com
, 
ûÎNum
, 
šdx
);

337 
	}
}

342 
	$S‘Pha£2_C–l
(
Pnod”
 *
pha£1_Nodes
, Pnod” *
pha£2_Node
)

344 
šdx
 = 0;

345 
Pnod”
 *
Šode1
, *
Šode2
;

346 
CES
 *
tCES1
, *
tCES2
;

347 
’dBmp
[
SIZE
];

348 
co¡
;

349 
i
, 
j
, 
m
;

351 
Šode1
 = &
pha£1_Nodes
[0];

352 
Šode2
 = &
pha£1_Nodes
[1];

356 
	`In™Li¡Eqs
(&
pha£2_Node
->
li¡Eqs
);

359 
ûÎNum
;

360 
ûÎNum
 = 
Šode1
->
li¡Eqs
.
nCES
 * 
Šode2
->listEqs.nCES;

361 
pha£2_Node
->
nûÎs
 = 
ûÎNum
;

363 
i
=0;i<
Šode1
->
li¡Eqs
.
nCES
;i++){

364 
tCES1
 = &
Šode1
->
li¡Eqs
.
ûs
[
i
];

366 
j
=0;j<
Šode2
->
li¡Eqs
.
nCES
;j++){

367 
tCES2
 = &
Šode2
->
li¡Eqs
.
ûs
[
j
];

370 
m
=0;m<
SIZE
;m++)

371 
’dBmp
[
m
] = 
tCES1
->
cbm
[m] & 
tCES2
->cbm[m];

374 
co¡
 = 
	`G‘RuËCo¡
(
’dBmp
);

377 
pha£2_Node
->
ûÎ
[
šdx
] = 
co¡
;

378 
šdx
++;

381 
	`´štf
("Pha£2 index = %d\n", 
šdx
);

382 
	}
}

384 #ifdeà
RFC4_DEBUG


385 
	$S‘Pha£1_C–l
(
Pnode
 *
pha£0_Nodes
, 
Pnod”
 *
pha£1_Nodes
)

387 
Pnode
 *
Šode1
 = 
NULL
, *
Šode2
 = NULL;

388 
com
, 
i
, 
j
, 
m
;

391 
com
=0;com<3;com++){

392 
šdx
 = 0;

393 
‹m³qID
;

396 
	`In™Li¡Eqs
(&
pha£1_Nodes
[
com
].
li¡Eqs
);

399 
com
) {

401 
Šode1
 = &
pha£0_Nodes
[0];

402 
Šode2
 = &
pha£0_Nodes
[1];

405 
Šode1
 = &
pha£0_Nodes
[2];

406 
Šode2
 = &
pha£0_Nodes
[3];

409 
Šode1
 = &
pha£0_Nodes
[4];

410 
Šode2
 = &
pha£0_Nodes
[5];

420 
ûÎNum
;

421 
ûÎNum
 = 
Šode1
->
li¡Eqs
.
nCES
 * 
Šode2
->listEqs.nCES;

422 if(
ûÎNum
 > 
ACL_MAX_CELL
)

423  
ACL_ERROR
;

424 
pha£1_Nodes
[
com
].
nûÎs
 = 
ûÎNum
;

427 
CES
 *
tCES1
, *
tCES2
;

428 
š‹r£ùedBmp
[
SIZE
];

430 
i
=0;i<
Šode1
->
li¡Eqs
.
nCES
;i++){

431 
tCES1
 = &
Šode1
->
li¡Eqs
.
ûs
[
i
];

432 
j
=0;j<
Šode2
->
li¡Eqs
.
nCES
;j++){

433 
tCES2
 = &
Šode2
->
li¡Eqs
.
ûs
[
j
];

434 
m
=0;m<
SIZE
;m++)

435 
š‹r£ùedBmp
[
m
] = 
tCES1
->
cbm
[m] & 
tCES2
->cbm[m];

437 
‹m³qID
 = 
	`S—rchBmp
(&
pha£1_Nodes
[
com
].
li¡Eqs
,
š‹r£ùedBmp
);

438 ià(-1 =ğ
‹m³qID
)

439 
‹m³qID
 = 
	`AddLi¡EqsCES
(&
pha£1_Nodes
[
com
].
li¡Eqs
,
š‹r£ùedBmp
);

440 
pha£1_Nodes
[
com
].
ûÎ
[
šdx
] = 
‹m³qID
;

441 
šdx
++;

448  
ACL_OK
;

449 
	}
}

450 
	$S‘Pha£2_C–l
(
Pnode
 *
pha£0_Nodes
, 
Pnod”
 *
pha£1_Nodes
, Pnod” *
pha£2_Nodes
)

452 
Pnode
 *
Šode4
 = 
NULL
;

453 
Pnod”
 *
Šode1
 = 
NULL
, *
Šode2
 = NULL, *
Šode3
 = NULL;

454 
com
, 
i
, 
j
, 
m
;

459 
com
=0;com<2;com++){

460 
šdx
 = 0;

461 
‹m³qID
;

464 
	`In™Li¡Eqs
(&
pha£2_Nodes
[
com
].
li¡Eqs
);

467 
com
) {

469 
Šode1
 = &
pha£1_Nodes
[0];

470 
Šode2
 = &
pha£1_Nodes
[1];

473 
Šode3
 = &
pha£1_Nodes
[2];

474 
Šode4
 = &
pha£0_Nodes
[6];

490 
ûÎNum
;

491 if(0 =ğ
com
){

492 
ûÎNum
 = 
Šode1
->
li¡Eqs
.
nCES
 * 
Šode2
->listEqs.nCES;

494 if(1 =ğ
com
){

495 
ûÎNum
 = 
Šode3
->
li¡Eqs
.
nCES
 * 
Šode4
->listEqs.nCES;

497 if(
ûÎNum
 > 
ACL_MAX_CELL
)

498  
ACL_ERROR
;

499 
pha£2_Nodes
[
com
].
nûÎs
 = 
ûÎNum
;

501 
CES
 *
tCES1
, *
tCES2
;

502 
š‹r£ùedBmp
[
SIZE
];

503 if(0 =ğ
com
){

504 
i
 = 0; i < 
Šode1
->
li¡Eqs
.
nCES
; i++){

505 
tCES1
 = &
Šode1
->
li¡Eqs
.
ûs
[
i
];

507 
j
 = 0; j < 
Šode2
->
li¡Eqs
.
nCES
; j++){

508 
tCES2
 = &
Šode2
->
li¡Eqs
.
ûs
[
j
];

509 
m
=0;m<
SIZE
;m++)

510 
š‹r£ùedBmp
[
m
] = 
tCES1
->
cbm
[m] & 
tCES2
->cbm[m];

512 
‹m³qID
 = 
	`S—rchBmp
(&
pha£2_Nodes
[
com
].
li¡Eqs
,
š‹r£ùedBmp
);

513 ià(-1 =ğ
‹m³qID
)

514 
‹m³qID
 = 
	`AddLi¡EqsCES
(&
pha£2_Nodes
[
com
].
li¡Eqs
,
š‹r£ùedBmp
);

515 
pha£2_Nodes
[
com
].
ûÎ
[
šdx
] = 
‹m³qID
;

516 
šdx
++;

520 if(1 =ğ
com
){

521 
i
 = 0; i < 
Šode3
->
li¡Eqs
.
nCES
; i++){

522 
tCES1
 = &
Šode3
->
li¡Eqs
.
ûs
[
i
];

524 
j
 = 0; j < 
Šode4
->
li¡Eqs
.
nCES
; j++){

525 
tCES2
 = &
Šode4
->
li¡Eqs
.
ûs
[
j
];

526 
m
=0;m<
SIZE
;m++)

527 
š‹r£ùedBmp
[
m
] = 
tCES1
->
cbm
[m] & 
tCES2
->cbm[m];

529 
‹m³qID
 = 
	`S—rchBmp
(&
pha£2_Nodes
[
com
].
li¡Eqs
,
š‹r£ùedBmp
);

530 ià(-1 =ğ
‹m³qID
)

531 
‹m³qID
 = 
	`AddLi¡EqsCES
(&
pha£2_Nodes
[
com
].
li¡Eqs
,
š‹r£ùedBmp
);

532 
pha£2_Nodes
[
com
].
ûÎ
[
šdx
] = 
‹m³qID
;

533 
šdx
++;

539  
ACL_OK
;

540 
	}
}

543 
	$S‘Pha£3_C–l
(
ušt8_t
 
aşgid
, 
Pnod”
 *
pha£2_Nodes
, Pnod” *
pha£3_Node
)

545 
šdx
 = 0;

546 
Pnod”
 *
Šode1
, *
Šode2
;

547 
CES
 *
tCES1
, *
tCES2
;

548 
’dBmp
[
SIZE
];

549 
št32_t
 
co¡
;

552 
i
, 
j
, 
m
;

554 
Šode1
 = &
pha£2_Nodes
[0];

555 
Šode2
 = &
pha£2_Nodes
[1];

559 
	`In™Li¡Eqs
(&
pha£3_Node
->
li¡Eqs
);

562 
ûÎNum
;

563 
ûÎNum
 = 
Šode1
->
li¡Eqs
.
nCES
 * 
Šode2
->listEqs.nCES;

564 if(
ûÎNum
 > 
ACL_MAX_CELL
)

565  
ACL_ERROR
;

566 
pha£3_Node
->
nûÎs
 = 
ûÎNum
;

568 
i
=0;i<
Šode1
->
li¡Eqs
.
nCES
;i++){

569 
tCES1
 = &
Šode1
->
li¡Eqs
.
ûs
[
i
];

571 
j
=0;j<
Šode2
->
li¡Eqs
.
nCES
;j++){

572 
tCES2
 = &
Šode2
->
li¡Eqs
.
ûs
[
j
];

575 
m
=0;m<
SIZE
;m++)

576 
’dBmp
[
m
] = 
tCES1
->
cbm
[m] & 
tCES2
->cbm[m];

579 
co¡
 = 
	`G‘RuËCo¡
(
’dBmp
);

581 
co¡
 = 
	`aş_g‘_gid_by_ruËid
(
aşgid
, cost);

589 
pha£3_Node
->
ûÎ
[
šdx
] = 
co¡
;

590 
šdx
++;

594  
ACL_OK
;

595 
	}
}

	@frcore/frcore_rfc.h

2 #iâdeà
_FRCORE_RFCPHASE_H_


3 
	#_FRCORE_RFCPHASE_H_


	)

5 
	~<¡dšt.h
>

6 
	~"äcÜe_cÚfig.h
"

9 
	#RFC4_DEBUG
 1

	)

11 
	#RFCTRUE
 1

	)

12 
	#RFCFALSE
 0

	)

13 
	#SUCCESS
 1

	)

14 
	#LENGTH
 32

16 
	#SIZE
 64

17 

	)

18 
	#ACL_ENABLE
 2

	)

19 
	#ACL_DISABLE
 1

	)

20 
	#ACL_UNSET
 0

	)

22 
	#ACL_ERROR
 -1

	)

23 
	#ACL_OK
 1

	)

25 
	#ACL_SYNC
 1

	)

26 
	#ACL_NOSYNC
 0

	)

27 
	#ACL_MAX_CELL
 1000000

	)

29 
	#MPP_MAX_RFC_STAT
 (
MPP_MAX_FILTERS
*
MPP_MAX_ACSM_NUM
)

	)

31 
	#MPP_ACL_SM_DEFAULT_VALUE
 0

	)

33 
	trfcboŞ
;

38 
	sFILTER


41 
	mco¡
;

43 
ušt8_t
 
	msync
;

44 
ušt8_t
 
	m¡©e
;

45 
ušt16_t
 
	mİ
;

46 
ušt16_t
 
	maùiÚ
;

47 
ušt16_t
 
	mruË_ty³
;

48 
ušt16_t
 
	mruË_sourû
;

50 
	mdim
[7][2];

53 
	sFILTSET


55 
	mnumF‹rs
;

56 
FILTER
 
	mftA¼
[
MPP_MAX_FILTERS
];

57 
št64_t
 
	mpkt_num
[
MPP_MAX_RFC_STAT
];

58 
št64_t
 
	mpkt_by‹s
[
MPP_MAX_RFC_STAT
];

62 
	sPACKAGE


64 
	mhighSIP
[2];

65 
	mlowSIP
[2];

66 
	mhighDIP
[2];

67 
	mlowDIP
[2];

68 
	msPÜt
;

69 
	mdPÜt
;

71 
	m´ÙocŞ
;

73 
	mdim
[7];

77 
	sCES


79 
	meqID
;

80 
	mcbm
[
SIZE
];

81 }
	tCES
;

84 
	sLISTEqS


86 
	mnCES
;

87 
CES
 
	mûs
[
MPP_MAX_FILTERS
];

90 }
	tLISTEqS
;

93 
	sPNODE


95 
	mûÎ
[65536];

96 
LISTEqS
 
	mli¡Eqs
;

97 }
	tPnode
;

100 
	sPNODER


102 
	mnûÎs
;

105 
ušt16_t
 
	mûÎ
[
ACL_MAX_CELL
];

106 
LISTEqS
 
	mli¡Eqs
;

107 }
	tPnod”
;

110 
S‘BmpB™
(*
tbmp
,
i
, 
rfcboŞ
 
v®ue
);

113 
In™Li¡Eqs
(
LISTEqS
 *
±¾i¡Eqs
);

116 
rfcboŞ
 
Com·»Bmp
(*
abmp
, *
bbmp
);

119 
S—rchBmp
(
LISTEqS
 *
±¾i¡Eqs
,*
tbmp
);

122 
AddLi¡EqsCES
(
LISTEqS
 *
±¾i¡Eqs
,*
tbmp
);

125 
G‘RuËCo¡
(*
tbmp
);

128 
F»eLi¡Eqs
(
LISTEqS
 *
±¾i¡Eqs
);

130 #ifdeà
RFC3_DEBUG


132 
S‘Pha£0_C–l
(
Pnode
 *
pha£0_Nodes
, 
FILTSET
 *
ft£t
);

133 
FšdOrd”
(
Pnode
 *
pha£0_Nodes
, 
ušt8_t
 *
dÙ
);

135 
S‘Pha£1_C–l
(
Pnode
 *
pha£0_Nodes
, 
Pnod”
 *
pha£1_Nodes
, 
ušt8_t
 *
dÙ
);

137 
S‘Pha£2_C–l
(
Pnod”
 *
pha£1_Nodes
, Pnod” *
pha£2_Nodes
);

140 #ifdeà
RFC4_DEBUG


141 
S‘Pha£0_C–l
(
Pnode
 *
pha£0_Nodes
, 
FILTSET
 *
ft£t
);

142 
S‘Pha£1_C–l
(
Pnode
 *
pha£0_Nodes
, 
Pnod”
 *
pha£1_Nodes
);

143 
S‘Pha£2_C–l
(
Pnode
 *
pha£0_Nodes
, 
Pnod”
 *
pha£1_Nodes
, Pnod” *
pha£2_Nodes
);

144 
S‘Pha£3_C–l
(
ušt8_t
 
aşgid
, 
Pnod”
 *
pha£2_Nodes
, Pnod” *
pha£3_Node
);

	@frcore/frcore_rule.c

1 
	~"äcÜe.h
"

2 
	~"äcÜe_cmd.h
"

3 
	~"äcÜe_misc.h
"

4 
	~"äc_·ck.h
"

5 
	~"äcÜe_´Ùo.h
"

6 
	~"cvmx-mdio.h
"

7 
	~"äcÜe_š™.h
"

8 
	~"äcÜe_aş.h
"

9 
	~"äcÜe_pkt.h
"

10 
	~"äc_ty³s.h
"

11 
	~"äcÜe_¡©.h
"

12 
	~"äcÜe_chª.h
"

14 #ià
FRC_CONFIG_RULE


15 
CVMX_SHARED
 
ušt8_t
 
	gruË_’abË
 = 0;

17 
	$äcÜe_cmd_ruË_’abË
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

19 
ušt8_t
 *
’abË
 = (ušt8_ˆ*)
·¿m
;

20 
ruË_’abË
 = *
’abË
;

21 
	`FRCORE_RULE
("===========================================================\n");

24  
FRE_SUCCESS
;

25 
	}
}

27 
	$äcÜe_cmd_ruË_¡©us_g‘
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

29 
ušt8_t
 
’abË
;

30 
’abË
 = 
ruË_’abË
;

31 
	`memıy
(
outbuf
, &
’abË
, 1);

32 *
Ş’
 = 1;

34  
FRE_SUCCESS
;

35 
	}
}

37 
	$äcÜe_cmd_ruË_add
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

39 
äc_ruË_t
 *
ruË
 = (äc_ruË_ˆ*)
·¿m
;

41 
	`FRCORE_RULE
("===========================================================\n");

42 
	`FRCORE_RULE
("s = 0x%x\n", 
ruË
->
s
);

43 
	`FRCORE_RULE
("d = 0x%x\n", 
ruË
->
d
);

44 
	`FRCORE_RULE
("¥ = %d\n", 
ruË
->
¥
);

45 
	`FRCORE_RULE
("d°ğ%d\n", 
ruË
->
dp
);

46 
	`FRCORE_RULE
("´ÙØğ%d\n", 
ruË
->
´Ùo
);

47 
	`FRCORE_RULE
("šdex = %d\n", 
ruË
->
šdex
);

48 
	`FRCORE_RULE
("ruË_sourû = %d\n", 
ruË
->
ruË_sourû
);

49 
	`FRCORE_RULE
("ruË_ty³ = %d\n", 
ruË
->
ruË_ty³
);

50 
	`FRCORE_RULE
("aùiÚ = %d\n", 
ruË
->
aùiÚ
);

51 
	`FRCORE_RULE
("İ = %d\n", 
ruË
->
İ
);

53 #iâdeà
FRCORE_ACL_API_INTERFACE


54 
ušt16_t
 
rg‘id
=1;

55 
s
[20] = {0}, 
d
[20] = {0}, 
¥
[20] = {0}, 
dp
[20] = {0}, 
´ÙocŞ
[20] = {0};

56 
	`memıy
(
s
, "192.168.0.1 ", 20);

57 
	`memıy
(
d
, "10.0.0.1 ", 20);

58 
	`memıy
(
¥
, "30-50 ", 20);

59 
	`memıy
(
dp
, "30-50 ", 20);

60 
	`memıy
(
´ÙocŞ
, "17 ", 20);

61 
	`aş_£tf‹r
(0, 
rg‘id
, 
s
, 
d
, 
¥
, 
dp
, 
´ÙocŞ
);

64 
rg‘id
=2;

65 
	`memıy
(
s
, "192.168.0.2 ", 20);

66 
	`memıy
(
d
, "10.0.0.1 ", 20);

67 
	`memıy
(
¥
, "30-50 ", 20);

68 
	`memıy
(
dp
, "30-50 ", 20);

69 
	`memıy
(
´ÙocŞ
, "17 ", 20);

70 
	`aş_£tf‹r
(0, 
rg‘id
, 
s
, 
d
, 
¥
, 
dp
, 
´ÙocŞ
);

73 
	`aş_£tf‹r
(0, 
ruË
->
šdex
,„uË->
s
,„uË->
d
,„uË->
¥
,„uË->
dp
,„uË->
´Ùo
,

74 
ruË
->
İ
,„uË->
aùiÚ
,„uË->
ruË_ty³
,„uË->
ruË_sourû
);

77  
FRE_SUCCESS
;

79 
	}
}

81 
	$äcÜe_cmd_ruË_d–
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

83 
i
, 
rv
 = 0;

84 
ušt16_t
 
num
 = 0;

85 
äc_ruË_İ_š_t
 *
d–
 = (äc_ruË_İ_š_ˆ*)
·¿m
;

87 
ušt16_t
 
gid
;

88 
	`FRCORE_RULE
("===========================================================\n");

89 
	`FRCORE_RULE
("šdex = %d\n", 
d–
->
šdex
);

90 
	`FRCORE_RULE
("num = %d\n", 
d–
->
num
);

92 
gid
 = 
d–
->
šdex
;

93 
i
 = 0; i < ()
d–
->
num
; i++)

95 
rv
 = 
	`aş_D–‘eOÃF‹r_by_gid
(0, 
gid
+
i
);

96 ià(!
rv
)

98 
num
++;

101 *((
ušt16_t
 *è
outbuf
èğ
num
;

103  
rv
;

105 
	}
}

107 
	$äcÜe_cmd_ruË_ş—r_®l
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

109 
i
, 
rv
;

110 
äc_ruË_İ_š_t
 *
d–
 = (äc_ruË_İ_š_ˆ*)
·¿m
;

111 
ušt16_t
 
num
;

113 
ušt16_t
 
gid
;

114 
	`FRCORE_RULE
("===========================================================\n");

115 
	`FRCORE_RULE
("šdex = %d\n", 
d–
->
šdex
);

116 
	`FRCORE_RULE
("num = %d\n", 
d–
->
num
);

118 
num
 = 
	`aş_g‘f‹r_couÁ
(0);

119 
gid
 = 
d–
->
šdex
;

120 
i
 = 0; i < ()
d–
->
num
; i++)

122 
rv
 = 
	`aş_D–‘eOÃF‹r_by_gid
(0, 
gid
+
i
);

124 ià(!
	`aş_g‘f‹r_couÁ
(0))

126 *((
ušt16_t
 *è
outbuf
èğ
num
;

128 
	`FRCORE_RULE
("num = %d\n", 
	`aş_g‘f‹r_couÁ
(0));

129  
FRE_FAIL
;

132  
FRE_SUCCESS
;

134 
	}
}

136 
	$äcÜe_cmd_ruË_upd©e
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

138 
rv
;

142 
	`FRCORE_RULE
("===========================================================\n");

143 
	`FRCORE_RULE
("update„ule.\n");

144 
rv
 = 
	`´e_aş_lookup_by_tu¶e
(0);

145 ià(
rv
)

147 
	`´štf
("% rv=%d\n", 
__func__
, 
rv
);

150  
rv
;

152 
	}
}

154 
	$äcÜe_cmd_ruË_¡©_g‘
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

156 
äc_ruË_İ_š_t
 *
šput
 = (äc_ruË_İ_š_ˆ*)
·¿m
;

157 
äc_ruË_¡©_out_t
 
ouut
;

159 
	`FRCORE_RULE
("===========================================================\n");

160 
	`FRCORE_RULE
("šdex = %d\n", 
šput
->
šdex
);

161 
	`FRCORE_RULE
("num = %d\n", 
šput
->
num
);

162 #iâdeà
FRCORE_ACL_API_INTERFACE


163 
	`mem£t
(&
ouut
, 0, (
äc_ruË_¡©_out_t
));

164 
ouut
.
num
 = 
šput
->num;

165 
ouut
.
ruË_¡©
[0].
ruË
.
s
 = 0xca000001;

166 
ouut
.
ruË_¡©
[0].
ruË
.
d
 = 0xca000002;

167 
ouut
.
ruË_¡©
[0].
ruË
.
¥
 = 435;

168 
ouut
.
ruË_¡©
[0].
ruË
.
dp
 = 526;

169 
ouut
.
ruË_¡©
[0].
ruË
.
´Ùo
 = 0x11;

170 
ouut
.
ruË_¡©
[0].
ruË
.
šdex
 = 
šput
->index;

171 
ouut
.
ruË_¡©
[0].
ruË
.
ruË_sourû
 = 4;

172 
ouut
.
ruË_¡©
[0].
ruË
.
ruË_ty³
 = 5;

173 
ouut
.
ruË_¡©
[0].
ruË
.
aùiÚ
 = 1;

174 
ouut
.
ruË_¡©
[0].
ruË
.
İ
 = 2;

175 
ouut
.
ruË_¡©
[0].
¡©
.
pkts
 = 400;

176 
ouut
.
ruË_¡©
[0].
¡©
.
by‹s
 = 50000;

178 
ouut
.
ruË_¡©
[1].
ruË
.
s
 = 0xc0000003;

179 
ouut
.
ruË_¡©
[1].
ruË
.
d
 = 0xca000004;

180 
ouut
.
ruË_¡©
[1].
ruË
.
¥
 = 676;

181 
ouut
.
ruË_¡©
[1].
ruË
.
dp
 = 787;

182 
ouut
.
ruË_¡©
[1].
ruË
.
´Ùo
 = 0x6;

183 
ouut
.
ruË_¡©
[1].
ruË
.
šdex
 = 
šput
->index + 1;

184 
ouut
.
ruË_¡©
[1].
ruË
.
ruË_sourû
 = 6;

185 
ouut
.
ruË_¡©
[1].
ruË
.
ruË_ty³
 = 7;

186 
ouut
.
ruË_¡©
[1].
ruË
.
aùiÚ
 = 8;

187 
ouut
.
ruË_¡©
[1].
ruË
.
İ
 = 9;

188 
ouut
.
ruË_¡©
[1].
¡©
.
pkts
 = 200;

189 
ouut
.
ruË_¡©
[1].
¡©
.
by‹s
 = 30000;

191 
ouut
.
ruË_¡©
[2].
ruË
.
s
 = 0xb0000003;

192 
ouut
.
ruË_¡©
[2].
ruË
.
d
 = 0xb0000004;

193 
ouut
.
ruË_¡©
[2].
ruË
.
¥
 = 232;

194 
ouut
.
ruË_¡©
[2].
ruË
.
dp
 = 345;

195 
ouut
.
ruË_¡©
[2].
ruË
.
´Ùo
 = 0x11;

196 
ouut
.
ruË_¡©
[2].
ruË
.
šdex
 = 
šput
->index + 2;

197 
ouut
.
ruË_¡©
[2].
ruË
.
ruË_sourû
 = 12;

198 
ouut
.
ruË_¡©
[2].
ruË
.
ruË_ty³
 = 13;

199 
ouut
.
ruË_¡©
[2].
ruË
.
aùiÚ
 = 14;

200 
ouut
.
ruË_¡©
[2].
ruË
.
İ
 = 15;

201 
ouut
.
ruË_¡©
[2].
¡©
.
pkts
 = 600;

202 
ouut
.
ruË_¡©
[2].
¡©
.
by‹s
 = 80000;

204 
i
,
j
, 
rv
;

205 
ušt32_t
 
s
, 
d
;

206 
ušt16_t
 
¥
 ,
dp
, 
´ÙocŞ
;

207 
ušt16_t
 
gid
, 
ruËnum
;

208 
ušt8_t
 
¡©e
, 
sync
;

209 
ušt16_t
 
İ
, 
aùiÚ
, 
ruË_ty³
, 
ruË_sourû
;

210 
ušt32_t
 
pkts
, 
by‹s
;

211 
ouut
.
num
 = 0;

212 
i
 = 0, 
j
 = 0; i < ()
šput
->
num
; i++)

214 
gid
 = 
šput
->
šdex
 + 
i
;

215 
rv
 = 
	`aş_g‘f‹r_by_gid
(0, 
gid
, &
ruËnum
, &
¡©e
, &
sync
,

216 &
s
, &
d
, &
¥
, &
dp
, &
´ÙocŞ
, &
pkts
, &
by‹s
,

217 &
İ
, &
aùiÚ
, &
ruË_ty³
, &
ruË_sourû
);

218 ià(
rv
)

222 
ouut
.
ruË_¡©
[
j
].
ruË
.
s
 = sip;

223 
ouut
.
ruË_¡©
[
j
].
ruË
.
d
 = dip;

224 
ouut
.
ruË_¡©
[
j
].
ruË
.
¥
 = sp;

225 
ouut
.
ruË_¡©
[
j
].
ruË
.
dp
 = dp;

226 
ouut
.
ruË_¡©
[
j
].
ruË
.
´Ùo
 = 
´ÙocŞ
;

227 
ouut
.
ruË_¡©
[
j
].
ruË
.
šdex
 = 
gid
;

228 
ouut
.
ruË_¡©
[
j
].
ruË
.
ruË_sourû
 =„ule_source;

229 
ouut
.
ruË_¡©
[
j
].
ruË
.
ruË_ty³
 =„ule_type;

230 
ouut
.
ruË_¡©
[
j
].
ruË
.
aùiÚ
 =‡ction;

231 
ouut
.
ruË_¡©
[
j
].
ruË
.
İ
 = op;

232 
ouut
.
ruË_¡©
[
j
].
¡©
.
pkts
 =…kts;

233 
ouut
.
ruË_¡©
[
j
].
¡©
.
by‹s
 = bytes;

234 
ouut
.
num
++;

235 
j
++;

238 
	`memıy
(
outbuf
, &
ouut
, (
äc_ruË_¡©_out_t
));

239 *
Ş’
 = (
äc_ruË_¡©_out_t
);

241  
FRE_SUCCESS
;

242 
	}
}

245 
	$äcÜe_cmd_ruË_¡©_ş—r
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

247 
äc_ruË_İ_š_t
 *
šput
 = (äc_ruË_İ_š_ˆ*)
·¿m
;

248 
i
;

250 
	`FRCORE_RULE
("===========================================================\n");

251 
	`FRCORE_RULE
("šdex = %d\n", 
šput
->
šdex
);

252 
	`FRCORE_RULE
("num = %d\n", 
šput
->
num
);

253 
ušt16_t
 
gid
;

254 
i
ğ0; i < ()
šput
->
num
; i++)

256 
gid
 = 
šput
->
šdex
 + 
i
;

257 
	`aş_š™f‹r_¡©i¡ics_by_gid
(0, 
gid
);

259 *((
ušt16_t
 *)
outbuf
èğ
i
;

260 *
Ş’
 = 2;

261 
	`FRCORE_RULE
(" *((ušt16_ˆ*)outbuf)ğ%d\n", *((
ušt16_t
 *)
outbuf
));

262  
FRE_SUCCESS
;

263 
	}
}

266 
	$äcÜe_cmd_ruË_g‘_num
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

268 
	`FRCORE_RULE
("===========================================================\n");

269 *((
ušt16_t
 *)
outbuf
èğ
	`aş_g‘f‹r_couÁ
(0);

270 *
Ş’
 = 2;

271 
	`FRCORE_RULE
(" *((ušt16_ˆ*)outbuf)ğ%d\n", *((
ušt16_t
 *)
outbuf
));

272  
FRE_SUCCESS
;

273 
	}
}

276 
	$äcÜe_ruË_š™
()

278 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_RULE_ENABLE
, 
äcÜe_cmd_ruË_’abË
);

279 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_GET_RULE_STATUS
, 
äcÜe_cmd_ruË_¡©us_g‘
);

280 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_ADD_RULE
, 
äcÜe_cmd_ruË_add
);

281 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_DEL_RULE
, 
äcÜe_cmd_ruË_d–
);

282 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_CLEAN_ALL_RULE
, 
äcÜe_cmd_ruË_ş—r_®l
);

283 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_UPDATE_RULE
, 
äcÜe_cmd_ruË_upd©e
);

284 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_GET_RULE
, 
äcÜe_cmd_ruË_¡©_g‘
);

285 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_CLEAN_RULE_STAT
, 
äcÜe_cmd_ruË_¡©_ş—r
);

286 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_GET_RULE_NUM
, 
äcÜe_cmd_ruË_g‘_num
);

289 
	}
}

292 
	$äcÜe_ruË_´oûss
(
cvmx_wqe_t
 *
wÜk
, 
ušt8_t
 *
‘h_±r
, ušt8_ˆ*
_±r
,

293 
ušt8_t
 *
udp_±r
, 
ušt16_t
 
_·yËn
, 
ušt64_t
 
smac
, ušt64_ˆ
dmac
)

296 
ušt8_t
 
aşgid
 = 0;

298 
rv
 = 0;

299 
mµ_tu¶e
 
tu¶e
;

300 
ušt16_t
 
g
 = 0;

301 
ušt16_t
 
pkt_Ën
;

302 
tıhdr
 *
th
;

305 ià(!
ruË_’abË
)

311 
äc_dma_hdr_t
 
hdr
;

312 
äc_dma_pkt_šfo_t
 
šfo
;

313 
‘h_Ën
;

315 
	#_IPH
 ((
hdr
*)(
_±r
))

	)

317 
tu¶e
.
d©a
[0] = *((
ušt64_t
*)(((*)
_IPH
)+12));

318 
tu¶e
.
d©a
[1] = 0ul;

319 
tu¶e
.
d©a_32
[2] = *(
ušt32_t
*)(
udp_±r
);

320 
tu¶e
.
´Ùo
 = 
_IPH
->
´ÙocŞ
;

322 
	`MC_PRINTF_INFO
("sip:%u,%u,%u,%u dip:%u,%u,%u,%u sp:%u,dp:%u,pro:%u\n",

323 
tu¶e
.
s
 >> 24 & 0xFF,

324 
tu¶e
.
s
 >>16 & 0xFF,

325 
tu¶e
.
s
 >> 8 & 0xFF,

326 
tu¶e
.
s
 & 0xFF,

327 
tu¶e
.
d
 >> 24 & 0xFF,

328 
tu¶e
.
d
 >>16 & 0xFF,

329 
tu¶e
.
d
 >> 8 & 0xFF,

330 
tu¶e
.
d
 & 0xFF,

331 
tu¶e
.
¥
,

332 
tu¶e
.
dp
,

333 
tu¶e
.
´Ùo
);

336 ià(
tu¶e
.
´Ùo
 =ğ
PROTO_TCP
)

338 
th
 = (
tıhdr
 *)
udp_±r
;

339 if(((
_IPH
->
ihl
 + 
th
->
doff
è<<2è> (_IPH->
tÙ_Ën
)) {

340 
	`FRCORE_STAT_INC
(
¡©_ruË_m®fÜmed_·ck‘
);

341  
FRCORE_ACT_DROP
;

346 
g
 = 
	`aş_lookup_by_tu¶e
(

347 
gsd©a
.
aş
->
aş_d©a
[
aşgid
].
pha£0_Nodes
,

348 
gsd©a
.
aş
->
aş_d©a
[
aşgid
].
pha£1_Nodes
,

349 
gsd©a
.
aş
->
aş_d©a
[
aşgid
].
pha£2_Nodes
,

350 &
gsd©a
.
aş
->
aş_d©a
[
aşgid
].
pha£3_Node
,

351 
tu¶e
.
s
>>16 & 0xFFFF,

352 
tu¶e
.
s
 & 0xFFFF,

353 
tu¶e
.
d
>>16 & 0xFFFF,

354 
tu¶e
.
d
 & 0xFFFF,

355 
tu¶e
.
¥
,

356 
tu¶e
.
dp
,

357 
tu¶e
.
´Ùo
);

359 
	`FRCORE_RULE
("g=%d\n", 
g
);

360 ià(
g
)

362 if(
g
 !ğ
MPP_MAX_FILTERS
-1) {

363 
	`FRCORE_STAT_INC
(
¡©_ruË_m©ched_pkts
);

364 
	`FRCORE_STAT_ADD
(
¡©_ruË_m©ched_by‹s
, 
wÜk
->
Ën
);

366 
pkt_Ën
 = 
wÜk
->
Ën
;;

367 
	`MC_PRINTF_INFO
("pkt_len: %d\n");

369 
	`aş_¡©i¡ic_h™
(
aşgid
, 
g
);

371 
	`aş_pkt_by‹s_add
(
aşgid
, 
g
, 
pkt_Ën
);

374 
	`mem£t
(&
hdr
, 0, (
äc_dma_hdr_t
));

375 
	`mem£t
(&
šfo
, 0, (
äc_dma_pkt_šfo_t
));

377 
	`UP32
(
_±r
 + 12, 
hdr
.
s
);

379 
	`UP32
(
_±r
 + 16, 
hdr
.
d
);

381 
	`UP16
(
udp_±r
, 
hdr
.
¥Üt
);

382 
	`UP16
(
udp_±r
 + 2, 
hdr
.
dpÜt
);

384 
‘h_Ën
 = 
wÜk
->
Ën
;

386 
hdr
.
´ÙocŞ
 = 
tu¶e
.
´Ùo
;

387 
hdr
.
hash
 = 
wÜk
->
g
 & 0xffffff;

389 
hdr
.
pkt_num
 = 1;

390 
hdr
.
tÙ®_·yËn
 = 
‘h_Ën
;

391 
tu¶e
.
´Ùo
) {

392 
PROTO_TCP
:

393 
th
 = (
tıhdr
 *)
udp_±r
;

394 
šfo
.
d©a_off£t
 = (
ušt32_t
)(
udp_±r
 - 
‘h_±r
 + (
th
->
doff
 << 2));

395 
šfo
.
·ylßd_Ën
 = 
_·yËn
 - (
th
->
doff
 << 2);

396 
šfo
.
£qu’û
 = 
th
->
£q
;

397 
šfo
.
ack_£q
 = 
th
->ack_seq;

399 
PROTO_UDP
:

400 
šfo
.
d©a_off£t
 = (
ušt32_t
)(
udp_±r
 - 
‘h_±r
 + 8);

401 
šfo
.
·ylßd_Ën
 = 
_·yËn
 - 8;

406 
šfo
.
smac
 = smac;

407 
šfo
.
dmac
 = dmac;

410 
rv
 = 
	`äcÜe_fÜw¬d_ruË_pkt_to_fifo
(&
g
, &
hdr
, &
šfo
, 
‘h_±r
);

411 
	`FRCORE_RULE
("äcÜe_fÜw¬d_sim¶e_pkt_to_fifØ»tuº %d.\n", 
rv
);

412 ià(
rv
)

420 
	`FRCORE_STAT_INC
(
¡©_ruË_nÙ_m©ched_pkts
);

421 
	`FRCORE_STAT_ADD
(
¡©_ruË_nÙ_m©ched_by‹s
, 
wÜk
->
Ën
);

424  
rv
;

425 
	}
}

	@frcore/frcore_rule.h

1 #iâdeà
__FRCORE_RULE_H__


2 
	#__FRCORE_RULE_H__


	)

3 #ià
FRC_CONFIG_RULE


4 
äcÜe_ruË_š™
();

5 
äcÜe_ruË_´oûss
(
cvmx_wqe_t
 *
wÜk
, 
ušt8_t
 *
‘h_±r
, ušt8_ˆ*
_±r
,

6 
ušt8_t
 *
udp_±r
, 
ušt16_t
 
_·yËn
, 
ušt64_t
 
smac
, ušt64_ˆ
dmac
);

	@frcore/frcore_ssn.c

30 
	~"cvmx.h
"

31 
	~"cvmx-cÚfig.h
"

32 
	~"cvmx-sysšfo.h
"

33 
	~"cvmx-boÙmem.h
"

34 
	~"cvmx-¥šlock.h
"

35 
	~"cvmx-rwlock.h
"

36 
	~"cvmx-åa.h
"

37 
	~"cvmx-d.h
"

38 
	~"cvmx-pko.h
"

39 
	~"cvmx-dç.h
"

40 
	~"cvmx-gmx.h
"

41 
	~"cvmx-cÜemask.h
"

42 
	~"cvmx-h–³r.h
"

43 
	~"cvmx-tim.h
"

44 
	~"cvmx-š‹¼u±.h
"

45 
	~"cvmx-p.h
"

46 
	~"cvmx-pow.h
"

47 
	~"cvmx-çu.h
"

49 
	~"äcÜe.h
"

50 
	~"äcÜe_cmd.h
"

51 
	~"äcÜe_misc.h
"

52 
	~"äcÜe_phy.h
"

53 
	~"äcÜe_dma.h
"

54 
	~"äcÜe_chª.h
"

55 
	~"äcÜe_pkt.h
"

56 
	~"äcÜe_¡©.h
"

57 
	~"äcÜe_s¢.h
"

58 
	~"äcÜe_debug.h
"

59 
	~"äcÜe_s¢_´iv.h
"

60 
	~"äcÜe_´Ùo.h
"

62 
CVMX_SHARED
 
mµ_sh¬ed_d©a
 
	ggsd©a
;

63 #ià
FRC_CONFIG_SSN_CHAN


64 
CVMX_SHARED
 
ušt8_t
 
	gäcÜe_s¢_age
 = 3;

65 
CVMX_SHARED
 
cvmx_¥šlock_t
 
	gs¢_¥šlock
;

66 
šlše
 
	$s¢_purge_s¢_nŞock
(
mµ_s¢
 *
s¢
)

68 
mµ_s¢
 *
s¢1
=&
gsd©a
.
s¢
[s¢->
s¢_šdex
];

71 if(
s¢
 =ğ
s¢1
) {

72 
	`cvmx_©omic_ãtch_ªd_b£t32_nosync
(&
s¢
->
s¢_¡©us
, 
SSN_STATUS_EMPTY
);

73 
CVMX_SYNCWS
;

74 
»t
;

77 
s¢1
) {

78 
	`CVMX_PREFETCH
(
s¢1
->
Ãxt_sc
, 0);

79 if(
s¢1
->
Ãxt_sc
 =ğ
s¢
) {

83 
s¢1
 = s¢1->
Ãxt_sc
;

86 if(!
s¢1
) {

87 
	`MC_PRINTF_ERR
("WrÚg s¢ w™h index 0x%x\n", 
s¢
->
s¢_šdex
);

90 
s¢1
->
Ãxt_sc
 = 
s¢
->next_sc;

92 
	`´štf
("purge ssn index 0x%x 0x%x head %p->%p…rev %p->%phis %p->%p \n",

93 
s¢
->
s¢_šdex
, 
gsd©a
.ssn[ssn->ssn_index].ssn_index,

94 &
gsd©a
.
s¢
[s¢->
s¢_šdex
], gsd©a.s¢[s¢->s¢_šdex].
Ãxt_sc
,

95 
s¢1
, s¢1->
Ãxt_sc
, 
s¢
, ssn->next_sc);

99 
	`FRCORE_STAT_INC
(
¡©_s¢_purge_to_åa
);

100 
	`cvmx_åa_ä“
((*)
s¢
, 
CVMX_FPA_SSN_POOL
, 0);

102 
»t
:

105 
	}
}

107 
	$s¢_purge_s¢
(
mµ_s¢
 *
s¢
)

109 
mµ_s¢
 *
s¢1
=&
gsd©a
.
s¢
[s¢->
s¢_šdex
];

113 
t£g_q’t
 *
q
;

114 if(
s¢
->
tı_æow_pos™ive_d©a
.
h—d
.
lh_fœ¡
) {

115 
q
 = 
	`LIST_FIRST
(&
s¢
->
tı_æow_pos™ive_d©a
.
h—d
);

116 
	`´štf
("% %d,q->ack_num=0x%Îx, q->d©a_Ën=%Îd\n", 
__func__
, 
__LINE__
, (
ULL
)
q
->
ack_num
, (ULL)q->
d©a_Ën
);

118 if(
s¢
->
tı_æow_Ãg©ive_d©a
.
h—d
.
lh_fœ¡
) {

119 
q
 = 
	`LIST_FIRST
(&
s¢
->
tı_æow_Ãg©ive_d©a
.
h—d
);

120 
	`´štf
("% %d,q->ack_num=0x%Îx, q->d©a_Ën=%Îd\n", 
__func__
, 
__LINE__
, (
ULL
)
q
->
ack_num
, (ULL)q->
d©a_Ën
);

122 
	`FRCORE_STAT_INC
(
¡©_s¢_purge
);

123 if(
s¢
 =ğ
s¢1
) {

124 
	`cvmx_©omic_ãtch_ªd_b£t32_nosync
(&
s¢
->
s¢_¡©us
, 
SSN_STATUS_EMPTY
);

125 
	`cvmx_©omic_ãtch_ªd_bşr32_nosync
(&
s¢
->
s¢_¡©us
, 
SSN_STATUS_GOOD
);

128 
	`sbum™_dma_h—d”_to_fifo
(
s¢
);

130 
»t
;

134 
s¢1
) {

135 
	`CVMX_PREFETCH
(
s¢1
->
Ãxt_sc
, 0);

136 if(
s¢1
->
Ãxt_sc
 =ğ
s¢
) {

140 
s¢1
 = s¢1->
Ãxt_sc
;

143 if(!
s¢1
) {

144 
	`MC_PRINTF_ERR
("WrÚg s¢ w™h index 0x%x. s¢1: %p\n", 
s¢
->
s¢_šdex
, 
s¢1
);

146 
	`FRCORE_STAT_INC
(
¡©_s¢_purge_unknown
);

148 
s¢1
->
Ãxt_sc
 = 
s¢
->next_sc;

150 
	`sbum™_dma_h—d”_to_fifo
(
s¢
);

152 
	`´štf
("purge ssn index 0x%x 0x%x head %p->%p…rev %p->%phis %p->%p \n",

153 
s¢
->
s¢_šdex
, 
gsd©a
.ssn[ssn->ssn_index].ssn_index,

154 &
gsd©a
.
s¢
[s¢->
s¢_šdex
], gsd©a.s¢[s¢->s¢_šdex].
Ãxt_sc
,

155 
s¢1
, s¢1->
Ãxt_sc
, 
s¢
, ssn->next_sc);

161 
	`FRCORE_STAT_INC
(
¡©_s¢_purge_to_åa
);

162 if(!
	`cvmx_åa_is_memb”
(
CVMX_FPA_SSN_POOL
, (*)
s¢
)){

164 
	`FRCORE_STAT_INC
(
¡©_s¢_åa_ä“_”r
);

166 
	`´štf
("ERROR PURGE SSN: %° !!!\n", 
s¢1
);

169 
	`cvmx_åa_ä“
((*)
s¢
, 
CVMX_FPA_SSN_POOL
, 0);

171 
»t
:

173 
	`FRCORE_STAT_ADD
(
¡©_s¢_aùive_num
, -1);

175 
	}
}

178 
mµ_s¢
 *
	$s¢_´•¬e
(
ušt32_t
 
s¢_šdex
, 
ušt64_t
 *
d©a
, ušt64_ˆ
mask
, 
ušt8_t
 
th_æags
,

179 
ušt32_t
 
£q
, ušt32_ˆ
ack_£q
)

181 
mµ_s¢
 *
s¢1
, *
s¢
;

185 ià((
th_æags
 & 
TH_FIN
è|| (th_æag & 
TH_RST
))

187 
	`FRCORE_STAT_INC
(
¡©_s¢_ç_fš_Ü_r¡
);

188  
NULL
;

191 if(
	`cvmx_uÆik–y
(
	`FRCORE_STAT_FETCH_AND_ADD
(
¡©_s¢_aùive_num
, 1)

192 >ğ
SSN_TOTAL_NUM
)) {

193 
	`FRCORE_STAT_ADD
(
¡©_s¢_aùive_num
, -1);

194 
	`FRCORE_STAT_INC
(
¡©_s¢_ç_ov”æow
);

195  
NULL
;

198 
s¢
 = &
gsd©a
.s¢[
s¢_šdex
];

200 
	`´štf
("Current ssn_index 0x%x, ssn status 0x%x\n",

201 
s¢_šdex
,

202 
s¢
->
s¢_¡©us
);

203 
	`´štf
("tuple 0x%x 0x%x %d %d %d %2d %d\n",

204 ((
mµ_tu¶e
*)
d©a
)->
d
, ((mµ_tu¶e*)d©a)->
s
,

205 ((
mµ_tu¶e
*)
d©a
)->
dp
, ((mµ_tu¶e*)d©a)->
¥
,

206 ((
mµ_tu¶e
*)
d©a
)->
if
, ((mµ_tu¶e*)d©a)->
´Ùo
,

207 ((
mµ_tu¶e
*)
d©a
)->
£ssiÚ_ty³
);

210 if(!(
	`cvmx_©omic_ãtch_ªd_bşr32_nosync
(

211 &
s¢
->
s¢_¡©us
, 
SSN_STATUS_EMPTY
)&SSN_STATUS_EMPTY)){

212 
s¢1
 = (
mµ_s¢
 *)
	`cvmx_åa_®loc
(
CVMX_FPA_SSN_POOL
);

214 
	`FRCORE_STAT_INC
(
¡©_s¢_´•¬ed_by_åa_®loc
);

215 if(
	`cvmx_lik–y
(
s¢1
)){

216 
	`MC_PRINTF_INFO
("´•¬e: index: 0x%x,hi %p, \n", 
s¢_šdex
, 
s¢1
);

218 
	`´štf
("FPA:‚ame: %s, base: %p, size:%d,‚um: %d\n",

219 
cvmx_åa_poŞ_šfo
[
CVMX_FPA_SSN_POOL
].
Çme
,

220 
cvmx_åa_poŞ_šfo
[
CVMX_FPA_SSN_POOL
].
ba£
,

221 
cvmx_åa_poŞ_šfo
[
CVMX_FPA_SSN_POOL
].
size
,

222 
cvmx_åa_poŞ_šfo
[
CVMX_FPA_SSN_POOL
].
¡¬tšg_–em’t_couÁ
 );

224 if(!
	`cvmx_åa_is_memb”
(
CVMX_FPA_SSN_POOL
, (*)
s¢1
)){

226 
	`FRCORE_STAT_ADD
(
¡©_s¢_åa_®loc_”r
, 1);

227 
	`MC_PRINTF_INFO
("ERROR PREPARE SSN1: %° !!!\n", 
s¢1
);

228  
NULL
;

230 
s¢1
->
s¢_¡©us
 = 
SSN_STATUS_EMPTY
;

231 
s¢1
->
s¢_addr
.
addr_æag
 = 0;

232 
s¢1
->
Ãxt_sc
 = 
s¢
->next_sc;

233 
s¢
->
Ãxt_sc
 = 
s¢1
;

235 
	`´štf
("prepare ssn index 0x%x head %p->%p status 0x%xthis %p->%p \n",

236 
s¢_šdex
, 
s¢
, s¢->
Ãxt_sc
, s¢->
s¢_¡©us
, 
s¢1
,

237 
s¢1
->
Ãxt_sc
);

241 
	`FRCORE_STAT_ADD
(
¡©_s¢_åa_çed
, 1);

242 
	`FRCORE_STAT_ADD
(
¡©_s¢_aùive_num
, -1);

243  
NULL
;

248 
s¢1
 = 
s¢
;

249 
s¢1
->
s¢_addr
.
addr_æag
 = 0;

251 
s¢1
->
£q
 = seq;

252 
s¢1
->
ack_£q
 =‡ck_seq;

253 
s¢1
->
by‹s
 = 0;

254 
s¢1
->
pkts
 = 0;

255 
s¢1
->
key
.
d©a_64
[0] = 
d©a
[0];

256 
s¢1
->
key
.
d©a_64
[1] = 
d©a
[1]&
mask
;

257 
s¢1
->
key
.
aùiÚ
 = 
MPP_SSN_ACTION_TCPFLOWREC
;

258 
s¢1
->
‰l
 = s¢1->
age
 = 
äcÜe_s¢_age
-1;

259 
s¢1
->
s¢_šdex
 = ssn_index;

260 
s¢1
->
qos
 = 1;

261 
s¢1
->
wqe_unu£d
 = 
FRCORE_WORK_SSN_AGE
;

262 
s¢1
->
´t
 = 0;

263 #ià!
FRC_CONFIG_SSN_ATOMIC


264 
s¢1
->
g½
 = 
GROUP_TO_DATA_PLANE_AGING
;

265 
s¢1
->
g
 = 
	`¡agšg_g
(
s¢_šdex
,
SESSION_STAGING
);

266 
s¢1
->
g_ty³
 = 
CVMX_POW_TAG_TYPE_ORDERED
;

268 
s¢1
->
g½
 = 
	`cvmx_g‘_cÜe_num
() + 1;

269 
s¢1
->
g
 = s¢1->
g½
;

270 
s¢1
->
g_ty³
 = 
CVMX_POW_TAG_TYPE_ATOMIC
;

273 if(
	`s¢_add_tim”
(
s¢1
, 
MC_SSN_TTL_UNIT
)<0)

275 
	`MC_PRINTF_ERR
("ssn‡ddimer failed.\n");

276 
	`s¢_purge_s¢_nŞock
(
s¢1
);

277 
s¢1
 = 
NULL
;

279  
s¢1
;

280 
	}
}

283 *
	g_¡©us
[]=

288 
NULL
,

291 *
	g_aùiÚ
[]=

298 
NULL
,

301 
	$md_dump_s¢
(
mµ_s¢
 *
s¢
)

303 *
¡r
="PREPARED";

304 *
¡r1
 = "NOACTION";

305 
i
;

306 
i
=0; i<3; i++) {

307 if(
s¢
->
s¢_¡©us
 & (1<<
i
))

308 
¡r
 = 
_¡©us
[
i
];

310 if((
s¢
->
key
.
aùiÚ
>0)&&(ssn->key.action<5))

311 
¡r1
 = 
_aùiÚ
[
s¢
->
key
.
aùiÚ
];

312 
	`´štf
("s¢‡ùiÚ: %d\n", 
s¢
->
key
.
aùiÚ
);

314 
	`´štf
("ssn %p: index 0x%xtl %d status 0x%x (%s)\n",

315 
s¢
, s¢->
s¢_šdex
, s¢->
‰l
, s¢->
s¢_¡©us
, 
¡r
);

316 
	`´štf
(" IF SIP DIP PR SP DP \n"

319 
s¢
->
key
.
if
, s¢->key.
s
, s¢->key.
d
,

320 
s¢
->
key
.
´Ùo
, s¢->key.
¥
, s¢->key.
dp
);

322 
	`´štf
(" TYPE EPIF ACTION BYTES PACKETS \n"

325 
s¢
->
key
.
¡
, s¢->key.
•if
, 
¡r1
,

326 ()
s¢
->
key
.
by‹_couÁ
, ()s¢->key.
·ck‘_couÁ
);

328 
	`´štf
(" DMAC SMAC \n"

334 
s¢
->
cÚt
.
dmac_hi
, s¢->cÚt.
dmac_lo
,

335 
s¢
->
cÚt
.
smac_hi
, s¢->cÚt.
smac_lo
,

336 
s¢
->
cÚt
.
Ãw_d
, s¢->cÚt.
Ãw_s
,

337 
s¢
->
cÚt
.
Ãw_dp
, s¢->cÚt.
Ãw_¥
);

342 
	}
}

343 
	$s¢_couÁ_s¢
(*
cgood
, *
ûm±y
, *
ûxpœed
)

346 
i
;

347 
i
 = 0; i < 
SSN_HASH_BUCKET_SIZE
; i++){

348 if((
gsd©a
.
s¢
[
i
].
s¢_¡©us
 & 
SSN_STATUS_GOOD
) == SSN_STATUS_GOOD)

349 (*
cgood
)++;

350 if((
gsd©a
.
s¢
[
i
].
s¢_¡©us
 & 
SSN_STATUS_EMPTY
) == SSN_STATUS_EMPTY)

351 (*
ûm±y
)++;

352 if(
gsd©a
.
s¢
[
i
].
s¢_¡©us
 =ğ
SSN_STATUS_EXPIRED
)

353 (*
ûxpœed
)++;

357 
	}
}

358 
	$s¢_isgoodšdex
(
šdex
)

360 if(
SSN_STATUS_GOOD
 =ğ(SSN_STATUS_GOOD & 
gsd©a
.
s¢
[
šdex
].
s¢_¡©us
))

363 
	}
}

365 
	$äcÜe_£t_s¢_age
(
ušt8_t
 
s¢_age
)

367 if(
s¢_age
 < 
FRCORE_SSN_AGE_MIN
 || s¢_ag> 
FRCORE_SSN_AGE_MAX
) {

368  
FRE_EXCEED
;

370 
äcÜe_s¢_age
 = 
s¢_age
;

371  
FRE_SUCCESS
;

372 
	}
}

374 
	$äcÜe_g‘_s¢_age
(
ušt8_t
 *
s¢_age
)

376 if(!
s¢_age
) {

377  
FRE_MEMORY
;

379 *
s¢_age
 = 
äcÜe_s¢_age
;

380  
FRE_SUCCESS
;

381 
	}
}

383 
	$äcÜe_g‘_s¢_by_hash
(
ušt32_t
 
hash
, 
äcÜe_s¢_¡©s_t
 *
s¢_¡©s
)

385 
i
=0;

386 
ušt32_t
 
šdex
 = 
hash
 & 
SSN_HASH_BUCKET_SIZE_MASK
;

387 
	`mem£t
(
s¢_¡©s
, 0, (
äcÜe_s¢_¡©s_t
));

388 
mµ_s¢
 *
s¢
 = &
gsd©a
.s¢[
šdex
];

389 if(
s¢
->
s¢_¡©us
 & 
SSN_STATUS_GOOD
) {

390 
s¢_¡©s
->
s¢_¡©
[
i
].
s
 = 
s¢
->
key
.sip;

391 
s¢_¡©s
->
s¢_¡©
[
i
].
d
 = 
s¢
->
key
.dip;

392 
s¢_¡©s
->
s¢_¡©
[
i
].
¥
 = 
s¢
->
key
.sp;

393 
s¢_¡©s
->
s¢_¡©
[
i
].
dp
 = 
s¢
->
key
.dp;

394 
s¢_¡©s
->
s¢_¡©
[
i
].
´Ùo
 = 
s¢
->
key
.proto;

395 
s¢_¡©s
->
s¢_¡©
[
i
].
pkts
 = 
s¢
->pkts;

396 
s¢_¡©s
->
s¢_¡©
[
i
].
by‹s
 = 
s¢
->bytes;

397 
s¢_¡©s
->
num
++;

398 
i
++;

400 
s¢
 = s¢->
Ãxt_sc
;

401 if(
s¢
) {

402 if(
s¢
->
s¢_¡©us
 & 
SSN_STATUS_GOOD
) {

403 
s¢_¡©s
->
s¢_¡©
[
i
].
s
 = 
s¢
->
key
.sip;

404 
s¢_¡©s
->
s¢_¡©
[
i
].
d
 = 
s¢
->
key
.dip;

405 
s¢_¡©s
->
s¢_¡©
[
i
].
¥
 = 
s¢
->
key
.sp;

406 
s¢_¡©s
->
s¢_¡©
[
i
].
dp
 = 
s¢
->
key
.dp;

407 
s¢_¡©s
->
s¢_¡©
[
i
].
´Ùo
 = 
s¢
->
key
.proto;

408 
s¢_¡©s
->
s¢_¡©
[
i
].
pkts
 = 
s¢
->pkts;

409 
s¢_¡©s
->
s¢_¡©
[
i
].
by‹s
 = 
s¢
->bytes;

410 
s¢_¡©s
->
num
++;

413  
FRE_SUCCESS
;

414 
	}
}

416 
	$äcÜe_g‘_s¢_by_tu¶e
(
ušt32_t
 
s
, ušt32_ˆ
d
, 
ušt16_t
 
¥
, ušt16_ˆ
dp
,

417 
ušt8_t
 
´Ùo
, 
äcÜe_s¢_¡©_t
 *
s¢_¡©
)

419 
mµ_tu¶e
 
tu¶e
, 
tu¶e_sÜt
;

420 
tu¶e
.
s
 = sip;

421 
tu¶e
.
d
 = dip;

422 
tu¶e
.
¥
 = sp;

423 
tu¶e
.
dp
 = dp;

424 
tu¶e
.
´Ùo
 =…roto;

425 
	`s¢_sÜt_tu¶e
(&
tu¶e
, &
tu¶e_sÜt
);

426 
ušt32_t
 
s¢_šdex
 = 
	`s¢_hash_by_tu¶e
(
tu¶e_sÜt
.
d©a
, 
SSN_HASH_BUCKET_SIZE_MASK
);

427 
mµ_s¢
 *
s¢
 = 
	`s¢_lookup_by_tu¶e
(
s¢_šdex
, &
tu¶e_sÜt
, 
MPP_SSN_HASH_MASK_SNIFFER
);

428 if(
s¢
 && (s¢->
s¢_¡©us
 & 
SSN_STATUS_GOOD
)) {

429 
	`mem£t
(
s¢_¡©
, 0, (
äcÜe_s¢_¡©_t
));

430 
s¢_¡©
->
s
 = 
s¢
->
key
.sip;

431 
s¢_¡©
->
d
 = 
s¢
->
key
.dip;

432 
s¢_¡©
->
¥
 = 
s¢
->
key
.sp;

433 
s¢_¡©
->
dp
 = 
s¢
->
key
.dp;

434 
s¢_¡©
->
´Ùo
 = 
s¢
->
key
.proto;

435 
s¢_¡©
->
pkts
 = 
s¢
->pkts;

436 
s¢_¡©
->
by‹s
 = 
s¢
->bytes;

438  
FRE_NOTFOUND
;

440  
FRE_SUCCESS
;

441 
	}
}

443 
	$äcÜe_m©ch_s¢_by_tu¶e
(
ušt32_t
 
s
, ušt32_ˆ
d
, 
ušt16_t
 
¥
, ušt16_ˆ
dp
, 
ušt8_t
 
´Ùo
)

445 
mµ_tu¶e
 
tu¶e
, 
tu¶e_sÜt
;

446 
tu¶e
.
s
 = sip;

447 
tu¶e
.
d
 = dip;

448 
tu¶e
.
¥
 = sp;

449 
tu¶e
.
dp
 = dp;

450 
tu¶e
.
´Ùo
 =…roto;

451 
	`s¢_sÜt_tu¶e
(&
tu¶e
, &
tu¶e_sÜt
);

452 
ušt32_t
 
s¢_šdex
 = 
	`s¢_hash_by_tu¶e
(
tu¶e_sÜt
.
d©a
, 
SSN_HASH_BUCKET_SIZE_MASK
);

453 
mµ_s¢
 *
s¢
 = 
	`s¢_lookup_by_tu¶e
(
s¢_šdex
, &
tu¶e_sÜt
, 
MPP_SSN_HASH_MASK_SNIFFER
);

454 if(
s¢
 && (s¢->
s¢_¡©us
 & 
SSN_STATUS_GOOD
)) {

455  
FRE_SUCCESS
;

457  
FRE_NOTFOUND
;

459  
FRE_SUCCESS
;

460 
	}
}

	@frcore/frcore_ssn.h

1 #iâdeà
__FRCORE_SSN_H__


2 
	#__FRCORE_SSN_H__


	)

3 
	~"äcÜe_tıæow»c.h
"

4 
	~"äcÜe_š™.h
"

5 
	~"cvmx-©omic.h
"

6 
	~"äc_dma.h
"

8 #ià
FRC_CONFIG_SSN_CHAN


9 
	#SSN_HASH_BUCKET_SIZE_BITS
 18

	)

10 
	#SSN_HASH_BUCKET_SIZE
 (1<<
SSN_HASH_BUCKET_SIZE_BITS
)

	)

11 
	#SSN_HASH_BUCKET_SIZE_MASK
 (
SSN_HASH_BUCKET_SIZE
-1)

	)

12 
	#MC_FPA_SSN_BUF_NUMS
 (300000è

	)

14 
	#SSN_TOTAL_NUM
 (300000)

	)

16 
	#CVMX_SSN_CACHE_LINE_SIZE
 (256)

	)

17 
	#CVMX_SSN_CACHE_LINE_ALIGNED
 
	`__©Œibu‹__
 ((
	`®igÃd
 (
CVMX_SSN_CACHE_LINE_SIZE
)))

	)

19 
	#CVMX_FPA_SSN_POOL
 (5)

	)

20 
	#CVMX_FPA_SSN_POOL_SIZE
 
CVMX_SSN_CACHE_LINE_SIZE


	)

21 
	#CVMX_FPA_TCPFLOWREC_POOL
 (6è

	)

22 
	#CVMX_FPA_TCPFLOWREC_POOL_SIZE
 
CVMX_CACHE_LINE_SIZE


	)

24 
	#QOS_INVALID_ID
 -1

	)

25 
	#MPP_QOS_ID_MAX_NUM
 65536

	)

27 
CVMX_SHARED
 
cvmx_¥šlock_t
 
s¢_¥šlock
;

30 
	smµ_s¢_cÚt
 {

34 
ušt32_t
 
	mÃw_s
;

35 
ušt32_t
 
	mÃw_d
;

37 
ušt16_t
 
	mÃw_¥
;

38 
ušt16_t
 
	msmac_hi
;

39 
ušt32_t
 
	msmac_lo
;

43 
ušt16_t
 
	mÃw_dp
;

44 
ušt16_t
 
	mdmac_hi
;

45 
ušt32_t
 
	mdmac_lo
;

48 
ušt64_t
 
	mÃw_tos
 : 8;

49 
ušt64_t
 
	msyncook›_svr
:1;

50 
ušt64_t
 
	munu£d
 : 21;

51 
ušt64_t
 
	mqos1_’
 : 1;

52 
ušt64_t
 
	mqos2_’
 : 1;

53 
ušt64_t
 
	mqos1_id
 : 16;

54 
ušt64_t
 
	mqos2_id
 : 16;

56 
ušt64_t
 
	md©a_64
[4];

57 
ušt32_t
 
	md©a_32
[8];

59 }
	tmµ_s¢_cÚt
;

61 
	säc_s¢_subm™_addr
 {

65 
ušt64_t
 
	mblock_addr
;

67 
ušt16_t
 
	mh—d_off£t
;

68 
ušt16_t
 
	mšfo_off£t
;

69 
ušt16_t
 
	m·ylßd_off£t
;

70 
ušt16_t
 
	maddr_æag
;

72 
ušt64_t
 
	m·ylßd_Ën
;

75 
ušt64_t
 
	mpkt_num
;

77 
ušt64_t
 
	md©a_64
[4];

78 
ušt32_t
 
	md©a_32
[8];

80 }
	täc_s¢_subm™_addr
;

82 
	smµ_s¢_key
 {

89 
ušt64_t
 
	ms
 : 32;

90 
ušt64_t
 
	md
 : 32;

92 
	#MPP_SSN_HASH_MASK_SNIFFER
 0xffffffffff000000

	)

93 
	#MPP_SSN_HASH_MASK_DATA64
 0xffffffffffff0000

	)

94 
	#MPP_SSN_HASH_PROTO_MASK_DATA64_3G
 0xffffffff00ff1f00

95 
ušt64_t
 
¥
 : 16;

	)

96 
ušt64_t
 
	mdp
 : 16;

97 
ušt64_t
 
	m´Ùo
 : 8;

98 
ušt64_t
 
	m¡
 : 3;

99 
ušt64_t
 
	mif
 : 5;

100 
ušt64_t
 
	mrsv0
 : 2;

101 
ušt64_t
 
	mcİyif
 : 5;

102 
ušt64_t
 
	mtıæow»c
 : 1;

103 
ušt64_t
 
	mho¡
 : 1;

104 
ušt64_t
 
	mfÜw¬d
 : 1;

105 
ušt64_t
 
	mmœrÜ
 : 1;

106 
ušt64_t
 
	m•if
 : 5;

109 
	#MPP_SSN_ACTION_TCPFLOWREC
 0x8

	)

110 
	#MPP_SSN_ACTION_HOST
 0x4

	)

111 
	#MPP_SSN_ACTION_DROP
 0x3

	)

112 
	#MPP_SSN_ACTION_FWD
 0x2

	)

113 
	#MPP_SSN_ACTION_MIRROR
 0x1

	)

117 
	#MPP_SSN_HASH_MAC_MASK_DATA64
 0xffffffff00000000

	)

118 
ušt64_t
 
	mdmac
 :48;

119 
ušt64_t
 
	msmac_hi
 : 16;

121 
ušt64_t
 
	msmac_lo
 : 32;

122 
ušt64_t
 
	m´Ùo
 : 8;

123 
ušt64_t
 
	m¡
 : 8;

124 
ušt64_t
 
	mrsv0
 : 2;

125 
ušt64_t
 
	mif
 : 5;

126 
ušt64_t
 
	maùiÚ
 : 4;

127 
ušt64_t
 
	m•if
 : 5;

131 
	#MPP_SSN_KEY_PKTS_COUNT_POS_BITS
 24

	)

132 
	#MPP_SSN_KEY_PKTS_COUNT_MASK
 0xffffffffff

	)

133 
ušt64_t
 
	m–if
 : 8;

134 
ušt64_t
 
	mhijack_•if
 : 8;

135 
ušt64_t
 
	mmod_add_vÏn
 : 1;

136 
ušt64_t
 
	mmod_dmac
 : 1;

137 
ušt64_t
 
	mmod_smac
 : 1;

138 
ušt64_t
 
	mmod_tos
 : 1;

139 
ušt64_t
 
	mmod_s
 : 1;

140 
ušt64_t
 
	mmod_d
 : 1;

141 
ušt64_t
 
	mmod_¥
 : 1;

142 
ušt64_t
 
	mmod_dp
 : 1;

143 
ušt64_t
 
	m·ck‘_couÁ
: 40;

145 
	#MPP_SSN_KEY_BYTES_COUNT_POS_BITS
 16

	)

146 
	#MPP_SSN_KEY_BYTES_COUNT_MASK
 0xffffffffffff

	)

147 
ušt64_t
 
	mrsv_x
 : 14;

148 
ušt64_t
 
	mqos_´io
 : 2;

149 
ušt64_t
 
	mby‹_couÁ
 : 48;

152 
ušt64_t
 
	md©a_64
[4];

154 }
	tmµ_s¢_key_t
;

157 
	smµ_s¢
 {

163 
ušt16_t
 
	mhw_chksum
;

164 
ušt8_t
 
	mwqe_unu£d
;

165 
ušt64_t
 
	mÃxt_±r
 :40;

166 
ušt64_t
 
	mËn
 :16;

167 
ušt64_t
 
	m´t
 : 6;

168 
ušt64_t
 
	mqos
 : 3;

169 
ušt64_t
 
	mg½
 : 4;

170 
cvmx_pow_g_ty³_t
 
	mg_ty³
 : 3;

171 
ušt64_t
 
	mg
 :32;

173 
ušt32_t
 
	mhw_d©a
[4];

177 
mµ_s¢_key
 
	mkey
;

179 
mµ_s¢_cÚt
 
	mcÚt
;

181 
äc_s¢_subm™_addr
 
	ms¢_addr
;

185 
ušt32_t
 
	mpkts
;

186 
ušt32_t
 
	mby‹s
;

188 
mµ_s¢
 *
	mÃxt_sc
;

189 
	#SSN_STATUS_GOOD
 0x00000001

	)

190 
	#SSN_STATUS_EMPTY
 0x00000002

	)

191 
	#SSN_STATUS_EXPIRED
 0x00000004

	)

192 
	#SSN_STATUS_HOST
 0x00000008

	)

193 
	#SSN_STATUS_PEND
 0x00000010

	)

194 
	#SSN_STATUS_ESTABLISHED
 0x00000020

	)

195 
	#SSN_STATUS_WAIT
 0x00000040

	)

196 
	#SSN_STATUS_MACHINE_MASK
 \

197 ~(
SSN_STATUS_EMPTY
|
SSN_STATUS_EXPIRED
|
SSN_STATUS_HOST
|(1<<31))

	)

200 
ušt32_t
 
	ms¢_¡©us
;

201 
ušt32_t
 
	ms¢_šdex
;

203 
št32_t
 
	m‰l
;

204 
ušt32_t
 
	mage
;

206 
ušt32_t
 
	m£q
;

207 
ušt32_t
 
	mack_£q
;

209 
tı_æow_d©a
 
	mtı_æow_pos™ive_d©a
;

211 
tı_æow_d©a
 
	mtı_æow_Ãg©ive_d©a
;

213 
ušt64_t
 
	md©a_64
[32];

215 }
	tCVMX_SSN_CACHE_LINE_ALIGNED
 
	tmµ_s¢
;

217 
	#FRCORE_SSN_LOOKUP_MAX
 2

	)

218 
	säcÜe_s¢_¡©
{

219 
ušt32_t
 
	ms
;

220 
ušt32_t
 
	md
;

221 
ušt16_t
 
	m¥
;

222 
ušt16_t
 
	mdp
;

223 
ušt16_t
 
	m´Ùo
;

224 
ušt16_t
 
	mrsvrd
;

225 
ušt32_t
 
	mpkts
;

226 
ušt32_t
 
	mby‹s
;

227 }
	täcÜe_s¢_¡©_t
;

229 
	säcÜe_s¢_¡©s
{

230 
ušt64_t
 
	mnum
;

231 
äcÜe_s¢_¡©_t
 
	ms¢_¡©
[
FRCORE_SSN_LOOKUP_MAX
];

232 }
	täcÜe_s¢_¡©s_t
;

234 
šlše
 
	$s¢_sÜt_tu¶e
(
mµ_tu¶e
 *
¤c_tu¶e
, mµ_tu¶*
des_tu¶e
)

236 
des_tu¶e
->
d©a
[0]=0;

237 
des_tu¶e
->
d©a
[1]=0;

238 if(
¤c_tu¶e
->
d©a_32
[0] >= src_tuple->data_32[1]) {

239 
des_tu¶e
->
d©a
[0] = 
¤c_tu¶e
->data[0];

240 
des_tu¶e
->
d©a_32
[2] = 
¤c_tu¶e
->data_32[2];

242 
des_tu¶e
->
d©a_32
[0] = 
¤c_tu¶e
->data_32[1];

243 
des_tu¶e
->
d©a_32
[1] = 
¤c_tu¶e
->data_32[0];

244 
des_tu¶e
->
¥
 = 
¤c_tu¶e
->
dp
;

245 
des_tu¶e
->
dp
 = 
¤c_tu¶e
->
¥
;

248 
des_tu¶e
->
´Ùo
 = 
¤c_tu¶e
->proto;

251 
	}
}

254 
šlše
 
	$s¢_dœeùiÚ_tu¶e
(
mµ_tu¶e
 *
¤c_tu¶e
, mµ_tu¶*
des_tu¶e
)

256 if(
¤c_tu¶e
->
d©a
[0] =ğ
des_tu¶e
->data[0]

257 && 
¤c_tu¶e
->
d©a_32
[2] =ğ
des_tu¶e
->data_32[2]) {

258  
FRC_SSN_POSIVTE_FLOW
;

260  
FRC_SSN_NEGATIVE_FLOW
;

261 
	}
}

263 
šlše
 
ušt32_t
 
	$s¢_hash_by_tu¶e
(
ušt64_t
 *
d©a_64
, 
ušt32_t
 
mask
)

266 
idx
;

267 
ušt64_t
 
t1
, 
t2
;

269 
	`CVMX_MT_CRC_POLYNOMIAL
 (0x1edc6f41);

270 
	`CVMX_MT_CRC_IV
 (0);

272 
t1
 = *
d©a_64
++;

273 
t2
 = *
d©a_64
++;

274 
	`CVMX_MT_CRC_DWORD
 (
t1
);

275 
	`CVMX_MT_CRC_DWORD
 (
t2
);

277 
	`CVMX_MF_CRC_IV
 (
idx
);

279  (
idx
 & 
mask
);

280 
	}
}

282 
šlše
 
ušt64_t
 
	$s¢_£t_tıæow»c
(
mµ_s¢
 *
s¢
, 
’abË
)

284 
ušt64_t
 
debug
;

287 if(!
’abË
){

288 
debug
 = 
	`cvmx_©omic_ãtch_ªd_bşr64_nosync
(&
s¢
->
key
.
d©a_64
[1],

292 
debug
 = 
	`cvmx_©omic_ãtch_ªd_b£t64_nosync
(&
s¢
->
key
.
d©a_64
[1],

295  
debug
;

298 
	}
}

304 
šlše
 
	$s¢_add
(
mµ_s¢
 *
s¢
)

306 
	`cvmx_©omic_ãtch_ªd_bşr32_nosync
(&
s¢
->
s¢_¡©us
, 
SSN_STATUS_MACHINE_MASK
);

307 
	`cvmx_©omic_ãtch_ªd_b£t32_nosync
(&
s¢
->
s¢_¡©us
, 
SSN_STATUS_GOOD
);

310 
	}
}

312 
šlše
 
	$s¢_add_by_ho¡
(
mµ_s¢
 *
s¢
)

314 
	`cvmx_©omic_ãtch_ªd_b£t32_nosync
(&
s¢
->
s¢_¡©us
, (
SSN_STATUS_GOOD
|
SSN_STATUS_HOST
));

317 
	}
}

319 
šlše
 
	$s¢_d–
(
mµ_s¢
 *
s¢
)

323 
s¢
->
‰l
 = 1;

324 
	`cvmx_©omic_ãtch_ªd_bşr32_nosync
(&
s¢
->
s¢_¡©us
,

325 
SSN_STATUS_GOOD
);

328 
	}
}

330 
šlše
 
	$s¢_ho¡_»f
(
mµ_s¢
 *
s¢
)

332 
	`cvmx_©omic_ãtch_ªd_b£t32_nosync
(&
s¢
->
s¢_¡©us
,

333 
SSN_STATUS_HOST
);

336 
	}
}

338 
šlše
 
	$s¢_ho¡_d”ef
(
mµ_s¢
 *
s¢
)

340 
	`cvmx_©omic_ãtch_ªd_bşr32_nosync
(&
s¢
->
s¢_¡©us
,

341 
SSN_STATUS_HOST
);

344 
	}
}

346 
šlše
 
	$s¢_¡©us_£t_³nd
(
mµ_s¢
 *
s¢
)

348 
	`cvmx_©omic_ãtch_ªd_bşr32_nosync
(&
s¢
->
s¢_¡©us
, 
SSN_STATUS_MACHINE_MASK
);

349 
	`cvmx_©omic_ãtch_ªd_b£t32_nosync
(&
s¢
->
s¢_¡©us
,

350 
SSN_STATUS_PEND
);

353 
	}
}

355 
šlše
 
	$s¢_¡©us_un£t_³nd
(
mµ_s¢
 *
s¢
)

357 
	`cvmx_©omic_ãtch_ªd_bşr32_nosync
(&
s¢
->
s¢_¡©us
,

358 
SSN_STATUS_PEND
);

361 
	}
}

363 
šlše
 
	$s¢_¡©us_£t_wa™
(
mµ_s¢
 *
s¢
)

365 
	`cvmx_©omic_ãtch_ªd_bşr32_nosync
(&
s¢
->
s¢_¡©us
, 
SSN_STATUS_MACHINE_MASK
);

366 
	`cvmx_©omic_ãtch_ªd_b£t32_nosync
(&
s¢
->
s¢_¡©us
,

367 
SSN_STATUS_WAIT
);

370 
	}
}

372 
šlše
 
	$s¢_¡©us_un£t_wa™
(
mµ_s¢
 *
s¢
)

374 
	`cvmx_©omic_ãtch_ªd_bşr32_nosync
(&
s¢
->
s¢_¡©us
,

375 
SSN_STATUS_WAIT
);

378 
	}
}

381 
šlše
 
	$s¢_¡©us_£t_e¡ablished
(
mµ_s¢
 *
s¢
)

383 
	`cvmx_©omic_ãtch_ªd_bşr32_nosync
(&
s¢
->
s¢_¡©us
, 
SSN_STATUS_MACHINE_MASK
);

384 
	`cvmx_©omic_ãtch_ªd_b£t32_nosync
(&
s¢
->
s¢_¡©us
,

385 
SSN_STATUS_ESTABLISHED
);

387 
	}
}

389 
šlše
 
	$s¢_¡©us_un£t_e¡ablished
(
mµ_s¢
 *
s¢
)

391 
	`cvmx_©omic_ãtch_ªd_bşr32_nosync
(&
s¢
->
s¢_¡©us
,

392 
SSN_STATUS_ESTABLISHED
);

394 
	}
}

396 
šlše
 
ušt64_t
 
	$s¢_£t_smac
(
mµ_s¢
 *
s¢
, 
ušt64_t
 
mac
)

398 
	`cvmx_©omic_ãtch_ªd_bşr64_nosync
(&
s¢
->
cÚt
.
d©a_64
[1],

401  
	`cvmx_©omic_ãtch_ªd_b£t64_nosync
(&
s¢
->
cÚt
.
d©a_64
[1],

402 
mac
&0xfffffffffffful);

405 
	}
}

407 
šlše
 
ušt64_t
 
	$s¢_£t_dmac
(
mµ_s¢
 *
s¢
, 
ušt64_t
 
mac
)

409 
	`cvmx_©omic_ãtch_ªd_bşr64_nosync
(&
s¢
->
cÚt
.
d©a_64
[2],

412  
	`cvmx_©omic_ãtch_ªd_b£t64_nosync
(&
s¢
->
cÚt
.
d©a_64
[2],

413 
mac
&0xfffffffffffful);

414 
	}
}

416 
md_dump_s¢
(
mµ_s¢
 *
s¢
);

417 
äcÜe_£t_s¢_age
(
ušt8_t
 
s¢_age
);

418 
äcÜe_g‘_s¢_age
(
ušt8_t
 *
s¢_age
);

419 
äcÜe_g‘_s¢_by_hash
(
ušt32_t
 
hash
, 
äcÜe_s¢_¡©s_t
 *
s¢_¡©s
);

420 
äcÜe_g‘_s¢_by_tu¶e
(
ušt32_t
 
s
, ušt32_ˆ
d
, 
ušt16_t
 
¥
, ušt16_ˆ
dp
,

421 
ušt8_t
 
´Ùo
, 
äcÜe_s¢_¡©_t
 *
s¢_¡©
);

422 
äcÜe_m©ch_s¢_by_tu¶e
(
ušt32_t
 
s
, ušt32_ˆ
d
, 
ušt16_t
 
¥
, ušt16_ˆ
dp
, 
ušt8_t
 
´Ùo
);

423 
mµ_s¢
 *
s¢_´•¬e
(
ušt32_t
 
s¢_šdex
, 
ušt64_t
 *
d©a
, ušt64_ˆ
mask
, 
ušt8_t
 
th_æags
,

424 
ušt32_t
 
£q
, ušt32_ˆ
ack_£q
);

425 
s¢_purge_s¢
(
mµ_s¢
 *
s¢
);

	@frcore/frcore_ssn_priv.h

2 #iâdeà
_MPP_SSN_PRIV_H


3 
	#_MPP_SSN_PRIV_H


	)

5 
	~"äcÜe_cÚfig.h
"

6 
	~"äcÜe_s¢.h
"

8 #ià
FRC_CONFIG_SSN_CHAN


19 
šlše
 
mµ_s¢
 * 
	$s¢_lookup_by_tu¶e
(
ušt32_t
 
šdex
, 
mµ_tu¶e
 *
tu¶e
, 
ušt64_t
 
mask
)

21 
mµ_s¢
 * 
s¢
 = &
gsd©a
.s¢[
šdex
];

23 if(!(
s¢
->
s¢_¡©us
 & 
SSN_STATUS_EMPTY
)){

24 
	`MC_PRINTF_INFO
("ssn status 0x%x index 0x%x\n",

25 
s¢
->
s¢_¡©us
, 
šdex
);

26 if(((
s¢
->
key
.
d©a_64
[0]==
tu¶e
->
d©a
[0])&&((s¢->key.d©a_64[1]&
mask
)==(tuple->data[1]&mask)))

27 || ((
s¢
->
key
.
s
 =ğ
tu¶e
->
d
) &&(ssn->key.dip ==uple->sip)

28 && (
s¢
->
key
.
¥
 =ğ
tu¶e
->
dp
) &&(ssn->key.dp ==uple->sp)

29 && (
s¢
->
key
.
´Ùo
 =ğ
tu¶e
->proto))){

30 
	`MC_PRINTF_INFO
("Fšdhs¢ w™h index: 0x%x\n", 
šdex
);

31 
	`MC_PRINTF_INFO
("[0x%08x 0x%08x 0x%04x 0x%4x 0x%02x]\n",

32 
s¢
->
key
.
s
, s¢->key.
d
, s¢->key.
¥
,

33 
s¢
->
key
.
dp
, s¢->key.
´Ùo
);

34 
dÚe
;

43 
s¢
 = s¢->
Ãxt_sc
;

44 
s¢
) {

45 
	`CVMX_PREFETCH
(
s¢
->
Ãxt_sc
, 0);

46 ià(((
s¢
->
key
.
d©a_64
[0]==
tu¶e
->
d©a
[0])&&(s¢->key.d©a_64[1]&
mask
)==(tuple->data[1]&mask))

47 ||((
s¢
->
key
.
s
 =ğ
tu¶e
->
d
) &&(ssn->key.dip ==uple->sip)

48 && (
s¢
->
key
.
¥
 =ğ
tu¶e
->
dp
) &&(ssn->key.dp ==uple->sp)

49 && (
s¢
->
key
.
´Ùo
 =ğ
tu¶e
->proto))) {

50 
	`MC_PRINTF_INFO
("Findhe ssn with index: 0x%x",

51 
šdex
);

52 
	`MC_PRINTF_INFO
("[0x%08x 0x%08x 0x%04x 0x%4x 0x%02x]\n",

53 
s¢
->
key
.
s
, s¢->key.
d
, s¢->key.
¥
,

54 
s¢
->
key
.
dp
, s¢->key.
´Ùo
);

55 
dÚe
;

57 
s¢
 = s¢->
Ãxt_sc
;

59 
	`MC_PRINTF_INFO
("NÙ Fšdhs¢ w™h index: 0x%x\n", 
šdex
);

60  
NULL
;

61 
dÚe
:

62  
s¢
;

63 
	}
}

65 
šlše
 
	$s¢_add_tim”
(
mµ_s¢
 *
s¢
, 
ušt64_t
 
ticks
)

67 
	`MC_PRINTF_INFO
("s¢‡ddim” %p\n", 
s¢
);

68 if(
	`cvmx_uÆik–y
(
	`cvmx_tim_add_’Œy
((
cvmx_wqe_t
*)
s¢
, 
ticks
, 
NULL
))){

70 
	`FRCORE_STAT_INC
(
¡©_s¢_tim_çed
);

74 
	`FRCORE_STAT_INC
(
¡©_s¢_tim_addok
);

77 
	}
}

79 
šlše
 
	$s¢_execu‹_·ck‘
(
cvmx_wqe_t
 *
wÜk
,

80 
mµ_s¢
 *
s¢
, 
mµ_cÚŒŞ
 *
mµ
, 
ušt8_t
 
dœeùiÚ
)

82 if(!(
s¢
->
s¢_¡©us
 & 
SSN_STATUS_MACHINE_MASK
)) {

83 
	`MC_PRINTF_ERR
("s¢ s¢_¡©u 0x%x\n", 
s¢
->
s¢_¡©us
);

89 
	`MC_PRINTF_DEBUG
("ssn->key.epif=%d, ssn->key.ipif=%d, ssn->index=0x%x\n", \

90 
s¢
->
key
.
•if
, s¢->key.
if
, s¢->
s¢_šdex
);

92 
s¢
->
‰l
 = s¢->
age
;

93 
CVMX_SYNCWS
;

95 
s¢
->
key
.
aùiÚ
){

96 
MPP_SSN_ACTION_DROP
:

99 
MPP_SSN_ACTION_HOST
:

102 
MPP_SSN_ACTION_TCPFLOWREC
:

103 
	`tı_æow_»cov”y
(
wÜk
, 
s¢
, 
mµ
, 
dœeùiÚ
);

104 
	`FRCORE_STAT_INC
(
¡©_s¢_fwd_tıæow»c
);

106 
MPP_SSN_ACTION_MIRROR
:

112 
	}
}

	@frcore/frcore_stat.c

1 
	~"äcÜe.h
"

2 
	~"äc_ut.h
"

4 
	~"äcÜe_¡©.h
"

5 
	~"äcÜe_debug.h
"

6 
	~"äcÜe_cmd.h
"

7 
CVMX_SHARED
 
ušt64_t
 
ıu_äeq
;

9 
	$äcÜe_¡©_add64
(
út
, 
št64_t
 
v®ue
)

11 
	`cvmx_çu_©omic_add64
(
	`FRCORE_STAT_REG
(
út
), 
v®ue
);

12 
	}
}

14 
	$äcÜe_¡©_£t64
(
út
, 
št64_t
 
v®ue
)

16 
	`cvmx_çu_©omic_wr™e64
(
	`FRCORE_STAT_REG
(
út
), 
v®ue
);

17 
	}
}

19 
št64_t
 
	$äcÜe_¡©_ãtch_ªd_add64
(
út
, 
ušt64_t
 
v®ue
)

21  
	`cvmx_çu_ãtch_ªd_add64
(
	`FRCORE_STAT_REG
(
út
), 
v®ue
);

22 
	}
}

26 
	$äcÜe_¡©_dump
()

28 
ušt64_t
 
v64
;

29 
i
;

30 
¡©_Çme
[
FRC_STAT_NAME_SIZE
];

31 
ušt64_t
 
£cÚds
;

33 
£cÚds
 = 
	`cvmx_g‘_cyşe
(è/ 
ıu_äeq
;

34 
	`´štf
("CYCLE %Îd u°time:%.5d:%.2d:%.2d\n", (
ULL
è
	`cvmx_g‘_cyşe
(),

35 ()
£cÚds
/3600, ()(seconds%3600)/60, ()seconds%60);

37 
i
 = 0; i < 
¡©_max
; i++)

39 
v64
 = 0;

40 
v64
 = 
	`FRCORE_STAT_VAL
(
i
);

41 ià(
v64
 > 0) {

42 
	`äc_¡©_Çme_g‘
(
i
, 
¡©_Çme
);

43 
	`´štf
("%-20s: %Îd\n", 
¡©_Çme
, (
ULL
è
v64
);

48 
	}
}

50 
	$äcÜe_¡©_ş—r
()

52 
i
;

54 
i
 = 0; i < 
¡©_max
; i++)

56 #ià
FRC_CONFIG_SSN


57 ià(
i
 =ğ
¡©_s¢_aùive_num
) {

61 
	`cvmx_çu_©omic_wr™e64
(
	`FRCORE_STAT_REG
(
i
), 0);

63 
	}
}

65 
	$äcÜe_cmd_g‘_¡©
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

67 
i
;

68 
äc_¡©_İ_š_t
 *
šput
 = (äc_¡©_İ_š_ˆ*è
·¿m
;

69 
ušt64_t
 *
v64p
;

71 
	`FRCORE_CMD
("¶’ %d,…¬am %p, *ŞÃ %d, outbuà%p.\n", 
¶’
, 
·¿m
, *
Ş’
, 
outbuf
);

73 
v64p
 = 
outbuf
;

74 
i
 = 0; i < 
šput
->
num
; i++, 
v64p
++)

76 *
v64p
 = 
	`FRCORE_STAT_VAL
(
šput
->
šdex
 + 
i
);

79 *
Ş’
 = 
šput
->
num
 * (
ušt64_t
);

82 
	}
}

84 
	$äcÜe_cmd_ş—r_¡©
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

86 *
Ş’
 = 0;

87 
	`äcÜe_¡©_ş—r
();

88  
FRE_SUCCESS
;

89 
	}
}

91 
	$äcÜe_¡©_š™
()

93 
	`äcÜe_¡©_ş—r
();

95 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_GET_STAT
, 
äcÜe_cmd_g‘_¡©
);

96 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_CLEAR_STAT
, 
äcÜe_cmd_ş—r_¡©
);

99 
	}
}

101 *
	gpoŞ_Çme
[] = {

109 
	$äcÜe_´št_poŞ_couÁ_¡©s
()

111 
	`´štf
("Pool stats: \n");

112 
	`´štf
("[PoŞ %d <%18s>: siz%.4dƒÁry %.7d f»%.7Îu ]\n", 0, 
poŞ_Çme
[0],

113 
CVMX_FPA_POOL_0_SIZE
, 
FPA_PACKET_POOL_COUNT
,
	`ÿ¡64
(
	`cvmx_»ad_c¤
(
	`CVMX_FPA_QUEX_AVAILABLE
(0))));

114 
	`´štf
("[PoŞ %d <%18s>: siz%.4dƒÁry %.7d f»%.7Îu ]\n", 1, 
poŞ_Çme
[1],

115 
CVMX_FPA_POOL_1_SIZE
, 0,
	`ÿ¡64
(
	`cvmx_»ad_c¤
(
	`CVMX_FPA_QUEX_AVAILABLE
(1))));

116 
	`´štf
("[PoŞ %d <%18s>: siz%.4dƒÁry %.7d f»%.7Îu ]\n", 2, 
poŞ_Çme
[2],

117 
CVMX_FPA_POOL_2_SIZE
, 
FPA_WQE_POOL_COUNT
,
	`ÿ¡64
(
	`cvmx_»ad_c¤
(
	`CVMX_FPA_QUEX_AVAILABLE
(2))));

118 
	`´štf
("[PoŞ %d <%18s>: siz%.4dƒÁry %.7d f»%.7Îu ]\n", 3, 
poŞ_Çme
[3],

119 
CVMX_FPA_POOL_3_SIZE
, 
FPA_OQ_POOL_COUNT
,
	`ÿ¡64
(
	`cvmx_»ad_c¤
(
	`CVMX_FPA_QUEX_AVAILABLE
(3))));

120 
	`´štf
("[PoŞ %d <%18s>: siz%.4dƒÁry %.7d f»%.7Îu ]\n", 4, 
poŞ_Çme
[4],

121 
CVMX_FPA_POOL_4_SIZE
, 
FPA_TIMER_POOL_COUNT
,
	`ÿ¡64
(
	`cvmx_»ad_c¤
(
	`CVMX_FPA_QUEX_AVAILABLE
(4))));

122 
	}
}

126 
	$äcÜe_cÜe_´št_pow
()

128 
k
 = 0;

129 
	`´štf
("-- POW/SSO queue info --\n");

130 
k
 = 0; k < 8; k++)

132 
cvmx_pow_iq_útx_t
 
iq_út
;

133 
iq_út
.
u64
 = 
	`cvmx_»ad_c¤
(
	`CVMX_POW_IQ_CNTX
(
k
));

134 
	`´štf
(" QoS [%d], iÀqueuusšg %d\n", 
k
, 
iq_út
.
s
.iq_cnt);

137 
cvmx_pow_iq_com_út_t
 
com_út
;

138 
com_út
.
u64
 = 
	`cvmx_»ad_c¤
(
CVMX_POW_IQ_COM_CNT
);

139 
	`´štf
(" IQ AÎ %d\n", 
com_út
.
s
.
iq_út
);

142 
cvmx_pow_nos_út_t
 
nos_út
;

143 
nos_út
.
u64
 = 
	`cvmx_»ad_c¤
(
CVMX_POW_NOS_CNT
);

144 
	`´štf
(" NoscheduË CouÁ %u\n", 
nos_út
.
s
.nos_cnt);

147 
k
 = 0; k < 8; k++)

149 
cvmx_pow_qos_thrx_t
 
thrx
;

150 
thrx
.
u64
 = 
	`cvmx_»ad_c¤
(
	`CVMX_POW_QOS_THRX
(
k
));

151 
	`´štf
("hreshold, QoS %d, DES_CNT %04d, BUF_CNT %04d, FREE_CNT %04d, MAX_THR %04d, MIN_THR %04d\n",

152 
k
, 
thrx
.
s
.
des_út
,hrx.s.
buf_út
,hrx.s.
ä“_út
,hrx.s.
max_thr
,hrx.s.
mš_thr
);

154 
	}
}

158 
	$äcÜe_cÜe_´št_p_pko_¡©
()

160 
cvmx_p_pÜt_¡©us_t
 
¡©
;

161 
cvmx_pko_pÜt_¡©us_t
 
¡©_pko
;

162 
i
, 
fœ¡_pÜt
 = 0, 
num_pÜts
 = 6;

163 
pÜt
[32] = {0, 16, 32, 33, 34, 35};

166 
	`´štf
("\nPIP Stat:\n");

167 
i
 = 0; i < 
num_pÜts
; i++) {

168 
	`cvmx_p_g‘_pÜt_¡©us
(
pÜt
[
i
], 0, &
¡©
);

169 ià(
¡©
.
šb_·ck‘s
)

170 
	`´štf
("port %02d, [recvotal %u drop %u,ƒrr %u],…roc %u,mcast %u,bcast %u,crcƒrr %u,minƒrr %u,maxƒrr %u\n",

171 
pÜt
[
i
], 
¡©
.
šb_·ck‘s
, st.
drİ³d_·ck‘s
, st.
šb_”rÜs
, st.
·ck‘s
, st.
muÉiÿ¡_·ck‘s
,

172 
¡©
.
brßdÿ¡_·ck‘s
, st.
fcs_®ign_”r_·ck‘s
, st.
ruÁ_·ck‘s
, st.
ov”size_·ck‘s
);

175 
	`´štf
("\nPKO Stat:\n");

176 
i
 = 0; i < 
num_pÜts
; i++) {

177 
	`cvmx_pko_g‘_pÜt_¡©us
(
pÜt
[
i
], 0, &
¡©_pko
);

178 if(
¡©_pko
.
·ck‘s
 || st_pko.
doÜb–l
)

179 
	`´štf
("PÜˆ%02d: doÜb–l: %Îu s’d…kts: %u \n", 
pÜt
[
i
], 
	`ÿ¡64
(
¡©_pko
.
doÜb–l
), st_pko.
·ck‘s
);

182 
	}
}

	@frcore/frcore_stat.h

1 
	~"äc_ty³s.h
"

2 
	~"äcÜe_cÚfig.h
"

3 
	~"äc_cÚfig.h
"

5 
	#FRCORE_STAT_FAU_OFFSET
 0x100

	)

7 
	#FRCORE_STAT_REG
(
_idx
) \

8 (
cvmx_çu_»g_64_t
)(
CVMX_FAU_REG_AVAIL_BASE
 + 
FRCORE_STAT_FAU_OFFSET
 + (
_idx
è* (
ušt64_t
))

	)

10 
	#FRCORE_STAT_VAL
(
_idx
) \

11 (
ušt64_t
è
	`cvmx_çu_ãtch_ªd_add64
(
	`FRCORE_STAT_REG
(
_idx
), 0)

	)

13 
äcÜe_¡©_add64
(
út
, 
št64_t
 
v®ue
);

14 
št64_t
 
äcÜe_¡©_ãtch_ªd_add64
(
út
, 
ušt64_t
 
v®ue
);

16 
	#FRCORE_STAT_ADD
(
_út
, 
_v®
) \

17 
	`äcÜe_¡©_add64
(
_út
, 
_v®
)

	)

19 
	#FRCORE_STAT_INC
(
_út
è
	`äcÜe_¡©_add64
((_út), 1)

	)

21 
	#FRCORE_STAT_FETCH_AND_ADD
(
_út
, 
_v®
) \

22 
	`äcÜe_¡©_ãtch_ªd_add64
(
_út
, 
_v®
)

	)

24 
äcÜe_¡©_š™
();

25 
äcÜe_¡©_dump
();

26 
äcÜe_´št_poŞ_couÁ_¡©s
();

27 
äcÜe_cÜe_´št_pow
();

28 
äcÜe_cÜe_´št_p_pko_¡©
();

30 #ià
FRCORE_CFG_DUMP_CYCLE


32 
	#FRCORE_CYCLE_REC_NUM
 100

	)

35 
	mfunc
[64];

36 
	mlše
;

37 
ušt64_t
 
	mcyşe
;

38 } 
	täcÜe_cyşe_¡•_t
;

41 
	midx
;

42 
ušt64_t
 
	m¡¬t_cyşe
;

43 
ušt64_t
 
	mÏ¡_cyşe
;

44 
äcÜe_cyşe_¡•_t
 
	m¡•s
[
FRCORE_CYCLE_REC_NUM
];

45 } 
	täcÜe_cyşe_»c_t
;

47 
äcÜe_cyşe_»c_t
 
äcÜe_cyşe_»cod”
;

49 
	#FRCORE_CYCLE_RECORDER_INIT
() \

51 
	`mem£t
(&
äcÜe_cyşe_»cod”
, 0, (
äcÜe_cyşe_»c_t
)); \

52 
äcÜe_cyşe_»cod”
.
¡¬t_cyşe
 = frcÜe_cyşe_»cod”.
Ï¡_cyşe
 = 
	`cvmx_g‘_cyşe
(); \

53 }

	)

55 
	#FRCORE_CYCLE_RECORDING
() \

57 
äcÜe_cyşe_»cod”
.
¡•s
[äcÜe_cyşe_»cod”.
idx
].
cyşe
 = 
	`cvmx_g‘_cyşe
(è- frcÜe_cyşe_»cod”.
Ï¡_cyşe
; \

58 
	`¡rıy
(
äcÜe_cyşe_»cod”
.
¡•s
[äcÜe_cyşe_»cod”.
idx
].
func
, 
__func__
); \

59 
äcÜe_cyşe_»cod”
.
¡•s
[äcÜe_cyşe_»cod”.
idx
].
lše
 = 
__LINE__
;\

60 
äcÜe_cyşe_»cod”
.
idx
++; \

61 
äcÜe_cyşe_»cod”
.
Ï¡_cyşe
 = 
	`cvmx_g‘_cyşe
(); \

62 }

	)

64 
	#FRCORE_CYCLE_RECORD_DUMP
() \

66 
i
; \

67 
ušt64_t
 
®l_cyşe
 = 0; \

68 
i
 = 0; i < 
äcÜe_cyşe_»cod”
.
idx
; i++) { \

69 
	`´štf
("%32s.%-.4d:ake %-8lld cycles.\n", \

70 
äcÜe_cyşe_»cod”
.
¡•s
[
i
].
func
, frcÜe_cyşe_»cod”.¡•s[i].
lše
, \

71 (è
äcÜe_cyşe_»cod”
.
¡•s
[
i
].
cyşe
); \

72 
®l_cyşe
 +ğ
äcÜe_cyşe_»cod”
.
¡•s
[
i
].
cyşe
; \

74 
	`´štf
("%d s‹p ke %Îd cyşes.\n", 
äcÜe_cyşe_»cod”
.
idx
, \

75 (è
®l_cyşe
); \

76 }

	)

78 
	#FRCORE_CYCLE_RECORDER_INIT
()

	)

79 
	#FRCORE_CYCLE_RECORDING
()

	)

80 
	#FRCORE_CYCLE_RECORD_DUMP
()

	)

	@frcore/frcore_tcp.c

1 
	~"äcÜe_pkt.h
"

3 
	~"äcÜe_tı.h
"

4 
	~"äcÜe_¡©.h
"

6 
	~"äc_dma.h
"

7 
	~"äcÜe_chª.h
"

8 
	~"äcÜe_´Ùo.h
"

9 
	~"äcÜe_s¢.h
"

10 
	~"äcÜe_s¢_´iv.h
"

12 
CVMX_SHARED
 
ušt64_t
 
	grx_tı_pkts
 = 0;

13 
CVMX_SHARED
 
ušt32_t
 
	gtı»c_lock
 = 0;

15 #ià
FRC_CONFIG_TCP


17 
	$äcÜe_tı_´oûss
(
cvmx_wqe_t
 *
wÜk
, 
ušt8_t
 *
‘h_±r
, ušt8_ˆ*
_±r
, ušt8_ˆ*
tı_±r
, 
ušt16_t
 
_·yËn
, 
ušt64_t
 
smac
, ušt64_ˆ
dmac
)

19 
rv
;

20 
äc_dma_hdr_t
 
hdr
;

21 
äc_dma_pkt_šfo_t
 
šfo
;

22 
‘h_Ën
;

24 
	`FRCORE_CYCLE_RECORDING
();

26 
	`FRCORE_PKT
("==============ğrx_tı_pkt %Îd.\n", (
ULL
è++
rx_tı_pkts
);

28 
	`mem£t
(&
hdr
, 0, (
äc_dma_hdr_t
));

29 
	`mem£t
(&
šfo
, 0, (
äc_dma_pkt_šfo_t
));

31 
	`UP32
(
_±r
 + 12, 
hdr
.
s
);

33 
	`UP32
(
_±r
 + 16, 
hdr
.
d
);

35 
	`UP16
(
tı_±r
, 
hdr
.
¥Üt
);

36 
	`UP16
(
tı_±r
 + 2, 
hdr
.
dpÜt
);

38 
‘h_Ën
 = 
wÜk
->
Ën
;

40 
hdr
.
´ÙocŞ
 = 
PROTO_TCP
;

41 
hdr
.
hash
 = 
wÜk
->
g
 & 0xffffff;

42 
hdr
.
šfo_off£t
 = 
FRC_DMA_PKT_INFO_OFFSET
;

43 
hdr
.
pkt_num
 = 1;

44 
hdr
.
tÙ®_·yËn
 = 
‘h_Ën
;

46 
šfo
.
d©a_off£t
 = 0;

47 
šfo
.
·ylßd_Ën
 = 
‘h_Ën
;

48 
šfo
.
smac
 = smac;

49 
šfo
.
dmac
 = dmac;

51 
rv
 = 
	`äcÜe_fÜw¬d_pkt_to_ho¡
(
FRC_TCP_QUEUE
, &
hdr
, &
šfo
, 
‘h_±r
);

52 ià(
rv
)

54 
	`FRCORE_TCP
("äcÜe_fÜw¬d_tı_pkt_to_ho¡„‘uº %d,ƒth_ËÀ%d.\n", 
rv
, 
‘h_Ën
);

55 
	`FRCORE_STAT_INC
(
¡©_dma_”rÜs
);

58  
FRCORE_ACT_FORWARD
;

59 
	}
}

61 
	$äcÜe_tı_´oûss
(
cvmx_wqe_t
 *
wÜk
, 
ušt8_t
 *
‘h_±r
, ušt8_ˆ*
_±r
, ušt8_ˆ*
tı_±r
, 
ušt16_t
 
_·yËn
, 
ušt64_t
 
smac
, ušt64_ˆ
dmac
)

63 
mµ_cÚŒŞ
 *
mµ
=
NULL
;

64 
mµ_tu¶e
 
tu¶e
;

65 
mµ_s¢
 *
s¢
;

66 
tıhdr
 *
th
;

67 
ušt8_t
 
th_æags
;

68 
ušt32_t
 
£q
;

69 
ušt32_t
 
ack_£q
;

70 
ušt8_t
 
dœeùiÚ
;

73 
mµ
 = (
mµ_cÚŒŞ
*)(&
wÜk
->
·ck‘_d©a
[0]);

74 
mµ
->
·ck‘
 = (
ušt8_t
 *)
	`cvmx_phys_to_±r
(
wÜk
->
·ck‘_±r
.
s
.
addr
);

75 
	#_IPH
 ((
hdr
*)((
ušt8_t
 *)
mµ
->
·ck‘
+
wÜk
->
wÜd2
.
s
.
_off£t
))

	)

77 
mµ
->
s¢
 = 
NULL
;

78 
mµ
->
s¢_šdex
 = 
SSN_INDEX_INVALID
;

79 
mµ
->
g
 = 0;

80 
mµ
->
vÏn_aù
 = 
MPP_VLAN_DO_NOTHING
;

81 
mµ
->
Ën_h—d”
 = 
wÜk
->
wÜd2
.
s
.
_off£t
;

83 
th
 = (
tıhdr
 *)(((
ušt8_t
*)(
_IPH
))+(_IPH->
ihl
<<2));

84 
th_æags
 = *(((
ušt8_t
 *)(
th
)) + 13);

86 if((
th_æags
 & 0x3f) == 0x3f ||

87 (
th_æags
 & 0x3f) == 0x00) {

88 
	`FRCORE_STAT_INC
(
¡©_tı_m®fÜmed_·ck‘
);

89  
FRCORE_ACT_DROP
;

92 if(((
_IPH
->
ihl
 + 
th
->
doff
è<<2è> (_IPH->
tÙ_Ën
)) {

93 
	`FRCORE_STAT_INC
(
¡©_tı_m®fÜmed_·ck‘
);

94  
FRCORE_ACT_DROP
;

96 
£q
 = 
th
->seq;

97 
ack_£q
 = 
th
->ack_seq;

100 if((
th
->
doff
 << 2) > 20) {

101 
	`FRCORE_STAT_INC
(
¡©_tı_İtiÚ
);

104 if((
_IPH
->
tÙ_Ën
è- ((_IPH->
ihl
 + 
th
->
doff
) <<2) == 0) {

105 
	`FRCORE_STAT_INC
(
¡©_tı_·ylßd_z”o
);

108 
mµ
->
udph
 = (
udphdr
*)(((
ušt8_t
*)(
_IPH
))+(_IPH->
ihl
<<2));

111 
tu¶e
.
d©a
[0] = *((
ušt64_t
*)(((*)
_IPH
)+12));

114 
tu¶e
.
d©a
[1] = 0ul;

115 
tu¶e
.
d©a_32
[2] = *(
ušt32_t
*)(
mµ
->
udph
);

116 
tu¶e
.
´Ùo
 = 
_IPH
->
´ÙocŞ
;

121 
mµ_tu¶e
 
tu¶e_sÜt
;

122 
mµ_tu¶e
 
tu¶e_pos™ive
;

123 
	`s¢_sÜt_tu¶e
(&
tu¶e
, &
tu¶e_sÜt
);

124 
mµ
->
s¢_šdex
 = 
	`s¢_hash_by_tu¶e
(
tu¶e_sÜt
.
d©a
, 
SSN_HASH_BUCKET_SIZE_MASK
);

125 
s¢
 = &
gsd©a
.s¢[
mµ
->
s¢_šdex
];

126 
ušt32_t
 *
s_¢ifãr
 = &
s¢
->
s¢_¡©us
;

127 
	`cvmx_¥šlock_b™_lock
(
s_¢ifãr
);

129 
mµ
->
s¢
 = 
	`s¢_lookup_by_tu¶e
(mµ->
s¢_šdex
, &
tu¶e_sÜt
, 
MPP_SSN_HASH_MASK_SNIFFER
);

130 if(!
mµ
->
s¢
) {

133 
mµ
->
s¢
 = 
	`s¢_´•¬e
(mµ->
s¢_šdex
, 
tu¶e
.
d©a
, 
MPP_SSN_HASH_MASK_DATA64
, 
th_æags
, 
£q
, 
ack_£q
);

135 if(
	`cvmx_uÆik–y
(!
mµ
->
s¢
)) {

138 
	`FRCORE_STAT_INC
(
¡©_s¢_ç
);

139 
	`cvmx_¥šlock_b™_uÆock
(
s_¢ifãr
);

140  
FRCORE_ACT_DROP
;

143 
mµ
->
s¢
->
key
.
d©a_64
[2] = 1;

144 
mµ
->
s¢
->
key
.
d©a_64
[3] = 
wÜk
->
Ën
;

145 
mµ
->
s¢
->
key
.
aùiÚ
 = 
MPP_SSN_ACTION_TCPFLOWREC
;

148 
mµ
->
s¢
->
tı_æow_pos™ive_d©a
.
t£gqe_Ën
 = 0;

149 
mµ
->
s¢
->
tı_æow_pos™ive_d©a
.
rcv_nxt
 = 0;

150 
mµ
->
s¢
->
tı_æow_pos™ive_d©a
.
h—d
.
lh_fœ¡
 = 
NULL
;

151 
mµ
->
s¢
->
tı_æow_Ãg©ive_d©a
.
t£gqe_Ën
 = 0;

152 
mµ
->
s¢
->
tı_æow_Ãg©ive_d©a
.
rcv_nxt
 = 0;

153 
mµ
->
s¢
->
tı_æow_Ãg©ive_d©a
.
h—d
.
lh_fœ¡
 = 
NULL
;

154 
mµ
->
s¢
->
tı_æow_pos™ive_d©a
.
»v_æow_d©a
 = &mµ->s¢->
tı_æow_Ãg©ive_d©a
;

155 
mµ
->
s¢
->
tı_æow_Ãg©ive_d©a
.
»v_æow_d©a
 = &mµ->s¢->
tı_æow_pos™ive_d©a
;

156 
	`MC_PRINTF_INFO
("\n");

157 
	`FRCORE_STAT_INC
(
¡©_s¢_´•¬e
);

158 
	`s¢_add
(
mµ
->
s¢
);

159 
	`s¢_£t_smac
(
mµ
->
s¢
, 
smac
);

160 
	`s¢_£t_dmac
(
mµ
->
s¢
, 
dmac
);

168 
tu¶e_pos™ive
.
d©a
[0] = 
mµ
->
s¢
->
key
.
d©a_64
[0];

169 
tu¶e_pos™ive
.
d©a
[1] = 
mµ
->
s¢
->
key
.
d©a_64
[1] & 
MPP_SSN_HASH_MASK_DATA64
;

170 
dœeùiÚ
 = 
	`s¢_dœeùiÚ_tu¶e
(&
tu¶e
, &
tu¶e_pos™ive
);

171 
	`s¢_execu‹_·ck‘
(
wÜk
, 
mµ
->
s¢
, mµ, 
dœeùiÚ
);

174 
	`cvmx_¥šlock_b™_uÆock
(
s_¢ifãr
);

175 
ü¦k
;

178 
ü¦k
:

179  
FRCORE_ACT_UNFREE
;

180 #undeà
_IPH


181 
	}
}

184 #ià
FRC_CONFIG_AGE


185 
	$äcÜe_s¢_age_´oûss
(
cvmx_wqe_t
 *
wÜk
)

188 #ià!
FRC_CONFIG_SSN_ATOMIC


189 if(
wÜk
->
g½
 =ğ
GROUP_TO_DATA_PLANE_AGING
){

192 
mµ_s¢
 *
s¢
 = (mµ_s¢*)
wÜk
;

193 
mµ_s¢
 *
s¢1
=&
gsd©a
.
s¢
[s¢->
s¢_šdex
];

194 
ušt32_t
 *
s
 = &
s¢1
->
s¢_¡©us
;

195 
	`FRCORE_STAT_INC
(
¡©_s¢_tim_fœed
);

196 if(
	`cvmx_©omic_ãtch_ªd_add32
(&
s¢
->
‰l
, -1)==0){

199 
	`cvmx_¥šlock_b™_lock
(
s
);

200 ià(
s¢
->
key
.
tıæow»c
) {

201 
	`tı_æow_æush_lock
(
s¢
);

204 
	`MC_PRINTF_INFO
("s¢…urgs¢ s¢->key.tıæow»c: %u\n", 
s¢
->
key
.
tıæow»c
);

205 
	`s¢_purge_s¢
(
s¢
);

206 
	`cvmx_¥šlock_b™_uÆock
(
s
);

209  
FRE_SUCCESS
;

211 
	`FRCORE_SSN
("s¢ %d\n", 
s¢
->
‰l
);

212 if(
	`s¢_add_tim”
(
s¢
, 
MC_SSN_TTL_UNIT
)<0) {

213 
	`cvmx_¥šlock_b™_lock
(
s
);

214 
	`MC_PRINTF_ERR
("Tim‡dd failed!\n");

215 ià(
s¢
->
key
.
tıæow»c
) {

216 
	`´štf
("s¢->key.tıæow»ø=ğ%d\n", 
s¢
->
key
.
tıæow»c
);

217 
	`tı_æow_æush_lock
(
s¢
);

219 
	`s¢_purge_s¢
(
s¢
);

220 
	`cvmx_¥šlock_b™_uÆock
(
s
);

222 
	`FRCORE_SSN
("ssn‡ddimer == 0\n");

224 #ià!
FRC_CONFIG_SSN_ATOMIC


227 
	`MC_PRINTF_ERR
("Unknow grou°%d %p\n", 
wÜk
->
g½
, work);

228  
FRE_FAIL
;

231  
FRE_SUCCESS
;

232 
	}
}

	@frcore/frcore_tcp.h

1 #iâdeà
_FRCORE_TCP_H_


2 
	#_FRCORE_TCP_H_


	)

4 
	#TCP_FLAG
(
_v®
, 
_æag
è(_v® & _æag)

	)

6 
	#TCP_FLAG_URG
(
_v®
è
	`TCP_FLAG
((_v®), 0x20)

	)

7 
	#TCP_FLAG_ACK
(
_v®
è
	`TCP_FLAG
((_v®), 0x10)

	)

8 
	#TCP_FLAG_PSH
(
_v®
è
	`TCP_FLAG
((_v®), 0x08)

	)

9 
	#TCP_FLAG_RST
(
_v®
è
	`TCP_FLAG
((_v®), 0x04)

	)

10 
	#TCP_FLAG_SYN
(
_v®
è
	`TCP_FLAG
((_v®), 0x02)

	)

11 
	#TCP_FLAG_FIN
(
_v®
è
	`TCP_FLAG
((_v®), 0x01)

	)

13 
äcÜe_tı_´oûss
(
cvmx_wqe_t
 *
wÜk
, 
ušt8_t
 *
‘h_±r
, ušt8_ˆ*
_±r
, ušt8_ˆ*
tı_±r
, 
ušt16_t
 
_·yËn
, 
ušt64_t
 
smac
, ušt64_ˆ
dmac
);

14 #ià
FRC_CONFIG_AGE


15 
äcÜe_s¢_age_´oûss
(
cvmx_wqe_t
 *
wÜk
);

	@frcore/frcore_tcpflowrec.c

5 
	~<¡dio.h
>

6 
	~<¡ršg.h
>

7 
	~<¡dlib.h
>

8 
	~<¡dšt.h
>

9 
	~<¡ddef.h
>

10 
	~<”ºo.h
>

12 
	~"cvmx-cÚfig.h
"

13 
	~"cvmx.h
"

14 
	~"cvmx-h–³r.h
"

15 
	~"cvmx-pko.h
"

16 
	~"cvmx-wqe.h
"

17 
	~"cvmx-sw­.h
"

18 
	~"äcÜe_´Ùo.h
"

19 
	~"äcÜe_s¢.h
"

20 
	~"äcÜe_tıæow»c.h
"

21 
	~"cvm-driv”-defs.h
"

22 
	~"cvm-pci.h
"

23 
	~"äcÜe_debug.h
"

24 
	~"äcÜe_´oc.h
"

25 
	~"äcÜe_dma.h
"

26 
	~"äcÜe_¡©.h
"

27 
	~"äc_ut.h
"

28 
	~"äcÜe_pkt.h
"

29 
	~"äcÜe_chª.h
"

33 
	gddoq_pkt_couÁ
[2000];

35 
CVMX_SHARED
 
ušt8_t
 
	gdisÜd”_d•th
 = 5;

36 #ià
FRC_CONFIG_SSN_CHAN


37 
CVMX_SHARED
 
ušt64_t
 
	gddoq_šdex
 = 0;

38 
CVMX_SHARED
 
ušt64_t
 
	gpkts_couÁ
 = 0;

41 
CVMX_SHARED
 
ušt64_t
 
ıu_äeq
;

42 
ušt8_t
 
	gs¢_block_exhau¡
[
FRC_SIMPLE_PACKAGE_SIMPLE_CHAN_FIFO_NUM
] = {0};

43 
ušt64_t
 
	gs¢_Ï¡_di¥Ïy
[
FRC_SIMPLE_PACKAGE_SIMPLE_CHAN_FIFO_NUM
] = {0};

44 
	$g‘_s¢_dœeùiÚ
(
mµ_s¢
 *
s¢
, 
ušt16_t
 *
dœeùiÚ
)

46 
ušt32_t
 
šdex
;

47 
mµ_s¢
 *
s¢_pos™ive
;

49 ià(
s¢
 =ğ
NULL
) {

50  
FRE_MEMORY
;

53 
šdex
 = 
s¢
->
s¢_šdex
;

54 
s¢_pos™ive
 = &
gsd©a
.
s¢
[
šdex
];

55 ià(
s¢_pos™ive
->
key
.
s
 =ğ
s¢
->key.sip) {

56 *
dœeùiÚ
 = 
FRC_SSN_POSIVTE_FLOW
;

57 }if(
s¢_pos™ive
->
key
.
s
 =ğ
s¢
->key.
d
){

58 *
dœeùiÚ
 = 
FRC_SSN_NEGATIVE_FLOW
;

60  
FRE_FAIL
;

62  
FRE_SUCCESS
;

63 
	}
}

65 
	$check_s¢_addr
(
äc_s¢_subm™_addr
 *
s¢_addr
, 
ušt32_t
 
fifo_id
)

67 
ušt16_t
 
æag
;

68 
ušt64_t
 
block_addr
;

69 
cÜe_num
;

70 ià(
s¢_addr
 =ğ
NULL
) {

71  
FRE_MEMORY
;

74 
cÜe_num
 = 
	`cvmx_g‘_cÜe_num
();

76 
æag
 = 
s¢_addr
->
addr_æag
;

77 ià(!
æag
)

79 ià(
s¢_block_exhau¡
[
cÜe_num
]) {

80 ià(
	`cvmx_g‘_cyşe
(è- 
s¢_Ï¡_di¥Ïy
[
cÜe_num
]

81 < (
ıu_äeq
 / 
DMA_CHANNEL_REST_DIV
))

83  
FRE_NOSPACE
;

88 ià(
	`äcÜe_s¢_g‘_Úe_block_addr
(&
block_addr
, 
fifo_id
))

90 
s¢_block_exhau¡
[
cÜe_num
] = 1;

91 
s¢_Ï¡_di¥Ïy
[
cÜe_num
] = 
	`cvmx_g‘_cyşe
();

92 
	`FRCORE_ERROR
("frcore_ssn_chan_avail_get failed!\n");

93  
FRE_NOSPACE
;

95 
s¢_block_exhau¡
[
cÜe_num
] = 0;

97 
s¢_addr
->
block_addr
 = block_addr;

98 
s¢_addr
->
h—d_off£t
 = 
FRC_DMA_OFFSET
;

99 
s¢_addr
->
·ylßd_off£t
 = 
FRC_DMA_OFFSET
 + (
äc_dma_hdr_t
);

100 
s¢_addr
->
šfo_off£t
 = 
FRC_DMA_SSN_BLOCK_SIZE
 - (
äc_dma_pkt_šfo_t
);

101 
s¢_addr
->
·ylßd_Ën
 = 0;

102 
s¢_addr
->
pkt_num
 = 0;

103 
s¢_addr
->
addr_æag
 = 1;

104 
CVMX_SYNCWS
;

106  
FRE_SUCCESS
;

108 
	}
}

110 
	$¡©_s¢_block
(
ušt64_t
 
pkt_num
)

112 
šdex
;

113 ià(
pkt_num
 <= 5) {

114 
šdex
 = ()(
pkt_num
 - 1);

116 
šdex
 = 5;

118 
	`FRCORE_STAT_INC
((
¡©_s¢_1·ck‘_blocks
 + 
šdex
));

119 
	`FRCORE_STAT_INC
(
¡©_s¢_dma_blocks
);

120 
	}
}

123 
	$sbum™_dma_h—d”_to_fifo
(
mµ_s¢
 *
s¢
)

125 #ià
FRC_CONFIG_SSN_CLOSE_SUBMIT_DATA


127 
rv
;

128 
äc_s¢_subm™_addr
 *
s¢_addr
=
NULL
;

129 
äc_dma_hdr_t
 
hdr
;

132 
s¢_addr
 = &
s¢
->ssn_addr;

134 ià(
s¢_addr
->
addr_æag
 ) {

137 
hdr
.
s
 = 
s¢
->
key
.sip;

138 
hdr
.
d
 = 
s¢
->
key
.dip;

139 
hdr
.
¥Üt
 = 
s¢
->
key
.
¥
;

140 
hdr
.
dpÜt
 = 
s¢
->
key
.
dp
;

141 
hdr
.
´ÙocŞ
 = 
s¢
->
key
.
´Ùo
;

142 
hdr
.
¡İ_£c
 = 0;

143 
hdr
.
hash
 = 
s¢
->
s¢_šdex
;

144 
hdr
.
tÙ®_·yËn
 = 
s¢_addr
->
·ylßd_Ën
;

145 
hdr
.
pkt_num
 = 
s¢_addr
->pkt_num;

147 
rv
 = 
	`äcÜe_fÜw¬d_s¢_pkt_to_fifo
(
FRC_WORK_SSN
, 
s¢
->
s¢_šdex
, 
FRC_SSN_DMA_HEAD
,

148 &
hdr
, 
NULL
, NULL, 
s¢_addr
->
block_addr
,

149 0, 0, 
NULL
);

150 ià(
rv
) {

151 
	`FRCORE_STAT_INC
(
¡©_s¢_dma_h—d_ç
);

152 
	`´štf
("%s,%d,rv=%d\n", 
__FUNCTION__
, 
__LINE__
, 
rv
);

153  
rv
;

155 
	`¡©_s¢_block
(
hdr
.
pkt_num
);

158 
s¢_addr
->
addr_æag
 = 0;

159 
CVMX_SYNCWS
;

162  
FRE_SUCCESS
;

163 
	}
}

167 
	$sbum™_d©a_to_fifo
(
t£g_q’t
 *
cu¼’t
, 
mµ_s¢
 *
s¢
)

169 #ià
FRC_CONFIG_SSN_CLOSE_SUBMIT_DATA


170 
cvmx_wqe_t
 *
wqe
 = 
cu¼’t
->
wÜk
;

171 
	`äcÜe_wÜk_ä“
(
wqe
);

173 
rv
;

174 
cvmx_wqe_t
 *
wqe
 = 
cu¼’t
->
wÜk
;

175 
ušt32_t
 
šdex
;

176 
ušt32_t
 
fifo_id
;

177 
äc_s¢_subm™_addr
 *
s¢_addr
=
NULL
;

178 
äc_dma_hdr_t
 
hdr
;

179 
äc_dma_pkt_šfo_t
 
šfo
;

180 
ušt64_t
 
d©a_Ën
;

181 
ušt8_t
 *
·ylßd
;

183 
šdex
 = 
s¢
->
s¢_šdex
;

184 
fifo_id
 = 
šdex
 % 
FRC_SSN_FIFO_NUM
;

187 
s¢_addr
 = &
s¢
->ssn_addr;

190 
rv
 = 
	`check_s¢_addr
(
s¢_addr
, 
fifo_id
);

191 ià(
rv
) {

192 
	`FRCORE_ERROR
("%s,%d,rv=%d\n", 
__FUNCTION__
, 
__LINE__
, 
rv
);

193 
	`äcÜe_wÜk_ä“
(
wqe
);

194  
rv
;

199 
d©a_Ën
 = 
cu¼’t
->data_len;

200 ià(
s¢_addr
->
·ylßd_off£t
 + 
d©a_Ën
 > s¢_addr->
šfo_off£t
 ) {

202 
hdr
.
s
 = 
s¢
->
key
.sip;

203 
hdr
.
d
 = 
s¢
->
key
.dip;

204 
hdr
.
¥Üt
 = 
s¢
->
key
.
¥
;

205 
hdr
.
dpÜt
 = 
s¢
->
key
.
dp
;

206 
hdr
.
´ÙocŞ
 = 
s¢
->
key
.
´Ùo
;

207 
hdr
.
¡İ_£c
 = 0;

208 
hdr
.
hash
 = 
s¢
->
s¢_šdex
;

209 
hdr
.
tÙ®_·yËn
 = 
s¢_addr
->
·ylßd_Ën
;

210 
hdr
.
pkt_num
 = 
s¢_addr
->pkt_num;

212 
rv
 = 
	`äcÜe_fÜw¬d_s¢_pkt_to_fifo
(
FRC_WORK_SSN
, 
s¢
->
s¢_šdex
,
FRC_SSN_DMA_HEAD
,

213 &
hdr
, 
NULL
, NULL,
s¢_addr
->
block_addr
,

214 0, 0, 
NULL
);

215 ià(
rv
) {

216 
	`FRCORE_STAT_INC
(
¡©_s¢_dma_h—d_ç
);

217 
	`´štf
("%s,%d,rv=%d\n", 
__FUNCTION__
, 
__LINE__
, 
rv
);

218 
	`äcÜe_wÜk_ä“
(
wqe
);

219  
rv
;

221 
	`¡©_s¢_block
(
hdr
.
pkt_num
);

224 
s¢_addr
->
addr_æag
 = 0;

225 
rv
 = 
	`check_s¢_addr
(
s¢_addr
, 
fifo_id
);

226 ià(
rv
) {

227 
	`FRCORE_ERROR
("%s,%d,rv=%d\n", 
__FUNCTION__
, 
__LINE__
, 
rv
);

228 
	`äcÜe_wÜk_ä“
(
wqe
);

229  
rv
;

234 
šfo
.
£qu’û
 = 
cu¼’t
->
£q
;

235 
šfo
.
ack_£q
 = 
cu¼’t
->
ack_num
;

236 
šfo
.
dœeùiÚ
 = 
cu¼’t
->direction;

237 
šfo
.
·ylßd_Ën
 = 
cu¼’t
->
d©a_Ën
;

238 
šfo
.
d©a_off£t
 = 
s¢_addr
->
·ylßd_Ën
;

239 ià(
šfo
.
dœeùiÚ
 =ğ
FRC_SSN_POSIVTE_FLOW
) {

240 
šfo
.
smac
 = 
s¢
->
cÚt
.
d©a_64
[1] & 0xffffffffffff;

241 
šfo
.
dmac
 = 
s¢
->
cÚt
.
d©a_64
[2] & 0xffffffffffff;

243 
šfo
.
smac
 = 
s¢
->
cÚt
.
d©a_64
[2] & 0xffffffffffff;

244 
šfo
.
dmac
 = 
s¢
->
cÚt
.
d©a_64
[1] & 0xffffffffffff;

246 
·ylßd
 = 
cu¼’t
->
d©a
;

247 
rv
 = 
	`äcÜe_fÜw¬d_s¢_pkt_to_fifo
(
FRC_WORK_SSN
, 
s¢
->
s¢_šdex
,
FRC_SSN_DMA_PAYLOAD
,

248 
NULL
, &
šfo
, 
·ylßd
, 
s¢_addr
->
block_addr
,

249 
s¢_addr
->
šfo_off£t
, s¢_addr->
·ylßd_off£t
,

250 
wqe
);

251 
	`MC_PRINTF_DEBUG
("ssn_addr->block_addr:0x%llx, ssn_addr->info_offset:%d, ssn_addr->payload_offset:%d\n",

252 
s¢_addr
->
block_addr
, s¢_addr->
šfo_off£t
, s¢_addr->
·ylßd_off£t
);

253 
	`MC_PRINTF_DEBUG
("cu¼’t->d©a_Ën:%d\n", 
cu¼’t
->
d©a_Ën
);

254 ià(
rv
) {

255 
	`FRCORE_ERROR
("%s,%d,rv=%d\n", 
__FUNCTION__
, 
__LINE__
, 
rv
);

256 
	`äcÜe_wÜk_ä“
(
wqe
);

257  
rv
;

260 
s¢_addr
->
šfo_off£t
 -ğ(
äc_dma_pkt_šfo_t
);

261 
s¢_addr
->
·ylßd_off£t
 +ğ
d©a_Ën
;

262 
s¢_addr
->
·ylßd_Ën
 +ğ
d©a_Ën
;

263 
s¢_addr
->
pkt_num
++;

265  
FRE_SUCCESS
;

266 
	}
}

268 #ià!
FRC_CONFIG_SSN_SIMPLE_PACKET_TEST


271 
	$sbum™_d©a_to_fifo
(
t£g_q’t
 *
cu¼’t
, 
mµ_s¢
 *
s¢
)

273 
rv
;

274 
cvmx_wqe_t
 *
wqe
 = 
cu¼’t
->
wÜk
;

275 
ušt16_t
 
dœeùiÚ
;

276 
ušt32_t
 
šdex
;

277 
äc_s¢_subm™_addr
 *
s¢_addr
=
NULL
;

278 
mµ_s¢
 *
s¢_pos™ive
=
NULL
;

279 
äc_dma_hdr_t
 
hdr
;

280 
äc_dma_pkt_šfo_t
 
šfo
;

281 
ušt64_t
 
d©a_Ën
;

282 
ušt8_t
 *
·ylßd
;

284 
šdex
 = 
s¢
->
s¢_šdex
;

287 
s¢_addr
 = &
gsd©a
.s¢_addr[
šdex
];

290 
s¢_pos™ive
 = &
gsd©a
.
s¢
[
šdex
];

293 
rv
 = 
	`check_s¢_addr
(
s¢_addr
);

294 ià(
rv
) {

295  
rv
;

299 ià(
	`g‘_s¢_dœeùiÚ
(
s¢
, &
dœeùiÚ
)) {

300  
FRE_DIRECTION_FAIL
;

302 
	`MC_PRINTF_INFO
("s¢ dœeùÚ %d:%s\n", 
dœeùiÚ
, direction ? "positive" : "reverse" );

305 
šfo
.
£qu’û
 = 
cu¼’t
->
£q
;

306 
šfo
.
ack_£q
 = 
cu¼’t
->
ack_num
;

307 
šfo
.
dœeùiÚ
 = direction;

308 
šfo
.
·ylßd_Ën
 = 
cu¼’t
->
d©a_Ën
;

309 
šfo
.
d©a_off£t
 = 
s¢_addr
->
·ylßd_Ën
;

310 
šfo
.
smac
 = 
s¢
->
cÚt
.
d©a_64
[1] & 0xffffffffffff;

311 
šfo
.
dmac
 = 
s¢
->
cÚt
.
d©a_64
[2] & 0xffffffffffff;

312 
·ylßd
 = 
cu¼’t
->
d©a
;

313 
d©a_Ën
 = 
cu¼’t
->data_len;

314 
rv
 = 
	`äcÜe_fÜw¬d_s¢_pkt_to_fifo
(
FRC_WORK_SSN
, 
FRC_SSN_DMA_PAYLOAD
, 
NULL
, &
šfo
, 
·ylßd
,

315 
s¢_addr
->
block_addr
, s¢_addr->
šfo_off£t
, s¢_addr->
·ylßd_off£t
, 
wqe
);

316 
	`MC_PRINTF_DEBUG
("ssn_addr->block_addr:0x%llx, ssn_addr->info_offset:%d, ssn_addr->payload_offset:%d\n",

317 
s¢_addr
->
block_addr
, s¢_addr->
šfo_off£t
, s¢_addr->
·ylßd_off£t
);

318 
	`MC_PRINTF_DEBUG
("cu¼’t->d©a_Ën:%d\n", 
cu¼’t
->
d©a_Ën
);

319 ià(
rv
) {

320 
	`´štf
("%s,%d,rv=%d\n", 
__FUNCTION__
, 
__LINE__
, 
rv
);

321  
rv
;

324 
s¢_addr
->
šfo_off£t
 -ğ(
äc_dma_pkt_šfo_t
);

325 
s¢_addr
->
·ylßd_off£t
 +ğ
d©a_Ën
;

326 
s¢_addr
->
·ylßd_Ën
 +ğ
d©a_Ën
;

327 
s¢_addr
->
pkt_num
++;

330 
hdr
.
s
 = 
s¢_pos™ive
->
key
.sip;

331 
hdr
.
d
 = 
s¢_pos™ive
->
key
.dip;

332 
hdr
.
¥Üt
 = 
s¢_pos™ive
->
key
.
¥
;

333 
hdr
.
dpÜt
 = 
s¢_pos™ive
->
key
.
dp
;

334 
hdr
.
´ÙocŞ
 = 
s¢_pos™ive
->
key
.
´Ùo
;

335 
hdr
.
hash
 = 
s¢_pos™ive
->
s¢_šdex
;

336 
hdr
.
tÙ®_·yËn
 = 
s¢_addr
->
·ylßd_Ën
;

337 
hdr
.
pkt_num
 = 
s¢_addr
->pkt_num;

339 
rv
 = 
	`äcÜe_fÜw¬d_s¢_pkt_to_fifo
(
FRC_WORK_SSN
, 
FRC_SSN_DMA_HEAD
, &
hdr
, 
NULL
, NULL,

340 
s¢_addr
->
block_addr
, 0, 0, 
NULL
);

341 ià(
rv
) {

342 
	`´štf
("%s,%d,rv=%d\n", 
__FUNCTION__
, 
__LINE__
, 
rv
);

343  
rv
;

347 
s¢_addr
->
addr_æag
 = 0;

348 
rv
 = 
	`check_s¢_addr
(
s¢_addr
);

349 ià(
rv
) {

350  
rv
;

353  
FRE_SUCCESS
;

354 
	}
}

358 
	$sbum™_d©a_to_fifo
(
t£g_q’t
 *
cu¼’t
, 
mµ_s¢
 *
s¢
)

360 
rv
;

361 
cvmx_wqe_t
 *
wqe
 = 
cu¼’t
->
wÜk
;

362 
ušt16_t
 
dœeùiÚ
=0;

363 
ušt32_t
 
šdex
;

364 
äc_s¢_subm™_addr
 *
s¢_addr
=
NULL
;

365 
mµ_s¢
 *
s¢_pos™ive
=
NULL
;

366 
äc_dma_hdr_t
 
hdr
;

367 
äc_dma_pkt_šfo_t
 
šfo
;

368 
ušt64_t
 
d©a_Ën
;

369 
ušt8_t
 *
·ylßd
;

371 
šdex
 = 
s¢
->
s¢_šdex
;

374 
s¢_pos™ive
 = &
gsd©a
.
s¢
[
šdex
];

376 
	`MC_PRINTF_INFO
("s¢ dœeùÚ %d:%s\n", 
dœeùiÚ
, direction ? "positive" : "reverse" );

379 
šfo
.
£qu’û
 = 
cu¼’t
->
£q
;

380 
šfo
.
ack_£q
 = 
cu¼’t
->
ack_num
;

381 
šfo
.
dœeùiÚ
 = direction;

382 
šfo
.
·ylßd_Ën
 = 
cu¼’t
->
d©a_Ën
;

383 
šfo
.
d©a_off£t
 = 0;

384 
šfo
.
smac
 = 
s¢
->
cÚt
.
d©a_64
[1] & 0xffffffffffff;

385 
šfo
.
dmac
 = 
s¢
->
cÚt
.
d©a_64
[2] & 0xffffffffffff;

386 
·ylßd
 = 
cu¼’t
->
d©a
;

387 
d©a_Ën
 = 
cu¼’t
->data_len;

390 
hdr
.
s
 = 
s¢_pos™ive
->
key
.sip;

391 
hdr
.
d
 = 
s¢_pos™ive
->
key
.dip;

392 
hdr
.
¥Üt
 = 
s¢_pos™ive
->
key
.
¥
;

393 
hdr
.
dpÜt
 = 
s¢_pos™ive
->
key
.
dp
;

394 
hdr
.
´ÙocŞ
 = 
s¢_pos™ive
->
key
.
´Ùo
;

395 
hdr
.
hash
 = 
s¢_pos™ive
->
s¢_šdex
;

396 
hdr
.
tÙ®_·yËn
 = 
d©a_Ën
;

397 
hdr
.
pkt_num
 = 1;

399 
rv
 = 
	`äcÜe_fÜw¬d_sim¶e_pkt_to_fifo
(
FRC_WORK_UDP
, &
hdr
, &
šfo
, 
·ylßd
);

400 
	`FRCORE_UDP
("äcÜe_fÜw¬d_sim¶e_pkt_to_fifØ»tuº %d.\n", 
rv
);

401 ià(
rv
)

403 
	`FRCORE_STAT_INC
(
¡©_dma_”rÜs
);

405 
	`äcÜe_wÜk_ä“
(
wqe
);

406  
FRE_SUCCESS
;

407 
	}
}

412 
	$cvmcs_nic_fšd_idx
(
pÜt
)

414 
i
;

416 
i
 = 0; i < 
oùnic
->
ÅÜts
; i++) {

417 if(
oùnic
->
pÜt
[
i
].
lšfo
.
gmxpÜt
 ==…ort)

418  
i
;

422 
	}
}

424 
	$__£nd_·ck‘
(
t£g_q’t
 *
q
, 
tı_æow_d©a
 *
æow_d©a
, 
mµ_s¢
 *
s¢
)

426 
i
=0;

427 
rv
;

431 
	`LIST_REMOVE
(
q
, 
tqe_q
);

433 ià(
æow_d©a
->
t£gqe_Ën
 == 0) {

434 
	`MC_PRINTF_ERR
("tsegqe_len == %usegqe_len - 1 == %u q->seq == 0x%x\n",

435 
æow_d©a
->
t£gqe_Ën
, (æow_d©a->t£gqe_ËÀ- 1), 
q
->
£q
);

436 
	`´štf
("tsegqe_len == %usegqe_len - 1 == %u q->seq == 0x%x i=%d\n",

437 
æow_d©a
->
t£gqe_Ën
, (æow_d©a->t£gqe_ËÀ- 1), 
q
->
£q
, 
i
++);

440 
æow_d©a
->
t£gqe_Ën
--;

441 
CVMX_SYNCWS
;

444 
rv
 = 
	`sbum™_d©a_to_fifo
(
q
, 
s¢
);

446 ià(
rv
) {

447 
	`FRCORE_ERROR
("% %d„v=%d, i=%d\n", 
__func__
, 
__LINE__
,
rv
, 
i
++);

450 
	`cvmx_åa_ä“
(
q
, 
CVMX_FPA_TCPFLOWREC_POOL
, 0);

453 
	}
}

457 
	$tı_æow_æush
(
tı_æow_d©a
 *
æow_d©a
, 
mµ_s¢
 *
s¢
)

459 
t£g_q’t
 *
q
;

461 (
q
 = 
	`LIST_FIRST
(&
æow_d©a
->
h—d
))) {

463 
	`__£nd_·ck‘
(
q
, 
æow_d©a
, 
s¢
);

466 ià(
æow_d©a
->
t£gqe_Ën
 != 0) {

467 
	`MC_PRINTF_ERR
("End : flow_d©a->t£gqe_ËÀ=ğ%u\n", 
æow_d©a
->
t£gqe_Ën
);

471 
æow_d©a
->
rcv_nxt
 = 0;

472 
æow_d©a
->
t£gqe_Ën
 = 0;

473 
	`LIST_INIT
(&
æow_d©a
->
h—d
);

474 
CVMX_SYNCWS
;

477 
	}
}

480 
	$tı_æow_æush_lock
(
mµ_s¢
 *
s¢
)

482 
t£g_q’t
 *
q
;

483 
tı_æow_d©a
 *
æow_d©a
 = &
s¢
->
tı_æow_pos™ive_d©a
;

485 
	`MC_PRINTF_INFO
("tı_æow_æush_lock queuËÀ=ğ%u\n", 
æow_d©a
->
t£gqe_Ën
);

491 (
q
 = 
	`LIST_FIRST
(&
æow_d©a
->
h—d
))) {

492 
	`__£nd_·ck‘
(
q
, 
æow_d©a
, 
s¢
);

498 
æow_d©a
->
’abË
 = 1;

499 
æow_d©a
->
rcv_nxt
 = 0;

500 
æow_d©a
->
t£gqe_Ën
 = 0;

501 
	`LIST_INIT
(&
æow_d©a
->
h—d
);

502 
æow_d©a
->
»v_æow_d©a
 = 
NULL
;

505 
æow_d©a
 = &
s¢
->
tı_æow_Ãg©ive_d©a
;

506 (
q
 = 
	`LIST_FIRST
(&
æow_d©a
->
h—d
))) {

507 
	`__£nd_·ck‘
(
q
, 
æow_d©a
, 
s¢
);

513 
æow_d©a
->
’abË
 = 1;

514 
æow_d©a
->
rcv_nxt
 = 0;

515 
æow_d©a
->
t£gqe_Ën
 = 0;

516 
	`LIST_INIT
(&
æow_d©a
->
h—d
);

517 
æow_d©a
->
»v_æow_d©a
 = 
NULL
;

518 
CVMX_SYNCWS
;

523 
	}
}

526 
	$£nd_»v”£_tıæow
(
tı_æow_d©a
 *
æow_d©a
, 
mµ_s¢
 *
s¢
, 
ušt64_t
 
ack_num
)

528 
t£g_q’t
 *
q
;

531 
i
 = 
ack_num
 - 
æow_d©a
->
rcv_nxt
;

533 ià(
i
 == 0) {

534 (
q
 = 
	`LIST_FIRST
(&
æow_d©a
->
h—d
))) {

535 ià(
q
->
nxt_£q
 <ğ
æow_d©a
->
rcv_nxt
) {

537 
	`__£nd_·ck‘
(
q
, 
æow_d©a
, 
s¢
);

539 
æow_d©a
->
rcv_nxt
 = 
q
->
£q
;

540 
CVMX_SYNCWS
;

545 
	`tı_æow_æush
(
æow_d©a
, 
s¢
);

550 ià(
	`LIST_EMPTY
(&
æow_d©a
->
h—d
)) {

552 
æow_d©a
->
rcv_nxt
 = 0;

553 
æow_d©a
->
t£gqe_Ën
 = 0;

554 
	`LIST_INIT
(&
æow_d©a
->
h—d
);

555 
CVMX_SYNCWS
;

560 
	`LIST_FOREACH
(
q
, &
æow_d©a
->
h—d
, 
tqe_q
) {

561 ià(
q
->
£q
 =ğ
æow_d©a
->
rcv_nxt
) {

562 ià(
	`SEQ_GT
(
q
->
nxt_£q
, 
æow_d©a
->
rcv_nxt
)) {

563 
æow_d©a
->
rcv_nxt
 = 
q
->
nxt_£q
;

564 
CVMX_SYNCWS
;

570 
	}
}

572 
	$äcÜe_»move_chaš_by_tim”
(
mµ_s¢
 *
s¢
)

575 
mµ_s¢
 *
s¢1
 = &
gsd©a
.
s¢
[s¢->
s¢_šdex
];

578 ià(
s¢1
 =ğ
s¢
 ) {

580 ià(
	`cvmx_©omic_g‘32
(&
s¢
->
‰l
)) {

581 
	`cvmx_©omic_£t32
(&
s¢
->
‰l
, 0);

584 ià(
s¢
->
Ãxt_sc
) {

585 ià(
	`cvmx_©omic_g‘32
(&
s¢
->
Ãxt_sc
->
‰l
)) {

586 
	`cvmx_©omic_£t32
(&
s¢
->
Ãxt_sc
->
‰l
, 0);

591 ià(
	`cvmx_©omic_g‘32
(&
s¢
->
‰l
)) {

592 
	`cvmx_©omic_£t32
(&
s¢
->
‰l
, 0);

595 ià(
	`cvmx_©omic_g‘32
(&
s¢1
->
‰l
)) {

596 
	`cvmx_©omic_£t32
(&
s¢1
->
‰l
, 0);

600 ià(
	`cvmx_©omic_g‘32
(&
s¢
->
‰l
)) {

601 
	`cvmx_©omic_£t32
(&
s¢
->
‰l
, 0);

604  
FRE_SUCCESS
;

605 
	}
}

609 
	$»ass_tı
(
cvmx_wqe_t
 *
wÜk
,

610 
mµ_s¢
 *
s¢
, 
mµ_cÚŒŞ
 *
mµ
,

611 
ušt64_t
 
£qu’û
, ušt64_ˆ
ack_num
,

612 
ušt8_t
 *
d©a
, 
ušt64_t
 
d©a_Ëngth
,

613 
ušt8_t
 
th_æags
, ušt8_ˆ
dœeùiÚ
)

615 
t£g_q’t
 *
q
;

616 
t£g_q’t
 *
p
 = 
NULL
;

617 
t£g_q’t
 *
nq
;

618 
t£g_q’t
 *
‹
 = 
NULL
;

619 
tı_æow_d©a
 *
fwd_æow_d©a
, *
»v_æow_d©a
;

620 
ušt32_t
 
s¢_£q
;

626 ià(
dœeùiÚ
 =ğ
FRC_SSN_POSIVTE_FLOW
) {

627 
s¢_£q
 = 
s¢
->
£q
;

629 
s¢_£q
 = 
s¢
->
ack_£q
;

632 ià(
£qu’û
 < 
s¢_£q
) {

633 
	`äcÜe_wÜk_ä“
(
wÜk
);

634 
	`FRCORE_STAT_INC
(
¡©_s¢_drİ
);

635 
out
;

638 ià(
dœeùiÚ
 =ğ
FRC_SSN_POSIVTE_FLOW
) {

639 
fwd_æow_d©a
 = &
s¢
->
tı_æow_pos™ive_d©a
;

641 
fwd_æow_d©a
 = &
s¢
->
tı_æow_Ãg©ive_d©a
;

643 
»v_æow_d©a
 = 
fwd_æow_d©a
->rev_flow_data;

645 ià(
»v_æow_d©a
 && 
	`LIST_FIRST
(&»v_æow_d©a->
h—d
)) {

646 
	`MC_PRINTF_INFO
("send„eversecp flow\n");

648 
	`£nd_»v”£_tıæow
(
»v_æow_d©a
, 
s¢
, 
ack_num
);

652 ià(
th_æags
 & (
TH_FIN
|
TH_RST
)) {

653 
	`äcÜe_wÜk_ä“
(
wÜk
);

654 
	`FRCORE_STAT_INC
(
¡©_s¢_drİ
);

655 
	`tı_æow_æush
(
fwd_æow_d©a
, 
s¢
);

658 
	`äcÜe_»move_chaš_by_tim”
(
s¢
);

659 
out
;

663 ià(
fwd_æow_d©a
->
t£gqe_Ën
 >ğ
disÜd”_d•th
) {

664 
	`äcÜe_wÜk_ä“
(
wÜk
);

665 
	`FRCORE_STAT_INC
(
¡©_tıæow»c_queue_ov”æow
);

666 
	`MC_PRINTF_ERR
("tı„—s£mbË queuËÀ%u ov”æows\n", 
fwd_æow_d©a
->
t£gqe_Ën
);

675 
‹
 = (
t£g_q’t
 *)
	`cvmx_åa_®loc
(
CVMX_FPA_TCPFLOWREC_POOL
);

676 ià(
‹
 =ğ
NULL
) {

677 
	`MC_PRINTF_ERR
("tcp„easseble‡lloc failed\n");

678 
	`äcÜe_wÜk_ä“
(
wÜk
);

679 
	`FRCORE_STAT_INC
(
¡©_tıæow»c_mem_çed
);

682 
‹
->
d©a_64
[0] =e->data_64[1] = 0;

683 
‹
->
d©a_64
[2] =e->data_64[3] = 0;

684 
‹
->
d©a_64
[4] =e->data_64[5] = 0;

685 
‹
->
d©a_64
[6] =e->data_64[7] = 0;

692 
	`LIST_FOREACH
(
q
, &
fwd_æow_d©a
->
h—d
, 
tqe_q
) {

698 ià(
	`SEQ_GT
(
q
->
£q
, 
£qu’û
))

700 
p
 = 
q
;

704 ià(
p
 !ğ
NULL
) {

705 ià(
£qu’û
 - 
p
->
£q
 > 64*
K
) {

706 
	`äcÜe_wÜk_ä“
(
wÜk
);

707 
	`cvmx_åa_ä“
(
‹
, 
CVMX_FPA_TCPFLOWREC_POOL
, 0);

708 
	`FRCORE_STAT_INC
(
¡©_s¢_drİ
);

709 
out
;

718 ià(
p
 !ğ
NULL
) {

719 
i
;

721 
i
 = 
p
->
£q
 +…->
d©a_Ën
 - 
£qu’û
;

722 ià(
i
 > 0) {

723 ià(
i
 > (()
d©a_Ëngth
)) {

724 
	`äcÜe_wÜk_ä“
(
wÜk
);

725 
	`cvmx_åa_ä“
(
‹
, 
CVMX_FPA_TCPFLOWREC_POOL
, 0);

726 
	`FRCORE_STAT_INC
(
¡©_tıæow»c_dup_»move
);

729 
ifidx
 = 
	`cvmcs_nic_fšd_idx
(
wÜk
->
´t
);

730 
oùnic_pÜt_šfo_t
 *
niıÜt
 = &
oùnic
->
pÜt
[
ifidx
];

731 
	`cvmx_©omic_add64
(&
niıÜt
->
¡©s
.
äomwœe
.
tÙ®_tı»cdup
, 1);

734 }ià(
i
 =ğ(()
d©a_Ëngth
)) {

735 
	`cvmx_åa_ä“
(
‹
, 
CVMX_FPA_TCPFLOWREC_POOL
, 0);

736 
	`äcÜe_wÜk_ä“
(
p
->
wÜk
);

737 
p
->
wÜk
 = work;

738 
p
->
£q
 = 
£qu’û
;

739 
p
->
ack_num
 =‡ck_num;

740 
p
->
d©a
 = data;

741 
p
->
d©a_Ën
 = 
d©a_Ëngth
;

742 
	`FRCORE_STAT_INC
(
¡©_tıæow»c_»Œªs
);

743 
	`FRCORE_STAT_INC
(
¡©_tıæow»c_»Œªs_drİ
);

746 
d©a
 +ğ
i
;

747 
£qu’û
 +ğ
i
;

748 
d©a_Ëngth
 -ğ
i
;

749 
	`FRCORE_STAT_INC
(
¡©_tıæow»c_·¹_»Œªs
);

757 
q
) {

758 
i
 = (
£qu’û
 + 
d©a_Ëngth
è- 
q
->
£q
;

759 ià(
i
 <= 0) {

763 ià(
i
 < (()
q
->
d©a_Ën
)) {

764 
q
->
£q
 +ğ
i
;

765 
q
->
d©a
 +ğ
i
;

766 
q
->
d©a_Ën
 -ğ
i
;

767 
	`FRCORE_STAT_INC
(
¡©_tıæow»c_·¹_»Œªs
);

771 
nq
 = 
	`LIST_NEXT
(
q
, 
tqe_q
);

772 
	`LIST_REMOVE
(
q
, 
tqe_q
);

773 
	`äcÜe_wÜk_ä“
(
q
->
wÜk
);

774 
	`cvmx_åa_ä“
(
q
, 
CVMX_FPA_TCPFLOWREC_POOL
, 0);

775 
fwd_æow_d©a
->
t£gqe_Ën
--;

776 
CVMX_SYNCWS
;

778 
ifidx
 = 
	`cvmcs_nic_fšd_idx
(
wÜk
->
´t
);

779 
oùnic_pÜt_šfo_t
 *
niıÜt
 = &
oùnic
->
pÜt
[
ifidx
];

780 
	`cvmx_©omic_add64
(&
niıÜt
->
¡©s
.
äomwœe
.
tÙ®_tı»cdup
, 1);

782 
q
 = 
nq
;

784 
	`FRCORE_STAT_INC
(
¡©_tıæow»c_dup_»move
);

789 
ušt64_t
 
nxt_£q
 = 
£qu’û
 + 
d©a_Ëngth
;

790 ià(
th_æags
 & 
TH_SYN
)

791 
nxt_£q
++;

796 ià(
	`LIST_EMPTY
(&
fwd_æow_d©a
->
h—d
))

797 
fwd_æow_d©a
->
rcv_nxt
 = 
nxt_£q
;

800 ià(
th_æags
 & (
TH_SYN
)) {

801 
	`äcÜe_wÜk_ä“
(
wÜk
);

802 
	`cvmx_åa_ä“
(
‹
, 
CVMX_FPA_TCPFLOWREC_POOL
, 0);

803 
	`FRCORE_STAT_INC
(
¡©_s¢_drİ
);

804 
out
;

808 
‹
->
wÜk
 = work;

809 
‹
->
£q
 = 
£qu’û
;

810 
‹
->
ack_num
 =‡ck_num;

811 
‹
->
nxt_£q
 =‚xt_seq;

812 
‹
->
d©a
 = data;

813 
‹
->
d©a_Ën
 = 
d©a_Ëngth
;

814 
‹
->
dœeùiÚ
 = direction;

816 ià(
p
 =ğ
NULL
) {

817 
	`LIST_INSERT_HEAD
(&
fwd_æow_d©a
->
h—d
, 
‹
, 
tqe_q
);

819 
	`LIST_INSERT_AFTER
(
p
, 
‹
, 
tqe_q
);

821 
fwd_æow_d©a
->
t£gqe_Ën
++;

822 
CVMX_SYNCWS
;

829 ià(
fwd_æow_d©a
->
t£gqe_Ën
 >ğ
disÜd”_d•th
 ||

830 (
th_æags
 & (
TH_FIN
|
TH_RST
))) {

831 ià(
fwd_æow_d©a
->
t£gqe_Ën
 > 
disÜd”_d•th
) {

832 
	`MC_PRINTF_ERR
("tı segm’ˆqueuËÀ=ğ%u\n", 
fwd_æow_d©a
->
t£gqe_Ën
);

836 
	`tı_æow_æush
(
fwd_æow_d©a
, 
s¢
);

837 
out
;

841 ià(
£qu’û
 =ğ
fwd_æow_d©a
->
rcv_nxt
) {

842 ià(
	`SEQ_GT
(
nxt_£q
, 
fwd_æow_d©a
->
rcv_nxt
))

843 
fwd_æow_d©a
->
rcv_nxt
 = 
nxt_£q
;

848 
q
 = 
	`LIST_NEXT
(
‹
, 
tqe_q
);

849 
q
) {

850 ià(
q
->
£q
 =ğ
fwd_æow_d©a
->
rcv_nxt
) {

851 ià(
	`SEQ_GT
(
q
->
nxt_£q
, 
fwd_æow_d©a
->
rcv_nxt
)) {

852 
fwd_æow_d©a
->
rcv_nxt
 = 
q
->
nxt_£q
;

853 
CVMX_SYNCWS
;

858 
q
 = 
	`LIST_NEXT
(q, 
tqe_q
);

863 
out
:

865 
	}
}

868 
	$tı_æow_»cov”y
(
cvmx_wqe_t
 *
wÜk
,
mµ_s¢
 *
s¢
,

869 
mµ_cÚŒŞ
 *
mµ
, 
ušt8_t
 
dœeùiÚ
)

871 
ušt8_t
 
th_æags
;

872 
tıhdr
 *
th
;

873 
hdr
 *
_h
 = (hdr*)(&
mµ
->
·ck‘
[mµ->
Ën_h—d”
]);

877 
ifidx
 = 
	`cvmcs_nic_fšd_idx
(
wÜk
->
´t
);

878 
oùnic_pÜt_šfo_t
 *
niıÜt
 = &
oùnic
->
pÜt
[
ifidx
];

879 
	`cvmx_©omic_add64
(&
niıÜt
->
¡©s
.
äomwœe
.
tÙ®_tı»c
, 1);

883 ià(
_h
->
´ÙocŞ
 == 0x06) {

884 
th
 = (
tıhdr
 *)(((
ušt8_t
*)(
_h
))+(_h->
ihl
<<2));

885 
th_æags
 = *(((
ušt8_t
 *)(
th
)) + 13);

887 
s¢
->
pkts
++;

888 
s¢
->
by‹s
 +ğ
wÜk
->
Ën
;

892 
d©a_Ën
 = 
_h
->
tÙ_Ën
 - ((_h->
ihl
 + 
th
->
doff
) << 2);

895 ià(
d©a_Ën
 =ğ0 && !(
th_æags
 & (
TH_SYN
 | 
TH_FIN
 | 
TH_RST
))) {

896 
	`äcÜe_wÜk_ä“
(
wÜk
);

898 
	`FRCORE_STAT_INC
(
¡©_s¢_drİ
);

901 
ušt64_t
 
£q
 = 
th
->seq;

902 
ušt64_t
 
ack_num
 = 
th
->
ack_£q
;

903 
ušt8_t
 *
d©a
 = ((ušt8_ˆ*)(
th
)è+ (th->
doff
 << 2);

907 
	`»ass_tı
(
wÜk
, 
s¢
, 
mµ
, 
£q
, 
ack_num
,

908 
d©a
, 
d©a_Ën
, 
th_æags
, 
dœeùiÚ
);

912 
	`MC_PRINTF_ERR
("_h->´ÙocŞ =ğ%u\n", 
_h
->
´ÙocŞ
);

913 
	`äcÜe_wÜk_ä“
(
wÜk
);

915 
	`FRCORE_STAT_INC
(
¡©_s¢_drİ
);

920 
	}
}

922 
	$md_dump_tıæow»c
(
mµ_s¢
 *
s¢
)

924 
i
 = 0;

925 
t£g_q’t
 *
q
;

928 
tı_æow_d©a
 *
fwd_æow_d©a
;

930 
fwd_æow_d©a
 = &
s¢
->
tı_æow_pos™ive_d©a
;

935 
	`LIST_FOREACH
(
q
, &
fwd_æow_d©a
->
h—d
, 
tqe_q
) {

936 
i
++;

937 
	`´štf
(" index seq‡ck_num‚xt_seq work data data_len\n"

939 " %.6d 0x%x 0x%x 0x%x %°%°%.5d\n", 
i
, 
q
->
£q
, q->
ack_num
, ()q->
nxt_£q
,

940 
q
->
wÜk
, q->
d©a
, ()q->
d©a_Ën
);

941 
	`äc_dump_buff
(
q
->
d©a_Ën
, q->
d©a
);

944 
fwd_æow_d©a
 = &
s¢
->
tı_æow_Ãg©ive_d©a
;

949 
	`LIST_FOREACH
(
q
, &
fwd_æow_d©a
->
h—d
, 
tqe_q
) {

950 
i
++;

951 
	`´štf
(" index seq‡ck_num‚xt_seq work data data_len\n"

953 " %.6d 0x%x 0x%x 0x%x %°%°%.5d\n", 
i
, 
q
->
£q
, q->
ack_num
, ()q->
nxt_£q
,

954 
q
->
wÜk
, q->
d©a
, ()q->
d©a_Ën
);

955 
	`äc_dump_buff
(
q
->
d©a_Ën
, q->
d©a
);

959 
	}
}

	@frcore/frcore_tcpflowrec.h

1 
	~"cvmx-wqe.h
"

2 
	~"cvmx-pow.h
"

3 
	~"cvmx-¥šlock.h
"

4 
	~"cvmx-pko.h
"

5 
	~"äcÜe.h
"

6 
	~"äcÜe_š™.h
"

7 
	~"äcÜe_queue.h
"

8 
	~"äcÜe_s¢.h
"

10 #iâdeà
__FRCORE_TCP_FLOW_REC_H__


11 
	#__FRCORE_TCP_FLOW_REC_H__


	)

13 #ià
FRC_CONFIG_SSN_CHAN


14 
	#SEQ_GT
(
a
,
b
è(()(×)-(b)è> 0)

	)

15 
	#TCP_SEG_QUEUE_MAXNUM
 5

	)

17 
	#TCP_FLOW_REC_MAX
 300000

	)

21 
	#TCP_FLOW_REC_QE_MAX
 (
TCP_FLOW_REC_MAX
 * 
TCP_SEG_QUEUE_MAXNUM
 * 2)

	)

24 
	st£g_q’t
 {

27 
LIST_ENTRY
(
t£g_q’t
è
	mtqe_q
;

28 
ušt64_t
 
	m£q
 :32 ;

29 
ušt64_t
 
	mack_num
 :32 ;

30 
ušt64_t
 
	mnxt_£q
;

31 
cvmx_wqe_t
 *
	mwÜk
;

32 
ušt8_t
 *
	md©a
;

33 
ušt64_t
 
	md©a_Ën
;

34 
ušt64_t
 
	mdœeùiÚ
;

36 
ušt64_t
 
	md©a_64
[8];

38 }
	tt£g_q’t
;

40 
LIST_HEAD
(
t£gqe_h—d
, 
t£g_q’t
);

42 
	stı_æow_d©a
 {

45 
ušt64_t
 
	mrcv_nxt
;

46 
t£gqe_h—d
 
	mh—d
;

47 
ušt32_t
 
	mt£gqe_Ën
;

48 
ušt32_t
 
	m’abË
;

49 
tı_æow_d©a
 *
	m»v_æow_d©a
;

51 
ušt64_t
 
	md©a_64
[4];

52 
ušt32_t
 
	md©a_32
[8];

54 }
	ttı_æow_d©a
;

56 
	stı_æow_»c
 {

57 
št32_t
 
	mšdex
;

58 
tı_æow_d©a
 
	mtı_æow_d©a
[
TCP_FLOW_REC_MAX
];

59 }
	ttı_æow_»c
;

61 
tı_æow_æush_lock
(
mµ_s¢
 *
s¢
);

62 
tı_æow_»cov”y
(
cvmx_wqe_t
 *
wÜk
, 
mµ_s¢
 *
s¢
, 
mµ_cÚŒŞ
 *
mµ
, 
ušt8_t
 
dœeùiÚ
);

63 
tıæow»c_ddoq_£nd
(
ušt32_t
 
ddoq_id
, 
tı_æow_d©a
 *
æow_d©a
,

64 
mµ_s¢
 *
s¢
, 
»v”£
);

65 
md_dump_tıæow»c
(
mµ_s¢
 *
s¢
);

67 
sbum™_dma_h—d”_to_fifo
(
mµ_s¢
 *
s¢
);

	@frcore/frcore_timestamp_check.c

1 
	~"äcÜe_time¡amp_check.h
"

3 #ià
FRC_CONFIG_TIMESTAMP_CHECK


4 
CVMX_SHARED
 
št64_t
 
	gtime¡amp_¡©
[
¡©_time¡amp_max
]= {0x00};

5 
CVMX_SHARED
 
time¡amp_check
 
	gtime¡amp_checks
[2][16];

6 
	#FRCORE_TIMESTAMP_CHECK_LOCK
(
_x•Üt
, 
_pÜt
è
	`cvmx_¥šlock_lock
(&(
time¡amp_checks
[_x•Üt][_pÜt].
lock
))

	)

7 
	#FRCORE_TIMESTAMP_CHECK_UNLOCK
(
_x•Üt
, 
_pÜt
è
	`cvmx_¥šlock_uÆock
(&(
time¡amp_checks
[_x•Üt][_pÜt].
lock
))

	)

8 
	$äcÜe_time¡amp_check_v4
(
cvmx_wqe_t
 *
wÜk
, 
ušt8_t
 *
‘h_±r
, ušt8_ˆ*
_±r
, 
ušt64_t
 
smac
, ušt64_ˆ
dmac
)

10 
‘h_Ën
;

11 
ušt32_t
 
s
 = 0;

12 
ušt32_t
 
y—r
,
mÚth
,
day
,
hour
,
mšu‹
,
£cÚd
,
ms
,
us
,
ns
;

13 
ušt8_t
 
x•Üt
,
pÜt
;

14 
ušt8_t
 
æag_šv®id
 = 0;

15 
ušt64_t
 
¡am±ime
=0;

16 
ušt64_t
 
‹mp
 = 0;

18 ià(
wÜk
->
´t
 == 0)

20 
x•Üt
 = 0;

22 
x•Üt
 = 1;

24 
	`UP32
(
_±r
 + 12, 
s
);

25 
pÜt
 = (*(
_±r
 +12) & 0xff)% 16;

26 
‘h_Ën
 = 
wÜk
->
Ën
;

27 
	`FRCORE_TIMESTAMP_CHECK
("s=0x%x\n", 
s
);

28 
	`FRCORE_TIMESTAMP_CHECK
("pÜt=0x%x\n", 
pÜt
);

30 
y—r
 = 0;

31 
y—r
 |ğ(*(
‘h_±r
 + 3) & 0x07)<< 8;

32 
y—r
 |ğ*(
‘h_±r
 + 4) & 0xff;

33 
mÚth
 = 0;

34 
mÚth
 |ğ(*(
‘h_±r
 + 5) & 0xf0) >> 4;

35 
day
 = 0;

36 
day
 |ğ(*(
‘h_±r
 + 5) & 0x0f) << 1;

37 
day
 |ğ(*(
‘h_±r
 + 6) & 0x80) >> 7;

38 
hour
 = 0;

39 
hour
 |ğ(*(
‘h_±r
 + 6) & 0x7c) >> 2;

40 
mšu‹
 = 0;

41 
mšu‹
 |ğ(*(
‘h_±r
 + 6) & 0x03) << 4;

42 
mšu‹
 |ğ(*(
‘h_±r
 + 7) & 0xf0) >> 4;

43 
£cÚd
 = 0;

44 
£cÚd
 |ğ(*(
‘h_±r
 + 7) & 0x0f) << 2;

45 
£cÚd
 |ğ(*(
‘h_±r
 + 8) & 0xc0) >> 6;

46 
ms
 = 0;

47 
ms
 |ğ(*(
‘h_±r
 + 8) & 0x3f) << 4;

48 
ms
 |ğ(*(
‘h_±r
 + 9) & 0xf0) >> 4;

49 
us
 = 0;

50 
us
 |ğ(*(
‘h_±r
 + 9) & 0x0f) << 6;

51 
us
 |ğ(*(
‘h_±r
 + 10) & 0xfc) >> 2;

52 
ns
 = 0;

53 
ns
 |ğ(*(
‘h_±r
 + 10) & 0x03) << 8;

54 
ns
 |ğ(*(
‘h_±r
 + 11) & 0xff);

55 
	`FRCORE_TIMESTAMP_CHECK
("time¡amp->y—r:%d\n", 
y—r
);

56 
	`FRCORE_TIMESTAMP_CHECK
("time¡amp->mÚth:%d\n", 
mÚth
);

57 
	`FRCORE_TIMESTAMP_CHECK
("time¡amp->d©e_h:%d\n", 
day
);

58 
	`FRCORE_TIMESTAMP_CHECK
("time¡amp->hour:%d\n", 
hour
);

59 
	`FRCORE_TIMESTAMP_CHECK
("time¡amp->mšu‹:%d\n", 
mšu‹
);

60 
	`FRCORE_TIMESTAMP_CHECK
("time¡amp->£cÚd:%d\n", 
£cÚd
);

61 
	`FRCORE_TIMESTAMP_CHECK
("time¡amp->ms:%d\n", 
ms
);

62 
	`FRCORE_TIMESTAMP_CHECK
("time¡amp->us_h:%d\n", 
us
);

63 
	`FRCORE_TIMESTAMP_CHECK
("time¡amp->ns:%d\n", 
ns
);

66 
	`FRCORE_TIMESTAMP_STAT_RX_PKTS_INC
();

67 
	`FRCORE_TIMESTAMP_STAT_RX_BYTES_ADD
(
‘h_Ën
);

68 
	`FRCORE_TIMESTAMP_STAT_XE_PKTS_INC
(
x•Üt
);

69 
	`FRCORE_TIMESTAMP_STAT_XE_BYTES_ADD
(
x•Üt
, 
‘h_Ën
);

70 
	`FRCORE_TIMESTAMP_STAT_PORT_PKTS_INC
(
pÜt
);

71 
	`FRCORE_TIMESTAMP_STAT_XE_PORT_PKTS_INC
(
x•Üt
, 
pÜt
);

74 ià(
y—r
 < 1970 || year > 2050)

76 
	`FRCORE_TIMESTAMP_STAT_XE_PORT_YEAR_INVALID_INC
(
x•Üt
, 
pÜt
);

77 
æag_šv®id
 = 1;

80 ià(
mÚth
 < 1 || month > 12)

82 
	`FRCORE_TIMESTAMP_STAT_XE_PORT_MONTH_INVALID_INC
(
x•Üt
, 
pÜt
);

83 
æag_šv®id
 = 1;

86 ià(
day
 < 1 || day > 31)

88 
	`FRCORE_TIMESTAMP_STAT_XE_PORT_DAY_INVALID_INC
(
x•Üt
, 
pÜt
);

89 
æag_šv®id
 = 1;

91 ià(
hour
 > 23)

93 
	`FRCORE_TIMESTAMP_STAT_XE_PORT_HOUR_INVALID_INC
(
x•Üt
, 
pÜt
);

94 
æag_šv®id
 = 1;

96 ià(
mšu‹
 > 60)

98 
	`FRCORE_TIMESTAMP_STAT_XE_PORT_MINUTE_INVALID_INC
(
x•Üt
, 
pÜt
);

99 
æag_šv®id
 = 1;

101 ià(
£cÚd
 > 60)

103 
	`FRCORE_TIMESTAMP_STAT_XE_PORT_SECOND_INVALID_INC
(
x•Üt
, 
pÜt
);

104 
æag_šv®id
 = 1;

107 ià(
æag_šv®id
)

109  
FRCORE_ACT_FORWARD
;

112 
¡am±ime
 = 
ns
 + 
us
*1000 + 
ms
*1000000;

113 
‹mp
 = 
£cÚd
 + 
mšu‹
*60 + 
hour
*3600+(
y—r
*365+
mÚth
*30+
day
)*24*3600;

114 
¡am±ime
 +ğ
‹mp
*1000000000;

115 
	`FRCORE_TIMESTAMP_CHECK_LOCK
(
x•Üt
, 
pÜt
);

116 ià(
time¡amp_checks
[
x•Üt
][
pÜt
].
upd©e
)

118 ià(
time¡amp_checks
[
x•Üt
][
pÜt
].
s
 >= sip)

120 
	`FRCORE_TIMESTAMP_STAT_XE_PORT_IP_ERR_INC
(
x•Üt
, 
pÜt
);

121 
’d
;

124 ià(
time¡amp_checks
[
x•Üt
][
pÜt
].
time¡amp
 >ğ
¡am±ime
)

126 
	`FRCORE_TIMESTAMP_STAT_XE_PORT_TIMESTAMP_ERR_INC
(
x•Üt
, 
pÜt
);

127 
’d
;

131 
time¡amp_checks
[
x•Üt
][
pÜt
].
time¡amp
 = 
¡am±ime
;

132 
time¡amp_checks
[
x•Üt
][
pÜt
].
s
 = sip;

133 
time¡amp_checks
[
x•Üt
][
pÜt
].
upd©e
 = 1;

135 
’d
:

136 
	`FRCORE_TIMESTAMP_CHECK_UNLOCK
(
x•Üt
, 
pÜt
);

137  
FRCORE_ACT_FORWARD
;

138 
	}
}

140 
	$äcÜe_time¡amp_check_v6
(
cvmx_wqe_t
 *
wÜk
, 
ušt8_t
 *
‘h_±r
, ušt8_ˆ*
_±r
, 
ušt64_t
 
smac
, ušt64_ˆ
dmac
)

142 
‘h_Ën
;

143 
ušt32_t
 
id_check
;

144 
ušt32_t
 
s
 = 0;

145 
ušt32_t
 
y—r
,
mÚth
,
day
,
hour
,
mšu‹
,
£cÚd
,
ms
,
us
,
ns
;

146 
ušt8_t
 
x•Üt
,
pÜt
;

147 
ušt8_t
 
æag_šv®id
 = 0;

148 
ušt64_t
 
¡am±ime
=0;

149 
ušt64_t
 
‹mp
 = 0;

151 ià(
wÜk
->
´t
 == 0)

153 
x•Üt
 = 0;

155 
x•Üt
 = 1;

157 
	`UP32
(
_±r
 + 20, 
s
);

158 
pÜt
 = (*(
_±r
 +20) & 0xff)%16;

159 
‘h_Ën
 = 
wÜk
->
Ën
;

160 
	`FRCORE_TIMESTAMP_CHECK
("s=0x%x\n", 
s
);

161 
	`FRCORE_TIMESTAMP_CHECK
("pÜt=0x%x\n", 
pÜt
);

164 
y—r
 = 0;

165 
y—r
 |ğ(*(
‘h_±r
 + 3) & 0x07)<< 8;

166 
y—r
 |ğ*(
‘h_±r
 + 4) & 0xff;

167 
mÚth
 = 0;

168 
mÚth
 |ğ(*(
‘h_±r
 + 5) & 0xf0) >> 4;

169 
day
 = 0;

170 
day
 |ğ(*(
‘h_±r
 + 5) & 0x0f) << 1;

171 
day
 |ğ(*(
‘h_±r
 + 6) & 0x80) >> 7;

172 
hour
 = 0;

173 
hour
 |ğ(*(
‘h_±r
 + 6) & 0x7c) >> 2;

174 
mšu‹
 = 0;

175 
mšu‹
 |ğ(*(
‘h_±r
 + 6) & 0x03) << 4;

176 
mšu‹
 |ğ(*(
‘h_±r
 + 7) & 0xf0) >> 4;

177 
£cÚd
 = 0;

178 
£cÚd
 |ğ(*(
‘h_±r
 + 7) & 0x0f) << 2;

179 
£cÚd
 |ğ(*(
‘h_±r
 + 8) & 0xc0) >> 6;

180 
ms
 = 0;

181 
ms
 |ğ(*(
‘h_±r
 + 8) & 0x3f) << 4;

182 
ms
 |ğ(*(
‘h_±r
 + 9) & 0xf0) >> 4;

183 
us
 = 0;

184 
us
 |ğ(*(
‘h_±r
 + 9) & 0x0f) << 6;

185 
us
 |ğ(*(
‘h_±r
 + 10) & 0xfc) >> 2;

186 
ns
 = 0;

187 
ns
 |ğ(*(
‘h_±r
 + 10) & 0x03) << 8;

188 
ns
 |ğ(*(
‘h_±r
 + 11) & 0xff);

189 
	`FRCORE_TIMESTAMP_CHECK
("time¡amp->y—r:%d\n", 
y—r
);

190 
	`FRCORE_TIMESTAMP_CHECK
("time¡amp->mÚth:%d\n", 
mÚth
);

191 
	`FRCORE_TIMESTAMP_CHECK
("time¡amp->d©e_h:%d\n", 
day
);

192 
	`FRCORE_TIMESTAMP_CHECK
("time¡amp->hour:%d\n", 
hour
);

193 
	`FRCORE_TIMESTAMP_CHECK
("time¡amp->mšu‹:%d\n", 
mšu‹
);

194 
	`FRCORE_TIMESTAMP_CHECK
("time¡amp->£cÚd:%d\n", 
£cÚd
);

195 
	`FRCORE_TIMESTAMP_CHECK
("time¡amp->ms:%d\n", 
ms
);

196 
	`FRCORE_TIMESTAMP_CHECK
("time¡amp->us_h:%d\n", 
us
);

197 
	`FRCORE_TIMESTAMP_CHECK
("time¡amp->ns:%d\n", 
ns
);

199 
	`FRCORE_TIMESTAMP_STAT_RX_PKTS_INC
();

200 
	`FRCORE_TIMESTAMP_STAT_RX_BYTES_ADD
(
‘h_Ën
);

201 
	`FRCORE_TIMESTAMP_STAT_XE_PKTS_INC
(
x•Üt
);

202 
	`FRCORE_TIMESTAMP_STAT_XE_BYTES_ADD
(
x•Üt
, 
‘h_Ën
);

203 
	`FRCORE_TIMESTAMP_STAT_PORT_PKTS_INC
(
pÜt
);

204 
	`FRCORE_TIMESTAMP_STAT_XE_PORT_PKTS_INC
(
x•Üt
, 
pÜt
);

207 ià(
y—r
 < 1970 || year > 2050)

209 
	`FRCORE_TIMESTAMP_STAT_XE_PORT_YEAR_INVALID_INC
(
x•Üt
, 
pÜt
);

210 
æag_šv®id
 = 1;

213 ià(
mÚth
 < 1 || month > 12)

215 
	`FRCORE_TIMESTAMP_STAT_XE_PORT_MONTH_INVALID_INC
(
x•Üt
, 
pÜt
);

216 
æag_šv®id
 = 1;

219 ià(
day
 < 1 || day > 31)

221 
	`FRCORE_TIMESTAMP_STAT_XE_PORT_DAY_INVALID_INC
(
x•Üt
, 
pÜt
);

222 
æag_šv®id
 = 1;

224 ià(
hour
 > 23)

226 
	`FRCORE_TIMESTAMP_STAT_XE_PORT_HOUR_INVALID_INC
(
x•Üt
, 
pÜt
);

227 
æag_šv®id
 = 1;

229 ià(
mšu‹
 > 60)

231 
	`FRCORE_TIMESTAMP_STAT_XE_PORT_MINUTE_INVALID_INC
(
x•Üt
, 
pÜt
);

232 
æag_šv®id
 = 1;

234 ià(
£cÚd
 > 60)

236 
	`FRCORE_TIMESTAMP_STAT_XE_PORT_SECOND_INVALID_INC
(
x•Üt
, 
pÜt
);

237 
æag_šv®id
 = 1;

240 ià(
æag_šv®id
)

242  
FRCORE_ACT_FORWARD
;

245 
¡am±ime
 = 
ns
 + 
us
*1000 + 
ms
*1000000;

246 
‹mp
 = 
£cÚd
 + 
mšu‹
*60 + 
hour
*3600+(
y—r
*365+
mÚth
*30+
day
)*24*3600;

247 
¡am±ime
 +ğ
‹mp
*1000000000;

248 
	`FRCORE_TIMESTAMP_CHECK_LOCK
(
x•Üt
, 
pÜt
);

249 ià(
time¡amp_checks
[
x•Üt
][
pÜt
].
upd©e
)

251 ià(
time¡amp_checks
[
x•Üt
][
pÜt
].
s
 >= sip)

253 
	`FRCORE_TIMESTAMP_STAT_XE_PORT_IP_ERR_INC
(
x•Üt
, 
pÜt
);

254 
’d
;

257 ià(
time¡amp_checks
[
x•Üt
][
pÜt
].
time¡amp
 >ğ
¡am±ime
)

259 
	`FRCORE_TIMESTAMP_STAT_XE_PORT_TIMESTAMP_ERR_INC
(
x•Üt
, 
pÜt
);

260 
’d
;

264 
time¡amp_checks
[
x•Üt
][
pÜt
].
time¡amp
 = 
¡am±ime
;

265 
time¡amp_checks
[
x•Üt
][
pÜt
].
s
 = sip;

266 
time¡amp_checks
[
x•Üt
][
pÜt
].
upd©e
 = 1;

268 
’d
:

269 
	`FRCORE_TIMESTAMP_CHECK_UNLOCK
(
x•Üt
, 
pÜt
);

270  
FRCORE_ACT_FORWARD
;

271 
	}
}

274 
	$äcÜe_cmd_time¡amp_check_g‘_¡©
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

276 
i
;

277 
äc_time¡amp_İ_š_t
 *
šput
 = (äc_time¡amp_İ_š_ˆ*è
·¿m
;

278 
ušt64_t
 *
v64p
;

279 
út_off£t
 = 0;

283 
	`FRCORE_TIMESTAMP_CHECK
("šput->šdex=%d\n", 
šput
->
šdex
);

284 
	`FRCORE_TIMESTAMP_CHECK
("šput->num =%d\n", 
šput
->
num
);

285 
út_off£t
 = 0;

286 
v64p
 = 
outbuf
;

287 
i
 = 0; i < 
šput
->
num
; i++, 
v64p
++)

289 *
v64p
 = 
	`FRCORE_TIMESTAMP_STAT_VAL
(
šput
->
šdex
 + 
i
 + 
út_off£t
);

290 ià(*
v64p
 > 0)

292 
	`FRCORE_TIMESTAMP_CHECK
("time¡amp_¡©[%d]ğ%Îd\n", 
šput
->
šdex
+
i
,*
v64p
);

296 *
Ş’
 = 
šput
->
num
 * (
ušt64_t
);

299 
	}
}

301 
	$äcÜe_time¡amp_check_¡©_ş—r
()

303 
i
;

305 
i
 = 0; i < 
¡©_time¡amp_max
; i++)

307 
	`FRCORE_TIMESTAMP_STAT_CLEAR
(
i
);

309 
	}
}

310 
	$äcÜe_cmd_time¡amp_check_ş—r_¡©
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

312 *
Ş’
 = 0;

313 
	`äcÜe_time¡amp_check_¡©_ş—r
();

314  
FRE_SUCCESS
;

315 
	}
}

317 
	$äcÜe_time¡amp_check_š™
()

319 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_GET_TIMESTAMP_CHECK_STAT
, 
äcÜe_cmd_time¡amp_check_g‘_¡©
);

320 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_CLEAR_TIMESTAMP_CHECK_STAT
, 
äcÜe_cmd_time¡amp_check_ş—r_¡©
);

322 
	`mem£t
(
time¡amp_checks
, 0, (timestamp_checks));

324 
	}
}

	@frcore/frcore_timestamp_check.h

1 #iâdeà
_FRCORE_TIMESTAMP_CHEKC_H_


2 
	#_FRCORE_TIMESTAMP_CHECK_H_


	)

3 
	~"äcÜe_pkt.h
"

4 
	~"äcÜe_¡©.h
"

5 
	~"äc_dma.h
"

6 
	~"äcÜe_´Ùo.h
"

7 
	~"äcÜe_s¢.h
"

8 
	~"äcÜe_s¢_´iv.h
"

9 
	~"äcÜe.h
"

10 
	~"äcÜe_cmd.h
"

11 
	~"äcÜe_misc.h
"

12 
	~"äc_·ck.h
"

13 
	~"äcÜe_´Ùo.h
"

14 
	~"äcÜe_š™.h
"

15 
	~"äc_ty³s.h
"

16 
	~"äcÜe_¡©.h
"

17 
	~"äcÜe_®g.h
"

19 #ià
FRC_CONFIG_TIMESTAMP_CHECK


21 
	#FRCORE_TIMESTAMP_STAT_INC
(
_út
è
	`cvmx_©omic_add64
((
št64_t
 *)(&
time¡amp_¡©
[_út]), 1)

	)

22 
	#FRCORE_TIMESTAMP_STAT_ADD
(
_út
, 
_v®
è
	`cvmx_©omic_add64
((
št64_t
 *)(&
time¡amp_¡©
[_út]), _v®)

	)

23 
	#FRCORE_TIMESTAMP_STAT_VAL
(
_út
è
	`cvmx_©omic_g‘64
((
št64_t
 *)(&
time¡amp_¡©
[_út]))

	)

24 
	#FRCORE_TIMESTAMP_STAT_CLEAR
(
_út
è
	`cvmx_©omic_£t64
((
št64_t
 *)(&
time¡amp_¡©
[_út]), 0)

	)

26 
	#FRCORE_TIMESTAMP_STAT_RX_PKTS_INC
(è
	`FRCORE_TIMESTAMP_STAT_INC
(
¡©_rxx_pkts
)

	)

27 
	#FRCORE_TIMESTAMP_STAT_RX_BYTES_ADD
(
_v®
è
	`FRCORE_TIMESTAMP_STAT_ADD
(
¡©_rxx_by‹s
, _v®)

	)

29 
	#FRCORE_TIMESTAMP_STAT_XE_PKTS_INC
(
_x•Üt
è\

	)

30 ià(0 =ğ
_x•Üt
) { \

31 
FRCORE_TIMESTAMP_STAT_INC
(
xe0_¡©_rxx_pkts
); \

34 
FRCORE_TIMESTAMP_STAT_INC
(
xe1_¡©_rxx_pkts
); \

37 
	#FRCORE_TIMESTAMP_STAT_XE_BYTES_ADD
(
_x•Üt
, 
_v®
è\

	)

38 ià(0 =ğ
_x•Üt
) { \

39 
FRCORE_TIMESTAMP_STAT_ADD
(
xe0_¡©_rxx_by‹s
, 
_v®
); \

42 
FRCORE_TIMESTAMP_STAT_ADD
(
xe1_¡©_rxx_by‹s
, 
_v®
); \

46 
	#FRCORE_TIMESTAMP_STAT_PORT_PKTS_INC
(
_pÜt
è
	`FRCORE_TIMESTAMP_STAT_INC
(
¡©_pÜt0_rxx_pkts
 + (_pÜt)*19 )

	)

48 
	#FRCORE_TIMESTAMP_STAT_XE_PORT_PKTS_INC
(
_x•Üt
, 
_pÜt
è\

	)

49 ià(0 =ğ
_x•Üt
) { \

50 
FRCORE_TIMESTAMP_STAT_INC
(
xe0_¡©_pÜt0_rxx_pkts
 + (
_pÜt
 )*19); \

53 
FRCORE_TIMESTAMP_STAT_INC
(
xe1_¡©_pÜt0_rxx_pkts
 + (
_pÜt
 )*19); \

56 
	#FRCORE_TIMESTAMP_STAT_XE_PORT_YEAR_INVALID_INC
(
_x•Üt
, 
_pÜt
è\

	)

57 ià(0 =ğ
_x•Üt
) { \

58 
FRCORE_TIMESTAMP_STAT_INC
(
xe0_¡©_pÜt0_y—r_šv®id_pkts
 + (
_pÜt
 )*19); \

61 
FRCORE_TIMESTAMP_STAT_INC
(
xe1_¡©_pÜt0_y—r_šv®id_pkts
 + (
_pÜt
 )*19); \

64 
	#FRCORE_TIMESTAMP_STAT_XE_PORT_MONTH_INVALID_INC
(
_x•Üt
, 
_pÜt
è\

	)

65 ià(0 =ğ
_x•Üt
) { \

66 
FRCORE_TIMESTAMP_STAT_INC
(
xe0_¡©_pÜt0_mÚth_šv®id_pkts
 + (
_pÜt
 )*19); \

69 
FRCORE_TIMESTAMP_STAT_INC
(
xe1_¡©_pÜt0_mÚth_šv®id_pkts
 + (
_pÜt
 )*19); \

72 
	#FRCORE_TIMESTAMP_STAT_XE_PORT_DAY_INVALID_INC
(
_x•Üt
, 
_pÜt
è\

	)

73 ià(0 =ğ
_x•Üt
) { \

74 
FRCORE_TIMESTAMP_STAT_INC
(
xe0_¡©_pÜt0_day_šv®id_pkts
 + (
_pÜt
 )*19); \

77 
FRCORE_TIMESTAMP_STAT_INC
(
xe1_¡©_pÜt0_day_šv®id_pkts
 + (
_pÜt
 )*19); \

80 
	#FRCORE_TIMESTAMP_STAT_XE_PORT_HOUR_INVALID_INC
(
_x•Üt
, 
_pÜt
è\

	)

81 ià(0 =ğ
_x•Üt
) { \

82 
FRCORE_TIMESTAMP_STAT_INC
(
xe0_¡©_pÜt0_hour_šv®id_pkts
 + (
_pÜt
 )*19); \

85 
FRCORE_TIMESTAMP_STAT_INC
(
xe1_¡©_pÜt0_hour_šv®id_pkts
 + (
_pÜt
 )*19); \

88 
	#FRCORE_TIMESTAMP_STAT_XE_PORT_MINUTE_INVALID_INC
(
_x•Üt
, 
_pÜt
è\

	)

89 ià(0 =ğ
_x•Üt
) { \

90 
FRCORE_TIMESTAMP_STAT_INC
(
xe0_¡©_pÜt0_mšu‹_šv®id_pkts
 + (
_pÜt
 )*19); \

93 
FRCORE_TIMESTAMP_STAT_INC
(
xe1_¡©_pÜt0_mšu‹_šv®id_pkts
 + (
_pÜt
 )*19); \

96 
	#FRCORE_TIMESTAMP_STAT_XE_PORT_SECOND_INVALID_INC
(
_x•Üt
, 
_pÜt
è\

	)

97 ià(0 =ğ
_x•Üt
) { \

98 
FRCORE_TIMESTAMP_STAT_INC
(
xe0_¡©_pÜt0_£cÚd_šv®id_pkts
 + (
_pÜt
 )*19); \

101 
FRCORE_TIMESTAMP_STAT_INC
(
xe1_¡©_pÜt0_£cÚd_šv®id_pkts
 + (
_pÜt
 )*19); \

105 
	#FRCORE_TIMESTAMP_STAT_XE_PORT_IP_ERR_INC
(
_x•Üt
, 
_pÜt
è\

	)

106 ià(0 =ğ
_x•Üt
) { \

107 
FRCORE_TIMESTAMP_STAT_INC
(
xe0_¡©_pÜt0__”r_pkts
 + (
_pÜt
 )*19); \

110 
FRCORE_TIMESTAMP_STAT_INC
(
xe1_¡©_pÜt0__”r_pkts
 + (
_pÜt
 )*19); \

113 
	#FRCORE_TIMESTAMP_STAT_XE_PORT_TIMESTAMP_ERR_INC
(
_x•Üt
, 
_pÜt
è\

	)

114 ià(0 =ğ
_x•Üt
) { \

115 
FRCORE_TIMESTAMP_STAT_INC
(
xe0_¡©_pÜt0_time¡amp_”r_pkts
 + (
_pÜt
 )*19); \

118 
FRCORE_TIMESTAMP_STAT_INC
(
xe1_¡©_pÜt0_time¡amp_”r_pkts
 + (
_pÜt
 )*19); \

122 
	stime¡amp
 {

123 
ušt8_t
 
	m»£rved
[3];

124 
ušt16_t
 
	mz”o
:5;

125 
ušt16_t
 
	my—r
:11;

126 
ušt8_t
 
	mmÚth
:4;

127 
ušt8_t
 
	md©e_h
:4;

128 
ušt32_t
 
	md©e_l
:1;

129 
ušt32_t
 
	mhour
:5;

130 
ušt32_t
 
	mmšu‹
:6;

131 
ušt32_t
 
	m£cÚd
:6;

132 
ušt32_t
 
	mms
:10;

133 
ušt32_t
 
	mus_h
:4;

134 
ušt16_t
 
	mus_l
:6;

135 
ušt16_t
 
	mns
:10;

136 }
	ttime¡amp_t
;

138 
	stime¡amp
 {

139 
ušt16_t
 
	my—r
;

140 
ušt8_t
 
	mmÚth
;

141 
ušt8_t
 
	mday
;

142 
ušt8_t
 
	mhour
;

143 
ušt8_t
 
	mmšu‹
;

144 
ušt8_t
 
	m£cÚd
;

145 
ušt16_t
 
	mms
;

146 
ušt16_t
 
	mus
;

147 
ušt16_t
 
	mns
;

152 
	stime¡amp_check
{

153 
ušt8_t
 
	mupd©e
;

154 
ušt32_t
 
	ms
;

155 
ušt64_t
 
	mtime¡amp
;

156 
cvmx_¥šlock_t
 
	mlock
;

159 
äcÜe_time¡amp_check_v4
(
cvmx_wqe_t
 *
wÜk
, 
ušt8_t
 *
‘h_±r
, ušt8_ˆ*
_±r
, 
ušt64_t
 
smac
, ušt64_ˆ
dmac
);

160 
äcÜe_time¡amp_check_v6
(
cvmx_wqe_t
 *
wÜk
, 
ušt8_t
 *
‘h_±r
, ušt8_ˆ*
_±r
, 
ušt64_t
 
smac
, ušt64_ˆ
dmac
);

161 
äcÜe_time¡amp_check_š™
();

	@frcore/frcore_twotuple.c

1 
	~"äcÜe.h
"

2 
	~"äcÜe_cmd.h
"

3 
	~"äcÜe_misc.h
"

4 
	~"äc_·ck.h
"

5 
	~"äcÜe_´Ùo.h
"

6 
	~"cvmx-mdio.h
"

7 
	~"äcÜe_š™.h
"

8 
	~"äcÜe_aş.h
"

9 
	~"äcÜe_pkt.h
"

10 
	~"äc_ty³s.h
"

11 
	~"äcÜe_¡©.h
"

12 
	~"äcÜe_chª.h
"

13 
	~"äcÜe_f‹r.h
"

15 #ià
FRC_CONFIG_TWO_TUPLE


16 
CVMX_SHARED
 
ušt8_t
 
	gaş_’abË
 = 0;

18 
	$äcÜe_cmd_aş_’abË
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

20 
ušt8_t
 *
’abË
 = (ušt8_ˆ*)
·¿m
;

21 
aş_’abË
 = *
’abË
;

22 
	`FRCORE_TwoTu¶e
("===========================================================\n");

23 
	`´štf
("aş_’abË=%d\n", 
aş_’abË
);

25  
FRE_SUCCESS
;

26 
	}
}

28 
	$äcÜe_cmd_aş_¡©us_g‘
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

30 
ušt8_t
 
’abË
;

31 
’abË
 = 
aş_’abË
;

32 
	`memıy
(
outbuf
, &
’abË
, 1);

33 *
Ş’
 = 1;

35  
FRE_SUCCESS
;

36 
	}
}

38 
	$äcÜe_cmd_aş_add
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

40 
äc_aş_t
 *
aş
 = (äc_aş_ˆ*)
·¿m
;

42 
	`FRCORE_TwoTu¶e
("===========================================================\n");

43 
	`FRCORE_TwoTu¶e
("Ú‘u¶ğ0x%x\n", 
aş
->
Úe_tu¶e
);

44 
	`FRCORE_TwoTu¶e
("´ÙØğ%d\n", 
aş
->
´Ùo
);

45 
	`FRCORE_TwoTu¶e
("šdex = %d\n", 
aş
->
šdex
);

46 
	`FRCORE_TwoTu¶e
("aş_sourû = %d\n", 
aş
->
aş_sourû
);

47 
	`FRCORE_TwoTu¶e
("aş_ty³ = %d\n", 
aş
->
aş_ty³
);

48 
	`FRCORE_TwoTu¶e
("aùiÚ = %d\n", 
aş
->
aùiÚ
);

49 
	`FRCORE_TwoTu¶e
("İ = %d\n", 
aş
->
İ
);

51 #ià
FRC_CONFIG_TWO_TUPLE_TSET


53 
	`aş_£t_f‹r
(
aş
->
šdex
,‡ş->
Úe_tu¶e
,‡ş->
´Ùo
,‡ş->
İ
,

54 
aş
->
aùiÚ
,‡ş->
aş_ty³
,‡ş->
aş_sourû
);

57  
FRE_SUCCESS
;

59 
	}
}

61 
	$äcÜe_cmd_aş_d–
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

63 
i
, 
rv
 = 0;

64 
ušt16_t
 
num
 = 0;

65 
äc_aş_İ_š_t
 *
d–
 = (äc_aş_İ_š_ˆ*)
·¿m
;

67 
ušt16_t
 
gid
;

68 
	`FRCORE_TwoTu¶e
("===========================================================\n");

69 
	`FRCORE_TwoTu¶e
("šdex = %d\n", 
d–
->
šdex
);

70 
	`FRCORE_TwoTu¶e
("num = %d\n", 
d–
->
num
);

72 #ià
FRC_CONFIG_TWO_TUPLE_TSET


73 
num
 = 
d–
->num;

75 
gid
 = 
d–
->
šdex
;

76 
i
 = 0; i < ()
d–
->
num
; i++)

78 
rv
 = 
	`aş_d–_f‹r
(
gid
+
i
);

79 ià(!
rv
)

81 
num
++;

85 *((
ušt16_t
 *è
outbuf
èğ
num
;

87  
rv
;

89 
	}
}

91 
	$äcÜe_cmd_aş_ş—r_®l
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

93 
i
, 
rv
;

94 
äc_aş_İ_š_t
 *
d–
 = (äc_aş_İ_š_ˆ*)
·¿m
;

95 
ušt16_t
 
num_Şd
, 
num_Ãw
;

97 
ušt16_t
 
gid
;

98 
	`FRCORE_TwoTu¶e
("===========================================================\n");

99 
	`FRCORE_TwoTu¶e
("šdex = %d\n", 
d–
->
šdex
);

100 
	`FRCORE_TwoTu¶e
("num = %d\n", 
d–
->
num
);

102 #ià
FRC_CONFIG_TWO_TUPLE_TSET


103 *((
ušt16_t
 *è
outbuf
èğ
d–
->
num
;

105 
rv
 = 
	`aş_g‘_f‹r_couÁ
(&
num_Şd
);

106 ià(
rv
)

108  
FRE_FAIL
;

111 
gid
 = 
d–
->
šdex
;

112 
i
 = 0; i < ()
d–
->
num
; i++)

114 
rv
 = 
	`aş_d–_f‹r
(
gid
+
i
);

117 
rv
 = 
	`aş_g‘_f‹r_couÁ
(&
num_Ãw
);

118 ià(
rv
)

120  
FRE_FAIL
;

123 ià(!
num_Ãw
)

125 *((
ušt16_t
 *è
outbuf
èğ
num_Şd
;

127 
	`FRCORE_TwoTu¶e
("num = %d\n", 
num_Ãw
);

128  
FRE_FAIL
;

131  
FRE_SUCCESS
;

133 
	}
}

136 
	$äcÜe_cmd_aş_¡©_g‘
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

138 
äc_aş_İ_š_t
 *
šput
 = (äc_aş_İ_š_ˆ*)
·¿m
;

139 
äc_aş_¡©_out_t
 
ouut
;

141 
	`FRCORE_TwoTu¶e
("===========================================================\n");

142 
	`FRCORE_TwoTu¶e
("šdex = %d\n", 
šput
->
šdex
);

143 
	`FRCORE_TwoTu¶e
("num = %d\n", 
šput
->
num
);

145 #ià
FRC_CONFIG_TWO_TUPLE_TSET


146 
	`mem£t
(&
ouut
, 0, (
äc_aş_¡©_out_t
));

147 
ouut
.
num
 = 
šput
->num;

148 
ouut
.
aş_¡©
[0].
aş
.
Úe_tu¶e
 = 0xca000001;

149 
ouut
.
aş_¡©
[0].
aş
.
´Ùo
 = 0x11;

150 
ouut
.
aş_¡©
[0].
aş
.
šdex
 = 
šput
->index;

151 
ouut
.
aş_¡©
[0].
aş
.
aş_sourû
 = 4;

152 
ouut
.
aş_¡©
[0].
aş
.
aş_ty³
 = 
FRC_ACL_SIP
;

153 
ouut
.
aş_¡©
[0].
aş
.
aùiÚ
 = 1;

154 
ouut
.
aş_¡©
[0].
aş
.
İ
 = 2;

155 
ouut
.
aş_¡©
[0].
¡©
.
pkts
 = 400;

156 
ouut
.
aş_¡©
[0].
¡©
.
by‹s
 = 50000;

158 
ouut
.
aş_¡©
[1].
aş
.
Úe_tu¶e
= 0xc0000003;

159 
ouut
.
aş_¡©
[1].
aş
.
´Ùo
 = 0x6;

160 
ouut
.
aş_¡©
[1].
aş
.
šdex
 = 
šput
->index + 1;

161 
ouut
.
aş_¡©
[1].
aş
.
aş_sourû
 = 6;

162 
ouut
.
aş_¡©
[1].
aş
.
aş_ty³
 = 
FRC_ACL_DIP
;

163 
ouut
.
aş_¡©
[1].
aş
.
aùiÚ
 = 8;

164 
ouut
.
aş_¡©
[1].
aş
.
İ
 = 9;

165 
ouut
.
aş_¡©
[1].
¡©
.
pkts
 = 200;

166 
ouut
.
aş_¡©
[1].
¡©
.
by‹s
 = 30000;

168 
ouut
.
aş_¡©
[2].
aş
.
Úe_tu¶e
 = 232;

169 
ouut
.
aş_¡©
[2].
aş
.
´Ùo
 = 0x11;

170 
ouut
.
aş_¡©
[2].
aş
.
šdex
 = 
šput
->index + 2;

171 
ouut
.
aş_¡©
[2].
aş
.
aş_sourû
 = 12;

172 
ouut
.
aş_¡©
[2].
aş
.
aş_ty³
 = 
FRC_ACL_SP
;

173 
ouut
.
aş_¡©
[2].
aş
.
aùiÚ
 = 14;

174 
ouut
.
aş_¡©
[2].
aş
.
İ
 = 15;

175 
ouut
.
aş_¡©
[2].
¡©
.
pkts
 = 600;

176 
ouut
.
aş_¡©
[2].
¡©
.
by‹s
 = 80000;

178 
i
,
j
, 
rv
;

179 
ušt32_t
 
Úe_tu¶e
;

180 
ušt16_t
 
´Ùo
;

181 
ušt16_t
 
gid
, 
aşnum
;

182 
ušt16_t
 
İ
, 
aùiÚ
, 
aş_ty³
, 
aş_sourû
;

183 
ušt32_t
 
pkts
, 
by‹s
, 
hash
;

184 
ouut
.
num
 = 0;

185 
i
 = 0, 
j
 = 0; i < ()
šput
->
num
; i++)

187 
gid
 = 
šput
->
šdex
 + 
i
;

188 
rv
 = 
	`aş_g‘_Úe_f‹r
(
gid
, &
Úe_tu¶e
, &
´Ùo
, &
İ
, &
aùiÚ
,

189 &
aş_ty³
, &
aş_sourû
, &
pkts
, &
by‹s
, &
hash
);

190 ià(
rv
)

194 
ouut
.
aş_¡©
[
j
].
aş
.
Úe_tu¶e
 = one_tuple;

195 
ouut
.
aş_¡©
[
j
].
aş
.
´Ùo
 =…roto;

196 
ouut
.
aş_¡©
[
j
].
aş
.
šdex
 = 
gid
;

197 
ouut
.
aş_¡©
[
j
].
aş
.
aş_sourû
 =‡cl_source;

198 
ouut
.
aş_¡©
[
j
].
aş
.
aş_ty³
 =‡cl_type;

199 
ouut
.
aş_¡©
[
j
].
aş
.
aùiÚ
 =‡ction;

200 
ouut
.
aş_¡©
[
j
].
aş
.
İ
 = op;

201 
ouut
.
aş_¡©
[
j
].
aş
.
hash
 = hash;

202 
ouut
.
aş_¡©
[
j
].
¡©
.
pkts
 =…kts;

203 
ouut
.
aş_¡©
[
j
].
¡©
.
by‹s
 = bytes;

204 
ouut
.
num
++;

205 
j
++;

208 
	`memıy
(
outbuf
, &
ouut
, (
äc_aş_¡©_out_t
));

209 *
Ş’
 = (
äc_aş_¡©_out_t
);

211  
FRE_SUCCESS
;

212 
	}
}

215 
	$äcÜe_cmd_aş_hash_bË_g‘
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

217 
äc_aş_hash_bË_İ_š_t
 *
šput
 = (äc_aş_hash_bË_İ_š_ˆ*)
·¿m
;

218 
äc_aş_hash_bË_¡©_out_t
 
ouut
;

220 
	`FRCORE_TwoTu¶e
("===========================================================\n");

221 
	`FRCORE_TwoTu¶e
("aş_ty³ = %d\n", 
šput
->
aş_ty³
);

222 
	`FRCORE_TwoTu¶e
("šdex = %d\n", 
šput
->
šdex
);

223 
	`FRCORE_TwoTu¶e
("num = %d\n", 
šput
->
num
);

225 #ià
FRC_CONFIG_TWO_TUPLE_TSET


226 
	`mem£t
(&
ouut
, 0, (
äc_aş_¡©_out_t
));

227 
ouut
.
num
 = 
šput
->num;

228 
ouut
.
aş_hash_¡©
[0].
hash
 = 
šput
->
šdex
;

229 
ouut
.
aş_hash_¡©
[0].
buck‘_d•th
 = 1;

230 
ouut
.
aş_hash_¡©
[0].
tÙ®_ûÎ
 = 1;

231 
ouut
.
aş_hash_¡©
[0].
d–_ûÎ
 = 0

233 
ouut
.
aş_hash_¡©
[1].
hash
 = 
šput
->
šdex
 + 1;

234 
ouut
.
aş_hash_¡©
[1].
buck‘_d•th
 = 1;

235 
ouut
.
aş_hash_¡©
[1].
tÙ®_ûÎ
 = 1;

236 
ouut
.
aş_hash_¡©
[1].
d–_ûÎ
 = 0

238 
ouut
.
aş_hash_¡©
[2].
hash
 = 
šput
->
šdex
 + 2;

239 
ouut
.
aş_hash_¡©
[2].
buck‘_d•th
 = 1;

240 
ouut
.
aş_hash_¡©
[2].
tÙ®_ûÎ
 = 1;

241 
ouut
.
aş_hash_¡©
[2].
d–_ûÎ
 = 0

243 
ouut
.
aş_hash_¡©
[3].
hash
 = 
šput
->
šdex
 + 3;

244 
ouut
.
aş_hash_¡©
[3].
buck‘_d•th
 = 1;

245 
ouut
.
aş_hash_¡©
[3].
tÙ®_ûÎ
 = 1;

246 
ouut
.
aş_hash_¡©
[3].
d–_ûÎ
 = 0

248 
i
,
j
, 
rv
;

249 
ušt16_t
 
gid
;

250 
ušt32_t
 
buck‘_d•th
, 
tÙ®_ûÎ
, 
d–_ûÎ
;

251 
ouut
.
num
 = 0;

252 
i
 = 0, 
j
 = 0; i < ()
šput
->
num
; i++)

254 
gid
 = 
šput
->
šdex
 + 
i
;

255 
rv
 = 
	`aş_g‘_Úe_hash_bË
(
šput
->
aş_ty³
, 
gid
, &
buck‘_d•th
, &
tÙ®_ûÎ
, &
d–_ûÎ
);

256 ià(
rv
)

261 
ouut
.
aş_hash_¡©
[
j
].
buck‘_d•th
 = bucket_depth;

262 
ouut
.
aş_hash_¡©
[
j
].
tÙ®_ûÎ
 =otal_cell;

263 
ouut
.
aş_hash_¡©
[
j
].
d–_ûÎ
 = del_cell;

264 
ouut
.
aş_hash_¡©
[
j
].
hash
 = 
gid
;

265 
ouut
.
num
++;

266 
j
++;

269 
	`memıy
(
outbuf
, &
ouut
, (
äc_aş_hash_bË_¡©_out_t
));

270 *
Ş’
 = (
äc_aş_hash_bË_¡©_out_t
);

272  
FRE_SUCCESS
;

273 
	}
}

275 
	$äcÜe_cmd_aş_¡©_ş—r
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

277 
äc_aş_İ_š_t
 *
šput
 = (äc_aş_İ_š_ˆ*)
·¿m
;

278 
i
;

280 
	`FRCORE_TwoTu¶e
("===========================================================\n");

281 
	`FRCORE_TwoTu¶e
("šdex = %d\n", 
šput
->
šdex
);

282 
	`FRCORE_TwoTu¶e
("num = %d\n", 
šput
->
num
);

283 #ià
FRC_CONFIG_TWO_TUPLE_TSET


284 *((
ušt16_t
 *)
outbuf
èğ
ACL_MAX
;

285 *
Ş’
 = 2;

287 
ušt16_t
 
gid
;

288 
i
ğ0; i < ()
šput
->
num
; i++)

290 
gid
 = 
šput
->
šdex
 + 
i
;

291 
	`f‹r_š™_f‹r_¡©i¡ics
(
gid
);

293 *((
ušt16_t
 *)
outbuf
èğ
i
;

294 *
Ş’
 = 2;

296 
	`FRCORE_TwoTu¶e
(" *((ušt16_ˆ*)outbuf)ğ%d\n", *((
ušt16_t
 *)
outbuf
));

297  
FRE_SUCCESS
;

298 
	}
}

301 
	$äcÜe_cmd_aş_g‘_num
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

303 
	`FRCORE_TwoTu¶e
("===========================================================\n");

304 #ià
FRC_CONFIG_TWO_TUPLE_TSET


305 *((
ušt16_t
 *)
outbuf
èğ
ACL_MAX
;

306 *
Ş’
 = 2;

308 
rv
;

309 
ušt16_t
 
aş_num
;

310 
rv
 = 
	`aş_g‘_f‹r_couÁ
(&
aş_num
);

311 ià(
rv
)

313  
FRE_FAIL
;

315 *((
ušt16_t
 *)
outbuf
èğ
aş_num
;

316 *
Ş’
 = 2;

318 
	`FRCORE_TwoTu¶e
(" *((ušt16_ˆ*)outbuf)ğ%d\n", *((
ušt16_t
 *)
outbuf
));

319  
FRE_SUCCESS
;

320 
	}
}

323 
	$äcÜe_aş_š™
()

325 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_ACL_ENABLE
, 
äcÜe_cmd_aş_’abË
);

326 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_GET_ACL_STATUS
, 
äcÜe_cmd_aş_¡©us_g‘
);

327 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_ADD_ACL
, 
äcÜe_cmd_aş_add
);

328 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_DEL_ACL
, 
äcÜe_cmd_aş_d–
);

329 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_CLEAN_ALL_ACL
, 
äcÜe_cmd_aş_ş—r_®l
);

330 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_GET_ACL
, 
äcÜe_cmd_aş_¡©_g‘
);

331 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_GET_ACL_HASH_TABLE
, 
äcÜe_cmd_aş_hash_bË_g‘
);

332 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_CLEAN_ACL_STAT
, 
äcÜe_cmd_aş_¡©_ş—r
);

333 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_GET_ACL_NUM
, 
äcÜe_cmd_aş_g‘_num
);

336 
	}
}

339 
	$äcÜe_aş_´oûss
(
cvmx_wqe_t
 *
wÜk
, 
ušt8_t
 *
‘h_±r
, ušt8_ˆ*
_±r
,

340 
ušt8_t
 *
udp_±r
, 
ušt16_t
 
_·yËn
, 
ušt64_t
 
smac
, ušt64_ˆ
dmac
)

343 
ušt8_t
 
aşgid
 = 0;

345 
rv
 = 0;

346 
mµ_tu¶e
 
tu¶e
;

347 
ušt16_t
 
g
 = 0;

348 
ušt16_t
 
pkt_Ën
;

349 
tıhdr
 *
th
;

352 ià(!
aş_’abË
)

358 
äc_dma_hdr_t
 
hdr
;

359 
äc_dma_pkt_šfo_t
 
šfo
;

360 
‘h_Ën
;

362 
	#_IPH
 ((
hdr
*)(
_±r
))

	)

364 
tu¶e
.
d©a
[0] = *((
ušt64_t
*)(((*)
_IPH
)+12));

365 
tu¶e
.
d©a
[1] = 0ul;

366 
tu¶e
.
d©a_32
[2] = *(
ušt32_t
*)(
udp_±r
);

367 
tu¶e
.
´Ùo
 = 
_IPH
->
´ÙocŞ
;

369 
	`MC_PRINTF_INFO
("sip:%u,%u,%u,%u dip:%u,%u,%u,%u sp:%u,dp:%u,pro:%u\n",

370 
tu¶e
.
s
 >> 24 & 0xFF,

371 
tu¶e
.
s
 >>16 & 0xFF,

372 
tu¶e
.
s
 >> 8 & 0xFF,

373 
tu¶e
.
s
 & 0xFF,

374 
tu¶e
.
d
 >> 24 & 0xFF,

375 
tu¶e
.
d
 >>16 & 0xFF,

376 
tu¶e
.
d
 >> 8 & 0xFF,

377 
tu¶e
.
d
 & 0xFF,

378 
tu¶e
.
¥
,

379 
tu¶e
.
dp
,

380 
tu¶e
.
´Ùo
);

383 ià(
tu¶e
.
´Ùo
 =ğ
PROTO_TCP
)

385 
th
 = (
tıhdr
 *)
udp_±r
;

386 if(((
_IPH
->
ihl
 + 
th
->
doff
è<<2è> (_IPH->
tÙ_Ën
)) {

387 
	`FRCORE_STAT_INC
(
¡©_aş_m®fÜmed_·ck‘
);

388  
FRCORE_ACT_DROP
;

392 
g
 = 
	`f‹r_lookup_by_tu¶e
(
tu¶e
);

394 
	`FRCORE_TwoTu¶e
("g=%d\n", 
g
);

395 ià(
g
)

397 
	`FRCORE_STAT_INC
(
¡©_aş_m©ched_pkts
);

398 
	`FRCORE_STAT_ADD
(
¡©_aş_m©ched_by‹s
, 
wÜk
->
Ën
);

400 
pkt_Ën
 = 
wÜk
->
Ën
;;

401 
	`MC_PRINTF_INFO
("pkt_len: %d\n");

403 
	`f‹r_¡©i¡ic_h™
(
g
);

405 
	`f‹r_pkt_by‹s_add
(
g
, 
pkt_Ën
);

408 
	`mem£t
(&
hdr
, 0, (
äc_dma_hdr_t
));

409 
	`mem£t
(&
šfo
, 0, (
äc_dma_pkt_šfo_t
));

411 
	`UP32
(
_±r
 + 12, 
hdr
.
s
);

413 
	`UP32
(
_±r
 + 16, 
hdr
.
d
);

415 
	`UP16
(
udp_±r
, 
hdr
.
¥Üt
);

416 
	`UP16
(
udp_±r
 + 2, 
hdr
.
dpÜt
);

418 
‘h_Ën
 = 
wÜk
->
Ën
;

420 
hdr
.
´ÙocŞ
 = 
tu¶e
.
´Ùo
;

421 
hdr
.
hash
 = 
wÜk
->
g
 & 0xffffff;

423 
hdr
.
pkt_num
 = 1;

424 
hdr
.
tÙ®_·yËn
 = 
‘h_Ën
;

425 
tu¶e
.
´Ùo
) {

426 
PROTO_TCP
:

427 
th
 = (
tıhdr
 *)
udp_±r
;

428 
šfo
.
d©a_off£t
 = (
ušt32_t
)(
udp_±r
 - 
‘h_±r
 + (
th
->
doff
 << 2));

429 
šfo
.
·ylßd_Ën
 = 
_·yËn
 - (
th
->
doff
 << 2);

430 
šfo
.
£qu’û
 = 
th
->
£q
;

431 
šfo
.
ack_£q
 = 
th
->ack_seq;

433 
PROTO_UDP
:

434 
šfo
.
d©a_off£t
 = (
ušt32_t
)(
udp_±r
 - 
‘h_±r
 + 8);

435 
šfo
.
·ylßd_Ën
 = 
_·yËn
 - 8;

440 
šfo
.
smac
 = smac;

441 
šfo
.
dmac
 = dmac;

443 
rv
 = 
	`äcÜe_fÜw¬d_ruË_pkt_to_fifo
(&
g
, &
hdr
, &
šfo
, 
‘h_±r
);

444 
	`FRCORE_TwoTu¶e
("äcÜe_fÜw¬d_sim¶e_pkt_to_fifØ»tuº %d.\n", 
rv
);

445 ià(
rv
)

452 
	`FRCORE_STAT_INC
(
¡©_aş_nÙ_m©ched_pkts
);

453 
	`FRCORE_STAT_ADD
(
¡©_aş_nÙ_m©ched_by‹s
, 
wÜk
->
Ën
);

456  
rv
;

457 
	}
}

	@frcore/frcore_twotuple.h

1 #iâdeà
__FRCORE_TWOTUPLE_H__


2 
	#__FRCORE_TWOTUPLE_H__


	)

3 #ià
FRC_CONFIG_TWO_TUPLE


4 
äcÜe_aş_š™
();

5 
äcÜe_aş_´oûss
(
cvmx_wqe_t
 *
wÜk
, 
ušt8_t
 *
‘h_±r
, ušt8_ˆ*
_±r
,

6 
ušt8_t
 *
udp_±r
, 
ušt16_t
 
_·yËn
, 
ušt64_t
 
smac
, ušt64_ˆ
dmac
);

	@frcore/frcore_udp.c

1 
	~"äcÜe_pkt.h
"

3 
	~"äcÜe_udp.h
"

4 
	~"äcÜe_¡©.h
"

6 
	~"äc_dma.h
"

7 
	~"äcÜe_chª.h
"

9 
	~"äcÜe.h
"

10 
	~"äcÜe_cmd.h
"

11 
	~"äc_ty³s.h
"

12 
CVMX_SHARED
 
ušt8_t
 
	gudp_’abË
 = 1;

14 #ià
FRC_CONFIG_UDP


15 
	$äcÜe_udp_´oûss
(
cvmx_wqe_t
 *
wÜk
, 
ušt8_t
 *
‘h_±r
, ušt8_ˆ*
_±r
, ušt8_ˆ*
udp_±r
, 
ušt16_t
 
_·yËn
, 
ušt64_t
 
smac
, ušt64_ˆ
dmac
)

17 
rv
;

18 
äc_dma_hdr_t
 
hdr
;

19 
äc_dma_pkt_šfo_t
 
šfo
;

20 
‘h_Ën
;

25 ià(!
udp_’abË
)

27  
FRCORE_ACT_FORWARD
;

30 
	`mem£t
(&
hdr
, 0, (
äc_dma_hdr_t
));

31 
	`mem£t
(&
šfo
, 0, (
äc_dma_pkt_šfo_t
));

33 
	`UP32
(
_±r
 + 12, 
hdr
.
s
);

35 
	`UP32
(
_±r
 + 16, 
hdr
.
d
);

37 
	`UP16
(
udp_±r
, 
hdr
.
¥Üt
);

38 
	`UP16
(
udp_±r
 + 2, 
hdr
.
dpÜt
);

40 
‘h_Ën
 = 
wÜk
->
Ën
;

42 
hdr
.
´ÙocŞ
 = 
PROTO_UDP
;

43 
hdr
.
hash
 = 
wÜk
->
g
 & 0xffffff;

45 
hdr
.
pkt_num
 = 1;

46 
hdr
.
tÙ®_·yËn
 = 
‘h_Ën
;

48 
šfo
.
d©a_off£t
 = (
ušt32_t
)(
udp_±r
 - 
‘h_±r
 + 8);

49 
šfo
.
·ylßd_Ën
 = 
_·yËn
 - 8;

50 
šfo
.
smac
 = smac;

51 
šfo
.
dmac
 = dmac;

53 
rv
 = 
	`äcÜe_fÜw¬d_sim¶e_pkt_to_fifo
(
FRC_WORK_UDP
, &
hdr
, &
šfo
, 
‘h_±r
);

54 
	`FRCORE_UDP
("äcÜe_fÜw¬d_sim¶e_pkt_to_fifØ»tuº %d.\n", 
rv
);

55 ià(
rv
 !ğ
FRE_SUCCESS
)

62 
	`FRCORE_STAT_INC
(
¡©_udp_subm™_pkts
);

63 
	`FRCORE_STAT_ADD
(
¡©_udp_subm™_by‹s
, 
wÜk
->
Ën
);

66  
FRCORE_ACT_FORWARD
;

67 
	}
}

69 
	$äcÜe_cmd_udp_’abË
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

71 
ušt8_t
 *
’abË
 = (ušt8_ˆ*)
·¿m
;

72 
udp_’abË
 = *
’abË
;

73 
	`FRCORE_UDP
("===========================================================\n");

74 
	`´štf
("udp_’abË=%d\n", 
udp_’abË
);

76  
FRE_SUCCESS
;

77 
	}
}

79 
	$äcÜe_cmd_udp_¡©us_g‘
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

81 
ušt8_t
 
’abË
;

82 
’abË
 = 
udp_’abË
;

83 
	`memıy
(
outbuf
, &
’abË
, 1);

84 *
Ş’
 = 1;

86  
FRE_SUCCESS
;

87 
	}
}

90 
	$äcÜe_udp_š™
()

92 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_UDP_ENABLE
, 
äcÜe_cmd_udp_’abË
);

93 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_GET_UDP_STATUS
, 
äcÜe_cmd_udp_¡©us_g‘
);

95  
FRE_SUCCESS
;

96 
	}
}

	@frcore/frcore_udp.h

1 #iâdeà
__FRCORE_UDP_H__


2 
	#__FRCORE_UDP_H__


	)

4 
	#UDP_HDR_SZ
 8

	)

6 
äcÜe_udp_´oûss
(
cvmx_wqe_t
 *
wÜk
, 
ušt8_t
 *
‘h_±r
, ušt8_ˆ*
_±r
, ušt8_ˆ*
udp_±r
, 
ušt16_t
 
_·yËn
, 
ušt64_t
 
smac
, ušt64_ˆ
dmac
);

9 
äcÜe_udp_š™
();

	@frcore/frcore_vlan_check.c

1 
	~"äcÜe_vÏn_check.h
"

3 #ià
FRC_CONFIG_VLAN_CHECK


4 
CVMX_SHARED
 
št64_t
 
	gvÏn_id_¡©
[
¡©_vÏn_id_max
]= {0};

5 
CVMX_SHARED
 
ušt16_t
 
	gvÏn_id_¡¬t
 = 1024;

6 
CVMX_SHARED
 
ušt16_t
 
	gvÏn_id_num
 = 128;

7 
CVMX_SHARED
 
ušt8_t
 
	gvÏn_check_hash_ty³
 = 1;

10 #ià
FRC_CONFIG_VLAN_IV


12 
CVMX_SHARED
 
ušt32_t
 
	ghash_s4_mask
 = 0xffffffff;

13 
CVMX_SHARED
 
ušt32_t
 
	ghash_d4_mask
 = 0xffffffff;

14 
CVMX_SHARED
 
bcm_6_t
 
	ghash_s6_mask
 = {0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff};

15 
CVMX_SHARED
 
bcm_6_t
 
	ghash_d6_mask
 = {0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff};

29 
šlše
 
ušt8_t
 
	$vÏn_check_hash_üc
(
ušt32_t
 
s
, ušt32_ˆ
d
)

31 
idx
;

33 
	`CVMX_MT_CRC_POLYNOMIAL
 (0x1edc6f41);

34 
	`CVMX_MT_CRC_IV
 (0);

35 
	`CVMX_MT_CRC_WORD
 (
s
);

36 
	`CVMX_MT_CRC_WORD
 (
d
);

37 
	`CVMX_MF_CRC_IV
 (
idx
);

39 
idx
 = 
s
 % 0xFF;

41  (
ušt8_t
)(
idx
 & 0xFF);

42 
	}
}

51 
	$¡©_vÏn_check
(
ušt8_t
 
vid
, 
ušt64_t
 
pÜt
)

53 
	`FRCORE_PORT_VLAN_STAT_INC
(
pÜt
, (
xe0_¡©_vÏn_id_0
 + 
vid
));

54 
	`FRCORE_PORT_VLAN_STAT_INC
(
pÜt
, 
xe0_¡©_vÏn_id_tÙ®
);

55 
	}
}

72 
	$äcÜe_vÏn_check_v4
(
cvmx_wqe_t
 *
wÜk
, 
ušt8_t
 *
‘h_±r
, ušt8_ˆ*
_±r
, 
ušt64_t
 
smac
, ušt64_ˆ
dmac
)

74 
‘h_Ën
;

75 
ušt16_t
 
vÏn_id
, 
vid
;

76 
ušt32_t
 
id_check
;

77 
4_pkt_t
 
4_pkt
;

79 
	`UP32
(
_±r
 + 12, 
4_pkt
.
s_d©a
);

80 
	`UP32
(
_±r
 + 16, 
4_pkt
.
d_d©a
);

82 
	`UP16
(
‘h_±r
 + 14, 
vÏn_id
);

83 
vÏn_id
 &= 0xfff;

84 
‘h_Ën
 = 
wÜk
->
Ën
;

87 
id_check
 = 
	`4_ÿlc_vÏn
(&
4_pkt
, 
vÏn_check_hash_ty³
, 
vÏn_id_num
, 
vÏn_id_¡¬t
);

90 ià(
id_check
 =ğ
vÏn_id
 ) {

91 
vid
 = 
vÏn_id
 - 
vÏn_id_¡¬t
;

92 
	`¡©_vÏn_check
(
vid
, 
wÜk
->
´t
);

94 
	`FRCORE_PORT_VLAN_STAT_INC
(
wÜk
->
´t
, 
xe0_¡©_vÏn_id_”rÜ
);

98  
FRCORE_ACT_FORWARD
;

99 
	}
}

116 
	$äcÜe_vÏn_check_v6
(
cvmx_wqe_t
 *
wÜk
, 
ušt8_t
 *
‘h_±r
, ušt8_ˆ*
_±r
, 
ušt64_t
 
smac
, ušt64_ˆ
dmac
)

118 
rv
;

119 
‘h_Ën
;

120 
ušt16_t
 
vÏn_id
, 
vid
;

121 
ušt16_t
 
id_check
;

122 
v6hdr
 *
hdr
;

123 
6_pkt_t
 
6_pkt
;

125 
	`UP16
(
‘h_±r
 + 14, 
vÏn_id
);

126 
vÏn_id
 &= 0xfff;

127 
‘h_Ën
 = 
wÜk
->
Ën
;

129 
hdr
 = (
v6hdr
 *)
_±r
;

130 
	`memıy
(
6_pkt
.
s6_d©a
, 
hdr
->
§ddr
.
s6_addr
, (
bcm_6_t
));

131 
	`memıy
(
6_pkt
.
d6_d©a
, 
hdr
->
daddr
.
s6_addr
, (
bcm_6_t
));

133 
	`FRCORE_VLAN_CHECK
("IPV6 HDR:\n");

134 
	`FRCORE_VLAN_CHECK
("v”siÚ:%d…riÜ™y:%d\n", 
hdr
->
v”siÚ
, hdr->
´iÜ™y
);

135 
	`FRCORE_VLAN_CHECK
("·ylßd_Ën:%d‚exthdr:%d hİ_lim™:%d\n", 
hdr
->
·ylßd_Ën
, hdr->
Ãxthdr
, hdr->
hİ_lim™
);

136 
	`FRCORE_VLAN_CHECK
("s: %.4x:%.4x:%.4x:%.4x:%.4x:%.4x:%.4x:%.4x\n", 
hdr
->
§ddr
.
s6_addr16
[0],hdr->saddr.s6_addr16[1],

137 
hdr
->
§ddr
.
s6_addr16
[2], hdr->saddr.s6_addr16[3], hdr->saddr.s6_addr16[4],hdr->saddr.s6_addr16[5],

138 
hdr
->
§ddr
.
s6_addr16
[6], hdr->saddr.s6_addr16[7]);

139 
	`FRCORE_VLAN_CHECK
("d: %.4x:%.4x:%.4x:%.4x:%.4x:%.4x:%.4x:%.4x\n", 
hdr
->
daddr
.
s6_addr16
[0],hdr->daddr.s6_addr16[1],

140 
hdr
->
daddr
.
s6_addr16
[2], hdr->daddr.s6_addr16[3], hdr->daddr.s6_addr16[4],hdr->daddr.s6_addr16[5],

141 
hdr
->
daddr
.
s6_addr16
[6], hdr->daddr.s6_addr16[7]);

142 
	`FRCORE_VLAN_CHECK
("ip6_pkt:sip: %.2x%.2x:%.2x%.2x:%.2x%.2x:%.2x%.2x:%.2x%.2x:%.2x%.2x:%.2x%.2x:%.2x%.2x\n",

143 
6_pkt
.
s6_d©a
[0], ip6_pkt.sip6_data[1], ip6_pkt.sip6_data[2], ip6_pkt.sip6_data[3],

144 
6_pkt
.
s6_d©a
[4], ip6_pkt.sip6_data[5], ip6_pkt.sip6_data[6], ip6_pkt.sip6_data[7],

145 
6_pkt
.
s6_d©a
[8], ip6_pkt.sip6_data[9], ip6_pkt.sip6_data[10], ip6_pkt.sip6_data[11],

146 
6_pkt
.
s6_d©a
[12], ip6_pkt.sip6_data[13], ip6_pkt.sip6_data[14], ip6_pkt.sip6_data[15]);

147 
	`FRCORE_VLAN_CHECK
("ip6_pkt:dip: %.2x%.2x:%.2x%.2x:%.2x%.2x:%.2x%.2x:%.2x%.2x:%.2x%.2x:%.2x%.2x:%.2x%.2x\n",

148 
6_pkt
.
d6_d©a
[0], ip6_pkt.dip6_data[1], ip6_pkt.dip6_data[2], ip6_pkt.dip6_data[3],

149 
6_pkt
.
d6_d©a
[4], ip6_pkt.dip6_data[5], ip6_pkt.dip6_data[6], ip6_pkt.dip6_data[7],

150 
6_pkt
.
d6_d©a
[8], ip6_pkt.dip6_data[9], ip6_pkt.dip6_data[10], ip6_pkt.dip6_data[11],

151 
6_pkt
.
d6_d©a
[12], ip6_pkt.dip6_data[13], ip6_pkt.dip6_data[14], ip6_pkt.dip6_data[15]);

153 
id_check
 = 
	`6_ÿlc_vÏn
(&
6_pkt
, 
vÏn_check_hash_ty³
, 
vÏn_id_num
, 
vÏn_id_¡¬t
);

155 ià(
id_check
 =ğ
vÏn_id
 ) {

156 
vid
 = 
vÏn_id
 - 
vÏn_id_¡¬t
;

157 
	`¡©_vÏn_check
(
vid
, 
wÜk
->
´t
);

159 
	`FRCORE_PORT_VLAN_STAT_INC
(
wÜk
->
´t
, 
xe0_¡©_vÏn_id_”rÜ
);

163  
FRCORE_ACT_FORWARD
;

164 
	}
}

167 #ià
FRC_CONFIG_VLAN_IV


168 
	$äcÜe_cmd_vÏn_v4_£t_hash_mask
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

170 
äc_vÏn_hash_mask_t
 *
vÏn_hash_mask
 = (äc_vÏn_hash_mask_ˆ*)
·¿m
;

172 
	`´štf
("IPV4: 0x%x,y³ = %d\n", 
vÏn_hash_mask
->
4
, vÏn_hash_mask->
hash_ty³
);

173 
vÏn_hash_mask
->
hash_ty³
)

175 
FRC_VLAN_CHECK_SIP
:

176 
hash_s4_mask
 = 
vÏn_hash_mask
->
4
;

178 
FRC_VLAN_CHECK_DIP
:

179 
hash_d4_mask
 = 
vÏn_hash_mask
->
4
;

182  
FRE_PARAM
;

185 
	`´štf
("%s.%d\n", 
__func__
, 
__LINE__
);

186  
FRE_SUCCESS
;

187 
	}
}

189 
	$äcÜe_cmd_vÏn_v6_£t_hash_mask
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

191 
i
;

192 
äc_vÏn_hash_mask_t
 *
vÏn_hash_mask
 = (äc_vÏn_hash_mask_ˆ*)
·¿m
;

193 
	`sw­_buff
(16 >> 3, 
vÏn_hash_mask
->
6
);

195 
i
 = 0; i < 16; i++)

197 
	`´štf
("IPV6(%d):0x%x\n", 
i
, 
vÏn_hash_mask
->
6
[i]);

199 
	`´štf
("\n");

200 
vÏn_hash_mask
->
hash_ty³
)

202 
FRC_VLAN_CHECK_SIP
:

203 
	`memıy
(
hash_s6_mask
, 
vÏn_hash_mask
->
6
, 16);

205 
FRC_VLAN_CHECK_DIP
:

206 
	`memıy
(
hash_d6_mask
, 
vÏn_hash_mask
->
6
, 16);

209  
FRE_PARAM
;

212  
FRE_SUCCESS
;

213 
	}
}

233 
	$äcÜe_cmd_vÏn_check_g‘_·¿
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

235 
äc_vÏn_check_·¿_t
 *
vÏn_check_·¿
 = (äc_vÏn_check_·¿_ˆ*)
outbuf
;

236 
vÏn_check_·¿
->
ty³
 = 
vÏn_check_hash_ty³
;

237 
vÏn_check_·¿
->
¡¬t_id
 = 
vÏn_id_¡¬t
;

238 
vÏn_check_·¿
->
num
 = 
vÏn_id_num
;

239 
	`FRCORE_VLAN_CHECK
("===========================================================\n");

240 
	`FRCORE_VLAN_CHECK
("ty³ =%d\n", 
vÏn_check_hash_ty³
);

241 
	`FRCORE_VLAN_CHECK
("¡¬t_id =%d\n", 
vÏn_id_¡¬t
);

242 
	`FRCORE_VLAN_CHECK
("num =%d\n", 
vÏn_id_num
);

244 *
Ş’
 = (
äc_vÏn_check_·¿_t
);

245  
FRE_SUCCESS
;

246 
	}
}

260 
	$äcÜe_cmd_vÏn_check_£t_·¿
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

262 
äc_vÏn_check_·¿_t
 *
vÏn_check_·¿
 = (äc_vÏn_check_·¿_ˆ*)
·¿m
;

263 
vÏn_check_hash_ty³
 = 
vÏn_check_·¿
->
ty³
;

264 
vÏn_id_¡¬t
 = 
vÏn_check_·¿
->
¡¬t_id
;

265 
vÏn_id_num
 = 
vÏn_check_·¿
->
num
;

266 
	`FRCORE_VLAN_CHECK
("===========================================================\n");

267 
	`FRCORE_VLAN_CHECK
("ty³ =%d\n", 
vÏn_check_hash_ty³
);

268 
	`FRCORE_VLAN_CHECK
("¡¬t_id =%d\n", 
vÏn_id_¡¬t
);

269 
	`FRCORE_VLAN_CHECK
("num =%d\n", 
vÏn_id_num
);

271  
FRE_SUCCESS
;

272 
	}
}

274 
	$äcÜe_cmd_vÏn_check_g‘_¡©
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

276 
i
;

277 
äc_vÏn_İ_š_t
 *
šput
 = (äc_vÏn_İ_š_ˆ*è
·¿m
;

278 
ušt64_t
 *
v64p
;

279 
út_off£t
 = 0;

283 ià(0 =ğ
šput
->
pÜt
)

285 
út_off£t
 = 0;

287 ià(16 =ğ
šput
->
pÜt
)

289 
út_off£t
 = 
¡©_vÏn_id_max
 / 2;

291 
v64p
 = 
outbuf
;

292 
i
 = 0; i < 
šput
->
num
; i++, 
v64p
++)

294 *
v64p
 = 
	`FRCORE_VLAN_STAT_VAL
(
šput
->
šdex
 + 
i
 + 
út_off£t
);

297 *
Ş’
 = 
šput
->
num
 * (
ušt64_t
);

300 
	}
}

302 
	$äcÜe_vÏn_check_¡©_ş—r
()

304 
i
;

306 
i
 = 0; i < 
¡©_vÏn_id_max
; i++)

308 
	`FRCORE_VLAN_STAT_CLEAR
(
i
);

310 
	}
}

311 
	$äcÜe_cmd_vÏn_check_ş—r_¡©
(
ušt16_t
 
¶’
, *
·¿m
, ušt16_ˆ*
Ş’
, *
outbuf
)

313 *
Ş’
 = 0;

314 
	`äcÜe_vÏn_check_¡©_ş—r
();

315  
FRE_SUCCESS
;

316 
	}
}

325 
	$äcÜe_vÏn_check_š™
()

327 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_SET_VLAN_CHECK_PARAMETER
, 
äcÜe_cmd_vÏn_check_£t_·¿
);

328 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_GET_VLAN_CHECK_PARAMETER
, 
äcÜe_cmd_vÏn_check_g‘_·¿
);

329 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_GET_VLAN_CHECK_STAT
, 
äcÜe_cmd_vÏn_check_g‘_¡©
);

330 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_CLEAR_VLAN_CHECK_STAT
, 
äcÜe_cmd_vÏn_check_ş—r_¡©
);

331 #ià
FRC_CONFIG_VLAN_IV


332 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_VLAN_V4_HASH_MASK_SET
, 
äcÜe_cmd_vÏn_v4_£t_hash_mask
);

333 
	`FRCORE_REGISTER_CMD
(
CMD_TYPE_USER
, 
USER_CMD_VLAN_V6_HASH_MASK_SET
, 
äcÜe_cmd_vÏn_v6_£t_hash_mask
);

337 
	}
}

	@frcore/frcore_vlan_check.h

1 #iâdeà
_FRCORE_VLAN_CHEKC_H_


2 
	#_FRCORE_VLAN_CHECK_H_


	)

3 
	~"äcÜe_pkt.h
"

4 
	~"äcÜe_¡©.h
"

5 
	~"äc_dma.h
"

6 
	~"äcÜe_´Ùo.h
"

7 
	~"äcÜe_s¢.h
"

8 
	~"äcÜe_s¢_´iv.h
"

9 
	~"äcÜe.h
"

10 
	~"äcÜe_cmd.h
"

11 
	~"äcÜe_misc.h
"

12 
	~"äc_·ck.h
"

13 
	~"äcÜe_´Ùo.h
"

14 
	~"äcÜe_š™.h
"

15 
	~"äc_ty³s.h
"

16 
	~"äcÜe_¡©.h
"

17 
	~"äcÜe_®g.h
"

19 #ià
FRC_CONFIG_VLAN_CHECK


21 
	#FRCORE_VLAN_STAT_INC
(
_út
è
	`cvmx_©omic_add64
((
št64_t
 *)(&
vÏn_id_¡©
[_út]), 1)

	)

22 
	#FRCORE_VLAN_STAT_ADD
(
_út
, 
_v®
è
	`cvmx_©omic_add64
((
št64_t
 *)(&
vÏn_id_¡©
[_út]), _v®)

	)

23 
	#FRCORE_VLAN_STAT_VAL
(
_út
è
	`cvmx_©omic_g‘64
((
št64_t
 *)(&
vÏn_id_¡©
[_út]))

	)

24 
	#FRCORE_VLAN_STAT_CLEAR
(
_út
è
	`cvmx_©omic_£t64
((
št64_t
 *)(&
vÏn_id_¡©
[_út]), 0)

	)

26 
	#FRCORE_PORT_VLAN_STAT_INC
(
_pÜt
, 
_út
è\

	)

27 ià(0 =ğ
_pÜt
) \

29 
FRCORE_VLAN_STAT_INC
(
_út
); \

33 
FRCORE_VLAN_STAT_INC
(
_út
 + (
¡©_vÏn_id_max
 / 2)); \

36 
	#FRCORE_PORT_VLAN_STAT_ADD
(
_pÜt
, 
_út
, 
_v®
è\

	)

37 ià(0 =ğ
_pÜt
) \

39 
FRCORE_VLAN_STAT_ADD
(
_út
, 
_v®
); \

43 
FRCORE_VLAN_STAT_ADD
((
_út
 + (
¡©_vÏn_id_max
 / 2)), 
_v®
); \

47 
äcÜe_vÏn_check_v4
(
cvmx_wqe_t
 *
wÜk
, 
ušt8_t
 *
‘h_±r
, ušt8_ˆ*
_±r
, 
ušt64_t
 
smac
, ušt64_ˆ
dmac
);

48 
äcÜe_vÏn_check_v6
(
cvmx_wqe_t
 *
wÜk
, 
ušt8_t
 *
‘h_±r
, ušt8_ˆ*
_±r
, 
ušt64_t
 
smac
, ušt64_ˆ
dmac
);

49 
äcÜe_vÏn_check_š™
();

	@frctweak/frctweak.c

1 
	~<¡dlib.h
>

2 
	~<¡ršg.h
>

4 
	~"äùw—k.h
"

5 
	~"äc_debug.h
"

6 
	~"äc_­i.h
"

7 
	~"äc_debug.h
"

8 
	~"äc_ty³s.h
"

10 
äùw—k_cmd_t
 *
	gäùw—k_cmd
 = 
NULL
;

11 *
	g´og¿m
;

13 
	$·r£_loİback
(*
¡r
, 
ušt8_t
 *
v®ue
)

15 ià(!
	`¡rÿ£cmp
("lše-phy", 
¡r
))

17 *
v®ue
 = 1;

21 ià(!
	`¡rÿ£cmp
("lše-cÜe", 
¡r
))

23 *
v®ue
 = 2;

27 ià(!
	`¡rÿ£cmp
("ho¡-phy", 
¡r
))

29 *
v®ue
 = 3;

33 ià(!
	`¡rÿ£cmp
("ho¡-cÜe", 
¡r
))

35 *
v®ue
 = 4;

39 ià(!
	`¡rÿ£cmp
("nÜm®", 
¡r
))

41 *
v®ue
 = 0;

45 
	}
}

48 
	$·r£_log
(*
¡r
, 
ušt8_t
 *
v®ue
)

50 ià(!
	`¡rÿ£cmp
(
¡r
, "config"))

52 *
v®ue
 |= 0x1;

56 ià(!
	`¡rÿ£cmp
(
¡r
, "event"))

58 *
v®ue
 |= 0x2;

62 ià(!
	`¡rÿ£cmp
(
¡r
, "debug"))

64 *
v®ue
 |= 0x4;

68 ià(!
	`¡rÿ£cmp
(
¡r
, "error"))

70 *
v®ue
 |= 0x8;

74 ià(!
	`¡rÿ£cmp
(
¡r
, "warning"))

76 *
v®ue
 |= 0x10;

80 ià(!
	`¡rÿ£cmp
(
¡r
, "alarm"))

82 *
v®ue
 |= 0x20;

86 ià(!
	`¡rÿ£cmp
(
¡r
, "all"))

88 *
v®ue
 |= 0x3f;

93 
	}
}

96 
	$ä_u8_¡ršg
(
ušt8_t
 
v®
, 
¡r
[18])

98 
	`mem£t
(
¡r
, 0, 18);

99 
	`¥rštf
(
¡r
, "%d", 
v®
);

100 
	}
}

102 
	$ä_u16_¡ršg
(
ušt16_t
 
v®
, 
¡r
[18])

104 
	`mem£t
(
¡r
, 0, 18);

105 
	`¥rštf
(
¡r
, "%d", 
v®
);

106 
	}
}

108 
	$ä_u32_¡ršg
(
ušt32_t
 
v®
, 
¡r
[18])

110 
	`mem£t
(
¡r
, 0, 18);

111 
	`¥rštf
(
¡r
, "%d", 
v®
);

112 
	}
}

114 
	$ä_´Ùo_¡ršg
(
ušt16_t
 
´Ùo
, 
¡r
[18])

116 
	`mem£t
(
¡r
, 0, 18);

117 ià(0 =ğ
´Ùo
)

119 
	`¥rštf
(
¡r
, "$");

122 ià(6 =ğ
´Ùo
)

124 
	`¥rštf
(
¡r
, "TCP");

127 ià(17 =ğ
´Ùo
)

129 
	`¥rštf
(
¡r
, "UDP");

134 
	`¥rštf
(
¡r
, "?");

137 
	}
}

139 
	$ä_pÜt_¡ršg
(
ušt16_t
 
pÜt
, 
¡r
[18])

141 
	`mem£t
(
¡r
, 0, 18);

142 ià(0 =ğ
pÜt
)

144 
	`¥rštf
(
¡r
, "$");

149 
	`¥rštf
(
¡r
, "%d", 
pÜt
);

152 
	}
}

154 
	$ä_v4_¡ršg
(
ušt32_t
 

, 
¡r
[18])

156 
	`mem£t
(
¡r
, 0, 18);

164 ià(0 =ğ

)

166 
	`¥rštf
(
¡r
, "$");

171 
	`¥rštf
(
¡r
, "%d.%d.%d.%d",

172 (

 >> 24) & 0xff,

173 (

 >> 16) & 0xff,

174 (

 >> 8) & 0xff,

175 

 & 0xff);

177 
	}
}

179 
	$u8_¡ršg
(
ušt8_t
 
v®
, *
¡r
)

181 ià(
NULL
 =ğ
¡r
)

183  
FRE_PARAM
;

186 
	`¥rštf
(
¡r
, "0x%.2X", 
v®
);

188 
	}
}

190 
	$u16_¡ršg
(
ušt16_t
 
v®
, *
¡r
)

192 ià(
NULL
 =ğ
¡r
)

194  
FRE_PARAM
;

197 
	`¥rštf
(
¡r
, "0x%.4X", 
v®
);

199 
	}
}

201 
	$u32_¡ršg
(
ušt32_t
 
v®
, *
¡r
)

203 ià(
NULL
 =ğ
¡r
)

205  
FRE_PARAM
;

208 
	`¥rštf
(
¡r
, "0x%.8X", 
v®
);

210 
	}
}

212 
	$u64_¡ršg
(
ušt64_t
 
v®
, *
¡r
)

214 ià(
NULL
 =ğ
¡r
)

216  
FRE_PARAM
;

219 
	`¥rštf
(
¡r
, "0x%ÎX", 
v®
);

221 
	}
}

223 
	$mac_¡ršg
(
ušt64_t
 
v®
, *
¡r
)

226 *
u8p
 = (*)&
v®
;

227 
	`¥rštf
(
¡r
, "%.2X:%.2X:%.2X:%.2X:%.2X:%.2X",

228 
u8p
[0], u8p[1], u8p[2], u8p[3], u8p[4], u8p[5]);

231 
	}
}

233 
	$·r£_mac64
(*
¡r
, 
ušt64_t
 *
v®
)

235 
rv
 = 0;

236 
i
;

237 
ušt16_t
 
u16
[6] = {};

238 
ušt64_t
 
v®1
 = 0, 
v®2
 = 0;

239 
rv
 = 
	`ssÿnf
(
¡r
, "%hX:%hX:%hX:%hX:%hX:%hX", &
u16
[0], &u16[1],&u16[2], &u16[3],&u16[4], &u16[5]);

240 ià(6 !ğ
rv
)

244 
i
 = 0; i < 3; i++)

246 
v®1
 |ğ((
u16
[
i
] & 0xff) << ( 8 * i));

248 
i
 = 3; i < 6; i++)

250 
v®2
 |ğ((
u16
[
i
] & 0xff) << ( 8 * (i-3)));

252 *
v®
 = (
v®2
 << 24è| 
v®1
;

253 *
v®
 &= 0xffffffffffff;

256 
	}
}

258 
	$·r£_´Ùoÿl
(*
¡r
, 
ušt16_t
 *
´Ùoÿl
)

260 ià(!
	`¡rÿ£cmp
(
¡r
, "TCP"))

262 *
´Ùoÿl
 = 6;

266 ià(!
	`¡rÿ£cmp
(
¡r
, "UDP"))

268 *
´Ùoÿl
 = 17;

271 ià(!
	`¡rÿ£cmp
(
¡r
, "ANY"))

273 *
´Ùoÿl
 = 0;

277 if(!
	`¡rÿ£cmp
(
¡r
, "$"))

279 *
´Ùoÿl
 = 0;

285 
	}
}

287 #ià
FRC_CONFIG_TWO_TUPLE


288 
	$·r£_aş_ty³
(*
¡r
, 
ušt16_t
 *
aş_ty³
)

290 ià(!
	`¡rÿ£cmp
(
¡r
, "SIP"))

292 *
aş_ty³
ğ
FRC_ACL_SIP
;

293  
FRE_SUCCESS
;

295 ià(!
	`¡rÿ£cmp
(
¡r
, "DIP"))

297 *
aş_ty³
 = 
FRC_ACL_DIP
;

298  
FRE_SUCCESS
;

299 }ià(!
	`¡rÿ£cmp
(
¡r
, "SP"))

301 *
aş_ty³
 = 
FRC_ACL_SP
;

302  
FRE_SUCCESS
;

304 if(!
	`¡rÿ£cmp
(
¡r
, "DP"))

306 *
aş_ty³
 = 
FRC_ACL_DP
;

307  
FRE_SUCCESS
;

309 *
aş_ty³
 = 
FRC_ACL_UNKNOWN
;

310  
FRE_FAIL
;

312 
	}
}

315 #ià
FRC_CONFIG_VLAN_CHECK


316 
	$·r£_vÏn_check_ty³
(*
¡r
, 
ušt8_t
 *
ty³
)

318 ià(!
	`¡rÿ£cmp
(
¡r
, "SIP"))

320 *
ty³
ğ
FRC_VLAN_CHECK_SIP
;

321  
FRE_SUCCESS
;

323 ià(!
	`¡rÿ£cmp
(
¡r
, "DIP"))

325 *
ty³
 = 
FRC_VLAN_CHECK_DIP
;

326  
FRE_SUCCESS
;

327 }ià(!
	`¡rÿ£cmp
(
¡r
, "SDIP"))

329 *
ty³
 = 
FRC_VLAN_CHECK_SDIP
;

330  
FRE_SUCCESS
;

332 *
ty³
 = 
FRC_VLAN_CHECK_UNKNOWN
;

333  
FRE_FAIL
;

335 
	}
}

338 
	$·r£_boŞ
(*
¡r
, 
ušt8_t
 *
v®ue
)

340 ià(!
	`¡rÿ£cmp
(
¡r
, "enable"))

342 *
v®ue
 = 1;

345 ià(!
	`¡rÿ£cmp
(
¡r
, "disable"))

347 *
v®ue
 = 0;

350 ià(!
	`¡rÿ£cmp
(
¡r
, "linkup"))

352 *
v®ue
 = 1;

355 ià(!
	`¡rÿ£cmp
(
¡r
, "linkdown"))

357 *
v®ue
 = 0;

360 ià(!
	`¡rÿ£cmp
(
¡r
, "NICMODE"))

362 *
v®ue
 = 1;

365 ià(!
	`¡rÿ£cmp
(
¡r
, "FRMODE"))

367 *
v®ue
 = 0;

372 
	}
}

375 
	$·r£_u32
(*
¡r
, 
ušt32_t
 *
v®ue
)

378 ià(!
	`¡ºÿ£cmp
("0x", 
¡r
, 2))

380 *
v®ue
 = 
	`¡¹oul
(
¡r
, 
NULL
, 16);

384 *
v®ue
 = 
	`¡¹oul
(
¡r
, 
NULL
, 10);

387 ià(
e
 =ğ(
¡r
) || *e != '\0' || *e != '\n') {

393 
	}
}

396 
	$·r£_u64
(*
¡r
, 
ušt64_t
 *
v®ue
)

398 *
e
;

399 ià(!
	`¡ºÿ£cmp
("0x", 
¡r
, 2))

401 *
v®ue
 = 
	`¡¹ouÎ
(
¡r
, &
e
, 16);

405 *
v®ue
 = 
	`¡¹ouÎ
(
¡r
, &
e
, 10);

408 ià(
e
 =ğ(
¡r
) || *e != '\0') {

413 
	}
}

415 
	$·r£_u32_šc
(*
¡r
, 
ušt32_t
 *
v®ue
, ušt32_ˆ*
šc
)

417 *
p
, 
u16s
[10];

419 
	`mem£t
(
u16s
, 0, 10);

420 ià(!
	`¡rcmp
("$", 
¡r
))

422 *
v®ue
 = 0;

423 *
šc
 = 1;

427 
p
 = 
	`¡rchr
(
¡r
, '+');

428 ià(
p
)

430 ià(
	`·r£_u32
((
p
 + 1), 
šc
))

434 
	`memıy
(
u16s
, 
¡r
, 
p
 - str);

438 *
šc
 = 1;

439 
	`memıy
(
u16s
, 
¡r
, 
	`¡¾’
(str));

442 ià(
	`·r£_u32
(
u16s
, 
v®ue
))

449 
	}
}

452 
	$·r£_u16
(*
¡r
, 
ušt16_t
 *
v®ue
)

454 
rv
;

456 
ušt32_t
 
v32
 = 0;

458 
rv
 = 
	`·r£_u32
(
¡r
, &
v32
);

460 ià(
rv
)

465 ià(
v32
 > 0xffff)

469 *
v®ue
 = 
v32
 & 0xffff;

472 
	}
}

476 
	$·r£_u16_šc
(*
¡r
, 
ušt16_t
 *
v®ue
, ušt16_ˆ*
šc
)

478 *
p
, 
u16s
[10];

480 
	`mem£t
(
u16s
, 0, 10);

481 ià(!
	`¡rcmp
("$", 
¡r
))

483 *
v®ue
 = 0;

484 *
šc
 = 1;

488 
p
 = 
	`¡rchr
(
¡r
, '+');

489 ià(
p
)

491 ià(
	`·r£_u16
((
p
 + 1), 
šc
))

495 
	`memıy
(
u16s
, 
¡r
, 
p
 - str);

499 *
šc
 = 1;

500 
	`memıy
(
u16s
, 
¡r
, 
	`¡¾’
(str));

503 ià(
	`·r£_u16
(
u16s
, 
v®ue
))

510 
	}
}

513 
	$·r£_u8
(*
¡r
, 
ušt8_t
 *
v®ue
)

516 
rv
;

518 
ušt32_t
 
v32
 = 0;

520 
rv
 = 
	`·r£_u32
(
¡r
, &
v32
);

522 ià(
rv
)

527 ià(
v32
 > 0xff)

532 *
v®ue
 = 
v32
 & 0xff;

535 
	}
}

538 
	$·r£_v4
(*
¡r
, 
ušt32_t
 *

)

540 
rv
, 
i
;

541 
ušt32_t
 
v
[4];

542 
buf
[32];

543 
	`mem£t
(
buf
, 0, 32);

544 
	`memıy
(
buf
, 
¡r
, 
	`¡¾’
(str));

546 
rv
 = 
	`ssÿnf
(
buf
, "%d.%d.%d.%d", &
v
[0], &ipv[1], &ipv[2], &ipv[3]);

547 if(
rv
 != 4)

552 
i
 = 0; i < 4; i++)

554 if((
v
[
i
] < 0) || (ipv[i] > 255))

560 *

 = (
ušt32_t
)
v
[3];

561 *

 |ğ(
ušt32_t
)
v
[2] << 8;

562 *

 |ğ(
ušt32_t
)
v
[1] << 16;

563 *

 |ğ(
ušt32_t
)
v
[0] << 24;

566 
	}
}

568 
	$·r£_v4_šc
(*
¡r
, 
ušt32_t
 *

, ušt32_ˆ*
šc
)

570 
¡r
[20], *
p
 = 
NULL
;

572 
	`mem£t
(
¡r
, 0, 20);

573 ià(!
	`¡rcmp
("$", 
¡r
))

575 
¡r
 = "0.0.0.0";

577 
p
 = 
	`¡rchr
(
¡r
, '+');

578 ià(
p
)

580 ià(
	`·r£_u32
((
p
 + 1), 
šc
))

584 
	`memıy
(
¡r
, 
¡r
, 
p
 - str);

588 *
šc
 = 1;

589 
	`memıy
(
¡r
, 
¡r
, 
	`¡¾’
(str));

592 ià(
	`·r£_v4
(
¡r
, 

))

598 
	}
}

600 
	$äùw—k_´og¿m_¡ršg
(
äùw—k_cmd_t
 *
cmd
, *
p¡r
)

602 
äùw—k_cmd_t
 *
·»Á
;

603 
t¡r
[
FRCTWEAK_PSTR_SZ
];

605 
	`mem£t
(
t¡r
, 0, 
FRCTWEAK_PSTR_SZ
);

606 
·»Á
 = 
cmd
;

609 
	`¥rštf
(
t¡r
, "%s", 
p¡r
);

610 
	`¥rštf
(
p¡r
, "% %s", 
·»Á
->
Çme
, 
t¡r
);

611 
·»Á
 =…arent->parent;

612 } 
·»Á
);

613 
p¡r
[
FRCTWEAK_PSTR_SZ
 - 1] = 0;

614 
	}
}

616 
	$äùw—k_cmd_u§ge
(
äùw—k_cmd_t
 *
cmd
, 
¬gc
, **
¬gv
)

618 
rv
 = 0;

619 
äc_li¡_t
 *
node
;

620 
äùw—k_cmd_t
 *
chd
;

622 
	`äùw—k_´og¿m_¡ršg
(
cmd
, 
´og¿m
);

624 ià((
¬gc
 > 1è&& !(!
	`¡rcmp
(
¬gv
[1], "?"è|| !
	`¡rÿ£cmp
(argv[1], "-h") || !strcasecmp(argv[1], "help") || !strcasecmp(argv[1], "--help")))

626 
	`´štf
("UnkowÀCOMMAND: %s!\n", 
¬gv
[1]);

627 
rv
 = 1;

632 
	`´štf
("USAGE:\n");

633 
	`´štf
("% (?|-h|-H|h–p|HELP|--h–p|--HELP)\n", 
´og¿m
);

634 ià(
cmd
->
u§ge
)

636 
cmd
->
	`u§ge
();

638 
	`´štf
("\nCOMMAND:\n");

639 
	`äc_li¡_fÜ_—ch
(
node
, 
cmd
->
h—d
) {

640 
chd
 = (
äùw—k_cmd_t
 *)
node
;

641 
	`´štf
("% %s\n", 
´og¿m
, 
chd
->
Çme
);

643 
	`´štf
("\nSUMMARY:\n");

644 
	`äc_li¡_fÜ_—ch
(
node
, 
cmd
->
h—d
) {

645 
chd
 = (
äùw—k_cmd_t
 *)
node
;

646 
	`´štf
(" %-16 --%s\n", 
chd
->
Çme
, chd->
summ¬y
);

649  
rv
;

650 
	}
}

652 
äùw—k_cmd_t
*

653 
	$äùw—k_cmd_»gi¡”
(
äùw—k_cmd_t
 *
·»Á
, *
Çme
, *
summ¬y
, 
äùw—k_â_t
 
â
, 
äùw—k_u§ge_â_t
 
u§ge
)

655 
äùw—k_cmd_t
 *
cmd
;

657 
cmd
 = 
	`m®loc
((
äùw—k_cmd_t
));

658 ià(
cmd
 =ğ
NULL
)

660 
	`FRCTWEAK_ERROR
("Register cmd fail: Can't malloc cmd!\n");

661 
	`ex™
(1);

664 
	`mem£t
(
cmd
, 0, (
äùw—k_cmd_t
));

666 
	`¡rıy
(
cmd
->
Çme
,‚ame);

667 
	`¡rıy
(
cmd
->
summ¬y
, summary);

668 
cmd
->
â
 = fn;

669 
cmd
->
u§ge
 = usage;

671 ià(
·»Á
)

673 ià(!
·»Á
->
h—d
)

675 
·»Á
->
h—d
 = 
	`m®loc
((
äc_li¡_t
));

676 
	`FRC_INIT_LIST_HEAD
(
·»Á
->
h—d
);

678 
	`äc_li¡_add_
(&
cmd
->
node
, 
·»Á
->
h—d
);

679 
cmd
->
·»Á
 =…arent;

683 
cmd
->
·»Á
 = 
NULL
;

686  
cmd
;

687 
	}
}

689 
	$äùw—k_maš_cmd
(
¬gc
, **
¬gv
)

691 
äc_v”siÚ_t
 
v”siÚ
;

693 
	`äùw—k_v”siÚ_g‘
(&
v”siÚ
);

694 
	`´štf
(" FRCTWEAK V%d.%.2d.%d\n", 
v”siÚ
.
majÜ
, v”siÚ.
mšÜ
, v”siÚ.
bud
);

695  
	`äùw—k_cmd_u§ge
(
äùw—k_cmd
, 
¬gc
, 
¬gv
);

696 
	}
}

698 
	$äùw—k_cmd_exec
(
äùw—k_cmd_t
 *
cmd
, 
¬gc
, **
¬gv
)

700 
rv
 = 
FRE_PARAM
;

701 
äc_li¡_t
 *
node
;

702 
äùw—k_cmd_t
 *
chd
;

704 ià(!
	`¡rcmp
(
¬gv
[0], "?"è|| !
	`¡rÿ£cmp
(argv[0], "-h") || !strcasecmp(argv[0], "help") || !strcasecmp(argv[0], "--help"))

706  
	`äùw—k_cmd_u§ge
(
cmd
, 
¬gc
, 
¬gv
);

710 ià(
¬gc
 > 1 && 
cmd
->
h—d
)

712 
	`äc_li¡_fÜ_—ch
(
node
, 
cmd
->
h—d
) {

713 
chd
 = (
äùw—k_cmd_t
 *)
node
;

714 ià(!
	`¡rcmp
(
chd
->
Çme
, 
¬gv
[1]))

716  
	`äùw—k_cmd_exec
(
chd
, --
¬gc
, ++
¬gv
);

721 ià(
cmd
->
â
)

723 
rv
 = 
cmd
->
	`â
(
¬gc
, 
¬gv
);

727 ià(
rv
 =ğ
FRE_PARAM
)

729  
	`äùw—k_cmd_u§ge
(
cmd
, 
¬gc
, 
¬gv
);

733 
	}
}

735 
	$maš
(
¬gc
, **
¬gv
)

737 
»t
;

739 
´og¿m
 = 
	`m®loc
(
FRCTWEAK_PSTR_SZ
);

740 
	`mem£t
(
´og¿m
, 0, 
FRCTWEAK_PSTR_SZ
);

741 
	`memıy
(
´og¿m
, 
¬gv
[0], 10);

743 
äùw—k_cmd
 = 
	`äùw—k_cmd_»gi¡”
(
NULL
, 
¬gv
[0], "Tw—koŞ oàäc", 
äùw—k_maš_cmd
, NULL);

747 
	`äùw—k_‹¡_cmd_š™
(
äùw—k_cmd
);

748 
	`äùw—k_ä_cmd_š™
(
äùw—k_cmd
);

749 
	`äùw—k_ruË_cmd_š™
(
äùw—k_cmd
);

750 
	`äùw—k_bmm_cmd_š™
(
äùw—k_cmd
);

752 
	`äùw—k_¡©_cmd_š™
(
äùw—k_cmd
);

753 
	`äùw—k_´_cmd_š™
(
äùw—k_cmd
);

754 
	`äùw—k_chª_cmd_š™
(
äùw—k_cmd
);

755 
	`äùw—k_fe_cmd_š™
(
äùw—k_cmd
);

756 #ià
FRC_CONFIG_TWO_TUPLE


757 
	`äùw—k_aş_cmd_š™
(
äùw—k_cmd
);

759 #ià
FRC_CONFIG_UDP


760 
	`äùw—k_udp_cmd_š™
(
äùw—k_cmd
);

762 #ià
FRC_CONFIG_VLAN_CHECK


763 
	`äùw—k_vÏn_check_cmd_š™
(
äùw—k_cmd
);

765 #ià
FRC_CONFIG_MAC_STATISTICS


766 
	`äùw—k_mac_¡©_cmd_š™
(
äùw—k_cmd
);

768 #ià
FRC_CONFIG_TIMESTAMP_CHECK


769 
	`äùw—k_time¡amp_check_cmd_š™
(
äùw—k_cmd
);

771 #ià
FRC_CONFIG_IPC


772 
	`äùw—k_c_cmd_š™
(
äùw—k_cmd
);

774 
»t
 = 
	`äùw—k_cmd_exec
(
äùw—k_cmd
, 
¬gc
, 
¬gv
);

776 ià(
»t
 !ğ
FRE_SUCCESS
)

778 
	`FRCTWEAK_DEBUG
("COMMAND: \"%s\"ƒxecu‹ fa: %d!\n", 
¬gv
[0], 
»t
);

786 
	}
}

	@frctweak/frctweak.h

1 #iâdeà
__FRCTWEAK_H__


2 
	#__FRCTWEAK_H__


	)

4 
	~"äc.h
"

5 
	~"äÿpi.h
"

6 
	~"äc_li¡.h
"

8 
	#FRCTWEAK_PSTR_SZ
 256

	)

10 (*
	täùw—k_â_t
è(
	t¬gc
, **
	t¬gv
);

11 (*
	täùw—k_u§ge_â_t
) ();

13 
	säùw—k_cmd_s
 {

14 
äc_li¡_t
 
node
;

15 
äc_li¡_t
 *
h—d
;

16 
äùw—k_cmd_s
 *
·»Á
;

17 
Çme
[128];

18 
summ¬y
[128];

19 
äùw—k_â_t
 
â
;

20 
äùw—k_u§ge_â_t
 
u§ge
;

21 } 
	täùw—k_cmd_t
;

23 
äc_li¡_t
 
äùw—k_cmd_h—d
;

25 
	`·r£_loİback
(*
¡r
, 
ušt8_t
 *
v®ue
);

26 
	`·r£_log
(*
¡r
, 
ušt8_t
 *
v®ue
);

27 
	`ä_u8_¡ršg
(
ušt8_t
 
v®
, 
¡r
[18]);

28 
	`ä_u16_¡ršg
(
ušt16_t
 
v®
, 
¡r
[18]);

29 
	`ä_u32_¡ršg
(
ušt32_t
 
v®
, 
¡r
[18]);

30 
	`ä_´Ùo_¡ršg
(
ušt16_t
 
´Ùo
, 
¡r
[18]);

31 
	`ä_pÜt_¡ršg
(
ušt16_t
 
pÜt
, 
¡r
[18]);

32 
	`ä_v4_¡ršg
(
ušt32_t
 

, 
¡r
[18]);

33 
	`·r£_´Ùoÿl
(*
¡r
, 
ušt16_t
 *
´Ùoÿl
);

34 #ià
FRC_CONFIG_TWO_TUPLE


35 
	`·r£_aş_ty³
(*
¡r
, 
ušt16_t
 *
aş_ty³
);

37 #ià
FRC_CONFIG_VLAN_CHECK


38 
	`·r£_vÏn_check_ty³
(*
¡r
, 
ušt8_t
 *
ty³
);

41 
	`·r£_boŞ
(*
¡r
, 
ušt8_t
 *
v®ue
);

42 
	`·r£_mac64
(*
¡r
, 
ušt64_t
 *
v®
);

43 
	`·r£_u64
(*
¡r
, 
ušt64_t
 *
v®ue
);

44 
	`·r£_u32
(*
¡r
, 
ušt32_t
 *
v®ue
);

45 
	`·r£_u32_šc
(*
¡r
, 
ušt32_t
 *
v®ue
, ušt32_ˆ*
šc
);

46 
	`·r£_u16
(*
¡r
, 
ušt16_t
 *
v®ue
);

47 
	`·r£_u16_šc
(*
¡r
, 
ušt16_t
 *
v®ue
, ušt16_ˆ*
šc
);

48 
	`·r£_u8
(*
¡r
, 
ušt8_t
 *
v®ue
);

49 
	`·r£_v4
(*
¡r
, 
ušt32_t
 *

);

50 
	`·r£_v4_šc
(*
¡r
, 
ušt32_t
 *

, ušt32_ˆ*
šc
);

51 
	`äùw—k_·»Á_¡ršg
(
äùw—k_cmd_t
 *
cmd
, 
p¡r
);

52 
	`u8_¡ršg
(
ušt8_t
 
v®
, *
¡r
);

53 
	`mac_¡ršg
(
ušt64_t
 
v®
, *
¡r
);

54 
	`u64_¡ršg
(
ušt64_t
 
v®
, *
¡r
);

55 
	`u16_¡ršg
(
ušt16_t
 
v®
, *
¡r
);

57 
äùw—k_cmd_t
* 
	`äùw—k_cmd_»gi¡”
(äùw—k_cmd_ˆ*
·»Á
, *
Çme
, *
summ¬y
, 
äùw—k_â_t
 
â
, 
äùw—k_u§ge_â_t
 
u§ge
);

59 
	`äùw—k_misc_cmd_š™
(
äùw—k_cmd_t
 *
cmd
);

60 
	`äùw—k_pÜt_cmd_š™
(
äùw—k_cmd_t
 *
cmd
);

62 
	`äùw—k_‹¡_cmd_š™
(
äùw—k_cmd_t
 *
cmd
);

63 
	`äùw—k_phy_cmd_š™
(
äùw—k_cmd_t
 *
cmd
);

64 
	`äùw—k_chª_cmd_š™
(
äùw—k_cmd_t
 *
cmd
);

65 
	`äùw—k_ä_cmd_š™
(
äùw—k_cmd_t
 *
cmd
);

66 
	`äùw—k_´_cmd_š™
(
äùw—k_cmd_t
 *
cmd
);

67 
	`äùw—k_ruË_cmd_š™
(
äùw—k_cmd_t
 *
cmd
);

68 
	`äùw—k_bmm_cmd_š™
(
äùw—k_cmd_t
 *
cmd
);

69 
	`äùw—k_¡©_cmd_š™
(
äùw—k_cmd_t
 *
cmd
);

70 
	`äùw—k_fe_cmd_š™
(
äùw—k_cmd_t
 *
cmd
);

71 #ià
FRC_CONFIG_TWO_TUPLE


72 
	`äùw—k_aş_cmd_š™
(
äùw—k_cmd_t
 *
cmd
);

74 #ià
FRC_CONFIG_UDP


75 
	`äùw—k_udp_cmd_š™
(
äùw—k_cmd_t
 *
cmd
);

77 #ià
FRC_CONFIG_VLAN_CHECK


78 
	`äùw—k_vÏn_check_cmd_š™
(
äùw—k_cmd_t
 *
cmd
);

80 #ià
FRC_CONFIG_MAC_STATISTICS


81 
	`äùw—k_mac_¡©_cmd_š™
(
äùw—k_cmd_t
 *
cmd
);

83 #ià
FRC_CONFIG_TIMESTAMP_CHECK


84 
	`äùw—k_time¡amp_check_cmd_š™
(
äùw—k_cmd_t
 *
cmd
);

86 #ià
FRC_CONFIG_IPC


87 
	`äùw—k_c_cmd_š™
(
äùw—k_cmd_t
 *
cmd
);

90 
äùw—k_cmd_t
 *
äùw—k_cmd
;

91 *
´og¿m
;

93 #ià
FRC_DEBUG_TWEAK


94 
	#FRCTWEAK_ERROR
(
_fmt
, 
_¬gs
...è
	`´štf
("[ERROR] %s.%d:" _fmt, 
__func__
, 
__LINE__
, ##_¬gs)

	)

95 
	#FRCTWEAK_DEBUG
(
_fmt
, 
_¬gs
...è
	`´štf
("[DEBUG] %s.%d:" _fmt, 
__func__
, 
__LINE__
, ##_¬gs)

	)

97 
	#FRCTWEAK_ERROR
(
_fmt
, 
_¬gs
...)

	)

98 
	#FRCTWEAK_DEBUG
(
_fmt
, 
_¬gs
...)

	)

101 
	`äùw—k_v”siÚ_g‘
(*
±r
);

	@frctweak/frctweak_acl.c

1 
	~<¡dlib.h
>

2 
	~<¡ršg.h
>

4 
	~"äùw—k.h
"

5 
	~"äc_·ck.h
"

6 
	~"äc_dma.h
"

7 
	~"cvmx-sw­.h
"

8 
	~"äc_­i.h
"

9 
	~"äc_debug.h
"

11 #ià
FRC_CONFIG_TWO_TUPLE


14 
	mFRCTWEAK_ACL_STATUS_CMD
,

15 
	mFRCTWEAK_ACL_ADD_CMD
,

16 
	mFRCTWEAK_ACL_DEL_CMD
,

17 
	mFRCTWEAK_ACL_STAT_CLEAR_CMD
,

18 
	mFRCTWEAK_ACL_CLEAR_CMD
,

19 
	mFRCTWEAK_ACL_GET_CMD
,

20 
	mFRCTWEAK_ACL_ENABLE_CMD
,

21 
	mFRCTWEAK_ACL_DISABLE_CMD
,

22 
	mFRCTWEAK_ACL_CNT_CMD
,

23 
	mFRCTWEAK_ACL_UPDATE_CMD
,

24 
	mFRCTWEAK_ACL_Num_GET_CMD
,

25 
	mFRCTWEAK_ACL_MATCH_CMD
,

26 
	mFRCTWEAK_ACL_GET_HASH_TABLE_CMD
,

27 }
	täùw—k_aş_t
;

29 
	$äùw—k_cmd_aş_u§ge
()

31 
	`´štf
("U§ge: % aş SUBCOMMAND OPTION\n",
´og¿m
);

32 
	`´štf
(" % aş stus\n",
´og¿m
);

33 
	`´štf
(" % aşƒÇbË\n",
´og¿m
);

34 
	`´štf
(" % aş di§bË\n",
´og¿m
);

35 
	`´štf
(" % aş‡dd Index Aş_ty³ (SIP|DIP|SP|DPèPROTO\n",
´og¿m
);

36 
	`´štf
(" % aş d– Index Num\n", 
´og¿m
);

37 
	`´štf
(" % aş g‘ Index Num\n", 
´og¿m
);

38 
	`´štf
(" % aş st_ş—¸ Index Num\n", 
´og¿m
);

39 
	`´štf
(" % aş‚um\n", 
´og¿m
);

40 
	`´štf
(" % aş m©ch Aş_ty³ (SIP|DIP|SP|DPèPROTO\n", 
´og¿m
);

41 
	`´štf
(" % aş cÁ Index Num\n", 
´og¿m
);

42 
	`´štf
(" % aş cË¬ \n", 
´og¿m
);

43 
	`´štf
(" % aş hash ", 
´og¿m
);

44 
	`´štf
("\n SUBCOMMAND:\n");

45 
	`´štf
(" status -- Get‡cl module status:(enable|disable).\n");

46 
	`´štf
("ƒnable -- Enable‡cl module.\n");

47 
	`´štf
(" disable -- Disable‡cl module.\n");

48 
	`´štf
("‡dd -- Add one‡cl.\n");

49 
	`´štf
(" del -- Delete‡cl.\n");

50 
	`´štf
(" get -- Get‡cl.\n");

51 
	`´štf
(" stat_clear -- Clear‡cl statistics.\n");

52 
	`´štf
("‚um -- Get‡cl‚um.\n");

53 
	`´štf
(" match -- Match‡cl.\n");

54 
	`´štf
(" cnt -- Printotal statistics of‡cl‚um.\n");

55 
	`´štf
(" clear -- Clear‡ll‡cl.\n");

56 
	`´štf
(" hash -- Get‡cl hashable.\n");

57 
	`´štf
("\n OPTION:\n");

58 
	`´štf
(" Index -- Index, from 1o 2000.\n");

59 
	`´štf
(" Acl_type -- Acl Type,like:SIP DIP SP DP.\n");

60 
	`´štf
(" SIP -- Source IP or ip increment:†ike 1.1.1.0 or 1.1.1.0+100\n");

61 
	`´štf
(" DIP -- Destination IP or ip increment,†ike: 1.1.1.0 or 1.1.1.0+100\n");

62 
	`´štf
(" SP -- TCP/UDP source…ort or…ort increment,†ike: 80 or 80+100\n");

63 
	`´štf
(" DP -- TCP/UDP destination…ort or…ort increment,†ike: 80 or 80+100\n");

64 
	`´štf
(" PROTO -- Protocol,†ike: (TCP|UDP).\n");

65 
	`´štf
(" Num -- Numero del.\n");

66 
	}
}

68 
	$äùw—k_cmd_aş_add_u§ge
()

70 
	`´štf
("USAGE: % aş‡dd Index Aş_ty³ (SIP|DIP|SP|DPèPROTO\n",
´og¿m
);

71 
	`´štf
("\n OPTION:\n");

72 
	`´štf
(" Index -- Index, from 1o 2000.\n");

73 
	`´štf
(" Acl_type -- Acl Type,like:SIP DIP SP DP.\n");

74 
	`´štf
(" SIP -- Source IP or ip increment:†ike 1.1.1.0 or 1.1.1.0+100\n");

75 
	`´štf
(" DIP -- Destination IP or ip increment,†ike: 1.1.1.0 or 1.1.1.0+100\n");

76 
	`´štf
(" SP -- TCP/UDP source…ort or…ort increment,†ike: 80 or 80+100\n");

77 
	`´štf
(" DP -- TCP/UDP destination…ort or…ort increment,†ike: 80 or 80+100\n");

78 
	`´štf
(" PROTO -- Protocol,†ike: (TCP|UDP).\n");

79 
	}
}

82 
	$äùw—k_cmd_aş_d–_u§ge
()

84 
	`´štf
("U§ge: % aş d– Index Num\n",
´og¿m
);

85 
	`´štf
("\n OPTION:\n");

86 
	`´štf
(" Index -- Index, from 1o 2000.\n");

87 
	`´štf
(" Num -- Numero del.\n");

88 
	}
}

90 
	$äùw—k_cmd_aş_g‘_u§ge
()

92 
	`´štf
("U§ge: % aş g‘ Index Num\n",
´og¿m
);

93 
	`´štf
("\n OPTION:\n");

94 
	`´štf
(" Index -- Index, from 1o 2000.\n");

95 
	`´štf
(" Num -- Numero del.\n");

96 
	}
}

98 
	$äùw—k_cmd_aş_hash_bË_g‘_u§ge
()

100 
	`´štf
("U§ge: % aş hash Aş_ty³\n",
´og¿m
);

101 
	`´štf
("\n OPTION:\n");

102 
	`´štf
(" Acl_type -- Acl Type,like:SIP DIP SP DP.\n");

103 
	}
}

105 
	$äùw—k_cmd_aş_¡©_ş—r_u§ge
()

107 
	`´štf
("U§ge: % aş st_ş—¸{Index Num,‡Î}\n",
´og¿m
);

108 
	`´štf
("\n OPTION:\n");

109 
	`´štf
(" Index -- Index, from 1o 2000.\n");

110 
	`´štf
(" Num -- Numero del.\n");

111 
	}
}

114 
	$äùw—k_cmd_aş_út_u§ge
()

116 
	`´štf
("U§ge: % aş cÁ Index Num\n",
´og¿m
);

117 
	`´štf
("\n OPTION:\n");

118 
	`´štf
(" Index -- Index, from 1o 2000.\n");

119 
	`´štf
(" Num -- Numero del.\n");

120 
	}
}

122 
	$äùw—k_cmd_aş_m©ch_u§ge
()

124 
	`´štf
("USAGE: % aş m©ch Aş_ty³ (SIP|DIP|SP|DPèPROTO\n",
´og¿m
);

125 
	`´štf
("\n OPTION:\n");

126 
	`´štf
(" Acl_type -- Acl Type,like:SIP DIP SP DP.\n");

127 
	`´štf
(" SIP -- Source IP or ip increment:†ike 1.1.1.0 or 1.1.1.0+100\n");

128 
	`´štf
(" DIP -- Destination IP or ip increment,†ike: 1.1.1.0 or 1.1.1.0+100\n");

129 
	`´štf
(" SP -- TCP/UDP source…ort or…ort increment,†ike: 80 or 80+100\n");

130 
	`´štf
(" DP -- TCP/UDP destination…ort or…ort increment,†ike: 80 or 80+100\n");

131 
	`´štf
(" PROTO -- Protocol,†ike: (TCP|UDP.\n");

132 
	}
}

135 
	$äùw—k_cmd_aş
(
¬gc
, **
¬gv
)

137 
rv
;

138 
İ
;

139 
ušt8_t
 
’abË
;

140 
äc_aş_t
 
aş
[
ACL_MAX
];

141 
äc_aş_¡©_t
 
aş_¡©
[
ACL_MAX
];

142 
äc_aş_İ_š_t
 
šput
;

143 
äc_aş_hash_bË_İ_š_t
 
hash_šput
;

144 
äc_aş_hash_bË_¡©_out_t
 
hash_out
;

145 
äc_aş_pkt_¡©_t
 
út
;

146 
äc_aş_¡©_out_t
 
¡©_out
;

148 
i
, 
j
, 
k
;

149 
ušt32_t
 
Úe_tu¶e
, 
šc
;

150 
ušt32_t
 
cur
 = 0;

151 
ušt8_t
 
aş_sourû
 = 0, 
aùiÚ
 = 0, 
aş_İ
 = 0;

152 
ušt16_t
 
aş_ty³
 = 0;

153 
ušt16_t
 
šdex
, 
´Ùo
;

154 
¡r_s
[18], 
¡r_d
[18], 
¡r_¥
[18], 
¡r_dp
[18], 
¡r_´Ùo
[18];

155 
ušt16_t
 
ş—r_num
, 
aş_num
, 
m©ch_num
 = 0;

156 
ušt16_t
 
num
 = 0;

157 
buf
[(
äc_aş_¡©_out_t
)], *
p
;

158 
ušt16_t
 
hash_num
 = 0;

160 
	`mem£t
(
aş
, 0, (
äc_aş_t
));

161 
	`mem£t
(&
aş_¡©
, 0 , (
äc_aş_¡©_t
));

162 
	`mem£t
(&
šput
, 0, (
äc_aş_İ_š_t
));

163 
	`mem£t
(&
út
, 0, (
äc_aş_pkt_¡©_t
));

164 
	`mem£t
(&
¡©_out
, 0, (
äc_aş_¡©_out_t
));

168 ià(
¬gc
 < 2)

170 
	`äùw—k_cmd_aş_u§ge
();

171  
FRE_SUCCESS
;

174 ià(!(
	`¡rcmp
("¡©us", 
¬gv
[1])))

176 
İ
 = 
FRCTWEAK_ACL_STATUS_CMD
;

179 ià(!(
	`¡rcmp
("add", 
¬gv
[1])))

181 
İ
 = 
FRCTWEAK_ACL_ADD_CMD
;

184 ià(!(
	`¡rcmp
("d–", 
¬gv
[1])))

186 
İ
 = 
FRCTWEAK_ACL_DEL_CMD
;

189 ià(!(
	`¡rcmp
("¡©_ş—r", 
¬gv
[1])))

191 
İ
 = 
FRCTWEAK_ACL_STAT_CLEAR_CMD
;

194 ià(!(
	`¡rcmp
("ş—r", 
¬gv
[1])))

196 
İ
 = 
FRCTWEAK_ACL_CLEAR_CMD
;

199 ià(!(
	`¡rcmp
("g‘", 
¬gv
[1])))

201 
İ
 = 
FRCTWEAK_ACL_GET_CMD
;

204 ià(!
	`¡rcmp
("’abË", 
¬gv
[1]))

206 
İ
 = 
FRCTWEAK_ACL_ENABLE_CMD
;

209 ià(!
	`¡rcmp
("di§bË", 
¬gv
[1]))

211 
İ
 = 
FRCTWEAK_ACL_DISABLE_CMD
;

213 ià(!
	`¡rcmp
("út", 
¬gv
[1]))

215 
İ
 = 
FRCTWEAK_ACL_CNT_CMD
;

217 ià(!
	`¡rcmp
("num", 
¬gv
[1]))

219 
İ
 = 
FRCTWEAK_ACL_Num_GET_CMD
;

221 ià(!
	`¡rcmp
("m©ch", 
¬gv
[1]))

223 
İ
 = 
FRCTWEAK_ACL_MATCH_CMD
;

225 ià(!
	`¡rcmp
("hash", 
¬gv
[1]))

227 
İ
 = 
FRCTWEAK_ACL_GET_HASH_TABLE_CMD
;

231 
	`äùw—k_cmd_aş_u§ge
();

235 
İ
)

237 
FRCTWEAK_ACL_STATUS_CMD
:

238 
rv
 = 
	`äÿpi_aş_¡©us_g‘
(&
’abË
);

239 
	`´štf
("ACL funùiÚ stus: %s\n", 
’abË
?"enable":"disable");

241 
FRCTWEAK_ACL_ADD_CMD
:

242 ià(
¬gc
 < 6 ||‡rgc > 9)

244 
	`äùw—k_cmd_aş_add_u§ge
();

245  
FRE_SUCCESS
;

248 
	`ssÿnf
(
¬gv
[2], "%hu", &
šdex
);

249 ià(
šdex
 < 
ACL_INDEX_START
 || index > 
ACL_MAX
)

251 
	`FRCTWEAK_ERROR
("Invalid‡cl index!");

252  
FRE_PARAM
;

255 ià(
	`·r£_aş_ty³
(
¬gv
[3], &
aş_ty³
))

257 
	`FRCTWEAK_ERROR
("Invalid‡clype!");

258  
FRE_PARAM
;

261 ià(
aş_ty³
 =ğ
FRC_ACL_SIP
 ||‡ş_ty³ =ğ
FRC_ACL_DIP
)

263 ià(
	`·r£_v4_šc
(
¬gv
[4], &
Úe_tu¶e
, &
šc
))

265 
	`FRCTWEAK_ERROR
("Invalid‡cl one_typle!");

266  
FRE_PARAM
;

268 } ià(
aş_ty³
 =ğ
FRC_ACL_SP
 ||‡ş_ty³ =ğ
FRC_ACL_DP
)

270 ià(
	`·r£_u32_šc
(
¬gv
[4], &
Úe_tu¶e
, &
šc
))

272 
	`FRCTWEAK_ERROR
("Invalid‡cl one_typle!");

273  
FRE_PARAM
;

276  
FRE_PARAM
;

279 ià(
	`·r£_´Ùoÿl
(
¬gv
[5], &
´Ùo
))

281  
FRE_PARAM
;

284 ià(9 =ğ
¬gc
)

286 ià(
	`·r£_u8
(
¬gv
[6], &
aş_sourû
))

288  
FRE_PARAM
;

291 ià(
	`·r£_u8
(
¬gv
[7], &
aùiÚ
))

293  
FRE_PARAM
;

296 ià(
	`·r£_u8
(
¬gv
[8], &
aş_İ
))

298  
FRE_PARAM
;

302 
aş
[
cur
].
Úe_tu¶e
 = one_tuple;

303 
aş
[
cur
].
´Ùo
 =…roto;

304 
aş
[
cur
].
aş_sourû
 =‡cl_source;

305 
aş
[
cur
].
aş_ty³
 =‡cl_type;

306 
aş
[
cur
].
aùiÚ
 =‡ction;

307 
aş
[
cur
].
İ
 = 
aş_İ
;

308 
aş
[
cur
].
šdex
 = index;

309 
i
 = 0; i < 
šc
; i++)

311 
rv
 = 
	`äÿpi_aş_add
(&
aş
[
cur
]);

312 
aş
[
cur
].
Úe_tu¶e
 ++ ;

313 
aş
[
cur
].
šdex
 ++;

316 
FRCTWEAK_ACL_DEL_CMD
:

317 ià(
¬gc
 < 4)

319 
	`äùw—k_cmd_aş_d–_u§ge
();

320  
FRE_SUCCESS
;

322 
	`ssÿnf
(
¬gv
[2], "%d", &
šput
.
šdex
);

323 ià(
šput
.
šdex
 < 
ACL_INDEX_START
 || iÅut.šdex > 
ACL_MAX
)

325 
	`FRCTWEAK_ERROR
("Invalid‡cl index!");

326  
FRE_PARAM
;

329 
	`ssÿnf
(
¬gv
[3], "%d", &
šput
.
num
);

330 ià(
šput
.
num
 < 
ACL_INDEX_START
 || iÅut.num > 
ACL_MAX
)

332 
	`FRCTWEAK_ERROR
("Invalid‡cl‚umber!");

333  
FRE_PARAM
;

336 ià(
šput
.
šdex
 + iÅut.
num
 > 
ACL_MAX
 + 
ACL_INDEX_START
)

338  
FRE_PARAM
;

340 
rv
 = 
	`äÿpi_aş_d–
(&
šput
, (
ušt16_t
 *)&šput.
num
);

342 
FRCTWEAK_ACL_STAT_CLEAR_CMD
:

343 ià((
¬gc
 < 3) || (argc > 4))

345 
	`äùw—k_cmd_aş_¡©_ş—r_u§ge
();

346  
FRE_SUCCESS
;

348 ià(4 =ğ
¬gc
)

350 
	`ssÿnf
(
¬gv
[2], "%d", &
šput
.
šdex
);

351 ià(
šput
.
šdex
 < 
ACL_INDEX_START
 || iÅut.šdex > (
ACL_MAX
))

353 
	`FRCTWEAK_ERROR
("Invalid‡cl index!");

354  
FRE_PARAM
;

356 ià(
¬gc
 < 4)

358 
	`äùw—k_cmd_aş_u§ge
();

359  
FRE_PARAM
;

361 
	`ssÿnf
(
¬gv
[3], "%d", &
šput
.
num
);

362 ià(
šput
.
num
 < 
ACL_INDEX_START
 || iÅut.num > 
ACL_MAX
)

364 
	`FRCTWEAK_ERROR
("Invalid‡cl‚umber!");

365  
FRE_PARAM
;

368 ià(
šput
.
šdex
 + iÅut.
num
 > 
ACL_MAX
 + 
ACL_INDEX_START
)

370  
FRE_PARAM
;

374 ià(3 =ğ
¬gc
)

376 ià(
	`¡rcmp
("®l", 
¬gv
[2]))

378  
FRE_PARAM
;

381 
šput
.
šdex
 = 
ACL_INDEX_START
;

382 
šput
.
num
 = 
ACL_MAX
;

385 
rv
 = 
	`äÿpi_aş_¡©_ş—r
(&
šput
, &
ş—r_num
);

386 ià(
rv
 !ğ
FRE_SUCCESS
)

388 
	`FRCTWEAK_ERROR
("Clearing uphe statistics of‡cls failed!\n");

391 
FRCTWEAK_ACL_CLEAR_CMD
:

392 
šput
.
šdex
 = 
ACL_INDEX_START
;

393 
šput
.
num
 = 
ACL_MAX
;

394 
rv
 = 
	`äÿpi_aş_ş—r
(&
šput
, &
ş—r_num
);

395 ià(
rv
 !ğ
FRE_SUCCESS
)

397 
	`FRCTWEAK_ERROR
("Clearing up‡cls failed\n");

400 
FRCTWEAK_ACL_GET_CMD
:

401 ià(
¬gc
 < 4)

403 
	`äùw—k_cmd_aş_g‘_u§ge
();

404  
FRE_SUCCESS
;

406 
	`ssÿnf
(
¬gv
[2], "%d", &
šput
.
šdex
);

407 ià(
šput
.
šdex
 < 
ACL_INDEX_START
 || iÅut.šdex > 
ACL_MAX
)

409 
	`FRCTWEAK_ERROR
("Invalid‡cl index!");

410  
FRE_PARAM
;

412 
	`ssÿnf
(
¬gv
[3], "%d", &
šput
.
num
);

413 ià(
šput
.
num
 < 
ACL_INDEX_START
 || iÅut.num > 
ACL_MAX
)

415 
	`FRCTWEAK_ERROR
("Invalid‡cl‚umber!");

416  
FRE_PARAM
;

419 ià(
šput
.
šdex
 + iÅut.
num
 > (
ACL_MAX
+
ACL_INDEX_START
))

421  
FRE_PARAM
;

423 
šdex
 = 
šput
.index;

424 
aş_num
 = 
šput
.
num
;

425 
num
 = 
šput
.num / 
MAX_ACL
;

426 ià(
šput
.
num
%
MAX_ACL
)

428 
num
 +=1;

430 
	`´štf
("%-6s %-18s %-18s %-6s %-6s %-6s %-8s %-8s %-6s %-8s %-6s %-8s %-4s\n",

433 
j
 = 0; j < 
num
; j++)

435 
p
 = 
buf
;

436 ià(
j
 =ğ
num
-1)

438 ià(
aş_num
%
MAX_ACL
)

440 
šput
.
num
 = 
aş_num
 % 
MAX_ACL
;

442 
šput
.
num
 = 
MAX_ACL
;

446 
šput
.
num
 = 
MAX_ACL
;

449 
šput
.
šdex
 = index + 
j
 * 
MAX_ACL
;

450 
rv
 = 
	`äÿpi_aş_¡©_g‘
(&
šput
, (
äc_aş_¡©_out_t
 *)
buf
);

451 
	`UNPACK_U32
(
p
, 
¡©_out
.
num
);

453 
i
 =0; i < 
¡©_out
.
num
;i++)

455 
p
 = 
	`äc_aş_¡©_uÅack
Õ, &
¡©_out
.
aş_¡©
[
i
]);

456 ià(
¡©_out
.
aş_¡©
[
i
].
aş
.
aş_ty³
 =ğ
FRC_ACL_SIP
)

458 
	`ä_v4_¡ršg
(
¡©_out
.
aş_¡©
[
i
].
aş
.
Úe_tu¶e
, 
¡r_s
);

459 
	`ä_v4_¡ršg
(0, 
¡r_d
);

460 
	`ä_pÜt_¡ršg
(0, 
¡r_¥
);

461 
	`ä_pÜt_¡ršg
(0, 
¡r_dp
);

462 }ià(
¡©_out
.
aş_¡©
[
i
].
aş
.
aş_ty³
 =ğ
FRC_ACL_DIP
)

464 
	`ä_v4_¡ršg
(0, 
¡r_s
);

465 
	`ä_v4_¡ršg
(
¡©_out
.
aş_¡©
[
i
].
aş
.
Úe_tu¶e
, 
¡r_d
);

466 
	`ä_pÜt_¡ršg
(0, 
¡r_¥
);

467 
	`ä_pÜt_¡ršg
(0, 
¡r_dp
);

468 }ià(
¡©_out
.
aş_¡©
[
i
].
aş
.
aş_ty³
 =ğ
FRC_ACL_SP
)

470 
	`ä_v4_¡ršg
(0, 
¡r_s
);

471 
	`ä_v4_¡ršg
(0, 
¡r_d
);

472 
	`ä_pÜt_¡ršg
(
¡©_out
.
aş_¡©
[
i
].
aş
.
Úe_tu¶e
, 
¡r_¥
);

473 
	`ä_pÜt_¡ršg
(0, 
¡r_dp
);

474 }ià(
¡©_out
.
aş_¡©
[
i
].
aş
.
aş_ty³
 =ğ
FRC_ACL_DP
)

476 
	`ä_v4_¡ršg
(0, 
¡r_s
);

477 
	`ä_v4_¡ršg
(0, 
¡r_d
);

478 
	`ä_pÜt_¡ršg
(0, 
¡r_¥
);

479 
	`ä_pÜt_¡ršg
(
¡©_out
.
aş_¡©
[
i
].
aş
.
Úe_tu¶e
, 
¡r_dp
);

481 
	`ä_´Ùo_¡ršg
(
¡©_out
.
aş_¡©
[
i
].
aş
.
´Ùo
, 
¡r_´Ùo
);

482 
	`´štf
("%-6d %-18s %-18s %-6s %-6s %-6s %-8d %-8d %-6d %-8d %-6d %-8d %-4d\n",

483 
¡©_out
.
aş_¡©
[
i
].
aş
.
šdex
, 
¡r_s
, 
¡r_d
, 
¡r_¥
, 
¡r_dp
, 
¡r_´Ùo
,

484 
¡©_out
.
aş_¡©
[
i
].
¡©
.
pkts
, st_out.aş_¡©[i].¡©.
by‹s
,

485 
¡©_out
.
aş_¡©
[
i
].
aş
.
hash
, st_out.aş_¡©[i].aş.
aş_sourû
,

486 
¡©_out
.
aş_¡©
[
i
].
aş
.
aş_ty³
, st_out.aş_¡©[i].aş.
aùiÚ
,

487 
¡©_out
.
aş_¡©
[
i
].
aş
.
İ
);

491 
FRCTWEAK_ACL_ENABLE_CMD
:

492 
FRCTWEAK_ACL_DISABLE_CMD
:

493 ià(
	`·r£_boŞ
(
¬gv
[1], &
’abË
))

495  
FRE_PARAM
;

498 
rv
 = 
	`äÿpi_aş_’abË
(
’abË
);

500 
FRCTWEAK_ACL_CNT_CMD
:

501 ià(
¬gc
 < 4)

503 
	`äùw—k_cmd_aş_út_u§ge
();

504  
FRE_SUCCESS
;

506 
	`ssÿnf
(
¬gv
[2], "%d", &
šput
.
šdex
);

507 ià(
šput
.
šdex
 < 
ACL_INDEX_START
 || iÅut.šdex > 
ACL_MAX
)

509 
	`FRCTWEAK_ERROR
("Invalid‡cl index!");

510  
FRE_PARAM
;

513 
	`ssÿnf
(
¬gv
[3], "%d", &
šput
.
num
);

514 ià(
šput
.
num
 < 
ACL_INDEX_START
 || iÅut.num > 
ACL_MAX
)

516 
	`FRCTWEAK_ERROR
("Invalid‡cl‚umber!");

517  
FRE_PARAM
;

520 ià(
šput
.
šdex
 + iÅut.
num
 > 
ACL_MAX
 + 
ACL_INDEX_START
)

522  
FRE_PARAM
;

525 
šdex
 = 
šput
.index;

526 
aş_num
 = 
šput
.
num
;

527 
num
 = 
šput
.num / 
MAX_ACL
;

528 ià(
šput
.
num
%
MAX_ACL
)

530 
num
 +=1;

532 
j
 = 0; j < 
num
; j++)

534 
p
 = 
buf
;

535 ià(
j
 =ğ
num
-1)

537 ià(
aş_num
%
MAX_ACL
)

539 
šput
.
num
 = 
aş_num
 % 
MAX_ACL
;

541 
šput
.
num
 = 
MAX_ACL
;

545 
šput
.
num
 = 
MAX_ACL
;

548 
šput
.
šdex
 = index + 
j
 * 
MAX_ACL
;

549 
rv
 = 
	`äÿpi_aş_¡©_g‘
(&
šput
, (
äc_aş_¡©_out_t
 *)
buf
);

550 
	`UNPACK_U32
(
p
, 
¡©_out
.
num
);

553 
i
 =0; i < 
¡©_out
.
num
;i++)

555 
p
 = 
	`äc_aş_¡©_uÅack
Õ, &
¡©_out
.
aş_¡©
[
i
]);

556 
út
.
pkts
 +ğ
¡©_out
.
aş_¡©
[
i
].
¡©
.pkts;

557 
út
.
by‹s
 +ğ
¡©_out
.
aş_¡©
[
i
].
¡©
.bytes;

562 
	`´štf
("sum_pkts: %d\n", 
út
.
pkts
);

563 
	`´štf
("sum_by‹s: %d\n", 
út
.
by‹s
);

565 
FRCTWEAK_ACL_Num_GET_CMD
:

566 
rv
 = 
	`äÿpi_aş_num_g‘
(&
aş_num
);

567 
	`´štf
("Cu¼’ˆaşs: %d\n", 
aş_num
);

569 
FRCTWEAK_ACL_MATCH_CMD
:

570 ià(
¬gc
 < 5)

572 
	`äùw—k_cmd_aş_m©ch_u§ge
();

573  
FRE_SUCCESS
;

576 ià(
	`·r£_aş_ty³
(
¬gv
[2], &
aş_ty³
))

578 
	`FRCTWEAK_ERROR
("Invalid‡clype!");

579  
FRE_PARAM
;

582 ià(
aş_ty³
 =ğ
FRC_ACL_SIP
 ||‡ş_ty³ =ğ
FRC_ACL_DIP
)

584 ià(
	`·r£_v4_šc
(
¬gv
[3], &
Úe_tu¶e
, &
šc
))

586 
	`FRCTWEAK_ERROR
("Invalid‡cl one_typle!");

587  
FRE_PARAM
;

589 } ià(
aş_ty³
 =ğ
FRC_ACL_SP
 ||‡ş_ty³ =ğ
FRC_ACL_DP
)

591 ià(
	`·r£_u32_šc
(
¬gv
[3], &
Úe_tu¶e
, &
šc
))

593 
	`FRCTWEAK_ERROR
("Invalid‡cl one_typle!");

594  
FRE_PARAM
;

597  
FRE_PARAM
;

600 ià(
	`·r£_´Ùoÿl
(
¬gv
[4], &
´Ùo
))

602  
FRE_PARAM
;

605 
aş_num
 = 
ACL_MAX
;

607 
k
=0;

608 
šput
.
šdex
 = 
ACL_INDEX_START
;

609 
šput
.
num
 = 
aş_num
;

610 
šdex
 = 
šput
.index;

611 
num
 = 
šput
.num / 
MAX_ACL
;

612 ià(
šput
.
num
%
MAX_ACL
)

614 
num
 +=1;

616 
j
 = 0; j < 
num
; j++)

618 
p
 = 
buf
;

619 ià(
j
 =ğ
num
-1)

621 ià(
aş_num
%
MAX_ACL
)

623 
šput
.
num
 = 
aş_num
 % 
MAX_ACL
;

625 
šput
.
num
 = 
MAX_ACL
;

629 
šput
.
num
 = 
MAX_ACL
;

632 
šput
.
šdex
 = index + 
j
 * 
MAX_ACL
;

633 
rv
 = 
	`äÿpi_aş_¡©_g‘
(&
šput
, (
äc_aş_¡©_out_t
 *)
buf
);

634 
	`UNPACK_U32
(
p
, 
¡©_out
.
num
);

637 
i
 =0; i < 
¡©_out
.
num
;i++)

639 
p
 = 
	`äc_aş_¡©_uÅack
Õ, &
¡©_out
.
aş_¡©
[
i
]);

640 
	`memıy
(&
aş_¡©
[
k
], &
¡©_out
.aş_¡©[
i
], (
äc_aş_¡©_t
));

641 
k
 ++;

646 
aş
[
cur
].
Úe_tu¶e
 = one_tuple;

647 
aş
[
cur
].
´Ùo
 =…roto;

649 
	`´štf
("Úe_tu¶ğ%d\n", 
aş
[
cur
].
Úe_tu¶e
);

650 
	`´štf
("´ÙØğ%d,Ù® = %d\n", 
aş
[
cur
].
´Ùo
, 
tÙ®
);

653 
i
 = 0; i < 
šc
; i++)

655 
rv
 = 
	`äÿpi_aş_m©ch
(
aş_¡©
, &
aş
[
cur
], 
aş_num
, &
m©ch_num
);

656 
aş
[
cur
].
Úe_tu¶e
 ++;

659 
	`´štf
("m©ched: %d\n", 
m©ch_num
);

661 
FRCTWEAK_ACL_GET_HASH_TABLE_CMD
:

662 ià(
¬gc
 < 3)

664 
	`äùw—k_cmd_aş_hash_bË_g‘_u§ge
();

665  
FRE_SUCCESS
;

668 ià(
	`·r£_aş_ty³
(
¬gv
[2], &
aş_ty³
))

670 
	`FRCTWEAK_ERROR
("Invalid‡clype!");

671  
FRE_PARAM
;

673 
hash_šput
.
aş_ty³
 =‡cl_type;

674 
hash_šput
.
šdex
 = 
ACL_INDEX_START
 - 1;

675 
hash_šput
.
num
 = 
ACL_HASH_MAX
;

677 
šdex
 = 
hash_šput
.index;

678 
aş_num
 = 
hash_šput
.
num
;

679 
num
 = 
hash_šput
.num / 
MAX_ACL
;

680 ià(
hash_šput
.
num
%
MAX_ACL
)

682 
num
 +=1;

684 
	`´štf
("%-6s %-18s %-18s %-18s\n", "Index","BucketDepth", "TotalCell", "DelCell");

685 
j
 = 0; j < 
num
; j++)

687 
p
 = 
buf
;

688 ià(
j
 =ğ
num
-1)

690 ià(
aş_num
%
MAX_ACL
)

692 
hash_šput
.
num
 = 
aş_num
 % 
MAX_ACL
;

694 
hash_šput
.
num
 = 
MAX_ACL
;

698 
hash_šput
.
num
 = 
MAX_ACL
;

701 
hash_šput
.
šdex
 = index + 
j
 * 
MAX_ACL
;

702 
rv
 = 
	`äÿpi_aş_hash_bË_¡©_g‘
(&
hash_šput
, &
hash_out
);

703 
	`sw­_buff
((
äc_aş_hash_bË_¡©_out_t
)>>3, (*)&
hash_out
);

704 
i
 =0; i < 
hash_out
.
num
;i++)

706 
	`´štf
("%-6d %-18d %-18d %-18d\n", 
hash_out
.
aş_hash_¡©
[
i
].
hash
,

707 
hash_out
.
aş_hash_¡©
[
i
].
buck‘_d•th
, hash_out.aş_hash_¡©[i].
tÙ®_ûÎ
,

708 
hash_out
.
aş_hash_¡©
[
i
].
d–_ûÎ
);

709 
hash_num
 +ğ
hash_out
.
aş_hash_¡©
[
i
].
buck‘_d•th
;

712 
	`´štf
("aş hash‚um:%d\n", 
hash_num
);

715  
FRE_PARAM
;

718  
rv
;

720 
	}
}

722 
	$äùw—k_aş_cmd_š™
(
äùw—k_cmd_t
 *
cmd
)

724 
	`äùw—k_cmd_»gi¡”
(
cmd
, "aş", "G‘ o¸£ˆfÜ‡ş moduË", 
äùw—k_cmd_aş
, 
äùw—k_cmd_aş_u§ge
);

728 
	}
}

	@frctweak/frctweak_arg_parser.c

1 
	~<¡dlib.h
>

2 
	~<¡ršg.h
>

4 
	~"äc_ty³s.h
"

5 
	~"äùw—k_¬g_·r£r.h
"

7 
	$äùw—k_¬g_·r£r_š™
(
¬g_·r£r_t
 *
·r£r
)

9 ià(
NULL
 =ğ
·r£r
)

11  
FRE_PARAM
;

14 
	`mem£t
(
·r£r
, 0, (
¬g_·r£r_t
));

16  
FRE_SUCCESS
;

17 
	}
}

19 
äùw—k_¬g_·r£r_add
(
¬g_·r£r_t
 *
·r£r
, *
key
, (*
func
), * 
v¬
)

21 
¬g_·r£r_’Œy_t
 *
	g’Œy
 = 
NULL
;

23 ià((
	g·r£r
 =ğ
NULL
è|| (NULL =ğ
key
è|| (NULL =ğ
v¬
))

25  
FRE_PARAM
;

28 ià(
¡¾’
(
key
è> 
	gARG_PARSER_KEY_MAX
)

30  
	gFRE_PARAM
;

33 
	g’Œy
 = 
m®loc
((
¬g_·r£r_’Œy_t
));

35 ià(
	gNULL
 =ğ
’Œy
)

37  
FRE_MEMORY
;

40 
mem£t
(
’Œy
, 0, (
¬g_·r£r_’Œy_t
));

42 
	g’Œy
->
	gkey
 = 
¡rdup
(
key
);

43 
	g’Œy
->
	gfunc
 =(*è
func
;

44 
	g’Œy
->
	gv¬
 = 
v¬
;

45 
	g’Œy
->
	gÃxt
 = 
NULL
;

47 ià(
	gNULL
 =ğ
·r£r
->
h—d
)

49 
·r£r
->
h—d
 = 
’Œy
;

53 
	g·r£r
->
	g
->
	gÃxt
 = 
’Œy
;

55 
	g·r£r
->
	g
 = 
’Œy
;

58  
	gFRE_SUCCESS
;

61 
¬g_·r£r_’Œy_t
 *

62 
	$äùw—k_¬g_·r£r_’Œy_lookup
(
¬g_·r£r_t
 *
·r£r
, *
key
)

64 
¬g_·r£r_’Œy_t
 *
’Œy
 = 
NULL
;

66 ià(
NULL
 =ğ
·r£r
)

68 
	`´štf
("%s.%d\n", 
__func__
, 
__LINE__
);

69  
NULL
;

72 
’Œy
 = 
·r£r
->
h—d
;

76 ià(!
	`¡rÿ£cmp
(
key
, 
’Œy
->key))

78  
’Œy
;

80 
’Œy
 =ƒÁry->
Ãxt
;

81 }
’Œy
);

83  
NULL
;

84 
	}
}

87 
	$äùw—k_¬g_·rsšg
(
¬g_·r£r_t
 *
·r£r
, 
¬gc
, **
¬gv
)

89 
i
;

90 
rv
;

91 *
vp
 = 
NULL
;

92 *
•
 = 
NULL
;

93 
key
[
ARG_PARSER_KEY_MAX
];

95 
¬g_·r£r_’Œy_t
 *
’Œy
 = 
NULL
;

97 
i
 = 0; i < 
¬gc
; i++)

99 
key_sz
 = 0;

100 
	`´štf
("¬gv[%d] = %s\n", 
i
, 
¬gv
[i]);

101 
•
 = 
	`¡rchr
(
¬gv
[
i
], '=');

103 ià(
NULL
 !ğ
•
)

105 
vp
 = 
•
 + 1;

106 ià(
	`¡¾’
(
vp
) <= 0)

108  
FRE_FAIL
;

110 
	`´štf
("v°ğ%s\n", 
vp
);

112 
	`mem£t
(
key
, 0, 
ARG_PARSER_KEY_MAX
);

114 
key_sz
 = 
•
 - 
¬gv
[
i
];

116 ià(
key_sz
 > 
ARG_PARSER_KEY_MAX
)

118  
FRE_NOTFOUND
;

121 
	`memıy
(
key
, 
¬gv
[
i
], 
key_sz
);

122 
	`´štf
("key = %s\n", 
key
);

124 
’Œy
 = 
	`äùw—k_¬g_·r£r_’Œy_lookup
(
·r£r
, 
key
);

126 ià(
NULL
 =ğ
’Œy
)

128  
FRE_NOTFOUND
;

131 
rv
 = 
’Œy
->
	`func
(
vp
,ƒÁry->
v¬
);

133 ià(
FRE_SUCCESS
 !ğ
rv
)

135  
rv
;

137 
	`´štf
("%s.%d\n", 
__func__
, 
__LINE__
);

141  
FRE_SUCCESS
;

142 
	}
}

145 
	$äùw—k_¬g_·r£r_ä“
(
¬g_·r£r_t
 *
·r£r
)

147 
¬g_·r£r_’Œy_t
 *
’Œy
 = 
NULL
, *
Ãxt
 = NULL;

149 ià(
NULL
 =ğ
·r£r
)

154 
’Œy
 = 
·r£r
->
h—d
;

155 
’Œy
)

157 
Ãxt
 = 
’Œy
->next;

159 ià(
’Œy
->
key
)

161 
	`ä“
(
’Œy
->
key
);

164 
	`ä“
(
’Œy
);

166 
’Œy
 = 
Ãxt
;

170 
	}
}

	@frctweak/frctweak_arg_parser.h

1 #iâdeà
__FRCTWEAK_ARG_PARSER_H__


2 
	#__FRCTWEAK_ARG_PARSER_H__


	)

4 
	s¬g_·r£r_’Œy_s


6 *
	mkey
;

7 *
	mv¬
;

8 (*
	mfunc
)(*
	mvp
, *
	mv¬
);

9 
¬g_·r£r_’Œy_s
 *
	mÃxt
;

10 } 
	t¬g_·r£r_’Œy_t
;

14 
	m’Œy_numb”
;

15 
¬g_·r£r_’Œy_t
 *
	mh—d
;

16 
¬g_·r£r_’Œy_t
 *
	m
;

17 } 
	t¬g_·r£r_t
;

19 
	#ARG_PARSER_KEY_MAX
 32

	)

21 
äùw—k_¬g_·r£r_š™
(
¬g_·r£r_t
 *
·r£r
);

22 
äùw—k_¬g_·r£r_add
(
¬g_·r£r_t
 *
·r£r
, *
key
, (*
func
), * 
v¬
);

23 
äùw—k_¬g_·rsšg
(
¬g_·r£r_t
 *
·r£r
, 
¬gc
, **
¬gv
);

24 
äùw—k_¬g_·r£r_ä“
(
¬g_·r£r_t
 *
·r£r
);

25 
¬g_·r£r_’Œy_t
 *
äùw—k_¬g_·r£r_’Œy_lookup
(
¬g_·r£r_t
 *
·r£r
, *
key
);

	@frctweak/frctweak_bmm.c

1 
	~<¡dlib.h
>

2 
	~<¡ršg.h
>

4 
	~"äùw—k.h
"

5 
	~"äc_·ck.h
"

6 
	~"äc_dma.h
"

7 
	~"cvmx-sw­.h
"

8 
	~"äc_­i.h
"

9 
	~"äc_debug.h
"

11 
	#HSTRTU16
(
_¡r
, 
_v®
) \

13 *
e
; \

14 
_v®i
;\

15 ià(
_¡r
 !ğ
NULL
) { \

16 
_v®i
 = 
	`¡¹oul
(
_¡r
, &
e
, 16); \

17 ià(
e
 =ğ
_¡r
 || *e != '\0') { \

18 
	`´štf
("Error: invail format!\n"); \

19  
FRE_PARAM
; \

21 ià(
_v®i
 > 0xFFFF) \

23  
FRE_PARAM
; \

25 
_v®
 = 
_v®i
 & 0xFFFF; \

27 }

	)

30 
	$·r£_où
(*
¡r
, 
ušt8_t
 *
v®ue
)

32 ià(!
	`¡rÿ£cmp
(
¡r
, "oct0"))

34 *
v®ue
 = 0;

38 ià(!
	`¡rÿ£cmp
(
¡r
, "oct1"))

40 *
v®ue
 = 16;

46 
	}
}

49 
	$debug_loİback_mode
(
ušt8_t
 
loİback
)

51 
loİback
)

54 
	`´štf
("line-phy\n");

57 
	`´štf
("line-core\n");

60 
	`´štf
("host-phy\n");

63 
	`´štf
("host-core\n");

66 
	`´štf
("normal\n");

69 
	`´štf
("Invilid†oopback mode\n");

73 
	}
}

75 
	$bßrd_šfo_g‘
()

77 
rv
;

78 
äc_bdd_šfo_out_t
 
bdd_šfo
;

79 
buf
[(
äc_bdd_šfo_out_t
)], *
p
;

81 
p
 = 
buf
;

83 
	`mem£t
(&
bdd_šfo
, 0, (
äc_bdd_šfo_out_t
));

85 
rv
 = 
	`äÿpi_bdd_šfo_g‘
((
äc_bdd_šfo_out_t
 *)
buf
);

86 ià(
rv
 !ğ
FRE_SUCCESS
)

88 
	`FRCTWEAK_ERROR
("G‘ infÜm©iÚ oàbßrd fa: %d!\n", 
rv
);

89  
rv
;

92 
p
 = 
	`äc_bdd_šfo_uÅack
Õ, &
bdd_šfo
);

94 
	`äùw—k_v”siÚ_g‘
(&
bdd_šfo
.
äùw—k_v”siÚ
);

96 
rv
 = 
	`äÿpi_äcdrv_v”siÚ_g‘
(&
bdd_šfo
.
äcdrv_v”siÚ
);

97 ià(
rv
 !ğ
FRE_SUCCESS
)

99 
	`FRCTWEAK_ERROR
("G‘ v”siÚ oàäcdrv fa: %d!\n", 
rv
);

100  
rv
;

103 
	`´štf
("äcÜv”siÚ: V%d.%d.%d\n", 
bdd_šfo
.
äcÜe_v”siÚ
.
majÜ
, bdd_šfo.äcÜe_v”siÚ.
mšÜ
, bdd_šfo.äcÜe_v”siÚ.
bud
);

104 
	`´štf
("äùw—k v”siÚ: V%d.%d.%d\n", 
bdd_šfo
.
äùw—k_v”siÚ
.
majÜ
, bdd_šfo.äùw—k_v”siÚ.
mšÜ
, bdd_šfo.äùw—k_v”siÚ.
bud
);

105 
	`´štf
("äcdrv v”siÚ: V%d.%d.%d\n", 
bdd_šfo
.
äcdrv_v”siÚ
.
majÜ
, bdd_šfo.äcdrv_v”siÚ.
mšÜ
, bdd_šfo.äcdrv_v”siÚ.
bud
);

106 
	`´štf
("oùeÚ_drv v”siÚ: V%d.%d.%d\n", 
bdd_šfo
.
oùdrv_v”siÚ
.
majÜ
, bdd_šfo.oùdrv_v”siÚ.
mšÜ
, bdd_šfo.oùdrv_v”siÚ.
bud
);

107 
	`´štf
("oùniøv”siÚ: V%d.%d.%d\n", 
bdd_šfo
.
oùnic_v”siÚ
.
majÜ
, bdd_šfo.oùnic_v”siÚ.
mšÜ
, bdd_šfo.oùnic_v”siÚ.
bud
);

108 
	`´štf
("ıld v”siÚ: %d\n", 
bdd_šfo
.
ıld_v”siÚ
);

109 
	`´štf
("pÜˆnumb”: %d\n", 
bdd_šfo
.
pÜt_numb”
);

111  
FRE_SUCCESS
;

112 
	}
}

116 
	$bßrd_¡©us_g‘
()

118 
rv
;

119 
äc_bdd_¡©us_out_t
 
bdd_¡©us
;

120 
buf
[(
äc_bdd_¡©us_out_t
)], *
p
;

122 
p
 = 
buf
;

124 
	`mem£t
(&
bdd_¡©us
, 0 , (
äc_bdd_¡©us_out_t
));

125 
rv
 = 
	`äÿpi_bdd_¡©us_g‘
((
äc_bdd_¡©us_out_t
 *)
buf
);

126 ià(
rv
 !ğ
FRE_SUCCESS
)

128 
	`FRCTWEAK_ERROR
("G‘ stu oàbßrd fa: %d!\n", 
rv
);

129  
rv
;

133 
p
 = 
	`äc_bdd_¡©us_uÅack
Õ, &
bdd_¡©us
);

136 
i
 = 0; i<(
äc_bdd_¡©us_out_t
); i ++)

138 
	`´štf
(" 0x%.2x\n", ((
ušt8_t
 *)(&
bdd_¡©us
))[
i
]);

141 
	`´štf
("\n");

144 
	`sw­_buff
(16 >> 3, &
bdd_¡©us
.
‹mp
);

145 
	`sw­_4_buff
(1, &
bdd_¡©us
.
ruË_max
);

148 
i
 = 0; i<(
äc_bdd_¡©us_out_t
); i ++)

150 
	`´štf
(" 0x%.2x\n", ((
ušt8_t
 *)(&
bdd_¡©us
))[
i
]);

153 
	`´štf
("loÿÈ‹m³¿tu»: %Îd\n", (
ULL
è
bdd_¡©us
.
‹mp
.
loÿl
);

154 
	`´štf
("»mÙ‹m³¿tu»: %Îd\n", (
ULL
è
bdd_¡©us
.
‹mp
.
»mÙe
);

156 
	`´štf
("dm¨block size: %d kb\n", 
bdd_¡©us
.
dma_block_size
);

157 
	`´štf
("bßrd„uÂšg stus: %s\n", 
bdd_¡©us
.
ruÂšg_¡©us
?"normal":"abnormal");

158 
	`´štf
("s¢ max: %d\n", 
bdd_¡©us
.
s¢_max
);

159 
	`´štf
("ruË max: %d\n", 
bdd_¡©us
.
ruË_max
);

161 
	`´štf
("où0†šk stus: %s\n", 
bdd_¡©us
.
où0
.
lšk
?"up":"down");

162 
	`´štf
("où0 wÜk mode: %s\n", 
bdd_¡©us
.
où0
.
wÜk_mode
?"NICMODE":"FRMODE");

164 
	`´štf
("oct0†oopback mode: ");

165 
	`debug_loİback_mode
(
bdd_¡©us
.
où0
.
loİback_mode
);

166 
	`´štf
("où0 o±iÿÈŒªsûiv” stus: %s\n", 
bdd_¡©us
.
où0
.
İtiÿl_¡©us
?"ON":"OFF");

173 
	`´štf
("où1†šk stus: %s\n", 
bdd_¡©us
.
où1
.
lšk
?"up":"down");

174 
	`´štf
("où1 wÜk mode: %s\n", 
bdd_¡©us
.
où1
.
wÜk_mode
?"NICMODE":"FRMODE");

176 
	`´štf
("oct1†oopback mode: ");

177 
	`debug_loİback_mode
(
bdd_¡©us
.
où1
.
loİback_mode
);

178 
	`´štf
("où1 o±iÿÈŒªsûiv” stus: %s\n", 
bdd_¡©us
.
où1
.
İtiÿl_¡©us
?"ON":"OFF");

185  
FRE_SUCCESS
;

187 
	}
}

190 
	$äùw—k_sysšfo_g‘
()

192 
rv
;

193 
äc_sy¡em_šfo_t
 
sysšfo
;

194 
rv
 = 
	`äÿpi_sysšfo_g‘
(&
sysšfo
);

195 ià(
rv
 !ğ
FRE_SUCCESS
)

197  
rv
;

200 
	`sw­_buff
((
äc_sy¡em_šfo_t
)>>3, &
sysšfo
);

201 
	`´štf
("cÜe_num : %d\n", ()
sysšfo
.
cÜe_num
);

202 
	`´štf
("core_type : %d\n", 5650);

203 
	`´štf
("core_arch (bit) : %d\n", 64);

204 
	`´štf
("cÜe_äeq (Mhzè : %d\n", ()
sysšfo
.
cÜe_äeq
/1000000);

205 
	`´štf
("mem_siz (GBè : %d\n", ()
sysšfo
.
mem_size
);

206 
	`´štf
("mem_äeq (Mhzè : %d\n", ()
sysšfo
.
mem_äeq
/1000000);

207 
	`´štf
("hfa_freq (Mhz) : %d\n", 0);

208 
	`´štf
("hfa_size (MB) : %d\n", 1024);

209 
	`´štf
("pÜt_¥“d (Gbpsè : %d\n", ()
sysšfo
.
pÜt_¥“d
);

210 
	`´štf
("pÜt_num : %d\n", ()
sysšfo
.
pÜt_num
);

211 
	`´štf
("pc›_ÏÀ : %d\n", ()
sysšfo
.
pc›_ÏÃ
);

212 
	`´štf
("pc›_v”siÚ : %d\n", ()
sysšfo
.
pc›_v”siÚ
);

213 
	`´štf
("pcie_oneway (Gbps) : %d\n", 10);

214 
	`´štf
("bßrd_ty³ : %d\n", ()
sysšfo
.
boÙ_ty³
);

215 
	`´štf
("uboot_flag : %d\n", 4);

216 
	`´štf
("soft_version : %d\n", 756);

217 
	`´štf
("grp_all_number : %d\n", 14);

218 
	`´štf
("grp_id : %d,‚um_core: %d, %d~%d\n", 0, 10, 0, 9);

219 
	`´štf
("grp_id : %d,‚um_core: %d, %d~%d\n", 1, 1, 0, 0);

220 
	`´štf
("grp_id : %d,‚um_core: %d, %d~%d\n", 2, 1, 1, 1);

221 
	`´štf
("grp_id : %d,‚um_core: %d, %d~%d\n", 3, 1, 2, 2);

222 
	`´štf
("grp_id : %d,‚um_core: %d, %d~%d\n", 4, 1, 3, 3);

223 
	`´štf
("grp_id : %d,‚um_core: %d, %d~%d\n", 5, 1, 4, 4);

224 
	`´štf
("grp_id : %d,‚um_core: %d, %d~%d\n", 6, 1, 5, 5);

225 
	`´štf
("grp_id : %d,‚um_core: %d, %d~%d\n", 7, 1, 6, 6);

226 
	`´štf
("grp_id : %d,‚um_core: %d, %d~%d\n", 8, 1, 7, 7);

227 
	`´štf
("grp_id : %d,‚um_core: %d, %d~%d\n", 9, 1, 8, 8);

228 
	`´štf
("grp_id : %d,‚um_core: %d, %d~%d\n", 10, 1, 9, 9);

229 
	`´štf
("grp_id : %d,‚um_core: %d, %d~%d\n", 11, 1, 10, 10);

230 
	`´štf
("grp_id : %d,‚um_core: %d, %d~%d\n", 12, 1, 11, 10);

231 
	`´štf
("grp_id : %d,‚um_core: %d, %d~%d\n", 13, 10, 0, 9);

232 
	`´štf
("oct0_ipd_port : %d\n", 0);

233 
	`´štf
("oct1_ipd_port : %d\n", 16);

234 
	`´štf
("pko_q_per_port_pci : %d\n", 8);

235 
	`´štf
("pko_q_per_port_if0 : %d\n", 8);

236 
	`´štf
("pko_q_per_port_if1 : %d\n", 8);

237 
	`´štf
("pko_max_port_if0 : %d\n", 1);

238 
	`´štf
("pko_max_port_if1 : %d\n", 1);

239 
	`´štf
("muti_queue : %d\n", 3);

240 
	`´štf
("core_drv_stat : %d\n", 1);

241 
	`´štf
("pko_stat : %d\n", 1);

242 
	`´štf
("dev_id : %d\n", 0);

243 
	`´štf
("npi_if : %d\n", 0);

244 
	`´štf
("dma_engines : %d\n", 8);

245 
	`´štf
("max_local_ptr : %d\n", 14);

246 
	`´štf
("max_remote_ptr : %d\n", 14);

247 
	`´štf
("pcipko_active : %d\n", 1);

248 
	`´štf
("pcipko_port : %d\n", 32);

249 
	`´štf
("pcipko_queue : %d\n", 16);

250 
	`´štf
("bar0_addr : %d\n", 0);

251 
	`´štf
("bar1_addr : %d\n", 0);

252 
	`´štf
("app_core : %d\n", 1);

253 
	`´štf
("drv_napi : %d\n", 1);

254 
	`´štf
("fast_path : %d\n", 0);

255 
	`´štf
("drop_thread : %d\n", 0);

256 
	`´štf
("baudrate : %d\n", 115200);

257  
FRE_SUCCESS
;

258 
	}
}

260 
	$äùw—k_cmd_bßrd_g‘_u§ge
()

262 
	`´štf
("USAGE: % bßrd (¡©us|šfo|sysšfo)\n", 
´og¿m
);

263 
	`´štf
(" % bßrd stu  --G‘h¡©u oàthsy¡em\n", 
´og¿m
);

264 
	`´štf
(" % bßrd infØ --G‘hv”siÚ oàthsoáw¬e\n", 
´og¿m
);

265 
	`´štf
(" % bßrd sysšfØ --G‘hšfÜm©iÚ oàthsy¡em\n", 
´og¿m
);

266 
	}
}

268 
	$äùw—k_cmd_bßrd_g‘
(
¬gc
, **
¬gv
)

270 
rv
;

271 ià(
¬gc
 != 2)

273 
	`äùw—k_cmd_bßrd_g‘_u§ge
();

274 
	`ex™
(1);

278 ià(!
	`¡rÿ£cmp
("¡©us", 
¬gv
[1]))

280 
rv
 = 
	`bßrd_¡©us_g‘
();

283 ià(!
	`¡rÿ£cmp
("šfo", 
¬gv
[1]))

285 
rv
 = 
	`bßrd_šfo_g‘
();

288 ià(!
	`¡rÿ£cmp
("sysšfo", 
¬gv
[1]))

290 
rv
 = 
	`äùw—k_sysšfo_g‘
();

294  
FRE_PARAM
;

297  
rv
;

298 
	}
}

304 
	$äùw—k_cmd_phy_u§ge
()

306 
	`´štf
("% phy (où0|où1èdevad‡dd¸[v®ue]\n", 
´og¿m
);

307 
	`´štf
("\nOPTIONS:\n");

308 
	`´štf
(" %-16s --%s", "oct0", "Get or set…hy„egister of oct0\n");

309 
	`´štf
(" %-16s --%s", "oct1", "Get or set…hy„egister of oct1\n");

310 
	`´štf
(" %-16s --%s", "devid", "1:PMD_PMA; 2: WIS; 3:PCS; 4:XGXS.\n");

311 
	`´štf
(" %-16s --%s", "addr", "Address of„egister.\n");

312 
	`´štf
(" %-16s --%s", "value", "Valueo set.\n");

314 
	}
}

317 
	$äùw—k_cmd_phy
(
¬gc
, **
¬gv
)

319 
rv
;

321 
äc_bdd_phy_t
 
šput
;

322 
äc_phy_İ_t
 
ouut
;

325 
	`mem£t
(&
šput
, 0, (
äc_bdd_phy_t
));

326 
	`mem£t
(&
ouut
, 0, (
äc_phy_İ_t
));

329 ià(
¬gc
 < 4 ||‡rgc > 5)

331 
	`äùw—k_cmd_phy_u§ge
();

332 
	`ex™
(1);

335 ià(
	`·r£_où
(
¬gv
[1], (
ušt8_t
 *)&
šput
.
phy
.
pÜt
))

337  
FRE_PARAM
;

340 
	`HSTRTU16
(
¬gv
[2], 
šput
.
phy
.
devad
);

342 
	`HSTRTU16
(
¬gv
[3], 
šput
.
phy
.
addr
);

344 ià(
¬gc
 == 5)

346 
	`HSTRTU16
(
¬gv
[4], 
šput
.
phy
.
v®ue
);

347 
šput
.
İ
 = 1;

352 
šput
.
İ
 = 0;

355 
rv
 =
	`äÿpi_bdd_phy
(&
šput
, &
ouut
);

356 ià(
rv
 !ğ
FRE_SUCCESS
)

358 
	`FRCTWEAK_ERROR
("G‘ o¸£ˆPHY oà% ç: %d!\n", 
¬gv
[1], 
rv
);

359  
rv
;

362 ià(!
šput
.
İ
)

364 
	`sw­_buff
((
äc_phy_İ_t
è>> 3, &
ouut
);

366 
	`´štf
("0x%x\n", 
ouut
.
v®ue
);

370  
FRE_SUCCESS
;

371 
	}
}

373 
	$äùw—k_cmd_ıld_u§ge
()

375 
	`´štf
("% ıld‡dd¸[v®ue]\n", 
´og¿m
);

376 
	`´štf
("\nOPTIONS:\n");

377 
	`´štf
(" %-16s --%s", "addr", "Address of„egister.\n");

378 
	`´štf
(" %-16s --%s", "value", "Valueo set.\n");

380 
	}
}

382 
	$äùw—k_cmd_ıld
(
¬gc
, **
¬gv
)

384 
rv
;

385 
äc_bdd_ıld_t
 
šput
;

386 
äc_ıld_İ_t
 
ouut
;

390 
	`mem£t
(&
ouut
, 0, (
äc_ıld_İ_t
));

391 
	`mem£t
(&
šput
, 0, (
äc_bdd_ıld_t
));

394 ià(
¬gc
 < 2 ||‡rgc > 3)

396 
	`äùw—k_cmd_ıld_u§ge
();

397 
	`ex™
(1);

401 
	`HSTRTU16
(
¬gv
[1], 
šput
.
ıld
.
addr
);

402 ià(3 =ğ
¬gc
)

404 
	`HSTRTU16
(
¬gv
[2], 
šput
.
ıld
.
d©a
);

405 
šput
.
İ
 = 1;

409 
šput
.
İ
 = 0;

413 
rv
 = 
	`äÿpi_bdd_ıld
(&
šput
, &
ouut
);

414 ià(
rv
 !ğ
FRE_SUCCESS
)

416 
	`FRCTWEAK_ERROR
("G‘ o¸£ˆıld fa: %d!\n", 
rv
);

417  
rv
;

420 ià(!
šput
.
İ
)

422 
	`sw­_buff
((
äc_ıld_İ_t
è>> 3, &
ouut
);

423 
	`´štf
("REG 0x%x VALUE 0x%x\n", 
ouut
.
addr
, ouut.
d©a
);

426  
FRE_SUCCESS
;

428 
	}
}

430 
	$äùw—k_cmd_pow”off_u§ge
()

432 
	`´štf
("% pow”off\n", 
´og¿m
);

433 
	}
}

435 
	$äùw—k_cmd_pow”off
(
¬gc
, **
¬gv
)

437 
rv
;

439 ià(
¬gc
 != 1)

441 
	`äùw—k_cmd_pow”off_u§ge
();

442 
	`ex™
(1);

445 ià(
	`¡rÿ£cmp
("pow”off", 
¬gv
[1]))

447  
FRE_PARAM
;

450 
rv
 = 
	`äÿpi_bdd_pow”off
();

451 ià(
rv
 !ğ
FRE_SUCCESS
)

453 
	`FRCTWEAK_ERROR
("Pow”ofàsy¡em fa: %d!\n", 
rv
);

454  
rv
;

457  
FRE_SUCCESS
;

459 
	}
}

462 
	$äùw—k_cmd_pÜt_’abË_u§ge
()

464 
	`´štf
("USAGE: % pÜˆINTERFACE (’abË/di§bË)\n", 
´og¿m
);

465 
	}
}

467 
	$äùw—k_cmd_pÜt_’abË
(
¬gc
, **
¬gv
)

469 
rv
;

470 
äc_bdd_£t_pÜt_š_t
 
šput
;

473 ià(
¬gc
 != 3)

475 
	`äùw—k_cmd_pÜt_’abË_u§ge
();

476 
	`ex™
(1);

479 ià(
	`·r£_où
(
¬gv
[1], &
šput
.
pÜt
))

481  
FRE_PARAM
;

484 ià(
	`·r£_boŞ
(
¬gv
[2], &
šput
.
’abË
))

486  
FRE_PARAM
;

490 
rv
 = 
	`äÿpi_bdd_pÜt_’abË
(&
šput
);

491 ià(
rv
 !ğ
FRE_SUCCESS
)

493 
	`FRCTWEAK_ERROR
("EÇbË % ç: %d!\n",
¬gv
[1], 
rv
);

494  
rv
;

497  
FRE_SUCCESS
;

499 
	}
}

501 
	$äùw—k_cmd_pÜt_loİback_£t_u§ge
()

503 
	`´štf
("USAGE: % loİback INTERFACE MODE\n", 
´og¿m
);

504 
	`´štf
("\n OPTION:\n");

505 
	`´štf
(" ---- INTERFACE: oct0 or oct1\n");

506 
	`´štf
(" ---- MODE:†ine-phy\n"

511 
	}
}

513 
	$äùw—k_cmd_pÜt_loİback_£t
(
¬gc
, **
¬gv
)

515 
rv
;

516 
äc_bdd_£t_loİback_š_t
 
mode
;

518 ià(
¬gc
 != 3)

520 
	`äùw—k_cmd_pÜt_loİback_£t_u§ge
();

521 
	`ex™
(1);

525 ià(
	`·r£_où
(
¬gv
[1], &
mode
.
pÜt
))

527  
FRE_PARAM
;

530 ià(
	`·r£_loİback
(
¬gv
[2], &
mode
.
loİback
))

532  
FRE_PARAM
;

537 
rv
 = 
	`äÿpi_bdd_pÜt_loİback_£t
(&
mode
);

538 ià(
rv
 !ğ
FRE_SUCCESS
)

540 
	`FRCTWEAK_ERROR
("S‘†oİback modç: %d!\n", 
rv
);

541  
rv
;

544  
FRE_SUCCESS
;

546 
	}
}

550 
	$äùw—k_cmd_£t_wÜk_mode_u§ge
()

552 
	`´štf
("USAGE: % wÜkmodINTERFACE MODE\n", 
´og¿m
);

553 
	`´štf
("\n OPTION:\n");

554 
	`´štf
(" INTERFACE -- oct0,oct1\n");

555 
	`´štf
(" MODE --NICMODE or FRMODE\n");

556 
	}
}

558 
	$äùw—k_cmd_£t_wÜk_mode
(
¬gc
, **
¬gv
)

560 
rv
;

561 
äc_bdd_wÜkmode_£t_š_t
 
šput
;

563 
	`mem£t
(&
šput
, 0, (
äc_bdd_wÜkmode_£t_š_t
));

565 ià(
¬gc
 != 3)

567 
	`äùw—k_cmd_£t_wÜk_mode_u§ge
();

568  
FRE_SUCCESS
;

571 ià(
	`·r£_où
(
¬gv
[1], &
šput
.
où
))

573  
FRE_PARAM
;

576 ià(
	`·r£_boŞ
(
¬gv
[2], &
šput
.
mode
))

578  
FRE_PARAM
;

581 
rv
 = 
	`äÿpi_bdd_wÜkmode_£t
(&
šput
);

582 ià(
rv
 !ğ
FRE_SUCCESS
)

584 
	`FRCTWEAK_ERROR
("S‘ wÜk_modoà% ç: %d!\n", 
¬gv
[1], 
rv
);

585  
rv
;

588  
FRE_SUCCESS
;

590 
	}
}

592 
	$äùw—k_cmd_sysšfo_g‘_u§ge
()

594 
	`´štf
("USAGE: % sysšfo\n", 
´og¿m
);

595 
	`´štf
(" % sysšfØ--G‘hsy¡em infÜm©iÚ oàthbßrd\n", 
´og¿m
);

596 
	}
}

598 
	$äùw—k_cmd_sysšfo_g‘
(
¬gc
, **
¬gv
)

600 
rv
;

601 
rv
 = 
	`äùw—k_sysšfo_g‘
();

602 ià(
rv
 !ğ
FRE_SUCCESS
)

604 
	`´štf
("G‘ sysšfØç %d\n", 
rv
);

606  
rv
;

607 
	}
}

611 
	$äùw—k_bmm_cmd_š™
(
äùw—k_cmd_t
 *
cmd
)

613 
	`äùw—k_cmd_»gi¡”
(
cmd
, "bßrd", "G‘hšfÜm©iÚ o¸¡©u oàthbßrd", 
äùw—k_cmd_bßrd_g‘
, 
äùw—k_cmd_bßrd_g‘_u§ge
);

614 
	`äùw—k_cmd_»gi¡”
(
cmd
, "phy", "R—d o¸wr™thphy„eg", 
äùw—k_cmd_phy
, 
äùw—k_cmd_phy_u§ge
);

615 
	`äùw—k_cmd_»gi¡”
(
cmd
, "ıld", "R—d o¸wr™thıld„eg", 
äùw—k_cmd_ıld
, 
äùw—k_cmd_ıld_u§ge
);

616 
	`äùw—k_cmd_»gi¡”
(
cmd
, "pow”off", "Pow”ofàthbßrd", 
äùw—k_cmd_pow”off
, 
äùw—k_cmd_pow”off_u§ge
);

617 
	`äùw—k_cmd_»gi¡”
(
cmd
, "pÜt", "EÇbË o¸di§bËhpÜt", 
äùw—k_cmd_pÜt_’abË
, 
äùw—k_cmd_pÜt_’abË_u§ge
);

618 
	`äùw—k_cmd_»gi¡”
(
cmd
, "loİback", "S‘hloİbÿk mode", 
äùw—k_cmd_pÜt_loİback_£t
, 
äùw—k_cmd_pÜt_loİback_£t_u§ge
);

619 
	`äùw—k_cmd_»gi¡”
(
cmd
, "wÜkmode", "S‘ wÜk mode", 
äùw—k_cmd_£t_wÜk_mode
, 
äùw—k_cmd_£t_wÜk_mode_u§ge
);

623 
	}
}

	@frctweak/frctweak_chan.c

1 
	~<¡dlib.h
>

2 
	~<¡ršg.h
>

3 
	~<¡dio.h
>

5 
	~<time.h
>

6 
	~<sys/mmª.h
>

7 
	~<sys/time.h
>

8 
	~<±h»ad.h
>

10 
	~"äùw—k.h
"

11 
	~"äc_dma.h
"

12 
	~"äc_üc8.h
"

13 
	~"äc_debug.h
"

14 
	~"äc_­i.h
"

17 
	$äùw—k_cmd_chª_u§ge
()

19 
	`´štf
("% (udp|s¢|ruËèOPTIONS\n", 
´og¿m
);

20 
	}
}

22 
	$äùw—k_cmd_chª
(
¬gc
, **
¬gv
)

24 
	`´štf
("% (udp|s¢|ruËèOPTIONS\n", 
´og¿m
);

26 
	}
}

28 
timev®
 
	g¡¬t_time
;

29 
	#DUMP_STAT_TITLE
 \

30 
	`´štf
(" %5s %16s %16s %9s %9s %16s %16s %16s %16s\n", \

31 "TIME", "RX_BLOCKS", "ERR_BLOCKS", "CUR SPEED", "AVG SPEED", "AVAIL_SPACE", "COMPL_SPACE", "AVAIL_W", "COMPL_W")

	)

33 #ià
FRC_CONFIG_SIMPLE_PACKAGE


35 
ušt64_t
 
	mrx_blocks
;

36 
ušt64_t
 
	m”r_blocks
;

37 } 
	tsim¶e_·ckage_¡©_t
;

40 
ušt64_t
 
	mty³
;

41 
sim¶e_·ckage_¡©_t
 
	mä_¡©
;

42 
äc_dma_chª_desc_t
 
	mdesc
;

43 
äc_dma_sim¶e_·ckage_chª_ù¾_t
 *
	mdma_ù¾
;

44 
ušt8_t
 *
	mpoŞ_addr
;

45 } 
	tchª_chª_t
;

47 
±h»ad_t
 
	gchª_udp_¡©_th»ad_id
;

48 
±h»ad_t
 
	gchª_udp_d©a_th»ad_id
;

51 
sim¶e_·ckage_¡©_t
 
	g¡©_now
, 
	g¡©_Şd
;

55 
äc_sim¶e_·ckage_block_t
 *

56 
	$chª_udp_pkt_g‘
(
ušt64_t
 
block_addr
, 
chª_chª_t
 *
chª
)

58 
ušt64_t
 
off£t
;

59 
äc_sim¶e_·ckage_block_t
 * 
dma_pkt
 = 
NULL
;

60 
off£t
 = 
block_addr
 - 
chª
->
desc
.
poŞ_addr
;

61 ià(
off£t
 > 
chª
->
desc
.
poŞ_size
)

63  
NULL
;

65 
dma_pkt
 = (
äc_sim¶e_·ckage_block_t
 *)(
chª
->
poŞ_addr
 + 
off£t
);

66  
dma_pkt
;

67 
	}
}

72 
	$chª_udp_pkt_check
(
äc_sim¶e_·ckage_block_t
 *
dma_pkt
)

74 
ušt8_t
 
üc
;

75 
üc
 = 
	`ÿl_üc
(
dma_pkt
->
d©a
, (dma_pkt->data));

76 ià(
üc
)

81 
	}
}

83 *
	$chª_udp_d©a_th»ad
(*
¬g
)

85 
ušt64_t
 
block_addr
;

86 
äc_sim¶e_·ckage_block_t
 *
dma_pkt
 = 
NULL
;

87 
time¥ec
 
¦“±ime
;

88 
¦“±ime
.
tv_£c
 = 0;

89 
¦“±ime
.
tv_n£c
 = 10;

90 
chª_chª_t
 *
udp_chª
 = (chª_chª_ˆ*)
¬g
;

93 ià(
	`SIMPLE_PACKAGE_COMPL_RING_GET
(*
udp_chª
->
dma_ù¾
, 
block_addr
))

95 
dma_pkt
 = 
	`chª_udp_pkt_g‘
(
block_addr
, 
udp_chª
);

96 ià(
dma_pkt
 =ğ
NULL
)

101 ià(
	`chª_udp_pkt_check
(
dma_pkt
))

103 
udp_chª
->
ä_¡©
.
rx_blocks
++;

105 
udp_chª
->
ä_¡©
.
”r_blocks
++;

108 !
	`SIMPLE_PACKAGE_AVAIL_RING_PUT
(*
udp_chª
->
dma_ù¾
, 
block_addr
))

110 
	`Çno¦“p
(&
¦“±ime
, &sleeptime);

115 
	`Çno¦“p
(&
¦“±ime
, &sleeptime);

120 
	`ex™
(1);

121  
NULL
;

122 
	}
}

124 *
	$chª_udp_¡©_th»ad
(*
¬g
)

126 
ušt64_t
 
cur_¥“d
, 
avg_¥“d
, 
¥’d
;

127 
cur_un™
, 
avg_un™
;

128 
chª_chª_t
 *
udp_chª
 = (chª_chª_ˆ*)
¬g
;

129 
timev®
 
now
;

130 
	`g‘timeofday
(&
¡¬t_time
, 
NULL
);

131 
DUMP_STAT_TITLE
;

134 
	`g‘timeofday
(&
now
, 
NULL
);

135 
	`memıy
(&
¡©_now
, &
udp_chª
->
ä_¡©
, (
sim¶e_·ckage_¡©_t
));

136 
¥’d
 = 
now
.
tv_£c
 - 
¡¬t_time
.tv_sec;

137 ià(
¥’d
 == 0)

139 
¥’d
 = 1;

141 
avg_¥“d
 = (
¡©_now
.
rx_blocks
 * 2)/ 
¥’d
;

142 ià(
avg_¥“d
 < 1024)

144 
avg_un™
 = 'K';

145 }ià(
avg_¥“d
 < 1024*1024)

147 
avg_un™
 = 'M';

148 
avg_¥“d
 /=1024;

151 
cur_¥“d
 = (
¡©_now
.
rx_blocks
 - 
¡©_Şd
.rx_blocks) * 2;

152 ià(
cur_¥“d
 < 1024)

154 
cur_un™
 = 'K';

155 }ià(
avg_¥“d
 < 1024*1024)

157 
cur_un™
 = 'M';

158 
cur_¥“d
 /=1024;

161 
	`´štf
("\¸ %5ld %16Îd %16Îd %8Îd%C %8Îd%C",
now
.
tv_£c
- 
¡¬t_time
.tv_sec,

162 (
ULL
è
¡©_now
.
rx_blocks
,(ULL)¡©_now.
”r_blocks
, (ULL)
cur_¥“d
, 
cur_un™
, (ULL)
avg_¥“d
, 
avg_un™
);

163 
	`fæush
(
¡dout
);

164 
	`memıy
(&
¡©_Şd
, &
¡©_now
, (
sim¶e_·ckage_¡©_t
));

165 
	`¦“p
(1);

168  
NULL
;

169 
	}
}

171 
	$äùw—k_cmd_chª_udp_u§ge
()

173 
	`´štf
("% \n", 
´og¿m
);

174 
	`´štf
("PR for udp start:\n");

175 
	}
}

177 
	$äùw—k_cmd_chª_udp_¡¬t
(
¬gc
, **
¬gv
)

179 
mfd
 = 0;

181 
rv
;

182 
chª_chª_t
 *
udp_chª
 = 
NULL
;

183 
udp_chª
 = 
	`m®loc
((
chª_chª_t
));

184 
	`mem£t
(
udp_chª
, 0, (
chª_chª_t
));

185 
udp_chª
->
ty³
 = 
FRC_WORK_UDP
;

189 
rv
 = 
	`äÿpi_chª_Ü_´_ruË_Ü_udp_¡¬t
(
udp_chª
->
ty³
, &udp_chª->
desc
);

190 ià(
rv
 !ğ
FRE_SUCCESS
)

192 
	`FRCTWEAK_ERROR
("commªdƒxecu‹ fa: %d!\n", 
rv
);

193 
äùw—k_cmd_chª_udp_¡¬t_”r
;

196 
	`FRCTWEAK_DEBUG
("udp_chan=%lld, ctlr_addr=%llx, ctrl_size=%llx,"

197 "poŞ_addr=%Îx,…oŞ_size=%Îx\n", (
ULL
)
udp_chª
->
desc
.
ty³
, (ULL)udp_chª->desc.
ù¾_addr
,(ULL)udp_chª->desc.
ù¾_size
,

198 (
ULL
)
udp_chª
->
desc
.
poŞ_addr
, (ULL)udp_chª->desc.
poŞ_size
);

200 
mfd
 = 
	`İ’
("/dev/mem",
O_RDWR
);

201 ià(
mfd
 < 0)

203 
	`FRCTWEAK_ERROR
("Can't open /dev/mem !\n");

204 
rv
 = 
FRE_FAIL
;

205 
äùw—k_cmd_chª_udp_¡¬t_”r
;

209 
udp_chª
->
dma_ù¾
 = 
	`mm­
(0, udp_chª->
desc
.
ù¾_size
, 
PROT_READ
|
PROT_WRITE
, 
MAP_SHARED
, 
mfd
, udp_chª->desc.
ù¾_addr
);

210 
	`FRCTWEAK_DEBUG
("udp_chª->dma_ù¾=%p\n", 
udp_chª
->
dma_ù¾
);

211 ià(
udp_chª
->
dma_ù¾
 =ğ
NULL
)

213 
	`FRCTWEAK_ERROR
("mmap udp‡vail„ing fail!\n");

214 
rv
 = 
FRE_MEMORY
;

215 
äùw—k_cmd_chª_udp_¡¬t_”r
;

218 
udp_chª
->
poŞ_addr
 = 
	`mm­
(0, udp_chª->
desc
.
poŞ_size
, 
PROT_READ
, 
MAP_SHARED
, 
mfd
, udp_chan->desc.pool_addr);

219 
	`FRCTWEAK_DEBUG
("udp_chª->poŞ_addr=%p\n", 
udp_chª
->
poŞ_addr
);

220 ià(
udp_chª
->
poŞ_addr
 =ğ
NULL
)

222 
	`FRCTWEAK_ERROR
("mmap udp…ool fail!\n");

223 
rv
 = 
FRE_MEMORY
;

224 
äùw—k_cmd_chª_udp_¡¬t_”r
;

229 
chª_udp_¡©_th»ad_id
 = 
	`±h»ad_ü—‹
(&chª_udp_¡©_th»ad_id, 
NULL
, 
chª_udp_¡©_th»ad
, (*)
udp_chª
);

230 
chª_udp_d©a_th»ad_id
 = 
	`±h»ad_ü—‹
(&chª_udp_d©a_th»ad_id, 
NULL
, 
chª_udp_d©a_th»ad
, (*)
udp_chª
);

234 
	`¦“p
(30);

236 
äùw—k_cmd_chª_udp_¡¬t_”r
:

237 ià(
mfd
 > 0)

239 
	`şo£
(
mfd
);

241 ià(
rv
)

243  
FRE_FAIL
;

245  
FRE_SUCCESS
;

246 
	}
}

248 
	$äùw—k_cmd_chª_ruË_u§ge
()

250 
	`´štf
("% \n", 
´og¿m
);

251 
	`´štf
("PR for„ule start:\n");

252 
	}
}

254 
	$äùw—k_cmd_chª_ruË_¡¬t
(
¬gc
, **
¬gv
)

256 
mfd
 = 0;

258 
rv
;

259 
chª_chª_t
 *
udp_chª
 = 
NULL
;

260 
udp_chª
 = 
	`m®loc
((
chª_chª_t
));

261 
	`mem£t
(
udp_chª
, 0, (
chª_chª_t
));

262 
udp_chª
->
ty³
 = 
FRC_WORK_RULE
;

268 
rv
 = 
	`äÿpi_chª_Ü_´_ruË_Ü_udp_¡¬t
(
udp_chª
->
ty³
, &udp_chª->
desc
);

269 ià(
rv
 !ğ
FRE_SUCCESS
)

271 
	`FRCTWEAK_ERROR
("commªdƒxecu‹ fa: %d!\n", 
rv
);

272 
äùw—k_cmd_chª_udp_¡¬t_”r
;

277 
mfd
 = 
	`İ’
("/dev/mem",
O_RDWR
);

278 ià(
mfd
 < 0)

280 
	`FRCTWEAK_ERROR
("Can't open /dev/mem !\n");

281 
rv
 = 
FRE_FAIL
;

282 
äùw—k_cmd_chª_udp_¡¬t_”r
;

286 
udp_chª
->
dma_ù¾
 = 
	`mm­
(0, udp_chª->
desc
.
ù¾_size
, 
PROT_READ
|
PROT_WRITE
, 
MAP_SHARED
, 
mfd
, udp_chª->desc.
ù¾_addr
);

287 ià(
udp_chª
->
dma_ù¾
 =ğ
NULL
)

289 
	`FRCTWEAK_ERROR
("mmap udp‡vail„ing fail!\n");

290 
rv
 = 
FRE_MEMORY
;

291 
äùw—k_cmd_chª_udp_¡¬t_”r
;

294 
udp_chª
->
poŞ_addr
 = 
	`mm­
(0, udp_chª->
desc
.
poŞ_size
, 
PROT_READ
, 
MAP_SHARED
, 
mfd
, udp_chan->desc.pool_addr);

295 ià(
udp_chª
->
poŞ_addr
 =ğ
NULL
)

297 
	`FRCTWEAK_ERROR
("mmap udp…ool fail!\n");

298 
rv
 = 
FRE_MEMORY
;

299 
äùw—k_cmd_chª_udp_¡¬t_”r
;

310 
chª_udp_¡©_th»ad_id
 = 
	`±h»ad_ü—‹
(&chª_udp_¡©_th»ad_id, 
NULL
, 
chª_udp_¡©_th»ad
, (*)
udp_chª
);

311 
chª_udp_d©a_th»ad_id
 = 
	`±h»ad_ü—‹
(&chª_udp_d©a_th»ad_id, 
NULL
, 
chª_udp_d©a_th»ad
, (*)
udp_chª
);

315 
	`¦“p
(30);

317 
äùw—k_cmd_chª_udp_¡¬t_”r
:

318 ià(
mfd
 > 0)

320 
	`şo£
(
mfd
);

322 ià(
rv
)

324  
FRE_FAIL
;

326  
FRE_SUCCESS
;

327 
	}
}

330 #ià
FRC_CONFIG_SSN_CHAN


332 
ušt64_t
 
	mrx_blocks
;

333 
ušt64_t
 
	m”r_blocks
;

334 } 
	ts¢_¡©_t
;

337 
ušt64_t
 
	mty³
;

338 
s¢_¡©_t
 
	mä_¡©
;

339 
äc_dma_s¢_chª_desc_t
 
	mdesc
;

340 
äc_s¢_ršg_buff_t
 *
	mavaabË_ršg
;

341 
äc_s¢_ršg_buff_t
 *
	mcom¶‘ed_ršg
;

342 
ušt8_t
 *
	mpoŞ_addr
;

343 } 
	tchª_s¢_chª_t
;

345 
±h»ad_t
 
	gchª_s¢_¡©_th»ad_id
;

346 
±h»ad_t
 
	gchª_s¢_d©a_th»ad_id
;

347 
s¢_¡©_t
 
	gs¢_¡©_now
, 
	gs¢_¡©_Şd
;

349 
äc_s¢_block_t
 *

350 
	$chª_s¢_pkt_g‘
(
ušt64_t
 
block_addr
, 
chª_s¢_chª_t
 *
chª
)

352 
ušt64_t
 
off£t
;

353 
äc_s¢_block_t
 * 
dma_pkt
 = 
NULL
;

354 
off£t
 = 
block_addr
 - 
chª
->
desc
.
poŞ_addr
;

355 ià(
off£t
 > 
chª
->
desc
.
poŞ_size
)

357  
NULL
;

359 
dma_pkt
 = (
äc_s¢_block_t
 *)(
chª
->
poŞ_addr
 + 
off£t
);

360  
dma_pkt
;

361 
	}
}

366 
	$chª_s¢_pkt_check
(
äc_s¢_block_t
 *
dma_pkt
)

368 
ušt8_t
 
üc
;

369 
üc
 = 
	`ÿl_üc
(
dma_pkt
->
d©a
, (dma_pkt->data)-1);

370 ià(
üc
 !ğ
dma_pkt
->
d©a
[
FRC_DMA_SSN_DATA_SIZE
-1])

375 
	}
}

377 *
	$chª_s¢_d©a_th»ad
(*
¬g
)

379 
ušt64_t
 
block_addr
;

380 
äc_s¢_block_t
 *
dma_pkt
 = 
NULL
;

381 
time¥ec
 
¦“±ime
;

382 
¦“±ime
.
tv_£c
 = 0;

383 
¦“±ime
.
tv_n£c
 = 10;

384 
chª_s¢_chª_t
 *
s¢_chª
 = (chª_s¢_chª_ˆ*)
¬g
;

387 ià(
	`SSN_COMPL_RING_GET
((*
s¢_chª
), 
block_addr
))

389 
dma_pkt
 = 
	`chª_s¢_pkt_g‘
(
block_addr
, 
s¢_chª
);

390 ià(
dma_pkt
 =ğ
NULL
)

394 #ià
FRC_CONFIG_SSN_CHAN_TEST_ONE_BLOCK_ONE_PAYLOD


395 
s¢_chª
->
ä_¡©
.
rx_blocks
++;

398 ià(
	`chª_s¢_pkt_check
(
dma_pkt
))

400 
s¢_chª
->
ä_¡©
.
rx_blocks
++;

402 
s¢_chª
->
ä_¡©
.
”r_blocks
++;

407 !
	`SSN_AVAIL_RING_PUT
(*
s¢_chª
, 
block_addr
))

409 
	`Çno¦“p
(&
¦“±ime
, &sleeptime);

413 
	`Çno¦“p
(&
¦“±ime
, &sleeptime);

416 
	}
}

418 *
	$chª_s¢_¡©_th»ad
(*
¬g
)

420 
ušt64_t
 
cur_¥“d
, 
avg_¥“d
, 
¥’d
;

421 
cur_un™
, 
avg_un™
;

422 
chª_s¢_chª_t
 *
s¢_chª
 = (chª_s¢_chª_ˆ*)
¬g
;

423 
timev®
 
now
;

424 
	`g‘timeofday
(&
¡¬t_time
, 
NULL
);

425 
DUMP_STAT_TITLE
;

428 
	`g‘timeofday
(&
now
, 
NULL
);

429 
	`memıy
(&
s¢_¡©_now
, &
s¢_chª
->
ä_¡©
, (
s¢_¡©_t
));

430 
¥’d
 = 
now
.
tv_£c
 - 
¡¬t_time
.tv_sec;

431 ià(
¥’d
 == 0)

433 
¥’d
 = 1;

435 #ià
FRC_CONFIG_SSN_CHAN_TEST_ONE_BLOCK_ONE_PAYLOD


436 
avg_¥“d
 = (
s¢_¡©_now
.
rx_blocks
 * 512)/ 
¥’d
;

437 ià(
avg_¥“d
 < 1024)

439 
avg_un™
 = 'B';

441 ià(
avg_¥“d
 > (1024 * 1024))

443 
avg_¥“d
 /= 1024 * 1024;

444 
avg_un™
 = 'M';

448 
avg_¥“d
 /= 1024;

449 
avg_un™
 = 'K';

452 
cur_¥“d
 = (
s¢_¡©_now
.
rx_blocks
 - 
s¢_¡©_Şd
.rx_blocks) * 512;

453 ià(
cur_¥“d
 < 1024)

455 
cur_un™
 = 'B';

457 ià(
cur_¥“d
 > (1024 * 1024))

459 
cur_¥“d
 /= 1024 * 1024;

460 
cur_un™
 = 'M';

464 
cur_¥“d
 /= 1024;

465 
cur_un™
 = 'K';

468 
avg_¥“d
 = (
s¢_¡©_now
.
rx_blocks
 * 8)/ 
¥’d
;

469 ià(
avg_¥“d
 < 1024)

471 
avg_un™
 = 'K';

472 }ià(
avg_¥“d
 < 1024*1024)

474 
avg_un™
 = 'M';

475 
avg_¥“d
 /=1024;

478 
cur_¥“d
 = (
s¢_¡©_now
.
rx_blocks
 - 
s¢_¡©_Şd
.rx_blocks) * 8;

479 ià(
cur_¥“d
 < 1024)

481 
cur_un™
 = 'K';

482 }ià(
avg_¥“d
 < 1024*1024)

484 
cur_un™
 = 'M';

485 
cur_¥“d
 /=1024;

489 
	`´štf
("\¸ %5ld %16Îd %16Îd %8Îd%C %8Îd%C %16Îd %16Îd",
now
.
tv_£c
- 
¡¬t_time
.tv_sec,

490 (
ULL
è
s¢_¡©_now
.
rx_blocks
,(ULL)s¢_¡©_now.
”r_blocks
, (ULL)
cur_¥“d
, 
cur_un™
, (ULL)
avg_¥“d
, 
avg_un™
,

491 (
ULL
è(
	`SWAP_8_BYTE
(
s¢_chª
->
avaabË_ršg
->
widx
)-SWAP_8_BYTE(s¢_chª->avaabË_ršg->
ridx
)),

492 (
ULL
è(
	`SWAP_8_BYTE
(
s¢_chª
->
com¶‘ed_ršg
->
widx
)-SWAP_8_BYTE(s¢_chª->com¶‘ed_ršg->
ridx
)));

494 
	`´štf
("\¸ %5ld %16Îd %16Îd %8Îd%C %8Îd%C %16Îd %16Îd %16Îd %16Îd",
now
.
tv_£c
- 
¡¬t_time
.tv_sec,

495 (
ULL
è
s¢_¡©_now
.
rx_blocks
,(ULL)s¢_¡©_now.
”r_blocks
, (ULL)
cur_¥“d
, 
cur_un™
, (ULL)
avg_¥“d
, 
avg_un™
,

496 (
ULL
è(
	`SWAP_8_BYTE
(
s¢_chª
->
avaabË_ršg
->
widx
)-SWAP_8_BYTE(s¢_chª->avaabË_ršg->
ridx
)),

497 (
ULL
è(
	`SWAP_8_BYTE
(
s¢_chª
->
com¶‘ed_ršg
->
widx
)-SWAP_8_BYTE(s¢_chª->com¶‘ed_ršg->
ridx
)),

498 (
ULL
è
	`SWAP_8_BYTE
(
s¢_chª
->
avaabË_ršg
->
widx
), (ULL)SWAP_8_BYTE(s¢_chª->
com¶‘ed_ršg
->widx));

500 
	`fæush
(
¡dout
);

501 
	`memıy
(&
s¢_¡©_Şd
, &
s¢_¡©_now
, (
s¢_¡©_t
));

502 
	`¦“p
(1);

505  
NULL
;

506 
	}
}

509 
	$äùw—k_cmd_chª_s¢_u§ge
()

511 
	`´štf
("% \n", 
´og¿m
);

512 
	`´štf
("PR for ssn start:\n");

513 
	}
}

515 
	$äùw—k_cmd_chª_s¢_¡¬t
(
¬gc
, **
¬gv
)

517 
mfd
 = 0;

519 
rv
;

520 
chª_s¢_chª_t
 *
s¢_chª
 = 
NULL
;

521 
s¢_chª
 = 
	`m®loc
((
chª_s¢_chª_t
));

522 
	`mem£t
(
s¢_chª
, 0, (
chª_s¢_chª_t
));

523 
s¢_chª
->
ty³
 = 
FRC_WORK_SSN
;

527 
rv
 = 
	`äÿpi_chª_Ü_´_s¢_¡¬t
(
s¢_chª
->
ty³
, &s¢_chª->
desc
);

528 ià(
rv
 !ğ
FRE_SUCCESS
)

530 
	`FRCTWEAK_ERROR
("commªdƒxecu‹ fa: %d!\n", 
rv
);

531 
äùw—k_cmd_chª_s¢_¡¬t_”r
;

533 
	`FRCTWEAK_DEBUG
("s¢_chª->desc.ava_addr=0x%Îx,‡va_size=0x%Îx\n", (
ULL
)
s¢_chª
->
desc
.
ava_addr
,

534 (
ULL
)
s¢_chª
->
desc
.
ava_size
);

535 
	`FRCTWEAK_DEBUG
("s¢_chª->desc.com¶_addr=0x%Îx, com¶_size=0x%Îx\n",(
ULL
)
s¢_chª
->
desc
.
com¶_addr
,

536 (
ULL
)
s¢_chª
->
desc
.
com¶_size
);

537 
	`FRCTWEAK_DEBUG
("s¢_chª->desc.poŞ_addr=0x%Îx,…oŞ_size=0x%Îx\n",(
ULL
)
s¢_chª
->
desc
.
poŞ_addr
,

538 (
ULL
)
s¢_chª
->
desc
.
poŞ_size
);

542 
mfd
 = 
	`İ’
("/dev/mem",
O_RDWR
);

543 ià(
mfd
 < 0)

545 
	`FRCTWEAK_ERROR
("Can't open /dev/mem !\n");

546 
rv
 = 
FRE_FAIL
;

547 
äùw—k_cmd_chª_s¢_¡¬t_”r
;

550 
s¢_chª
->
avaabË_ršg
 = 
	`mm­
(0, s¢_chª->
desc
.
ava_size
, 
PROT_READ
|
PROT_WRITE
, 
MAP_SHARED
, 
mfd
, s¢_chª->desc.
ava_addr
);

551 ià(
s¢_chª
->
avaabË_ršg
 =ğ
NULL
)

553 
	`FRCTWEAK_ERROR
("mmap udp‡vail„ing fail!\n");

554 
rv
 = 
FRE_MEMORY
;

555 
äùw—k_cmd_chª_s¢_¡¬t_”r
;

558 
s¢_chª
->
com¶‘ed_ršg
 = 
	`mm­
(0, s¢_chª->
desc
.
com¶_size
, 
PROT_READ
|
PROT_WRITE
, 
MAP_SHARED
, 
mfd
, s¢_chª->desc.
com¶_addr
);

559 ià(
s¢_chª
->
com¶‘ed_ršg
 =ğ
NULL
)

561 
	`FRCTWEAK_ERROR
("mmap udp compl„ing fail!\n");

562 
rv
 = 
FRE_MEMORY
;

563 
äùw—k_cmd_chª_s¢_¡¬t_”r
;

566 
s¢_chª
->
poŞ_addr
 = 
	`mm­
(0, s¢_chª->
desc
.
poŞ_size
, 
PROT_READ
, 
MAP_SHARED
, 
mfd
, ssn_chan->desc.pool_addr);

567 ià(
s¢_chª
->
poŞ_addr
 =ğ
NULL
)

569 
	`FRCTWEAK_ERROR
("mmap udp…ool fail!\n");

570 
rv
 = 
FRE_MEMORY
;

571 
äùw—k_cmd_chª_s¢_¡¬t_”r
;

576 
chª_s¢_¡©_th»ad_id
 = 
	`±h»ad_ü—‹
(&chª_s¢_¡©_th»ad_id, 
NULL
, 
chª_s¢_¡©_th»ad
, (*)
s¢_chª
);

577 
chª_s¢_d©a_th»ad_id
 = 
	`±h»ad_ü—‹
(&chª_s¢_d©a_th»ad_id, 
NULL
, 
chª_s¢_d©a_th»ad
, (*)
s¢_chª
);

581 
	`¦“p
(30);

583 
äùw—k_cmd_chª_s¢_¡¬t_”r
:

584 ià(
mfd
 > 0)

586 
	`şo£
(
mfd
);

588 ià(
rv
)

590  
FRE_FAIL
;

592  
FRE_SUCCESS
;

593 
	}
}

596 
	$äùw—k_chª_cmd_š™
(
äùw—k_cmd_t
 *
cmd
)

598 
äùw—k_cmd_t
 *
chª_cmd
;

600 
chª_cmd
 = 
	`äùw—k_cmd_»gi¡”
(
cmd
, "chª", "chªe¡", 
äùw—k_cmd_chª
, 
äùw—k_cmd_chª_u§ge
);

601 #ià
FRC_CONFIG_SIMPLE_PACKAGE


602 
	`äùw—k_cmd_»gi¡”
(
chª_cmd
, "udp", "chª ud°‹¡.", 
äùw—k_cmd_chª_udp_¡¬t
, 
äùw—k_cmd_chª_udp_u§ge
);

603 
	`äùw—k_cmd_»gi¡”
(
chª_cmd
, "ruË", "chª„uËe¡.", 
äùw—k_cmd_chª_ruË_¡¬t
, 
äùw—k_cmd_chª_ruË_u§ge
);

605 #ià
FRC_CONFIG_SSN_CHAN


606 
	`äùw—k_cmd_»gi¡”
(
chª_cmd
, "s¢", "chª s¢e¡.", 
äùw—k_cmd_chª_s¢_¡¬t
, 
äùw—k_cmd_chª_s¢_u§ge
);

609 
	}
}

	@frctweak/frctweak_file.c

2 
	~<¡dlib.h
>

3 
	~<¡ršg.h
>

5 
	~<time.h
>

6 
	~<sys/mmª.h
>

7 
	~<sys/time.h
>

8 
	~<±h»ad.h
>

10 
	~<uni¡d.h
>

11 
	~<fú.h
>

12 
	~<sys/ty³s.h
>

13 
	~<sys/¡©.h
>

16 
	~"äùw—k.h
"

17 
	~"äc_dma.h
"

18 
	~"äc_üc8.h
"

19 
	~"äc_ut.h
"

20 
	~"äc_debug.h
"

21 
	~"äc_­i.h
"

23 
	#FRC_MAC_STRING_SIZE
 40

	)

25 
	$äùw—k_cmd_fe_u§ge
()

27 
	`´štf
("% (udp|s¢|ruËèOPTIONS\n", 
´og¿m
);

28 
	}
}

30 
	$äùw—k_cmd_fe
(
¬gc
, **
¬gv
)

32 
	`´štf
("% (udp|s¢|ruËèOPTIONS\n", 
´og¿m
);

34 
	}
}

38 
	spÿp_fe_h—d”
 {

39 
ušt32_t
 
	mmagic
;

40 
ušt16_t
 
	mv”siÚ_majÜ
;

41 
ušt16_t
 
	mv”siÚ_mšÜ
;

42 
ušt32_t
 
	mthiszÚe
;

43 
ušt32_t
 
	msigfigs
;

44 
ušt32_t
 
	m¢­Ën
;

45 
ušt32_t
 
	mlškty³
;

48 
	spÿp_pkthdr
 {

49 
ušt32_t
 
	m£cÚd
;

50 
ušt32_t
 
	mmiüe£c
;

51 
ušt32_t
 
	mÿ¶’
;

52 
ušt32_t
 
	mËn
;

57 
	mšfd
;

58 
	moutfd
;

59 }
	tpÿp_fe_¡ruù
;

62 
šlše
 
	$pÿp_dump_buff
(
Ën
, 
ušt8_t
 *
buff
)

65 
i
;

66 *
p
, 
lše
[
DUMP_LINE_SIZE
];

68 
p
 = 
lše
;

69 
	`´štf
("BUFF DUMP %d by‹s:\n", 
Ën
);

70 
i
 = 0; i < 
Ën
; i++)

72 ià((
i
 % 16) == 0)

74 
	`mem£t
(
lše
, 0, 
DUMP_LINE_SIZE
);

75 
p
 = 
lše
;

76 
p
 +ğ
	`¥rštf
Õ, "%.4d:", 
i
);

79 ià((
i
 % 16) == 8)

81 
p
 +ğ
	`¥rštf
(p, " -");

83 
p
 +ğ
	`¥rštf
Õ, " %.2x", 
buff
[
i
]);

85 ià((
i
 % 16) == 15)

87 
lše
[
DUMP_LINE_SIZE
 - 1] = 0;

88 
	`´štf
("%s\n", 
lše
);

91 ià((
i
 % 16) != 0)

93 
lše
[
DUMP_LINE_SIZE
 - 1] = 0;

94 
	`´štf
("%s\n", 
lše
);

96 
	`´štf
("\n");

98 
i
;

99 
	`´štf
("PAYLOAD: %d by‹s.\n", 
Ën
);

101 
i
 = 0; i < 
Ën
; i++)

103 ià((
i
 % 16) == 0)

105 
	`´štf
(" %.4x:", 
i
);

107 
	`´štf
(" %.2x", 
buff
[
i
]);

108 ià((
i
 % 16) == 15)

110 
	`´štf
("\n");

113 
	`´štf
("\n");

114 
	}
}

119 
	$pÿp_fe_š™
(* 
š_fe
, * 
out_fe
, 
pÿp_fe_¡ruù
 *
fe_des
)

121 
š_fd
, 
out_fd
;

122 
ušt32_t
 
numby‹s
;

123 
pÿp_fe_h—d”
 
pÿp_h—d”
;

124 
æags
 = 
O_CREAT
 | 
O_TRUNC
 | 
O_WRONLY
;

126 
	`mem£t
(&
pÿp_h—d”
, 0, (
pÿp_fe_h—d”
));

128 ià((
š_fd
 = 
	`İ’
(
š_fe
, 
O_RDONLY
, 0644)) < 0) {

129 
	`³¼Ü
("open");

130  
EXIT_FAILURE
;

132 
	`´štf
("İ’ed %s\n",
š_fe
);

133 
	`´štf
("desütÜ i %d\n", 
š_fd
);

137 ià(
	`»ad
(
š_fd
, &
pÿp_h—d”
, (
pÿp_fe_h—d”
))

138 !ğ(
pÿp_fe_h—d”
))

140 
	`´štf
("read…cap header failed!\n");

141 
	`şo£
(
š_fd
);

143 
	`´štf
("pÿp_h—d”.magiøğ0x%x\n", 
pÿp_h—d”
.
magic
);

144 
	`´štf
("pÿp_h—d”.v”siÚ_majÜ = 0x%x\n", 
pÿp_h—d”
.
v”siÚ_majÜ
);

145 
	`´štf
("pÿp_h—d”.v”siÚ_mšÜ = 0x%x\n", 
pÿp_h—d”
.
v”siÚ_mšÜ
);

146 
	`´štf
("pÿp_h—d”.thiszÚğ0x%x\n", 
pÿp_h—d”
.
thiszÚe
);

147 
	`´štf
("pÿp_h—d”.sigfig ğ0x%x\n", 
pÿp_h—d”
.
sigfigs
);

148 
	`´štf
("pÿp_h—d”.¢­ËÀğ0x%x\n", 
pÿp_h—d”
.
¢­Ën
);

149 
	`´štf
("pÿp_h—d”.lškty³ = 0x%x\n", 
pÿp_h—d”
.
lškty³
);

153 ià((
out_fd
 = 
	`İ’
(
out_fe
, 
æags
, 0644)) < 0) {

154 
	`³¼Ü
("open");

155 
	`şo£
(
š_fd
);

156 
	`şo£
(
out_fd
);

157  
EXIT_FAILURE
;

161 
numby‹s
 = 
	`wr™e
(
out_fd
, &
pÿp_h—d”
, (
pÿp_fe_h—d”
));

162 ià(
numby‹s
 !ğ(
pÿp_fe_h—d”
))

164 
	`´štf
("write…cap header failed!\n");

165 
	`şo£
(
š_fd
);

166 
	`şo£
(
out_fd
);

167  
EXIT_FAILURE
;

170 
fe_des
->
šfd
 = 
š_fd
;

171 
fe_des
->
outfd
 = 
out_fd
;

173 
	}
}

176 
	$pÿp_fe_add_·ck‘
(*
buff
, 
pÿp_fe_¡ruù
 *
fe_des
)

178 
š_fd
, 
out_fd
;

179 
ušt32_t
 
numby‹s
;

180 
pÿp_pkthdr
 
pkt_h—d”
;

181 
ušt32_t
 
·ck‘_Ën
;

183 
š_fd
 = 
fe_des
->
šfd
;

184 
out_fd
 = 
fe_des
->
outfd
;

186 
	`mem£t
(&
pkt_h—d”
, 0, (
pÿp_pkthdr
));

189 ià(
	`»ad
(
š_fd
, &
pkt_h—d”
, (
pÿp_pkthdr
))

190 !ğ(
pÿp_pkthdr
))

192 
	`´štf
("read…cap…acket header failed!\n");

200 
·ck‘_Ën
 = 
pkt_h—d”
.
ÿ¶’
;

204 ià(
	`wr™e
(
out_fd
, &
pkt_h—d”
, (
pÿp_pkthdr
)) !=

205 (
pÿp_pkthdr
))

207 
	`´štf
("write…acket header faile\n");

210  
EXIT_FAILURE
;

216 
numby‹s
 = 
	`wr™e
(
out_fd
, 
buff
, 
·ck‘_Ën
);

217 ià(
numby‹s
 !ğ
·ck‘_Ën
)

219 
	`´štf
("wr™·ck‘ bufàçed ! 0x%x\n", 
numby‹s
);

222  
EXIT_FAILURE
;

229 ià(
	`l£ek
(
š_fd
, 
·ck‘_Ën
, 
SEEK_CUR
) < 0)

231 
	`´štf
("fileƒnd!\n");

234  
EXIT_FAILURE
;

237  
EXIT_SUCCESS
;

238 
	}
}

240 
	$pÿp_fe_şo£
(
pÿp_fe_¡ruù
 *
fe_des
)

242 
š_fd
, 
out_fd
;

244 
š_fd
 = 
fe_des
->
šfd
;

245 
out_fd
 = 
fe_des
->
outfd
;

247 ià(
	`şo£
(
š_fd
) < 0) {

248 
	`³¼Ü
("close");

249  
EXIT_FAILURE
;

251 ià(
	`şo£
(
out_fd
) < 0) {

252 
	`³¼Ü
("close");

253  
EXIT_FAILURE
;

255  
EXIT_SUCCESS
;

256 
	}
}

260 
timev®
 
	g¡¬t_time
;

263 #ià
FRC_CONFIG_SIMPLE_PACKAGE


265 
ušt64_t
 
	mrx_blocks
;

266 
ušt64_t
 
	mrx_pkts
;

267 
ušt64_t
 
	mrx_by‹s
;

268 
ušt64_t
 
	mrx_loss
;

269 
ušt64_t
 
	mrx_pos™ive
;

270 
ušt64_t
 
	mrx_»v”£
;

271 
ušt64_t
 
	mrx_”rÜs
;

273 
ušt64_t
 
	mtx_block
;

274 
ušt64_t
 
	mtx_pkts
;

275 
ušt64_t
 
	mtx_by‹s
;

276 
ušt64_t
 
	mtx_”rÜ
;

277 
ušt64_t
 
	mtx_pos™ive
;

278 
ušt64_t
 
	mtx_»v”£
;

279 } 
	tsim¶e_·ckage_¡©_t
;

282 
ušt64_t
 
	mty³
;

283 
sim¶e_·ckage_¡©_t
 
	mä_¡©
;

284 
äc_dma_chª_desc_t
 
	mdesc
;

285 
äc_dma_sim¶e_·ckage_chª_ù¾_t
 *
	mdma_ù¾
;

286 
ušt8_t
 *
	mpoŞ_addr
;

287 } 
	t´_chª_t
;

292 
sim¶e_·ckage_¡©_t
 
	g¡©_now
, 
	g¡©_Şd
;

296 
äc_sim¶e_·ckage_block_t
 *

297 
	$´_udp_pkt_g‘
(
ušt64_t
 
block_addr
, 
´_chª_t
 *
chª
)

299 
ušt64_t
 
off£t
;

300 
äc_sim¶e_·ckage_block_t
 * 
dma_pkt
 = 
NULL
;

301 
off£t
 = 
block_addr
 - 
chª
->
desc
.
poŞ_addr
;

302 ià(
off£t
 > 
chª
->
desc
.
poŞ_size
)

304  
NULL
;

306 
dma_pkt
 = (
äc_sim¶e_·ckage_block_t
 *)(
chª
->
poŞ_addr
 + 
off£t
);

307  
dma_pkt
;

308 
	}
}

315 
	$´_sim¶e_pkt_g‘
(
äc_sim¶e_·ckage_block_t
 *
dma_pkt
, 
äc_sim¶e_pkt_t
 *
sim¶e_pkt
)

317 ià(
dma_pkt
 =ğ
NULL
 || 
sim¶e_pkt
 == NULL)

319  
FRE_FAIL
;

321 
	`mem£t
(
sim¶e_pkt
, 0, (
äc_sim¶e_pkt_t
));

322 
	`memıy
(&
sim¶e_pkt
->
h—d”
, 
dma_pkt
->
d©a
, 
FRC_DMA_PKT_HEAD_SIZE
);

323 
	`sw­_buff
(
FRC_DMA_PKT_HEAD_SIZE
 >>3, &
sim¶e_pkt
->
h—d”
);

324 
	`memıy
(
sim¶e_pkt
->
·ylßd
, &
dma_pkt
->
d©a
[
FRC_DMA_PKT_PAYLOAD_OFFSET
], sim¶e_pkt->
h—d”
.
tÙ®_·yËn
);

325 
	`memıy
(&
sim¶e_pkt
->
šfo
, &
dma_pkt
->
d©a
[
FRC_DMA_PKT_PAYLOAD_OFFSET
 + sim¶e_pkt->
h—d”
.
tÙ®_·yËn
], 
FRC_DMA_PKT_INFO_SIZE
);

326 
	`sw­_buff
(
FRC_DMA_PKT_INFO_SIZE
 >>3, &
sim¶e_pkt
->
šfo
);

327  
FRE_SUCCESS
;

328 
	}
}

331 
	$´_sim¶e_pkt_´oûss
(
´_chª_t
 *
chª
, 
äc_sim¶e_pkt_t
 *
sim¶e_pkt
, 
pÿp_fe_¡ruù
 *
fe_des
)

346 
i
 = 0; i<1024; i++)

348 
buf
[
i
]=i+1;

351 ià(
	`pÿp_fe_add_·ck‘
((*)
sim¶e_pkt
->
·ylßd
, 
fe_des
))

354 
	`FRCTWEAK_ERROR
("pcap_file_add_packet failed\n");

355 
	`pÿp_fe_şo£
(
fe_des
);

356  
FRE_PARAM
;

358  
FRE_SUCCESS
;

359 
	}
}

361 
	$´_udp_d©a
(
´_chª_t
 *
udp_chª
, 
pÿp_fe_¡ruù
 *
fe_des
, 
»cv_num
)

363 
i
=0;

364 
ušt64_t
 
block_addr
;

365 
äc_sim¶e_·ckage_block_t
 *
dma_pkt
 = 
NULL
;

366 
äc_sim¶e_pkt_t
 
sim¶e_pkt
;

367 
time¥ec
 
¦“±ime
;

368 
¦“±ime
.
tv_£c
 = 0;

369 
¦“±ime
.
tv_n£c
 = 10;

374 ià(
	`SIMPLE_PACKAGE_COMPL_RING_GET
(*
udp_chª
->
dma_ù¾
, 
block_addr
))

376 
i
 ++;

379 
dma_pkt
 = 
	`´_udp_pkt_g‘
(
block_addr
, 
udp_chª
);

380 ià(
dma_pkt
 =ğ
NULL
)

382 
udp_chª
->
ä_¡©
.
rx_”rÜs
++;

385  ià(
	`´_sim¶e_pkt_g‘
(
dma_pkt
, &
sim¶e_pkt
))

387 
udp_chª
->
ä_¡©
.
rx_”rÜs
++;

390 #ià
FRC_DEBUG_PKT_LEN


391 
	`äc_dump_buff
(
FRC_DMA_SIMPLE_PACKAGE_DATA_SIZE
, 
dma_pkt
->
d©a
);

392 
	`äc_dump_dma_hdr
(&
sim¶e_pkt
.
h—d”
);

393 
	`äc_dump_dma_pkt_šfo
(&
sim¶e_pkt
.
šfo
);

394 
	`äc_dump_buff
(
sim¶e_pkt
.
šfo
.
·ylßd_Ën
, sim¶e_pkt.
·ylßd
);

400 
	`´_sim¶e_pkt_´oûss
(
udp_chª
, &
sim¶e_pkt
, 
fe_des
);

403 !
	`SIMPLE_PACKAGE_AVAIL_RING_PUT
(*
udp_chª
->
dma_ù¾
, 
block_addr
))

405 
	`´štf
("%s.%d, i = %d\n", 
__func__
, 
__LINE__
, 
i
);

406 
	`Çno¦“p
(&
¦“±ime
, &sleeptime);

412 
	`Çno¦“p
(&
¦“±ime
, &sleeptime);

415 ià(
i
 =ğ
»cv_num
)

417 
	`´štf
("˜ğ%d\n", 
i
);

418 
	`pÿp_fe_şo£
(
fe_des
);

424 
	}
}

428 
	$äùw—k_cmd_fe_udp_u§ge
()

430 
	`´štf
("% ÿ±u» ud°INPUT OUTPUT RECV_NUM\n", 
´og¿m
);

431 
	`´štf
("OPTIONS:\n");

432 
	`´štf
(" INPUT --The…ath of sending…cap file\n");

433 
	`´štf
(" OUTPUT --The…ath of„eceiving…cap file\n");

434 
	`´štf
(" RECV_NUM --The‚umber of delivered…kts\n");

435 
	}
}

437 
	$äùw—k_cmd_fe_udp_¡¬t
(
¬gc
, **
¬gv
)

439 
mfd
 = 0;

440 
»cv_num
;

441 
rv
;

442 
pÿp_fe_¡ruù
 
fe_des
;

443 
´_chª_t
 *
udp_chª
 = 
NULL
;

447 
udp_chª
 = 
	`m®loc
((
´_chª_t
));

448 
	`mem£t
(
udp_chª
, 0, (
´_chª_t
));

449 
	`mem£t
(&
fe_des
, 0 ,(
pÿp_fe_¡ruù
));

450 
udp_chª
->
ty³
 = 
FRC_WORK_UDP
;

452 ià(
¬gc
 < 3)

454 
	`äùw—k_cmd_fe_udp_u§ge
();

455  
FRE_SUCCESS
;

459 
	`ssÿnf
(
¬gv
[3], "%d", &
»cv_num
);

461 ià(!
»cv_num
)

463 
	`FRCTWEAK_ERROR
("invalid…acket†ength, must > 0\n");

464  
FRE_FAIL
;

467 ià(
	`pÿp_fe_š™
(
¬gv
[1],‡rgv[2], &
fe_des
))

469 
	`FRCTWEAK_ERROR
("pcap_file_init failed!\n");

470  
FRE_FAIL
;

476 
rv
 = 
	`äÿpi_chª_Ü_´_ruË_Ü_udp_¡¬t
(
udp_chª
->
ty³
, &udp_chª->
desc
);

478 ià(
rv
 !ğ
FRE_SUCCESS
)

480 
	`FRCTWEAK_ERROR
("commªdƒxecu‹ fa: %d!\n", 
rv
);

481 
äùw—k_cmd_´_udp_¡¬t_”r
;

484 
	`FRCTWEAK_DEBUG
("udp_chan=%lld, ctlr_addr=%llx, ctrl_size=%llx,"

485 "poŞ_addr=%Îx,…oŞ_size=%Îx\n", (
ULL
)
udp_chª
->
desc
.
ty³
, (ULL)udp_chª->desc.
ù¾_addr
,(ULL)udp_chª->desc.
ù¾_size
,

486 (
ULL
)
udp_chª
->
desc
.
poŞ_addr
, (ULL)udp_chª->desc.
poŞ_size
);

488 
mfd
 = 
	`İ’
("/dev/mem",
O_RDWR
);

489 ià(
mfd
 < 0)

491 
	`FRCTWEAK_ERROR
("Can't open /dev/mem !\n");

492 
rv
 = 
FRE_FAIL
;

493 
äùw—k_cmd_´_udp_¡¬t_”r
;

497 
udp_chª
->
dma_ù¾
 = 
	`mm­
(0, udp_chª->
desc
.
ù¾_size
, 
PROT_READ
|
PROT_WRITE
, 
MAP_SHARED
, 
mfd
, udp_chª->desc.
ù¾_addr
);

498 
	`FRCTWEAK_DEBUG
("udp_chª->dma_ù¾=%p\n", 
udp_chª
->
dma_ù¾
);

499 ià(
udp_chª
->
dma_ù¾
 =ğ
NULL
)

501 
	`FRCTWEAK_ERROR
("mmap udp‡vail„ing fail!\n");

502 
rv
 = 
FRE_MEMORY
;

503 
äùw—k_cmd_´_udp_¡¬t_”r
;

506 
udp_chª
->
poŞ_addr
 = 
	`mm­
(0, udp_chª->
desc
.
poŞ_size
, 
PROT_READ
, 
MAP_SHARED
, 
mfd
, udp_chan->desc.pool_addr);

507 
	`FRCTWEAK_DEBUG
("udp_chª->poŞ_addr=%p\n", 
udp_chª
->
poŞ_addr
);

508 ià(
udp_chª
->
poŞ_addr
 =ğ
NULL
)

510 
	`FRCTWEAK_ERROR
("mmap udp…ool fail!\n");

511 
rv
 = 
FRE_MEMORY
;

512 
äùw—k_cmd_´_udp_¡¬t_”r
;

518 
	`´_udp_d©a
(
udp_chª
, &
fe_des
, 
»cv_num
);

521 
äùw—k_cmd_´_udp_¡¬t_”r
:

522 ià(
mfd
 > 0)

524 
	`şo£
(
mfd
);

526 ià(
rv
)

528  
FRE_FAIL
;

530  
FRE_SUCCESS
;

531 
	}
}

540 
	$´_sim¶e_ruË_pkt_g‘
(
äc_sim¶e_·ckage_block_t
 *
dma_pkt
, 
äc_sim¶e_ruË_pkt_t
 *
sim¶e_pkt
)

542 ià(
dma_pkt
 =ğ
NULL
 || 
sim¶e_pkt
 == NULL)

544  
FRE_FAIL
;

546 
	`mem£t
(
sim¶e_pkt
, 0, (
äc_sim¶e_ruË_pkt_t
));

547 
	`memıy
(&
sim¶e_pkt
->
h—d”
, 
dma_pkt
->
d©a
, 
FRC_DMA_PKT_HEAD_SIZE
);

548 
	`sw­_buff
(
FRC_DMA_PKT_HEAD_SIZE
 >>3, &
sim¶e_pkt
->
h—d”
);

549 
	`memıy
(&
sim¶e_pkt
->
ruË_id
, &
dma_pkt
->
d©a
[
FRC_DMA_PKT_PAYLOAD_OFFSET
], 2);

550 
sim¶e_pkt
->
ruË_id
 = 
	`SWAP_2_BYTE
(simple_pkt->rule_id);

551 
	`memıy
(
sim¶e_pkt
->
·ylßd
, &
dma_pkt
->
d©a
[
FRC_DMA_PKT_PAYLOAD_OFFSET
+2], sim¶e_pkt->
h—d”
.
tÙ®_·yËn
);

552 
	`memıy
(&
sim¶e_pkt
->
šfo
, &
dma_pkt
->
d©a
[
FRC_DMA_PKT_PAYLOAD_OFFSET
 + sim¶e_pkt->
h—d”
.
tÙ®_·yËn
 +2], 
FRC_DMA_PKT_INFO_SIZE
);

553 
	`sw­_buff
(
FRC_DMA_PKT_INFO_SIZE
 >>3, &
sim¶e_pkt
->
šfo
);

554  
FRE_SUCCESS
;

555 
	}
}

558 
	$´_sim¶e_ruË_pkt_´oûss
(
´_chª_t
 *
chª
, 
äc_sim¶e_ruË_pkt_t
 *
sim¶e_pkt
, 
pÿp_fe_¡ruù
 *
fe_des
)

561 ià(
	`pÿp_fe_add_·ck‘
((*)
sim¶e_pkt
->
·ylßd
, 
fe_des
))

563 
	`FRCTWEAK_ERROR
("pcap_file_add_packet failed\n");

564 
	`pÿp_fe_şo£
(
fe_des
);

565  
FRE_PARAM
;

568  
FRE_SUCCESS
;

569 
	}
}

572 
	$´_ruË_d©a
(
´_chª_t
 *
udp_chª
, 
pÿp_fe_¡ruù
 *
fe_des
, 
»cv_num
)

574 
i
 = 0;

575 
ušt64_t
 
block_addr
;

576 
äc_sim¶e_·ckage_block_t
 *
dma_pkt
 = 
NULL
;

577 
äc_sim¶e_ruË_pkt_t
 
sim¶e_pkt
;

578 
time¥ec
 
¦“±ime
;

579 
¦“±ime
.
tv_£c
 = 0;

580 
¦“±ime
.
tv_n£c
 = 10;

585 ià(
	`SIMPLE_PACKAGE_COMPL_RING_GET
(*
udp_chª
->
dma_ù¾
, 
block_addr
))

587 
i
 ++;

590 
dma_pkt
 = 
	`´_udp_pkt_g‘
(
block_addr
, 
udp_chª
);

591 ià(
dma_pkt
 =ğ
NULL
)

593 
	`´štf
("%s.%d\n", 
__func__
, 
__LINE__
);

594 
udp_chª
->
ä_¡©
.
rx_”rÜs
++;

597  ià(
	`´_sim¶e_ruË_pkt_g‘
(
dma_pkt
, &
sim¶e_pkt
))

599 
	`´štf
("%s.%d\n", 
__func__
, 
__LINE__
);

600 
udp_chª
->
ä_¡©
.
rx_”rÜs
++;

603 #ià
FRC_DEBUG_PKT_LEN


604 
	`äc_dump_buff
(
FRC_DMA_SIMPLE_PACKAGE_DATA_SIZE
, 
dma_pkt
->
d©a
);

605 
	`äc_dump_dma_hdr
(&
sim¶e_pkt
.
h—d”
);

606 
	`äc_dump_dma_pkt_šfo
(&
sim¶e_pkt
.
šfo
);

607 
	`äc_dump_buff
(
sim¶e_pkt
.
šfo
.
·ylßd_Ën
, sim¶e_pkt.
·ylßd
);

610 
	`´_sim¶e_ruË_pkt_´oûss
(
udp_chª
, &
sim¶e_pkt
, 
fe_des
);

612 !
	`SIMPLE_PACKAGE_AVAIL_RING_PUT
(*
udp_chª
->
dma_ù¾
, 
block_addr
))

614 
	`´štf
("%s.%d\n", 
__func__
, 
__LINE__
);

615 
	`Çno¦“p
(&
¦“±ime
, &sleeptime);

621 
	`Çno¦“p
(&
¦“±ime
, &sleeptime);

624 ià(
i
 =ğ
»cv_num
)

626 
	`´štf
("˜ğ%d\n", 
i
);

627 
	`pÿp_fe_şo£
(
fe_des
);

633 
	}
}

637 
	$äùw—k_cmd_fe_ruË_u§ge
()

639 
	`´štf
("% ÿ±u»„uË INPUT OUTPUT RECV_NUM\n", 
´og¿m
);

640 
	`´štf
("OPTIONS:\n");

641 
	`´štf
(" INPUT --The…ath of sending…cap file\n");

642 
	`´štf
(" OUTPUT --The…ath of„eceiving…cap file\n");

643 
	`´štf
(" RECV_NUM --The‚umber of delivered…kts\n");

645 
	}
}

647 
	$äùw—k_cmd_fe_ruË_¡¬t
(
¬gc
, **
¬gv
)

649 
mfd
 = 0;

651 
rv
;

652 
»cv_num
;

653 
pÿp_fe_¡ruù
 
fe_des
;

654 
´_chª_t
 *
udp_chª
 = 
NULL
;

656 
udp_chª
 = 
	`m®loc
((
´_chª_t
));

657 
	`mem£t
(
udp_chª
, 0, (
´_chª_t
));

658 
	`mem£t
(&
fe_des
, 0 ,(
pÿp_fe_¡ruù
));

659 
udp_chª
->
ty³
 = 
FRC_WORK_RULE
;

661 ià(
¬gc
 < 3)

663 
	`äùw—k_cmd_fe_ruË_u§ge
();

664  
FRE_SUCCESS
;

667 
	`ssÿnf
(
¬gv
[3], "%d", &
»cv_num
);

669 ià(!
»cv_num
)

671 
	`FRCTWEAK_ERROR
("invalid…acket†ength, must > 0\n");

672  
FRE_FAIL
;

675 ià(
	`pÿp_fe_š™
(
¬gv
[1],‡rgv[2], &
fe_des
))

677 
	`FRCTWEAK_ERROR
("pcap_file_init failed!\n");

678  
FRE_FAIL
;

683 
rv
 = 
	`äÿpi_chª_Ü_´_ruË_Ü_udp_¡¬t
(
udp_chª
->
ty³
, &udp_chª->
desc
);

684 ià(
rv
 !ğ
FRE_SUCCESS
)

686 
	`FRCTWEAK_ERROR
("commªdƒxecu‹ fa: %d!\n", 
rv
);

687 
äùw—k_cmd_´_udp_¡¬t_”r
;

690 
	`FRCTWEAK_DEBUG
("udp_chan=%lld, ctlr_addr=%llx, ctrl_size=%llx,"

691 "poŞ_addr=%Îx,…oŞ_size=%Îx\n", (
ULL
)
udp_chª
->
desc
.
ty³
, (ULL)udp_chª->desc.
ù¾_addr
,(ULL)udp_chª->desc.
ù¾_size
,

692 (
ULL
)
udp_chª
->
desc
.
poŞ_addr
, (ULL)udp_chª->desc.
poŞ_size
);

694 
mfd
 = 
	`İ’
("/dev/mem",
O_RDWR
);

695 ià(
mfd
 < 0)

697 
	`FRCTWEAK_ERROR
("Can't open /dev/mem !\n");

698 
rv
 = 
FRE_FAIL
;

699 
äùw—k_cmd_´_udp_¡¬t_”r
;

703 
udp_chª
->
dma_ù¾
 = 
	`mm­
(0, udp_chª->
desc
.
ù¾_size
, 
PROT_READ
|
PROT_WRITE
, 
MAP_SHARED
, 
mfd
, udp_chª->desc.
ù¾_addr
);

704 
	`FRCTWEAK_DEBUG
("udp_chª->dma_ù¾=%p\n", 
udp_chª
->
dma_ù¾
);

705 ià(
udp_chª
->
dma_ù¾
 =ğ
NULL
)

707 
	`FRCTWEAK_ERROR
("mmap udp‡vail„ing fail!\n");

708 
rv
 = 
FRE_MEMORY
;

709 
äùw—k_cmd_´_udp_¡¬t_”r
;

712 
udp_chª
->
poŞ_addr
 = 
	`mm­
(0, udp_chª->
desc
.
poŞ_size
, 
PROT_READ
, 
MAP_SHARED
, 
mfd
, udp_chan->desc.pool_addr);

713 
	`FRCTWEAK_DEBUG
("udp_chª->poŞ_addr=%p\n", 
udp_chª
->
poŞ_addr
);

714 ià(
udp_chª
->
poŞ_addr
 =ğ
NULL
)

716 
	`FRCTWEAK_ERROR
("mmap udp…ool fail!\n");

717 
rv
 = 
FRE_MEMORY
;

718 
äùw—k_cmd_´_udp_¡¬t_”r
;

723 
	`´_ruË_d©a
(
udp_chª
, &
fe_des
, 
»cv_num
);

726 
äùw—k_cmd_´_udp_¡¬t_”r
:

727 ià(
mfd
 > 0)

729 
	`şo£
(
mfd
);

731 ià(
rv
)

733  
FRE_FAIL
;

735  
FRE_SUCCESS
;

736 
	}
}

741 
ušt64_t
 
	mrx_blocks
;

742 
ušt64_t
 
	mrx_pkts
;

743 
ušt64_t
 
	mrx_by‹s
;

744 
ušt64_t
 
	mrx_loss
;

745 
ušt64_t
 
	mrx_pos™ive
;

746 
ušt64_t
 
	mrx_»v”£
;

747 
ušt64_t
 
	mrx_”rÜs
;

749 
ušt64_t
 
	mtx_block
;

750 
ušt64_t
 
	mtx_pkts
;

751 
ušt64_t
 
	mtx_by‹s
;

752 
ušt64_t
 
	mtx_”rÜ
;

753 
ušt64_t
 
	mtx_pos™ive
;

754 
ušt64_t
 
	mtx_»v”£
;

755 } 
	ts¢_¡©_t
;

758 
ušt64_t
 
	mty³
;

759 
s¢_¡©_t
 
	mä_¡©
;

760 
äc_dma_s¢_chª_desc_t
 
	mdesc
;

761 
äc_s¢_ršg_buff_t
 *
	mavaabË_ršg
;

762 
äc_s¢_ršg_buff_t
 *
	mcom¶‘ed_ršg
;

763 
ušt8_t
 *
	mpoŞ_addr
;

764 } 
	t´_s¢_chª_t
;

767 
ušt32_t
 
	ms
;

768 
ušt32_t
 
	md
;

769 
ušt16_t
 
	m¥
;

770 
ušt16_t
 
	mdp
;

771 
ušt16_t
 
	mblock_num
;

772 
ušt16_t
 
	mblock_Ën
;

773 } 
	täc_tu¶e_block_t
;

776 
ušt16_t
 
	mv®id
;

777 
äc_tu¶e_block_t
 
	ms¢_block
[100];

778 } 
	täc_tu¶e_block_u£_t
;

782 
s¢_¡©_t
 
	gs¢_¡©_now
, 
	gs¢_¡©_Şd
;

784 
äc_s¢_block_t
 *

785 
	$´_s¢_pkt_g‘
(
ušt64_t
 
block_addr
, 
´_s¢_chª_t
 *
chª
)

787 
ušt64_t
 
off£t
;

788 
äc_s¢_block_t
 * 
dma_pkt
 = 
NULL
;

789 
off£t
 = 
block_addr
 - 
chª
->
desc
.
poŞ_addr
;

790 ià(
off£t
 > 
chª
->
desc
.
poŞ_size
)

792  
NULL
;

794 
dma_pkt
 = (
äc_s¢_block_t
 *)(
chª
->
poŞ_addr
 + 
off£t
);

795  
dma_pkt
;

796 
	}
}

803 
	$´_s¢_dma_h—d_g‘
(
äc_s¢_block_t
 *
dma_pkt
, 
äc_dma_hdr_t
 *
dma_hdr
)

805 ià(
dma_pkt
 =ğ
NULL
)

807  
FRE_FAIL
;

809 
	`mem£t
(
dma_hdr
, 0, 
FRC_DMA_PKT_HEAD_SIZE
);

810 
	`memıy
(
dma_hdr
, 
dma_pkt
->
d©a
, 
FRC_DMA_PKT_HEAD_SIZE
);

811 
	`sw­_buff
(
FRC_DMA_PKT_HEAD_SIZE
 >>3, 
dma_hdr
);

812  
FRE_SUCCESS
;

813 
	}
}

819 
	$´_s¢_pkt_´oûss
(
äc_s¢_block_t
 *
dma_pkt
, 
äc_dma_hdr_t
 *
dma_hdr
, *
f’ame
, 
ušt16_t
 
block_Ën
, *
»cv_dœ
)

821 
i
 = 0;

823 
FILE
 *
å
;

824 
ušt8_t
 *
·ylßd
 = 
NULL
;

825 
ušt16_t
 
·yËn
 = 0, 
block_off£t
 = 0;

826 
ušt16_t
 
·ylßd_off£t
 = 
FRC_DMA_PKT_PAYLOAD_OFFSET
;

831 
	`¥rštf
(
f’ame
, "%s/%x_%x_%x_%x.txt", 
»cv_dœ
,

832 
dma_hdr
->
s
, dma_hdr->
d
, dma_hdr->
¥Üt
, dma_hdr->
dpÜt
);

834 
å
 = 
	`fİ’
(
f’ame
, "a+");

835 ià(
å
 =ğ
NULL
)

841 
·ylßd
 = &
dma_pkt
->
d©a
[
·ylßd_off£t
];

842 
·yËn
 = 
dma_hdr
->
tÙ®_·yËn
;

843 
block_off£t
 = 
block_Ën
 - 
·yËn
;

845 ià(
block_off£t
)

847 
	`´štf
("%d\n", 
block_off£t
);

850 
i
 =0; i< 
·yËn
; i++)

854 ià((((
block_off£t
 % 32è+ 
i
) % 32) == 0)

857 
	`årštf
(
å
, "%.2X", 
·ylßd
[
i
]);

861 
	`årštf
(
å
, " %.2X", 
·ylßd
[
i
]);

864 ià((((
block_off£t
 % 32è+ 
i
) % 32) == 31)

868 
	`årštf
(
å
, "\n");

871 
	`fşo£
(
å
);

872 
	}
}

878 
	$´_s¢_pkt_´oûss
(
äc_s¢_block_t
 *
dma_pkt
, 
äc_dma_hdr_t
 *
dma_hdr
, *
f’ame
, 
ušt16_t
 
block_num
)

880 
i
, 
j
 = 0;

881 
äc_dma_pkt_šfo_t
 
pkt_šfo
;

882 
FILE
 *
å
;

883 
ušt8_t
 *
·ylßd
 = 
NULL
;

884 
ušt16_t
 
·yËn
 = 0;

885 
ušt16_t
 
·ylßd_off£t
 = 
FRC_DMA_PKT_PAYLOAD_OFFSET
;

886 
ušt16_t
 
pktšfo_off£t
 = 
FRC_DMA_SSN_DATA_SIZE
 - 
FRC_DMA_PKT_INFO_SIZE
;

887 
ušt8_t
 
pkt_num
;

890 
	`¥rštf
(
f’ame
, "/root/fengying/%x_%x_%x_%x.txt",

891 
dma_hdr
->
s
, dma_hdr->
d
, dma_hdr->
¥Üt
, dma_hdr->
dpÜt
);

893 
å
 = 
	`fİ’
(
f’ame
, "a+");

894 ià(
å
 =ğ
NULL
)

900 
pkt_num
 = 
dma_hdr
->pkt_num;

903 
i
 = 0; i < 
pkt_num
; i++ )

906 
	`mem£t
(&
pkt_šfo
, 0, 
FRC_DMA_PKT_INFO_SIZE
);

907 
	`memıy
(&
pkt_šfo
, (
äc_dma_pkt_šfo_t
 *)&
dma_pkt
->
d©a
[
pktšfo_off£t
], 
FRC_DMA_PKT_INFO_SIZE
);

908 
	`sw­_buff
(
FRC_DMA_PKT_INFO_SIZE
>>3, &
pkt_šfo
);

909 
·ylßd
 = &
dma_pkt
->
d©a
[
·ylßd_off£t
];

910 
·yËn
 = 
pkt_šfo
.
·ylßd_Ën
;

914 
pktšfo_off£t
 -ğ
FRC_DMA_PKT_INFO_SIZE
;

915 
·ylßd_off£t
 +ğ
pkt_šfo
.
·ylßd_Ën
;

918 
j
 =0; j< 
·yËn
; j++)

922 ià((((
·yËn
 * 
pkt_num
 * (
block_num
 - 1)è+(
i
 *…ayËnè+ 
j
) % 32) == 0)

925 
	`årštf
(
å
, "%.2x", 
·ylßd
[
j
]);

929 
	`årštf
(
å
, " %.2x", 
·ylßd
[
j
]);

932 ià((((
·yËn
 * 
pkt_num
 * (
block_num
 - 1)è+(
i
 *…ayËnè+ 
j
) % 32) == 31)

936 
	`årštf
(
å
, "\n");

941 
	`fşo£
(
å
);

942 
	}
}

945 
ušt16_t
 
	$five_tu¶e_ü—‹
(
äc_tu¶e_block_u£_t
 *
tu¶e_block
, 
äc_dma_hdr_t
 *
dma_hdr
)

947 
ušt16_t
 
šdex
, 
block_Ën
;

948 
šdex
 = 
tu¶e_block
->
v®id
;

949 
tu¶e_block
->
s¢_block
[
šdex
].
s
 = 
dma_hdr
->sip;

950 
tu¶e_block
->
s¢_block
[
šdex
].
d
 = 
dma_hdr
->dip;

951 
tu¶e_block
->
s¢_block
[
šdex
].
¥
 = 
dma_hdr
->
¥Üt
;

952 
tu¶e_block
->
s¢_block
[
šdex
].
dp
 = 
dma_hdr
->
dpÜt
;

953 
tu¶e_block
->
s¢_block
[
šdex
].
block_Ën
 = 
dma_hdr
->
tÙ®_·yËn
;

954 
tu¶e_block
->
s¢_block
[
šdex
].
block_num
 = 1;

955 
block_Ën
 = 
tu¶e_block
->
s¢_block
[
šdex
].block_len;

958 
tu¶e_block
->
v®id
 ++;

960  
block_Ën
;

961 
	}
}

963 
ušt16_t
 
	$five_tu¶e_m©ch_´oûss
(
äc_tu¶e_block_u£_t
 *
tu¶e_block
, 
äc_dma_hdr_t
 *
dma_hdr
)

965 
i
;

966 
ušt16_t
 
block_Ën
;

968 ià(
tu¶e_block
->
v®id
)

970 
i
 = 0; i < 
tu¶e_block
->
v®id
; i++)

972 ià(
dma_hdr
->
s
 =ğ
tu¶e_block
->
s¢_block
[
i
].sip &&

973 
dma_hdr
->
d
 =ğ
tu¶e_block
->
s¢_block
[
i
].dip &&

974 
dma_hdr
->
¥Üt
 =ğ
tu¶e_block
->
s¢_block
[
i
].
¥
 &&

975 
dma_hdr
->
dpÜt
 =ğ
tu¶e_block
->
s¢_block
[
i
].
dp
)

977 
tu¶e_block
->
s¢_block
[
i
].
block_Ën
 +ğ
dma_hdr
->
tÙ®_·yËn
;

978 
tu¶e_block
->
s¢_block
[
i
].
block_num
 ++;

980 
block_Ën
 = 
tu¶e_block
->
s¢_block
[
i
].block_len;

983  
block_Ën
;

988  
	`five_tu¶e_ü—‹
(
tu¶e_block
, 
dma_hdr
);

989 
	}
}

991 
	$´_s¢_d©a
(
´_s¢_chª_t
 *
s¢_chª
, *
»cv_dœ
)

993 
ušt64_t
 
block_addr
;

994 
ušt16_t
 
block_Ën
;

995 
äc_s¢_block_t
 *
dma_pkt
 = 
NULL
;

996 
äc_dma_hdr_t
 
dma_h—d
;

997 
äc_tu¶e_block_u£_t
 
tu¶e_block
;

998 
f’ame
[128];

999 
time¥ec
 
¦“±ime
;

1000 
timev®
 
¡¬t
, 
’d
;

1001 
¦“±ime
.
tv_£c
 = 0;

1002 
¦“±ime
.
tv_n£c
 = 10;

1003 
	`mem£t
(&
tu¶e_block
, 0, (
äc_tu¶e_block_u£_t
));

1004 
	`g‘timeofday
(&
¡¬t
, 
NULL
);

1009 ià(
	`SSN_COMPL_RING_GET
((*
s¢_chª
), 
block_addr
))

1012 
dma_pkt
 = 
	`´_s¢_pkt_g‘
(
block_addr
, 
s¢_chª
);

1013 ià(
dma_pkt
 =ğ
NULL
)

1020 ià(!
	`´_s¢_dma_h—d_g‘
(
dma_pkt
, &
dma_h—d
))

1022 
block_Ën
 = 
	`five_tu¶e_m©ch_´oûss
(&
tu¶e_block
, &
dma_h—d
);

1023 
s¢_chª
->
ä_¡©
.
rx_blocks
++;

1025 
s¢_chª
->
ä_¡©
.
rx_”rÜs
++;

1029 ià(
block_num
 > 1)

1031 
	`´štf
("%d\n", 
block_num
);

1035 
s¢_chª
->
ä_¡©
.
rx_blocks
++;

1038 
	`´_s¢_pkt_´oûss
(
dma_pkt
, &
dma_h—d
, 
f’ame
, 
block_Ën
, 
»cv_dœ
);

1039 !
	`SSN_AVAIL_RING_PUT
(*
s¢_chª
, 
block_addr
))

1041 
	`Çno¦“p
(&
¦“±ime
, &sleeptime);

1046 
	`Çno¦“p
(&
¦“±ime
, &sleeptime);

1048 
	`g‘timeofday
(&
’d
, 
NULL
);

1050 ià((
’d
.
tv_£c
 - 
¡¬t
.tv_sec)>30)

1056 
	}
}

1059 
	$äùw—k_cmd_fe_s¢_u§ge
()

1061 
	`´štf
("% ÿ±u» s¢ RECVDIR\n", 
´og¿m
);

1062 
	`´štf
(" RECVDIR -- The directory which is used forhe dumped files\n" );

1063 
	}
}

1065 
	$äùw—k_cmd_fe_s¢_¡¬t
(
¬gc
, **
¬gv
)

1067 
mfd
 = 0;

1069 
rv
;

1070 
»cv_dœ
[128];

1071 
´_s¢_chª_t
 *
s¢_chª
 = 
NULL
;

1074 ià(
¬gc
 < 2)

1076 
	`äùw—k_cmd_fe_s¢_u§ge
();

1077  
FRE_SUCCESS
;

1079 
	`ssÿnf
(
¬gv
[1], "%s", 
»cv_dœ
);

1082 
s¢_chª
 = 
	`m®loc
((
´_s¢_chª_t
));

1083 
	`mem£t
(
s¢_chª
, 0, (
´_s¢_chª_t
));

1084 
s¢_chª
->
ty³
 = 
FRC_WORK_SSN
;

1087 
rv
 = 
	`äÿpi_chª_Ü_´_s¢_¡¬t
(
s¢_chª
->
ty³
, &s¢_chª->
desc
);

1089 ià(
rv
 !ğ
FRE_SUCCESS
)

1091 
	`FRCTWEAK_ERROR
("commªdƒxecu‹ fa: %d!\n", 
rv
);

1092 
äùw—k_cmd_´_s¢_¡¬t_”r
;

1094 
	`FRCTWEAK_DEBUG
("s¢_chª->desc.ava_addr=0x%Îx,‡va_size=0x%Îx\n", (
ULL
)
s¢_chª
->
desc
.
ava_addr
,

1095 (
ULL
)
s¢_chª
->
desc
.
ava_size
);

1096 
	`FRCTWEAK_DEBUG
("s¢_chª->desc.com¶_addr=0x%Îx, com¶_size=0x%Îx\n",(
ULL
)
s¢_chª
->
desc
.
com¶_addr
,

1097 (
ULL
)
s¢_chª
->
desc
.
com¶_size
);

1098 
	`FRCTWEAK_DEBUG
("s¢_chª->desc.poŞ_addr=0x%Îx,…oŞ_size=0x%Îx\n",(
ULL
)
s¢_chª
->
desc
.
poŞ_addr
,

1099 (
ULL
)
s¢_chª
->
desc
.
poŞ_size
);

1103 
mfd
 = 
	`İ’
("/dev/mem",
O_RDWR
);

1104 ià(
mfd
 < 0)

1106 
	`FRCTWEAK_ERROR
("Can't open /dev/mem !\n");

1107 
rv
 = 
FRE_FAIL
;

1108 
äùw—k_cmd_´_s¢_¡¬t_”r
;

1111 
s¢_chª
->
avaabË_ršg
 = 
	`mm­
(0, s¢_chª->
desc
.
ava_size
, 
PROT_READ
|
PROT_WRITE
, 
MAP_SHARED
, 
mfd
, s¢_chª->desc.
ava_addr
);

1112 ià(
s¢_chª
->
avaabË_ršg
 =ğ
NULL
)

1114 
	`FRCTWEAK_ERROR
("mmap udp‡vail„ing fail!\n");

1115 
rv
 = 
FRE_MEMORY
;

1116 
äùw—k_cmd_´_s¢_¡¬t_”r
;

1119 
s¢_chª
->
com¶‘ed_ršg
 = 
	`mm­
(0, s¢_chª->
desc
.
com¶_size
, 
PROT_READ
|
PROT_WRITE
, 
MAP_SHARED
, 
mfd
, s¢_chª->desc.
com¶_addr
);

1120 ià(
s¢_chª
->
com¶‘ed_ršg
 =ğ
NULL
)

1122 
	`FRCTWEAK_ERROR
("mmap udp compl„ing fail!\n");

1123 
rv
 = 
FRE_MEMORY
;

1124 
äùw—k_cmd_´_s¢_¡¬t_”r
;

1127 
s¢_chª
->
poŞ_addr
 = 
	`mm­
(0, s¢_chª->
desc
.
poŞ_size
, 
PROT_READ
, 
MAP_SHARED
, 
mfd
, ssn_chan->desc.pool_addr);

1128 ià(
s¢_chª
->
poŞ_addr
 =ğ
NULL
)

1130 
	`FRCTWEAK_ERROR
("mmap udp…ool fail!\n");

1131 
rv
 = 
FRE_MEMORY
;

1132 
äùw—k_cmd_´_s¢_¡¬t_”r
;

1137 
	`´_s¢_d©a
(
s¢_chª
, 
»cv_dœ
);

1140 
äùw—k_cmd_´_s¢_¡¬t_”r
:

1141 ià(
mfd
 > 0)

1143 
	`şo£
(
mfd
);

1145 ià(
rv
)

1147  
FRE_FAIL
;

1149  
FRE_SUCCESS
;

1150 
	}
}

1153 
	$äùw—k_fe_cmd_š™
(
äùw—k_cmd_t
 *
cmd
)

1155 
äùw—k_cmd_t
 *
fe_cmd
;

1157 
fe_cmd
 = 
	`äùw—k_cmd_»gi¡”
(
cmd
, "ÿ±u»", "ÿ±u»hdm¨·ck‘ š…ÿp", 
äùw—k_cmd_fe
, 
äùw—k_cmd_fe_u§ge
);

1158 #ià
FRC_CONFIG_SIMPLE_PACKAGE


1159 
	`äùw—k_cmd_»gi¡”
(
fe_cmd
, "udp", "ÿ±u» ud°g‘ d©a.", 
äùw—k_cmd_fe_udp_¡¬t
, 
äùw—k_cmd_fe_udp_u§ge
);

1160 
	`äùw—k_cmd_»gi¡”
(
fe_cmd
, "ruË", "ÿ±u»„uË g‘ d©a.", 
äùw—k_cmd_fe_ruË_¡¬t
, 
äùw—k_cmd_fe_ruË_u§ge
);

1162 #ià
FRC_CONFIG_SSN_CHAN


1163 
	`äùw—k_cmd_»gi¡”
(
fe_cmd
, "s¢", "ÿ±u» s¢ g‘ d©a.", 
äùw—k_cmd_fe_s¢_¡¬t
, 
äùw—k_cmd_fe_s¢_u§ge
);

1166 
	}
}

	@frctweak/frctweak_fr.c

1 
	~<¡dlib.h
>

2 
	~<¡ršg.h
>

4 
	~"äùw—k.h
"

5 
	~"äc_·ck.h
"

6 
	~"äc_dma.h
"

7 
	~"cvmx-sw­.h
"

8 
	~"äc_­i.h
"

9 
	~"äc_debug.h
"

11 
	$äùw—k_cmd_s¢_u§ge
()

13 
	`´štf
("% s¢ m©ch OPTIONS\n", 
´og¿m
);

14 
	}
}

16 
	$äùw—k_cmd_s¢
(
¬gc
, **
¬gv
)

18 
	`´štf
("% s¢ m©ch OPTIONS\n", 
´og¿m
);

20 
	}
}

24 
	$ä_¡©us_g‘
(
äc_ä_¡©us_t
 *
¡©us
)

26 
rv
;

27 
rv
 = 
	`äÿpi_ä_¡©us_g‘
(
¡©us
);

28 ià(
rv
 !ğ
FRE_SUCCESS
)

30 
	`FRCTWEAK_ERROR
("G‘ f¸¡©u ç: %d!\n", 
rv
);

31  
rv
;

34 
	`´štf
("FR funùiÚ stus: %s\n", 
¡©us
->
’abË
?"enable":"disable");

36 
	`´štf
("s¢‡ge: %d\n", 
¡©us
->
age_time
);

38 
	`´štf
("disÜd” max„ªge: %d\n", 
¡©us
->
disÜd”_d•th
);

41  
FRE_SUCCESS
;

42 
	}
}

45 
	$äùw—k_cmd_ä_u§ge
()

47 
	`´štf
("% ä (age|disÜd”èPARAM\n", 
´og¿m
);

48 
	`´štf
("% ä stus\n", 
´og¿m
);

49 
	`´štf
("% ä (’abË/di§bË)\n", 
´og¿m
);

50 
	`´štf
(" %-16s --%s", "age", "Sethe‡geime for session, PARAM„ange from 1o 15, initial value is 3\n");

51 
	`´štf
(" %-16s --%s", "disorder", "Sethe disorder depth for flow„estoration, PARAM„ange from 1o 15, initial value is 5\n");

52 
	`´štf
(" %-16s --%s", "status", "Gethe status for flow„estoration\n");

53 
	`´štf
(" %-16s --%s", "(enable/disable)", "Enable or disablehe flow„estoration\n");

54 
	}
}

56 
	$äùw—k_cmd_ä
(
¬gc
, **
¬gv
)

58 
rv
;

59 
ušt32_t
 
age_time
, 
disÜd”_d•th
;

60 
ušt8_t
 
’abË
;

61 
äc_ä_¡©us_t
 
¡©us
;

63 
	`mem£t
(&
¡©us
, 0, (
äc_ä_¡©us_t
));

65 ià(
¬gc
 < 2 ||‡rgc > 3)

67 
	`äùw—k_cmd_ä_u§ge
();

68  
FRE_SUCCESS
;

71 ià(
¬gc
 == 2)

73 ià(!
	`¡rÿ£cmp
("¡©us", 
¬gv
[1]))

75 
	`mem£t
(&
¡©us
, 0, (
äc_ä_¡©us_t
));

76 
rv
 = 
	`ä_¡©us_g‘
(&
¡©us
);

81 if(
	`·r£_boŞ
(
¬gv
[1], &
’abË
))

83  
FRE_PARAM
;

85 
rv
 = 
	`äÿpi_ä_’abË
(
’abË
);

89 ià(
¬gc
 == 3)

91 ià(!
	`¡rÿ£cmp
("disÜd”", 
¬gv
[1]))

93 
	`ssÿnf
(
¬gv
[2], "%d", &
disÜd”_d•th
);

94 ià(
disÜd”_d•th
 < 1 || disorder_depth > 15)

96 
	`FRCTWEAK_ERROR
("Invalid disorder depth!");

97  
FRE_PARAM
;

100 
rv
 = 
	`äÿpi_ä_disÜd”_d•th_£t
(
disÜd”_d•th
);

103 ià(!
	`¡rÿ£cmp
("age", 
¬gv
[1]))

105 
	`ssÿnf
(
¬gv
[2], "%d", &
age_time
);

106 ià(
age_time
 < 1 ||‡ge_time > 2000)

108 
	`FRCTWEAK_ERROR
("Invalid‡geime!");

109  
FRE_PARAM
;

112 
rv
 = 
	`äÿpi_ä_age_time_£t
(
age_time
);

117  
FRE_PARAM
;

121 ià(
rv
 !ğ
FRE_SUCCESS
)

123 
	`FRCTWEAK_ERROR
("G‘ o¸£ˆæow„e¡Ü©iÚ fa: %d!\n", 
rv
);

124  
rv
;

127  
FRE_SUCCESS
;

129 
	}
}

133 
	$äùw—k_cmd_s¢_g‘_fiv‘u¶e_u§ge
()

135 
	`´štf
("USAGE:% s¢ g‘ SIP DIP SP DP PROTO\n", 
´og¿m
);

136 
	}
}

138 
	$äùw—k_cmd_s¢_g‘_fiv‘u¶e
(
¬gc
, **
¬gv
)

140 
rv
, 
i
;

141 
äc_ä_tu¶e_t
 
s¢
;

142 
äc_ä_£ssiÚ_¡©_t
 
¡©
;

143 
	`mem£t
(&
s¢
, 0, (
äc_ä_tu¶e_t
));

145 
	`mem£t
(&
¡©
, 0, (
äc_ä_£ssiÚ_¡©_t
));

147 ià(
¬gc
 < 6)

149 
	`äùw—k_cmd_s¢_g‘_fiv‘u¶e_u§ge
();

150 
	`ex™
(0);

153 ià(
	`·r£_v4
(
¬gv
[1], &
s¢
.
s
))

155  
FRE_PARAM
;

158 ià(
	`·r£_v4
(
¬gv
[2], &
s¢
.
d
))

160  
FRE_PARAM
;

163 ià(
	`·r£_u16
(
¬gv
[3], &
s¢
.
¥
))

165  
FRE_PARAM
;

168 ià(
	`·r£_u16
(
¬gv
[4], &
s¢
.
dp
))

170  
FRE_PARAM
;

173 ià(
	`·r£_´Ùoÿl
(
¬gv
[5], &
s¢
.
´Ùo
))

175  
FRE_PARAM
;

180 
rv
 = 
	`äÿpi_s¢_g‘
(&
s¢
, &
¡©
);

183 ià(
rv
 !ğ
FRE_SUCCESS
)

185 
	`FRCTWEAK_ERROR
("G‘ s¢ by fivtu¶ç: %d!\n", 
rv
);

186  
rv
;

192 
i
 = 0; i<(
äc_ä_£ssiÚ_¡©_t
); i ++)

194 
	`´štf
(" 0x%.2x\n", ((
ušt8_t
 *)(&
¡©
))[
i
]);

196 
	`sw­_buff
((
äc_ä_£ssiÚ_¡©_t
è>> 3, &
¡©
);

197 
	`´štf
("PKTS: %d, BYTES: %d\n", 
¡©
.
pkts
, st.
by‹s
);

199  
FRE_SUCCESS
;

201 
	}
}

204 
	$äùw—k_cmd_s¢_buck‘_g‘_hash_u§ge
()

206 
	`´štf
("USAGE:% g‘ HASH\n", 
´og¿m
);

207 
	}
}

209 
	$äùw—k_cmd_s¢_buck‘_g‘_hash
(
¬gc
, **
¬gv
)

211 
rv
;

212 
i
;

213 
ušt32_t
 
hash
;

216 
s
[18], 
d
[18];

217 
äc_ä_hash_£ssiÚ_t
 
buck‘
;

219 
buf
[(
äc_ä_hash_£ssiÚ_t
)], *
p
;

221 
p
 = 
buf
;

223 
	`mem£t
(&
buck‘
, 0, (
äc_ä_hash_£ssiÚ_t
));

225 ià(
¬gc
 != 3)

227 
	`äùw—k_cmd_s¢_buck‘_g‘_hash_u§ge
();

228 
	`ex™
(0);

231 ià(
	`¡rÿ£cmp
("g‘", 
¬gv
[1]))

233  
FRE_PARAM
;

236 ià(
	`·r£_u32
(
¬gv
[2], &
hash
))

238  
FRE_PARAM
;

242 
rv
 = 
	`äÿpi_s¢_buck‘_g‘
(
hash
, (
äc_ä_hash_£ssiÚ_t
 *)
buf
);

243 ià(
rv
 !ğ
FRE_SUCCESS
)

245 
	`FRCTWEAK_ERROR
("G‘ s¢ buck‘ fa: %d!\n", 
rv
);

246  
rv
;

250 
i
 = 0; i < (
äc_ä_hash_£ssiÚ_t
); i ++)

252 
	`´štf
("0x%x\n", 
buf
[
i
]);

257 
	`UNPACK_U32
(
p
, 
buck‘
.
num
);

259 
	`´štf
("s¢‚umb”: %d\n", 
buck‘
.
num
);

260 
	`´štf
("%-18s %-18s %-4s %-4s %-6s %-6s %-6s\n",

262 
i
=0;i<
buck‘
.
num
;i++)

264 
p
 = 
	`äc_ä_£ssiÚ_t_uÅack
Õ, &
buck‘
.
£ssiÚ
[
i
]);

265 
	`ä_v4_¡ršg
(
buck‘
.
£ssiÚ
[
i
].
five_tu¶e
.
s
, sip);

266 
	`ä_v4_¡ršg
(
buck‘
.
£ssiÚ
[
i
].
five_tu¶e
.
d
, dip);

267 
	`´štf
("%-18s %-18s %-4d %-4d %-6d %-6d %-6d\n",

268 
s
, 
d
, 
buck‘
.
£ssiÚ
[
i
].
five_tu¶e
.
¥
, buck‘.£ssiÚ[i].five_tu¶e.
dp
, buck‘.£ssiÚ[i].five_tu¶e.
´Ùo
, buck‘.£ssiÚ[i].
£ssiÚ_¡©
.
pkts
, buck‘.£ssiÚ[i].£ssiÚ_¡©.
by‹s
);

271  
FRE_SUCCESS
;

272 
	}
}

274 
	$äùw—k_cmd_s¢_m©ch_u§ge
()

276 
	`´štf
("USAGE: % s¢ m©ch SIP DIP SP DP\n", 
´og¿m
);

277 
	`´štf
(" SIP+ -- Source IP or source ip increment,†ike: 192.168.1.0/255.255.255.0 or 10.0.0.1+100\n");

278 
	`´štf
(" DIP+ -- Destination IP or source ip increment,†ike: 192.168.1.0/255.255.255.0 or 10.0.0.1+100\n");

279 
	`´štf
(" SP+ -- TCP/UDP source…ort & mask or source…ort increment,†ike: 80,80/0x00ff, 1024+10\n");

280 
	`´štf
(" DP+ -- TCP/UDP destination…ort & mask or destination…ort increment,†ike: 80,80/0x00ff, 1024+10\n");

281 
	}
}

283 
	$äùw—k_cmd_s¢_m©ch
(
¬gc
, **
¬gv
)

285 
rv
;

286 
ušt64_t
 
num
 = 0;

287 
ušt32_t
 
s
, 
ss
, 
si
, 
se
, 
d
, 
ds
, 
di
, 
de
;

288 
ušt16_t
 
¥
, 
¥s
, 
¥i
, 
¥e
, 
dp
, 
dps
, 
dpi
, 
d³
;

289 
äc_s¢_m©ch_t
 
s¢_m©ch
;

291 ià(
¬gc
 < 5)

293 
	`äùw—k_cmd_s¢_m©ch_u§ge
();

294  
FRE_SUCCESS
;

297 ià(
	`·r£_v4_šc
(
¬gv
[1], &
ss
, &
si
))

299  
FRE_PARAM
;

302 ià(
	`·r£_v4_šc
(
¬gv
[2], &
ds
, &
di
))

304  
FRE_PARAM
;

307 ià(
	`·r£_u16_šc
(
¬gv
[3], &
¥s
, &
¥i
))

309  
FRE_PARAM
;

312 ià(
	`·r£_u16_šc
(
¬gv
[4], &
dps
, &
dpi
))

314  
FRE_PARAM
;

318 
se
 = 
ss
 + 
si
;

319 
de
 = 
ds
 + 
di
;

320 
¥e
 = 
¥s
 + 
¥i
;

321 
d³
 = 
dps
 + 
dpi
;

323 
s
 = 
ss
; s < 
se
; sip++)

325 
d
 = 
ds
; d < 
de
; dip++)

327 
¥
 = 
¥s
; s°< 
¥e
; sp++)

329 
dp
 = 
dps
; d°< 
d³
; dp++)

332 
s¢_m©ch
.
tu¶e
.
s
 = sip;

333 
s¢_m©ch
.
tu¶e
.
d
 = dip;

334 
s¢_m©ch
.
tu¶e
.
¥
 = sp;

335 
s¢_m©ch
.
tu¶e
.
dp
 = dp;

336 
s¢_m©ch
.
tu¶e
.
´Ùo
 = 6;

338 
rv
 = 
	`äÿpi_s¢_m©ch
(&
s¢_m©ch
, &s¢_m©ch.
num
);

339 
	`sw­_buff
(1, &
s¢_m©ch
.
num
);

340 ià(
FRE_SUCCESS
 =ğ
rv
)

342 
num
 +ğ
s¢_m©ch
.num;

350 
	`´štf
("m©ched: %Îd\n", (
ULL
)
num
);

351  
FRE_SUCCESS
;

352 
	}
}

355 
	$äùw—k_ä_cmd_š™
(
äùw—k_cmd_t
 *
cmd
)

357 
äùw—k_cmd_t
 *
s¢_cmd
;

358 
	`äùw—k_cmd_»gi¡”
(
cmd
, "ä", "S‘ o¸g‘ flow„e¡Ü©iÚ moduË", 
äùw—k_cmd_ä
, 
äùw—k_cmd_ä_u§ge
);

360 
s¢_cmd
 = 
	`äùw—k_cmd_»gi¡”
(
cmd
, "s¢", "g‘hs¢ infÜm©iÚ", 
äùw—k_cmd_s¢
, 
äùw—k_cmd_s¢_u§ge
);

361 
	`äùw—k_cmd_»gi¡”
(
s¢_cmd
, "m©ch", "M©chhs¢ fromh¥ecif›d fivtu¶e", 
äùw—k_cmd_s¢_m©ch
, 
äùw—k_cmd_s¢_m©ch_u§ge
);

365 
	}
}

	@frctweak/frctweak_ipc.c

1 
	~<¡dlib.h
>

2 
	~<¡ršg.h
>

3 
	~<¡dšt.h
>

4 
	~"äùw—k.h
"

5 
	~"äc_·ck.h
"

6 
	~"äc_dma.h
"

7 
	~"cvmx-sw­.h
"

8 
	~"äc_­i.h
"

9 
	~"äc_debug.h
"

10 
	~<¬·/š‘.h
>

13 
	~"äùw—k_¬g_·r£r.h
"

15 #ià
FRC_CONFIG_IPC


17 
	$äùw—k_cmd_c_u§ge
()

19 
	`´štf
("U§ge: % øş—r\n", 
´og¿m
);

20 
	`´štf
(" ipc misc [smac_check=y/n] [pktid_check=y/n] [exp_check=y/n]\n");

21 
	`´štf
(" [invaild_dump=0xHH] [instr_send=y/n]\n");

22 
	`´štf
(" ipc misc clear\n");

23 
	`´štf
(" ipc instr [sipd=A.B.C.D] [sipm=A.B.C.D] [dipd=A.B.C.D] [dipm=A.B.C.D]\n");

24 
	`´štf
(" [type=0|1|2|3|4|5] [action=0|1] [payload=FILE]\n");

25 
	`´štf
(" ipc instr clear\n");

26 
	`´štf
(" ipcƒxp [ouid=0xHH] [ouim=0xHH] [pidd=0xHH] [pidm=0xHH] [iifd=0xHH] [iifm=0xHH]\n");

27 
	`´štf
(" ipcƒxp clear\n");

28 
	`´štf
(" ipc cur [smac=HH:HH:HH:HH:HH:HH] [pktid=0xHH]\n");

29 
	`´štf
(" ipc cur clear\n");

30 
	`´štf
(" ipc vlan_hash [v4/v6] sip/dip A.B.C.D/AA::BB\n");

31 
	}
}

34 
	#FRCTWEAK_IPC_FILED_DUMP
(
_v®
, 
_f›ld
, 
_func
) \

36 ià(
NULL
 =ğ
_func
) \

38 
	`´štf
(" %16 : 0x%x\n", #_f›ld, 
_v®
.
_f›ld
); \

42 
_¡r
[256]; \

43 
	`_func
(
_v®
.
_f›ld
, 
_¡r
); \

44 
	`´štf
(" %16 : %s\n", #_f›ld, 
_¡r
); \

46 }

	)

48 
	$äùw—k_c_misc_ş—r
()

50 
rv
;

51 
c_misc_t
 
misc
;

53 
	`mem£t
(&
misc
, 0, (
c_misc_t
));

55 
rv
 = 
	`äÿpi_c_misc_£t
(&
misc
);

57 ià(
FRE_SUCCESS
 =ğ
rv
)

59 
	`´štf
("IPC misc„eset success.\n");

63 
	`´štf
("E¼Ü: IPC misø»£ˆç!Ôv=%d)\n", 
rv
);

66  
rv
;

67 
	}
}

69 
	$äùw—k_cmd_c_misc
(
¬gc
, **
¬gv
)

71 
rv
 = 0;

72 
c_misc_t
 
misc
;

73 
¬g_·r£r_t
 
·r£r
 = {};

75 
rv
 = 
	`äÿpi_c_misc_g‘
(&
misc
);

78 ià(
FRE_SUCCESS
 !ğ
rv
)

80 
	`´štf
("ERROR: ipømisøg‘ fa!Ôv=%d)\n", 
rv
);

81  
rv
;

84 
	`sw­_buff
((
c_misc_t
è>> 3, &
misc
);

85 
	`´štf
("%s.%d:smac_check = %d,…ktid_check = %d\n", 
__func__
, 
__LINE__
, 
misc
.
smac_check
, misc.
pktid_check
);

87 ià(1 =ğ
¬gc
)

89 
	`´štf
("IPC MISC:\n");

91 
	`FRCTWEAK_IPC_FILED_DUMP
(
misc
, 
smac_check
, 
u8_¡ršg
);

92 
	`FRCTWEAK_IPC_FILED_DUMP
(
misc
, 
pktid_check
, 
u8_¡ršg
);

93 
	`FRCTWEAK_IPC_FILED_DUMP
(
misc
, 
exp_check
, 
u8_¡ršg
);

94 
	`FRCTWEAK_IPC_FILED_DUMP
(
misc
, 
šv®id_dump
, 
u8_¡ršg
);

95 
	`FRCTWEAK_IPC_FILED_DUMP
(
misc
, 
š¡r_£nd
, 
u8_¡ršg
);

97 ià(!
	`¡rÿ£cmp
("ş—r", 
¬gv
[1]))

99 
rv
 = 
	`äùw—k_c_misc_ş—r
();

103 
	`äùw—k_¬g_·r£r_š™
(&
·r£r
);

105 
	`äùw—k_¬g_·r£r_add
(&
·r£r
,"smac_check", 
·r£_u8
, &
misc
.
smac_check
);

106 
	`äùw—k_¬g_·r£r_add
(&
·r£r
,"pktid_check", 
·r£_u8
, &
misc
.
pktid_check
);

107 
	`äùw—k_¬g_·r£r_add
(&
·r£r
,"exp_check", 
·r£_u8
, &
misc
.
exp_check
);

108 
	`äùw—k_¬g_·r£r_add
(&
·r£r
,"šv®id_dump", 
·r£_u8
, &
misc
.
šv®id_dump
);

109 
	`äùw—k_¬g_·r£r_add
(&
·r£r
,"š¡r_£nd", 
·r£_u8
, &
misc
.
š¡r_£nd
);

110 
	`´štf
("¬gøğ%d,‡rgv[0] = %s\n", 
¬gc
, 
¬gv
[0]);

112 
rv
 = 
	`äùw—k_¬g_·rsšg
(&
·r£r
, --
¬gc
, ++
¬gv
);

114 
	`äùw—k_¬g_·r£r_ä“
(&
·r£r
);

116 ià(
FRE_SUCCESS
 !ğ
rv
)

118 
	`äùw—k_cmd_c_u§ge
();

119  
FRE_PARAM
;

122 
rv
 = 
	`äÿpi_c_misc_£t
(&
misc
);

124 ià(
FRE_SUCCESS
 =ğ
rv
)

126 
	`´štf
("IPC misc set success.\n");

130 
	`´štf
("E¼Ü: IPC misø£ˆç!Ôv=%d)\n", 
rv
);

134  
rv
;

136 
	}
}

138 
	$äùw—k_c_cur_ş—r
()

140 
rv
;

141 
c_cur_t
 
cur
;

143 
	`mem£t
(&
cur
, 0, (
c_cur_t
));

145 
rv
 = 
	`äÿpi_c_cur_£t
(&
cur
);

147 ià(
FRE_SUCCESS
 =ğ
rv
)

149 
	`´štf
("IPC cur„eset success.\n");

153 
	`´štf
("E¼Ü: IPC cu¸»£ˆç!Ôv=%d)\n", 
rv
);

156  
rv
;

157 
	}
}

159 
	$äùw—k_cmd_c_cur
(
¬gc
, **
¬gv
)

161 
rv
 = 0;

162 
c_cur_t
 
cur
;

163 
¬g_·r£r_t
 
·r£r
;

165 ià(1 =ğ
¬gc
)

167 
rv
 = 
	`äÿpi_c_cur_g‘
(&
cur
);

169 ià(
FRE_SUCCESS
 !ğ
rv
)

171 
	`´štf
("ERROR: ipøcu¸g‘ fa!Ôv=%d)\n", 
rv
);

172  
rv
;

175 
	`´štf
("IPC CUR:\n");

176 
	`sw­_buff
(2, &
cur
);

178 
	`FRCTWEAK_IPC_FILED_DUMP
(
cur
, 
smac
, 
mac_¡ršg
);

179 
	`FRCTWEAK_IPC_FILED_DUMP
(
cur
, 
pktid
, 
u64_¡ršg
);

181 
rv
 = 
FRE_SUCCESS
;

183 ià(!
	`¡rÿ£cmp
("ş—r", 
¬gv
[1]))

185 
rv
 = 
	`äùw—k_c_cur_ş—r
();

189 
rv
 = 
	`äÿpi_c_cur_g‘
(&
cur
);

191 ià(
FRE_SUCCESS
 !ğ
rv
)

193 
	`´štf
("ERROR: ipøcu¸g‘ fa!Ôv=%d)\n", 
rv
);

194  
rv
;

196 
	`sw­_buff
(2, &
cur
);

198 
	`äùw—k_¬g_·r£r_š™
(&
·r£r
);

199 
	`äùw—k_¬g_·r£r_add
(&
·r£r
, "smac", 
·r£_mac64
, (*)&
cur
.
smac
);

200 
	`äùw—k_¬g_·r£r_add
(&
·r£r
, "pktid", 
·r£_u64
, (*)&
cur
.
pktid
);

202 
rv
 = 
	`äùw—k_¬g_·rsšg
(&
·r£r
, 
¬gc
, 
¬gv
);

204 
	`äùw—k_¬g_·r£r_ä“
(&
·r£r
);

206 ià(
FRE_SUCCESS
 !ğ
rv
)

208 
	`äùw—k_cmd_c_u§ge
();

209  
FRE_PARAM
;

212 
rv
 = 
	`äÿpi_c_cur_£t
(&
cur
);

214 ià(
FRE_SUCCESS
 =ğ
rv
)

216 
	`´štf
("IPC cur set success.\n");

220 
	`´štf
("E¼Ü: IPC cu¸£ˆç!Ôv=%d)\n", 
rv
);

224  
rv
;

225 
	}
}

227 
	$·r£_hash_ty³
(*
¡r
, 
ušt32_t
 *
ty³
)

229 ià(!
	`¡rcmp
(
¡r
, "sip"))

231 *
ty³
 = 
FRC_VLAN_CHECK_SIP
;

233 ià(!
	`¡rcmp
(
¡r
, "dip"))

235 *
ty³
 = 
FRC_VLAN_CHECK_DIP
;

239  
FRE_PARAM
;

241  
FRE_SUCCESS
;

242 
	}
}

244 
	$äùw—k_cmd_c_vÏn_hash
(
¬gc
, **
¬gv
)

246 
i
;

247 
rv
 = 0;

248 
äc_vÏn_hash_mask_t
 
hash_mask
 = {};

250 ià(1 =ğ
¬gc
)

255 ià(
FRE_SUCCESS
 !ğ
rv
)

257 
	`´štf
("ERROR: ipøcu¸g‘ fa!Ôv=%d)\n", 
rv
);

258  
rv
;

261 
	`´štf
("IPC CUR:\n");

262 
	`sw­_buff
(2, &
cur
);

264 
	`FRCTWEAK_IPC_FILED_DUMP
(
cur
, 
smac
, 
mac_¡ršg
);

265 
	`FRCTWEAK_IPC_FILED_DUMP
(
cur
, 
pktid
, 
u64_¡ršg
);

267 
rv
 = 
FRE_SUCCESS
;

270 ià(!
	`¡rÿ£cmp
("v4", 
¬gv
[1]))

272 ià(
	`·r£_hash_ty³
(
¬gv
[2], &
hash_mask
.
hash_ty³
))

274  
FRE_PARAM
;

276 ià(
	`·r£_v4
(
¬gv
[3], &
hash_mask
.
4
))

278  
FRE_PARAM
;

280 
	`´štf
("4=0x%x\n", 
hash_mask
.
4
);

281 
rv
 = 
	`äùw—k_c_hash4_mask_£t
(&
hash_mask
);

284 ià(!
	`¡rÿ£cmp
("v6", 
¬gv
[1]))

286 ià(
	`·r£_hash_ty³
(
¬gv
[2], &
hash_mask
.
hash_ty³
))

288  
FRE_PARAM
;

290 ià(
	`š‘_±Ú
(
AF_INET6
, 
¬gv
[3], 
hash_mask
.
6
) <= 0)

292  
FRE_PARAM
;

294 
i
 = 0; i < 16; i++)

296 
	`´štf
("%d, ", 
hash_mask
.
6
[
i
]);

298 
	`´štf
("\n");

299 
rv
 = 
	`äùw—k_c_hash6_mask_£t
(&
hash_mask
);

302 ià(
FRE_SUCCESS
 =ğ
rv
)

304 
	`´štf
("IPC hash mask set success.\n");

308 
	`´štf
("E¼Ü: IPC hash mask s‘ fa!Ôv=%d)\n", 
rv
);

311  
rv
;

312 
	}
}

317 
	$äùw—k_c_exp_ş—r
()

319 
rv
;

320 
c_exp_t
 
exp
;

321 
	`mem£t
(&
exp
, 0, (
c_exp_t
));

323 
rv
 = 
	`äÿpi_c_exp_£t
(&
exp
);

325 ià(
FRE_SUCCESS
 =ğ
rv
)

327 
	`´štf
("IPCƒxp„eset success.\n");

331 
	`´štf
("E¼Ü: IPCƒx°»£ˆç!Ôv=%d)\n", 
rv
);

334  
rv
;

335 
	}
}

337 
	$äùw—k_cmd_c_exp
(
¬gc
, **
¬gv
)

339 
rv
 = 0;

340 
c_exp_t
 
exp
;

341 
¬g_·r£r_t
 
·r£r
;

343 ià(1 =ğ
¬gc
)

345 
rv
 = 
	`äÿpi_c_exp_g‘
(&
exp
);

347 ià(
FRE_SUCCESS
 !ğ
rv
)

349 
	`´štf
("ERROR: ipøex°g‘ fa!Ôv=%d)\n", 
rv
);

350  
rv
;

352 
	`sw­_buff
((
c_exp_t
)>>3, &
exp
);

354 
	`´štf
("IPCƒxp:\n");

356 
	`´štf
("N: iifd = 0x%x, iifm=0x%x\n", 
exp
.
iifd
,ƒxp.
iifm
);

358 
	`FRCTWEAK_IPC_FILED_DUMP
(
exp
, 
ouid
, 
u16_¡ršg
);

359 
	`FRCTWEAK_IPC_FILED_DUMP
(
exp
, 
ouim
, 
u16_¡ršg
);

361 
	`FRCTWEAK_IPC_FILED_DUMP
(
exp
, 
pidd
, 
u64_¡ršg
);

362 
	`FRCTWEAK_IPC_FILED_DUMP
(
exp
, 
pidm
, 
u64_¡ršg
);

364 
	`FRCTWEAK_IPC_FILED_DUMP
(
exp
, 
iifd
, 
u16_¡ršg
);

365 
	`FRCTWEAK_IPC_FILED_DUMP
(
exp
, 
iifm
, 
u16_¡ršg
);

368 ià(!
	`¡rÿ£cmp
("ş—r", 
¬gv
[1]))

370 
rv
 = 
	`äùw—k_c_exp_ş—r
();

374 
rv
 = 
	`äÿpi_c_exp_g‘
(&
exp
);

376 ià(
FRE_SUCCESS
 !ğ
rv
)

378 
	`´štf
("ERROR: ipøex°g‘ fa!Ôv=%d)\n", 
rv
);

379  
rv
;

381 
	`sw­_buff
((
c_exp_t
)>>3, &
exp
);

383 
	`äùw—k_¬g_·r£r_š™
(&
·r£r
);

385 
	`äùw—k_¬g_·r£r_add
(&
·r£r
,"ouid", 
·r£_u16
, &
exp
.
ouid
);

386 
	`äùw—k_¬g_·r£r_add
(&
·r£r
,"pidd", 
·r£_u64
, &
exp
.
pidd
);

387 
	`äùw—k_¬g_·r£r_add
(&
·r£r
,"iifd", 
·r£_u16
, &
exp
.
iifd
);

389 
	`äùw—k_¬g_·r£r_add
(&
·r£r
,"ouim", 
·r£_u16
, &
exp
.
ouim
);

390 
	`äùw—k_¬g_·r£r_add
(&
·r£r
,"pidm", 
·r£_u64
, &
exp
.
pidm
);

391 
	`äùw—k_¬g_·r£r_add
(&
·r£r
,"iifm", 
·r£_u16
, &
exp
.
iifm
);

393 
rv
 = 
	`äùw—k_¬g_·rsšg
(&
·r£r
, 
¬gc
, 
¬gv
);

395 
	`äùw—k_¬g_·r£r_ä“
(&
·r£r
);

397 ià(
FRE_SUCCESS
 !ğ
rv
)

399 
	`äùw—k_cmd_c_u§ge
();

400  
FRE_PARAM
;

402 
	`´štf
("RRRR :ouid =%d, ouim=%d, iifd=%d, iifm=%d\n", 
exp
.
ouid
,ƒxp.
ouim
,ƒxp.
iifd
,ƒxp.
iifm
);

404 
rv
 = 
	`äÿpi_c_exp_£t
(&
exp
);

406 ià(
FRE_SUCCESS
 =ğ
rv
)

408 
	`´štf
("IPCƒxp set success.\n");

412 
	`´štf
("E¼Ü: IPCƒx°£ˆç!Ôv=%d)\n", 
rv
);

416  
rv
;

418 
	}
}

420 
	$äùw—k_c_š¡r_ş—r
()

422 
rv
;

423 
c_š¡r_t
 
š¡r
;

425 
	`mem£t
(&
š¡r
, 0, (
c_š¡r_t
));

427 
rv
 = 
	`äÿpi_c_š¡r_£t
(&
š¡r
);

429 ià(
FRE_SUCCESS
 =ğ
rv
)

431 
	`´štf
("IPC instr„eset success.\n");

435 
	`´štf
("E¼Ü: IPC in¡¸»£ˆç!Ôv=%d)\n", 
rv
);

438  
rv
;

439 
	}
}

441 
	#LINE_SZ
 32

	)

443 
	$·ylßd_dump
(
Ën
, *
buff
)

445 
i
;

447 
i
 = 0; i < 
Ën
; i++)

449 ià(0 =ğ(
i
 % 
LINE_SZ
))

451 
	`´štf
(" ");

453 ià(((
LINE_SZ
 - 1è=ğ(
i
 % LINE_SZ)è|| (˜=ğ(
Ën
 - 1)))

455 
	`´štf
("\n");

459 
	`´štf
(" %.2x", 
buff
[
i
]);

462 
	}
}

464 
	$·r£_·ylßd
(*
fe
, *
buff
)

466 
Ën
 = 0;

467 
c
 = 0;

468 
lše
[256];

469 
FILE
 *
å
 = 
NULL
;

471 
rv
 = 
	`sy¡em
("dir…ayload.txt");

472 ià(
rv
)

474 
	`´štf
("cao\n");

476 
	`´štf
("fe=%s\n", 
fe
);

477 
å
 = 
	`fİ’
(
fe
 , "r");

479 ià(
NULL
 =ğ
å
)

481  
FRE_OPEN
;

484 
	`mem£t
(
lše
, 0, 256);

485 
	`fg‘s
(
lše
, 256, 
å
è!ğ
NULL
)

488 
Ën
 = 
	`¡¾’
(
lše
);

490 *
p
;

491 
p
=
	`¡¹ok
(
lše
," ");

492 
p
)

495 ià(
c
 >ğ
IPC_IP_LEN_MAX
)

497  
FRE_FAIL
;

499 ià(
	`·r£_u8
(
p
, &
buff
[
c
++]))

501  
FRE_FAIL
;

503 
p
=
	`¡¹ok
(
NULL
," ");

507  
FRE_SUCCESS
;

508 
	}
}

510 
	$äùw—k_cmd_c_š¡r
(
¬gc
, **
¬gv
)

512 
ušt64_t
 
i
 = 0, 
n
 = 0;

513 
rv
 = 0;

514 
c_š¡r_t
 
š¡r
 = {};

515 
c_·ylßd_£t_š_t
 
·ylßd_£t
 = {};

516 
¬g_·r£r_t
 
·r£r
;

518 ià(1 =ğ
¬gc
)

520 
rv
 = 
	`äÿpi_c_š¡r_g‘
(&
š¡r
.
š¡r_cfg
);

522 ià(
FRE_SUCCESS
 !ğ
rv
)

524 
	`´štf
("ERROR: ipøš¡¸g‘ fa!Ôv=%d)\n", 
rv
);

525  
rv
;

527 
	`sw­_buff
((
c_š¡r_cfg_t
è>> 3, &
š¡r
.
š¡r_cfg
);

529 
	`´štf
("IPC instr:\n");

542 
	`FRCTWEAK_IPC_FILED_DUMP
(
š¡r
.
š¡r_cfg
, 
s_d©a
, 
ä_v4_¡ršg
);

543 
	`FRCTWEAK_IPC_FILED_DUMP
(
š¡r
.
š¡r_cfg
, 
s_mask
, 
ä_v4_¡ršg
);

544 
	`FRCTWEAK_IPC_FILED_DUMP
(
š¡r
.
š¡r_cfg
, 
d_d©a
, 
ä_v4_¡ršg
);

545 
	`FRCTWEAK_IPC_FILED_DUMP
(
š¡r
.
š¡r_cfg
, 
d_mask
, 
ä_v4_¡ršg
);

546 
	`FRCTWEAK_IPC_FILED_DUMP
(
š¡r
.
š¡r_cfg
, 
ty³
, 
ä_u32_¡ršg
);

547 
	`FRCTWEAK_IPC_FILED_DUMP
(
š¡r
.
š¡r_cfg
, 
_Ën
, 
ä_u32_¡ršg
);

548 
	`FRCTWEAK_IPC_FILED_DUMP
(
š¡r
.
š¡r_cfg
, 
tx_pÜt
, 
ä_u32_¡ršg
);

549 
	`FRCTWEAK_IPC_FILED_DUMP
(
š¡r
.
š¡r_cfg
, 
aùiÚ
, 
ä_u32_¡ršg
);

552 
	`·ylßd_dump
(
š¡r
.
š¡r_cfg
.
_Ën
, in¡r.
·ylßd
);

554 
rv
 = 
FRE_SUCCESS
;

556 ià(!
	`¡rÿ£cmp
("ş—r", 
¬gv
[1]))

558 
rv
 = 
	`äùw—k_c_š¡r_ş—r
();

562 
rv
 = 
	`äÿpi_c_š¡r_g‘
(&
š¡r
.
š¡r_cfg
);

564 ià(
FRE_SUCCESS
 !ğ
rv
)

566 
	`´štf
("ERROR: ipøš¡¸g‘ fa!Ôv=%d)\n", 
rv
);

567  
rv
;

570 
	`sw­_buff
((
c_š¡r_cfg_t
è>> 3, &
š¡r
.
š¡r_cfg
);

572 
	`äùw—k_¬g_·r£r_š™
(&
·r£r
);

573 
	`äùw—k_¬g_·r£r_add
(&
·r£r
,"sd", 
·r£_v4
, &
š¡r
.
š¡r_cfg
.
s_d©a
);

574 
	`äùw—k_¬g_·r£r_add
(&
·r£r
,"sm", 
·r£_v4
, &
š¡r
.
š¡r_cfg
.
s_mask
);

575 
	`äùw—k_¬g_·r£r_add
(&
·r£r
,"dd", 
·r£_v4
, &
š¡r
.
š¡r_cfg
.
d_d©a
);

576 
	`äùw—k_¬g_·r£r_add
(&
·r£r
,"dm", 
·r£_v4
, &
š¡r
.
š¡r_cfg
.
d_mask
);

577 
	`äùw—k_¬g_·r£r_add
(&
·r£r
,"ty³", 
·r£_u16
, &
š¡r
.
š¡r_cfg
.
ty³
);

578 
	`äùw—k_¬g_·r£r_add
(&
·r£r
,"_Ën", 
·r£_u16
, &
š¡r
.
š¡r_cfg
.
_Ën
);

579 
	`äùw—k_¬g_·r£r_add
(&
·r£r
,"tx_pÜt", 
·r£_u16
, &
š¡r
.
š¡r_cfg
.
tx_pÜt
);

580 
	`äùw—k_¬g_·r£r_add
(&
·r£r
,"aùiÚ", 
·r£_u16
, &
š¡r
.
š¡r_cfg
.
aùiÚ
);

581 
	`äùw—k_¬g_·r£r_add
(&
·r£r
,"·ylßd", 
·r£_·ylßd
, 
š¡r
.
·ylßd
);

583 
rv
 = 
	`äùw—k_¬g_·rsšg
(&
·r£r
, 
¬gc
, 
¬gv
);

585 
	`äùw—k_¬g_·r£r_ä“
(&
·r£r
);

587 
i
 = 0; i < 
INSTR_PAYLOAD_SZ
; i++)

592 ià(
FRE_SUCCESS
 !ğ
rv
)

594 
	`äùw—k_cmd_c_u§ge
();

595  
FRE_PARAM
;

598 
rv
 = 
	`äÿpi_c_š¡r_£t
(&
š¡r
.
š¡r_cfg
);

600 ià(
FRE_SUCCESS
 =ğ
rv
)

602 
	`´štf
("IPC instr set success.\n");

606 
	`´štf
("E¼Ü: IPC in¡¸£ˆç!Ôv=%d)\n", 
rv
);

607  
rv
;

609 
n
 = 
IPC_IP_LEN_MAX
 / 
INSTR_PAYLOAD_SZ
;

610 
	`´štf
("Àğ%d\n", 
n
);

611 
i
 = 0; i < 
n
; i++)

613 
	`memıy
(
·ylßd_£t
.
d©a
, &
š¡r
.
·ylßd
[
i
 * 
INSTR_PAYLOAD_SZ
], INSTR_PAYLOAD_SZ);

614 
·ylßd_£t
.
šdex
 = 
i
;

615 
rv
 = 
	`äÿpi_c_š¡r_·ylßd_£t
(&
·ylßd_£t
);

616 ià(
FRE_SUCCESS
 !ğ
rv
)

618 
	`´štf
("E¼Ü: IPC in¡¸£ˆç!Ôv=%d)\n", 
rv
);

619  
rv
;

624  
rv
;

625 
	}
}

628 
	$äùw—k_cmd_c_ş—r
()

630 
	`äùw—k_c_misc_ş—r
();

631 
	`äùw—k_c_cur_ş—r
();

632 
	`äùw—k_c_exp_ş—r
();

633 
	`äùw—k_c_š¡r_ş—r
();

635 
	}
}

637 
	$äùw—k_cmd_c
(
¬gc
, **
¬gv
)

639 
rv
 = 0;

640 ià(
¬gc
 < 2)

642 
	`äùw—k_cmd_c_u§ge
();

643  
FRE_SUCCESS
;

645 ià(!
	`¡rcmp
("misc", 
¬gv
[1]))

647 
rv
 = 
	`äùw—k_cmd_c_misc
(--
¬gc
, ++
¬gv
);

649 ià(!
	`¡rcmp
("š¡r", 
¬gv
[1]))

651 
rv
 = 
	`äùw—k_cmd_c_š¡r
(--
¬gc
, ++
¬gv
);

653 ià(!
	`¡rcmp
("exp", 
¬gv
[1]))

655 
rv
 = 
	`äùw—k_cmd_c_exp
(--
¬gc
, ++
¬gv
);

657 ià(!
	`¡rcmp
("cur", 
¬gv
[1]))

659 
rv
 = 
	`äùw—k_cmd_c_cur
(--
¬gc
, ++
¬gv
);

661 ià(!
	`¡rcmp
("vÏn_hash", 
¬gv
[1]))

663 
rv
 = 
	`äùw—k_cmd_c_vÏn_hash
(--
¬gc
, ++
¬gv
);

665 ià(!
	`¡rcmp
("ş—r", 
¬gv
[1]))

667 
rv
 = 
	`äùw—k_cmd_c_ş—r
();

671 
	`äùw—k_cmd_c_u§ge
();

672  
FRE_SUCCESS
;

675  
rv
;

676 
	}
}

678 
	$äùw—k_c_cmd_š™
(
äùw—k_cmd_t
 *
cmd
)

680 
	`äùw—k_cmd_»gi¡”
(
cmd
, "c", "FS9000 IPC s‘tšg", 
äùw—k_cmd_c
, 
äùw—k_cmd_c_u§ge
);

682 
	}
}

	@frctweak/frctweak_mac_stat.c

1 
	~<¡dlib.h
>

2 
	~<¡ršg.h
>

3 
	~<¡dšt.h
>

4 
	~"äùw—k.h
"

5 
	~"äc_·ck.h
"

6 
	~"äc_dma.h
"

7 
	~"cvmx-sw­.h
"

8 
	~"äc_­i.h
"

9 
	~"äc_debug.h
"

10 #ià
FRC_CONFIG_MAC_STATISTICS


12 
	#MAX_MAC_NUM
 512

	)

14 
	#HASH_SIP
 0

	)

15 
	#HASH_DIP
 1

	)

16 
	#HASH_SIP_DIP
 2

	)

17 
	#HASH_FIVE_TUPLE
 3

	)

19 
	#HEART_BEAT_OFF
 0

	)

20 
	#HEART_BEAT_ON
 1

	)

21 
	#HEART_BEAT_ON_WITH_DROP
 2

	)

23 
	#IP_TOS
 1

	)

24 
	#IP_TTL
 2

	)

27 
	$äùw—k_cmd_mac_¡©_u§ge
()

29 
	`´štf
("U§ge: % mac_¡©‡dd maø<maøadd»ss>\n", 
´og¿m
);

30 
	`´štf
(" % mac_¡©‡dd maøšø<num> <¡•> <maøadd»ss>\n", 
´og¿m
);

31 
	`´štf
(" % mac_¡© d– maø<maøadd»ss>\n", 
´og¿m
);

32 
	`´štf
(" % mac_¡© d–‡Î\n", 
´og¿m
);

33 
	`´štf
(" % mac_¡© cË¬ couÁ” <maøadd»ss>\n", 
´og¿m
);

34 
	`´štf
(" % mac_¡© cË¬‡Î\n", 
´og¿m
);

35 
	`´štf
(" % mac_¡© show couÁ” <maøadd»ss>\n", 
´og¿m
);

36 
	`´štf
(" % mac_¡© show‡Î\n", 
´og¿m
);

37 
	`´štf
(" % mac_¡© s‘_hash <s | d | s_d | five_tu¶e>\n", 
´og¿m
);

38 
	`´štf
(" % mac_¡© h—¹_b—ˆ<Ú | ofà| on_w™h_drİ>\n", 
´og¿m
);

39 
	`´štf
(" % mac_¡© s‘_ <to |> <num>\n", 
´og¿m
);

40 
	`´štf
("Example: \n");

41 
	`´štf
(" % mac_¡©‡dd maø00:21:45:¯:bb:cc\n", 
´og¿m
);

42 
	}
}

44 
ušt64_t
 
	$äùw—k_’dŸn_sw­_64
(
ušt64_t
 
x
)

46 
x
 = ((x << 8) & 0xFF00FF00FF00FF00ULL) | ((x >> 8) & 0x00FF00FF00FF00FFULL);

47 
x
 = ((x << 16) & 0xFFFF0000FFFF0000ULL) | ((x >> 16) & 0x0000FFFF0000FFFFULL);

48  (
x
>>32) | (x<<32);

49 
	}
}

51 
	$äùw—k_mac_¡r2št
(*
mac
, 
ušt64_t
 *
mac_num
)

53 *
¡r
 = 
	`m®loc
(
	`¡¾’
(
mac
) + 1);

54 ià(
¡r
 =ğ
NULL
)

56 
	`FRC_DEBUG
(0, "mallocƒrror\n");

57  
FRE_NOSPACE
;

60 
	`mem£t
(
¡r
, 0, 
	`¡¾’
(
mac
) + 1);

61 
	`¡rıy
(
¡r
, 
mac
);

62 
m
[6] = {0};

63 *
tmp
 = 
¡r
;

64 
i
;

65 
i
 = 0; i < 5; i++)

67 
tmp
 = 
	`¡r¡r
(tmp, ":");

68 ià(
tmp
 =ğ
NULL
)

70 
	`FRC_DEBUG
(0, "mac formatƒrror\n");

71 
”r
;

75 *
tmp
 = '\0';

76 
tmp
++;

80 
tmp
 = 
¡r
;

82 
i
 = 0; i < 6; i++)

84 
m
[
i
] = ()(
	`¡¹oul
(
tmp
, 
NULL
, 16));

85 
tmp
 +ğ
	`¡¾’
(tmp) + 1;

88 
ušt64_t
 
mac_tmp
 = 0;

89 
ušt64_t
 
t
;

90 
i
 = 5; i >= 0; i--)

92 
t
 = 0xff;

93 
t
 = 
m
[5 - 
i
] &;

94 
mac_tmp
 = mac_tm°| (
t
 << (
i
 * 8));

96 *
mac_num
 = 
mac_tmp
;

97  
FRE_SUCCESS
;

98 
”r
:

99 
	`ä“
(
¡r
);

100  
FRE_PARAM
;

101 
	}
}

103 
	$äùw—k_mac_št2¡r
(
ušt64_t
 
imac
, *
mac
)

105 
cmac
[6] = {0};

106 
ušt64_t
 
tmp
;

107 
i
;

108 
i
 = 0; i < 6; i++)

110 
tmp
 = 
imac
 & 0xff;

111 
cmac
[
i
] = ()
tmp
;

112 
imac
 = imac >> 8;

115 
	`¥rštf
(
mac
, "%02x:%02x:%02x:%02x:%02x:%02x", 
cmac
[5], cmac[4], cmac[3], cmac[2], cmac[1], cmac[0]);

116  
FRE_SUCCESS
;

117 
	}
}

119 
	$äùw—k_cmd_mac_¡©_£t_hash_mode
(*
hash_mode
)

121 
ušt64_t
 
hash
;

122 ià(!
	`¡rcmp
(
hash_mode
, "sip"))

124 
hash
 = 
HASH_SIP
;

126 ià(!
	`¡rcmp
(
hash_mode
, "dip"))

128 
hash
 = 
HASH_DIP
;

130 ià(!
	`¡rcmp
(
hash_mode
, "sip_dip"))

132 
hash
 = 
HASH_SIP_DIP
;

134 ià(!
	`¡rcmp
(
hash_mode
, "five_tuple"))

136 
hash
 = 
HASH_FIVE_TUPLE
;

140 
	`´štf
("hash mode‡rgumentsƒrror!!!\n");

141  
FRE_FAIL
;

144 
äc_mac_¡©_š_t
 
šput
;

145 
šput
.
mac
 = 
hash
;

146 
šput
.
couÁ”
 = 0;

148 
rv
 = 
	`äÿpi_mac_¡©_£t
(&
šput
, 
USER_CMD_MAC_STAT_SET_HASH_MODE
);

149 ià(
rv
 !ğ
FRE_SUCCESS
)

151 
	`´štf
("set hash modeƒrror!\n");

152  
FRE_FAIL
;

154  
FRE_SUCCESS
;

155 
	}
}

157 
	$äùw—k_cmd_mac_¡©_h—¹_b—t
(*
h—¹
)

159 
äc_mac_¡©_š_t
 
šput
;

160 ià(!
	`¡rcmp
(
h—¹
, "on"))

162 
šput
.
mac
 = 
HEART_BEAT_ON
;

164 ià(!
	`¡rcmp
(
h—¹
, "off"))

166 
šput
.
mac
 = 
HEART_BEAT_OFF
;

168 ià(!
	`¡rcmp
(
h—¹
, "on_with_drop"))

170 
šput
.
mac
 = 
HEART_BEAT_ON_WITH_DROP
;

174 
	`´štf
("heart beat‡rgumentsƒrror!\n");

175  
FRE_FAIL
;

178 
šput
.
couÁ”
 = 0;

179 
rv
 = 
	`äÿpi_mac_¡©_£t
(&
šput
, 
USER_CMD_MAC_STAT_HEART_BEAT
);

180 ià(
rv
 !ğ
FRE_SUCCESS
)

182 
	`´štf
("set heart beatƒrror!\n");

183  
FRE_FAIL
;

185  
FRE_SUCCESS
;

186 
	}
}

188 
	$äùw—k_cmd_mac_¡©_£t_
(*
ty³
, 
v®ue
)

190 
äc_mac_¡©_š_t
 
šput
;

191 ià(!
	`¡rcmp
(
ty³
, "tos"))

193 
šput
.
mac
 = 
IP_TOS
;

195 ià(!
	`¡rcmp
(
ty³
, "ttl"))

197 
šput
.
mac
 = 
IP_TTL
;

201 
	`´štf
("ip header‡rgumentsƒrror!\n");

202  
FRE_FAIL
;

204 
šput
.
couÁ”
 = 
v®ue
;

206 
rv
 = 
	`äÿpi_mac_¡©_£t
(&
šput
, 
USER_CMD_MAC_STAT_SET_IP
);

207 ià(
rv
 !ğ
FRE_SUCCESS
)

209 
	`´štf
("set ip headerƒrror!\n");

210  
FRE_FAIL
;

212  
rv
;

213 
	}
}

215 
	$äùw—k_cmd_mac_¡©_add_mac
(*
mac
)

217 
ušt64_t
 
imac
;

218 
rv
 = 
	`äùw—k_mac_¡r2št
(
mac
, &
imac
);

219 ià(
rv
 !ğ
FRE_SUCCESS
)

221 
	`FRC_DEBUG
(0, "add macƒrror!\n");

222  
FRE_FAIL
;

225 
äc_mac_¡©_š_t
 
šput
;

226 
šput
.
mac
 = 
imac
;

227 
šput
.
couÁ”
 = 0;

228 
rv
 = 
	`äÿpi_mac_¡©_£t
(&
šput
, 
USER_CMD_MAC_STAT_ADD_MAC
);

229 ià(
rv
 =ğ
FRE_SUCCESS
)

231 
	`´štf
("add % OK!\n", 
mac
);

235 
	`´štf
("add % ERR!\n", 
mac
);

238  
rv
;

239 
	}
}

241 
	$äùw—k_cmd_mac_¡©_add_mac_šc
(*
mac
, 
num
, 
¡•
)

243 
ušt64_t
 
imac
;

244 
	`äùw—k_mac_¡r2št
(
mac
, &
imac
);

245 
mac_¡r
[64];

246 ; 
num
 > 0;‚um--)

248 
	`mem£t
(
mac_¡r
, 0, 64);

249 
	`äùw—k_mac_št2¡r
(
imac
, &(
mac_¡r
[0]));

250 
	`äùw—k_cmd_mac_¡©_add_mac
(&
mac_¡r
);

251 
imac
 = imaø+ 
¡•
;

254  
FRE_SUCCESS
;

255 
	}
}

257 
	$äùw—k_cmd_mac_¡©_d–_mac
(*
mac
)

259 
ušt64_t
 
imac
;

260 
rv
 = 
	`äùw—k_mac_¡r2št
(
mac
, &
imac
);

261 ià(
rv
 !ğ
FRE_SUCCESS
)

263 
	`´štf
("del macƒrror!\n");

264  
FRE_FAIL
;

267 
äc_mac_¡©_š_t
 
šput
;

268 
šput
.
mac
 = 
imac
;

269 
šput
.
couÁ”
 = 0;

271 
rv
 = 
	`äÿpi_mac_¡©_£t
(&
šput
, 
USER_CMD_MAC_STAT_DEL_MAC
);

272 ià(
rv
 =ğ
FRE_SUCCESS
)

274 
	`´štf
("d– % OK!\n", 
mac
);

278 
	`´štf
("d– % ERR!\n", 
mac
);

281  
rv
;

282 
	}
}

284 
	$äùw—k_cmd_mac_¡©_d–_®l
()

286 
rv
 = 
	`äÿpi_mac_¡©_£t
(
NULL
, 
USER_CMD_MAC_STAT_DEL_ALL
);

287 ià(
rv
 =ğ
FRE_SUCCESS
)

289 
	`´štf
("del‡ll OK!\n");

293 
	`´štf
("del‡ll ERR!\n");

296  
rv
;

297 
	}
}

299 
	$äùw—k_cmd_mac_¡©_ş—r_couÁ”
(*
mac
)

301 
ušt64_t
 
imac
;

302 
rv
 = 
	`äùw—k_mac_¡r2št
(
mac
, &
imac
);

303 ià(
rv
 !ğ
FRE_SUCCESS
)

305 
	`´štf
("clear counterƒrror!\n");

306  
FRE_FAIL
;

309 
äc_mac_¡©_š_t
 
šput
;

310 
šput
.
mac
 = 
imac
;

311 
šput
.
couÁ”
 = 0;

313 
rv
 = 
	`äÿpi_mac_¡©_£t
(&
šput
, 
USER_CMD_MAC_STAT_CLEAR_COUNTER
);

314 ià(
rv
 =ğ
FRE_SUCCESS
)

316 
	`´štf
("ş—¸% couÁ” OK!\n", 
mac
);

320 
	`´štf
("ş—¸% couÁ” ERR!\n", 
mac
);

323  
rv
;

325 
	}
}

327 
	$äùw—k_cmd_mac_¡©_ş—r_®l
()

329 
rv
 = 
	`äÿpi_mac_¡©_£t
(
NULL
, 
USER_CMD_MAC_STAT_CLEAR_ALL_COUNTER
);

330 ià(
rv
 =ğ
FRE_SUCCESS
)

332 
	`´štf
("clear‡ll mac counter OK!\n");

336 
	`´štf
("clear‡ll mac counter ERR!\n");

339  
rv
;

341 
	}
}

343 
	$äùw—k_cmd_mac_¡©_show_couÁ”
(*
mac
)

345 
ušt64_t
 
imac
;

346 
mac_¡r
[64];

347 
	`mem£t
(
mac_¡r
, 0, 64);

348 
rv
 = 
	`äùw—k_mac_¡r2št
(
mac
, &
imac
);

349 ià(
rv
 !ğ
FRE_SUCCESS
)

351 
	`´štf
("show counterƒrror!\n");

352  
FRE_FAIL
;

355 
äc_mac_¡©_š_t
 
šput
;

356 
šput
.
mac
 = 
imac
;

357 
šput
.
couÁ”
 = 0;

359 
äc_mac_¡©_out_t
 
ouut
;

360 
ouut
.
mac
 = 0;

361 
ouut
.
tÙ®
 = 0;

362 
ouut
.
”rÜs
 = 0;

363 
rv
 = 
	`äÿpi_mac_¡©_g‘
(&
šput
, &
ouut
, 
USER_CMD_MAC_STAT_SHOW_COUNTER
);

364 ià(
rv
 =ğ
FRE_SUCCESS
)

366 
ouut
.
mac
 = 
	`äùw—k_’dŸn_sw­_64
(output.mac);

367 
ouut
.
tÙ®
 = 
	`äùw—k_’dŸn_sw­_64
(output.total);

368 
ouut
.
”rÜs
 = 
	`äùw—k_’dŸn_sw­_64
(output.errors);

369 
	`äùw—k_mac_št2¡r
(
ouut
.
mac
, 
mac_¡r
);

370 
	`´štf
("mac: %  \‰Ù®: %lu\t\‹¼Üs:%lu\n", 
mac_¡r
, 
ouut
.
tÙ®
, ouut.
”rÜs
);

374 
	`´štf
("show % couÁ” ERR!\n", 
mac
);

377  
rv
;

379 
	}
}

381 
	$äùw—k_cmd_mac_¡©_show_®l
()

383 
rv
;

384 
äc_mac_¡©_š_t
 
šput
;

385 
ušt8_t
 
mac
[64];

386 
äc_mac_¡©_out_t
 
ouut
;

387 
ušt64_t
 
i
;

389 
i
 = 0; i <ğ
MAX_MAC_NUM
; i++)

391 
šput
.
mac
 = 
i
;

392 
šput
.
couÁ”
 = 0;

393 
	`mem£t
(&
ouut
, 0, (
äc_mac_¡©_out_t
));

394 
rv
 = 
	`äÿpi_mac_¡©_g‘_®l
(&
šput
, &
ouut
, 3, 
USER_CMD_MAC_STAT_SHOW_ALL_COUNTER
);

395 ià(
rv
 =ğ
FRE_SUCCESS
)

397 
	`mem£t
(
mac
, 0, 64);

398 
ouut
.
mac
 = 
	`äùw—k_’dŸn_sw­_64
(output.mac);

399 
ouut
.
tÙ®
 = 
	`äùw—k_’dŸn_sw­_64
(output.total);

400 
ouut
.
”rÜs
 = 
	`äùw—k_’dŸn_sw­_64
(output.errors);

401 
	`äùw—k_mac_št2¡r
(
ouut
.
mac
, mac);

402 
	`´štf
("mac: %  \‰Ù®: %lu\t\‹¼Üs:%lu\n", 
mac
, 
ouut
.
tÙ®
, ouut.
”rÜs
);

410  
FRE_SUCCESS
;

411 
	}
}

413 
	$äùw—k_cmd_mac_¡©
(
¬gc
, **
¬gv
)

415 ià(
¬gc
 < 3)

417 
	`äùw—k_cmd_mac_¡©_u§ge
();

418  
FRE_SUCCESS
;

420 ià(!
	`¡rcmp
(
¬gv
[1], "add"))

422 ià(!
	`¡rcmp
(
¬gv
[2], "mac"))

424 ià(
¬gc
 == 4)

426  
	`äùw—k_cmd_mac_¡©_add_mac
(
¬gv
[3]);

428 ià(
¬gc
 == 7)

430 ià(!
	`¡rcmp
(
¬gv
[3], "inc"))

432  
	`äùw—k_cmd_mac_¡©_add_mac_šc
(
¬gv
[6], 
	`©oi
(argv[4]),‡toi(argv[5]));

436 
	`äùw—k_cmd_mac_¡©_u§ge
();

437  
FRE_SUCCESS
;

442 
	`äùw—k_cmd_mac_¡©_u§ge
();

443  
FRE_SUCCESS
;

448 
	`äùw—k_cmd_mac_¡©_u§ge
();

449  
FRE_FAIL
;

452 ià(!
	`¡rcmp
(
¬gv
[1], "del"))

454 ià(
¬gc
 == 3)

456 ià(!
	`¡rcmp
(
¬gv
[2], "all"))

458  
	`äùw—k_cmd_mac_¡©_d–_®l
();

463 
	`äùw—k_cmd_mac_¡©_u§ge
();

464  
FRE_SUCCESS
;

467 ià(
¬gc
 ==4 && (!
	`¡rcmp
(
¬gv
[2], "mac")))

469  
	`äùw—k_cmd_mac_¡©_d–_mac
(
¬gv
[3]);

473 
	`äùw—k_cmd_mac_¡©_u§ge
();

474  
FRE_SUCCESS
;

477 ià(!
	`¡rcmp
(
¬gv
[1], "clear"))

479 ià(
¬gc
 == 3)

481 ià(!
	`¡rcmp
(
¬gv
[2], "all"))

483  
	`äùw—k_cmd_mac_¡©_ş—r_®l
();

487 
	`äùw—k_cmd_mac_¡©_u§ge
();

488  
FRE_SUCCESS
;

491 ià(
¬gc
 == 4)

493 ià(!
	`¡rcmp
(
¬gv
[2], "counter"))

495  
	`äùw—k_cmd_mac_¡©_ş—r_couÁ”
(
¬gv
[3]);

499 
	`äùw—k_cmd_mac_¡©_u§ge
();

500  
FRE_SUCCESS
;

505 
	`äùw—k_cmd_mac_¡©_u§ge
();

506  
FRE_SUCCESS
;

509 ià(!
	`¡rcmp
(
¬gv
[1], "show"))

511 ià(
¬gc
 == 3)

513 ià(!
	`¡rcmp
(
¬gv
[2], "all"))

515  
	`äùw—k_cmd_mac_¡©_show_®l
();

519 
	`äùw—k_cmd_mac_¡©_u§ge
();

520  
FRE_SUCCESS
;

523 ià(
¬gc
 == 4)

525 ià(!
	`¡rcmp
(
¬gv
[2], "counter"))

527  
	`äùw—k_cmd_mac_¡©_show_couÁ”
(
¬gv
[3]);

531  
FRE_SUCCESS
;

536 
	`äùw—k_cmd_mac_¡©_u§ge
();

537  
FRE_SUCCESS
;

540 ià(!
	`¡rcmp
(
¬gv
[1], "set_hash"))

542 ià(
¬gc
 != 3)

544 
	`äùw—k_cmd_mac_¡©_u§ge
();

545  
FRE_SUCCESS
;

547  
	`äùw—k_cmd_mac_¡©_£t_hash_mode
(
¬gv
[2]);

549 ià(!
	`¡rcmp
(
¬gv
[1], "heart_beat"))

551 ià(
¬gc
 != 3)

553 
	`äùw—k_cmd_mac_¡©_u§ge
();

554  
FRE_FAIL
;

556  
	`äùw—k_cmd_mac_¡©_h—¹_b—t
(
¬gv
[2]);

558 ià(!
	`¡rcmp
(
¬gv
[1], "set_ip"))

560 ià((!
	`¡rcmp
(
¬gv
[2], "tos")) || (!strcmp(argv[2], "ttl")))

562  
	`äùw—k_cmd_mac_¡©_£t_
(
¬gv
[2], 
	`©oi
(argv[3]));

564 
	`äùw—k_cmd_mac_¡©_u§ge
();

565  
FRE_FAIL
;

568 
	`äùw—k_cmd_mac_¡©_u§ge
();

569  
FRE_SUCCESS
;

571 
	}
}

573 
	$äùw—k_mac_¡©_cmd_š™
(
äùw—k_cmd_t
 *
cmd
)

575 
	`äùw—k_cmd_»gi¡”
(
cmd
, "mac_¡©", "Add‡nd D– maøpkt couÁ”", 
äùw—k_cmd_mac_¡©
, 
äùw—k_cmd_mac_¡©_u§ge
);

577 
	}
}

	@frctweak/frctweak_pr.c

1 
	~<¡dlib.h
>

2 
	~<¡ršg.h
>

4 
	~<time.h
>

5 
	~<sys/mmª.h
>

6 
	~<sys/time.h
>

7 
	~<±h»ad.h
>

9 
	~"äùw—k.h
"

10 
	~"äc_dma.h
"

11 
	~"äc_üc8.h
"

12 
	~"äc_ut.h
"

13 
	~"äc_­i.h
"

15 
	#FRC_MAC_STRING_SIZE
 40

	)

17 
	$äùw—k_cmd_´_u§ge
()

19 
	`´štf
("% (udp|s¢|ruËèOPTIONS\n", 
´og¿m
);

20 
	}
}

22 
	$äùw—k_cmd_´
(
¬gc
, **
¬gv
)

24 
	`´štf
("% (udp|s¢|ruËèOPTIONS\n", 
´og¿m
);

26 
	}
}

28 
	$_¡ršg
(
ušt32_t
 

, *
¡r
)

30 
ušt8_t
 *
c
 = (ušt8_ˆ*)&

;

31 
	`¥rštf
(
¡r
, "%u.%u.%u.%u", 
c
[3], ipc[2], ipc[1], ipc[0]);

32 
	}
}

34 
	$´Ùo_¡ršg
(
ušt16_t
 
´Ùo
, *
¡r
)

36 
´Ùo
)

38 
PROTO_TCP
:

39 
	`¥rštf
(
¡r
, "TCP");

41 
PROTO_UDP
:

42 
	`¥rštf
(
¡r
, "UDP");

44 
PROTO_SCTP
:

45 
	`¥rštf
(
¡r
, "SCTP");

47 
PROTO_ICMP
:

48 
	`¥rštf
(
¡r
, "ICMP");

51 
	`¥rštf
(
¡r
, "UNKOWN");

54 
	}
}

57 
	$äc_dma_h—d”_dump
(
ušt64_t
 
chª_id
, 
äc_dma_hdr_t
 *
h—d”
)

59 
s
[20], 
d
[20], 
´Ùo
[8];

60 
	`_¡ršg
(
h—d”
->
s
, sip);

61 
	`_¡ršg
(
h—d”
->
d
, dip);

62 
	`´Ùo_¡ršg
(
h—d”
->
´ÙocŞ
, 
´Ùo
);

64 
	`´štf
(" CHAN %lld,%u %s %s->%s %d:%d; %d…kts %d bytes, hash 0x%x.\n",

65 (
ULL
è
chª_id
, 
h—d”
->
¡İ_£c
, 
´Ùo
, 
s
, 
d
, h—d”->
¥Üt
, h—d”->
dpÜt
,

66 
h—d”
->
pkt_num
, h—d”->
tÙ®_·yËn
, h—d”->
hash
);

67 
	}
}

70 
	$äc_mac_¡ršg
(
ušt64_t
 
mac
, *
¡r
)

72 
ušt8_t
 *
cmac
;

73 
cmac
 = (
ušt8_t
 *è&
mac
;

74 
	`mem£t
(
¡r
, 0, 
FRC_MAC_STRING_SIZE
);

76 
	`¥rštf
(
¡r
, "%.2x:%.2x:%.2x:%.2x:%.2x:%.2x",

77 
cmac
[0], cmac[1], cmac[2], cmac[3], cmac[4], cmac[5]);

78 
	}
}

81 
	$äc_pkt_šfo_dump
(
äc_dma_pkt_šfo_t
 *
pkt_šfo
)

83 
smac_¡r
[
FRC_MAC_STRING_SIZE
];

84 
dmac_¡r
[
FRC_MAC_STRING_SIZE
];

86 
	`äc_mac_¡ršg
(
pkt_šfo
->
smac
, 
smac_¡r
);

87 
	`äc_mac_¡ršg
(
pkt_šfo
->
dmac
, 
dmac_¡r
);

88 
	`´štf
("INFO: %s -> %s 0x%.8x:0x%.8x offset %d…aylen %d dir %d\n",

89 
smac_¡r
, 
dmac_¡r
,
pkt_šfo
->
£qu’û
,…kt_šfo->
ack_£q
,

90 
pkt_šfo
->
d©a_off£t
,…kt_šfo->
·ylßd_Ën
,…kt_šfo->
dœeùiÚ
);

91 
	}
}

94 
	$äc_pkt_·ylßd_dump
(
·yËn
, 
ušt8_t
 *
·ylßd
)

96 
i
;

97 
	`´štf
("PAYLOAD: %d by‹s.\n", 
·yËn
);

99 
i
 = 0; i < 
·yËn
; i++)

101 ià((
i
 % 16) == 0)

103 
	`´štf
(" %.4x:", 
i
);

105 
	`´štf
(" %.2x", 
·ylßd
[
i
]);

106 ià((
i
 % 16) == 15)

108 
	`´štf
("\n");

111 
	`´štf
("\n");

112 
	}
}

114 
	$äc_¥“d_¡r
(
ušt64_t
 
v®
, *
¡r
, *
´efix
)

117 ià(
v®
 > (10 * 1024 * 1024))

119 
	`¥rštf
(
¡r
, "%ÎdM%s", (
ULL
è(
v®
 / (1024 * 1024)), 
´efix
);

121 ià(
v®
 > (10 *1024))

123 
	`¥rštf
(
¡r
, "%ÎdK%s", (
ULL
è(
v®
 / 1024), 
´efix
);

127 
	`¥rštf
(
¡r
, "%Îd%s", (
ULL
è
v®
, 
´efix
);

129 
	}
}

130 
	#DUMP_STAT_TITLE
 \

131 
	`´štf
(" %5s %16s %16s %9s %9s %16s %16s %16s %16s\n", \

132 "TIME", "RX_BLOCKS", "ERR_BLOCKS", "CUR SPEED", "AVG SPEED", "AVAIL_SPACE", "COMPL_SPACE", "AVAIL_W", "COMPL_W")

	)

133 
timev®
 
	g¡¬t_time
;

134 
	gdump_block
 = 0;

135 
	gdump_šfo
 = 0;

136 
	gdump_·ck‘
 = 0;

137 
	gdump_”r_addr
= 0;

139 #ià
FRC_CONFIG_SIMPLE_PACKAGE


141 
ušt64_t
 
	mrx_blocks
;

142 
ušt64_t
 
	mrx_pkts
;

143 
ušt64_t
 
	mrx_by‹s
;

144 
ušt64_t
 
	mrx_loss
;

145 
ušt64_t
 
	mrx_pos™ive
;

146 
ušt64_t
 
	mrx_»v”£
;

147 
ušt64_t
 
	mrx_”rÜs
;

149 
ušt64_t
 
	mtx_block
;

150 
ušt64_t
 
	mtx_pkts
;

151 
ušt64_t
 
	mtx_by‹s
;

152 
ušt64_t
 
	mtx_”rÜ
;

153 
ušt64_t
 
	mtx_pos™ive
;

154 
ušt64_t
 
	mtx_»v”£
;

155 } 
	tsim¶e_·ckage_¡©_t
;

158 
ušt64_t
 
	mty³
;

159 
sim¶e_·ckage_¡©_t
 
	mä_¡©
;

160 
äc_dma_chª_desc_t
 
	mdesc
;

161 
äc_dma_sim¶e_·ckage_chª_ù¾_t
 *
	mdma_ù¾
;

162 
ušt8_t
 *
	mpoŞ_addr
;

163 } 
	t´_chª_t
;

165 
±h»ad_t
 
	g´_udp_¡©_th»ad_id
;

166 
±h»ad_t
 
	g´_udp_d©a_th»ad_id
;

168 
sim¶e_·ckage_¡©_t
 
	g¡©_now
, 
	g¡©_Şd
;

172 
äc_sim¶e_·ckage_block_t
 *

173 
	$´_udp_pkt_g‘
(
ušt64_t
 
block_addr
, 
´_chª_t
 *
chª
)

175 
ušt64_t
 
off£t
;

176 
äc_sim¶e_·ckage_block_t
 * 
dma_pkt
 = 
NULL
;

177 
off£t
 = 
block_addr
 - 
chª
->
desc
.
poŞ_addr
;

178 ià(
off£t
 > 
chª
->
desc
.
poŞ_size
)

180  
NULL
;

182 
dma_pkt
 = (
äc_sim¶e_·ckage_block_t
 *)(
chª
->
poŞ_addr
 + 
off£t
);

183  
dma_pkt
;

184 
	}
}

191 
	$´_sim¶e_pkt_g‘
(
äc_sim¶e_·ckage_block_t
 *
dma_pkt
, 
äc_sim¶e_pkt_t
 *
sim¶e_pkt
)

193 ià(
dma_pkt
 =ğ
NULL
 || 
sim¶e_pkt
 == NULL)

195  
FRE_FAIL
;

197 
	`mem£t
(
sim¶e_pkt
, 0, (
äc_sim¶e_pkt_t
));

198 
	`memıy
(&
sim¶e_pkt
->
h—d”
, 
dma_pkt
->
d©a
, 
FRC_DMA_PKT_HEAD_SIZE
);

199 
	`sw­_buff
(
FRC_DMA_PKT_HEAD_SIZE
 >>3, &
sim¶e_pkt
->
h—d”
);

200 
	`memıy
(
sim¶e_pkt
->
·ylßd
, &
dma_pkt
->
d©a
[
FRC_DMA_PKT_PAYLOAD_OFFSET
], sim¶e_pkt->
h—d”
.
tÙ®_·yËn
);

201 
	`memıy
(&
sim¶e_pkt
->
šfo
, &
dma_pkt
->
d©a
[
FRC_DMA_PKT_PAYLOAD_OFFSET
 + sim¶e_pkt->
h—d”
.
tÙ®_·yËn
], 
FRC_DMA_PKT_INFO_SIZE
);

202 
	`sw­_buff
(
FRC_DMA_PKT_INFO_SIZE
 >>3, &
sim¶e_pkt
->
šfo
);

203  
FRE_SUCCESS
;

204 
	}
}

207 
	$´_sim¶e_pkt_´oûss
(
´_chª_t
 *
chª
, 
äc_sim¶e_pkt_t
 *
sim¶e_pkt
)

209 
äc_dma_pkt_šfo_t
 *
pkt_šfo
;

211 
chª
->
ä_¡©
.
rx_blocks
++;

213 ià(
dump_block
)

215 
	`äc_dma_h—d”_dump
(
chª
->
desc
.
ty³
, &
sim¶e_pkt
->
h—d”
);

218 
pkt_šfo
 = &
sim¶e_pkt
->
šfo
;

220 
chª
->
ä_¡©
.
rx_pkts
++;

221 
chª
->
ä_¡©
.
rx_by‹s
 +ğ
sim¶e_pkt
->
h—d”
.
tÙ®_·yËn
;

223 ià(
dump_šfo
)

225 
	`äc_pkt_šfo_dump
(
pkt_šfo
);

228 ià(
dump_·ck‘
)

230 
	`äc_pkt_·ylßd_dump
(
sim¶e_pkt
->
h—d”
.
tÙ®_·yËn
, sim¶e_pkt->
·ylßd
);

232 
	}
}

234 *
	$´_udp_d©a_th»ad
(*
¬g
)

236 
ušt64_t
 
block_addr
;

237 
äc_sim¶e_·ckage_block_t
 *
dma_pkt
 = 
NULL
;

238 
äc_sim¶e_pkt_t
 
sim¶e_pkt
;

239 
time¥ec
 
¦“±ime
;

240 
¦“±ime
.
tv_£c
 = 0;

241 
¦“±ime
.
tv_n£c
 = 10;

242 
´_chª_t
 *
udp_chª
 = (´_chª_ˆ*)
¬g
;

245 ià(
	`SIMPLE_PACKAGE_COMPL_RING_GET
(*
udp_chª
->
dma_ù¾
, 
block_addr
))

247 
dma_pkt
 = 
	`´_udp_pkt_g‘
(
block_addr
, 
udp_chª
);

248 ià(
dma_pkt
 =ğ
NULL
)

250 
udp_chª
->
ä_¡©
.
rx_”rÜs
++;

253  ià(
	`´_sim¶e_pkt_g‘
(
dma_pkt
, &
sim¶e_pkt
))

255 
udp_chª
->
ä_¡©
.
rx_”rÜs
++;

258 #ià
FRC_DEBUG_PKT_LEN


259 
	`äc_dump_buff
(
FRC_DMA_SIMPLE_PACKAGE_DATA_SIZE
, 
dma_pkt
->
d©a
);

260 
	`äc_dump_dma_hdr
(&
sim¶e_pkt
.
h—d”
);

261 
	`äc_dump_dma_pkt_šfo
(&
sim¶e_pkt
.
šfo
);

262 
	`äc_dump_buff
(
sim¶e_pkt
.
h—d”
.
tÙ®_·yËn
, sim¶e_pkt.
·ylßd
);

265 
	`´_sim¶e_pkt_´oûss
(
udp_chª
, &
sim¶e_pkt
);

267 !
	`SIMPLE_PACKAGE_AVAIL_RING_PUT
(*
udp_chª
->
dma_ù¾
, 
block_addr
))

269 
	`Çno¦“p
(&
¦“±ime
, &sleeptime);

274 
	`Çno¦“p
(&
¦“±ime
, &sleeptime);

279 
	`ex™
(1);

280  
NULL
;

281 
	}
}

283 *
	$´_udp_¡©_th»ad
(*
¬g
)

285 
£c
 = 0;

286 
	`´štf
(" %5s %10s %10s %8s %10s %8s %10s\n", "TIME", "RX_BLOCKS", "RX_PKTS", "SPEED", "RX_BYTES", "SPEED", "RX_ERRORS");

287 
ušt64_t
 
rx_pkts
, 
rx_by‹s
, 
rx_blocks
, 
rx_”rÜs
;

288 
ušt64_t
 
rx_by‹s_Şd
 = 0, 
rx_pkts_Şd
 =0, 
rx_by‹s_¥“d
 = 0, 
rx_pkts_¥“d
 = 0;

289 
rx_by‹s_¥“d_¡r
[10];

290 
rx_pkts_¥“d_¡r
[10];

291 
´_chª_t
 *
chª
 = (´_chª_ˆ*è
¬g
;

295 
rx_blocks
 = 
chª
->
ä_¡©
.rx_blocks;

296 
rx_pkts
 = 
chª
->
ä_¡©
.rx_pkts;

297 
rx_by‹s
 = 
chª
->
ä_¡©
.rx_bytes;

298 
rx_”rÜs
 = 
chª
->
ä_¡©
.rx_errors;

300 
rx_by‹s_¥“d
 = 
rx_by‹s
 - 
rx_by‹s_Şd
;

301 
rx_pkts_¥“d
 = 
rx_pkts
 - 
rx_pkts_Şd
;

303 
	`äc_¥“d_¡r
(
rx_by‹s_¥“d
, 
rx_by‹s_¥“d_¡r
, "Bps");

304 
	`äc_¥“d_¡r
(
rx_pkts_¥“d
, 
rx_pkts_¥“d_¡r
, "pps");

305 
	`´štf
("\¸ %5d %10Îd %10Îd %8  %10Îd %8  %10Îd", 
£c
,

306 (
ULL
è
rx_blocks
, (ULLè
rx_pkts
, 
rx_pkts_¥“d_¡r
,

307 (
ULL
è
rx_by‹s
, 
rx_by‹s_¥“d_¡r
, (ULLè
rx_”rÜs
);

308 
	`fæush
(
¡dout
);

310 
£c
++;

311 
rx_by‹s_Şd
 = 
rx_by‹s
;

312 
rx_pkts_Şd
 = 
rx_pkts
;

313 
	`¦“p
(1);

316  
NULL
;

317 
	}
}

319 
	$äùw—k_cmd_´_udp_u§ge
()

321 
	`´štf
("U§ge: % [-bch].\n", 
´og¿m
);

322 
	`´štf
(" -b -- Dump block info.\n");

323 
	`´štf
(" -i -- Dump…kt info.\n");

324 
	`´štf
(" -p -- Dump…acket data.\n");

325 
	`´štf
(" -c -- Dump counter.\n");

326 
	`´štf
(" -h -- Printf help message.\n");

328 
	`ex™
(0);

329 
	}
}

331 
	$äùw—k_cmd_´_udp_¡¬t
(
¬gc
, **
¬gv
)

333 
mfd
 = 0;

335 
rv
;

336 
´_chª_t
 *
udp_chª
 = 
NULL
;

337 
İt
;

338 
dump_couÁ
 = 0;

339 ià(
¬gc
 == 1)

341 
	`äùw—k_cmd_´_udp_u§ge
();

342  
FRE_SUCCESS
;

344 (
İt
 = 
	`g‘İt
(
¬gc
, 
¬gv
, "bfipcvo:TURh?")) != -1) {

345 
İt
) {

347 
dump_block
 = 1;

350 
dump_šfo
 = 1;

353 
dump_·ck‘
 = 1;

356 
dump_couÁ
 = 1;

360 
	`äùw—k_cmd_´_udp_u§ge
();

361  
FRE_SUCCESS
;

366 
udp_chª
 = 
	`m®loc
((
´_chª_t
));

367 
	`mem£t
(
udp_chª
, 0, (
´_chª_t
));

368 
udp_chª
->
ty³
 = 
FRC_WORK_UDP
;

372 
rv
 = 
	`äÿpi_chª_Ü_´_ruË_Ü_udp_¡¬t
(
udp_chª
->
ty³
, &udp_chª->
desc
);

373 ià(
rv
 !ğ
FRE_SUCCESS
)

375 
	`FRCTWEAK_ERROR
("commªdƒxecu‹ fa: %d!\n", 
rv
);

376 
äùw—k_cmd_´_udp_¡¬t_”r
;

379 
	`FRCTWEAK_DEBUG
("udp_chan=%lld, ctlr_addr=%llx, ctrl_size=%llx,"

380 "poŞ_addr=%Îx,…oŞ_size=%Îx\n", (
ULL
)
udp_chª
->
desc
.
ty³
, (ULL)udp_chª->desc.
ù¾_addr
,(ULL)udp_chª->desc.
ù¾_size
,

381 (
ULL
)
udp_chª
->
desc
.
poŞ_addr
, (ULL)udp_chª->desc.
poŞ_size
);

383 
mfd
 = 
	`İ’
("/dev/mem",
O_RDWR
);

384 ià(
mfd
 < 0)

386 
	`FRCTWEAK_ERROR
("Can't open /dev/mem !\n");

387 
rv
 = 
FRE_FAIL
;

388 
äùw—k_cmd_´_udp_¡¬t_”r
;

392 
udp_chª
->
dma_ù¾
 = 
	`mm­
(0, udp_chª->
desc
.
ù¾_size
, 
PROT_READ
|
PROT_WRITE
, 
MAP_SHARED
, 
mfd
, udp_chª->desc.
ù¾_addr
);

393 
	`FRCTWEAK_DEBUG
("udp_chª->dma_ù¾=%p\n", 
udp_chª
->
dma_ù¾
);

394 ià(
udp_chª
->
dma_ù¾
 =ğ
NULL
)

396 
	`FRCTWEAK_ERROR
("mmap udp‡vail„ing fail!\n");

397 
rv
 = 
FRE_MEMORY
;

398 
äùw—k_cmd_´_udp_¡¬t_”r
;

401 
udp_chª
->
poŞ_addr
 = 
	`mm­
(0, udp_chª->
desc
.
poŞ_size
, 
PROT_READ
, 
MAP_SHARED
, 
mfd
, udp_chan->desc.pool_addr);

402 
	`FRCTWEAK_DEBUG
("udp_chª->poŞ_addr=%p\n", 
udp_chª
->
poŞ_addr
);

403 ià(
udp_chª
->
poŞ_addr
 =ğ
NULL
)

405 
	`FRCTWEAK_ERROR
("mmap udp…ool fail!\n");

406 
rv
 = 
FRE_MEMORY
;

407 
äùw—k_cmd_´_udp_¡¬t_”r
;

412 ià(
dump_couÁ
 && !
dump_block
 && !
dump_šfo
 && !
dump_·ck‘
)

414 
´_udp_¡©_th»ad_id
 = 
	`±h»ad_ü—‹
(&´_udp_¡©_th»ad_id, 
NULL
, 
´_udp_¡©_th»ad
, (*)
udp_chª
);

416 
´_udp_d©a_th»ad_id
 = 
	`±h»ad_ü—‹
(&´_udp_d©a_th»ad_id, 
NULL
, 
´_udp_d©a_th»ad
, (*)
udp_chª
);

420 
	`¦“p
(30);

422 
äùw—k_cmd_´_udp_¡¬t_”r
:

423 ià(
mfd
 > 0)

425 
	`şo£
(
mfd
);

427 ià(
rv
)

429  
FRE_FAIL
;

431  
FRE_SUCCESS
;

432 
	}
}

440 
	$´_sim¶e_ruË_pkt_g‘
(
äc_sim¶e_·ckage_block_t
 *
dma_pkt
, 
äc_sim¶e_ruË_pkt_t
 *
sim¶e_pkt
)

442 ià(
dma_pkt
 =ğ
NULL
 || 
sim¶e_pkt
 == NULL)

444  
FRE_FAIL
;

446 
	`mem£t
(
sim¶e_pkt
, 0, (
äc_sim¶e_ruË_pkt_t
));

447 
	`memıy
(&
sim¶e_pkt
->
h—d”
, 
dma_pkt
->
d©a
, 
FRC_DMA_PKT_HEAD_SIZE
);

448 
	`sw­_buff
(
FRC_DMA_PKT_HEAD_SIZE
 >>3, &
sim¶e_pkt
->
h—d”
);

449 
	`memıy
(&
sim¶e_pkt
->
ruË_id
, &
dma_pkt
->
d©a
[
FRC_DMA_PKT_PAYLOAD_OFFSET
], 2);

450 
sim¶e_pkt
->
ruË_id
 = 
	`SWAP_2_BYTE
(simple_pkt->rule_id);

451 
	`memıy
(
sim¶e_pkt
->
·ylßd
, &
dma_pkt
->
d©a
[
FRC_DMA_PKT_PAYLOAD_OFFSET
+2], sim¶e_pkt->
h—d”
.
tÙ®_·yËn
);

452 
	`memıy
(&
sim¶e_pkt
->
šfo
, &
dma_pkt
->
d©a
[
FRC_DMA_PKT_PAYLOAD_OFFSET
 + sim¶e_pkt->
h—d”
.
tÙ®_·yËn
 +2], 
FRC_DMA_PKT_INFO_SIZE
);

453 
	`sw­_buff
(
FRC_DMA_PKT_INFO_SIZE
 >>3, &
sim¶e_pkt
->
šfo
);

454  
FRE_SUCCESS
;

455 
	}
}

458 
	$´_sim¶e_ruË_pkt_´oûss
(
´_chª_t
 *
chª
, 
äc_sim¶e_ruË_pkt_t
 *
sim¶e_pkt
)

460 
äc_dma_pkt_šfo_t
 *
pkt_šfo
;

462 
chª
->
ä_¡©
.
rx_blocks
++;

464 ià(
dump_block
)

466 
	`äc_dma_h—d”_dump
(
chª
->
desc
.
ty³
, &
sim¶e_pkt
->
h—d”
);

469 
pkt_šfo
 = &
sim¶e_pkt
->
šfo
;

471 
chª
->
ä_¡©
.
rx_pkts
++;

472 
chª
->
ä_¡©
.
rx_by‹s
 +ğ
sim¶e_pkt
->
h—d”
.
tÙ®_·yËn
;

474 ià(
dump_šfo
)

476 
	`äc_pkt_šfo_dump
(
pkt_šfo
);

479 ià(
dump_·ck‘
)

481 
	`´štf
("RuË Index: %d\n", 
sim¶e_pkt
->
ruË_id
);

482 
	`äc_pkt_·ylßd_dump
(
sim¶e_pkt
->
h—d”
.
tÙ®_·yËn
, sim¶e_pkt->
·ylßd
);

484 
	}
}

487 *
	$´_ruË_d©a_th»ad
(*
¬g
)

489 
ušt64_t
 
block_addr
;

490 
äc_sim¶e_·ckage_block_t
 *
dma_pkt
 = 
NULL
;

491 
äc_sim¶e_ruË_pkt_t
 
sim¶e_pkt
;

492 
time¥ec
 
¦“±ime
;

493 
¦“±ime
.
tv_£c
 = 0;

494 
¦“±ime
.
tv_n£c
 = 10;

495 
´_chª_t
 *
udp_chª
 = (´_chª_ˆ*)
¬g
;

498 ià(
	`SIMPLE_PACKAGE_COMPL_RING_GET
(*
udp_chª
->
dma_ù¾
, 
block_addr
))

500 
dma_pkt
 = 
	`´_udp_pkt_g‘
(
block_addr
, 
udp_chª
);

501 ià(
dma_pkt
 =ğ
NULL
)

503 
udp_chª
->
ä_¡©
.
rx_”rÜs
++;

506  ià(
	`´_sim¶e_ruË_pkt_g‘
(
dma_pkt
, &
sim¶e_pkt
))

508 
udp_chª
->
ä_¡©
.
rx_”rÜs
++;

511 #ià
FRC_DEBUG_PKT_LEN


512 
	`äc_dump_buff
(
FRC_DMA_SIMPLE_PACKAGE_DATA_SIZE
, 
dma_pkt
->
d©a
);

513 
	`äc_dump_dma_hdr
(&
sim¶e_pkt
.
h—d”
);

514 
	`äc_dump_dma_pkt_šfo
(&
sim¶e_pkt
.
šfo
);

515 
	`äc_dump_buff
(
sim¶e_pkt
.
h—d”
.
tÙ®_·yËn
, sim¶e_pkt.
·ylßd
);

518 
	`´_sim¶e_ruË_pkt_´oûss
(
udp_chª
, &
sim¶e_pkt
);

520 !
	`SIMPLE_PACKAGE_AVAIL_RING_PUT
(*
udp_chª
->
dma_ù¾
, 
block_addr
))

522 
	`Çno¦“p
(&
¦“±ime
, &sleeptime);

527 
	`Çno¦“p
(&
¦“±ime
, &sleeptime);

532 
	`ex™
(1);

533  
NULL
;

534 
	}
}

536 *
	$´_ruË_¡©_th»ad
(*
¬g
)

538 
£c
 = 0;

539 
	`´štf
(" %5s %10s %10s %8s %10s %8s %10s\n", "TIME", "RX_BLOCKS", "RX_PKTS", "SPEED", "RX_BYTES", "SPEED", "RX_ERRORS");

540 
ušt64_t
 
rx_pkts
, 
rx_by‹s
, 
rx_blocks
, 
rx_”rÜs
;

541 
ušt64_t
 
rx_by‹s_Şd
 = 0, 
rx_pkts_Şd
 =0, 
rx_by‹s_¥“d
 = 0, 
rx_pkts_¥“d
 = 0;

542 
rx_by‹s_¥“d_¡r
[10];

543 
rx_pkts_¥“d_¡r
[10];

544 
´_chª_t
 *
chª
 = (´_chª_ˆ*è
¬g
;

548 
rx_blocks
 = 
chª
->
ä_¡©
.rx_blocks;

549 
rx_pkts
 = 
chª
->
ä_¡©
.rx_pkts;

550 
rx_by‹s
 = 
chª
->
ä_¡©
.rx_bytes;

551 
rx_”rÜs
 = 
chª
->
ä_¡©
.rx_errors;

553 
rx_by‹s_¥“d
 = 
rx_by‹s
 - 
rx_by‹s_Şd
;

554 
rx_pkts_¥“d
 = 
rx_pkts
 - 
rx_pkts_Şd
;

556 
	`äc_¥“d_¡r
(
rx_by‹s_¥“d
, 
rx_by‹s_¥“d_¡r
, "Bps");

557 
	`äc_¥“d_¡r
(
rx_pkts_¥“d
, 
rx_pkts_¥“d_¡r
, "pps");

558 
	`´štf
("\¸ %5d %10Îd %10Îd %8  %10Îd %8  %10Îd", 
£c
,

559 (
ULL
è
rx_blocks
, (ULLè
rx_pkts
, 
rx_pkts_¥“d_¡r
,

560 (
ULL
è
rx_by‹s
, 
rx_by‹s_¥“d_¡r
, (ULLè
rx_”rÜs
);

561 
	`fæush
(
¡dout
);

563 
£c
++;

564 
rx_by‹s_Şd
 = 
rx_by‹s
;

565 
rx_pkts_Şd
 = 
rx_pkts
;

566 
	`¦“p
(1);

569  
NULL
;

570 
	}
}

572 
	$äùw—k_cmd_´_ruË_u§ge
()

574 
	`´štf
("U§ge: % [-bch].\n", 
´og¿m
);

575 
	`´štf
(" -b -- Dump block info.\n");

576 
	`´štf
(" -i -- Dump…kt info.\n");

577 
	`´štf
(" -p -- Dump…acket data.\n");

578 
	`´štf
(" -c -- Dump counter.\n");

579 
	`´štf
(" -h -- Printf help message.\n");

581 
	`ex™
(0);

582 
	}
}

584 
	$äùw—k_cmd_´_ruË_¡¬t
(
¬gc
, **
¬gv
)

586 
mfd
 = 0;

588 
rv
;

589 
´_chª_t
 *
udp_chª
 = 
NULL
;

590 
İt
;

591 
dump_couÁ
 = 0;

592 ià(
¬gc
 == 1)

594 
	`äùw—k_cmd_´_udp_u§ge
();

595  
FRE_SUCCESS
;

597 (
İt
 = 
	`g‘İt
(
¬gc
, 
¬gv
, "bfipcvo:TURh?")) != -1) {

598 
İt
) {

600 
dump_block
 = 1;

603 
dump_šfo
 = 1;

606 
dump_·ck‘
 = 1;

609 
dump_couÁ
 = 1;

613 
	`äùw—k_cmd_´_udp_u§ge
();

614  
FRE_SUCCESS
;

619 
udp_chª
 = 
	`m®loc
((
´_chª_t
));

620 
	`mem£t
(
udp_chª
, 0, (
´_chª_t
));

621 
udp_chª
->
ty³
 = 
FRC_WORK_RULE
;

625 
rv
 = 
	`äÿpi_chª_Ü_´_ruË_Ü_udp_¡¬t
(
udp_chª
->
ty³
, &udp_chª->
desc
);

626 ià(
rv
 !ğ
FRE_SUCCESS
)

628 
	`FRCTWEAK_ERROR
("commªdƒxecu‹ fa: %d!\n", 
rv
);

629 
äùw—k_cmd_´_udp_¡¬t_”r
;

632 
	`FRCTWEAK_DEBUG
("udp_chan=%lld, ctlr_addr=%llx, ctrl_size=%llx,"

633 "poŞ_addr=%Îx,…oŞ_size=%Îx\n", (
ULL
)
udp_chª
->
desc
.
ty³
, (ULL)udp_chª->desc.
ù¾_addr
,(ULL)udp_chª->desc.
ù¾_size
,

634 (
ULL
)
udp_chª
->
desc
.
poŞ_addr
, (ULL)udp_chª->desc.
poŞ_size
);

636 
mfd
 = 
	`İ’
("/dev/mem",
O_RDWR
);

637 ià(
mfd
 < 0)

639 
	`FRCTWEAK_ERROR
("Can't open /dev/mem !\n");

640 
rv
 = 
FRE_FAIL
;

641 
äùw—k_cmd_´_udp_¡¬t_”r
;

645 
udp_chª
->
dma_ù¾
 = 
	`mm­
(0, udp_chª->
desc
.
ù¾_size
, 
PROT_READ
|
PROT_WRITE
, 
MAP_SHARED
, 
mfd
, udp_chª->desc.
ù¾_addr
);

646 
	`FRCTWEAK_DEBUG
("udp_chª->dma_ù¾=%p\n", 
udp_chª
->
dma_ù¾
);

647 ià(
udp_chª
->
dma_ù¾
 =ğ
NULL
)

649 
	`FRCTWEAK_ERROR
("mmap udp‡vail„ing fail!\n");

650 
rv
 = 
FRE_MEMORY
;

651 
äùw—k_cmd_´_udp_¡¬t_”r
;

654 
udp_chª
->
poŞ_addr
 = 
	`mm­
(0, udp_chª->
desc
.
poŞ_size
, 
PROT_READ
, 
MAP_SHARED
, 
mfd
, udp_chan->desc.pool_addr);

655 
	`FRCTWEAK_DEBUG
("udp_chª->poŞ_addr=%p\n", 
udp_chª
->
poŞ_addr
);

656 ià(
udp_chª
->
poŞ_addr
 =ğ
NULL
)

658 
	`FRCTWEAK_ERROR
("mmap udp…ool fail!\n");

659 
rv
 = 
FRE_MEMORY
;

660 
äùw—k_cmd_´_udp_¡¬t_”r
;

665 ià(
dump_couÁ
 && !
dump_block
 && !
dump_šfo
 && !
dump_·ck‘
)

667 
´_udp_¡©_th»ad_id
 = 
	`±h»ad_ü—‹
(&´_udp_¡©_th»ad_id, 
NULL
, 
´_ruË_¡©_th»ad
, (*)
udp_chª
);

669 
´_udp_d©a_th»ad_id
 = 
	`±h»ad_ü—‹
(&´_udp_d©a_th»ad_id, 
NULL
, 
´_ruË_d©a_th»ad
, (*)
udp_chª
);

673 
	`¦“p
(30);

675 
äùw—k_cmd_´_udp_¡¬t_”r
:

676 ià(
mfd
 > 0)

678 
	`şo£
(
mfd
);

680 ià(
rv
)

682  
FRE_FAIL
;

684  
FRE_SUCCESS
;

685 
	}
}

688 #ià
FRC_CONFIG_SSN_CHAN


690 
ušt64_t
 
	mrx_blocks
;

691 
ušt64_t
 
	mrx_pkts
;

692 
ušt64_t
 
	mrx_by‹s
;

693 
ušt64_t
 
	mrx_loss
;

694 
ušt64_t
 
	mrx_pos™ive
;

695 
ušt64_t
 
	mrx_»v”£
;

696 
ušt64_t
 
	mrx_”rÜs
;

698 
ušt64_t
 
	mtx_block
;

699 
ušt64_t
 
	mtx_pkts
;

700 
ušt64_t
 
	mtx_by‹s
;

701 
ušt64_t
 
	mtx_”rÜ
;

702 
ušt64_t
 
	mtx_pos™ive
;

703 
ušt64_t
 
	mtx_»v”£
;

704 } 
	ts¢_¡©_t
;

707 
ušt64_t
 
	mty³
;

708 
s¢_¡©_t
 
	mä_¡©
;

709 
äc_dma_s¢_chª_desc_t
 
	mdesc
;

710 
äc_s¢_ršg_buff_t
 *
	mavaabË_ršg
;

711 
äc_s¢_ršg_buff_t
 *
	mcom¶‘ed_ršg
;

712 
ušt8_t
 *
	mpoŞ_addr
;

713 } 
	t´_s¢_chª_t
;

715 
±h»ad_t
 
	g´_s¢_¡©_th»ad_id
;

716 
±h»ad_t
 
	g´_s¢_d©a_th»ad_id
;

717 
s¢_¡©_t
 
	gs¢_¡©_now
, 
	gs¢_¡©_Şd
;

721 
ušt64_t
 
	mnum
;

722 
ušt64_t
 
	mbuff
[
FRC_DMA_SSN_RING_BUFF_SIZE
];

723 } 
	t´_s¢_ršg_t
;

725 
´_s¢_ršg_t
 *
	gava_ršg
 = 
NULL
;

726 
´_s¢_ršg_t
 *
	gcom¶_ršg
 = 
NULL
;

728 
	$´_s¢_di§bË_où0
()

730 
rv
;

731 
äc_bdd_phy_t
 
šput
;

732 
äc_phy_İ_t
 
ouut
;

733 
	`mem£t
(&
šput
, 0, (
äc_bdd_phy_t
));

734 
	`mem£t
(&
ouut
, 0, (
äc_phy_İ_t
));

735 
šput
.
phy
.
pÜt
 = 0;

736 
šput
.
phy
.
devad
 = 1;

737 
šput
.
phy
.
addr
 = 0;

738 
šput
.
phy
.
v®ue
 = 0x2041;

739 
šput
.
İ
 = 1;

741 
rv
 =
	`äÿpi_bdd_phy
(&
šput
, &
ouut
);

742 ià(
rv
 !ğ
FRE_SUCCESS
)

744 
	`´štf
("G‘ o¸£ˆPHY fa: %d!\n", 
rv
);

746  
rv
;

747 
	}
}

749 
	$´_s¢_’abË_où0
()

751 
rv
;

752 
äc_bdd_phy_t
 
šput
;

753 
äc_phy_İ_t
 
ouut
;

754 
	`mem£t
(&
šput
, 0, (
äc_bdd_phy_t
));

755 
	`mem£t
(&
ouut
, 0, (
äc_phy_İ_t
));

756 
šput
.
phy
.
pÜt
 = 0;

757 
šput
.
phy
.
devad
 = 1;

758 
šput
.
phy
.
addr
 = 0;

759 
šput
.
phy
.
v®ue
 = 0x2040;

760 
šput
.
İ
 = 1;

762 
rv
 =
	`äÿpi_bdd_phy
(&
šput
, &
ouut
);

763 ià(
rv
 !ğ
FRE_SUCCESS
)

765 
	`´štf
("G‘ o¸£ˆPHY fa: %d!\n", 
rv
);

767  
rv
;

768 
	}
}

769 
šlše
 
	$´_s¢_ršg_g‘
(
äc_s¢_ršg_buff_t
 *
ršg
, 
´_s¢_ršg_t
 *
buff
)

771 
ušt64_t
 
ridx
, 
widx
;

772 
i
;

774 
ridx
 = 
	`s¢_ršg_ridx
(
ršg
);

775 
widx
 = 
	`s¢_ršg_widx
(
ršg
);

777 
i
 = 0; 
ridx
 < 
widx
;„idx++, i++)

779 ià((
widx
 >ğ
ridx
è&& (widx -„idx <ğ
FRC_DMA_SSN_RING_BUFF_SIZE
)) {

780 #ià
__FRC_BYTE_ORDER
 =ğ
__FRC_LITTLE_ENDIAN


781 
buff
->buff[
i
] = 
	`SWAP_8_BYTE
(
ršg
->buff[
ridx
%
FRC_DMA_SSN_RING_BUFF_SIZE
]);

783 
buff
->buff[
i
] = 
ršg
->buff[
ridx
%
FRC_DMA_SSN_RING_BUFF_SIZE
];

787 
buff
->
num
 = 
i
;

788 
	`´štf
("´_s¢_ršg size=%d\n", 
i
);

789 
	}
}

791 
äc_s¢_block_t
 *

792 
	$´_s¢_pkt_g‘
(
ušt64_t
 
block_addr
, 
´_s¢_chª_t
 *
chª
)

794 
ušt64_t
 
off£t
;

795 
äc_s¢_block_t
 * 
dma_pkt
 = 
NULL
;

796 
off£t
 = 
block_addr
 - 
chª
->
desc
.
poŞ_addr
;

797 ià(
off£t
 > 
chª
->
desc
.
poŞ_size
)

799  
NULL
;

801 
dma_pkt
 = (
äc_s¢_block_t
 *)(
chª
->
poŞ_addr
 + 
off£t
);

802  
dma_pkt
;

803 
	}
}

810 
	$´_s¢_dma_h—d_g‘
(
äc_s¢_block_t
 *
dma_pkt
, 
äc_dma_hdr_t
 *
dma_hdr
)

812 ià(
dma_pkt
 =ğ
NULL
)

814  
FRE_FAIL
;

816 
	`mem£t
(
dma_hdr
, 0, 
FRC_DMA_PKT_HEAD_SIZE
);

817 
	`memıy
(
dma_hdr
, 
dma_pkt
->
d©a
, 
FRC_DMA_PKT_HEAD_SIZE
);

818 
	`sw­_buff
(
FRC_DMA_PKT_HEAD_SIZE
 >>3, 
dma_hdr
);

819  
FRE_SUCCESS
;

820 
	}
}

823 
	$´_s¢_pkt_´oûss
(
´_s¢_chª_t
 *
chª
, 
äc_s¢_block_t
 *
dma_pkt
, 
äc_dma_hdr_t
 *
dma_hdr
,

824 
ušt64_t
 
block_addr
)

826 
i
;

827 
äc_dma_pkt_šfo_t
 
pkt_šfo
;

828 
ušt8_t
 *
·ylßd
 = 
NULL
;

829 
ušt16_t
 
·yËn
 = 0;

830 
ušt16_t
 
·ylßd_off£t
 = 
FRC_DMA_PKT_PAYLOAD_OFFSET
;

831 
ušt16_t
 
pktšfo_off£t
 = 
FRC_DMA_SSN_DATA_SIZE
 - 
FRC_DMA_PKT_INFO_SIZE
;

832 
ušt8_t
 
pkt_num
;

833 
ušt8_t
 
æag
 = 0;

834 
ušt64_t
 
dmac
 = 0;

835 ià(
dump_block
)

837 
	`äc_dma_h—d”_dump
(
chª
->
desc
.
ty³
, 
dma_hdr
);

840 #ià
FRC_DEBUG_PKT_LEN


841 
	`äc_dump_buff
(
FRC_DMA_SSN_DATA_SIZE
, 
dma_pkt
->
d©a
);

842 
	`äc_dump_dma_hdr
(
dma_hdr
);

844 
pkt_num
 = 
dma_hdr
->pkt_num;

847 
i
 = 0; i < 
pkt_num
; i++ )

849 
	`mem£t
(&
pkt_šfo
, 0, 
FRC_DMA_PKT_INFO_SIZE
);

850 
	`memıy
(&
pkt_šfo
, (
äc_dma_pkt_šfo_t
 *)&
dma_pkt
->
d©a
[
pktšfo_off£t
], 
FRC_DMA_PKT_INFO_SIZE
);

851 
	`sw­_buff
(
FRC_DMA_PKT_INFO_SIZE
>>3, &
pkt_šfo
);

852 
·ylßd
 = &
dma_pkt
->
d©a
[
·ylßd_off£t
];

853 
·yËn
 = 
pkt_šfo
.
·ylßd_Ën
;

854 
chª
->
ä_¡©
.
rx_pkts
++;

855 
chª
->
ä_¡©
.
rx_by‹s
 +ğ
pkt_šfo
.
·ylßd_Ën
;

857 
pktšfo_off£t
 -ğ
FRC_DMA_PKT_INFO_SIZE
;

858 
·ylßd_off£t
 +ğ
pkt_šfo
.
·ylßd_Ën
;

860 ià(
i
 == 0)

862 
dmac
 = 
pkt_šfo
.dmac & 0xffffffffffff;

864 ià((
dmac
 !ğ(
pkt_šfo
.dmac & 0xffffffffffff)) &&

865 (
dmac
 !ğ(
pkt_šfo
.
smac
 & 0xffffffffffff)))

867 
æag
 |= 1;

872 ià(
dump_šfo
)

874 
	`äc_pkt_šfo_dump
(&
pkt_šfo
);

877 ià(
dump_·ck‘
)

879 
	`äc_pkt_·ylßd_dump
(
·yËn
, 
·ylßd
);

881 #ià
FRC_DEBUG_PKT_LEN


882 
	`äc_dump_dma_pkt_šfo
(&
pkt_šfo
);

887 ià(
æag
)

889 
chª
->
ä_¡©
.
rx_”rÜs
++;

890 ià(
dump_”r_addr
)

892 
	`äc_dma_h—d”_dump
(
chª
->
desc
.
ty³
, 
dma_hdr
);

893 
	`´štf
("block_addr=%Îx\n", (
ULL
)
block_addr
);

894 
	`äc_dump_buff
(
FRC_DMA_SSN_DATA_SIZE
, 
dma_pkt
->
d©a
);

895 ià(
	`´_s¢_di§bË_où0
())

897 
	`´štf
("disable oct0 failed\n");

899 
	`¦“p
(5);

901 
	`´_s¢_ršg_g‘
(
chª
->
avaabË_ršg
, 
ava_ršg
);

902 
	`´_s¢_ršg_g‘
(
chª
->
com¶‘ed_ršg
, 
com¶_ršg
);

903 
	`´štf
("ava_ršg->num + com¶_ršg->num = %Îu\n", (
ULL
)(
ava_ršg
->
num
+
com¶_ršg
->num));

907 
i
 = 0; i < 
ava_ršg
->
num
; i++)

909 ià(
block_addr
 =ğ
ava_ršg
->
buff
[
i
])

911 
	`´štf
("fšd‡va_ršg‡dd¸i=%d\n", 
i
);

915 
i
 = 0; i < 
com¶_ršg
->
num
; i++)

917 ià(
block_addr
 =ğ
com¶_ršg
->
buff
[
i
])

919 
	`´štf
("fšd com¶_ršg‡dd¸i=%d\n", 
i
);

922 ià(
	`´_s¢_’abË_où0
())

924 
	`´štf
("disable oct0 failed\n");

930 
	`mem£t
(
dma_pkt
, 0, (
äc_s¢_block_t
));

931 
	}
}

933 *
	$´_s¢_d©a_th»ad
(*
¬g
)

935 
ušt64_t
 
block_addr
;

936 
äc_s¢_block_t
 *
dma_pkt
 = 
NULL
;

937 
äc_dma_hdr_t
 
dma_h—d
;

938 
time¥ec
 
¦“±ime
;

939 
¦“±ime
.
tv_£c
 = 0;

940 
¦“±ime
.
tv_n£c
 = 10;

941 
´_s¢_chª_t
 *
s¢_chª
 = (´_s¢_chª_ˆ*)
¬g
;

944 ià(
	`SSN_COMPL_RING_GET
((*
s¢_chª
), 
block_addr
))

947 
dma_pkt
 = 
	`´_s¢_pkt_g‘
(
block_addr
, 
s¢_chª
);

948 ià(
dma_pkt
 =ğ
NULL
)

955 ià(!
	`´_s¢_dma_h—d_g‘
(
dma_pkt
, &
dma_h—d
))

957 
s¢_chª
->
ä_¡©
.
rx_blocks
++;

963 
s¢_chª
->
ä_¡©
.
rx_blocks
++;

966 
	`´_s¢_pkt_´oûss
(
s¢_chª
, 
dma_pkt
, &
dma_h—d
, 
block_addr
);

967 !
	`SSN_AVAIL_RING_PUT
(*
s¢_chª
, 
block_addr
))

969 
	`Çno¦“p
(&
¦“±ime
, &sleeptime);

973 
	`Çno¦“p
(&
¦“±ime
, &sleeptime);

976 
	}
}

978 *
	$´_s¢_¡©_th»ad
(*
¬g
)

980 
ušt64_t
 
cur_¥“d
, 
avg_¥“d
, 
¥’d
;

981 
cur_un™
, 
avg_un™
;

982 
´_s¢_chª_t
 *
s¢_chª
 = (´_s¢_chª_ˆ*)
¬g
;

983 
timev®
 
now
;

984 
	`g‘timeofday
(&
¡¬t_time
, 
NULL
);

986 
	`´štf
(" %5s %16s %16s %9s %9s %16s %16s %16s %16s\n", \

991 
	`g‘timeofday
(&
now
, 
NULL
);

992 
	`memıy
(&
s¢_¡©_now
, &
s¢_chª
->
ä_¡©
, (
s¢_¡©_t
));

993 
¥’d
 = 
now
.
tv_£c
 - 
¡¬t_time
.tv_sec;

994 ià(
¥’d
 == 0)

996 
¥’d
 = 1;

998 
avg_¥“d
 = (
s¢_¡©_now
.
rx_by‹s
 )/ 
¥’d
;

999 ià(
avg_¥“d
 < 1024)

1001 
avg_un™
 = 'B';

1003 ià(
avg_¥“d
 > (1024 * 1024))

1005 
avg_¥“d
 /= 1024 * 1024;

1006 
avg_un™
 = 'M';

1010 
avg_¥“d
 /= 1024;

1011 
avg_un™
 = 'K';

1014 
cur_¥“d
 = 
s¢_¡©_now
.
rx_by‹s
 - 
s¢_¡©_Şd
.rx_bytes;

1015 ià(
cur_¥“d
 < 1024)

1017 
cur_un™
 = 'B';

1019 ià(
cur_¥“d
 > (1024 * 1024))

1021 
cur_¥“d
 /= 1024 * 1024;

1022 
cur_un™
 = 'M';

1026 
cur_¥“d
 /= 1024;

1027 
cur_un™
 = 'K';

1030 
	`´štf
("\¸ %5ld %16Îd %16Îd %8Îd%C %8Îd%C %16Îd %16Îd",
now
.
tv_£c
- 
¡¬t_time
.tv_sec,

1031 (
ULL
è
s¢_¡©_now
.
rx_blocks
,(ULL)s¢_¡©_now.
rx_”rÜs
, (ULL)
cur_¥“d
, 
cur_un™
, (ULL)
avg_¥“d
, 
avg_un™
,

1032 (
ULL
è(
	`SWAP_8_BYTE
(
s¢_chª
->
avaabË_ršg
->
widx
)-SWAP_8_BYTE(s¢_chª->avaabË_ršg->
ridx
)),

1033 (
ULL
è(
	`SWAP_8_BYTE
(
s¢_chª
->
com¶‘ed_ršg
->
widx
)-SWAP_8_BYTE(s¢_chª->com¶‘ed_ršg->
ridx
)));

1036 
	`´štf
("\¸ %5ld %16Îd %16Îd %8Îd%C %8Îd%C %16Îd %16Îd %16Îd %16Îd",
now
.
tv_£c
- 
¡¬t_time
.tv_sec,

1037 (
ULL
è
s¢_¡©_now
.
rx_blocks
,(ULL)s¢_¡©_now.
rx_”rÜs
, (ULL)
cur_¥“d
, 
cur_un™
, (ULL)
avg_¥“d
, 
avg_un™
,

1038 (
ULL
è(
	`SWAP_8_BYTE
(
s¢_chª
->
avaabË_ršg
->
widx
)-SWAP_8_BYTE(s¢_chª->avaabË_ršg->
ridx
)),

1039 (
ULL
è(
	`SWAP_8_BYTE
(
s¢_chª
->
com¶‘ed_ršg
->
widx
)-SWAP_8_BYTE(s¢_chª->com¶‘ed_ršg->
ridx
)),

1040 (
ULL
è
	`SWAP_8_BYTE
(
s¢_chª
->
avaabË_ršg
->
widx
), (ULL)SWAP_8_BYTE(s¢_chª->
com¶‘ed_ršg
->widx));

1043 
	`´štf
("\r %5ld %16lld %16lld %8lld%C %8lld%C %16lld %16lld %16lld %16lld",

1044 
now
.
tv_£c
- 
¡¬t_time
.tv_£c,(
ULL
è
s¢_¡©_now
.
rx_blocks
,

1045 (
ULL
)
s¢_¡©_now
.
rx_”rÜs
, (ULL)
cur_¥“d
, 
cur_un™
,

1046 (
ULL
)
avg_¥“d
, 
avg_un™
,(ULLè
s¢_¡©_now
.
rx_pkts
,

1047 (
ULL
è
s¢_¡©_now
.
rx_by‹s
,

1048 (
ULL
è(
	`SWAP_8_BYTE
(
s¢_chª
->
avaabË_ršg
->
widx
)-SWAP_8_BYTE(s¢_chª->avaabË_ršg->
ridx
)),

1049 (
ULL
è(
	`SWAP_8_BYTE
(
s¢_chª
->
com¶‘ed_ršg
->
widx
)-SWAP_8_BYTE(s¢_chª->com¶‘ed_ršg->
ridx
)));

1052 
	`fæush
(
¡dout
);

1053 
	`memıy
(&
s¢_¡©_Şd
, &
s¢_¡©_now
, (
s¢_¡©_t
));

1054 
	`¦“p
(1);

1057  
NULL
;

1058 
	}
}

1061 
	$äùw—k_cmd_´_s¢_u§ge
()

1063 
	`´štf
("U§ge: % [-bûh].\n", 
´og¿m
);

1064 
	`´štf
(" -b -- Dump block info.\n");

1065 
	`´štf
(" -i -- Dump…kt info.\n");

1066 
	`´štf
(" -p -- Dump…acket data.\n");

1067 
	`´štf
(" -c -- Dump counter.\n");

1068 
	`´štf
(" -e -- Dumpƒrror‡ddress.\n");

1069 
	`´štf
(" -h -- Printf help message.\n");

1070 
	}
}

1072 
	$äùw—k_cmd_´_s¢_¡¬t
(
¬gc
, **
¬gv
)

1074 
mfd
 = 0;

1076 
rv
;

1077 
´_s¢_chª_t
 *
s¢_chª
 = 
NULL
;

1078 
dump_couÁ
 = 0;

1079 
İt
;

1080 ià(
¬gc
 == 1)

1082 
	`äùw—k_cmd_´_s¢_u§ge
();

1083 
	`ex™
(0);

1085 (
İt
 = 
	`g‘İt
(
¬gc
, 
¬gv
, "befipcvo:TURh?")) != -1) {

1086 
İt
) {

1088 
dump_block
 = 1;

1091 
dump_šfo
 = 1;

1094 
dump_·ck‘
 = 1;

1097 
dump_couÁ
 = 1;

1100 
dump_”r_addr
 = 1;

1104 
	`äùw—k_cmd_´_s¢_u§ge
();

1105  
FRE_SUCCESS
;

1111 
ava_ršg
 = 
	`m®loc
((
´_s¢_ršg_t
));

1112 ià(
ava_ršg
 =ğ
NULL
)

1114 
	`´štf
("% %d‡va_ršg m®loøçed!\n", 
__FUNCTION__
, 
__LINE__
);

1116 
	`mem£t
(
ava_ršg
, 0, (
´_s¢_ršg_t
));

1118 
com¶_ršg
 = 
	`m®loc
((
´_s¢_ršg_t
));

1119 ià(
com¶_ršg
 =ğ
NULL
)

1121 
	`´štf
("% %d com¶_ršg m®loøçed!\n", 
__FUNCTION__
, 
__LINE__
);

1124 
	`mem£t
(
ava_ršg
, 0, (
´_s¢_ršg_t
));

1125 
s¢_chª
 = 
	`m®loc
((
´_s¢_chª_t
));

1126 
	`mem£t
(
s¢_chª
, 0, (
´_s¢_chª_t
));

1127 
s¢_chª
->
ty³
 = 
FRC_WORK_SSN
;

1130 
rv
 = 
	`äÿpi_chª_Ü_´_s¢_¡¬t
(
s¢_chª
->
ty³
, &s¢_chª->
desc
);

1132 ià(
rv
 !ğ
FRE_SUCCESS
)

1134 
	`FRCTWEAK_ERROR
("commªdƒxecu‹ fa: %d!\n", 
rv
);

1135 
äùw—k_cmd_´_s¢_¡¬t_”r
;

1137 
	`FRCTWEAK_DEBUG
("s¢_chª->desc.ava_addr=0x%Îx,‡va_size=0x%Îx\n", (
ULL
)
s¢_chª
->
desc
.
ava_addr
,

1138 (
ULL
)
s¢_chª
->
desc
.
ava_size
);

1139 
	`FRCTWEAK_DEBUG
("s¢_chª->desc.com¶_addr=0x%Îx, com¶_size=0x%Îx\n",(
ULL
)
s¢_chª
->
desc
.
com¶_addr
,

1140 (
ULL
)
s¢_chª
->
desc
.
com¶_size
);

1141 
	`FRCTWEAK_DEBUG
("s¢_chª->desc.poŞ_addr=0x%Îx,…oŞ_size=0x%Îx\n",(
ULL
)
s¢_chª
->
desc
.
poŞ_addr
,

1142 (
ULL
)
s¢_chª
->
desc
.
poŞ_size
);

1146 
mfd
 = 
	`İ’
("/dev/mem",
O_RDWR
);

1147 ià(
mfd
 < 0)

1149 
	`FRCTWEAK_ERROR
("Can't open /dev/mem !\n");

1150 
rv
 = 
FRE_FAIL
;

1151 
äùw—k_cmd_´_s¢_¡¬t_”r
;

1154 
s¢_chª
->
avaabË_ršg
 = 
	`mm­
(0, s¢_chª->
desc
.
ava_size
, 
PROT_READ
|
PROT_WRITE
, 
MAP_SHARED
, 
mfd
, s¢_chª->desc.
ava_addr
);

1155 ià(
s¢_chª
->
avaabË_ršg
 =ğ
NULL
)

1157 
	`FRCTWEAK_ERROR
("mmap udp‡vail„ing fail!\n");

1158 
rv
 = 
FRE_MEMORY
;

1159 
äùw—k_cmd_´_s¢_¡¬t_”r
;

1162 
s¢_chª
->
com¶‘ed_ršg
 = 
	`mm­
(0, s¢_chª->
desc
.
com¶_size
, 
PROT_READ
|
PROT_WRITE
, 
MAP_SHARED
, 
mfd
, s¢_chª->desc.
com¶_addr
);

1163 ià(
s¢_chª
->
com¶‘ed_ršg
 =ğ
NULL
)

1165 
	`FRCTWEAK_ERROR
("mmap udp compl„ing fail!\n");

1166 
rv
 = 
FRE_MEMORY
;

1167 
äùw—k_cmd_´_s¢_¡¬t_”r
;

1170 
s¢_chª
->
poŞ_addr
 = 
	`mm­
(0, s¢_chª->
desc
.
poŞ_size
, 
PROT_READ
|
PROT_WRITE
, 
MAP_SHARED
, 
mfd
, ssn_chan->desc.pool_addr);

1171 ià(
s¢_chª
->
poŞ_addr
 =ğ
NULL
)

1173 
	`FRCTWEAK_ERROR
("mmap udp…ool fail!\n");

1174 
rv
 = 
FRE_MEMORY
;

1175 
äùw—k_cmd_´_s¢_¡¬t_”r
;

1179 ià(
dump_couÁ
 && !
dump_block
 && !
dump_šfo
 && !
dump_·ck‘
)

1181 
´_s¢_¡©_th»ad_id
 = 
	`±h»ad_ü—‹
(&´_s¢_¡©_th»ad_id, 
NULL
, 
´_s¢_¡©_th»ad
, (*)
s¢_chª
);

1183 
´_s¢_d©a_th»ad_id
 = 
	`±h»ad_ü—‹
(&´_s¢_d©a_th»ad_id, 
NULL
, 
´_s¢_d©a_th»ad
, (*)
s¢_chª
);

1187 
	`¦“p
(30);

1189 
äùw—k_cmd_´_s¢_¡¬t_”r
:

1190 ià(
mfd
 > 0)

1192 
	`şo£
(
mfd
);

1194 ià(
rv
)

1196  
FRE_FAIL
;

1198  
FRE_SUCCESS
;

1199 
	}
}

1202 
	$äùw—k_´_cmd_š™
(
äùw—k_cmd_t
 *
cmd
)

1204 
äùw—k_cmd_t
 *
´_cmd
;

1206 
´_cmd
 = 
	`äùw—k_cmd_»gi¡”
(
cmd
, "´", "´ g‘ d©a", 
äùw—k_cmd_´
, 
äùw—k_cmd_´_u§ge
);

1207 #ià
FRC_CONFIG_SIMPLE_PACKAGE


1208 
	`äùw—k_cmd_»gi¡”
(
´_cmd
, "udp", "´ ud°g‘ d©a.", 
äùw—k_cmd_´_udp_¡¬t
, 
äùw—k_cmd_´_udp_u§ge
);

1209 
	`äùw—k_cmd_»gi¡”
(
´_cmd
, "ruË", "´„uË g‘ d©a.", 
äùw—k_cmd_´_ruË_¡¬t
, 
äùw—k_cmd_´_ruË_u§ge
);

1211 #ià
FRC_CONFIG_SSN_CHAN


1212 
	`äùw—k_cmd_»gi¡”
(
´_cmd
, "s¢", "´ s¢ g‘ d©a.", 
äùw—k_cmd_´_s¢_¡¬t
, 
äùw—k_cmd_´_s¢_u§ge
);

1215 
	}
}

	@frctweak/frctweak_rule.c

1 
	~<¡dlib.h
>

2 
	~<¡ršg.h
>

4 
	~"äùw—k.h
"

5 
	~"äc_·ck.h
"

6 
	~"äc_dma.h
"

7 
	~"cvmx-sw­.h
"

8 
	~"äc_­i.h
"

9 
	~"äc_debug.h
"

13 
	mFRCTWEAK_RULE_STATUS_CMD
,

14 
	mFRCTWEAK_RULE_ADD_CMD
,

15 
	mFRCTWEAK_RULE_DEL_CMD
,

16 
	mFRCTWEAK_RULE_STAT_CLEAR_CMD
,

17 
	mFRCTWEAK_RULE_CLEAR_CMD
,

18 
	mFRCTWEAK_RULE_GET_CMD
,

19 
	mFRCTWEAK_RULE_ENABLE_CMD
,

20 
	mFRCTWEAK_RULE_DISABLE_CMD
,

21 
	mFRCTWEAK_RULE_CNT_CMD
,

22 
	mFRCTWEAK_RULE_UPDATE_CMD
,

23 
	mFRCTWEAK_RULE_NUM_GET_CMD
,

24 
	mFRCTWEAK_RULE_MATCH_CMD
,

25 }
	täùw—k_ruË_t
;

27 
	$äùw—k_cmd_ruË_u§ge
()

29 
	`´štf
("U§ge: % ruË SUBCOMMAND OPTION\n",
´og¿m
);

30 
	`´štf
(" % ruË stus\n",
´og¿m
);

31 
	`´štf
(" % ruË‡dd INDEX SIP DIP SP DP PROTO\n",
´og¿m
);

32 
	`´štf
(" % ruË d– INDEX NUM\n", 
´og¿m
);

33 
	`´štf
(" % ruË upd©e\n", 
´og¿m
);

34 
	`´štf
(" % ruË g‘ INDEX NUM\n", 
´og¿m
);

35 
	`´štf
(" % ruË st_ş—¸ INDEX NUM\n", 
´og¿m
);

36 
	`´štf
(" % ruË‚um\n", 
´og¿m
);

37 
	`´štf
(" % ruË m©ch SIP DIP SP DP PROTO\n", 
´og¿m
);

38 
	`´štf
(" % ruË cÁ INDEX NUM\n", 
´og¿m
);

39 
	`´štf
(" % ruË cË¬ ", 
´og¿m
);

40 
	`´štf
("\n SUBCOMMAND:\n");

41 
	`´štf
(" status -- Get„ule module status:(enable|disable).\n");

42 
	`´štf
("‡dd -- Add one„ule.\n");

43 
	`´štf
(" del -- Delete„ule.\n");

44 
	`´štf
("\n OPTION:\n");

45 
	`´štf
(" INDEX -- Index, from 1o 2000.\n");

46 
	`´štf
(" SIP+ -- Source IP or source ip increment,†ike: 192.168.1.0/255.255.255.0 or 10.0.0.1+100\n");

47 
	`´štf
(" DIP+ -- Destination IP or source ip increment,†ike: 192.168.1.0/255.255.255.0 or 10.0.0.1+100\n");

48 
	`´štf
(" SP+ -- TCP/UDP source…ort & mask or source…ort increment,†ike: 80,80/0x00ff, 1024+10\n");

49 
	`´štf
(" DP+ -- TCP/UDP destination…ort & mask or destination…ort increment,†ike: 80,80/0x00ff, 1024+10\n");

50 
	`´štf
(" NUM -- Numero del.\n");

51 
	}
}

53 
	$äùw—k_cmd_ruË_add_u§ge
()

55 
	`´štf
("USAGE: % ruË‡dd INDEX SIP DIP SP DP PROTO\n",
´og¿m
);

56 
	`´štf
("\n OPTION:\n");

57 
	`´štf
(" INDEX -- Index, from 1o 2000.\n");

58 
	`´štf
(" SIP+ -- Source IP or source ip increment,†ike: 192.168.1.0/255.255.255.0 or 10.0.0.1+100\n");

59 
	`´štf
(" DIP+ -- Destination IP or source ip increment,†ike: 192.168.1.0/255.255.255.0 or 10.0.0.1+100\n");

60 
	`´štf
(" SP+ -- TCP/UDP source…ort & mask or source…ort increment,†ike: 80,80/0x00ff, 1024+10\n");

61 
	`´štf
(" DP+ -- TCP/UDP destination…ort & mask or destination…ort increment,†ike: 80,80/0x00ff, 1024+10\n");

62 
	`´štf
(" PROTO -- Protocol,†ike: (TCP|UDP|ANY).\n");

63 
	}
}

66 
	$äùw—k_cmd_ruË_d–_u§ge
()

68 
	`´štf
("U§ge: % ruË d– INDEX NUM\n",
´og¿m
);

69 
	`´štf
("\n OPTION:\n");

70 
	`´štf
(" INDEX -- Index, from 1o 2000.\n");

71 
	`´štf
(" NUM -- Numero del.\n");

72 
	}
}

74 
	$äùw—k_cmd_ruË_g‘_u§ge
()

76 
	`´štf
("U§ge: % ruË g‘ INDEX NUM\n",
´og¿m
);

77 
	`´štf
("\n OPTION:\n");

78 
	`´štf
(" INDEX -- Index, from 1o 2000.\n");

79 
	`´štf
(" NUM -- Numero del.\n");

80 
	}
}

82 
	$äùw—k_cmd_ruË_¡©_ş—r_u§ge
()

84 
	`´štf
("U§ge: % ruË st_ş—¸{INDEX NUM,‡Î}\n",
´og¿m
);

85 
	`´štf
("\n OPTION:\n");

86 
	`´štf
(" INDEX -- Index, from 1o 2000.\n");

87 
	`´štf
(" NUM -- Numero del.\n");

88 
	}
}

91 
	$äùw—k_cmd_ruË_út_u§ge
()

93 
	`´štf
("U§ge: % ruË cÁ INDEX NUM\n",
´og¿m
);

94 
	`´štf
("\n OPTION:\n");

95 
	`´štf
(" INDEX -- Index, from 1o 2000.\n");

96 
	`´štf
(" NUM -- Numero del.\n");

97 
	}
}

99 
	$äùw—k_cmd_ruË_m©ch_u§ge
()

101 
	`´štf
("USAGE: % ruË m©ch SIP DIP SP DP PROTO\n",
´og¿m
);

102 
	`´štf
("\n OPTION:\n");

103 
	`´štf
(" INDEX -- Index, from 1o 2000.\n");

104 
	`´štf
(" SIP+ -- Source IP or source ip increment,†ike: 192.168.1.0/255.255.255.0 or 10.0.0.1+100\n");

105 
	`´štf
(" DIP+ -- Destination IP or source ip increment,†ike: 192.168.1.0/255.255.255.0 or 10.0.0.1+100\n");

106 
	`´štf
(" SP+ -- TCP/UDP source…ort & mask or source…ort increment,†ike: 80,80/0x00ff, 1024+10\n");

107 
	`´štf
(" DP+ -- TCP/UDP destination…ort & mask or destination…ort increment,†ike: 80,80/0x00ff, 1024+10\n");

108 
	`´štf
(" PROTO -- Protocol,†ike: (TCP|UDP|ANY).\n");

109 
	}
}

112 
	$äùw—k_cmd_ruË
(
¬gc
, **
¬gv
)

114 
rv
;

115 
İ
;

116 
ušt8_t
 
’abË
;

118 
äc_ruË_t
 
ruË
[
RULE_MAX
];

119 
äc_ruË_¡©_t
 
ruË_¡©
[
RULE_MAX
];

120 
äc_ruË_İ_š_t
 
šput
;

121 
äc_ruË_pkt_¡©_t
 
út
;

122 
äc_ruË_¡©_out_t
 
¡©_out
;

124 
i
, 
j
, 
k
;

126 
ušt32_t
 
s
, 
ss
, 
si
, 
se
, 
d
, 
ds
, 
di
, 
de
;

127 
ušt16_t
 
¥
, 
¥s
, 
¥i
, 
¥e
, 
dp
, 
dps
, 
dpi
, 
d³
;

128 
ušt32_t
 
tÙ®
 = 0, 
cur
 = 0;

129 
ušt8_t
 
ruË_sourû
 = 0, 
ruË_ty³
 = 0, 
aùiÚ
 = 0, 
ruË_İ
 = 0;

130 
ušt16_t
 
šdex
, 
´Ùo
;

131 
¡r_s
[18], 
¡r_d
[18], 
¡r_¥
[18], 
¡r_dp
[18], 
¡r_´Ùo
[18];

132 
ušt16_t
 
ş—r_num
, 
ruË_num
, 
m©ch_num
;

133 
ušt16_t
 
num
 = 0;

136 
buf
[(
äc_ruË_¡©_out_t
)], *
p
;

138 
	`mem£t
(
ruË
, 0, (
äc_ruË_t
));

139 
	`mem£t
(&
ruË_¡©
, 0 , (
äc_ruË_¡©_t
));

140 
	`mem£t
(&
šput
, 0, (
äc_ruË_İ_š_t
));

141 
	`mem£t
(&
út
, 0, (
äc_ruË_pkt_¡©_t
));

142 
	`mem£t
(&
¡©_out
, 0, (
äc_ruË_¡©_out_t
));

146 ià(
¬gc
 < 2)

148 
	`äùw—k_cmd_ruË_u§ge
();

149  
FRE_SUCCESS
;

152 ià(!(
	`¡rcmp
("¡©us", 
¬gv
[1])))

154 
İ
 = 
FRCTWEAK_RULE_STATUS_CMD
;

157 ià(!(
	`¡rcmp
("add", 
¬gv
[1])))

159 
İ
 = 
FRCTWEAK_RULE_ADD_CMD
;

162 ià(!(
	`¡rcmp
("d–", 
¬gv
[1])))

164 
İ
 = 
FRCTWEAK_RULE_DEL_CMD
;

167 ià(!(
	`¡rcmp
("¡©_ş—r", 
¬gv
[1])))

169 
İ
 = 
FRCTWEAK_RULE_STAT_CLEAR_CMD
;

172 ià(!(
	`¡rcmp
("ş—r", 
¬gv
[1])))

174 
İ
 = 
FRCTWEAK_RULE_CLEAR_CMD
;

177 ià(!(
	`¡rcmp
("g‘", 
¬gv
[1])))

179 
İ
 = 
FRCTWEAK_RULE_GET_CMD
;

182 ià(!
	`¡rcmp
("’abË", 
¬gv
[1]))

184 
İ
 = 
FRCTWEAK_RULE_ENABLE_CMD
;

187 ià(!
	`¡rcmp
("di§bË", 
¬gv
[1]))

189 
İ
 = 
FRCTWEAK_RULE_DISABLE_CMD
;

191 ià(!
	`¡rcmp
("út", 
¬gv
[1]))

193 
İ
 = 
FRCTWEAK_RULE_CNT_CMD
;

195 ià(!
	`¡rcmp
("upd©e", 
¬gv
[1]))

197 
İ
 = 
FRCTWEAK_RULE_UPDATE_CMD
;

199 ià(!
	`¡rcmp
("num", 
¬gv
[1]))

201 
İ
 = 
FRCTWEAK_RULE_NUM_GET_CMD
;

203 ià(!
	`¡rcmp
("m©ch", 
¬gv
[1]))

205 
İ
 = 
FRCTWEAK_RULE_MATCH_CMD
;

209 
	`äùw—k_cmd_ruË_u§ge
();

213 
İ
)

215 
FRCTWEAK_RULE_STATUS_CMD
:

216 
rv
 = 
	`äÿpi_ruË_¡©us_g‘
(&
’abË
);

217 
	`´štf
("RULE funùiÚ stus: %s\n", 
’abË
?"enable":"disable");

219 
FRCTWEAK_RULE_ADD_CMD
:

220 ià((
¬gc
 < 8) || (argc > 11))

222 
	`äùw—k_cmd_ruË_add_u§ge
();

223  
FRE_SUCCESS
;

226 
	`ssÿnf
(
¬gv
[2], "%hu", &
šdex
);

227 ià(
šdex
 <ğ0 || index > 
RULE_MAX
)

229 
	`FRCTWEAK_ERROR
("Invalid„ule index!");

230  
FRE_PARAM
;

233 ià(
	`·r£_v4_šc
(
¬gv
[3], &
ss
, &
si
))

235  
FRE_PARAM
;

238 ià(
	`·r£_v4_šc
(
¬gv
[4], &
ds
, &
di
))

240  
FRE_PARAM
;

243 ià(
	`·r£_u16_šc
(
¬gv
[5], &
¥s
, &
¥i
))

245  
FRE_PARAM
;

248 ià(
	`·r£_u16_šc
(
¬gv
[6], &
dps
, &
dpi
))

250  
FRE_PARAM
;

253 ià(
	`·r£_´Ùoÿl
(
¬gv
[7], &
´Ùo
))

255  
FRE_PARAM
;

258 ià(11 =ğ
¬gc
)

260 ià(
	`·r£_u8
(
¬gv
[8], &
ruË_sourû
))

262  
FRE_PARAM
;

265 ià(
	`·r£_u8
(
¬gv
[9], &
ruË_ty³
))

267  
FRE_PARAM
;

270 ià(
	`·r£_u8
(
¬gv
[10], &
ruË_İ
))

272  
FRE_PARAM
;

276 
tÙ®
 = 
si
 * 
di
 * 
¥i
 * 
dpi
;

278 ià(
tÙ®
 > 
RULE_MAX
)

280 
	`´štf
("TÙ® %d„uËs, ouˆoàbÚd.\n", 
tÙ®
);

281  
FRE_PARAM
;

284 
se
 = 
ss
 + 
si
;

285 
de
 = 
ds
 + 
di
;

286 
¥e
 = 
¥s
 + 
¥i
;

287 
d³
 = 
dps
 + 
dpi
;

289 
s
 = 
ss
; s < 
se
; sip++)

291 
d
 = 
ds
; d < 
de
; dip++)

293 
¥
 = 
¥s
; s°< 
¥e
; sp++)

295 
dp
 = 
dps
; d°< 
d³
; dp++)

298 
ruË
[
cur
].
s
 = sip;

299 
ruË
[
cur
].
d
 = dip;

300 
ruË
[
cur
].
¥
 = sp;

301 
ruË
[
cur
].
dp
 = dp;

302 
ruË
[
cur
].
´Ùo
 =…roto;

303 
ruË
[
cur
].
ruË_sourû
 =„ule_source;

304 
ruË
[
cur
].
ruË_ty³
 =„ule_type;

305 
ruË
[
cur
].
aùiÚ
 =‡ction;

306 
ruË
[
cur
].
İ
 = 
ruË_İ
;

307 
ruË
[
cur
].
šdex
 = index;

309 
rv
 = 
	`äÿpi_ruË_add
(&
ruË
[
cur
]);

311 
cur
 ++;

312 
šdex
 ++;

319 
FRCTWEAK_RULE_DEL_CMD
:

320 ià(
¬gc
 < 4)

322 
	`äùw—k_cmd_ruË_d–_u§ge
();

323  
FRE_SUCCESS
;

325 
	`ssÿnf
(
¬gv
[2], "%d", &
šput
.
šdex
);

326 ià(
šput
.
šdex
 <ğ0 || iÅut.šdex > 
RULE_MAX
)

328 
	`FRCTWEAK_ERROR
("Invalid„ule index!");

329  
FRE_PARAM
;

332 
	`ssÿnf
(
¬gv
[3], "%d", &
šput
.
num
);

333 ià(
šput
.
num
 < 1 || iÅut.num > 
RULE_MAX
)

335 
	`FRCTWEAK_ERROR
("Invalid„ule‚umber!");

336  
FRE_PARAM
;

339 ià(
šput
.
šdex
 + iÅut.
num
 > 
RULE_MAX
 + 1)

341  
FRE_PARAM
;

343 
rv
 = 
	`äÿpi_ruË_d–
(&
šput
, (
ušt16_t
 *)&šput.
num
);

345 
FRCTWEAK_RULE_STAT_CLEAR_CMD
:

346 ià((
¬gc
 < 3) || (argc > 4))

348 
	`äùw—k_cmd_ruË_¡©_ş—r_u§ge
();

349  
FRE_SUCCESS
;

351 ià(4 =ğ
¬gc
)

353 
	`ssÿnf
(
¬gv
[2], "%d", &
šput
.
šdex
);

354 ià(
šput
.
šdex
 < 1 || iÅut.šdex > (
RULE_MAX
))

356 
	`FRCTWEAK_ERROR
("Invalid„ule index!");

357  
FRE_PARAM
;

359 ià(
¬gc
 < 4)

361 
	`äùw—k_cmd_ruË_u§ge
();

362  
FRE_PARAM
;

364 
	`ssÿnf
(
¬gv
[3], "%d", &
šput
.
num
);

365 ià(
šput
.
num
 < 1 || iÅut.num > 
RULE_MAX
)

367 
	`FRCTWEAK_ERROR
("Invalid„ule‚umber!");

368  
FRE_PARAM
;

371 ià(
šput
.
šdex
 + iÅut.
num
 > 
RULE_MAX
+1)

373  
FRE_PARAM
;

377 ià(3 =ğ
¬gc
)

379 ià(
	`¡rcmp
("®l", 
¬gv
[2]))

381  
FRE_PARAM
;

384 
šput
.
šdex
 = 1;

385 
šput
.
num
 = 
RULE_MAX
;

388 
rv
 = 
	`äÿpi_ruË_¡©_ş—r
(&
šput
, &
ş—r_num
);

389 ià(
rv
 !ğ
FRE_SUCCESS
)

391 
	`FRCTWEAK_ERROR
("Clearing uphe statistics of„ules failed!\n");

394 
FRCTWEAK_RULE_CLEAR_CMD
:

395 
šput
.
šdex
 = 1;

396 
šput
.
num
 = 
RULE_MAX
;

397 
rv
 = 
	`äÿpi_ruË_ş—r
(&
šput
, &
ş—r_num
);

398 ià(
rv
 !ğ
FRE_SUCCESS
)

400 
	`FRCTWEAK_ERROR
("Clearing up„ules failed\n");

403 
FRCTWEAK_RULE_GET_CMD
:

404 ià(
¬gc
 < 4)

406 
	`äùw—k_cmd_ruË_g‘_u§ge
();

407  
FRE_SUCCESS
;

409 
	`ssÿnf
(
¬gv
[2], "%d", &
šput
.
šdex
);

410 ià(
šput
.
šdex
 < 1 || iÅut.šdex > 
RULE_MAX
)

412 
	`FRCTWEAK_ERROR
("Invalid„ule index!");

413  
FRE_PARAM
;

415 
	`ssÿnf
(
¬gv
[3], "%d", &
šput
.
num
);

416 ià(
šput
.
num
 < 1 || iÅut.num > 
RULE_MAX
)

418 
	`FRCTWEAK_ERROR
("Invalid„ule‚umber!");

419  
FRE_PARAM
;

422 ià(
šput
.
šdex
 + iÅut.
num
 > (
RULE_MAX
+1))

424  
FRE_PARAM
;

426 
šdex
 = 
šput
.index;

427 
ruË_num
 = 
šput
.
num
;

428 
num
 = 
šput
.num / 
MAX_RULE
;

429 ià(
šput
.
num
%
MAX_RULE
)

431 
num
 +=1;

433 
	`´štf
("%-6s %-18s %-18s %-6s %-6s %-6s %-8s %-8s %-8s %-6s %-8s %-4s\n",

435 
j
 = 0; j < 
num
; j++)

437 
p
 = 
buf
;

438 ià(
j
 =ğ
num
-1)

440 ià(
ruË_num
%
MAX_RULE
)

442 
šput
.
num
 = 
ruË_num
 % 
MAX_RULE
;

444 
šput
.
num
 = 
MAX_RULE
;

448 
šput
.
num
 = 
MAX_RULE
;

451 
šput
.
šdex
 = index + 
j
 * 
MAX_RULE
;

452 
rv
 = 
	`äÿpi_ruË_¡©_g‘
(&
šput
, (
äc_ruË_¡©_out_t
 *)
buf
);

453 
	`UNPACK_U32
(
p
, 
¡©_out
.
num
);

455 
i
 =0; i < 
¡©_out
.
num
;i++)

457 
p
 = 
	`äc_ruË_¡©_uÅack
Õ, &
¡©_out
.
ruË_¡©
[
i
]);

458 
	`ä_v4_¡ršg
(
¡©_out
.
ruË_¡©
[
i
].
ruË
.
s
, 
¡r_s
);

459 
	`ä_v4_¡ršg
(
¡©_out
.
ruË_¡©
[
i
].
ruË
.
d
, 
¡r_d
);

460 
	`ä_pÜt_¡ršg
(
¡©_out
.
ruË_¡©
[
i
].
ruË
.
¥
, 
¡r_¥
);

461 
	`ä_pÜt_¡ršg
(
¡©_out
.
ruË_¡©
[
i
].
ruË
.
dp
, 
¡r_dp
);

462 
	`ä_´Ùo_¡ršg
(
¡©_out
.
ruË_¡©
[
i
].
ruË
.
´Ùo
, 
¡r_´Ùo
);

463 
	`´štf
("%-6d %-18s %-18s %-6s %-6s %-6s %-8d %-8d %-8d %-6d %-8d %-4d\n",

464 
¡©_out
.
ruË_¡©
[
i
].
ruË
.
šdex
, 
¡r_s
, 
¡r_d
, 
¡r_¥
, 
¡r_dp
, 
¡r_´Ùo
,

465 
¡©_out
.
ruË_¡©
[
i
].
¡©
.
pkts
, st_out.ruË_¡©[i].¡©.
by‹s
,

466 
¡©_out
.
ruË_¡©
[
i
].
ruË
.
ruË_sourû
, st_out.ruË_¡©[i].ruË.
ruË_ty³
, st_out.ruË_¡©[i].ruË.
aùiÚ
, st_out.ruË_¡©[i].ruË.
İ
);

470 
FRCTWEAK_RULE_ENABLE_CMD
:

471 
FRCTWEAK_RULE_DISABLE_CMD
:

472 ià(
	`·r£_boŞ
(
¬gv
[1], &
’abË
))

474  
FRE_PARAM
;

477 
rv
 = 
	`äÿpi_ruË_’abË
(
’abË
);

479 
FRCTWEAK_RULE_CNT_CMD
:

480 ià(
¬gc
 < 4)

482 
	`äùw—k_cmd_ruË_út_u§ge
();

483  
FRE_SUCCESS
;

485 
	`ssÿnf
(
¬gv
[2], "%d", &
šput
.
šdex
);

486 ià(
šput
.
šdex
 < 1 || iÅut.šdex > 
RULE_MAX
)

488 
	`FRCTWEAK_ERROR
("Invalid„ule index!");

489  
FRE_PARAM
;

492 
	`ssÿnf
(
¬gv
[3], "%d", &
šput
.
num
);

493 ià(
šput
.
num
 < 1 || iÅut.num > 
RULE_MAX
)

495 
	`FRCTWEAK_ERROR
("Invalid„ule‚umber!");

496  
FRE_PARAM
;

499 ià(
šput
.
šdex
 + iÅut.
num
 > 
RULE_MAX
 + 1)

501  
FRE_PARAM
;

504 
šdex
 = 
šput
.index;

505 
ruË_num
 = 
šput
.
num
;

506 
num
 = 
šput
.num / 
MAX_RULE
;

507 ià(
šput
.
num
%
MAX_RULE
)

509 
num
 +=1;

511 
j
 = 0; j < 
num
; j++)

513 
p
 = 
buf
;

514 ià(
j
 =ğ
num
-1)

516 ià(
ruË_num
%
MAX_RULE
)

518 
šput
.
num
 = 
ruË_num
 % 
MAX_RULE
;

520 
šput
.
num
 = 
MAX_RULE
;

524 
šput
.
num
 = 
MAX_RULE
;

527 
šput
.
šdex
 = index + 
j
 * 
MAX_RULE
;

528 
rv
 = 
	`äÿpi_ruË_¡©_g‘
(&
šput
, (
äc_ruË_¡©_out_t
 *)
buf
);

529 
	`UNPACK_U32
(
p
, 
¡©_out
.
num
);

532 
i
 =0; i < 
¡©_out
.
num
;i++)

534 
p
 = 
	`äc_ruË_¡©_uÅack
Õ, &
¡©_out
.
ruË_¡©
[
i
]);

535 
út
.
pkts
 +ğ
¡©_out
.
ruË_¡©
[
i
].
¡©
.pkts;

536 
út
.
by‹s
 +ğ
¡©_out
.
ruË_¡©
[
i
].
¡©
.bytes;

541 
	`´štf
("sum_pkts: %d\n", 
út
.
pkts
);

542 
	`´štf
("sum_by‹s: %d\n", 
út
.
by‹s
);

544 
FRCTWEAK_RULE_UPDATE_CMD
:

545 
rv
 = 
	`äÿpi_ruË_upd©e
();

547 
FRCTWEAK_RULE_NUM_GET_CMD
:

548 
rv
 = 
	`äÿpi_ruË_num_g‘
(&
ruË_num
);

549 
	`´štf
("Cu¼’ˆruËs: %d\n", 
ruË_num
);

551 
FRCTWEAK_RULE_MATCH_CMD
:

552 ià(
¬gc
 < 7)

554 
	`äùw—k_cmd_ruË_m©ch_u§ge
();

555  
FRE_SUCCESS
;

558 ià(
	`·r£_v4_šc
(
¬gv
[2], &
ss
, &
si
))

560 
	`´štf
("%s.%d\n", 
__func__
, 
__LINE__
);

561  
FRE_PARAM
;

564 ià(
	`·r£_v4_šc
(
¬gv
[3], &
ds
, &
di
))

566  
FRE_PARAM
;

569 ià(
	`·r£_u16_šc
(
¬gv
[4], &
¥s
, &
¥i
))

571 
	`´štf
("%s.%d\n", 
__func__
, 
__LINE__
);

572  
FRE_PARAM
;

575 ià(
	`·r£_u16_šc
(
¬gv
[5], &
dps
, &
dpi
))

577  
FRE_PARAM
;

580 ià(
	`·r£_´Ùoÿl
(
¬gv
[6], &
´Ùo
))

582  
FRE_PARAM
;

586 
tÙ®
 = 
si
 * 
di
 * 
¥i
 * 
dpi
;

588 ià(
tÙ®
 > 
RULE_MAX
)

590 
	`´štf
("TÙ® %d„uËs, ouˆoàbÚd.\n", 
tÙ®
);

591  
FRE_PARAM
;

595 
ruË_num
 = 
RULE_MAX
;

597 
k
=0;

598 
šput
.
šdex
 = 1;

599 
šput
.
num
 = 
ruË_num
;

600 
šdex
 = 
šput
.index;

601 
num
 = 
šput
.num / 
MAX_RULE
;

602 ià(
šput
.
num
%
MAX_RULE
)

604 
num
 +=1;

606 
j
 = 0; j < 
num
; j++)

608 
p
 = 
buf
;

609 ià(
j
 =ğ
num
-1)

611 ià(
ruË_num
%
MAX_RULE
)

613 
šput
.
num
 = 
ruË_num
 % 
MAX_RULE
;

615 
šput
.
num
 = 
MAX_RULE
;

619 
šput
.
num
 = 
MAX_RULE
;

622 
šput
.
šdex
 = index + 
j
 * 
MAX_RULE
;

623 
rv
 = 
	`äÿpi_ruË_¡©_g‘
(&
šput
, (
äc_ruË_¡©_out_t
 *)
buf
);

624 
	`UNPACK_U32
(
p
, 
¡©_out
.
num
);

627 
i
 =0; i < 
¡©_out
.
num
;i++)

629 
p
 = 
	`äc_ruË_¡©_uÅack
Õ, &
¡©_out
.
ruË_¡©
[
i
]);

630 
	`memıy
(&
ruË_¡©
[
k
], &
¡©_out
.ruË_¡©[
i
], (
äc_ruË_¡©_t
));

631 
k
 ++;

636 
se
 = 
ss
 + 
si
;

637 
de
 = 
ds
 + 
di
;

638 
¥e
 = 
¥s
 + 
¥i
;

639 
d³
 = 
dps
 + 
dpi
;

641 
s
 = 
ss
; s < 
se
; sip++)

643 
d
 = 
ds
; d < 
de
; dip++)

645 
¥
 = 
¥s
; s°< 
¥e
; sp++)

647 
dp
 = 
dps
; d°< 
d³
; dp++)

649 
ruË
[
cur
].
s
 = sip;

650 
ruË
[
cur
].
d
 = dip;

651 
ruË
[
cur
].
¥
 = sp;

652 
ruË
[
cur
].
dp
 = dp;

653 
ruË
[
cur
].
´Ùo
 =…roto;

655 
	`´štf
("s = 0x%x\n", 
ruË
[
cur
].
s
);

656 
	`´štf
("d = 0x%x\n", 
ruË
[
cur
].
d
);

657 
	`´štf
("¥ = %d\n", 
ruË
[
cur
].
¥
);

658 
	`´štf
("d°ğ%d\n", 
ruË
[
cur
].
dp
);

659 
	`´štf
("´ÙØğ%d,Ù® = %d\n", 
ruË
[
cur
].
´Ùo
, 
tÙ®
);

663 
rv
 = 
	`äÿpi_ruË_m©ch
(
ruË_¡©
, &
ruË
[
cur
], 
ruË_num
, &
m©ch_num
);

664 
cur
 ++;

670 
	`´štf
("m©ched: %d\n", 
m©ch_num
);

673  
FRE_PARAM
;

676  
rv
;

678 
	}
}

680 
	$äùw—k_ruË_cmd_š™
(
äùw—k_cmd_t
 *
cmd
)

682 
	`äùw—k_cmd_»gi¡”
(
cmd
, "ruË", "G‘ o¸£ˆfÜ„uË moduË", 
äùw—k_cmd_ruË
, 
äùw—k_cmd_ruË_u§ge
);

686 
	}
}

	@frctweak/frctweak_stat.c

1 
	~<¡dlib.h
>

2 
	~<¡ršg.h
>

4 
	~"äùw—k.h
"

5 
	~"äc_·ck.h
"

6 
	~"äc_dma.h
"

7 
	~"cvmx-sw­.h
"

8 
	~"äc_­i.h
"

9 
	~"äc_debug.h
"

11 *
	gäc_út_Çme
[
¡©_max
] = {

81 
	$äùw—k_cmd_¡©_ş—r_u§ge
()

83 
	`´štf
("% ş—¸¡©\n", 
´og¿m
);

84 
	}
}

86 
	$äùw—k_cmd_¡©_ş—r
(
¬gc
, **
¬gv
)

88 
rv
;

89 ià(
¬gc
 < 2)

91 
	`äùw—k_cmd_¡©_ş—r_u§ge
();

92  
FRE_SUCCESS
;

95 ià(
	`¡rcmp
("¡©", 
¬gv
[1]))

97  
FRE_PARAM
;

100 
rv
 = 
	`äÿpi_¡©_ş—r
();

102 ià(
rv
 !ğ
FRE_SUCCESS
)

104 
	`FRCTWEAK_ERROR
("CË¬ sˆoàäcÜç: %d!\n", 
rv
);

105  
rv
;

108  
FRE_SUCCESS
;

110 
	}
}

112 
	$äùw—k_cmd_¡©_g‘_u§ge
()

114 
	`´štf
("% ¡©\n", 
´og¿m
);

115 
	}
}

117 
	$äùw—k_cmd_¡©_g‘
(
¬gc
,**
¬gv
)

119 
	#STAT_GET_ONCE_SIZE
 12

	)

120 
rv
, 
i
;

121 
ušt64_t
 
¡©
[
¡©_max
];

122 
¡©_Çme
[
FRC_STAT_NAME_SIZE
];

123 
äc_¡©_İ_š_t
 
šput
;

124 
	`mem£t
(
¡©
, 0, (stat));

125 
num
;

126 
num
 = 
¡©_max
 / 
STAT_GET_ONCE_SIZE
;

127 ià(
¡©_max
 % 
STAT_GET_ONCE_SIZE
)

129 
num
 += 1;

131 
i
 = 0; i < 
num
; i++)

133 ià(
i
 =ğ
num
 -1)

135 ià(
¡©_max
 % 
STAT_GET_ONCE_SIZE
)

137 
šput
.
num
 = 
¡©_max
 % 
STAT_GET_ONCE_SIZE
;

139 
šput
.
num
 = 
STAT_GET_ONCE_SIZE
;

142 
šput
.
num
 = 
STAT_GET_ONCE_SIZE
;

145 
šput
.
šdex
 = 
i
 * 
STAT_GET_ONCE_SIZE
;

147 
rv
 = 
	`äÿpi_pkt_¡©_g‘
(&
šput
, &
¡©
[
i
 * 
STAT_GET_ONCE_SIZE
]);

149 ià(
rv
 !ğ
FRE_SUCCESS
)

151 
	`´štf
("G‘ sˆoàäcÜç: %d!\n", 
rv
);

152  
FRE_FAIL
;

157 
	`sw­_buff
(
¡©_max
, 
¡©
);

158 
i
 = 0; i < 
¡©_max
; i++)

160 ià(
¡©
[
i
] > 0) {

161 
	`äc_¡©_Çme_g‘
(
i
, 
¡©_Çme
);

162 
	`´štf
("%-20s: %Îd\n", 
¡©_Çme
, (
ULL
)
¡©
[
i
]);

166  
FRE_SUCCESS
;

167 
	}
}

170 
	$äùw—k_¡©_cmd_š™
(
äùw—k_cmd_t
 *
cmd
)

172 
	`äùw—k_cmd_»gi¡”
(
cmd
, "ş—r", "ş—¸·ck‘ ¡©i¡ic", 
äùw—k_cmd_¡©_ş—r
, 
äùw—k_cmd_¡©_ş—r_u§ge
);

173 
	`äùw—k_cmd_»gi¡”
(
cmd
, "¡©", "G‘ st™ic oà®È·ck‘s", 
äùw—k_cmd_¡©_g‘
, 
äùw—k_cmd_¡©_g‘_u§ge
);

177 
	}
}

	@frctweak/frctweak_test.c

1 
	~<¡dlib.h
>

2 
	~<¡ršg.h
>

4 
	~<time.h
>

5 
	~<sys/mmª.h
>

6 
	~<sys/time.h
>

7 
	~<±h»ad.h
>

9 
	~"äùw—k.h
"

10 
	~"äc_dma.h
"

14 
	$äùw—k_cmd_‹¡_u§ge
()

16 
	`´štf
("% Õkt|dma|chªèOPTIONS\n", 
´og¿m
);

17 
	}
}

19 
	$äùw—k_cmd_‹¡
(
¬gc
, **
¬gv
)

21 
	`´štf
("% Õkt|dma|chªèOPTIONS\n", 
´og¿m
);

23 
	}
}

24 #ià
FRC_CONFIG_QUEUE_TEST


25 
	$äùw—k_cmd_‹¡_dma_pkt_u§ge
()

27 
	`´štf
("% (driv”|cÜeèÑı|udpèNUMBER [LENGTH]\n", 
´og¿m
);

28 
	`´štf
("\nOPTIONS:\n");

29 
	`´štf
(" %-16s --%s", "dirver", "Generate data from driver.\n");

30 
	`´štf
(" %-16s --%s", "core", "Generate data from driver.\n");

31 
	`´štf
(" %-16s --%s", "tcp", "Generatecp data.\n");

32 
	`´štf
(" %-16s --%s", "udp", "Generate udp data.\n");

33 
	`´štf
(" %-16s --%s", "NUMBER", "Number of block.\n");

34 
	`´štf
(" %-16s --%s", "LENGTH", "Length of…akcet.\n");

35 
	}
}

37 
	$äùw—k_cmd_‹¡_dma_pkt
(
¬gc
, **
¬gv
)

39 
rv
;

40 
ušt16_t
 
Ş’
;

41 
äc_pkt_dma_‹¡_t
 
‹¡
;

42 
ušt16_t
 
ty³
;

43 
ušt16_t
 
cmd
;

45 ià((
¬gc
 != 4) || (argc != 5))

47  
FRE_PARAM
;

50 ià(!
	`¡rcmp
("driv”", 
¬gv
[1]))

52 
ty³
 = 
CMD_TYPE_DRV
;

53 ià(!
	`¡rcmp
("tı", 
¬gv
[2]))

55 
cmd
 = 
DRV_CMD_TEST_TCP
;

57 if(!
	`¡rcmp
("udp", 
¬gv
[2]))

59 
cmd
 = 
DRV_CMD_TEST_UDP
;

63  
FRE_PARAM
;

66 ià(!
	`¡rcmp
("cÜe", 
¬gv
[1]))

68 
ty³
 = 
CMD_TYPE_TEST
;

69 ià(!
	`¡rcmp
("tı", 
¬gv
[2]))

71 
cmd
 = 
TEST_CMD_TCP_DMA
;

73 if(!
	`¡rcmp
("udp", 
¬gv
[2]))

75 
cmd
 = 
TEST_CMD_UDP_DMA
;

79  
FRE_PARAM
;

84  
FRE_PARAM
;

87 
	`mem£t
(&
‹¡
, 0, (
äc_pkt_dma_‹¡_t
));

89 
‹¡
.
num
 = 
	`©oi
(
¬gv
[3]);

91 
Ş’
 = (
äc_pkt_dma_‹¡_t
);

93 ià(
¬gc
 == 5)

95 
‹¡
.
Ën
 = 
	`©oi
(
¬gv
[4]);

98 
rv
 = 
	`äÿpi
(
ty³
, 
cmd
, (
äc_pkt_dma_‹¡_t
), &
‹¡
, 
NULL
, NULL);

99 ià(
rv
 !ğ
FRE_SUCCESS
)

101 
	`FRCTWEAK_ERROR
("commªdƒxecu‹ fa: %d!\n", 
rv
);

102  
rv
;

105  
FRE_SUCCESS
;

106 
	}
}

108 #ià
FRC_CONFIG_DMA_TEST


109 
	#DMA_LOOP_VAILD_DATA
 1

	)

110 
	#DMA_LOOP_SLEEP
 1

	)

112 
ušt64_t
 
	mrx_’Œ›s
;

113 
ušt64_t
 
	mrx_by‹s
;

114 
ušt64_t
 
	mtx_’Œ›s
;

115 
ušt64_t
 
	mtx_by‹s
;

116 
ušt64_t
 
	m”r_by‹s
;

117 } 
	tdma_loİ_¡©_t
;

119 
dma_loİ_¡©_t
 
	gdma_loİ_¡©
;

120 
ušt32_t
 
	gdma_loİ_’Œ›s
 = 0;

121 
	gcÜe_num
 = 0;

122 
	gpkt_Ën
 = 0;

123 
äc_dma_loİ_buff_t
 *
	gäùw—k_dma_loİ_tx_buff
 = 
NULL
, *
	gäùw—k_dma_loİ_rx_buff
 = NULL;

125 
	#DUMP_STAT_TITLE
 \

126 
	`´štf
(" %5s %16s %16s %16s %16s %16s %9s %9s\n", \

127 "TIME", "RX_ENTRIES", "RX_BYTES", "TX_ENTRIES", "TX_BYTES", "ERR_BYTES", "CUR SPEED", "AVG SPEED")

	)

129 
dma_loİ_¡©_t
 
	g¡©_now
, 
	g¡©_Şd
;

130 
timev®
 
	g¡¬t_time
;

133 
	$dma_¡©_dump
()

135 
ušt64_t
 
cur_¥“d
, 
avg_¥“d
, 
¥’d
;

136 
cur_un™
, 
avg_un™
;

137 
timev®
 
now
;

138 
	`g‘timeofday
(&
now
, 
NULL
);

140 
	`memıy
(&
¡©_now
, &
dma_loİ_¡©
, (
dma_loİ_¡©_t
));

142 
¥’d
 = 
now
.
tv_£c
 - 
¡¬t_time
.tv_sec;

143 ià(
¥’d
 == 0)

145 
¥’d
 = 1;

147 
avg_¥“d
 = 
¡©_now
.
rx_by‹s
 / 
¥’d
;

148 ià(
avg_¥“d
 < 1024)

150 
avg_un™
 = 'B';

152 ià(
avg_¥“d
 > (1024 * 1024))

154 
avg_¥“d
 /= 1024 * 1024;

155 
avg_un™
 = 'M';

159 
avg_¥“d
 /= 1024;

160 
avg_un™
 = 'K';

163 
cur_¥“d
 = 
¡©_now
.
rx_by‹s
 - 
¡©_Şd
.rx_bytes;

164 ià(
cur_¥“d
 < 1024)

166 
cur_un™
 = 'B';

168 ià(
cur_¥“d
 > (1024 * 1024))

170 
cur_¥“d
 /= 1024 * 1024;

171 
cur_un™
 = 'M';

175 
cur_¥“d
 /= 1024;

176 
cur_un™
 = 'K';

178 
	`´štf
("\¸ %5ld %16Îd %16Îd %16Îd %16Îd %16Îd %8Îd%C %8Îd%C", 
now
.
tv_£c
- 
¡¬t_time
.tv_sec,

179 (
ULL
è
¡©_now
.
rx_’Œ›s
, (ULLè¡©_now.
rx_by‹s
,

180 (
ULL
è
¡©_now
.
tx_’Œ›s
, (ULLè¡©_now.
tx_by‹s
,

181 (
ULL
è
¡©_now
.
”r_by‹s
, (ULLè
cur_¥“d
, 
cur_un™
, (ULLè
avg_¥“d
, 
avg_un™
);

182 
	`fæush
(
¡dout
);

183 
	`memıy
(&
¡©_Şd
, &
¡©_now
, (
dma_loİ_¡©_t
));

184 
	}
}

186 
	$dma_¡©_loİ
()

189 
DUMP_STAT_TITLE
;

193 
	`dma_¡©_dump
();

194 ià(
dma_loİ_¡©
.
rx_’Œ›s
 =ğ
dma_loİ_’Œ›s
)

196 
	`´štf
("\n");

199 
	`¦“p
(1);

201 
	}
}

206 
	$dma_rx
(
Ën
, 
ušt8_t
 
v®ue
)

208 
i
;

210 
äc_dma_loİ_buff_t
 *
rx_buff
;

211 
ušt64_t
 
widx
, 
ridx
, 
off£t
;

212 
ušt8_t
 *
buå
;

213 
dma_loİ_¡©_t
 *
¡©
;

214 
Ën1
, 
Ën2
;

216 
time¥ec
 
¦“±ime
;

217 
¦“±ime
.
tv_£c
 = 0;

218 
¦“±ime
.
tv_n£c
 = 10;

220 
rx_buff
 = 
äùw—k_dma_loİ_rx_buff
;

221 
¡©
 = &
dma_loİ_¡©
;

225 
widx
 = 
rx_buff
->widx;

226 
ridx
 = 
rx_buff
->ridx;

228 ià((
widx
 - 
ridx
è>ğ
Ën
)

230 #ià
DMA_LOOP_VAILD_DATA


231 
off£t
 = 
ridx
 % 
FRC_DMA_LOOP_BUFF_SIZE
;

233 ià((
off£t
 + 
Ën
è> 
FRC_DMA_LOOP_BUFF_SIZE
)

235 
buå
 = 
rx_buff
->
buff
 + 
off£t
;

236 
Ën1
 = 
FRC_DMA_LOOP_BUFF_SIZE
 - 
off£t
;

237 
i
 = 0; i < 
Ën1
; i++)

239 ià((
buå
[
i
] & 0xffè!ğ
v®ue
)

242 
¡©
->
”r_by‹s
++;

246 
buå
 = 
rx_buff
->
buff
;

247 
Ën2
 = 
Ën
 - 
Ën1
;

248 
i
 = 0; i < 
Ën2
; i++)

250 ià((
buå
[
i
] & 0xffè!ğ
v®ue
)

253 
¡©
->
”r_by‹s
++;

259 
buå
 = 
rx_buff
->
buff
 + 
off£t
;

260 
i
 = 0; i < 
Ën
; i++)

262 ià((
buå
[
i
] & 0xffè!ğ
v®ue
)

265 
¡©
->
”r_by‹s
++;

270 
rx_buff
->
ridx
 +ğ
Ën
;

271 
¡©
->
rx_by‹s
 +ğ
Ën
;

272 
¡©
->
rx_’Œ›s
 += 1;

275 #ià
DMA_LOOP_SLEEP


277 
	`Çno¦“p
(&
¦“±ime
, &sleeptime);

281 
	}
}

283 
	$dma_tx
(
Ën
, 
ušt8_t
 
v®ue
)

285 
äc_dma_loİ_buff_t
 *
tx_buff
;

286 
ušt64_t
 
widx
, 
ridx
, 
off£t
, 
Ën1
, 
Ën2
;

287 
ušt8_t
 *
buå
;

288 
dma_loİ_¡©_t
 *
¡©
;

290 
time¥ec
 
¦“±ime
;

291 
¦“±ime
.
tv_£c
 = 0;

292 
¦“±ime
.
tv_n£c
 = 10;

294 
tx_buff
 = 
äùw—k_dma_loİ_tx_buff
;

295 
¡©
 = &
dma_loİ_¡©
;

299 
widx
 = 
tx_buff
->widx;

300 
ridx
 = 
tx_buff
->ridx;

302 ià((
widx
 - 
ridx
è< (
FRC_DMA_LOOP_BUFF_SIZE
 - 
Ën
))

304 #ià
DMA_LOOP_VAILD_DATA


305 
off£t
 = 
widx
 % 
FRC_DMA_LOOP_BUFF_SIZE
;

307 
buå
 = 
tx_buff
->
buff
 + 
off£t
;

308 ià((
off£t
 + 
Ën
è> 
FRC_DMA_LOOP_BUFF_SIZE
)

310 
Ën1
 = 
FRC_DMA_LOOP_BUFF_SIZE
 - 
off£t
;

311 
	`mem£t
(
buå
, 
v®ue
, 
Ën1
);

312 
Ën2
 = 
Ën
 - 
Ën1
;

313 
buå
 = 
tx_buff
->
buff
;

314 
	`mem£t
(
buå
, 
v®ue
, 
Ën2
);

318 
	`mem£t
(
buå
, 
v®ue
, 
Ën
);

321 
tx_buff
->
widx
 = widx + 
Ën
;

322 
¡©
->
tx_by‹s
 +ğ
Ën
;

323 
¡©
->
tx_’Œ›s
 += 1;

326 #ià
DMA_LOOP_SLEEP


329 
	`Çno¦“p
(&
¦“±ime
, &sleeptime);

333 
	}
}

335 
	$dma_‹¡_loİ
(
Ën
, 
ušt32_t
 
’tœes
)

337 
ušt32_t
 
i
;

338 
ušt8_t
 
v®ue
;

340 
Şd_£c
;

341 
timev®
 
now
;

342 
	`g‘timeofday
(&
now
, 
NULL
);

343 
Şd_£c
 = 
now
.
tv_£c
;

344 
DUMP_STAT_TITLE
;

345 
i
 = 0; i < 
’tœes
; i++)

347 ià(
i
 % 2)

349 
v®ue
 = 0X5A;

353 
v®ue
 = 0xA5;

356 
	`dma_tx
(
Ën
, 
v®ue
);

357 
	`dma_rx
(
Ën
, 
v®ue
);

359 ià((
i
 & 0xf) == 0)

361 
	`g‘timeofday
(&
now
, 
NULL
);

362 ià(
now
.
tv_£c
 - 
Şd_£c
)

364 
	`dma_¡©_dump
();

365 
Şd_£c
 = 
now
.
tv_£c
;

369 
	`dma_¡©_dump
();

370 
	`´štf
(".\n");

371 
	}
}

373 *
	$dma_rx_th»ad
(* 
¬g
)

375 
ušt32_t
 
»maš
 = 
dma_loİ_’Œ›s
;

376 
ušt8_t
 
v®ue
;

378 
»maš
)

380 ià(
»maš
 & 0x1)

382 
v®ue
 = 0x5a;

386 
v®ue
 = 0xa5;

388 
	`dma_rx
(
pkt_Ën
, 
v®ue
);

389 
»maš
--;

392  
NULL
;

393 
	}
}

395 *
	$dma_tx_th»ad
(* 
¬g
)

397 
ušt32_t
 
»maš
 = 
dma_loİ_’Œ›s
;

398 
ušt32_t
 
v®ue
 = 0;

399 
»maš
)

401 ià(
»maš
 & 0x1)

403 
v®ue
 = 0x5a;

407 
v®ue
 = 0xa5;

409 
	`dma_tx
(
pkt_Ën
, 
v®ue
);

410 
»maš
--;

414  
NULL
;

415 
	}
}

417 
	$äùw—k_cmd_‹¡_dma_loİ_u§ge
()

419 
	`´štf
("% (LEN ENTRIES CORE)\n", 
´og¿m
);

420 
	`´štf
("\nOPTIONS:\n");

421 
	`´štf
(" %-16s --%s", "LEN", "Len of…acket.\n");

422 
	`´štf
(" %-16s --%s", "ENTRIES", "Number ofƒntries data†oop. Entry size 1024 Bytes.\n");

423 
	`´štf
(" %-16s --%s", "CORE", "Index of core.\n");

424 
	}
}

426 
	$äùw—k_cmd_‹¡_dma_loİ
(
¬gc
, **
¬gv
)

428 
mfd
 = 0;

429 
äc_dma_loİ_¬g_t
 
loİ_¬g
;

430 
ušt16_t
 
Ş’
;

431 
rv
;

432 
ušt64_t
 
cid
;

434 ià(
¬gc
 != 4)

436  
FRE_PARAM
;

439 
pkt_Ën
 = 
	`©oi
(
¬gv
[1]);

440 
dma_loİ_’Œ›s
 = 
	`©oi
(
¬gv
[2]);

441 
cÜe_num
 = 
	`©oi
(
¬gv
[3]);

443 
cid
 = 
cÜe_num
;

444 
Ş’
 = 0;

445 
rv
 = 
	`äÿpi
(
CMD_TYPE_TEST
, 
TEST_CMD_DMA_LOOP_START
, 8, &
cid
, &
Ş’
, 
NULL
);

446 ià(
rv
 !ğ
FRE_SUCCESS
)

448 
	`FRCTWEAK_ERROR
("commªdƒxecu‹ fa: %d!\n", 
rv
);

453 
	`mem£t
(&
loİ_¬g
, 0, (
äc_dma_loİ_¬g_t
));

455 
Ş’
 = (
äc_dma_loİ_¬g_t
);

456 
rv
 = 
	`äÿpi
(
CMD_TYPE_DRV
, 
DRV_CMD_DMA_LOOP_BUFF_GET
, 0, 
NULL
, &
Ş’
, &
loİ_¬g
);

457 ià(
rv
 !ğ
FRE_SUCCESS
)

459 
	`FRCTWEAK_ERROR
("commªdƒxecu‹ fa: %d!\n", 
rv
);

460 
äùw—k_cmd_‹¡_dma_loİ_”r
;

465 
mfd
 = 
	`İ’
("/dev/mem",
O_RDWR
);

466 ià(
mfd
 < 0)

468 
	`FRCTWEAK_ERROR
("Can't open /dev/mem !\n");

469 
rv
 = 
FRE_FAIL
;

470 
äùw—k_cmd_‹¡_dma_loİ_”r
;

474 
äùw—k_dma_loİ_rx_buff
 = 
	`mm­
(0, 
FRC_DMA_BUFF_SIZE
, 
PROT_READ
|
PROT_WRITE
, 
MAP_SHARED
, 
mfd
, 
loİ_¬g
.
rx_addr
[
cÜe_num
]);

475 ià(
äùw—k_dma_loİ_rx_buff
 =ğ
NULL
)

477 
	`FRCTWEAK_ERROR
("mm­ dm¨loİ„x bufà%d fa!\n", 
cÜe_num
);

478 
rv
 = 
FRE_MEMORY
;

479 
äùw—k_cmd_‹¡_dma_loİ_”r
;

482 
äùw—k_dma_loİ_tx_buff
 = 
	`mm­
(0, 
FRC_DMA_BUFF_SIZE
, 
PROT_READ
|
PROT_WRITE
, 
MAP_SHARED
, 
mfd
, 
loİ_¬g
.
tx_addr
[
cÜe_num
]);

483 ià(
äùw—k_dma_loİ_tx_buff
 =ğ
NULL
)

485 
	`FRCTWEAK_ERROR
("mm­ dm¨loİx bufà%d fa!\n", 
cÜe_num
);

486 
rv
 = 
FRE_MEMORY
;

487 
äùw—k_cmd_‹¡_dma_loİ_”r
;

492 
	`mem£t
(&
dma_loİ_¡©
, 0, (
dma_loİ_¡©_t
));

493 
	`mem£t
(&
¡©_now
, 0, (
dma_loİ_¡©_t
));

494 
	`mem£t
(&
¡©_Şd
, 0, (
dma_loİ_¡©_t
));

495 
	`g‘timeofday
(&
¡¬t_time
, 
NULL
);

497 
	`dma_‹¡_loİ
(
pkt_Ën
, 
dma_loİ_’Œ›s
);

499 
±h»ad_t
 
tx_th»ad
, 
rx_th»ad
;

500 
rx_th»ad
 = 
	`±h»ad_ü—‹
(&rx_th»ad, 
NULL
, 
dma_rx_th»ad
, &
dma_loİ_’Œ›s
);

501 
tx_th»ad
 = 
	`±h»ad_ü—‹
(&tx_th»ad, 
NULL
, 
dma_tx_th»ad
, &
dma_loİ_’Œ›s
);

503 
	`dma_¡©_loİ
();

505 
äùw—k_cmd_‹¡_dma_loİ_”r
:

506 ià(
mfd
 > 0)

508 
	`şo£
(
mfd
);

510 ià(
rv
)

512  
FRE_FAIL
;

514  
FRE_SUCCESS
;

515 
	}
}

518 #ià
FRC_CONFIG_SIMPLE_PACKET_TEST
 || 
FRC_CONFIG_SSN_CHAN_TEST


519 
	$äùw—k_cmd_‹¡_chª_u§ge
()

521 
	`´štf
("% (CHAN)\n", 
´og¿m
);

522 
	`´štf
("\nOPTIONS:\n");

523 
	`´štf
(" %-16s --%s", "CHAN", "CHAN ID, 0 for UDP, 1 for RULE, 2 for SSN.\n");

524 
	}
}

526 
	$äùw—k_cmd_‹¡_chª
(
¬gc
, **
¬gv
)

528 
ušt16_t
 
Ş’
;

529 
rv
;

530 
ušt64_t
 
chª
;

532 ià(
¬gc
 != 2)

534  
FRE_PARAM
;

537 
chª
 = 
	`©oi
(
¬gv
[1]);

539 
rv
 = 
	`äÿpi_chª_‹¡_¡¬t
(&
chª
, &
Ş’
);

540 ià(
rv
 !ğ
FRE_SUCCESS
)

542 
	`FRCTWEAK_ERROR
("commªdƒxecu‹ fa: %d!\n", 
rv
);

545  
FRE_SUCCESS
;

546 
	}
}

549 
	$äùw—k_‹¡_cmd_š™
(
äùw—k_cmd_t
 *
cmd
)

551 #ià(
FRC_CONFIG_QUEUE_TEST
 | 
FRC_CONFIG_DMA_TEST
 | 
FRC_CONFIG_SIMPLE_PACKET_TEST
 | 
FRC_CONFIG_SSN_CHAN_TEST
 )

552 
äùw—k_cmd_t
 *
‹¡_cmd
;

554 
‹¡_cmd
 = 
	`äùw—k_cmd_»gi¡”
(
cmd
, "‹¡", "DØsom‹¡", 
äùw—k_cmd_‹¡
, 
äùw—k_cmd_‹¡_u§ge
);

556 #ià
FRC_CONFIG_QUEUE_TEST


557 
	`äùw—k_cmd_»gi¡”
(
‹¡_cmd
, "pkt", "Te¡ dm¨pkˆŒªsãr.", 
äùw—k_cmd_‹¡_dma_pkt
, 
äùw—k_cmd_‹¡_dma_pkt_u§ge
);

559 #ià
FRC_CONFIG_DMA_TEST


560 
	`äùw—k_cmd_»gi¡”
(
‹¡_cmd
, "dma", "DMA†oİe¡.", 
äùw—k_cmd_‹¡_dma_loİ
, 
äùw—k_cmd_‹¡_dma_loİ_u§ge
);

562 #ià
FRC_CONFIG_SIMPLE_PACKET_TEST
 || 
FRC_CONFIG_SSN_CHAN_TEST


563 
	`äùw—k_cmd_»gi¡”
(
‹¡_cmd
, "chª", "DMA†oİe¡.", 
äùw—k_cmd_‹¡_chª
, 
äùw—k_cmd_‹¡_chª_u§ge
);

566 
	}
}

	@frctweak/frctweak_timestamp_check.c

1 
	~<¡dlib.h
>

2 
	~<¡ršg.h
>

4 
	~"äùw—k.h
"

5 
	~"äc_·ck.h
"

6 
	~"äc_dma.h
"

7 
	~"cvmx-sw­.h
"

8 
	~"äc_­i.h
"

9 
	~"äc_debug.h
"

11 #ià
FRC_CONFIG_TIMESTAMP_CHECK


14 
	mFRCTWEAK_TIMESTAMP_CHECK_GET_PARAMETER_CMD
,

15 
	mFRCTWEAK_TIMESTAMP_CHECK_SET_PARAMETER_CMD
,

16 
	mFRCTWEAK_TIMESTAMP_CHECK_GET_STAT_CMD
,

17 
	mFRCTWEAK_TIMESTAMP_CHECK_CLEAR_STAT_CMD
,

18 }
	täùw—k_time¡amp_check_t
;

21 
	$äùw—k_cmd_time¡amp_check_u§ge
()

23 
	`´štf
("U§ge: % time¡amp_check SUBCOMMAND OPTION\n",
´og¿m
);

24 
	`´štf
(" % time¡amp_check st\n", 
´og¿m
);

25 
	`´štf
(" % time¡amp_check cË¬\n", 
´og¿m
);

26 
	`´štf
("\n SUBCOMMAND:\n");

27 
	`´štf
(" stat -- Getimestamp_check statistics.\n");

28 
	`´štf
(" clear -- Clearimestamp_check statistics.\n");

29 
	}
}

32 
	$äùw—k_cmd_time¡amp_¡©_u§ge
()

34 
	`´štf
("USAGE: % time¡amp_check sˆPORT\n",
´og¿m
);

35 
	}
}

37 
	$äùw—k_time¡amp_check_¡©_g‘
()

39 
	#STAT_GET_ONCE_SIZE
 12

	)

40 
rv
, 
i
;

41 
ušt64_t
 
¡©
[
¡©_time¡amp_max
];

42 
¡©_Çme
[42];

43 
äc_time¡amp_İ_š_t
 
šput
;

44 
	`mem£t
(
¡©
, 0, (stat));

45 
num
;

46 
num
 = 
¡©_time¡amp_max
 / 
STAT_GET_ONCE_SIZE
;

47 ià(
¡©_time¡amp_max
 % 
STAT_GET_ONCE_SIZE
)

49 
num
 += 1;

51 
i
 = 0; i < 
num
; i++)

53 ià(
i
 =ğ
num
 -1)

55 ià(
¡©_time¡amp_max
 % 
STAT_GET_ONCE_SIZE
)

57 
šput
.
num
 = 
¡©_time¡amp_max
 % 
STAT_GET_ONCE_SIZE
;

59 
šput
.
num
 = 
STAT_GET_ONCE_SIZE
;

62 
šput
.
num
 = 
STAT_GET_ONCE_SIZE
;

65 
šput
.
šdex
 = 
i
 * 
STAT_GET_ONCE_SIZE
;

67 
rv
 = 
	`äÿpi_time¡amp_check_¡©_g‘
(&
šput
, &
¡©
[
i
 * 
STAT_GET_ONCE_SIZE
]);

69 ià(
rv
 !ğ
FRE_SUCCESS
)

71 
	`´štf
("G‘ sˆoàäcÜç: %d!\n", 
rv
);

72  
FRE_FAIL
;

77 
	`sw­_buff
(
¡©_time¡amp_max
, 
¡©
);

78 
i
 = 0; i < 
¡©_time¡amp_max
; i++)

80 ià(
¡©
[
i
] > 0) {

81 
	`äc_time¡amp_¡©_Çme_g‘
(
i
, 
¡©_Çme
);

82 
	`´štf
("%-40s: %Îd\n", 
¡©_Çme
, (
ULL
)
¡©
[
i
]);

86  
FRE_SUCCESS
;

87 
	}
}

89 
	$äùw—k_cmd_time¡amp_check
(
¬gc
, **
¬gv
)

91 
rv
;

92 
İ
;

93 
ušt8_t
 
time¡amp_check_ty³
;

94 
ušt16_t
 
¡¬t_id
;

95 
ušt16_t
 
numb”
;

96 ià(
¬gc
 < 2)

98 
	`äùw—k_cmd_time¡amp_check_u§ge
();

99  
FRE_SUCCESS
;

101 ià(!(
	`¡rcmp
("¡©", 
¬gv
[1])))

103 
İ
 = 
FRCTWEAK_TIMESTAMP_CHECK_GET_STAT_CMD
;

105 ià(!(
	`¡rcmp
("ş—r", 
¬gv
[1])))

107 
İ
 = 
FRCTWEAK_TIMESTAMP_CHECK_CLEAR_STAT_CMD
;

111 
	`äùw—k_cmd_time¡amp_check_u§ge
();

115 
İ
)

117 
FRCTWEAK_TIMESTAMP_CHECK_GET_STAT_CMD
:

118 
rv
 = 
	`äùw—k_time¡amp_check_¡©_g‘
();

119 ià(
rv
)

121 
	`´štf
("E¼Ü„v=%d\n", 
rv
);

122  
FRE_FAIL
;

125 
FRCTWEAK_TIMESTAMP_CHECK_CLEAR_STAT_CMD
:

126 
rv
 = 
	`äÿpi_time¡amp_check_¡©_ş—r
();

127 ià(
rv
)

129 
	`´štf
("E¼Ü„v=%d\n", 
rv
);

130  
FRE_FAIL
;

134  
FRE_PARAM
;

137  
rv
;

139 
	}
}

141 
	$äùw—k_time¡amp_check_cmd_š™
(
äùw—k_cmd_t
 *
cmd
)

143 
	`äùw—k_cmd_»gi¡”
(
cmd
, "time¡amp_check", "G‘ o¸£ˆfÜime¡amp_check moduË", 
äùw—k_cmd_time¡amp_check
, 
äùw—k_cmd_time¡amp_check_u§ge
);

147 
	}
}

	@frctweak/frctweak_udp.c

1 
	~<¡dlib.h
>

2 
	~<¡ršg.h
>

4 
	~"äùw—k.h
"

5 
	~"äc_·ck.h
"

6 
	~"äc_dma.h
"

7 
	~"cvmx-sw­.h
"

8 
	~"äc_­i.h
"

9 
	~"äc_debug.h
"

11 #ià
FRC_CONFIG_UDP


14 
	mFRCTWEAK_UDP_STATUS_CMD
,

15 
	mFRCTWEAK_UDP_ENABLE_CMD
,

16 
	mFRCTWEAK_UDP_DISABLE_CMD
,

17 }
	täùw—k_udp_t
;

19 
	$äùw—k_cmd_udp_u§ge
()

21 
	`´štf
("U§ge: % ud°SUBCOMMAND OPTION\n",
´og¿m
);

22 
	`´štf
(" % ud°¡©us\n",
´og¿m
);

23 
	`´štf
(" % ud°’abË\n",
´og¿m
);

24 
	`´štf
(" % ud°di§bË\n",
´og¿m
);

25 
	`´štf
("\n SUBCOMMAND:\n");

26 
	`´štf
(" status -- Get udp module status:(enable|disable).\n");

27 
	`´štf
("ƒnable -- Enable udp module.\n");

28 
	`´štf
(" disable -- Disable udp module.\n");

29 
	}
}

32 
	$äùw—k_cmd_udp
(
¬gc
, **
¬gv
)

34 
rv
;

35 
İ
;

36 
ušt8_t
 
’abË
;

39 ià(
¬gc
 < 2)

41 
	`äùw—k_cmd_udp_u§ge
();

42  
FRE_SUCCESS
;

45 ià(!(
	`¡rcmp
("¡©us", 
¬gv
[1])))

47 
İ
 = 
FRCTWEAK_UDP_STATUS_CMD
;

50 ià(!
	`¡rcmp
("’abË", 
¬gv
[1]))

52 
İ
 = 
FRCTWEAK_UDP_ENABLE_CMD
;

55 ià(!
	`¡rcmp
("di§bË", 
¬gv
[1]))

57 
İ
 = 
FRCTWEAK_UDP_DISABLE_CMD
;

61 
	`äùw—k_cmd_udp_u§ge
();

65 
İ
)

67 
FRCTWEAK_UDP_STATUS_CMD
:

68 
rv
 = 
	`äÿpi_udp_¡©us_g‘
(&
’abË
);

69 
	`´štf
("UDP funùiÚ stus: %s\n", 
’abË
?"enable":"disable");

71 
FRCTWEAK_UDP_ENABLE_CMD
:

72 
FRCTWEAK_UDP_DISABLE_CMD
:

73 ià(
	`·r£_boŞ
(
¬gv
[1], &
’abË
))

75  
FRE_PARAM
;

78 
rv
 = 
	`äÿpi_udp_’abË
(
’abË
);

81  
FRE_PARAM
;

84  
rv
;

86 
	}
}

88 
	$äùw—k_udp_cmd_š™
(
äùw—k_cmd_t
 *
cmd
)

90 
	`äùw—k_cmd_»gi¡”
(
cmd
, "udp", "G‘ o¸£ˆfÜ ud°moduË", 
äùw—k_cmd_udp
, 
äùw—k_cmd_udp_u§ge
);

94 
	}
}

	@frctweak/frctweak_vlan_check.c

1 
	~<¡dlib.h
>

2 
	~<¡ršg.h
>

4 
	~"äùw—k.h
"

5 
	~"äc_·ck.h
"

6 
	~"äc_dma.h
"

7 
	~"cvmx-sw­.h
"

8 
	~"äc_­i.h
"

9 
	~"äc_debug.h
"

11 #ià
FRC_CONFIG_VLAN_CHECK


14 
	mFRCTWEAK_VLAN_CHECK_GET_PARAMETER_CMD
,

15 
	mFRCTWEAK_VLAN_CHECK_SET_PARAMETER_CMD
,

16 
	mFRCTWEAK_VLAN_CHECK_GET_STAT_CMD
,

17 
	mFRCTWEAK_VLAN_CHECK_CLEAR_STAT_CMD
,

18 }
	täùw—k_vÏn_check_t
;

20 *
	gäùw—k_vÏn_check_ty³_¡r
[
FRC_VLAN_CHECK_MAX
]= {

27 
	$äùw—k_cmd_vÏn_check_u§ge
()

29 
	`´štf
("U§ge: % vÏn_check SUBCOMMAND OPTION\n",
´og¿m
);

30 
	`´štf
(" % vÏn_check stus\n",
´og¿m
);

31 
	`´štf
(" % vÏn_check s‘ Ty³ S¹ Num\n", 
´og¿m
);

32 
	`´štf
(" % vÏn_check sˆPORT\n", 
´og¿m
);

33 
	`´štf
(" % vÏn_check cË¬\n", 
´og¿m
);

34 
	`´štf
("\n SUBCOMMAND:\n");

35 
	`´štf
(" status -- Get vlan_check module…arameter.\n");

36 
	`´štf
(" set -- Set vlan_check…arameter.\n");

37 
	`´štf
(" stat -- Get vlan_check statistics.\n");

38 
	`´štf
(" clear -- Clear vlan_check statistics.\n");

39 
	`´štf
("\n OPTION:\n");

40 
	`´štf
(" Type -- Type, (SIP | DIP | SDIP).\n");

41 
	`´štf
(" Start -- Start ID\n");

42 
	`´štf
(" Num -- Vlan id Number, <=256\n");

43 
	`´štf
(" PORT -- Physic…ort, (xe0 | xe1).\n");

44 
	}
}

46 
	$äùw—k_cmd_vÏn_check_£t_u§ge
()

48 
	`´štf
("USAGE: % vÏn_check s‘ Ty³ S¹ Num\n",
´og¿m
);

49 
	`´štf
("\n OPTION:\n");

50 
	`´štf
(" Type -- Type, (SIP | DIP | SDIP).\n");

51 
	`´štf
(" Start -- Start ID\n");

52 
	`´štf
(" Num -- Vlan id Number, <=256\n");

53 
	}
}

55 
	$äùw—k_cmd_vÏn_¡©_u§ge
()

57 
	`´štf
("USAGE: % vÏn_check sˆPORT\n",
´og¿m
);

58 
	`´štf
("\n OPTION:\n");

59 
	`´štf
(" PORT -- Physic…ort, (xe0 | xe1).\n");

60 
	}
}

62 
	$äùw—k_vÏn_check_¡©_g‘
(*
pÜt
)

64 
	#STAT_GET_ONCE_SIZE
 12

	)

65 
rv
, 
i
;

66 
¡©_max
 = 
¡©_vÏn_id_max
/2;

67 
ušt64_t
 
¡©
[
¡©_max
];

68 
äc_vÏn_check_·¿_t
 
vÏn_check_·¿
 = {};

69 
¡©_Çme
[
FRC_STAT_NAME_SIZE
];

70 
äc_vÏn_İ_š_t
 
šput
;

71 
	`mem£t
(
¡©
, 0, (stat));

72 
num
;

73 
¡©_max
 = 
¡©_vÏn_id_max
/2;

74 
num
 = 
¡©_max
 / 
STAT_GET_ONCE_SIZE
;

76 ià(
NULL
 =ğ
pÜt
)

78  
FRE_FAIL
;

81 ià(!
	`¡rcmp
(
pÜt
, "xe0"))

83 
šput
.
pÜt
 = 0;

85 ià(!
	`¡rcmp
(
pÜt
, "xe1"))

87 
šput
.
pÜt
 = 16;

91 
	`äùw—k_cmd_vÏn_¡©_u§ge
();

94 
¿w_num
 = 0, 
vÏn_off£t
 = 0;

95 ià(
¡©_max
 % 
STAT_GET_ONCE_SIZE
)

97 
num
 += 1;

99 
rv
 = 
	`äÿpi_vÏn_check_¡©us_g‘
(&
vÏn_check_·¿
);

100 ià(
rv
 !ğ
FRE_SUCCESS
)

102 
	`´štf
("G‘ stu oàvÏÀcÚfig fa: %d!\n", 
rv
);

103  
FRE_FAIL
;

105 
	`sw­_buff
((
äc_vÏn_check_·¿_t
)>>3, &
vÏn_check_·¿
);

107 
	`´štf
("S¹_id : %d\n", 
vÏn_check_·¿
.
¡¬t_id
);

109 
vÏn_off£t
 = 
vÏn_check_·¿
.
¡¬t_id
;

111 
i
 = 0; i < 
num
; i++)

113 ià(
i
 =ğ
num
 -1)

115 ià(
¡©_max
 % 
STAT_GET_ONCE_SIZE
)

117 
šput
.
num
 = 
¡©_max
 % 
STAT_GET_ONCE_SIZE
;

119 
šput
.
num
 = 
STAT_GET_ONCE_SIZE
;

122 
šput
.
num
 = 
STAT_GET_ONCE_SIZE
;

125 
šput
.
šdex
 = 
i
 * 
STAT_GET_ONCE_SIZE
;

127 
rv
 = 
	`äÿpi_vÏn_check_¡©_g‘
(&
šput
, &
¡©
[
i
 * 
STAT_GET_ONCE_SIZE
]);

129 ià(
rv
 !ğ
FRE_SUCCESS
)

131 
	`´štf
("G‘ sˆoàäcÜç: %d!\n", 
rv
);

132  
FRE_FAIL
;

137 
	`sw­_buff
(
¡©_max
, 
¡©
);

140 
i
 = 0; i < 
¡©_max
; i++)

142 ià(
¡©
[
i
] > 0) {

143 
	`äc_vÏn_¡©_Çme_g‘
(
i
, 
¡©_Çme
);

144 
rv
 = 
	`ssÿnf
(
¡©_Çme
, "vÏn_id_%d", &
¿w_num
);

145 ià(1 =ğ
rv
)

147 
	`¥rštf
(
¡©_Çme
, "vÏn_id_%d", 
¿w_num
+
vÏn_off£t
);

149 ià(
pÜt
)

151 
	`´štf
("%-20s: %Îd\n", 
¡©_Çme
, (
ULL
)
¡©
[
i
]);

156  
FRE_SUCCESS
;

157 
	}
}

159 
	$äùw—k_cmd_vÏn_check
(
¬gc
, **
¬gv
)

161 
rv
;

162 
İ
;

163 
äc_vÏn_check_·¿_t
 
vÏn_check_·¿
;

164 
ušt8_t
 
vÏn_check_ty³
;

165 
ušt16_t
 
¡¬t_id
;

166 
ušt16_t
 
numb”
;

168 
	`mem£t
(&
vÏn_check_·¿
, 0, (
äc_vÏn_check_·¿_t
));

170 ià(
¬gc
 < 2)

172 
	`äùw—k_cmd_vÏn_check_u§ge
();

173  
FRE_SUCCESS
;

175 ià(!(
	`¡rcmp
("¡©us", 
¬gv
[1])))

177 
İ
 = 
FRCTWEAK_VLAN_CHECK_GET_PARAMETER_CMD
;

179 ià(!(
	`¡rcmp
("£t", 
¬gv
[1])))

181 
İ
 = 
FRCTWEAK_VLAN_CHECK_SET_PARAMETER_CMD
;

183 ià(!(
	`¡rcmp
("¡©", 
¬gv
[1])))

185 
İ
 = 
FRCTWEAK_VLAN_CHECK_GET_STAT_CMD
;

187 ià(!(
	`¡rcmp
("ş—r", 
¬gv
[1])))

189 
İ
 = 
FRCTWEAK_VLAN_CHECK_CLEAR_STAT_CMD
;

193 
	`äùw—k_cmd_vÏn_check_u§ge
();

197 
İ
)

199 
FRCTWEAK_VLAN_CHECK_GET_PARAMETER_CMD
:

200 
rv
 = 
	`äÿpi_vÏn_check_¡©us_g‘
(&
vÏn_check_·¿
);

201 ià(
rv
)

203 
	`´štf
("E¼Ü„v=%d", 
rv
);

204  
FRE_FAIL
;

206 
	`sw­_buff
((
äc_vÏn_check_·¿_t
)>>3, &
vÏn_check_·¿
);

207 
	`´štf
("VLAN_CHECK status:\n");

208 
	`´štf
("Ty³ : %s\n", 
äùw—k_vÏn_check_ty³_¡r
[
vÏn_check_·¿
.
ty³
]);

209 
	`´štf
("S¹_id : %d\n", 
vÏn_check_·¿
.
¡¬t_id
);

210 
	`´štf
("numb” : %d\n", 
vÏn_check_·¿
.
num
);

212 
FRCTWEAK_VLAN_CHECK_SET_PARAMETER_CMD
:

213 ià(
¬gc
 < 5)

215 
	`äùw—k_cmd_vÏn_check_£t_u§ge
();

216  
FRE_SUCCESS
;

219 ià(
	`·r£_vÏn_check_ty³
(
¬gv
[2], &
vÏn_check_ty³
))

221 
	`´štf
("Invalid vlan_checkype!");

222  
FRE_PARAM
;

225 
	`ssÿnf
(
¬gv
[3], "%hu", &
¡¬t_id
);

226 ià(
¡¬t_id
 < 
VLAN_CHECK_START_ID_MIN
 || s¹_id > 
VLAN_CHECK_START_ID_MAX
)

228 
	`´štf
("Invalid vlan_check start_id!");

229  
FRE_PARAM
;

232 ià(
	`·r£_u16
(
¬gv
[4], &
numb”
))

234  
FRE_PARAM
;

236 ià(
numb”
 > 128)

238 
	`´štf
("Invalid vlan_check start_id!");

239  
FRE_PARAM
;

242 ià(
¡¬t_id
 + 
numb”
 > 
VLAN_CHECK_ID_MAX
)

244 
	`´štf
(" st_id +‚umb” > %d\n", 
VLAN_CHECK_ID_MAX
);

245  
FRE_PARAM
;

248 
vÏn_check_·¿
.
ty³
 = 
vÏn_check_ty³
;

249 
vÏn_check_·¿
.
¡¬t_id
 = start_id;

250 
vÏn_check_·¿
.
num
 = 
numb”
;

251 
rv
 = 
	`äÿpi_vÏn_check_£t_·¿m‘”
(&
vÏn_check_·¿
);

252 ià(
rv
)

254 
	`´štf
("E¼Ü„v=%d\n", 
rv
);

255  
FRE_FAIL
;

258 
FRCTWEAK_VLAN_CHECK_GET_STAT_CMD
:

259 
rv
 = 
	`äùw—k_vÏn_check_¡©_g‘
(
¬gv
[2]);

260 ià(
rv
)

262 
	`´štf
("E¼Ü„v=%d\n", 
rv
);

263  
FRE_FAIL
;

266 
FRCTWEAK_VLAN_CHECK_CLEAR_STAT_CMD
:

267 
rv
 = 
	`äÿpi_vÏn_check_¡©_ş—r
();

268 ià(
rv
)

270 
	`´štf
("E¼Ü„v=%d\n", 
rv
);

271  
FRE_FAIL
;

275  
FRE_PARAM
;

278  
rv
;

280 
	}
}

282 
	$äùw—k_vÏn_check_cmd_š™
(
äùw—k_cmd_t
 *
cmd
)

284 
	`äùw—k_cmd_»gi¡”
(
cmd
, "vÏn_check", "G‘ o¸£ˆfÜ vÏn_check moduË", 
äùw—k_cmd_vÏn_check
, 
äùw—k_cmd_vÏn_check_u§ge
);

288 
	}
}

	@include/frc.h

1 #iâdeà
__FRC_H__


2 
	#__FRC_H__


	)

6 
	~"äc_cÚfig.h
"

7 
	~"äc_defs.h
"

8 
	~"äc_ty³s.h
"

9 
	~"äc_debug.h
"

	@include/frc_cmd.h

1 #iâdeà
__FRC_CMD_H__


2 
	#__FRC_CMD_H__


	)

4 
	#FRCORE_CMD_INPUT_MAX
 (64)

	)

7 
	mCMD_TYPE_RESV
,

8 
	mCMD_TYPE_TEST
,

9 
	mCMD_TYPE_CTRL
,

10 
	mCMD_TYPE_USER
,

11 
	mCMD_TYPE_DRV
,

12 
	mCMD_TYPE_MAX
,

13 } 
	täcÜe_cmd_ty³_e
;

16 
	mTEST_CMD_RESV
,

17 
	mTEST_CMD_UDP_DMA
,

18 
	mTEST_CMD_TCP_DMA
,

19 
	mTEST_CMD_DMA_LOOP_START
,

20 
	mTEST_CMD_DMA_LOOP_STOP
,

21 
	mTEST_CMD_SIMPLE_PACKET_CHAN
,

22 
	mTEST_CMD_MAX
,

23 } 
	täcÜe_‹¡_cmd_e
;

26 
	mUSER_CMD_RESV
,

27 
	mUSER_CMD_GET_BDD_STATUS
,

28 
	mUSER_CMD_GET_VERSION
,

29 
	mUSER_CMD_BDD_PORT_ENABLE
,

30 
	mUSER_CMD_CONFIG_LOG_SW
,

31 
	mUSER_CMD_GET_BDD_INFO
,

32 
	mUSER_CMD_GET_STAT
,

33 
	mUSER_CMD_CLEAR_STAT
,

34 
	mUSER_CMD_GET_PORT_STATUS
,

35 
	mUSER_CMD_GET_PORT_STAT
,

36 
	mUSER_CMD_CLEAR_PORT_STAT
,

37 
	mUSER_CMD_GET_TEMP
,

38 
	mUSER_CMD_GET_PHY
,

39 
	mUSER_CMD_SET_PHY
,

40 
	mUSER_CMD_SET_CPLD
,

41 
	mUSER_CMD_GET_CPLD
,

42 
	mUSER_CMD_PROT_ENABLE
,

43 
	mUSER_CMD_SET_LOOPBACK_MODE
,

44 
	mUSER_CMD_SET_WORK_MODE
,

45 
	mUSER_CMD_FORCE_LINK
,

46 
	mUSER_CMD_GET_SYSINFO
,

47 
	mUSER_CMD_SET_AGE_TIME
,

48 
	mUSER_CMD_POWEROFF
,

49 
	mUSER_CMD_SET_RETRANS_TIME
,

50 
	mUSER_CMD_SET_DISORDER_DEPTH
,

51 
	mUSER_CMD_GET_FR_STATUS
,

52 
	mUSER_CMD_FR_ENABLE
,

53 
	mUSER_CMD_SSN_GET_FIVETUPLE
,

54 
	mUSER_CMD_SSN_BUCKET_GET
,

55 
	mUSER_CMD_SSN_MATCH
,

56 
	mUSER_CMD_GET_RULE_STATUS
,

57 
	mUSER_CMD_RULE_ENABLE
,

58 
	mUSER_CMD_ADD_RULE
,

59 
	mUSER_CMD_CLEAN_ALL_RULE
,

60 
	mUSER_CMD_RULE_MATCH
,

61 
	mUSER_CMD_GET_RULE_CNT
,

62 
	mUSER_CMD_DEL_RULE
,

63 
	mUSER_CMD_GET_RULE
,

64 
	mUSER_CMD_CLEAN_RULE_STAT
,

65 
	mUSER_CMD_UPDATE_RULE
,

66 
	mUSER_CMD_GET_RULE_NUM
,

67 #ià
FRC_CONFIG_TWO_TUPLE


68 
	mUSER_CMD_GET_ACL_STATUS
,

69 
	mUSER_CMD_ACL_ENABLE
,

70 
	mUSER_CMD_ADD_ACL
,

71 
	mUSER_CMD_CLEAN_ALL_ACL
,

72 
	mUSER_CMD_ACL_MATCH
,

73 
	mUSER_CMD_GET_ACL_CNT
,

74 
	mUSER_CMD_DEL_ACL
,

75 
	mUSER_CMD_GET_ACL
,

76 
	mUSER_CMD_CLEAN_ACL_STAT
,

77 
	mUSER_CMD_GET_ACL_NUM
,

78 
	mUSER_CMD_GET_ACL_HASH_TABLE
,

80 
	mUSER_CMD_SET_DMA_BLOCK_SIZE
,

81 
	mUSER_CMD_READ_DMA
,

82 #ià
FRC_CONFIG_UDP


83 
	mUSER_CMD_GET_UDP_STATUS
,

84 
	mUSER_CMD_UDP_ENABLE
,

86 #ià
FRC_CONFIG_VLAN_CHECK


87 
	mUSER_CMD_SET_VLAN_CHECK_PARAMETER
,

88 
	mUSER_CMD_GET_VLAN_CHECK_PARAMETER
,

89 
	mUSER_CMD_GET_VLAN_CHECK_STAT
,

90 
	mUSER_CMD_CLEAR_VLAN_CHECK_STAT
,

92 #ià
FRC_CONFIG_VLAN_IV


93 
	mUSER_CMD_VLAN_V4_HASH_MASK_SET
,

94 
	mUSER_CMD_VLAN_V6_HASH_MASK_SET
,

96 #ià
FRC_CONFIG_TIMESTAMP_CHECK


97 
	mUSER_CMD_GET_TIMESTAMP_CHECK_STAT
,

98 
	mUSER_CMD_CLEAR_TIMESTAMP_CHECK_STAT
,

100 #ià
FRC_CONFIG_MAC_STATISTICS


101 
	mUSER_CMD_MAC_STAT_ADD_MAC
,

102 
	mUSER_CMD_MAC_STAT_DEL_MAC
,

103 
	mUSER_CMD_MAC_STAT_DEL_ALL
,

104 
	mUSER_CMD_MAC_STAT_CLEAR_COUNTER
,

105 
	mUSER_CMD_MAC_STAT_CLEAR_ALL_COUNTER
,

106 
	mUSER_CMD_MAC_STAT_SHOW_COUNTER
,

107 
	mUSER_CMD_MAC_STAT_SHOW_ALL_COUNTER
,

108 
	mUSER_CMD_MAC_STAT_SET_HASH_MODE
,

109 
	mUSER_CMD_MAC_STAT_HEART_BEAT
,

110 
	mUSER_CMD_MAC_STAT_SET_IP
,

112 #ià
FRC_CONFIG_IPC


113 
	mUSER_CMD_IPC_CUR_GET
,

114 
	mUSER_CMD_IPC_CUR_SET
,

115 
	mUSER_CMD_IPC_MISC_GET
,

116 
	mUSER_CMD_IPC_MISC_SET
,

117 
	mUSER_CMD_IPC_EXP_GET
,

118 
	mUSER_CMD_IPC_EXP_SET
,

119 
	mUSER_CMD_IPC_INSTR_GET
,

120 
	mUSER_CMD_IPC_INSTR_SET
,

121 
	mUSER_CMD_IPC_INSTR_PAYLOAD_SET
,

123 
	mUSER_CMD_MAX
,

124 } 
	täcÜe_u£r_cmd_e
;

127 
	mFEATURE_TCP_RESTORATION
,

128 
	mFEATURE_TCP_SINGLE
,

129 
	mFEATURE_OCT1_NETNIC
,

130 
	mFEATURE_RULE_FILTRATE
,

131 
	mREATURE_LOCK_XMIT
,

132 } 
	täc_ã©u»_e
;

135 
	mDRV_CMD_RESV
,

136 
	mDRV_CMD_GET_VERSION
,

137 
	mDRV_CMD_GET_QUEUE_DESC
,

138 
	mDRV_CMD_GET_TCP_QUEUE_INFO
,

139 
	mDRV_CMD_GET_UDP_QUEUE_INFO
,

140 
	mDRV_CMD_DMA_LOOP_BUFF_GET
,

141 
	mDRV_CMD_GET_FEATURE
,

142 
	mDRV_CMD_GET_POOL_AND_RING_ADDR
,

143 
	mDRV_CMD_MAX


144 } 
	täcdrv_cmd_e
;

147 #ià
__FRC_BYTE_ORDER
 =ğ
__FRC_LITTLE_ENDIAN


148 
ušt64_t
 
	mnum
:32;

149 
ušt64_t
 
	mËn
:32;

151 
ušt64_t
 
	mËn
:32;

152 
ušt64_t
 
	mnum
:32;

154 } 
	täc_pkt_dma_‹¡_t
;

158 
ušt64_t
 
	mtx_addr
[
FRC_DAT_CORE_NUM
];

159 
ušt64_t
 
	mrx_addr
[
FRC_DAT_CORE_NUM
];

160 } 
	täc_dma_loİ_¬g_t
;

163 
ušt64_t
 
	mcÜe_num
;

164 
ušt64_t
 
	mrx_addr
;

165 
ušt64_t
 
	mtx_addr
;

166 } 
	täc_dma_loİ_buff_addr_t
;

169 
ušt32_t
 
	mqueue_num
;

170 
ušt32_t
 
	m¡¬t_id
;

171 } 
	täc_dma_queue_šfo_t
;

	@include/frc_config.h

1 #iâdeà
__FRC_CONFIG_H__


2 
	#__FRC_CONFIG_H__


	)

4 
	#FRC_CONFIG_FR
 1

	)

5 
	#FRC_CONFIG_NIC
 1

	)

7 
	#FRC_CONFIG_TCP
 0

	)

8 
	#FRC_CONFIG_QUEUE_TEST
 0

	)

9 
	#FRC_CONFIG_DMA_TEST
 0

	)

10 
	#FRC_CONFIG_UDP
 0

	)

11 
	#FRC_CONFIG_UDP_CLOSE_SUBMIT_DATA
 0

	)

12 
	#FRC_CONFIG_NIC_GRP
 0

	)

13 
	#FRC_CONFIG_LOCK_NET_XMIT
 1

	)

14 
	#FRC_CONFIG_SIMPLE_PACKAGE
 0

	)

15 
	#FRC_CONFIG_SIMPLE_PACKET_TEST
 0

	)

16 
	#FRC_CONFIG_RULE
 0

	)

17 
	#FRC_CONFIG_SSN_CHAN
 0

	)

18 
	#FRC_CONFIG_SSN_CHAN_TEST
 0

	)

19 
	#FRC_CONFIG_SSN
 0

	)

20 
	#FRC_CONFIG_AGE
 0

	)

21 
	#FRC_CONFIG_SSN_WQE_TEST
 0

	)

22 
	#FRC_CONFIG_SSN_SIMPLE_PACKET_TEST
 0

	)

23 
	#FRC_CONFIG_SSN_ATOMIC
 0

	)

24 
	#FRC_CONFIG_SSN_AVAIL_BUFF_GET
 0

	)

25 
	#FRC_CONFIG_SSN_CLOSE_SUBMIT_DATA
 0

	)

26 
	#FRC_CONFIG_SSN_CHAN_TEST_ONE_BLOCK_ONE_PAYLOD
 0

	)

28 
	#FRC_CONFIG_TWO_TUPLE
 0

	)

29 
	#FRC_CONFIG_TWO_TUPLE_TSET
 0

	)

31 
	#FRC_CONFIG_GET_SYSINFO
 0

	)

32 
	#FRC_CONFIG_VLAN_CHECK
 1

	)

33 
	#FRC_CONFIG_TIMESTAMP_CHECK
 0

	)

34 
	#FRC_CONFIG_MAC_STATISTICS
 0

	)

35 
	#FRC_CONFIG_IPC
 1

	)

36 
	#FRC_CONFIG_VLAN_IV
 1

	)

	@include/frc_crc8.h

1 #iâdeà
__FRC_CRC8_H__


2 
	#__FRC_CRC8_H__


	)

6 
	~"äc_cÚfig.h
"

7 
	~"äc_defs.h
"

8 
	~"äc_ty³s.h
"

9 
	~"äc_debug.h
"

11 
	gCRC8TabË
[256]={

31 
	$ÿl_üc
(*
±r
, 
Ën
)

33 
üc
=0;

34 
Ën
--!=0)

36 
üc
 =
CRC8TabË
[üø^ *
±r
++];

38 (
üc
);

39 
	}
}

	@include/frc_debug.h

1 #iâdeà
__FRC_DEBUG_H__


2 
	#__FRC_DEBUG_H__


	)

4 
	#FRC_DEBUG_DRV
 0

	)

5 
	#FRC_DEBUG_CORE
 0

	)

6 
	#FRC_DEBUG_FRLOOPER
 0

	)

7 
	#FRC_DEBUG_API
 0

	)

8 
	#FRC_DEBUG_TWEAK
 0

	)

9 
	#FRC_DEBUG_RING_BUFF
 0

	)

10 
	#FRC_DEBUG_PKT_LEN
 0

	)

12 
	#FRC_DEBUG
(
_Ëv–
, 
_fmt
, 
_¬gs
...) \

13 
	`´štf
("[%s]%s.%d: " 
_fmt
, #_Ëv–, 
__func__
, 
__LINE__
, ##
_¬gs
)

	)

	@include/frc_defs.h

1 #iâdeà
__FRC_DEFS_H__


2 
	#__FRC_DEFS_H__


	)

4 #ià 
defšed
(
MAKE_KERNEL
)

6 
	#__FRC_BYTE_ORDER
 
__CAVIUM_BYTE_ORDER


	)

7 
	#__FRC_BIG_ENDIAN
 
__CAVIUM_BIG_ENDIAN


	)

8 
	#__FRC_LITTLE_ENDIAN
 
__CAVIUM_LITTLE_ENDIAN


	)

10 
	#äc_¥šlock_t
 
¥šlock_t


	)

11 
	#äc_¥šlock_lock
(
lock
è
	`cvmx_¥šlock_lock
Öock)

	)

12 
	#äc_¥šlock_uÆock
(
lock
è
	`cvmx_¥šlock_uÆock
Öock)

	)

13 
	#äc_´št
 
´štk


	)

14 #–ià
defšed
(
MAKE_APP
)

16 
	#__FRC_BYTE_ORDER
 
__BYTE_ORDER


	)

17 
	#__FRC_BIG_ENDIAN
 
__BIG_ENDIAN


	)

18 
	#__FRC_LITTLE_ENDIAN
 
__LITTLE_ENDIAN


	)

20 
	#äc_¥šlock_t
 

	)

21 
	#äc_¥šlock_lock
(
lock
)

	)

22 
	#äc_¥šlock_uÆock
(
lock
)

	)

23 
	#äc_´št
 
´štf


	)

24 #–ià
defšed
(
MAKE_CORE
)

26 
	#__FRC_BYTE_ORDER
 
__BYTE_ORDER


	)

27 
	#__FRC_BIG_ENDIAN
 
__BIG_ENDIAN


	)

28 
	#__FRC_LITTLE_ENDIAN
 
__LITTLE_ENDIAN


	)

30 
	~"cvmx-¥šlock.h
"

32 
	#äc_¥šlock_t
 
cvmx_¥šlock_t


	)

33 
	#äc_¥šlock_lock
(
lock
è
	`cvmx_¥šlock_lock
Öock)

	)

34 
	#äc_¥šlock_uÆock
(
lock
è
	`cvmx_¥šlock_uÆock
Öock)

	)

35 
	#äc_´št
 
´štf


	)

	@include/frc_dma.h

1 #iâdeà
__FRC_DMA_H__


2 
	#__FRC_DMA_H__


	)

4 #ià!
__KERNEL__


5 
	~<¡ršg.h
>

8 
	~"äc.h
"

11 
	#FRC_MEM_PAGE_SIZE
 4096

	)

12 
	#FRC_DMA_PKT_SIZE
 2048

	)

14 
	#FRC_DMA_BUFF_PAGES_ORDER
 (10)

	)

15 
	#FRC_DMA_BUFF_PAGES
 1024

	)

16 
	#FRC_DMA_BUFF_SIZE
 (
FRC_MEM_PAGE_SIZE
 * 
FRC_DMA_BUFF_PAGES
)

	)

18 
	#FRC_DMA_LOOP_ENTRY_SIZE
 1024

	)

20 
	#FRC_TCP_DMA_QUEUE_NUM
 
FRC_DAT_CORE_NUM


	)

21 
	#FRC_TCP_DMA_BUFF_NUM
 1

	)

23 
	#FRC_UDP_DMA_QUEUE_NUM
 
FRC_DAT_CORE_NUM


	)

24 
	#FRC_UDP_DMA_BUFF_NUM
 1

	)

26 
	#FRC_DMA_QUEUE_NUM
 ((
FRC_TCP_DMA_QUEUE_NUM
è+ (
FRC_UDP_DMA_QUEUE_NUM
))

	)

27 
	#FRC_TCP_QUEUE_START
 0

	)

28 
	#FRC_UDP_QUEUE_START
 (
FRC_TCP_DMA_QUEUE_NUM
)

	)

30 
	#FRC_QUEUE_UNKOWN
 0

	)

31 
	#FRC_TCP_QUEUE
 1

	)

32 
	#FRC_UDP_QUEUE
 2

	)

34 
	#FRC_DMA_BUFF_MAX
 12

	)

37 
	#RING_BUFF_CELL_SIZE
 (
ušt64_t
)

	)

38 
	#RING_BUFF_SIZE
 (2048 * 
RING_BUFF_CELL_SIZE
)

	)

40 
	#FRC_SSN_POSIVTE_FLOW
 0

	)

41 
	#FRC_SSN_NEGATIVE_FLOW
 1

	)

47 
	säc_dma_pkt_šfo
 {

48 #ià
__FRC_BYTE_ORDER
 =ğ
__FRC_BIG_ENDIAN


49 
ušt32_t
 
	mack_£q
;

50 
ušt32_t
 
	m£qu’û
;

52 
ušt16_t
 
	mdœeùiÚ
;

53 
ušt16_t
 
	m·ylßd_Ën
;

54 
ušt32_t
 
	md©a_off£t
;

56 
ušt64_t
 
	msmac
;

57 
ušt64_t
 
	mdmac
;

59 
ušt32_t
 
	m£qu’û
;

60 
ušt32_t
 
	mack_£q
;

62 
ušt32_t
 
	md©a_off£t
;

63 
ušt16_t
 
	m·ylßd_Ën
;

64 
ušt16_t
 
	mdœeùiÚ
;

66 
ušt64_t
 
	msmac
;

67 
ušt64_t
 
	mdmac
;

69 } 
	täc_dma_pkt_šfo_t
;

72 
	mDMA_BUFF_UNUSED
,

73 
	mDMA_BUFF_AVAILABLE
,

74 
	mDMA_BUFF_RESTORING
,

75 
	mDMA_BUFF_COMPLETED
,

76 
	mDMA_BUFF_REVERTING
,

77 } 
	tdma_¡©_e
;

80 
	mDMA_TYPE_RESV
,

81 
	mDMA_TYPE_UDP
,

82 
	mDMA_TYPE_TCP
,

83 
	mDMA_TYPE_MAX


84 } 
	tdma_ty³_e
;

98 
	säc_dma_hdr
 {

99 #ià
__FRC_BYTE_ORDER
 =ğ
__FRC_BIG_ENDIAN


100 
ušt32_t
 
	md
;

101 
ušt32_t
 
	ms
;

103 
ušt16_t
 
	m¡İ_£c
;

104 
ušt16_t
 
	m´ÙocŞ
;

105 
ušt16_t
 
	mdpÜt
;

106 
ušt16_t
 
	m¥Üt
;

108 
ušt32_t
 
	mhash
;

109 
ušt16_t
 
	mtÙ®_·yËn
;

110 
ušt16_t
 
	mpkt_num
;

112 
ušt32_t
 
	mµpÛ_£ss_id
;

113 
ušt32_t
 
	m‹id
;

115 
ušt16_t
 
	mvÏn_ty³
;

116 
ušt16_t
 
	mvÏn_id
;

117 
ušt16_t
 
	mµpÛ_·yËn
;

118 
ušt16_t
 
	mµpÛ_´ÙocŞ
;

120 
ušt32_t
 
	ms
;

121 
ušt32_t
 
	md
;

123 
ušt16_t
 
	m¥Üt
;

124 
ušt16_t
 
	mdpÜt
;

125 
ušt16_t
 
	m´ÙocŞ
;

126 
ušt16_t
 
	m¡İ_£c
;

128 
ušt16_t
 
	mpkt_num
;

129 
ušt16_t
 
	mtÙ®_·yËn
;

130 
ušt32_t
 
	mhash
;

132 
ušt32_t
 
	m‹id
;

133 
ušt32_t
 
	mµpÛ_£ss_id
;

135 
ušt16_t
 
	mµpÛ_´ÙocŞ
;

136 
ušt16_t
 
	mµpÛ_·yËn
;

137 
ušt16_t
 
	mvÏn_id
;

138 
ušt16_t
 
	mvÏn_ty³
;

140 } 
	täc_dma_hdr_t
;

142 
	#FRC_DMA_PKT_HEAD_SIZE
 (
äc_dma_hdr_t
)

	)

143 
	#FRC_DMA_PKT_PAYLOAD_OFFSET
 (
äc_dma_hdr_t
)

	)

144 
	#FRC_DMA_PKT_INFO_SIZE
 (
äc_dma_pkt_šfo_t
)

	)

145 
	#FRC_DMA_PKT_INFO_OFFSET
 (
äc_dma_hdr_t
)

	)

146 
	#FRC_DMA_PKT_DATA_OFFSET
 ((
FRC_DMA_PKT_INFO_OFFSET
è+ (
äc_dma_pkt_šfo_t
))

	)

147 
	#FRC_DMA_PKT_DATA_SIZE
 ((
FRC_DMA_PKT_SIZE
è- (
FRC_DMA_PKT_DATA_OFFSET
))

	)

149 
	säc_dma_pkt
 {

150 
äc_dma_hdr_t
 
	mh—d”
;

151 
äc_dma_pkt_šfo_t
 
	mšfo
;

152 
ušt8_t
 
	md©a
[
FRC_DMA_PKT_DATA_SIZE
];

153 } 
	täc_dma_pkt_t
;

154 
	säc_sim¶e_pkt
 {

155 
äc_dma_hdr_t
 
	mh—d”
;

156 
ušt8_t
 
	m·ylßd
[
FRC_DMA_PKT_DATA_SIZE
];

157 
äc_dma_pkt_šfo_t
 
	mšfo
;

158 } 
	täc_sim¶e_pkt_t
;

160 
	säc_sim¶e_ruË_pkt
 {

161 
äc_dma_hdr_t
 
	mh—d”
;

162 
ušt16_t
 
	mruË_id
;

163 
ušt8_t
 
	m·ylßd
[
FRC_DMA_PKT_DATA_SIZE
];

164 
äc_dma_pkt_šfo_t
 
	mšfo
;

165 } 
	täc_sim¶e_ruË_pkt_t
;

166 
	#FRC_DMA_LOOP_HD_SIZE
 16

	)

167 
	#FRC_DMA_LOOP_BUFF_SIZE
 (
FRC_DMA_BUFF_SIZE
 - 
FRC_DMA_LOOP_HD_SIZE
)

	)

170 
ušt64_t
 
	mwidx
;

171 
ušt64_t
 
	mridx
;

172 
ušt8_t
 
	mbuff
[
FRC_DMA_LOOP_BUFF_SIZE
];

173 } 
	täc_dma_loİ_buff_t
;

177 
ušt64_t
 
	msize
;

178 
ušt64_t
 
	m»sv
;

179 
ušt64_t
 
	mwidx
;

180 
ušt64_t
 
	mridx
;

181 
ušt8_t
 
	mbuff
[
RING_BUFF_SIZE
];

182 } 
	täc_ršg_buff_t
;

184 
	säc_s¢_dma_ù¾
 {

185 
äc_ršg_buff_t
 
	mavaabË_ršg
;

186 
äc_ršg_buff_t
 
	mcom¶‘ed_ršg
;

187 } 
	täc_dma_ù¾_t
;

189 
	#FRC_DMA_AVAIL_OFFSET
 0

	)

190 
	#FRC_DMA_AVAIL_SIZE_OFFSET
 (
FRC_DMA_AVAIL_OFFSET
 + 0)

	)

191 
	#FRC_DMA_AVAIL_WIDX_OFFSET
 (
FRC_DMA_AVAIL_OFFSET
 + 16)

	)

192 
	#FRC_DMA_AVAIL_RIDX_OFFSET
 (
FRC_DMA_AVAIL_OFFSET
 + 24)

	)

193 
	#FRC_DMA_AVAIL_BUFF_OFFSET
 (
FRC_DMA_AVAIL_OFFSET
 + 32)

	)

195 
	#FRC_DMA_COMPL_OFFSET
 (
RING_BUFF_SIZE
 + 32)

	)

196 
	#FRC_DMA_COMPL_SIZE_OFFSET
 (
FRC_DMA_COMPL_OFFSET
 + 0)

	)

197 
	#FRC_DMA_COMPL_WIDX_OFFSET
 (
FRC_DMA_COMPL_OFFSET
 + 16)

	)

198 
	#FRC_DMA_COMPL_RIDX_OFFSET
 (
FRC_DMA_COMPL_OFFSET
 + 24)

	)

199 
	#FRC_DMA_COMPL_BUFF_OFFSET
 (
FRC_DMA_COMPL_OFFSET
 + 32)

	)

202 #ià
__FRC_BYTE_ORDER
 =ğ
__FRC_LITTLE_ENDIAN


203 
ušt32_t
 
	mty³
;

204 
ušt32_t
 
	mqueue_id
;

206 
ušt32_t
 
	mqueue_id
;

207 
ušt32_t
 
	mty³
;

209 
ušt64_t
 
	mù¾_size
;

210 
ušt64_t
 
	mù¾_addr
;

211 
ušt64_t
 
	mpoŞ_addr
;

212 } 
	täc_dma_queue_desc_t
;

215 
ušt64_t
 
	mbuff_numb
;

216 
ušt64_t
 
	mbuff_size
;

217 
ušt64_t
 
	mbuff_addr
[
FRC_DMA_BUFF_MAX
];

218 
ušt64_t
 
	mblock_numb
;

219 
ušt64_t
 
	mblock_size
;

220 } 
	täc_dma_buff_poŞ_t
;

223 
äc_dma_queue_desc_t
 
	mdesc
;

224 
äc_dma_ù¾_t
 *
	mdma_ù¾
;

225 
äc_dma_buff_poŞ_t
 *
	mpoŞ
;

226 } 
	täc_dma_queue_t
;

228 
	#SWAP_8_BYTE
(
_i
) \

229 ((((((
ušt64_t
)(
_i
)) >> 0) & (uint64_t)0xff) << 56) | \

230 (((((
ušt64_t
)(
_i
)) >> 8) & (uint64_t)0xff) << 48) | \

231 (((((
ušt64_t
)(
_i
)) >> 16) & (uint64_t)0xff) << 40) | \

232 (((((
ušt64_t
)(
_i
)) >> 24) & (uint64_t)0xff) << 32) | \

233 (((((
ušt64_t
)(
_i
)) >> 32) & (uint64_t)0xff) << 24) | \

234 (((((
ušt64_t
)(
_i
)) >> 40) & (uint64_t)0xff) << 16) | \

235 (((((
ušt64_t
)(
_i
)) >> 48) & (uint64_t)0xff) << 8) | \

236 (((((
ušt64_t
)(
_i
)è>> 56è& (ušt64_t)0xffè<< 0))

	)

239 
	#SWAP_4_BYTE
(
_i
) \

240 ((((
ušt32_t
)(
_i
)) & 0xff000000) >> 24) | \

241 ((((
ušt32_t
)(
_i
)) & 0x00ff0000) >> 8) | \

242 ((((
ušt32_t
)(
_i
)) & 0x0000ff00) << 8) | \

243 ((((
ušt32_t
)(
_i
)è& 0x000000ffè<< 24)

	)

245 
	#SWAP_2_BYTE
(
_i
) \

246 ((((
ušt16_t
)(
_i
)) & 0xff00) >> 8) | \

247 ((((
ušt16_t
)(
_i
)è& 0x00ffè<< 8)

	)

249 
	#äc_mš
(
_x
, 
_y
è((_xè< (_yè? (_xè: (_y))

	)

252 
šlše
 
	$sw­_cİy
(*
de¡
, *
¤c
, 
size
)

254 
i
;

255 
ušt64_t
 *
d64
, *
s64
;

256 
d64
 = (
ušt64_t
 *è
de¡
;

257 
s64
 = (
ušt64_t
 *è
¤c
;

258 
i
 = 0; i < 
size
; i++) {

259 
d64
[
i
] = 
	`SWAP_8_BYTE
(
s64
[i]);

261 
	}
}

263 
šlše
 
	$sw­_buff
(
Ën
, *
buff
)

265 
i
;

266 
ušt64_t
 *
p64
;

267 
p64
 = (
ušt64_t
 *è
buff
;

268 
i
 = 0; i < 
Ën
; i++) {

269 
p64
[
i
] = 
	`SWAP_8_BYTE
(p64[i]);

271 
	}
}

273 
šlše
 
ušt64_t
 
	$ršg_ridx
(
äc_ršg_buff_t
 *
ršg
)

275 #ià
__FRC_BYTE_ORDER
 =ğ
__FRC_LITTLE_ENDIAN


276  
ršg
->
ridx
;

278  
	`SWAP_8_BYTE
(
ršg
->
ridx
);

280 
	}
}

282 
šlše
 
ušt64_t
 
	$ršg_widx
(
äc_ršg_buff_t
 *
ršg
)

284 #ià
__FRC_BYTE_ORDER
 =ğ
__FRC_LITTLE_ENDIAN


285  
ršg
->
widx
;

287  
	`SWAP_8_BYTE
(
ršg
->
widx
);

289 
	}
}

291 
šlše
 
ušt64_t
 
	$ršg_size
(
äc_ršg_buff_t
 *
ršg
)

293 #ià
__FRC_BYTE_ORDER
 =ğ
__FRC_LITTLE_ENDIAN


294  
ršg
->
size
;

296  
	`SWAP_8_BYTE
(
ršg
->
size
);

298 
	}
}

307 
šlše
 
ušt64_t


308 
	$__ršg_put
(
äc_ršg_buff_t
 *
ršg
, 
ušt8_t
 *
buff
, 
ušt64_t
 
Ën
)

310 
ušt64_t
 
l
, 
¶
;

311 
ušt64_t
 
size
, 
ridx
, 
widx
;

312 
ušt8_t
 *
p
;

314 
size
 = 
	`ršg_size
(
ršg
);

315 
ridx
 = 
	`ršg_ridx
(
ršg
);

316 
widx
 = 
	`ršg_widx
(
ršg
);

319 
Ën
 = 
	`äc_mš
Ö’, 
size
 - 
widx
 + 
ridx
);

322 
l
 = 
	`äc_mš
(
Ën
, 
size
 - (
widx
 & (size - 1)));

325 
p
 = 
ršg
->
buff
 + (
widx
 & (
size
 - 1));

326 
¶
 = 
l
;

327 
	`memıy
(
p
, 
buff
, 
¶
);

328 #ià
__FRC_BYTE_ORDER
 =ğ
__FRC_BIG_ENDIAN


329 
	`sw­_buff
(
¶
 >> 3, 
p
);

333 
p
 = 
ršg
->
buff
;

334 
¶
 = 
Ën
 - 
l
;

335 
	`memıy
(
p
, 
buff
 + 
l
, 
¶
);

336 #ià
__FRC_BYTE_ORDER
 =ğ
__FRC_BIG_ENDIAN


337 
	`sw­_buff
(
¶
 >> 3, 
p
);

339 
widx
 +ğ
Ën
;

341 #ià
__FRC_BYTE_ORDER
 =ğ
__FRC_BIG_ENDIAN


342 
ršg
->
widx
 = 
	`SWAP_8_BYTE
(widx);

344 
ršg
->
widx
 = widx;

347  
Ën
;

348 
	}
}

356 
šlše
 
ušt64_t


357 
	$__ršg_g‘
(
äc_ršg_buff_t
 *
ršg
, 
ušt8_t
 *
buff
, 
ušt64_t
 
Ën
)

359 
ušt64_t
 
l
, 
¶
;

360 
ušt64_t
 
size
, 
ridx
, 
widx
;

361 
ušt8_t
 *
p
;

363 
size
 = 
	`ršg_size
(
ršg
);

364 
ridx
 = 
	`ršg_ridx
(
ršg
);

365 
widx
 = 
	`ršg_widx
(
ršg
);

368 
Ën
 = 
	`äc_mš
Ö’, 
widx
 - 
ridx
);

371 
l
 = 
	`äc_mš
(
Ën
, 
size
 - (
ridx
 & (size - 1)));

373 
p
 = 
buff
;

374 
¶
 = 
l
;

375 
	`memıy
(
p
, 
ršg
->
buff
 + (
ridx
 & (
size
 - 1)), 
¶
);

376 #ià
__FRC_BYTE_ORDER
 =ğ
__FRC_BIG_ENDIAN


377 
	`sw­_buff
(
¶
 >> 3, 
p
);

380 
p
 = 
buff
 + 
l
;

381 
¶
 = 
Ën
 - 
l
;

382 
	`memıy
(
p
, 
ršg
->
buff
, 
¶
);

383 #ià
__FRC_BYTE_ORDER
 =ğ
__FRC_BIG_ENDIAN


384 
	`sw­_buff
(
¶
 >> 3, 
p
);

387 
ridx
 +ğ
Ën
;

389 #ià
__FRC_BYTE_ORDER
 =ğ
__FRC_BIG_ENDIAN


390 
ršg
->
ridx
 = 
	`SWAP_8_BYTE
(ridx);

392 
ršg
->
ridx
 =„idx;

395  
Ën
;

396 
	}
}

398 
	#AVAIL_RING_INIT
(
_dma_ù¾
, 
_size
) \

400 
	`mem£t
((
_dma_ù¾
).
avaabË_ršg
.
buff
, 0, 
_size
); \

401 (
_dma_ù¾
).
avaabË_ršg
.
size
 = (
_size
 >> 3) << 3; \

402 (
_dma_ù¾
).
avaabË_ršg
.
»sv
 = 0; \

403 (
_dma_ù¾
).
avaabË_ršg
.
widx
 = 0; \

404 (
_dma_ù¾
).
avaabË_ršg
.
ridx
 = 0; \

405 }

	)

407 
	#COMPL_RING_INIT
(
_dma_ù¾
, 
_size
) \

409 
	`mem£t
((
_dma_ù¾
).
com¶‘ed_ršg
.
buff
, 0, 
_size
); \

410 (
_dma_ù¾
).
com¶‘ed_ršg
.
size
 = (
_size
 >> 3) << 3; \

411 (
_dma_ù¾
).
com¶‘ed_ršg
.
»sv
 = 0; \

412 (
_dma_ù¾
).
com¶‘ed_ršg
.
widx
 = 0; \

413 (
_dma_ù¾
).
com¶‘ed_ršg
.
ridx
 = 0; \

414 }

	)

416 
	#AVAIL_RIDX_VAL
(
_dma_ù¾
è(
	`ršg_ridx
(&(_dma_ù¾).
avaabË_ršg
))

	)

417 
	#AVAIL_RIDX_PTR
(
_dma_ù¾
è(&(_dma_ù¾).
avaabË_ršg
.
ridx
)

	)

418 
	#AVAIL_RIDX_SIZE
(
_dma_ù¾
è((_dma_ù¾).
avaabË_ršg
.
ridx
)

	)

421 
	#AVAIL_SIZE_VAL
(
_dma_ù¾
è(
	`ršg_size
(&(_dma_ù¾).
avaabË_ršg
))

	)

422 
	#AVAIL_WIDX_VAL
(
_dma_ù¾
è(
	`ršg_widx
(&(_dma_ù¾).
avaabË_ršg
))

	)

423 
	#AVAIL_WIDX_PTR
(
_dma_ù¾
è(&(_dma_ù¾).
avaabË_ršg
.
widx
)

	)

424 
	#AVAIL_WIDX_SIZE
(
_dma_ù¾
è((_dma_ù¾).
avaabË_ršg
.
widx
)

	)

426 
	#AVAIL_BUFF
(
_dma_ù¾
è(_dma_ù¾).
avaabË_ršg
.
buff


	)

427 
	#AVAIL_BUFF_PTR
(
_dma_ù¾
è(&(_dma_ù¾).
avaabË_ršg
.
buff
)

	)

430 
	#AVAIL_RING_GET
(
_dma_ù¾
, 
_šdex
, 
_size
) \

431 (
	`__ršg_g‘
(&((
_dma_ù¾
).
avaabË_ršg
), (
ušt8_t
 *è&(
_šdex
), 
_size
è=ğ_size)

	)

432 
	#AVAIL_RING_PUT
(
_dma_ù¾
, 
_šdex
, 
_size
) \

433 (
	`__ršg_put
(&((
_dma_ù¾
).
avaabË_ršg
), (
ušt8_t
 *è&(
_šdex
), 
_size
è=ğ_size)

	)

435 
	#COMPL_SIZE_VAL
(
_dma_ù¾
è(
	`ršg_size
(&(_dma_ù¾).
com¶‘ed_ršg
))

	)

436 
	#COMPL_RIDX_VAL
(
_dma_ù¾
è(
	`ršg_ridx
(&(_dma_ù¾).
com¶‘ed_ršg
))

	)

437 
	#COMPL_RIDX_PTR
(
_dma_ù¾
è(&(_dma_ù¾).
com¶‘ed_ršg
.
ridx
)

	)

438 
	#COMPL_RIDX_SIZE
(
_dma_ù¾
è((_dma_ù¾).
com¶‘ed_ršg
.
ridx
)

	)

440 
	#COMPL_WIDX_VAL
(
_dma_ù¾
è(
	`ršg_widx
(&(_dma_ù¾).
com¶‘ed_ršg
))

	)

441 
	#COMPL_WIDX_PTR
(
_dma_ù¾
è(&(_dma_ù¾).
com¶‘ed_ršg
.
widx
)

	)

442 
	#COMPL_WIDX_SIZE
(
_dma_ù¾
è((_dma_ù¾).
com¶‘ed_ršg
.
widx
)

	)

444 
	#COMPL_BUFF
(
_dma_ù¾
è(_dma_ù¾).
com¶‘ed_ršg
.
buff


	)

445 
	#COMPL_BUFF_PTR
(
_dma_ù¾
è(&(_dma_ù¾).
com¶‘ed_ršg
.
buff
)

	)

447 
	#COMPL_RING_GET
(
_dma_ù¾
, 
_šdex
, 
_size
) \

448 (
	`__ršg_g‘
(&((
_dma_ù¾
).
com¶‘ed_ršg
), (
ušt8_t
 *è&(
_šdex
), 
_size
è=ğ_size)

	)

449 
	#COMPL_RING_PUT
(
_dma_ù¾
, 
_šdex
, 
_size
) \

450 (
	`__ršg_put
(&((
_dma_ù¾
).
com¶‘ed_ršg
), (
ušt8_t
 *è&(
_šdex
), 
_size
è=ğ_size)

	)

453 
	#FRC_DMA_PKT_PTR
(
_ù¾
, 
_block
, 
_šdex
è(
äc_dma_pkt_t
 *)((_ù¾)->
block
[(_block)] + ((_šdexè* 
FRC_DMA_PKT_SIZE
))

	)

455 
	s£ssiÚ_node
 {

456 
ušt64_t
 
	m´ev_±r
;

457 
ušt64_t
 
	mÃxt_±r
;

458 
ušt64_t
 
	mh—d_wÜk
;

459 
ušt64_t
 
	m_wÜk
;

460 
št32_t
 
	mblock_šdex
;

461 
št32_t
 
	mupd©e
;

462 
äc_dma_hdr_t
 
	mdma_hdr
;

463 } 
	täc_£ssiÚ_node_t
 ;

465 
	#g’off£t
(
TYPE
, 
MEMBER
è((
size_t
è&((TYPE *)0)->MEMBER)

	)

468 
	#FRC_DMA_OFFSET
 (40)

	)

469 
	#FRC_DMA_SIMPLE_PACKAGE_BLOCK_SIZE
 (2*
K
)

	)

470 
	#FRC_DMA_SIMPLE_PACKAGE_DATA_SIZE
 (
FRC_DMA_SIMPLE_PACKAGE_BLOCK_SIZE
 - 
FRC_DMA_OFFSET
)

	)

471 
	#FRC_DMA_SIMPLE_PACKAGE_RING_BUFF_SIZE
 (2*
K
*10)

	)

472 
	#FRC_SIMPLE_RING_BUFF_SIZE
 
FRC_DMA_SIMPLE_PACKAGE_RING_BUFF_SIZE


	)

474 
	mFRC_WORK_UDP
,

475 
	mFRC_WORK_RULE
,

476 
	mFRC_WORK_SSN
,

477 
	mFRC_WORK_MAX


478 }
	täc_wÜk_e
;

481 
ušt64_t
 
	mty³
;

482 
ušt64_t
 
	mù¾_addr
;

483 
ušt64_t
 
	mù¾_size
;

484 
ušt64_t
 
	mpoŞ_addr
;

485 
ušt64_t
 
	mpoŞ_size
;

486 } 
	täc_dma_chª_desc_t
;

489 
ušt64_t
 
	mwidx
;

490 
ušt64_t
 
	mridx
;

491 
ušt64_t
 
	mbuff
[
FRC_DMA_SIMPLE_PACKAGE_RING_BUFF_SIZE
];

492 } 
	täc_sim¶e_·ckage_ršg_buff_t
;

494 
	säc_dma_sim¶e_·ckage_chª_ù¾
 {

495 
äc_sim¶e_·ckage_ršg_buff_t
 
	mavaabË_ršg
;

496 
äc_sim¶e_·ckage_ršg_buff_t
 
	mcom¶‘ed_ršg
;

497 } 
	täc_dma_sim¶e_·ckage_chª_ù¾_t
;

499 
	säc_sim¶e_·ckage_block
{

500 
ušt8_t
 
	m»£rv”d
[
FRC_DMA_OFFSET
];

501 
ušt8_t
 
	md©a
[
FRC_DMA_SIMPLE_PACKAGE_DATA_SIZE
];

502 }
	täc_sim¶e_·ckage_block_t
;

504 
šlše
 
ušt64_t
 
	$sim¶e_·ckage_ršg_ridx
(
äc_sim¶e_·ckage_ršg_buff_t
 *
ršg
)

506 #ià
__FRC_BYTE_ORDER
 =ğ
__FRC_BIG_ENDIAN


507  
ršg
->
ridx
;

509  
	`SWAP_8_BYTE
(
ršg
->
ridx
);

511 
	}
}

513 
šlše
 
ušt64_t
 
	$sim¶e_·ckage_ršg_widx
(
äc_sim¶e_·ckage_ršg_buff_t
 *
ršg
)

515 #ià
__FRC_BYTE_ORDER
 =ğ
__FRC_BIG_ENDIAN


516  
ršg
->
widx
;

518  
	`SWAP_8_BYTE
(
ršg
->
widx
);

520 
	}
}

528 
šlše
 
ušt64_t


529 
	$__sim¶e_·ckage_ršg_put
(
äc_sim¶e_·ckage_ršg_buff_t
 *
ršg
, 
ušt64_t
 
buff
)

531 
ušt64_t
 
Ën
;

532 
ušt64_t
 
ridx
, 
widx
;

534 
ridx
 = 
	`sim¶e_·ckage_ršg_ridx
(
ršg
);

535 
widx
 = 
	`sim¶e_·ckage_ršg_widx
(
ršg
);

537 ià((
widx
 >ğ
ridx
è&& (widx -„idx < 
FRC_DMA_SIMPLE_PACKAGE_RING_BUFF_SIZE
)) {

538 #ià
__FRC_BYTE_ORDER
 =ğ
__FRC_LITTLE_ENDIAN


539 
ršg
->
buff
[
widx
%
FRC_DMA_SIMPLE_PACKAGE_RING_BUFF_SIZE
] = 
	`SWAP_8_BYTE
(buff);

541 
ršg
->
buff
[
widx
%
FRC_DMA_SIMPLE_PACKAGE_RING_BUFF_SIZE
] = buff;

543 
widx
 += 1;

544 #ià
__FRC_BYTE_ORDER
 =ğ
__FRC_LITTLE_ENDIAN


545 
ršg
->
widx
 = 
	`SWAP_8_BYTE
(widx);

547 
ršg
->
widx
 = widx;

549 
Ën
 = 1;

551 
Ën
 = 0;

553  
Ën
;

554 
	}
}

562 
šlše
 
ušt64_t


563 
	$__sim¶e_·ckage_ršg_g‘
(
äc_sim¶e_·ckage_ršg_buff_t
 *
ršg
, 
ušt64_t
 *
buff
)

565 
ušt64_t
 
Ën
;

566 
ušt64_t
 
ridx
, 
widx
;

568 
ridx
 = 
	`sim¶e_·ckage_ršg_ridx
(
ršg
);

569 
widx
 = 
	`sim¶e_·ckage_ršg_widx
(
ršg
);

571 ià((
widx
 > 
ridx
è&& (widx -„idx <ğ
FRC_DMA_SIMPLE_PACKAGE_RING_BUFF_SIZE
)) {

572 #ià
__FRC_BYTE_ORDER
 =ğ
__FRC_LITTLE_ENDIAN


573 *
buff
 = 
	`SWAP_8_BYTE
(
ršg
->buff[
ridx
%
FRC_DMA_SIMPLE_PACKAGE_RING_BUFF_SIZE
]);

575 *
buff
 = 
ršg
->buff[
ridx
%
FRC_DMA_SIMPLE_PACKAGE_RING_BUFF_SIZE
];

577 
ridx
 += 1;

578 #ià
__FRC_BYTE_ORDER
 =ğ
__FRC_LITTLE_ENDIAN


579 
ršg
->
ridx
 = 
	`SWAP_8_BYTE
(ridx);

581 
ršg
->
ridx
 =„idx;

583 
Ën
 = 1;

585 
Ën
 = 0;

587  
Ën
;

588 
	}
}

590 
	#SIMPLE_PACKAGE_AVAIL_RING_GET
(
_dma_ù¾
, 
_buff
) \

591 (
	`__sim¶e_·ckage_ršg_g‘
(&((
_dma_ù¾
).
avaabË_ršg
), (
ušt64_t
 *è&(
_buff
)è=ğ1)

	)

592 
	#SIMPLE_PACKAGE_AVAIL_RING_PUT
(
_dma_ù¾
, 
_buff
) \

593 (
	`__sim¶e_·ckage_ršg_put
(&((
_dma_ù¾
).
avaabË_ršg
), (
ušt64_t
 ) (
_buff
)è=ğ1)

	)

595 
	#SIMPLE_PACKAGE_COMPL_RING_GET
(
_dma_ù¾
, 
_buff
) \

596 (
	`__sim¶e_·ckage_ršg_g‘
(&((
_dma_ù¾
).
com¶‘ed_ršg
), (
ušt64_t
 *è&(
_buff
)è=ğ1)

	)

597 
	#SIMPLE_PACKAGE_COMPL_RING_PUT
(
_dma_ù¾
, 
_buff
) \

598 (
	`__sim¶e_·ckage_ršg_put
(&((
_dma_ù¾
).
com¶‘ed_ršg
), (
ušt64_t
 ) (
_buff
)è=ğ1)

	)

600 
	#FRC_DMA_SIMPLE_PACKAGE_CHAN_POOL_NUM
 10

	)

601 
	#FRC_DMA_SIMPLE_PACKAGE_CHAN_NUM
 2

	)

602 
	#FRC_DMA_POOL_SIZE
 (
FRC_MEM_PAGE_SIZE
 * 
FRC_DMA_BUFF_PAGES
)

	)

603 
	#FRC_DMA_SIMPLE_PACKAGE_POOL_NUM_MAX
 
FRC_DMA_SIMPLE_PACKAGE_CHAN_POOL_NUM


	)

605 
ušt64_t
 
	mpoŞ_num
;

606 
ušt64_t
 
	mpoŞ_addr
[
FRC_DMA_SIMPLE_PACKAGE_CHAN_POOL_NUM
];

607 } 
	täc_dma_sim¶e_·ckage_poŞ_t
;

610 
äc_dma_chª_desc_t
 
	mdesc
;

611 
äc_dma_sim¶e_·ckage_chª_ù¾_t
 *
	mdma_ù¾
;

612 
äc_dma_sim¶e_·ckage_poŞ_t
 *
	mpoŞ
;

613 } 
	täc_dma_sim¶e_·ckage_chª_t
;

615 
	#FRC_DMA_SIMPLE_CHAN_CHAN_AVAIL_OFFSET
 0

	)

616 
	#FRC_DMA_SIMPLE_CHAN_AVAIL_WIDX_OFFSET
 (
FRC_DMA_SIMPLE_CHAN_CHAN_AVAIL_OFFSET
 + 0)

	)

617 
	#FRC_DMA_SIMPLE_CHAN_AVAIL_RIDX_OFFSET
 (
FRC_DMA_SIMPLE_CHAN_CHAN_AVAIL_OFFSET
 + 8)

	)

618 
	#FRC_DMA_SIMPLE_CHAN_AVAIL_RING_OFFSET
 (
FRC_DMA_SIMPLE_CHAN_CHAN_AVAIL_OFFSET
 + 16)

	)

620 
	#FRC_DMA_SIMPLE_CHAN_COMPL_OFFSET
 (
äc_sim¶e_·ckage_ršg_buff_t
)

	)

621 
	#FRC_DMA_SIMPLE_CHAN_COMPL_WIDX_OFFSET
 (
FRC_DMA_SIMPLE_CHAN_COMPL_OFFSET
 + 0)

	)

622 
	#FRC_DMA_SIMPLE_CHAN_COMPL_RIDX_OFFSET
 (
FRC_DMA_SIMPLE_CHAN_COMPL_OFFSET
 + 8)

	)

623 
	#FRC_DMA_SIMPLE_CHAN_COMPL_RING_OFFSET
 (
FRC_DMA_SIMPLE_CHAN_COMPL_OFFSET
 + 16)

	)

628 
	#FRC_DMA_SSN_RING_BUFF_SIZE
 (400896)

	)

630 
	#FRC_DMA_SSN_BLOCK_SIZE
 (8*
K
)

	)

631 
	#FRC_DMA_SSN_CHAN_POOL_NUM
 (
FRC_DMA_SSN_RING_BUFF_SIZE
/(
FRC_DMA_POOL_SIZE
/
FRC_DMA_SSN_BLOCK_SIZE
))

	)

632 
	#FRC_DMA_SSN_POOL_NUM_MAX
 
FRC_DMA_SSN_CHAN_POOL_NUM


	)

633 
	#FRC_DMA_SSN_CHAN_NUM
 1

	)

634 
	#FRC_DMA_SSN_DATA_SIZE
 (
FRC_DMA_SSN_BLOCK_SIZE
 - 
FRC_DMA_OFFSET
)

	)

636 
ušt64_t
 
	mwidx
;

637 
ušt64_t
 
	mridx
;

638 
ušt64_t
 
	mbuff
[
FRC_DMA_SSN_RING_BUFF_SIZE
];

639 } 
	täc_s¢_ršg_buff_t
;

642 
ušt64_t
 
	mpoŞ_num
;

643 
ušt64_t
 
	mpoŞ_addr
[
FRC_DMA_SSN_CHAN_POOL_NUM
];

644 } 
	täc_dma_s¢_poŞ_t
;

647 
ušt64_t
 
	mty³
;

648 
ušt64_t
 
	mava_addr
;

649 
ušt64_t
 
	mava_size
;

650 
ušt64_t
 
	mcom¶_addr
;

651 
ušt64_t
 
	mcom¶_size
;

652 
ušt64_t
 
	mpoŞ_addr
;

653 
ušt64_t
 
	mpoŞ_size
;

654 } 
	täc_dma_s¢_chª_desc_t
;

657 
äc_dma_s¢_chª_desc_t
 
	mdesc
;

658 
äc_s¢_ršg_buff_t
 *
	mavaabË_ršg
;

659 
äc_s¢_ršg_buff_t
 *
	mcom¶‘ed_ršg
;

660 
äc_dma_s¢_poŞ_t
 *
	mpoŞ
;

661 } 
	täc_dma_s¢_chª_t
;

663 
šlše
 
ušt64_t
 
	$s¢_ršg_ridx
(
äc_s¢_ršg_buff_t
 *
ršg
)

665 #ià
__FRC_BYTE_ORDER
 =ğ
__FRC_BIG_ENDIAN


666  
ršg
->
ridx
;

668  
	`SWAP_8_BYTE
(
ršg
->
ridx
);

670 
	}
}

672 
šlše
 
ušt64_t
 
	$s¢_ršg_widx
(
äc_s¢_ršg_buff_t
 *
ršg
)

674 #ià
__FRC_BYTE_ORDER
 =ğ
__FRC_BIG_ENDIAN


675  
ršg
->
widx
;

677  
	`SWAP_8_BYTE
(
ršg
->
widx
);

679 
	}
}

687 
šlše
 
ušt64_t


688 
	$__s¢_ršg_put
(
äc_s¢_ršg_buff_t
 *
ršg
, 
ušt64_t
 
buff
)

690 
ušt64_t
 
Ën
;

691 
ušt64_t
 
ridx
, 
widx
;

693 
ridx
 = 
	`s¢_ršg_ridx
(
ršg
);

694 
widx
 = 
	`s¢_ršg_widx
(
ršg
);

696 ià((
widx
 >ğ
ridx
è&& (widx -„idx < 
FRC_DMA_SSN_RING_BUFF_SIZE
)) {

697 #ià
__FRC_BYTE_ORDER
 =ğ
__FRC_LITTLE_ENDIAN


698 
ršg
->
buff
[
widx
%
FRC_DMA_SSN_RING_BUFF_SIZE
] = 
	`SWAP_8_BYTE
(buff);

700 
ršg
->
buff
[
widx
%
FRC_DMA_SSN_RING_BUFF_SIZE
] = buff;

702 
widx
 += 1;

703 #ià
__FRC_BYTE_ORDER
 =ğ
__FRC_LITTLE_ENDIAN


704 
ršg
->
widx
 = 
	`SWAP_8_BYTE
(widx);

706 
ršg
->
widx
 = widx;

708 
Ën
 = 1;

710 
Ën
 = 0;

712  
Ën
;

713 
	}
}

721 
šlše
 
ušt64_t


722 
	$__s¢_ršg_g‘
(
äc_s¢_ršg_buff_t
 *
ršg
, 
ušt64_t
 *
buff
)

724 
ušt64_t
 
Ën
;

725 
ušt64_t
 
ridx
, 
widx
;

727 
ridx
 = 
	`s¢_ršg_ridx
(
ršg
);

728 
widx
 = 
	`s¢_ršg_widx
(
ršg
);

732 ià((
widx
 > 
ridx
è&& (widx -„idx <ğ
FRC_DMA_SSN_RING_BUFF_SIZE
)) {

733 #ià
__FRC_BYTE_ORDER
 =ğ
__FRC_LITTLE_ENDIAN


734 *
buff
 = 
	`SWAP_8_BYTE
(
ršg
->buff[
ridx
%
FRC_DMA_SSN_RING_BUFF_SIZE
]);

736 *
buff
 = 
ršg
->buff[
ridx
%
FRC_DMA_SSN_RING_BUFF_SIZE
];

738 
ridx
 += 1;

739 #ià
__FRC_BYTE_ORDER
 =ğ
__FRC_LITTLE_ENDIAN


740 
ršg
->
ridx
 = 
	`SWAP_8_BYTE
(ridx);

742 
ršg
->
ridx
 =„idx;

744 
Ën
 = 1;

746 
Ën
 = 0;

748  
Ën
;

749 
	}
}

751 
	#SSN_AVAIL_RING_GET
(
_dma_chª
, 
_buff
) \

752 (
	`__s¢_ršg_g‘
(((
_dma_chª
).
avaabË_ršg
), (
ušt64_t
 *è&(
_buff
)è=ğ1)

	)

753 
	#SSN_AVAIL_RING_PUT
(
_dma_chª
, 
_buff
) \

754 (
	`__s¢_ršg_put
(((
_dma_chª
).
avaabË_ršg
), (
ušt64_t
 ) (
_buff
)è=ğ1)

	)

756 
	#SSN_COMPL_RING_GET
(
_dma_chª
, 
_buff
) \

757 (
	`__s¢_ršg_g‘
(((
_dma_chª
).
com¶‘ed_ršg
), (
ušt64_t
 *è&(
_buff
)è=ğ1)

	)

758 
	#SSN_COMPL_RING_PUT
(
_dma_chª
, 
_buff
) \

759 (
	`__s¢_ršg_put
(((
_dma_chª
).
com¶‘ed_ršg
), (
ušt64_t
 ) (
_buff
)è=ğ1)

	)

761 
	#FRC_DMA_SSN_CHAN_AVAIL_OFFSET
 0

	)

762 
	#FRC_DMA_SSN_AVAIL_WIDX_OFFSET
 (
FRC_DMA_SSN_CHAN_AVAIL_OFFSET
 + 0)

	)

763 
	#FRC_DMA_SSN_AVAIL_RIDX_OFFSET
 (
FRC_DMA_SSN_CHAN_AVAIL_OFFSET
 + 8)

	)

764 
	#FRC_DMA_SSN_AVAIL_RING_OFFSET
 (
FRC_DMA_SSN_CHAN_AVAIL_OFFSET
 + 16)

	)

766 
	#FRC_DMA_SSN_COMPL_OFFSET
 0

	)

767 
	#FRC_DMA_SSN_COMPL_WIDX_OFFSET
 (
FRC_DMA_SSN_COMPL_OFFSET
 + 0)

	)

768 
	#FRC_DMA_SSN_COMPL_RIDX_OFFSET
 (
FRC_DMA_SSN_COMPL_OFFSET
 + 8)

	)

769 
	#FRC_DMA_SSN_COMPL_RING_OFFSET
 (
FRC_DMA_SSN_COMPL_OFFSET
 + 16)

	)

771 
	säc_s¢_block
{

772 
ušt8_t
 
	m»£rv”d
[
FRC_DMA_OFFSET
];

773 
ušt8_t
 
	md©a
[
FRC_DMA_SSN_DATA_SIZE
];

774 }
	täc_s¢_block_t
;

	@include/frc_ioctl.h

1 #iâdeà 
__FRC_IOCTL_H__


2 
	#__FRC_IOCTL_H__


	)

4 
	#FRC_DEVICE_NAME
 "äc"

	)

5 
	#FRC_DEVICE_PATH
 "/dev/"
FRC_DEVICE_NAME


	)

7 
	#FRC_DEVICE_MAJOR
 250

	)

9 
	säc_ioùl
 {

10 
ušt32_t
 
	mdid
;

11 
ušt32_t
 
	mrv
;

12 
ušt16_t
 
	mty³
;

13 
ušt16_t
 
	mcmd
;

14 
ušt16_t
 
	m’
;

15 
ušt16_t
 
	mŞ’
;

16 *
	mšput
;

17 *
	mouut
;

18 } 
	täc_ioùl_t
;

20 #ià
defšed
(
_WIN32
)

22 
	#_IOWR
(
_A
, 
_B
, 
_C
è
	`CTL_CODE
(
FILE_DEVICE_UNKNOWN
, 0x8000 | _B, 
METHOD_NEITHER
, \

23 
FILE_READ_DATA
 | 
FILE_WRITE_DATA
)

	)

26 
	#FRC_MAGIC
 0xC2

	)

28 
	#FRCDRV_REQUEST_CODE
 1

	)

29 
	#FRCORE_REQUEST_CODE
 2

	)

32 
	#IOCTL_FRCDRV_REQUEST
 \

33 
	`_IOWR
(
FRC_MAGIC
, 
FRCDRV_REQUEST_CODE
, 
äc_ioùl_t
)

	)

35 
	#IOCTL_FRCORE_REQUEST
 \

36 
	`_IOWR
(
FRC_MAGIC
, 
FRCORE_REQUEST_CODE
, 
äc_ioùl_t
)

	)

	@include/frc_list.h

1 #iâdeà
__FRC_LIST_H__


2 
	#__FRC_LIST_H__


	)

5 
	s__äc_li¡_node
 {

6 
__äc_li¡_node
 *
	mË_Ãxt
;

7 
__äc_li¡_node
 *
	mË_´ev
;

10 
__äc_li¡_node
 
	täc_li¡_t
;

12 
šlše
 

13 
	$FRC_INIT_LIST_HEAD
(
äc_li¡_t
 *
±r
)

15 
±r
->
Ë_Ãxt
 =…Œ;…Œ->
Ë_´ev
 =…tr;

16 
	}
}

20 
šlše


21 
	$äc_li¡_add_h—d
(
äc_li¡_t
 *
node
, frc_li¡_ˆ*
h—d
)

23 
h—d
->
Ë_Ãxt
->
Ë_´ev
 = 
node
;

24 
node
->
Ë_Ãxt
 = 
h—d
->le_next;

25 
h—d
->
Ë_Ãxt
 = 
node
;

26 
node
->
Ë_´ev
 = 
h—d
;

27 
	}
}

30 
šlše


31 
	$äc_li¡_add_
(
äc_li¡_t
 *
node
, frc_li¡_ˆ*
h—d
)

33 
h—d
->
Ë_´ev
->
Ë_Ãxt
 = 
node
;

34 
node
->
Ë_´ev
 = 
h—d
->le_prev;

35 
h—d
->
Ë_´ev
 = 
node
;

36 
node
->
Ë_Ãxt
 = 
h—d
;

37 
	}
}

46 
šlše


47 
	$äc_li¡_move
(
äc_li¡_t
 *
li¡1
, frc_li¡_ˆ*
li¡2
)

49 if(
li¡2
->
Ë_Ãxt
 !=†ist2) {

50 
li¡1
->
Ë_Ãxt
 = 
li¡2
->le_next;

51 
li¡1
->
Ë_Ãxt
->
Ë_´ev
 =†ist1;

52 
li¡1
->
Ë_´ev
 = 
li¡2
->le_prev;

53 
li¡1
->
Ë_´ev
->
Ë_Ãxt
 =†ist1;

56 
li¡2
->
Ë_Ãxt
 =†i¡2->
Ë_´ev
 =†ist2;

57 
	}
}

62 
šlše


63 
äc_li¡_t
 *
	$äc_li¡_g‘_h—d
(
äc_li¡_t
 *
roÙ
)

65 ifĞ(
roÙ
->
Ë_´ev
 =ğroÙè&& (roÙ->
Ë_Ãxt
 ==„oot) )

66  
NULL
;

68  
roÙ
->
Ë_Ãxt
;

69 
	}
}

73 
šlše


74 
äc_li¡_t
 *
	$äc_li¡_g‘_
(
äc_li¡_t
 *
roÙ
)

76 ifĞ(
roÙ
->
Ë_´ev
 =ğroÙè&& (roÙ->
Ë_Ãxt
 ==„oot) )

77  
NULL
;

79  
roÙ
->
Ë_´ev
;

80 
	}
}

86 
šlše


87 
	$äc_li¡_d–
(
äc_li¡_t
 *
node
)

89 
node
->
Ë_Ãxt
->
Ë_´ev
 =‚ode->le_prev;

90 
node
->
Ë_´ev
->
Ë_Ãxt
 =‚ode->le_next;

91 
	}
}

96 
šlše


97 
äc_li¡_t
 *
	$äc_li¡_d–‘e_h—d
(
äc_li¡_t
 *
roÙ
)

99 
äc_li¡_t
 *
node
 = 
	`äc_li¡_g‘_h—d
(
roÙ
);

100 if(
node
)

101 
	`äc_li¡_d–
(
node
);

103  
node
;

104 
	}
}

108 
	#äc_li¡_fÜ_—ch
(
tmp
, 
h—d
) \

109 
tmp
 = (
h—d
)->
Ë_Ãxt
;m°!ğ(h—d);m°ğtmp->Ë_Ãxt)

	)

112 
	#äc_li¡_fÜ_—ch_§ã
(
tmp
, 
tmp2
, 
h—d
) \

113 
tmp
 = (
h—d
)->
Ë_Ãxt
, 
tmp2
 =mp->Ë_Ãxt;m°!ğ(h—d);m°ğtmp2,mp2 =mp->Ë_Ãxt)

	)

	@include/frc_pack.h

1 #iâdeà
__FRC_PACK_H__


2 
	#__FRC_PACK_H__


	)

5 
	~"äc.h
"

6 
	~"äc_ut.h
"

9 
	#PACK_U8
(
_buf
, 
_v¬
) \

10 *
_buf
++ = (
_v¬
è& 0xff

	)

11 
	#UNPACK_U8
(
_buf
, 
_v¬
) \

12 
_v¬
 = *
_buf
++ & 0xff

	)

14 
	#PACK_U16
(
_buf
, 
_v¬
) \

15 *
_buf
++ = ((
_v¬
) >> 8) & 0xff; \

16 *
_buf
++ = (
_v¬
è& 0xff;

	)

17 
	#UNPACK_U16
(
_buf
, 
_v¬
) \

18 
_v¬
 = (*
_buf
++ & 0xff) << 8; \

19 
_v¬
 |ğ(*
_buf
++ & 0xff);

	)

21 
	#PACK_U32
(
_buf
, 
_v¬
) \

22 *
_buf
++ = ((
_v¬
) >> 24) & 0xff; \

23 *
_buf
++ = ((
_v¬
) >> 16) & 0xff; \

24 *
_buf
++ = ((
_v¬
) >> 8) & 0xff; \

25 *
_buf
++ = (
_v¬
è& 0xff;

	)

27 
	#UNPACK_U32
(
_buf
, 
_v¬
) \

28 
_v¬
 = 0; \

29 
_v¬
 |ğ(*
_buf
++ & 0xff) << 24; \

30 
_v¬
 |ğ(*
_buf
++ & 0xff) << 16; \

31 
_v¬
 |ğ(*
_buf
++ & 0xff) << 8; \

32 
_v¬
 |ğ(*
_buf
++ & 0xff);

	)

34 
	#PACK_BYTES
(
_buf
, 
_v¬
, 
_Ën
) \

36 
b
; \

37 
b
 = 0; b < 
_Ën
; b++) { \

38 
	`PACK_U8
(
_buf
, (
_v¬
)[
b
]); \

40 }

	)

42 
	#UNPACK_BYTES
(
_buf
, 
_v¬
, 
_Ën
) \

44 
b
; \

45 
b
 = 0; b < 
_Ën
; b++) { \

46 
	`UNPACK_U8
(
_buf
, (
_v¬
)[
b
]); \

48 }

	)

50 
	#PACK_MAC
(
_buf
, 
_mac
) \

51 *
_buf
++ = ((
ušt8_t
 *è&(
_mac
))[0] & 0xff; \

52 *
_buf
++ = ((
ušt8_t
 *è&(
_mac
))[1] & 0xff; \

53 *
_buf
++ = ((
ušt8_t
 *è&(
_mac
))[2] & 0xff; \

54 *
_buf
++ = ((
ušt8_t
 *è&(
_mac
))[3] & 0xff; \

55 *
_buf
++ = ((
ušt8_t
 *è&(
_mac
))[4] & 0xff; \

56 *
_buf
++ = ((
ušt8_t
 *è&(
_mac
))[5] & 0xff;

	)

58 
	#UNPACK_MAC
(
_buf
, 
_mac
) \

59 ((
ušt8_t
 *è&(
_mac
))[0] = *
_buf
++ & 0xff; \

60 ((
ušt8_t
 *è&(
_mac
))[1] = *
_buf
++ & 0xff; \

61 ((
ušt8_t
 *è&(
_mac
))[2] = *
_buf
++ & 0xff; \

62 ((
ušt8_t
 *è&(
_mac
))[3] = *
_buf
++ & 0xff; \

63 ((
ušt8_t
 *è&(
_mac
))[4] = *
_buf
++ & 0xff; \

64 ((
ušt8_t
 *è&(
_mac
))[5] = *
_buf
++ & 0xff;

	)

66 
šlše
 *

67 
	$u8_·ck
(*
buf
, 
ušt8_t
 *
v¬
)

69 
	`PACK_U8
(
buf
, *
v¬
);

71  
buf
;

72 
	}
}

74 
šlše
 *

75 
	$u8_uÅack
(*
buf
, 
ušt8_t
 *
v¬
)

77 
	`UNPACK_U8
(
buf
, *
v¬
);

79  
buf
;

80 
	}
}

82 
šlše
 *

83 
	$u16_·ck
(*
buf
, 
ušt16_t
 *
v¬
)

85 
	`PACK_U16
(
buf
, *
v¬
);

87  
buf
;

88 
	}
}

90 
šlše
 *

91 
	$u16_uÅack
(*
buf
, 
ušt16_t
 *
v¬
)

93 
	`UNPACK_U16
(
buf
, *
v¬
);

95  
buf
;

96 
	}
}

98 
šlše
 *

99 
	$u32_·ck
(*
buf
, 
ušt32_t
 *
v¬
)

101 
	`PACK_U32
(
buf
, *
v¬
);

103  
buf
;

104 
	}
}

106 
šlše
 *

107 
	$u32_uÅack
(*
buf
, 
ušt32_t
 *
v¬
)

109 
	`UNPACK_U32
(
buf
, *
v¬
);

111  
buf
;

112 
	}
}

114 
šlše
 *

115 
	$u64_·ck
(*
buf
, 
ušt64_t
 *
v¬
)

117 
ušt32_t
 
_u32
;

119 
_u32
 = 
	`FRC_64_HI
(*
v¬
);

120 
	`PACK_U32
(
buf
, 
_u32
);

121 
_u32
 = 
	`FRC_64_LO
(*
v¬
);

122 
	`PACK_U32
(
buf
, 
_u32
);

124  
buf
;

125 
	}
}

127 
šlše
 *

128 
	$u64_uÅack
(*
buf
, 
ušt64_t
 *
v¬
)

130 
ušt32_t
 
_u32h
, 
_u32l
;

132 
	`UNPACK_U32
(
buf
, 
_u32h
);

133 
	`UNPACK_U32
(
buf
, 
_u32l
);

134 
	`FRC_64_SET
(*
v¬
, 
_u32h
, 
_u32l
);

136  
buf
;

137 
	}
}

140 
šlše
 *

141 
	$äc_v”siÚ_·ck
(*
buf
, 
äc_v”siÚ_t
 *
v¬
)

144 
	`PACK_U8
(
buf
, 
v¬
->
majÜ
);

145 
	`PACK_U8
(
buf
, 
v¬
->
mšÜ
);

146 
	`PACK_U16
(
buf
, 
v¬
->
bud
);

148  
buf
;

149 
	}
}

151 
šlše
 *

152 
	$äc_v”siÚ_uÅack
(*
buf
, 
äc_v”siÚ_t
 *
v¬
)

154 
	`UNPACK_U8
(
buf
, 
v¬
->
majÜ
);

155 
	`UNPACK_U8
(
buf
, 
v¬
->
mšÜ
);

156 
	`UNPACK_U16
(
buf
, 
v¬
->
bud
);

158  
buf
;

159 
	}
}

162 
šlše
 *

163 
	$äc_bdd_¡©us_uÅack
(*
buf
, 
äc_bdd_¡©us_out_t
 *
v¬
)

165 
buf
 = 
	`u64_uÅack
(buf, &
v¬
->
‹mp
.
loÿl
);

166 
buf
 = 
	`u64_uÅack
(buf, &
v¬
->
‹mp
.
»mÙe
);

167 
	`UNPACK_U16
(
buf
, 
v¬
->
dma_block_size
);

168 
	`UNPACK_U16
(
buf
, 
v¬
->
ruÂšg_¡©us
);

169 
	`UNPACK_U32
(
buf
, 
v¬
->
ruË_max
);

170 
	`UNPACK_U32
(
buf
, 
v¬
->
s¢_max
);

171 
	`UNPACK_U8
(
buf
, 
v¬
->
où0
.
lšk
);

172 
	`UNPACK_U8
(
buf
, 
v¬
->
où0
.
’abË
);

173 
	`UNPACK_U8
(
buf
, 
v¬
->
où0
.
wÜk_mode
);

174 
	`UNPACK_U8
(
buf
, 
v¬
->
où0
.
loİback_mode
);

175 
	`UNPACK_U16
(
buf
, 
v¬
->
où0
.
İtiÿl_¡©us
);

176 
	`UNPACK_U16
(
buf
, 
v¬
->
où0
.
İtiÿl
);

177 
	`UNPACK_U32
(
buf
, 
v¬
->
où0
.
rx_pkts_¿‹
);

178 
	`UNPACK_U32
(
buf
, 
v¬
->
où0
.
rx_by‹s_¿‹
);

179 
	`UNPACK_U32
(
buf
, 
v¬
->
où0
.
tx_pkts_¿‹
);

180 
	`UNPACK_U32
(
buf
, 
v¬
->
où0
.
tx_by‹s_¿‹
);

181 
	`UNPACK_U8
(
buf
, 
v¬
->
où1
.
lšk
);

182 
	`UNPACK_U8
(
buf
, 
v¬
->
où1
.
’abË
);

183 
	`UNPACK_U8
(
buf
, 
v¬
->
où1
.
wÜk_mode
);

184 
	`UNPACK_U8
(
buf
, 
v¬
->
où1
.
loİback_mode
);

185 
	`UNPACK_U16
(
buf
, 
v¬
->
où1
.
İtiÿl_¡©us
);

186 
	`UNPACK_U16
(
buf
, 
v¬
->
où1
.
İtiÿl
);

187 
	`UNPACK_U32
(
buf
, 
v¬
->
où1
.
rx_pkts_¿‹
);

188 
	`UNPACK_U32
(
buf
, 
v¬
->
où1
.
rx_by‹s_¿‹
);

189 
	`UNPACK_U32
(
buf
, 
v¬
->
où1
.
tx_pkts_¿‹
);

190 
	`UNPACK_U32
(
buf
, 
v¬
->
où1
.
tx_by‹s_¿‹
);

192  
buf
;

193 
	}
}

196 
šlše
 *

197 
	$äc_bdd_šfo_uÅack
(*
buf
, 
äc_bdd_šfo_out_t
 *
v¬
)

199 
buf
 = 
	`äc_v”siÚ_uÅack
(buf, &
v¬
->
äcÜe_v”siÚ
);

200 
buf
 = 
	`äc_v”siÚ_uÅack
(buf, &
v¬
->
äcdrv_v”siÚ
);

201 
buf
 = 
	`äc_v”siÚ_uÅack
(buf, &
v¬
->
äùw—k_v”siÚ
);

202 
buf
 = 
	`äc_v”siÚ_uÅack
(buf, &
v¬
->
oùdrv_v”siÚ
);

203 
buf
 = 
	`äc_v”siÚ_uÅack
(buf, &
v¬
->
oùnic_v”siÚ
);

204 
	`UNPACK_U32
(
buf
, 
v¬
->
ıld_v”siÚ
);

205 
	`UNPACK_U32
(
buf
, 
v¬
->
pÜt_numb”
);

207  
buf
;

208 
	}
}

210 
šlše
 *

211 
	$äc_tu¶e_·ck
(*
buf
, 
äc_ä_tu¶e_t
 *
v¬
)

213 
	`PACK_U32
(
buf
, 
v¬
->
s
);

214 
	`PACK_U32
(
buf
, 
v¬
->
d
);

215 
	`PACK_U16
(
buf
, 
v¬
->
¥
);

216 
	`PACK_U16
(
buf
, 
v¬
->
dp
);

217 
	`PACK_U16
(
buf
, 
v¬
->
´Ùo
);

218 
	`PACK_U16
(
buf
, 
v¬
->
»£rve
);

220  
buf
;

221 
	}
}

224 
šlše
 *

225 
	$äc_tu¶e_uÅack
(*
buf
, 
äc_ä_tu¶e_t
 *
v¬
)

227 #ià
__FRC_BYTE_ORDER
 =ğ
__FRC_LITTLE_ENDIAN


228 
	`UNPACK_U32
(
buf
, 
v¬
->
d
);

229 
	`UNPACK_U32
(
buf
, 
v¬
->
s
);

230 
	`UNPACK_U16
(
buf
, 
v¬
->
»£rve
);

231 
	`UNPACK_U16
(
buf
, 
v¬
->
´Ùo
);

232 
	`UNPACK_U16
(
buf
, 
v¬
->
dp
);

233 
	`UNPACK_U16
(
buf
, 
v¬
->
¥
);

235 
	`UNPACK_U32
(
buf
, 
v¬
->
s
);

236 
	`UNPACK_U32
(
buf
, 
v¬
->
d
);

237 
	`UNPACK_U16
(
buf
, 
v¬
->
¥
);

238 
	`UNPACK_U16
(
buf
, 
v¬
->
dp
);

239 
	`UNPACK_U16
(
buf
, 
v¬
->
´Ùo
);

240 
	`UNPACK_U16
(
buf
, 
v¬
->
»£rve
);

243  
buf
;

244 
	}
}

247 
šlše
 *

248 
	$äc_ä_£ssiÚ_t_uÅack
(*
buf
, 
äc_ä_£ssiÚ_t
 *
v¬
)

250 
buf
 = 
	`äc_tu¶e_uÅack
(buf, &
v¬
->
five_tu¶e
);

251 #ià
__FRC_BYTE_ORDER
 =ğ
__FRC_LITTLE_ENDIAN


252 
	`UNPACK_U32
(
buf
, 
v¬
->
£ssiÚ_¡©
.
by‹s
);

253 
	`UNPACK_U32
(
buf
, 
v¬
->
£ssiÚ_¡©
.
pkts
);

255 
	`UNPACK_U32
(
buf
, 
v¬
->
£ssiÚ_¡©
.
pkts
);

256 
	`UNPACK_U32
(
buf
, 
v¬
->
£ssiÚ_¡©
.
by‹s
);

258  
buf
;

260 
	}
}

262 
šlše
 *

263 
	$äc_ruË_uÅack
(*
buf
, 
äc_ruË_t
 *
v¬
)

265 #ià
__FRC_BYTE_ORDER
 =ğ
__FRC_LITTLE_ENDIAN


270 
	`UNPACK_U16
(
buf
, 
v¬
->
İ
);

271 
	`UNPACK_U16
(
buf
, 
v¬
->
aùiÚ
);

272 
	`UNPACK_U16
(
buf
, 
v¬
->
ruË_ty³
);

273 
	`UNPACK_U16
(
buf
, 
v¬
->
ruË_sourû
);

274 
	`UNPACK_U32
(
buf
, 
v¬
->
d
);

276 
	`UNPACK_U32
(
buf
, 
v¬
->
s
);

278 
	`UNPACK_U16
(
buf
, 
v¬
->
šdex
);

279 
	`UNPACK_U16
(
buf
, 
v¬
->
´Ùo
);

281 
	`UNPACK_U16
(
buf
, 
v¬
->
dp
);

283 
	`UNPACK_U16
(
buf
, 
v¬
->
¥
);

290 
	`UNPACK_U16
(
buf
, 
v¬
->
ruË_sourû
);

291 
	`UNPACK_U16
(
buf
, 
v¬
->
ruË_ty³
);

292 
	`UNPACK_U16
(
buf
, 
v¬
->
aùiÚ
);

293 
	`UNPACK_U16
(
buf
, 
v¬
->
İ
);

294 
	`UNPACK_U32
(
buf
, 
v¬
->
s
);

295 
	`´štf
("v¬->s = 0x%x\n", 
v¬
->
s
);

296 
	`UNPACK_U32
(
buf
, 
v¬
->
d
);

297 
	`´štf
("v¬->d = 0x%x\n", 
v¬
->
d
);

298 
	`UNPACK_U16
(
buf
, 
v¬
->
¥
);

299 
	`´štf
("v¬->¥ = 0x%x\n", 
v¬
->
¥
);

300 
	`UNPACK_U16
(
buf
, 
v¬
->
dp
);

301 
	`´štf
("v¬->d°ğ0x%x\n", 
v¬
->
dp
);

302 
	`UNPACK_U16
(
buf
, 
v¬
->
´Ùo
);

303 
	`´štf
("v¬->´ÙØğ0x%x\n", 
v¬
->
´Ùo
);

304 
	`UNPACK_U16
(
buf
, 
v¬
->
šdex
);

306  
buf
;

308 
	}
}

310 
šlše
 *

311 
	$äc_ruË_¡©_uÅack
(*
buf
, 
äc_ruË_¡©_t
 *
v¬
)

313 
buf
 = 
	`äc_ruË_uÅack
(buf, &
v¬
->
ruË
);

314 #ià
__FRC_BYTE_ORDER
 =ğ
__FRC_LITTLE_ENDIAN


315 
	`UNPACK_U32
(
buf
, 
v¬
->
¡©
.
by‹s
);

316 
	`UNPACK_U32
(
buf
, 
v¬
->
¡©
.
pkts
);

318 
	`UNPACK_U32
(
buf
, 
v¬
->
¡©
.
pkts
);

319 
	`UNPACK_U32
(
buf
, 
v¬
->
¡©
.
by‹s
);

321  
buf
;

322 
	}
}

324 #ià
FRC_CONFIG_TWO_TUPLE


325 
šlše
 *

326 
	$äc_aş_uÅack
(*
buf
, 
äc_aş_t
 *
v¬
)

328 #ià
__FRC_BYTE_ORDER
 =ğ
__FRC_LITTLE_ENDIAN


333 
	`UNPACK_U16
(
buf
, 
v¬
->
İ
);

334 
	`UNPACK_U16
(
buf
, 
v¬
->
aùiÚ
);

335 
	`UNPACK_U16
(
buf
, 
v¬
->
aş_ty³
);

336 
	`UNPACK_U16
(
buf
, 
v¬
->
aş_sourû
);

339 
	`UNPACK_U16
(
buf
, 
v¬
->
šdex
);

340 
	`UNPACK_U16
(
buf
, 
v¬
->
´Ùo
);

341 
	`UNPACK_U32
(
buf
, 
v¬
->
Úe_tu¶e
);

342 
	`UNPACK_U32
(
buf
, 
v¬
->
»£rved
);

343 
	`UNPACK_U32
(
buf
, 
v¬
->
hash
);

352 
	`UNPACK_U16
(
buf
, 
v¬
->
aş_sourû
);

353 
	`UNPACK_U16
(
buf
, 
v¬
->
aş_ty³
);

354 
	`UNPACK_U16
(
buf
, 
v¬
->
aùiÚ
);

355 
	`UNPACK_U16
(
buf
, 
v¬
->
İ
);

356 
	`UNPACK_U32
(
buf
, 
v¬
->
Úe_tu¶e
);

357 
	`UNPACK_U16
(
buf
, 
v¬
->
´Ùo
);

358 
	`UNPACK_U16
(
buf
, 
v¬
->
šdex
);

359 
	`UNPACK_U32
(
buf
, 
v¬
->
hash
);

360 
	`UNPACK_U32
(
buf
, 
v¬
->
»£rved
);

362  
buf
;

364 
	}
}

366 
šlše
 *

367 
	$äc_aş_¡©_uÅack
(*
buf
, 
äc_aş_¡©_t
 *
v¬
)

369 
buf
 = 
	`äc_aş_uÅack
(buf, &
v¬
->
aş
);

370 #ià
__FRC_BYTE_ORDER
 =ğ
__FRC_LITTLE_ENDIAN


371 
	`UNPACK_U32
(
buf
, 
v¬
->
¡©
.
by‹s
);

372 
	`UNPACK_U32
(
buf
, 
v¬
->
¡©
.
pkts
);

374 
	`UNPACK_U32
(
buf
, 
v¬
->
¡©
.
pkts
);

375 
	`UNPACK_U32
(
buf
, 
v¬
->
¡©
.
by‹s
);

377  
buf
;

378 
	}
}

	@include/frc_types.h

1 #iâdeà
__FRC_TYPES_H__


2 
	#__FRC_TYPES_H__


	)

4 
	~"äc_cÚfig.h
"

6 #ià 
defšed
(
MAKE_KERNEL
)

7 
	~<lšux/ty³s.h
>

8 #–ià
defšed
(
MAKE_APP
è|| defšed(
MAKE_CORE
)

9 
	~<¡dšt.h
>

13 
	#K
 (1024)

	)

14 
	#M
 (1024 * 1024)

	)

15 
	#G
 (1024 * 1024 * 1024)

	)

18 
	#FRC_CORE_MAX
 12

	)

19 
	#FRC_DAT_CORE_NUM
 10

	)

20 
	#FRC_DAT_CORE_MAX
 
FRC_DAT_CORE_NUM


	)

21 
	#FRC_PKT_CORE_MAX
 11

	)

22 
	#FRC_CMD_CORE_MAX
 12

	)

24 
	#FRC_CMD_GRP
 12

	)

25 
	#FRC_PKT_GRP
 11

	)

26 
	#FRC_DAT_GRP
 0

	)

27 
	#GROUP_FROM_INPUT_PORT
 0

	)

28 
	#GROUP_TO_DATA_PLANE_AGING
 13

	)

31 
	#MAX_HASH_SESSION
 4

	)

32 
	#RULE_MAX
 2000

	)

33 
	#MAX_RULE
 4

	)

35 #ià
FRC_CONFIG_TWO_TUPLE


36 
	#ACL_MAX
 2000

	)

37 
	#ACL_HASH_MAX
 2048

	)

38 
	#ACL_INDEX_START
 1

	)

39 
	#MAX_ACL
 4

	)

42 #ià
FRC_CONFIG_VLAN_CHECK


43 
	#VLAN_CHECK_START_ID_MIN
 2

	)

44 
	#VLAN_CHECK_START_ID_MAX
 4095

	)

45 
	#VLAN_CHECK_ID_MAX
 4096

	)

52 
	#PROTO_TCP
 0x06

	)

53 
	#PROTO_UDP
 0x11

	)

54 
	#PROTO_ICMP
 0x1

	)

55 
	#PROTO_SCTP
 0x2

	)

56 
	#PROTO_VLAN
 0x8100

	)

57 
	#PROTO_IPV4
 0x0800

	)

58 
	#PROTO_IPV6
 0x86DD

	)

61 #ià
FRC_CONFIG_VLAN_CHECK
 | 
FRC_CONFIG_TIMESTAMP_CHECK


62 
	#FRCORE_IPV4
 0x04

	)

63 
	#FRCORE_IPV6
 0x06

	)

71 
	mFRE_SUCCESS
,

72 
	mFRE_FAIL
,

73 
	mFRE_INIT
,

74 
	mFRE_MEMORY
,

75 
	mFRE_UNSUPPORT
,

76 
	mFRE_UNREGISTER
,

77 
	mFRE_EXIST
,

78 
	mFRE_DMA
,

79 
	mFRE_NOSPACE
,

80 
	mFRE_IOCTL
,

81 
	mFRE_OPEN
 = 10,

82 
	mFRE_BUSY
,

83 
	mFRE_PARAM
,

84 
	mFRE_TIMEOUT
,

85 
	mFRE_EXCEED
,

86 
	mFRE_NOTFOUND
,

87 
	mFRE_DEBUG
,

88 
	mFRE_DIRECTION_FAIL
,

89 
	mFRE_MAX


90 } 
	täe_t
;

94 
	#STAT_START_INDEX
 76

	)

95 
	#STAT_END_INDEX
 125

	)

96 
	#STAT_INTERVAL
 (
STAT_END_INDEX
 - 
STAT_START_INDEX
)

	)

101 
	säc_v”siÚ
 {

102 
ušt8_t
 
	mmajÜ
;

103 
ušt8_t
 
	mmšÜ
;

104 
ušt16_t
 
	mbud
;

105 } 
	täc_v”siÚ_t
;

108 
ušt64_t
 
	mcÜe_num
;

109 
ušt64_t
 
	mcÜe_mask
;

110 
ušt64_t
 
	md©a_cÜe_num
;

111 
ušt64_t
 
	mcÜe_äeq
;

113 
ušt64_t
 
	mmem_size
;

114 
ušt64_t
 
	mmem_äeq
;

116 
ušt64_t
 
	mpcb_v”siÚ
;

117 
ušt64_t
 
	mboÙ_ty³
;

119 
ušt64_t
 
	mpc›_v”siÚ
;

120 
ušt64_t
 
	mpc›_ÏÃ
;

122 
ušt64_t
 
	mıld_v”siÚ
;

123 
ušt64_t
 
	mpÜt_num
;

124 
ušt64_t
 
	mpÜt_¥“d
;

125 
ušt64_t
 
	mboÙ_cyşe
;

126 } 
	täc_sy¡em_šfo_t
;

130 } 
	gäc_sy¡em_cÚfig_t
;

133 
	m¡©_p0_rx_pkts
 ,

134 
	m¡©_p0_tx_pkts
 ,

135 
	m¡©_p0_rx_”rs
 ,

136 
	m¡©_p0_rx_drİ³d
 ,

137 
	m¡©_p1_rx_pkts
 ,

138 
	m¡©_p1_tx_pkts
 ,

139 
	m¡©_p1_rx_”rs
 ,

140 
	m¡©_p1_rx_drİ³d
 ,

141 
	m¡©_p1_rx_pko
 ,

142 
	m¡©_p0_PARTIAL_ERR
 ,

143 
	m¡©_p0_JABBER_ERR
 ,

144 
	m¡©_p0_OVER_FCS_ERR
 ,

145 
	m¡©_p0_OVER_ERR
 ,

146 
	m¡©_p0_ALIGN_ERR
 ,

147 
	m¡©_p0_UNDER_FCS_ERR
 ,

148 
	m¡©_p0_GMX_FCS_ERR
 ,

149 
	m¡©_p0_UNDER_ERR
 ,

150 
	m¡©_p0_EXTEND_ERR
 ,

151 
	m¡©_p0_LENGTH_ERR
 ,

152 
	m¡©_p0_DAT_ERR
 ,

153 
	m¡©_p0_SKIP_ERR
 ,

154 
	m¡©_p0_NIBBLE_ERR
 ,

155 
	m¡©_p0_PIP_FCS
 ,

156 
	m¡©_p0_PIP_SKIP_ERR
 ,

157 
	m¡©_p0_PIP_L2_MAL_HDR
 ,

158 
	m¡©_p0_PUNY_ERR
 ,

159 
	m¡©_p0_UNKNOWN_ERR
 ,

161 
	m¡©_p1_PARTIAL_ERR
 ,

162 
	m¡©_p1_JABBER_ERR
 ,

163 
	m¡©_p1_OVER_FCS_ERR
 ,

164 
	m¡©_p1_OVER_ERR
 ,

165 
	m¡©_p1_ALIGN_ERR
 ,

166 
	m¡©_p1_UNDER_FCS_ERR
 ,

167 
	m¡©_p1_GMX_FCS_ERR
 ,

168 
	m¡©_p1_UNDER_ERR
 ,

169 
	m¡©_p1_EXTEND_ERR
 ,

170 
	m¡©_p1_LENGTH_ERR
 ,

171 
	m¡©_p1_DAT_ERR
 ,

172 
	m¡©_p1_SKIP_ERR
 ,

173 
	m¡©_p1_NIBBLE_ERR
 ,

174 
	m¡©_p1_PIP_FCS
 ,

175 
	m¡©_p1_PIP_SKIP_ERR
 ,

176 
	m¡©_p1_PIP_L2_MAL_HDR
 ,

177 
	m¡©_p1_PUNY_ERR
 ,

178 
	m¡©_p1_UNKNOWN_ERR
 ,

180 
	m¡©_cÜe0_wqe
 ,

181 
	m¡©_cÜe1_wqe
 ,

182 
	m¡©_cÜe2_wqe
 ,

183 
	m¡©_cÜe3_wqe
 ,

184 
	m¡©_cÜe4_wqe
 ,

185 
	m¡©_cÜe5_wqe
 ,

186 
	m¡©_cÜe6_wqe
 ,

187 
	m¡©_cÜe7_wqe
 ,

188 
	m¡©_cÜe8_wqe
 ,

189 
	m¡©_cÜe9_wqe
 ,

190 
	m¡©_cÜe10_wqe
 ,

191 
	m¡©_cÜe11_wqe
 ,

192 
	m¡©_wÜk_ä“
 ,

193 
	m¡©_wÜk_d©a
 ,

194 
	m¡©_wÜk_¡©
 ,

195 
	m¡©_wÜk_queue
 ,

196 
	m¡©_wÜk_pkt
 ,

197 
	m¡©_wÜk_cmd
 ,

198 
	m¡©_wÜk_š¡r
 ,

199 
	m¡©_wÜk_unkown
 ,

200 
	m¡©_chª_tim”
 ,

201 
	m¡©_aù_debug
,

202 
	m¡©_aù_drİ
 ,

203 
	m¡©_aù_ä“
 ,

204 
	m¡©_aù_fÜw¬d
 ,

205 
	m¡©_aù_d–ay
 ,

206 
	m¡©_aù_unä“
 ,

207 
	m¡©_aù_unkown
 ,

208 
	m¡©_pkts_b–ow_64
,

209 
	m¡©_pkts_b‘w“n_64_128
,

210 
	m¡©_pkts_b‘w“n_128_256
,

211 
	m¡©_pkts_b‘w“n_256_512
,

212 
	m¡©_pkts_b‘w“n_512_1024
,

213 
	m¡©_pkts_b‘w“n_1024_1500
,

214 
	m¡©_pkts_b‘w“n_1500_1600
,

215 
	m¡©_pkts_above_1600
,

216 
	m¡©_v”y_shÜt_pkts
,

217 
	m¡©_v”y_lÚg_pkts
,

218 
	m¡©_nÜm®_pkts
,

219 
	m¡©_tx_pkts
 ,

220 
	m¡©_tx_by‹s
 ,

221 
	m¡©_tx_”rs
 ,

222 
	m¡©_rx_wÜk
 ,

223 
	m¡©_rx_”rs
 ,

224 
	m¡©_rx_pkts
 ,

225 
	m¡©_rx_by‹s
 ,

226 
	m¡©_drİ_pÜt_off
 ,

227 
	m¡©_drİ_rx_”rÜ
 ,

228 
	m¡©_nÙ_
 ,

229 
	m¡©_m¶s
 ,

230 
	m¡©_µpÛ
 ,

231 
	m¡©_drİ_nÙ_
 ,

232 
	m¡©_
 ,

233 
	m¡©__v6
 ,

234 
	m¡©_drİ__v6
 ,

235 
	m¡©__v4
 ,

236 
	m¡©_vÏn
 ,

237 
	m¡©_drİ_vÏn
 ,

238 
	m¡©__äag
 ,

239 
	m¡©_drİ__äag
 ,

240 
	m¡©__nÙ_tı_udp
 ,

241 
	m¡©_drİ__nÙ_tı_udp
 ,

242 
	m¡©__İtiÚ
 ,

243 
	m¡©_drİ__İtiÚ
 ,

244 
	m¡©__Ùh”
 ,

245 
	m¡©_drİ__Ùh”
 ,

246 
	m¡©_tı
 ,

247 
	m¡©_tı_m®fÜmed_·ck‘
 ,

248 
	m¡©_tı_İtiÚ
 ,

249 
	m¡©_tı_·ylßd_z”o
 ,

250 
	m¡©_s¢_´•¬e
 ,

251 
	m¡©_s¢_ç
 ,

252 
	m¡©_s¢_ç_fš_Ü_r¡
 ,

253 
	m¡©_s¢_ç_ov”æow
 ,

254 
	m¡©_s¢_åa_®loc_”r
 ,

255 
	m¡©_s¢_åa_çed
 ,

256 
	m¡©_s¢_aùive_num
 ,

257 
	m¡©_s¢_fwd_tıæow»c
 ,

258 
	m¡©_s¢_drİ
 ,

259 
	m¡©_tıæow»c_»Œªs
 ,

260 
	m¡©_tıæow»c_»Œªs_drİ
 ,

261 
	m¡©_tıæow»c_·¹_»Œªs
 ,

262 
	m¡©_tıæow»c_dup_»move
 ,

263 
	m¡©_tıæow»c_queue_ov”æow
,

264 
	m¡©_tıæow»c_mem_çed
 ,

265 
	m¡©_s¢_age_wqe
,

266 
	m¡©_s¢_tim_addok
 ,

267 
	m¡©_s¢_tim_fœed
 ,

268 
	m¡©_s¢_tim_çed
 ,

269 
	m¡©_s¢_´•¬ed_by_åa_®loc
,

270 
	m¡©_s¢_purge_to_åa
 ,

271 
	m¡©_s¢_purge_unknown
 ,

272 
	m¡©_s¢_åa_ä“_”r
 ,

273 
	m¡©_s¢_purge
 ,

274 
	m¡©_s¢_dma_”rÜs
 ,

275 
	m¡©_s¢_dma_pkts
 ,

276 
	m¡©_s¢_dma_by‹s
 ,

277 
	m¡©_s¢_dma_pkt_šfos
 ,

278 
	m¡©_s¢_dma_blocks
 ,

279 
	m¡©_s¢_1·ck‘_blocks
 ,

280 
	m¡©_s¢_2·ck‘s_blocks
 ,

281 
	m¡©_s¢_3·ck‘s_blocks
 ,

282 
	m¡©_s¢_4·ck‘s_blocks
 ,

283 
	m¡©_s¢_5·ck‘s_blocks
 ,

284 
	m¡©_s¢_above_5·ck‘s_blocks
,

285 
	m¡©_s¢_queue_no_¥aû
 ,

286 
	m¡©_s¢_dma_’queue_pkts
 ,

287 
	m¡©_s¢_dma_’queue_”rs
 ,

288 
	m¡©_s¢_dma_h—d_ç
 ,

289 
	m¡©_s¢_ava_g‘
 ,

290 
	m¡©_s¢_ava_g‘_”r
 ,

291 
	m¡©_s¢_ava_g‘_no_¥aû
 ,

292 
	m¡©_s¢_com¶_put
 ,

293 
	m¡©_s¢_com¶_put_”r
 ,

294 
	m¡©_s¢_com¶_put_no_¥aû
 ,

295 
	m¡©_s¢_pkt_po¡
 ,

296 
	m¡©_s¢_pkt_po¡_”r
 ,

297 
	m¡©_s¢_po¡_”r_pkts
 ,

298 
	m¡©_udp
 ,

299 
	m¡©_udp_m®fÜmed_·ck‘
 ,

300 
	m¡©_udp_subm™_pkts
,

301 
	m¡©_udp_subm™_by‹s
,

302 
	m¡©_ruË_m®fÜmed_·ck‘
 ,

303 
	m¡©_ruË_m©ched_pkts
,

304 
	m¡©_ruË_m©ched_by‹s
,

305 
	m¡©_ruË_nÙ_m©ched_pkts
,

306 
	m¡©_ruË_nÙ_m©ched_by‹s
,

307 
	m¡©_pkt_ov”size
 ,

308 
	m¡©_dma_”rÜs
 ,

309 
	m¡©_dma_pkts
 ,

310 
	m¡©_dma_pkt_šfos
 ,

311 
	m¡©_dma_by‹s
 ,

312 
	m¡©_dma_blocks
 ,

313 
	m¡©_ava_g‘
 ,

314 
	m¡©_ava_g‘_”r
 ,

315 
	m¡©_ava_g‘_no_¥aû
 ,

316 
	m¡©_com¶_put
 ,

317 
	m¡©_com¶_put_”r
 ,

318 
	m¡©_com¶_put_no_¥aû
 ,

319 
	m¡©_pkt_po¡
 ,

320 
	m¡©_pkt_po¡_”r
 ,

321 
	m¡©_po¡_”r_pkts
 ,

322 
	m¡©_queue_po¡
 ,

323 
	m¡©_queue_po¡_”r
 ,

324 
	m¡©_dma_loİ_by‹s
 ,

325 
	m¡©_dma_loİ_’Œ›s
 ,

326 
	m¡©_dma_loİ_”rs
 ,

327 
	m¡©_dma_block_addr_”rs
 ,

328 
	m¡©_dma_’queue_pkts
 ,

329 
	m¡©_dma_’queue_”rs
 ,

330 
	m¡©_g‘_ava_by‹s
 ,

331 
	m¡©_put_com¶_by‹s
 ,

332 
	m¡©_queue_no_¥aû
 ,

333 #ià
FRC_CONFIG_TWO_TUPLE


334 
	m¡©_aş_m®fÜmed_·ck‘
 ,

335 
	m¡©_aş_ty³_”rÜ
 ,

336 
	m¡©_aş_hash_”rÜ
 ,

337 
	m¡©_aş_’Œy_exû±iÚ
 ,

338 
	m¡©_aş_nÙ_found_šdex
 ,

339 
	m¡©_aş_d–_hash_ûÎ
 ,

340 
	m¡©_aş_d–_ruË_num
 ,

341 
	m¡©_aş_add_hash_ûÎ
 ,

342 
	m¡©_aş_add_ruË_num
 ,

343 
	m¡©_aş_hash_ûÎ_®loc_ç
,

344 
	m¡©_aş_m©ched_pkts
,

345 
	m¡©_aş_m©ched_by‹s
,

346 
	m¡©_aş_nÙ_m©ched_pkts
,

347 
	m¡©_aş_nÙ_m©ched_by‹s
,

349 
	m¡©_s¢_fifo_lock
,

350 
	m¡©_s¢_fifo_uÆock
,

351 #ifdeà
FRC_CONFIG_MAC_STATISTICS


352 
	m¡©_sw­_mac_£nd_pkts
,

353 
	m¡©_h—¹_b—t_pkt
,

354 
	m¡©_h—¹_b—t_£nd_back_pkt
,

355 
	m¡©_h—¹_b—t_Ú_drİ_pkt
,

356 
	m¡©_h—¹_b—t_drİ_pkt
,

358 #ifdeà
FRC_CONFIG_IPC


359 
	m¡©_c_drİ_smac_z”o
,

360 
	m¡©_c_smac_Üd”ed
,

361 
	m¡©_c_smac_disÜd”
,

362 
	m¡©_c_pktid_Üd”ed
,

363 
	m¡©_c_pktid_disÜd”
,

364 
	m¡©_c_pktid_»³©
,

365 
	m¡©_c_h—d_v®id
,

366 
	m¡©_c_h—d_šv®id
,

367 
	m¡©_c_šÃr_vÏn
,

369 
	m¡©_max


370 } 
	täc_¡©_e
;

372 #ià
FRC_CONFIG_VLAN_CHECK


374 
	mxe0_¡©_rxx_pkts
 ,

375 
	mxe0_¡©_rxx_by‹s
 ,

376 
	mxe0_¡©_vÏn_id_tÙ®
 ,

377 
	mxe0_¡©_vÏn_id_”rÜ
 ,

378 
	mxe0_¡©_vÏn_id_0
 ,

379 
	mxe0_¡©_vÏn_id_1
 ,

380 
	mxe0_¡©_vÏn_id_2
 ,

381 
	mxe0_¡©_vÏn_id_3
 ,

382 
	mxe0_¡©_vÏn_id_4
 ,

383 
	mxe0_¡©_vÏn_id_5
 ,

384 
	mxe0_¡©_vÏn_id_6
 ,

385 
	mxe0_¡©_vÏn_id_7
 ,

386 
	mxe0_¡©_vÏn_id_8
 ,

387 
	mxe0_¡©_vÏn_id_9
 ,

388 
	mxe0_¡©_vÏn_id_10
 ,

389 
	mxe0_¡©_vÏn_id_11
 ,

390 
	mxe0_¡©_vÏn_id_12
 ,

391 
	mxe0_¡©_vÏn_id_13
 ,

392 
	mxe0_¡©_vÏn_id_14
 ,

393 
	mxe0_¡©_vÏn_id_15
 ,

394 
	mxe0_¡©_vÏn_id_16
 ,

395 
	mxe0_¡©_vÏn_id_17
 ,

396 
	mxe0_¡©_vÏn_id_18
 ,

397 
	mxe0_¡©_vÏn_id_19
 ,

398 
	mxe0_¡©_vÏn_id_20
 ,

399 
	mxe0_¡©_vÏn_id_21
 ,

400 
	mxe0_¡©_vÏn_id_22
 ,

401 
	mxe0_¡©_vÏn_id_23
 ,

402 
	mxe0_¡©_vÏn_id_24
 ,

403 
	mxe0_¡©_vÏn_id_25
 ,

404 
	mxe0_¡©_vÏn_id_26
 ,

405 
	mxe0_¡©_vÏn_id_27
 ,

406 
	mxe0_¡©_vÏn_id_28
 ,

407 
	mxe0_¡©_vÏn_id_29
 ,

408 
	mxe0_¡©_vÏn_id_30
 ,

409 
	mxe0_¡©_vÏn_id_31
 ,

410 
	mxe0_¡©_vÏn_id_32
 ,

411 
	mxe0_¡©_vÏn_id_33
 ,

412 
	mxe0_¡©_vÏn_id_34
 ,

413 
	mxe0_¡©_vÏn_id_35
 ,

414 
	mxe0_¡©_vÏn_id_36
 ,

415 
	mxe0_¡©_vÏn_id_37
 ,

416 
	mxe0_¡©_vÏn_id_38
 ,

417 
	mxe0_¡©_vÏn_id_39
 ,

418 
	mxe0_¡©_vÏn_id_40
 ,

419 
	mxe0_¡©_vÏn_id_41
 ,

420 
	mxe0_¡©_vÏn_id_42
 ,

421 
	mxe0_¡©_vÏn_id_43
 ,

422 
	mxe0_¡©_vÏn_id_44
 ,

423 
	mxe0_¡©_vÏn_id_45
 ,

424 
	mxe0_¡©_vÏn_id_46
 ,

425 
	mxe0_¡©_vÏn_id_47
 ,

426 
	mxe0_¡©_vÏn_id_48
 ,

427 
	mxe0_¡©_vÏn_id_49
 ,

428 
	mxe0_¡©_vÏn_id_50
 ,

429 
	mxe0_¡©_vÏn_id_51
 ,

430 
	mxe0_¡©_vÏn_id_52
 ,

431 
	mxe0_¡©_vÏn_id_53
 ,

432 
	mxe0_¡©_vÏn_id_54
 ,

433 
	mxe0_¡©_vÏn_id_55
 ,

434 
	mxe0_¡©_vÏn_id_56
 ,

435 
	mxe0_¡©_vÏn_id_57
 ,

436 
	mxe0_¡©_vÏn_id_58
 ,

437 
	mxe0_¡©_vÏn_id_59
 ,

438 
	mxe0_¡©_vÏn_id_60
 ,

439 
	mxe0_¡©_vÏn_id_61
 ,

440 
	mxe0_¡©_vÏn_id_62
 ,

441 
	mxe0_¡©_vÏn_id_63
 ,

442 
	mxe0_¡©_vÏn_id_64
 ,

443 
	mxe0_¡©_vÏn_id_65
 ,

444 
	mxe0_¡©_vÏn_id_66
 ,

445 
	mxe0_¡©_vÏn_id_67
 ,

446 
	mxe0_¡©_vÏn_id_68
 ,

447 
	mxe0_¡©_vÏn_id_69
 ,

448 
	mxe0_¡©_vÏn_id_70
 ,

449 
	mxe0_¡©_vÏn_id_71
 ,

450 
	mxe0_¡©_vÏn_id_72
 ,

451 
	mxe0_¡©_vÏn_id_73
 ,

452 
	mxe0_¡©_vÏn_id_74
 ,

453 
	mxe0_¡©_vÏn_id_75
 ,

454 
	mxe0_¡©_vÏn_id_76
 ,

455 
	mxe0_¡©_vÏn_id_77
 ,

456 
	mxe0_¡©_vÏn_id_78
 ,

457 
	mxe0_¡©_vÏn_id_79
 ,

458 
	mxe0_¡©_vÏn_id_80
 ,

459 
	mxe0_¡©_vÏn_id_81
 ,

460 
	mxe0_¡©_vÏn_id_82
 ,

461 
	mxe0_¡©_vÏn_id_83
 ,

462 
	mxe0_¡©_vÏn_id_84
 ,

463 
	mxe0_¡©_vÏn_id_85
 ,

464 
	mxe0_¡©_vÏn_id_86
 ,

465 
	mxe0_¡©_vÏn_id_87
 ,

466 
	mxe0_¡©_vÏn_id_88
 ,

467 
	mxe0_¡©_vÏn_id_89
 ,

468 
	mxe0_¡©_vÏn_id_90
 ,

469 
	mxe0_¡©_vÏn_id_91
 ,

470 
	mxe0_¡©_vÏn_id_92
 ,

471 
	mxe0_¡©_vÏn_id_93
 ,

472 
	mxe0_¡©_vÏn_id_94
 ,

473 
	mxe0_¡©_vÏn_id_95
 ,

474 
	mxe0_¡©_vÏn_id_96
 ,

475 
	mxe0_¡©_vÏn_id_97
 ,

476 
	mxe0_¡©_vÏn_id_98
 ,

477 
	mxe0_¡©_vÏn_id_99
 ,

478 
	mxe0_¡©_vÏn_id_100
 ,

479 
	mxe0_¡©_vÏn_id_101
 ,

480 
	mxe0_¡©_vÏn_id_102
 ,

481 
	mxe0_¡©_vÏn_id_103
 ,

482 
	mxe0_¡©_vÏn_id_104
 ,

483 
	mxe0_¡©_vÏn_id_105
 ,

484 
	mxe0_¡©_vÏn_id_106
 ,

485 
	mxe0_¡©_vÏn_id_107
 ,

486 
	mxe0_¡©_vÏn_id_108
 ,

487 
	mxe0_¡©_vÏn_id_109
 ,

488 
	mxe0_¡©_vÏn_id_110
 ,

489 
	mxe0_¡©_vÏn_id_111
 ,

490 
	mxe0_¡©_vÏn_id_112
 ,

491 
	mxe0_¡©_vÏn_id_113
 ,

492 
	mxe0_¡©_vÏn_id_114
 ,

493 
	mxe0_¡©_vÏn_id_115
 ,

494 
	mxe0_¡©_vÏn_id_116
 ,

495 
	mxe0_¡©_vÏn_id_117
 ,

496 
	mxe0_¡©_vÏn_id_118
 ,

497 
	mxe0_¡©_vÏn_id_119
 ,

498 
	mxe0_¡©_vÏn_id_120
 ,

499 
	mxe0_¡©_vÏn_id_121
 ,

500 
	mxe0_¡©_vÏn_id_122
 ,

501 
	mxe0_¡©_vÏn_id_123
 ,

502 
	mxe0_¡©_vÏn_id_124
 ,

503 
	mxe0_¡©_vÏn_id_125
 ,

504 
	mxe0_¡©_vÏn_id_126
 ,

505 
	mxe0_¡©_vÏn_id_127
 ,

506 
	mxe0_¡©_vÏn_id_128
 ,

507 
	mxe0_¡©_vÏn_id_129
 ,

508 
	mxe0_¡©_vÏn_id_130
 ,

509 
	mxe0_¡©_vÏn_id_131
 ,

510 
	mxe0_¡©_vÏn_id_132
 ,

511 
	mxe0_¡©_vÏn_id_133
 ,

512 
	mxe0_¡©_vÏn_id_134
 ,

513 
	mxe0_¡©_vÏn_id_135
 ,

514 
	mxe0_¡©_vÏn_id_136
 ,

515 
	mxe0_¡©_vÏn_id_137
 ,

516 
	mxe0_¡©_vÏn_id_138
 ,

517 
	mxe0_¡©_vÏn_id_139
 ,

518 
	mxe0_¡©_vÏn_id_140
 ,

519 
	mxe0_¡©_vÏn_id_141
 ,

520 
	mxe0_¡©_vÏn_id_142
 ,

521 
	mxe0_¡©_vÏn_id_143
 ,

522 
	mxe0_¡©_vÏn_id_144
 ,

523 
	mxe0_¡©_vÏn_id_145
 ,

524 
	mxe0_¡©_vÏn_id_146
 ,

525 
	mxe0_¡©_vÏn_id_147
 ,

526 
	mxe0_¡©_vÏn_id_148
 ,

527 
	mxe0_¡©_vÏn_id_149
 ,

528 
	mxe0_¡©_vÏn_id_150
 ,

529 
	mxe0_¡©_vÏn_id_151
 ,

530 
	mxe0_¡©_vÏn_id_152
 ,

531 
	mxe0_¡©_vÏn_id_153
 ,

532 
	mxe0_¡©_vÏn_id_154
 ,

533 
	mxe0_¡©_vÏn_id_155
 ,

534 
	mxe0_¡©_vÏn_id_156
 ,

535 
	mxe0_¡©_vÏn_id_157
 ,

536 
	mxe0_¡©_vÏn_id_158
 ,

537 
	mxe0_¡©_vÏn_id_159
 ,

538 
	mxe0_¡©_vÏn_id_160
 ,

539 
	mxe0_¡©_vÏn_id_161
 ,

540 
	mxe0_¡©_vÏn_id_162
 ,

541 
	mxe0_¡©_vÏn_id_163
 ,

542 
	mxe0_¡©_vÏn_id_164
 ,

543 
	mxe0_¡©_vÏn_id_165
 ,

544 
	mxe0_¡©_vÏn_id_166
 ,

545 
	mxe0_¡©_vÏn_id_167
 ,

546 
	mxe0_¡©_vÏn_id_168
 ,

547 
	mxe0_¡©_vÏn_id_169
 ,

548 
	mxe0_¡©_vÏn_id_170
 ,

549 
	mxe0_¡©_vÏn_id_171
 ,

550 
	mxe0_¡©_vÏn_id_172
 ,

551 
	mxe0_¡©_vÏn_id_173
 ,

552 
	mxe0_¡©_vÏn_id_174
 ,

553 
	mxe0_¡©_vÏn_id_175
 ,

554 
	mxe0_¡©_vÏn_id_176
 ,

555 
	mxe0_¡©_vÏn_id_177
 ,

556 
	mxe0_¡©_vÏn_id_178
 ,

557 
	mxe0_¡©_vÏn_id_179
 ,

558 
	mxe0_¡©_vÏn_id_180
 ,

559 
	mxe0_¡©_vÏn_id_181
 ,

560 
	mxe0_¡©_vÏn_id_182
 ,

561 
	mxe0_¡©_vÏn_id_183
 ,

562 
	mxe0_¡©_vÏn_id_184
 ,

563 
	mxe0_¡©_vÏn_id_185
 ,

564 
	mxe0_¡©_vÏn_id_186
 ,

565 
	mxe0_¡©_vÏn_id_187
 ,

566 
	mxe0_¡©_vÏn_id_188
 ,

567 
	mxe0_¡©_vÏn_id_189
 ,

568 
	mxe0_¡©_vÏn_id_190
 ,

569 
	mxe0_¡©_vÏn_id_191
 ,

570 
	mxe0_¡©_vÏn_id_192
 ,

571 
	mxe0_¡©_vÏn_id_193
 ,

572 
	mxe0_¡©_vÏn_id_194
 ,

573 
	mxe0_¡©_vÏn_id_195
 ,

574 
	mxe0_¡©_vÏn_id_196
 ,

575 
	mxe0_¡©_vÏn_id_197
 ,

576 
	mxe0_¡©_vÏn_id_198
 ,

577 
	mxe0_¡©_vÏn_id_199
 ,

578 
	mxe0_¡©_vÏn_id_200
 ,

579 
	mxe0_¡©_vÏn_id_201
 ,

580 
	mxe0_¡©_vÏn_id_202
 ,

581 
	mxe0_¡©_vÏn_id_203
 ,

582 
	mxe0_¡©_vÏn_id_204
 ,

583 
	mxe0_¡©_vÏn_id_205
 ,

584 
	mxe0_¡©_vÏn_id_206
 ,

585 
	mxe0_¡©_vÏn_id_207
 ,

586 
	mxe0_¡©_vÏn_id_208
 ,

587 
	mxe0_¡©_vÏn_id_209
 ,

588 
	mxe0_¡©_vÏn_id_210
 ,

589 
	mxe0_¡©_vÏn_id_211
 ,

590 
	mxe0_¡©_vÏn_id_212
 ,

591 
	mxe0_¡©_vÏn_id_213
 ,

592 
	mxe0_¡©_vÏn_id_214
 ,

593 
	mxe0_¡©_vÏn_id_215
 ,

594 
	mxe0_¡©_vÏn_id_216
 ,

595 
	mxe0_¡©_vÏn_id_217
 ,

596 
	mxe0_¡©_vÏn_id_218
 ,

597 
	mxe0_¡©_vÏn_id_219
 ,

598 
	mxe0_¡©_vÏn_id_220
 ,

599 
	mxe0_¡©_vÏn_id_221
 ,

600 
	mxe0_¡©_vÏn_id_222
 ,

601 
	mxe0_¡©_vÏn_id_223
 ,

602 
	mxe0_¡©_vÏn_id_224
 ,

603 
	mxe0_¡©_vÏn_id_225
 ,

604 
	mxe0_¡©_vÏn_id_226
 ,

605 
	mxe0_¡©_vÏn_id_227
 ,

606 
	mxe0_¡©_vÏn_id_228
 ,

607 
	mxe0_¡©_vÏn_id_229
 ,

608 
	mxe0_¡©_vÏn_id_230
 ,

609 
	mxe0_¡©_vÏn_id_231
 ,

610 
	mxe0_¡©_vÏn_id_232
 ,

611 
	mxe0_¡©_vÏn_id_233
 ,

612 
	mxe0_¡©_vÏn_id_234
 ,

613 
	mxe0_¡©_vÏn_id_235
 ,

614 
	mxe0_¡©_vÏn_id_236
 ,

615 
	mxe0_¡©_vÏn_id_237
 ,

616 
	mxe0_¡©_vÏn_id_238
 ,

617 
	mxe0_¡©_vÏn_id_239
 ,

618 
	mxe0_¡©_vÏn_id_240
 ,

619 
	mxe0_¡©_vÏn_id_241
 ,

620 
	mxe0_¡©_vÏn_id_242
 ,

621 
	mxe0_¡©_vÏn_id_243
 ,

622 
	mxe0_¡©_vÏn_id_244
 ,

623 
	mxe0_¡©_vÏn_id_245
 ,

624 
	mxe0_¡©_vÏn_id_246
 ,

625 
	mxe0_¡©_vÏn_id_247
 ,

626 
	mxe0_¡©_vÏn_id_248
 ,

627 
	mxe0_¡©_vÏn_id_249
 ,

628 
	mxe0_¡©_vÏn_id_250
 ,

629 
	mxe0_¡©_vÏn_id_251
 ,

630 
	mxe0_¡©_vÏn_id_252
 ,

631 
	mxe0_¡©_vÏn_id_253
 ,

632 
	mxe0_¡©_vÏn_id_254
 ,

633 
	mxe0_¡©_vÏn_id_255
 ,

634 
	mxe1_¡©_rxx_pkts
 ,

635 
	mxe1_¡©_rxx_by‹s
 ,

636 
	mxe1_¡©_vÏn_id_tÙ®
 ,

637 
	mxe1_¡©_vÏn_id_”rÜ
 ,

638 
	mxe1_¡©_vÏn_id_0
 ,

639 
	mxe1_¡©_vÏn_id_1
 ,

640 
	mxe1_¡©_vÏn_id_2
 ,

641 
	mxe1_¡©_vÏn_id_3
 ,

642 
	mxe1_¡©_vÏn_id_4
 ,

643 
	mxe1_¡©_vÏn_id_5
 ,

644 
	mxe1_¡©_vÏn_id_6
 ,

645 
	mxe1_¡©_vÏn_id_7
 ,

646 
	mxe1_¡©_vÏn_id_8
 ,

647 
	mxe1_¡©_vÏn_id_9
 ,

648 
	mxe1_¡©_vÏn_id_10
 ,

649 
	mxe1_¡©_vÏn_id_11
 ,

650 
	mxe1_¡©_vÏn_id_12
 ,

651 
	mxe1_¡©_vÏn_id_13
 ,

652 
	mxe1_¡©_vÏn_id_14
 ,

653 
	mxe1_¡©_vÏn_id_15
 ,

654 
	mxe1_¡©_vÏn_id_16
 ,

655 
	mxe1_¡©_vÏn_id_17
 ,

656 
	mxe1_¡©_vÏn_id_18
 ,

657 
	mxe1_¡©_vÏn_id_19
 ,

658 
	mxe1_¡©_vÏn_id_20
 ,

659 
	mxe1_¡©_vÏn_id_21
 ,

660 
	mxe1_¡©_vÏn_id_22
 ,

661 
	mxe1_¡©_vÏn_id_23
 ,

662 
	mxe1_¡©_vÏn_id_24
 ,

663 
	mxe1_¡©_vÏn_id_25
 ,

664 
	mxe1_¡©_vÏn_id_26
 ,

665 
	mxe1_¡©_vÏn_id_27
 ,

666 
	mxe1_¡©_vÏn_id_28
 ,

667 
	mxe1_¡©_vÏn_id_29
 ,

668 
	mxe1_¡©_vÏn_id_30
 ,

669 
	mxe1_¡©_vÏn_id_31
 ,

670 
	mxe1_¡©_vÏn_id_32
 ,

671 
	mxe1_¡©_vÏn_id_33
 ,

672 
	mxe1_¡©_vÏn_id_34
 ,

673 
	mxe1_¡©_vÏn_id_35
 ,

674 
	mxe1_¡©_vÏn_id_36
 ,

675 
	mxe1_¡©_vÏn_id_37
 ,

676 
	mxe1_¡©_vÏn_id_38
 ,

677 
	mxe1_¡©_vÏn_id_39
 ,

678 
	mxe1_¡©_vÏn_id_40
 ,

679 
	mxe1_¡©_vÏn_id_41
 ,

680 
	mxe1_¡©_vÏn_id_42
 ,

681 
	mxe1_¡©_vÏn_id_43
 ,

682 
	mxe1_¡©_vÏn_id_44
 ,

683 
	mxe1_¡©_vÏn_id_45
 ,

684 
	mxe1_¡©_vÏn_id_46
 ,

685 
	mxe1_¡©_vÏn_id_47
 ,

686 
	mxe1_¡©_vÏn_id_48
 ,

687 
	mxe1_¡©_vÏn_id_49
 ,

688 
	mxe1_¡©_vÏn_id_50
 ,

689 
	mxe1_¡©_vÏn_id_51
 ,

690 
	mxe1_¡©_vÏn_id_52
 ,

691 
	mxe1_¡©_vÏn_id_53
 ,

692 
	mxe1_¡©_vÏn_id_54
 ,

693 
	mxe1_¡©_vÏn_id_55
 ,

694 
	mxe1_¡©_vÏn_id_56
 ,

695 
	mxe1_¡©_vÏn_id_57
 ,

696 
	mxe1_¡©_vÏn_id_58
 ,

697 
	mxe1_¡©_vÏn_id_59
 ,

698 
	mxe1_¡©_vÏn_id_60
 ,

699 
	mxe1_¡©_vÏn_id_61
 ,

700 
	mxe1_¡©_vÏn_id_62
 ,

701 
	mxe1_¡©_vÏn_id_63
 ,

702 
	mxe1_¡©_vÏn_id_64
 ,

703 
	mxe1_¡©_vÏn_id_65
 ,

704 
	mxe1_¡©_vÏn_id_66
 ,

705 
	mxe1_¡©_vÏn_id_67
 ,

706 
	mxe1_¡©_vÏn_id_68
 ,

707 
	mxe1_¡©_vÏn_id_69
 ,

708 
	mxe1_¡©_vÏn_id_70
 ,

709 
	mxe1_¡©_vÏn_id_71
 ,

710 
	mxe1_¡©_vÏn_id_72
 ,

711 
	mxe1_¡©_vÏn_id_73
 ,

712 
	mxe1_¡©_vÏn_id_74
 ,

713 
	mxe1_¡©_vÏn_id_75
 ,

714 
	mxe1_¡©_vÏn_id_76
 ,

715 
	mxe1_¡©_vÏn_id_77
 ,

716 
	mxe1_¡©_vÏn_id_78
 ,

717 
	mxe1_¡©_vÏn_id_79
 ,

718 
	mxe1_¡©_vÏn_id_80
 ,

719 
	mxe1_¡©_vÏn_id_81
 ,

720 
	mxe1_¡©_vÏn_id_82
 ,

721 
	mxe1_¡©_vÏn_id_83
 ,

722 
	mxe1_¡©_vÏn_id_84
 ,

723 
	mxe1_¡©_vÏn_id_85
 ,

724 
	mxe1_¡©_vÏn_id_86
 ,

725 
	mxe1_¡©_vÏn_id_87
 ,

726 
	mxe1_¡©_vÏn_id_88
 ,

727 
	mxe1_¡©_vÏn_id_89
 ,

728 
	mxe1_¡©_vÏn_id_90
 ,

729 
	mxe1_¡©_vÏn_id_91
 ,

730 
	mxe1_¡©_vÏn_id_92
 ,

731 
	mxe1_¡©_vÏn_id_93
 ,

732 
	mxe1_¡©_vÏn_id_94
 ,

733 
	mxe1_¡©_vÏn_id_95
 ,

734 
	mxe1_¡©_vÏn_id_96
 ,

735 
	mxe1_¡©_vÏn_id_97
 ,

736 
	mxe1_¡©_vÏn_id_98
 ,

737 
	mxe1_¡©_vÏn_id_99
 ,

738 
	mxe1_¡©_vÏn_id_100
 ,

739 
	mxe1_¡©_vÏn_id_101
 ,

740 
	mxe1_¡©_vÏn_id_102
 ,

741 
	mxe1_¡©_vÏn_id_103
 ,

742 
	mxe1_¡©_vÏn_id_104
 ,

743 
	mxe1_¡©_vÏn_id_105
 ,

744 
	mxe1_¡©_vÏn_id_106
 ,

745 
	mxe1_¡©_vÏn_id_107
 ,

746 
	mxe1_¡©_vÏn_id_108
 ,

747 
	mxe1_¡©_vÏn_id_109
 ,

748 
	mxe1_¡©_vÏn_id_110
 ,

749 
	mxe1_¡©_vÏn_id_111
 ,

750 
	mxe1_¡©_vÏn_id_112
 ,

751 
	mxe1_¡©_vÏn_id_113
 ,

752 
	mxe1_¡©_vÏn_id_114
 ,

753 
	mxe1_¡©_vÏn_id_115
 ,

754 
	mxe1_¡©_vÏn_id_116
 ,

755 
	mxe1_¡©_vÏn_id_117
 ,

756 
	mxe1_¡©_vÏn_id_118
 ,

757 
	mxe1_¡©_vÏn_id_119
 ,

758 
	mxe1_¡©_vÏn_id_120
 ,

759 
	mxe1_¡©_vÏn_id_121
 ,

760 
	mxe1_¡©_vÏn_id_122
 ,

761 
	mxe1_¡©_vÏn_id_123
 ,

762 
	mxe1_¡©_vÏn_id_124
 ,

763 
	mxe1_¡©_vÏn_id_125
 ,

764 
	mxe1_¡©_vÏn_id_126
 ,

765 
	mxe1_¡©_vÏn_id_127
 ,

766 
	mxe1_¡©_vÏn_id_128
 ,

767 
	mxe1_¡©_vÏn_id_129
 ,

768 
	mxe1_¡©_vÏn_id_130
 ,

769 
	mxe1_¡©_vÏn_id_131
 ,

770 
	mxe1_¡©_vÏn_id_132
 ,

771 
	mxe1_¡©_vÏn_id_133
 ,

772 
	mxe1_¡©_vÏn_id_134
 ,

773 
	mxe1_¡©_vÏn_id_135
 ,

774 
	mxe1_¡©_vÏn_id_136
 ,

775 
	mxe1_¡©_vÏn_id_137
 ,

776 
	mxe1_¡©_vÏn_id_138
 ,

777 
	mxe1_¡©_vÏn_id_139
 ,

778 
	mxe1_¡©_vÏn_id_140
 ,

779 
	mxe1_¡©_vÏn_id_141
 ,

780 
	mxe1_¡©_vÏn_id_142
 ,

781 
	mxe1_¡©_vÏn_id_143
 ,

782 
	mxe1_¡©_vÏn_id_144
 ,

783 
	mxe1_¡©_vÏn_id_145
 ,

784 
	mxe1_¡©_vÏn_id_146
 ,

785 
	mxe1_¡©_vÏn_id_147
 ,

786 
	mxe1_¡©_vÏn_id_148
 ,

787 
	mxe1_¡©_vÏn_id_149
 ,

788 
	mxe1_¡©_vÏn_id_150
 ,

789 
	mxe1_¡©_vÏn_id_151
 ,

790 
	mxe1_¡©_vÏn_id_152
 ,

791 
	mxe1_¡©_vÏn_id_153
 ,

792 
	mxe1_¡©_vÏn_id_154
 ,

793 
	mxe1_¡©_vÏn_id_155
 ,

794 
	mxe1_¡©_vÏn_id_156
 ,

795 
	mxe1_¡©_vÏn_id_157
 ,

796 
	mxe1_¡©_vÏn_id_158
 ,

797 
	mxe1_¡©_vÏn_id_159
 ,

798 
	mxe1_¡©_vÏn_id_160
 ,

799 
	mxe1_¡©_vÏn_id_161
 ,

800 
	mxe1_¡©_vÏn_id_162
 ,

801 
	mxe1_¡©_vÏn_id_163
 ,

802 
	mxe1_¡©_vÏn_id_164
 ,

803 
	mxe1_¡©_vÏn_id_165
 ,

804 
	mxe1_¡©_vÏn_id_166
 ,

805 
	mxe1_¡©_vÏn_id_167
 ,

806 
	mxe1_¡©_vÏn_id_168
 ,

807 
	mxe1_¡©_vÏn_id_169
 ,

808 
	mxe1_¡©_vÏn_id_170
 ,

809 
	mxe1_¡©_vÏn_id_171
 ,

810 
	mxe1_¡©_vÏn_id_172
 ,

811 
	mxe1_¡©_vÏn_id_173
 ,

812 
	mxe1_¡©_vÏn_id_174
 ,

813 
	mxe1_¡©_vÏn_id_175
 ,

814 
	mxe1_¡©_vÏn_id_176
 ,

815 
	mxe1_¡©_vÏn_id_177
 ,

816 
	mxe1_¡©_vÏn_id_178
 ,

817 
	mxe1_¡©_vÏn_id_179
 ,

818 
	mxe1_¡©_vÏn_id_180
 ,

819 
	mxe1_¡©_vÏn_id_181
 ,

820 
	mxe1_¡©_vÏn_id_182
 ,

821 
	mxe1_¡©_vÏn_id_183
 ,

822 
	mxe1_¡©_vÏn_id_184
 ,

823 
	mxe1_¡©_vÏn_id_185
 ,

824 
	mxe1_¡©_vÏn_id_186
 ,

825 
	mxe1_¡©_vÏn_id_187
 ,

826 
	mxe1_¡©_vÏn_id_188
 ,

827 
	mxe1_¡©_vÏn_id_189
 ,

828 
	mxe1_¡©_vÏn_id_190
 ,

829 
	mxe1_¡©_vÏn_id_191
 ,

830 
	mxe1_¡©_vÏn_id_192
 ,

831 
	mxe1_¡©_vÏn_id_193
 ,

832 
	mxe1_¡©_vÏn_id_194
 ,

833 
	mxe1_¡©_vÏn_id_195
 ,

834 
	mxe1_¡©_vÏn_id_196
 ,

835 
	mxe1_¡©_vÏn_id_197
 ,

836 
	mxe1_¡©_vÏn_id_198
 ,

837 
	mxe1_¡©_vÏn_id_199
 ,

838 
	mxe1_¡©_vÏn_id_200
 ,

839 
	mxe1_¡©_vÏn_id_201
 ,

840 
	mxe1_¡©_vÏn_id_202
 ,

841 
	mxe1_¡©_vÏn_id_203
 ,

842 
	mxe1_¡©_vÏn_id_204
 ,

843 
	mxe1_¡©_vÏn_id_205
 ,

844 
	mxe1_¡©_vÏn_id_206
 ,

845 
	mxe1_¡©_vÏn_id_207
 ,

846 
	mxe1_¡©_vÏn_id_208
 ,

847 
	mxe1_¡©_vÏn_id_209
 ,

848 
	mxe1_¡©_vÏn_id_210
 ,

849 
	mxe1_¡©_vÏn_id_211
 ,

850 
	mxe1_¡©_vÏn_id_212
 ,

851 
	mxe1_¡©_vÏn_id_213
 ,

852 
	mxe1_¡©_vÏn_id_214
 ,

853 
	mxe1_¡©_vÏn_id_215
 ,

854 
	mxe1_¡©_vÏn_id_216
 ,

855 
	mxe1_¡©_vÏn_id_217
 ,

856 
	mxe1_¡©_vÏn_id_218
 ,

857 
	mxe1_¡©_vÏn_id_219
 ,

858 
	mxe1_¡©_vÏn_id_220
 ,

859 
	mxe1_¡©_vÏn_id_221
 ,

860 
	mxe1_¡©_vÏn_id_222
 ,

861 
	mxe1_¡©_vÏn_id_223
 ,

862 
	mxe1_¡©_vÏn_id_224
 ,

863 
	mxe1_¡©_vÏn_id_225
 ,

864 
	mxe1_¡©_vÏn_id_226
 ,

865 
	mxe1_¡©_vÏn_id_227
 ,

866 
	mxe1_¡©_vÏn_id_228
 ,

867 
	mxe1_¡©_vÏn_id_229
 ,

868 
	mxe1_¡©_vÏn_id_230
 ,

869 
	mxe1_¡©_vÏn_id_231
 ,

870 
	mxe1_¡©_vÏn_id_232
 ,

871 
	mxe1_¡©_vÏn_id_233
 ,

872 
	mxe1_¡©_vÏn_id_234
 ,

873 
	mxe1_¡©_vÏn_id_235
 ,

874 
	mxe1_¡©_vÏn_id_236
 ,

875 
	mxe1_¡©_vÏn_id_237
 ,

876 
	mxe1_¡©_vÏn_id_238
 ,

877 
	mxe1_¡©_vÏn_id_239
 ,

878 
	mxe1_¡©_vÏn_id_240
 ,

879 
	mxe1_¡©_vÏn_id_241
 ,

880 
	mxe1_¡©_vÏn_id_242
 ,

881 
	mxe1_¡©_vÏn_id_243
 ,

882 
	mxe1_¡©_vÏn_id_244
 ,

883 
	mxe1_¡©_vÏn_id_245
 ,

884 
	mxe1_¡©_vÏn_id_246
 ,

885 
	mxe1_¡©_vÏn_id_247
 ,

886 
	mxe1_¡©_vÏn_id_248
 ,

887 
	mxe1_¡©_vÏn_id_249
 ,

888 
	mxe1_¡©_vÏn_id_250
 ,

889 
	mxe1_¡©_vÏn_id_251
 ,

890 
	mxe1_¡©_vÏn_id_252
 ,

891 
	mxe1_¡©_vÏn_id_253
 ,

892 
	mxe1_¡©_vÏn_id_254
 ,

893 
	mxe1_¡©_vÏn_id_255
 ,

894 
	m¡©_vÏn_id_max
,

895 } 
	täc_vÏn_¡©_e
;

899 #ià
FRC_CONFIG_TIMESTAMP_CHECK


901 
	m¡©_rxx_pkts
 ,

902 
	m¡©_rxx_by‹s
 ,

903 
	mxe0_¡©_rxx_pkts
 ,

904 
	mxe0_¡©_rxx_by‹s
 ,

905 
	mxe1_¡©_rxx_pkts
 ,

906 
	mxe1_¡©_rxx_by‹s
 ,

908 
	m¡©_pÜt0_rxx_pkts
 ,

909 
	mxe0_¡©_pÜt0_rxx_pkts
 ,

910 
	mxe0_¡©_pÜt0_y—r_šv®id_pkts
 ,

911 
	mxe0_¡©_pÜt0_mÚth_šv®id_pkts
 ,

912 
	mxe0_¡©_pÜt0_day_šv®id_pkts
 ,

913 
	mxe0_¡©_pÜt0_hour_šv®id_pkts
 ,

914 
	mxe0_¡©_pÜt0_mšu‹_šv®id_pkts
 ,

915 
	mxe0_¡©_pÜt0_£cÚd_šv®id_pkts
 ,

916 
	mxe0_¡©_pÜt0__”r_pkts
 ,

917 
	mxe0_¡©_pÜt0_time¡amp_”r_pkts
 ,

918 
	mxe1_¡©_pÜt0_rxx_pkts
 ,

919 
	mxe1_¡©_pÜt0_y—r_šv®id_pkts
 ,

920 
	mxe1_¡©_pÜt0_mÚth_šv®id_pkts
 ,

921 
	mxe1_¡©_pÜt0_day_šv®id_pkts
 ,

922 
	mxe1_¡©_pÜt0_hour_šv®id_pkts
 ,

923 
	mxe1_¡©_pÜt0_mšu‹_šv®id_pkts
 ,

924 
	mxe1_¡©_pÜt0_£cÚd_šv®id_pkts
 ,

925 
	mxe1_¡©_pÜt0__”r_pkts
 ,

926 
	mxe1_¡©_pÜt0_time¡amp_”r_pkts
 ,

928 
	m¡©_pÜt1_rxx_pkts
 ,

929 
	mxe0_¡©_pÜt1_rxx_pkts
 ,

930 
	mxe0_¡©_pÜt1_y—r_šv®id_pkts
 ,

931 
	mxe0_¡©_pÜt1_mÚth_šv®id_pkts
 ,

932 
	mxe0_¡©_pÜt1_day_šv®id_pkts
 ,

933 
	mxe0_¡©_pÜt1_hour_šv®id_pkts
 ,

934 
	mxe0_¡©_pÜt1_mšu‹_šv®id_pkts
 ,

935 
	mxe0_¡©_pÜt1_£cÚd_šv®id_pkts
 ,

936 
	mxe0_¡©_pÜt1__”r_pkts
 ,

937 
	mxe0_¡©_pÜt1_time¡amp_”r_pkts
 ,

938 
	mxe1_¡©_pÜt1_rxx_pkts
 ,

939 
	mxe1_¡©_pÜt1_y—r_šv®id_pkts
 ,

940 
	mxe1_¡©_pÜt1_mÚth_šv®id_pkts
 ,

941 
	mxe1_¡©_pÜt1_day_šv®id_pkts
 ,

942 
	mxe1_¡©_pÜt1_hour_šv®id_pkts
 ,

943 
	mxe1_¡©_pÜt1_mšu‹_šv®id_pkts
 ,

944 
	mxe1_¡©_pÜt1_£cÚd_šv®id_pkts
 ,

945 
	mxe1_¡©_pÜt1__”r_pkts
 ,

946 
	mxe1_¡©_pÜt1_time¡amp_”r_pkts
 ,

948 
	m¡©_pÜt2_rxx_pkts
 ,

949 
	mxe0_¡©_pÜt2_rxx_pkts
 ,

950 
	mxe0_¡©_pÜt2_y—r_šv®id_pkts
 ,

951 
	mxe0_¡©_pÜt2_mÚth_šv®id_pkts
 ,

952 
	mxe0_¡©_pÜt2_day_šv®id_pkts
 ,

953 
	mxe0_¡©_pÜt2_hour_šv®id_pkts
 ,

954 
	mxe0_¡©_pÜt2_mšu‹_šv®id_pkts
 ,

955 
	mxe0_¡©_pÜt2_£cÚd_šv®id_pkts
 ,

956 
	mxe0_¡©_pÜt2__”r_pkts
 ,

957 
	mxe0_¡©_pÜt2_time¡amp_”r_pkts
 ,

958 
	mxe1_¡©_pÜt2_rxx_pkts
 ,

959 
	mxe1_¡©_pÜt2_y—r_šv®id_pkts
 ,

960 
	mxe1_¡©_pÜt2_mÚth_šv®id_pkts
 ,

961 
	mxe1_¡©_pÜt2_day_šv®id_pkts
 ,

962 
	mxe1_¡©_pÜt2_hour_šv®id_pkts
 ,

963 
	mxe1_¡©_pÜt2_mšu‹_šv®id_pkts
 ,

964 
	mxe1_¡©_pÜt2_£cÚd_šv®id_pkts
 ,

965 
	mxe1_¡©_pÜt2__”r_pkts
 ,

966 
	mxe1_¡©_pÜt2_time¡amp_”r_pkts
 ,

968 
	m¡©_pÜt3_rxx_pkts
 ,

969 
	mxe0_¡©_pÜt3_rxx_pkts
 ,

970 
	mxe0_¡©_pÜt3_y—r_šv®id_pkts
 ,

971 
	mxe0_¡©_pÜt3_mÚth_šv®id_pkts
 ,

972 
	mxe0_¡©_pÜt3_day_šv®id_pkts
 ,

973 
	mxe0_¡©_pÜt3_hour_šv®id_pkts
 ,

974 
	mxe0_¡©_pÜt3_mšu‹_šv®id_pkts
 ,

975 
	mxe0_¡©_pÜt3_£cÚd_šv®id_pkts
 ,

976 
	mxe0_¡©_pÜt3__”r_pkts
 ,

977 
	mxe0_¡©_pÜt3_time¡amp_”r_pkts
 ,

978 
	mxe1_¡©_pÜt3_rxx_pkts
 ,

979 
	mxe1_¡©_pÜt3_y—r_šv®id_pkts
 ,

980 
	mxe1_¡©_pÜt3_mÚth_šv®id_pkts
 ,

981 
	mxe1_¡©_pÜt3_day_šv®id_pkts
 ,

982 
	mxe1_¡©_pÜt3_hour_šv®id_pkts
 ,

983 
	mxe1_¡©_pÜt3_mšu‹_šv®id_pkts
 ,

984 
	mxe1_¡©_pÜt3_£cÚd_šv®id_pkts
 ,

985 
	mxe1_¡©_pÜt3__”r_pkts
 ,

986 
	mxe1_¡©_pÜt3_time¡amp_”r_pkts
 ,

988 
	m¡©_pÜt4_rxx_pkts
 ,

989 
	mxe0_¡©_pÜt4_rxx_pkts
 ,

990 
	mxe0_¡©_pÜt4_y—r_šv®id_pkts
 ,

991 
	mxe0_¡©_pÜt4_mÚth_šv®id_pkts
 ,

992 
	mxe0_¡©_pÜt4_day_šv®id_pkts
 ,

993 
	mxe0_¡©_pÜt4_hour_šv®id_pkts
 ,

994 
	mxe0_¡©_pÜt4_mšu‹_šv®id_pkts
 ,

995 
	mxe0_¡©_pÜt4_£cÚd_šv®id_pkts
 ,

996 
	mxe0_¡©_pÜt4__”r_pkts
 ,

997 
	mxe0_¡©_pÜt4_time¡amp_”r_pkts
 ,

998 
	mxe1_¡©_pÜt4_rxx_pkts
 ,

999 
	mxe1_¡©_pÜt4_y—r_šv®id_pkts
 ,

1000 
	mxe1_¡©_pÜt4_mÚth_šv®id_pkts
 ,

1001 
	mxe1_¡©_pÜt4_day_šv®id_pkts
 ,

1002 
	mxe1_¡©_pÜt4_hour_šv®id_pkts
 ,

1003 
	mxe1_¡©_pÜt4_mšu‹_šv®id_pkts
 ,

1004 
	mxe1_¡©_pÜt4_£cÚd_šv®id_pkts
 ,

1005 
	mxe1_¡©_pÜt4__”r_pkts
 ,

1006 
	mxe1_¡©_pÜt4_time¡amp_”r_pkts
 ,

1008 
	m¡©_pÜt5_rxx_pkts
 ,

1009 
	mxe0_¡©_pÜt5_rxx_pkts
 ,

1010 
	mxe0_¡©_pÜt5_y—r_šv®id_pkts
 ,

1011 
	mxe0_¡©_pÜt5_mÚth_šv®id_pkts
 ,

1012 
	mxe0_¡©_pÜt5_day_šv®id_pkts
 ,

1013 
	mxe0_¡©_pÜt5_hour_šv®id_pkts
 ,

1014 
	mxe0_¡©_pÜt5_mšu‹_šv®id_pkts
 ,

1015 
	mxe0_¡©_pÜt5_£cÚd_šv®id_pkts
 ,

1016 
	mxe0_¡©_pÜt5__”r_pkts
 ,

1017 
	mxe0_¡©_pÜt5_time¡amp_”r_pkts
 ,

1018 
	mxe1_¡©_pÜt5_rxx_pkts
 ,

1019 
	mxe1_¡©_pÜt5_y—r_šv®id_pkts
 ,

1020 
	mxe1_¡©_pÜt5_mÚth_šv®id_pkts
 ,

1021 
	mxe1_¡©_pÜt5_day_šv®id_pkts
 ,

1022 
	mxe1_¡©_pÜt5_hour_šv®id_pkts
 ,

1023 
	mxe1_¡©_pÜt5_mšu‹_šv®id_pkts
 ,

1024 
	mxe1_¡©_pÜt5_£cÚd_šv®id_pkts
 ,

1025 
	mxe1_¡©_pÜt5__”r_pkts
 ,

1026 
	mxe1_¡©_pÜt5_time¡amp_”r_pkts
 ,

1028 
	m¡©_pÜt6_rxx_pkts
 ,

1029 
	mxe0_¡©_pÜt6_rxx_pkts
 ,

1030 
	mxe0_¡©_pÜt6_y—r_šv®id_pkts
 ,

1031 
	mxe0_¡©_pÜt6_mÚth_šv®id_pkts
 ,

1032 
	mxe0_¡©_pÜt6_day_šv®id_pkts
 ,

1033 
	mxe0_¡©_pÜt6_hour_šv®id_pkts
 ,

1034 
	mxe0_¡©_pÜt6_mšu‹_šv®id_pkts
 ,

1035 
	mxe0_¡©_pÜt6_£cÚd_šv®id_pkts
 ,

1036 
	mxe0_¡©_pÜt6__”r_pkts
 ,

1037 
	mxe0_¡©_pÜt6_time¡amp_”r_pkts
 ,

1038 
	mxe1_¡©_pÜt6_rxx_pkts
 ,

1039 
	mxe1_¡©_pÜt6_y—r_šv®id_pkts
 ,

1040 
	mxe1_¡©_pÜt6_mÚth_šv®id_pkts
 ,

1041 
	mxe1_¡©_pÜt6_day_šv®id_pkts
 ,

1042 
	mxe1_¡©_pÜt6_hour_šv®id_pkts
 ,

1043 
	mxe1_¡©_pÜt6_mšu‹_šv®id_pkts
 ,

1044 
	mxe1_¡©_pÜt6_£cÚd_šv®id_pkts
 ,

1045 
	mxe1_¡©_pÜt6__”r_pkts
 ,

1046 
	mxe1_¡©_pÜt6_time¡amp_”r_pkts
 ,

1048 
	m¡©_pÜt7_rxx_pkts
 ,

1049 
	mxe0_¡©_pÜt7_rxx_pkts
 ,

1050 
	mxe0_¡©_pÜt7_y—r_šv®id_pkts
 ,

1051 
	mxe0_¡©_pÜt7_mÚth_šv®id_pkts
 ,

1052 
	mxe0_¡©_pÜt7_day_šv®id_pkts
 ,

1053 
	mxe0_¡©_pÜt7_hour_šv®id_pkts
 ,

1054 
	mxe0_¡©_pÜt7_mšu‹_šv®id_pkts
 ,

1055 
	mxe0_¡©_pÜt7_£cÚd_šv®id_pkts
 ,

1056 
	mxe0_¡©_pÜt7__”r_pkts
 ,

1057 
	mxe0_¡©_pÜt7_time¡amp_”r_pkts
 ,

1058 
	mxe1_¡©_pÜt7_rxx_pkts
 ,

1059 
	mxe1_¡©_pÜt7_y—r_šv®id_pkts
 ,

1060 
	mxe1_¡©_pÜt7_mÚth_šv®id_pkts
 ,

1061 
	mxe1_¡©_pÜt7_day_šv®id_pkts
 ,

1062 
	mxe1_¡©_pÜt7_hour_šv®id_pkts
 ,

1063 
	mxe1_¡©_pÜt7_mšu‹_šv®id_pkts
 ,

1064 
	mxe1_¡©_pÜt7_£cÚd_šv®id_pkts
 ,

1065 
	mxe1_¡©_pÜt7__”r_pkts
 ,

1066 
	mxe1_¡©_pÜt7_time¡amp_”r_pkts
 ,

1068 
	m¡©_pÜt8_rxx_pkts
 ,

1069 
	mxe0_¡©_pÜt8_rxx_pkts
 ,

1070 
	mxe0_¡©_pÜt8_y—r_šv®id_pkts
 ,

1071 
	mxe0_¡©_pÜt8_mÚth_šv®id_pkts
 ,

1072 
	mxe0_¡©_pÜt8_day_šv®id_pkts
 ,

1073 
	mxe0_¡©_pÜt8_hour_šv®id_pkts
 ,

1074 
	mxe0_¡©_pÜt8_mšu‹_šv®id_pkts
 ,

1075 
	mxe0_¡©_pÜt8_£cÚd_šv®id_pkts
 ,

1076 
	mxe0_¡©_pÜt8__”r_pkts
 ,

1077 
	mxe0_¡©_pÜt8_time¡amp_”r_pkts
 ,

1078 
	mxe1_¡©_pÜt8_rxx_pkts
 ,

1079 
	mxe1_¡©_pÜt8_y—r_šv®id_pkts
 ,

1080 
	mxe1_¡©_pÜt8_mÚth_šv®id_pkts
 ,

1081 
	mxe1_¡©_pÜt8_day_šv®id_pkts
 ,

1082 
	mxe1_¡©_pÜt8_hour_šv®id_pkts
 ,

1083 
	mxe1_¡©_pÜt8_mšu‹_šv®id_pkts
 ,

1084 
	mxe1_¡©_pÜt8_£cÚd_šv®id_pkts
 ,

1085 
	mxe1_¡©_pÜt8__”r_pkts
 ,

1086 
	mxe1_¡©_pÜt8_time¡amp_”r_pkts
 ,

1088 
	m¡©_pÜt9_rxx_pkts
 ,

1089 
	mxe0_¡©_pÜt9_rxx_pkts
 ,

1090 
	mxe0_¡©_pÜt9_y—r_šv®id_pkts
 ,

1091 
	mxe0_¡©_pÜt9_mÚth_šv®id_pkts
 ,

1092 
	mxe0_¡©_pÜt9_day_šv®id_pkts
 ,

1093 
	mxe0_¡©_pÜt9_hour_šv®id_pkts
 ,

1094 
	mxe0_¡©_pÜt9_mšu‹_šv®id_pkts
 ,

1095 
	mxe0_¡©_pÜt9_£cÚd_šv®id_pkts
 ,

1096 
	mxe0_¡©_pÜt9__”r_pkts
 ,

1097 
	mxe0_¡©_pÜt9_time¡amp_”r_pkts
 ,

1098 
	mxe1_¡©_pÜt9_rxx_pkts
 ,

1099 
	mxe1_¡©_pÜt9_y—r_šv®id_pkts
 ,

1100 
	mxe1_¡©_pÜt9_mÚth_šv®id_pkts
 ,

1101 
	mxe1_¡©_pÜt9_day_šv®id_pkts
 ,

1102 
	mxe1_¡©_pÜt9_hour_šv®id_pkts
 ,

1103 
	mxe1_¡©_pÜt9_mšu‹_šv®id_pkts
 ,

1104 
	mxe1_¡©_pÜt9_£cÚd_šv®id_pkts
 ,

1105 
	mxe1_¡©_pÜt9__”r_pkts
 ,

1106 
	mxe1_¡©_pÜt9_time¡amp_”r_pkts
 ,

1108 
	m¡©_pÜt10_rxx_pkts
 ,

1109 
	mxe0_¡©_pÜt10_rxx_pkts
 ,

1110 
	mxe0_¡©_pÜt10_y—r_šv®id_pkts
 ,

1111 
	mxe0_¡©_pÜt10_mÚth_šv®id_pkts
 ,

1112 
	mxe0_¡©_pÜt10_day_šv®id_pkts
 ,

1113 
	mxe0_¡©_pÜt10_hour_šv®id_pkts
 ,

1114 
	mxe0_¡©_pÜt10_mšu‹_šv®id_pkts
 ,

1115 
	mxe0_¡©_pÜt10_£cÚd_šv®id_pkts
 ,

1116 
	mxe0_¡©_pÜt10__”r_pkts
 ,

1117 
	mxe0_¡©_pÜt10_time¡amp_”r_pkts
 ,

1118 
	mxe1_¡©_pÜt10_rxx_pkts
 ,

1119 
	mxe1_¡©_pÜt10_y—r_šv®id_pkts
 ,

1120 
	mxe1_¡©_pÜt10_mÚth_šv®id_pkts
 ,

1121 
	mxe1_¡©_pÜt10_day_šv®id_pkts
 ,

1122 
	mxe1_¡©_pÜt10_hour_šv®id_pkts
 ,

1123 
	mxe1_¡©_pÜt10_mšu‹_šv®id_pkts
 ,

1124 
	mxe1_¡©_pÜt10_£cÚd_šv®id_pkts
 ,

1125 
	mxe1_¡©_pÜt10__”r_pkts
 ,

1126 
	mxe1_¡©_pÜt10_time¡amp_”r_pkts
 ,

1128 
	m¡©_pÜt11_rxx_pkts
 ,

1129 
	mxe0_¡©_pÜt11_rxx_pkts
 ,

1130 
	mxe0_¡©_pÜt11_y—r_šv®id_pkts
 ,

1131 
	mxe0_¡©_pÜt11_mÚth_šv®id_pkts
 ,

1132 
	mxe0_¡©_pÜt11_day_šv®id_pkts
 ,

1133 
	mxe0_¡©_pÜt11_hour_šv®id_pkts
 ,

1134 
	mxe0_¡©_pÜt11_mšu‹_šv®id_pkts
 ,

1135 
	mxe0_¡©_pÜt11_£cÚd_šv®id_pkts
 ,

1136 
	mxe0_¡©_pÜt11__”r_pkts
 ,

1137 
	mxe0_¡©_pÜt11_time¡amp_”r_pkts
 ,

1138 
	mxe1_¡©_pÜt11_rxx_pkts
 ,

1139 
	mxe1_¡©_pÜt11_y—r_šv®id_pkts
 ,

1140 
	mxe1_¡©_pÜt11_mÚth_šv®id_pkts
 ,

1141 
	mxe1_¡©_pÜt11_day_šv®id_pkts
 ,

1142 
	mxe1_¡©_pÜt11_hour_šv®id_pkts
 ,

1143 
	mxe1_¡©_pÜt11_mšu‹_šv®id_pkts
 ,

1144 
	mxe1_¡©_pÜt11_£cÚd_šv®id_pkts
 ,

1145 
	mxe1_¡©_pÜt11__”r_pkts
 ,

1146 
	mxe1_¡©_pÜt11_time¡amp_”r_pkts
 ,

1148 
	m¡©_pÜt12_rxx_pkts
 ,

1149 
	mxe0_¡©_pÜt12_rxx_pkts
 ,

1150 
	mxe0_¡©_pÜt12_y—r_šv®id_pkts
 ,

1151 
	mxe0_¡©_pÜt12_mÚth_šv®id_pkts
 ,

1152 
	mxe0_¡©_pÜt12_day_šv®id_pkts
 ,

1153 
	mxe0_¡©_pÜt12_hour_šv®id_pkts
 ,

1154 
	mxe0_¡©_pÜt12_mšu‹_šv®id_pkts
 ,

1155 
	mxe0_¡©_pÜt12_£cÚd_šv®id_pkts
 ,

1156 
	mxe0_¡©_pÜt12__”r_pkts
 ,

1157 
	mxe0_¡©_pÜt12_time¡amp_”r_pkts
 ,

1158 
	mxe1_¡©_pÜt12_rxx_pkts
 ,

1159 
	mxe1_¡©_pÜt12_y—r_šv®id_pkts
 ,

1160 
	mxe1_¡©_pÜt12_mÚth_šv®id_pkts
 ,

1161 
	mxe1_¡©_pÜt12_day_šv®id_pkts
 ,

1162 
	mxe1_¡©_pÜt12_hour_šv®id_pkts
 ,

1163 
	mxe1_¡©_pÜt12_mšu‹_šv®id_pkts
 ,

1164 
	mxe1_¡©_pÜt12_£cÚd_šv®id_pkts
 ,

1165 
	mxe1_¡©_pÜt12__”r_pkts
 ,

1166 
	mxe1_¡©_pÜt12_time¡amp_”r_pkts
 ,

1168 
	m¡©_pÜt13_rxx_pkts
 ,

1169 
	mxe0_¡©_pÜt13_rxx_pkts
 ,

1170 
	mxe0_¡©_pÜt13_y—r_šv®id_pkts
 ,

1171 
	mxe0_¡©_pÜt13_mÚth_šv®id_pkts
 ,

1172 
	mxe0_¡©_pÜt13_day_šv®id_pkts
 ,

1173 
	mxe0_¡©_pÜt13_hour_šv®id_pkts
 ,

1174 
	mxe0_¡©_pÜt13_mšu‹_šv®id_pkts
 ,

1175 
	mxe0_¡©_pÜt13_£cÚd_šv®id_pkts
 ,

1176 
	mxe0_¡©_pÜt13__”r_pkts
 ,

1177 
	mxe0_¡©_pÜt13_time¡amp_”r_pkts
 ,

1178 
	mxe1_¡©_pÜt13_rxx_pkts
 ,

1179 
	mxe1_¡©_pÜt13_y—r_šv®id_pkts
 ,

1180 
	mxe1_¡©_pÜt13_mÚth_šv®id_pkts
 ,

1181 
	mxe1_¡©_pÜt13_day_šv®id_pkts
 ,

1182 
	mxe1_¡©_pÜt13_hour_šv®id_pkts
 ,

1183 
	mxe1_¡©_pÜt13_mšu‹_šv®id_pkts
 ,

1184 
	mxe1_¡©_pÜt13_£cÚd_šv®id_pkts
 ,

1185 
	mxe1_¡©_pÜt13__”r_pkts
 ,

1186 
	mxe1_¡©_pÜt13_time¡amp_”r_pkts
 ,

1188 
	m¡©_pÜt14_rxx_pkts
 ,

1189 
	mxe0_¡©_pÜt14_rxx_pkts
 ,

1190 
	mxe0_¡©_pÜt14_y—r_šv®id_pkts
 ,

1191 
	mxe0_¡©_pÜt14_mÚth_šv®id_pkts
 ,

1192 
	mxe0_¡©_pÜt14_day_šv®id_pkts
 ,

1193 
	mxe0_¡©_pÜt14_hour_šv®id_pkts
 ,

1194 
	mxe0_¡©_pÜt14_mšu‹_šv®id_pkts
 ,

1195 
	mxe0_¡©_pÜt14_£cÚd_šv®id_pkts
 ,

1196 
	mxe0_¡©_pÜt14__”r_pkts
 ,

1197 
	mxe0_¡©_pÜt14_time¡amp_”r_pkts
 ,

1198 
	mxe1_¡©_pÜt14_rxx_pkts
 ,

1199 
	mxe1_¡©_pÜt14_y—r_šv®id_pkts
 ,

1200 
	mxe1_¡©_pÜt14_mÚth_šv®id_pkts
 ,

1201 
	mxe1_¡©_pÜt14_day_šv®id_pkts
 ,

1202 
	mxe1_¡©_pÜt14_hour_šv®id_pkts
 ,

1203 
	mxe1_¡©_pÜt14_mšu‹_šv®id_pkts
 ,

1204 
	mxe1_¡©_pÜt14_£cÚd_šv®id_pkts
 ,

1205 
	mxe1_¡©_pÜt14__”r_pkts
 ,

1206 
	mxe1_¡©_pÜt14_time¡amp_”r_pkts
 ,

1208 
	m¡©_pÜt15_rxx_pkts
 ,

1209 
	mxe0_¡©_pÜt15_rxx_pkts
 ,

1210 
	mxe0_¡©_pÜt15_y—r_šv®id_pkts
 ,

1211 
	mxe0_¡©_pÜt15_mÚth_šv®id_pkts
 ,

1212 
	mxe0_¡©_pÜt15_day_šv®id_pkts
 ,

1213 
	mxe0_¡©_pÜt15_hour_šv®id_pkts
 ,

1214 
	mxe0_¡©_pÜt15_mšu‹_šv®id_pkts
 ,

1215 
	mxe0_¡©_pÜt15_£cÚd_šv®id_pkts
 ,

1216 
	mxe0_¡©_pÜt15__”r_pkts
 ,

1217 
	mxe0_¡©_pÜt15_time¡amp_”r_pkts
 ,

1218 
	mxe1_¡©_pÜt15_rxx_pkts
 ,

1219 
	mxe1_¡©_pÜt15_y—r_šv®id_pkts
 ,

1220 
	mxe1_¡©_pÜt15_mÚth_šv®id_pkts
 ,

1221 
	mxe1_¡©_pÜt15_day_šv®id_pkts
 ,

1222 
	mxe1_¡©_pÜt15_hour_šv®id_pkts
 ,

1223 
	mxe1_¡©_pÜt15_mšu‹_šv®id_pkts
 ,

1224 
	mxe1_¡©_pÜt15_£cÚd_šv®id_pkts
 ,

1225 
	mxe1_¡©_pÜt15__”r_pkts
 ,

1226 
	mxe1_¡©_pÜt15_time¡amp_”r_pkts
 ,

1228 
	m¡©_time¡amp_max
,

1229 } 
	täc_time¡amp_¡©_e
;

1231 
	#FRC_STAT_NAME_SIZE
 32

	)

1234 
ušt64_t
 
	mloÿl
;

1235 
ušt64_t
 
	m»mÙe
;

1236 } 
	täc_‹mp_t
;

1240 
ušt64_t
 
	mrx_”rs
;

1241 
ušt64_t
 
	mrx_pkts
;

1242 
ušt64_t
 
	mrx_by‹s
;

1244 
ušt64_t
 
	mtx_”rs
;

1245 
ušt64_t
 
	mtx_pkts
;

1246 
ušt64_t
 
	mtx_by‹s
;

1247 } 
	täc_pÜt_¡©_t
;

1250 #ià
__FRC_BYTE_ORDER
 =ğ
__FRC_LITTLE_ENDIAN


1251 
ušt64_t
 
	m’abË
:8;

1252 
ušt64_t
 
	mlšked
:8;

1253 
ušt64_t
 
	m¥“d
:16;

1254 
ušt64_t
 
	mmtu
:16;

1255 
ušt64_t
 
	mæags
:16;

1257 
ušt64_t
 
	mæags
:16;

1258 
ušt64_t
 
	mmtu
:16;

1259 
ušt64_t
 
	m¥“d
:16;

1260 
ušt64_t
 
	mlšked
:8;

1261 
ušt64_t
 
	m’abË
:8;

1263 } 
	täc_pÜt_¡©us_t
;

1267 #ià
__FRC_BYTE_ORDER
 =ğ
__FRC_LITTLE_ENDIAN


1268 
ušt16_t
 
	mpÜt
;

1269 
ušt16_t
 
	mdevad
;

1270 
ušt16_t
 
	maddr
;

1271 
ušt16_t
 
	mv®ue
;

1273 
ušt16_t
 
	mv®ue
;

1274 
ušt16_t
 
	maddr
;

1275 
ušt16_t
 
	mdevad
;

1276 
ušt16_t
 
	mpÜt
;

1278 } 
	täc_phy_İ_t
;

1282 
ušt8_t
 
	mİ
;

1283 
äc_phy_İ_t
 
	mphy
;

1284 } 
	täc_bdd_phy_t
;

1287 
ušt8_t
 
	m’abË
;

1288 
ušt8_t
 
	mdisÜd”_d•th
;

1289 
ušt8_t
 
	mage_time
;

1290 
ušt8_t
 
	m»Œªs_time
;

1291 } 
	täc_ä_¡©us_t
;

1295 #ià
__FRC_BYTE_ORDER
 =ğ
__FRC_LITTLE_ENDIAN


1296 
ušt32_t
 
	ms
;

1297 
ušt32_t
 
	md
;

1298 
ušt16_t
 
	m¥
;

1299 
ušt16_t
 
	mdp
;

1300 
ušt16_t
 
	m´Ùo
;

1301 
ušt16_t
 
	m»£rve
;

1303 
ušt32_t
 
	md
;

1304 
ušt32_t
 
	ms
;

1305 
ušt16_t
 
	m»£rve
;

1306 
ušt16_t
 
	m´Ùo
;

1307 
ušt16_t
 
	mdp
;

1308 
ušt16_t
 
	m¥
;

1310 } 
	täc_ä_tu¶e_t
;

1313 #ià
__FRC_BYTE_ORDER
 =ğ
__FRC_LITTLE_ENDIAN


1314 
ušt32_t
 
	mpkts
;

1315 
ušt32_t
 
	mby‹s
;

1317 
ušt32_t
 
	mby‹s
;

1318 
ušt32_t
 
	mpkts
;

1320 } 
	täc_ä_£ssiÚ_¡©_t
;

1325 
ušt8_t
 
	mlšk
;

1326 
ušt8_t
 
	m’abË
;

1327 
ušt8_t
 
	mwÜk_mode
;

1328 
ušt8_t
 
	mloİback_mode
;

1329 
ušt16_t
 
	mİtiÿl_¡©us
;

1330 
ušt16_t
 
	mİtiÿl
;

1331 
ušt32_t
 
	mrx_pkts_¿‹
;

1332 
ušt32_t
 
	mrx_by‹s_¿‹
;

1333 
ušt32_t
 
	mtx_pkts_¿‹
;

1334 
ušt32_t
 
	mtx_by‹s_¿‹
;

1335 } 
	täc_où_t
;

1339 
äc_v”siÚ_t
 
	mäcÜe_v”siÚ
;

1340 
äc_v”siÚ_t
 
	mäcdrv_v”siÚ
;

1341 
äc_v”siÚ_t
 
	mäùw—k_v”siÚ
;

1342 
äc_v”siÚ_t
 
	moùdrv_v”siÚ
;

1343 
äc_v”siÚ_t
 
	moùnic_v”siÚ
;

1344 
ušt32_t
 
	mıld_v”siÚ
;

1345 
ušt32_t
 
	mpÜt_numb”
;

1346 } 
	täc_bdd_šfo_out_t
;

1350 
äc_ä_tu¶e_t
 
	mfive_tu¶e
;

1351 
äc_ä_£ssiÚ_¡©_t
 
	m£ssiÚ_¡©
;

1352 } 
	täc_ä_£ssiÚ_t
;

1355 
ušt32_t
 
	mnum
;

1356 
äc_ä_£ssiÚ_t
 
	m£ssiÚ
[
MAX_HASH_SESSION
];

1357 } 
	täc_ä_hash_£ssiÚ_t
;

1360 
äc_ä_tu¶e_t
 
	mtu¶e
;

1361 
ušt64_t
 
	mnum
;

1362 } 
	täc_s¢_m©ch_t
;

1366 #ià
__FRC_BYTE_ORDER
 =ğ
__FRC_LITTLE_ENDIAN


1367 
ušt32_t
 
	maddr
;

1368 
ušt32_t
 
	msize
;

1370 
ušt32_t
 
	msize
;

1371 
ušt32_t
 
	maddr
;

1373 } 
	täc_bdd_dma_»ad_š_t
;

1377 
äc_‹mp_t
 
	m‹mp
;

1378 
ušt16_t
 
	mdma_block_size
;

1379 
ušt16_t
 
	mruÂšg_¡©us
;

1380 
ušt32_t
 
	mruË_max
;

1381 
ušt32_t
 
	ms¢_max
;

1382 
äc_où_t
 
	moù0
;

1383 
äc_où_t
 
	moù1
;

1384 } 
	täc_bdd_¡©us_out_t
;

1387 #ià
__FRC_BYTE_ORDER
 =ğ
__FRC_LITTLE_ENDIAN


1388 
ušt32_t
 
	maddr
;

1389 
ušt32_t
 
	md©a
;

1391 
ušt32_t
 
	md©a
;

1392 
ušt32_t
 
	maddr
;

1394 } 
	täc_ıld_İ_t
;

1397 
ušt8_t
 
	mİ
;

1398 
äc_ıld_İ_t
 
	mıld
;

1399 } 
	täc_bdd_ıld_t
;

1403 
ušt8_t
 
	moù
;

1404 
ušt8_t
 
	mmode
;

1405 } 
	täc_bdd_wÜkmode_£t_š_t
;

1408 
ušt8_t
 
	mpÜt
;

1409 
ušt8_t
 
	m’abË
;

1410 } 
	täc_bdd_£t_pÜt_š_t
;

1413 
ušt8_t
 
	moù
;

1414 
ušt8_t
 
	mlšk
;

1415 } 
	täc_bdd_fÜû_lšk_š_t
;

1418 
ušt8_t
 
	mpÜt
;

1419 
ušt8_t
 
	mloİback
;

1423 } 
	täc_bdd_£t_loİback_š_t
;

1426 
ušt8_t
 
	mlog
;

1433 
ušt8_t
 
	m’abË
;

1434 } 
	täc_bdd_log_š_t
;

1438 
ušt16_t
 
	mšdex
;

1439 
ušt16_t
 
	mnum
;

1440 } 
	täc_ruË_d–_š_t
;

1443 
ušt16_t
 
	mšdex
;

1444 
ušt16_t
 
	mnum
;

1445 } 
	täc_ruË_¡©_š_t
;

1449 
ušt16_t
 
	mšdex
;

1450 
ušt16_t
 
	mnum
;

1451 } 
	täc_ruË_ş—r_¡©_š_t
;

1455 #ià
__FRC_BYTE_ORDER
 =ğ
__FRC_LITTLE_ENDIAN


1456 
ušt32_t
 
	mšdex
;

1457 
ušt32_t
 
	mnum
;

1459 
ušt32_t
 
	mnum
;

1460 
ušt32_t
 
	mšdex
;

1462 } 
	täc_ruË_İ_š_t
;

1465 #ià
__FRC_BYTE_ORDER
 =ğ
__FRC_LITTLE_ENDIAN


1466 
ušt16_t
 
	mruË_sourû
;

1467 
ušt16_t
 
	mruË_ty³
;

1468 
ušt16_t
 
	maùiÚ
;

1469 
ušt16_t
 
	mİ
;

1470 
ušt32_t
 
	ms
;

1471 
ušt32_t
 
	md
;

1472 
ušt16_t
 
	m¥
;

1473 
ušt16_t
 
	mdp
;

1474 
ušt16_t
 
	m´Ùo
;

1475 
ušt16_t
 
	mšdex
;

1477 
ušt16_t
 
	mİ
;

1478 
ušt16_t
 
	maùiÚ
;

1479 
ušt16_t
 
	mruË_ty³
;

1480 
ušt16_t
 
	mruË_sourû
;

1481 
ušt32_t
 
	md
;

1482 
ušt32_t
 
	ms
;

1483 
ušt16_t
 
	mšdex
;

1484 
ušt16_t
 
	m´Ùo
;

1485 
ušt16_t
 
	mdp
;

1486 
ušt16_t
 
	m¥
;

1489 } 
	täc_ruË_t
;

1492 #ià
__FRC_BYTE_ORDER
 =ğ
__FRC_LITTLE_ENDIAN


1493 
ušt16_t
 
	mruË_sourû
;

1494 
ušt16_t
 
	mruË_ty³
;

1495 
ušt16_t
 
	maùiÚ
;

1496 
ušt16_t
 
	mİ
;

1497 
ušt8_t
 
	ms
[24];

1498 
ušt8_t
 
	md
[24];

1499 
ušt8_t
 
	m¥
[16];

1500 
ušt8_t
 
	mdp
[16];

1501 
ušt8_t
 
	m´Ùo
[8];

1502 
ušt64_t
 
	mšdex
;

1504 
ušt16_t
 
	mİ
;

1505 
ušt16_t
 
	maùiÚ
;

1506 
ušt16_t
 
	mruË_ty³
;

1507 
ušt16_t
 
	mruË_sourû
;

1508 
ušt8_t
 
	ms
[24];

1509 
ušt8_t
 
	md
[24];

1510 
ušt8_t
 
	m¥
[16];

1511 
ušt8_t
 
	mdp
[16];

1512 
ušt8_t
 
	m´Ùo
[8];

1513 
ušt64_t
 
	mšdex
;

1516 } 
	täcc_ruË_t
;

1519 #ià
__FRC_BYTE_ORDER
 =ğ
__FRC_LITTLE_ENDIAN


1520 
ušt32_t
 
	mpkts
;

1521 
ušt32_t
 
	mby‹s
;

1523 
ušt32_t
 
	mby‹s
;

1524 
ušt32_t
 
	mpkts
;

1526 }
	täc_ruË_pkt_¡©_t
;

1529 
äc_ruË_t
 
	mruË
;

1530 
äc_ruË_pkt_¡©_t
 
	m¡©
;

1531 }
	täc_ruË_¡©_t
;

1534 
ušt32_t
 
	mnum
;

1535 
äc_ruË_¡©_t
 
	mruË_¡©
[
MAX_RULE
];

1536 } 
	täc_ruË_¡©_out_t
;

1538 #ià
FRC_CONFIG_TWO_TUPLE


1541 
	mFRC_ACL_UNKNOWN
,

1542 
	mFRC_ACL_SIP
,

1543 
	mFRC_ACL_DIP
,

1544 
	mFRC_ACL_SP
,

1545 
	mFRC_ACL_DP
,

1546 } 
	täc_aş_ty³_t
;

1549 
ušt16_t
 
	mšdex
;

1550 
ušt16_t
 
	mnum
;

1551 } 
	täc_aş_d–_š_t
;

1554 
ušt16_t
 
	mšdex
;

1555 
ušt16_t
 
	mnum
;

1556 } 
	täc_aş_¡©_š_t
;

1560 
ušt16_t
 
	mšdex
;

1561 
ušt16_t
 
	mnum
;

1562 } 
	täc_aş_ş—r_¡©_š_t
;

1566 #ià
__FRC_BYTE_ORDER
 =ğ
__FRC_LITTLE_ENDIAN


1567 
ušt32_t
 
	mšdex
;

1568 
ušt32_t
 
	mnum
;

1570 
ušt32_t
 
	mnum
;

1571 
ušt32_t
 
	mšdex
;

1573 } 
	täc_aş_İ_š_t
;

1576 #ià
__FRC_BYTE_ORDER
 =ğ
__FRC_LITTLE_ENDIAN


1577 
ušt16_t
 
	maş_sourû
;

1578 
ušt16_t
 
	maş_ty³
;

1579 
ušt16_t
 
	maùiÚ
;

1580 
ušt16_t
 
	mİ
;

1581 
ušt32_t
 
	mÚe_tu¶e
;

1582 
ušt16_t
 
	m´Ùo
;

1583 
ušt16_t
 
	mšdex
;

1584 
ušt32_t
 
	mhash
;

1585 
ušt32_t
 
	m»£rved
;

1587 
ušt16_t
 
	mİ
;

1588 
ušt16_t
 
	maùiÚ
;

1589 
ušt16_t
 
	maş_ty³
;

1590 
ušt16_t
 
	maş_sourû
;

1591 
ušt16_t
 
	mšdex
;

1592 
ušt16_t
 
	m´Ùo
;

1593 
ušt32_t
 
	mÚe_tu¶e
;

1594 
ušt32_t
 
	m»£rved
;

1595 
ušt32_t
 
	mhash
;

1598 } 
	täc_aş_t
;

1601 #ià
__FRC_BYTE_ORDER
 =ğ
__FRC_LITTLE_ENDIAN


1602 
ušt32_t
 
	mhash
;

1603 
ušt32_t
 
	mbuck‘_d•th
;

1604 
ušt32_t
 
	mtÙ®_ûÎ
;

1605 
ušt32_t
 
	md–_ûÎ
;

1607 
ušt32_t
 
	mbuck‘_d•th
;

1608 
ušt32_t
 
	mhash
;

1609 
ušt32_t
 
	md–_ûÎ
;

1610 
ušt32_t
 
	mtÙ®_ûÎ
;

1612 } 
	täc_aş_hash_bË_t
;

1615 #ià
__FRC_BYTE_ORDER
 =ğ
__FRC_LITTLE_ENDIAN


1616 
ušt16_t
 
	maş_sourû
;

1617 
ušt16_t
 
	maş_ty³
;

1618 
ušt16_t
 
	maùiÚ
;

1619 
ušt16_t
 
	mİ
;

1620 
ušt8_t
 
	ms
[24];

1621 
ušt8_t
 
	md
[24];

1622 
ušt8_t
 
	m¥
[16];

1623 
ušt8_t
 
	mdp
[16];

1624 
ušt8_t
 
	m´Ùo
[8];

1625 
ušt64_t
 
	mšdex
;

1627 
ušt16_t
 
	mİ
;

1628 
ušt16_t
 
	maùiÚ
;

1629 
ušt16_t
 
	maş_ty³
;

1630 
ušt16_t
 
	maş_sourû
;

1631 
ušt8_t
 
	ms
[24];

1632 
ušt8_t
 
	md
[24];

1633 
ušt8_t
 
	m¥
[16];

1634 
ušt8_t
 
	mdp
[16];

1635 
ušt8_t
 
	m´Ùo
[8];

1636 
ušt64_t
 
	mšdex
;

1639 } 
	täcc_aş_t
;

1642 #ià
__FRC_BYTE_ORDER
 =ğ
__FRC_LITTLE_ENDIAN


1643 
ušt32_t
 
	mpkts
;

1644 
ušt32_t
 
	mby‹s
;

1646 
ušt32_t
 
	mby‹s
;

1647 
ušt32_t
 
	mpkts
;

1649 }
	täc_aş_pkt_¡©_t
;

1652 
äc_aş_t
 
	maş
;

1653 
äc_aş_pkt_¡©_t
 
	m¡©
;

1654 }
	täc_aş_¡©_t
;

1657 
ušt32_t
 
	mnum
;

1658 
äc_aş_¡©_t
 
	maş_¡©
[
MAX_RULE
];

1659 } 
	täc_aş_¡©_out_t
;

1662 #ià
__FRC_BYTE_ORDER
 =ğ
__FRC_LITTLE_ENDIAN


1663 
ušt32_t
 
	maş_ty³
;

1664 
ušt32_t
 
	m»£rved
;

1665 
ušt32_t
 
	mšdex
;

1666 
ušt32_t
 
	mnum
;

1668 
ušt32_t
 
	m»£rved
;

1669 
ušt32_t
 
	maş_ty³
;

1670 
ušt32_t
 
	mnum
;

1671 
ušt32_t
 
	mšdex
;

1673 } 
	täc_aş_hash_bË_İ_š_t
;

1676 
ušt64_t
 
	mnum
;

1677 
äc_aş_hash_bË_t
 
	maş_hash_¡©
[
MAX_RULE
];

1678 } 
	täc_aş_hash_bË_¡©_out_t
;

1682 #ià
FRC_CONFIG_VLAN_IV


1684 #ià
__FRC_BYTE_ORDER
 =ğ
__FRC_LITTLE_ENDIAN


1685 
ušt32_t
 
	mhash_ty³
;

1686 
ušt32_t
 
	m4
;

1688 
ušt32_t
 
	m4
;

1689 
ušt32_t
 
	mhash_ty³
;

1691 
ušt8_t
 
	m6
[16];

1692 } 
	täc_vÏn_hash_mask_t
;

1695 #ià
FRC_CONFIG_VLAN_CHECK


1697 
	mFRC_VLAN_CHECK_UNKNOWN
,

1698 
	mFRC_VLAN_CHECK_SIP
,

1699 
	mFRC_VLAN_CHECK_DIP
,

1700 
	mFRC_VLAN_CHECK_SDIP
,

1701 
	mFRC_VLAN_CHECK_MAX
,

1702 } 
	täc_vÏn_check_ty³_t
;

1704 #ià
__FRC_BYTE_ORDER
 =ğ
__FRC_LITTLE_ENDIAN


1705 
ušt16_t
 
	m¡¬t_id
;

1706 
ušt8_t
 
	mty³
;

1707 
ušt8_t
 
	m»sv”ed0
;

1708 
ušt16_t
 
	mnum
;

1709 
ušt16_t
 
	m»£rved
;

1711 
ušt16_t
 
	m»£rved
;

1712 
ušt16_t
 
	mnum
;

1713 
ušt8_t
 
	m»sv”ed0
;

1714 
ušt8_t
 
	mty³
;

1715 
ušt16_t
 
	m¡¬t_id
;

1717 } 
	täc_vÏn_check_·¿_t
;

1720 #ià
__FRC_BYTE_ORDER
 =ğ
__FRC_LITTLE_ENDIAN


1721 
ušt32_t
 
	mšdex
;

1722 
ušt32_t
 
	mnum
;

1724 
ušt32_t
 
	mnum
;

1725 
ušt32_t
 
	mšdex
;

1727 } 
	täc_¡©_İ_š_t
;

1731 #ià
__FRC_BYTE_ORDER
 =ğ
__FRC_LITTLE_ENDIAN


1732 
ušt32_t
 
	mšdex
;

1733 
ušt32_t
 
	mnum
;

1734 
ušt32_t
 
	mpÜt
;

1735 
ušt32_t
 
	m»£rv
;

1737 
ušt32_t
 
	mnum
;

1738 
ušt32_t
 
	mšdex
;

1739 
ušt32_t
 
	m»£rv
;

1740 
ušt32_t
 
	mpÜt
;

1742 } 
	täc_vÏn_İ_š_t
;

1745 
ušt64_t
 
	mmac
;

1746 
ušt64_t
 
	mcouÁ”
;

1747 } 
	täc_mac_¡©_š_t
;

1750 
ušt64_t
 
	mmac
;

1751 
ušt64_t
 
	mtÙ®
;

1752 
ušt64_t
 
	m”rÜs
;

1753 } 
	täc_mac_¡©_out_t
;

1754 #ià
FRC_CONFIG_TIMESTAMP_CHECK


1756 #ià
__FRC_BYTE_ORDER
 =ğ
__FRC_LITTLE_ENDIAN


1757 
ušt32_t
 
	mšdex
;

1758 
ušt32_t
 
	mnum
;

1759 
ušt32_t
 
	mpÜt
;

1760 
ušt32_t
 
	m»£rv
;

1762 
ušt32_t
 
	mnum
;

1763 
ušt32_t
 
	mšdex
;

1764 
ušt32_t
 
	m»£rv
;

1765 
ušt32_t
 
	mpÜt
;

1767 } 
	täc_time¡amp_İ_š_t
;

1770 #ià
FRC_CONFIG_IPC


1771 
	#IPC_INSTR_PROTOCOL
 0x8062

	)

1772 
	#IPC_INSTR_OUI
 0x2145

	)

1773 
	#IPC_INSTR_POOL
 5

	)

1774 
	#INSTR_PAYLOAD_SZ
 32

	)

1778 #ià
__FRC_BYTE_ORDER
 =ğ
__FRC_LITTLE_ENDIAN


1779 
ušt16_t
 
	mouid
;

1780 
ušt16_t
 
	mouim
;

1781 
ušt16_t
 
	miifd
;

1782 
ušt16_t
 
	miifm
;

1783 
ušt64_t
 
	mpidd
;

1784 
ušt64_t
 
	mpidm
;

1786 
ušt16_t
 
	miifm
;

1787 
ušt16_t
 
	miifd
;

1788 
ušt16_t
 
	mouim
;

1789 
ušt16_t
 
	mouid
;

1790 
ušt64_t
 
	mpidd
;

1791 
ušt64_t
 
	mpidm
;

1793 } 
	tc_exp_t
;

1798 #ià
__FRC_BYTE_ORDER
 =ğ
__FRC_LITTLE_ENDIAN


1799 
ušt8_t
 
	msmac_check
;

1800 
ušt8_t
 
	mpktid_check
;

1801 
ušt8_t
 
	mexp_check
;

1802 
ušt8_t
 
	mšv®id_dump
;

1803 
ušt8_t
 
	mš¡r_£nd
;

1804 
ušt8_t
 
	m»v1
;

1805 
ušt16_t
 
	m»v2
;

1807 
ušt16_t
 
	m»v2
;

1808 
ušt8_t
 
	m»v1
;

1809 
ušt8_t
 
	mš¡r_£nd
;

1810 
ušt8_t
 
	mšv®id_dump
;

1811 
ušt8_t
 
	mexp_check
;

1812 
ušt8_t
 
	mpktid_check
;

1813 
ušt8_t
 
	msmac_check
;

1815 } 
	tc_misc_t
;

1817 
	#IPC_IP_LEN_MAX
 2048

	)

1818 
	#IPC_IIF_MAX
 0x400

	)

1822 #ià
__FRC_BYTE_ORDER
 =ğ
__FRC_LITTLE_ENDIAN


1823 
ušt32_t
 
	mtx_pÜt
;

1824 
ušt32_t
 
	maùiÚ
;

1825 
ušt32_t
 
	mty³
;

1826 
ušt32_t
 
	m_Ën
;

1827 
ušt32_t
 
	ms_d©a
;

1828 
ušt32_t
 
	ms_mask
;

1829 
ušt32_t
 
	md_d©a
;

1830 
ušt32_t
 
	md_mask
;

1832 
ušt32_t
 
	maùiÚ
;

1833 
ušt32_t
 
	mtx_pÜt
;

1834 
ušt32_t
 
	m_Ën
;

1835 
ušt32_t
 
	mty³
;

1836 
ušt32_t
 
	ms_mask
;

1837 
ušt32_t
 
	ms_d©a
;

1838 
ušt32_t
 
	md_mask
;

1839 
ušt32_t
 
	md_d©a
;

1842 } 
	tc_š¡r_cfg_t
;

1846 
c_š¡r_cfg_t
 
	mš¡r_cfg
;

1847 
ušt8_t
 
	m·ylßd
[
IPC_IP_LEN_MAX
];

1848 } 
	tc_š¡r_t
;

1852 
ušt8_t
 
	md©a
[
INSTR_PAYLOAD_SZ
];

1853 
ušt64_t
 
	mšdex
;

1854 }
	tc_·ylßd_£t_š_t
;

1858 
št64_t
 
	msmac
;

1859 
št64_t
 
	mpktid
;

1860 } 
	tc_cur_t
;

1863 
	#FRC_CMD_RESPOND_DATA_SZ
 (1024)

	)

1865 
	#ULL
 

	)

	@include/frc_util.h

1 #iâdeà
__FRC_UTIL_H__


2 
	#__FRC_UTIL_H__


	)

4 #ià!
__KERNEL__


5 
	~<¡dio.h
>

6 
	~<¡ršg.h
>

9 
	~"äc_defs.h
"

10 
	~"äc_dma.h
"

12 
	#MAC_FMT_STR
 "%.2x:%.2x:%.2x:%.2x:%.2x:%.2x"

	)

13 
	#MAC_PARGS
(
_mac
è_mac[0],_mac[1],_mac[2],_mac[3],_mac[4],_mac[5]

	)

14 
	#MAC_CMP
(
_mac1
, 
_mac2
è(
	`memcmp
(_mac1, _mac2, (
mac_t
)è=ğ0)

	)

15 
	#MAC_CPY
(
_mac1
, 
_mac2
è
	`memıy
(_mac1, _mac2, (
mac_t
))

	)

16 
	#MAC_BROADCAST
(
_mac
) (_mac[0] == 0xff && \

17 
_mac
[1] == 0xff && \

18 
_mac
[2] == 0xff && \

19 
_mac
[3] == 0xff && \

20 
_mac
[4] == 0xff && \

21 
_mac
[5] =ğ0xff)

	)

24 
	#BIT
(
X
è(1 << (X))

	)

25 
	#BITV
(
X
, 
B
è(((Xè& 
	`BIT
(B)è=ğBIT(B))

	)

26 
	#BITH
(
X
, 
B
è((Xè|ğ
	`BIT
(B))

	)

27 
	#BITL
(
X
, 
B
è((Xè&ğ~
	`BIT
(B))

	)

29 
	#FRC_64_TO_32_LO
(
d¡
, 
¤c
è((d¡èğ(
ušt32_t
è(¤c))

	)

30 
	#FRC_64_TO_32_HI
(
d¡
, 
¤c
è((d¡èğ(
ušt32_t
è((¤cè>> 32))

	)

31 
	#FRC_64_HI
(
¤c
è((
ušt32_t
è((¤cè>> 32))

	)

32 
	#FRC_64_LO
(
¤c
è((
ušt32_t
è(¤c))

	)

33 
	#FRC_64_ZERO
(
d¡
è((d¡èğ0)

	)

34 
	#FRC_64_IS_ZERO
(
¤c
è((¤cè=ğ0)

	)

36 
	#FRC_64_SET
(
d¡
, 
¤c_hi
, 
¤c_lo
) \

37 ((
d¡
èğ(((
ušt64_t
è((
ušt32_t
)(
¤c_hi
))è<< 32è| ((ušt64_tè((ušt32_t)(
¤c_lo
))))

	)

39 
	#DUMP_LINE_SIZE
 128

	)

41 
	#_DUMP_FIELD32
(
_v¬
, 
_f›ld
) \

42 
	`äc_´št
(" %16s: 0x%.8x\n", #_f›ld, 
_v¬
->
_f›ld
)

	)

44 
	#_DUMP_FIELD64
(
_v¬
, 
_f›ld
) \

45 
	`äc_´št
(" %16s: 0x%.16Îx\n", #_f›ld, (
ULL
)(
_v¬
->
_f›ld
))

	)

47 
šlše
 
	$äc_dump_dma_hdr
(
äc_dma_hdr_t
 *
hdr
)

57 
	`_DUMP_FIELD32
(
hdr
, 
¡İ_£c
);

60 
	`_DUMP_FIELD32
(
hdr
, 
s
);

61 
	`_DUMP_FIELD32
(
hdr
, 
d
);

63 
	`_DUMP_FIELD32
(
hdr
, 
¥Üt
);

64 
	`_DUMP_FIELD32
(
hdr
, 
dpÜt
);

65 
	`_DUMP_FIELD32
(
hdr
, 
´ÙocŞ
);

66 
	`_DUMP_FIELD32
(
hdr
, 
pkt_num
);

68 
	`_DUMP_FIELD32
(
hdr
, 
tÙ®_·yËn
);

69 
	`_DUMP_FIELD32
(
hdr
, 
hash
);

71 
	`_DUMP_FIELD32
(
hdr
, 
‹id
);

72 
	`_DUMP_FIELD32
(
hdr
, 
µpÛ_£ss_id
);

74 
	`_DUMP_FIELD32
(
hdr
, 
µpÛ_´ÙocŞ
);

75 
	`_DUMP_FIELD32
(
hdr
, 
µpÛ_·yËn
);

76 
	`_DUMP_FIELD32
(
hdr
, 
vÏn_id
);

77 
	`_DUMP_FIELD32
(
hdr
, 
vÏn_ty³
);

81 
	}
}

83 
šlše
 
	$äc_dump_dma_pkt_šfo
(
äc_dma_pkt_šfo_t
 *
šfo
)

85 
	`_DUMP_FIELD32
(
šfo
, 
£qu’û
);

86 
	`_DUMP_FIELD32
(
šfo
, 
ack_£q
);

88 
	`_DUMP_FIELD32
(
šfo
, 
d©a_off£t
);

89 
	`_DUMP_FIELD32
(
šfo
, 
·ylßd_Ën
);

90 
	`_DUMP_FIELD32
(
šfo
, 
dœeùiÚ
);

92 
	`_DUMP_FIELD64
(
šfo
, 
smac
);

93 
	`_DUMP_FIELD64
(
šfo
, 
dmac
);

94 
	}
}

96 
šlše
 
	$_äc_dump_buff
(cÚ¡ *
func
, 
lše_num
, 
Ën
, 
ušt8_t
 *
buff
)

98 
i
;

99 *
p
, 
lše
[
DUMP_LINE_SIZE
];

101 
p
 = 
lše
;

102 
	`äc_´št
("%s.%d: BUFF DUMP %d by‹s:\n", 
func
, 
lše_num
, 
Ën
);

103 
i
 = 0; i < 
Ën
; i++)

105 ià((
i
 % 16) == 0)

108 
	`mem£t
(
lše
, 0, 
DUMP_LINE_SIZE
);

109 
p
 = 
lše
;

110 
p
 +ğ
	`¥rštf
Õ, "%.6d:", 
i
);

113 ià((
i
 % 16) == 8)

115 
p
 +ğ
	`¥rštf
(p, " -");

117 
p
 +ğ
	`¥rštf
Õ, " %.2x", 
buff
[
i
]);

119 ià((
i
 % 16) == 15)

121 
lše
[
DUMP_LINE_SIZE
 - 1] = 0;

122 
	`äc_´št
("%s\n", 
lše
);

125 ià((
i
 % 16) != 0)

127 
lše
[
DUMP_LINE_SIZE
 - 1] = 0;

128 
	`äc_´št
("%s\n", 
lše
);

130 
	`äc_´št
("\n");

131 
	}
}

134 
šlše
 

135 
	$äc_¡©_Çme_g‘
(
šdex
, *
Çme
)

138 *
¡©_Çme
[
¡©_max
] = {

339 #ià
FRC_CONFIG_TWO_TUPLE


357 #ifdeà
FRC_CONFIG_MAC_STATISTICS


364 #ifdeà
FRC_CONFIG_IPC


379 ià(
šdex
 >ğ
¡©_max
)

384 
	`¡rıy
(
Çme
, 
¡©_Çme
[
šdex
]);

387 
	}
}

389 #ià
FRC_CONFIG_VLAN_CHECK


390 
šlše
 

391 
	$äc_vÏn_¡©_Çme_g‘
(
šdex
, *
Çme
)

394 *
¡©_Çme
[
¡©_vÏn_id_max
/2] = {

659 ià(
šdex
 >ğ
¡©_vÏn_id_max
)

664 
	`¡rıy
(
Çme
, 
¡©_Çme
[
šdex
]);

667 
	}
}

670 #ià
FRC_CONFIG_TIMESTAMP_CHECK


671 
šlše
 

672 
	$äc_time¡amp_¡©_Çme_g‘
(
šdex
, *
Çme
)

675 *
¡©_Çme
[
¡©_time¡amp_max
] = {

1006 ià(
šdex
 >ğ
¡©_time¡amp_max
)

1011 
	`¡rıy
(
Çme
, 
¡©_Çme
[
šdex
]);

1014 
	}
}

1016 
	#äc_dump_buff
(
_Ën
, 
_buff
è
	`_äc_dump_buff
(
__func__
, 
__LINE__
, _Ën, _buff)

	)

	@include/frcapi.h

1 #iâdeà
__FRCAPI_H__


2 
	#__FRCAPI_H__


	)

4 
	~<sys/ty³s.h
>

5 
	~<sys/¡©.h
>

6 
	~<fú.h
>

7 
	~<¡dio.h
>

8 
	~<uni¡d.h
>

9 
	~<¡ršg.h
>

10 
	~<sys/ioùl.h
>

12 
	~"äc.h
"

13 
	~"äc_cmd.h
"

14 
	~"äc_ioùl.h
"

16 #ifdeà
FRC_DEBUG_API


17 
	#FRCAPI_ERROR
(
_fmt
, 
_¬gs
...è
	`´štf
("[ERROR] %s.%d:" _fmt, 
__func__
, 
__LINE__
, ##_¬gs)

	)

18 
	#FRCAPI_DEBUG
(
_fmt
, 
_¬gs
...è
	`´štf
("[DEBUG] %s.%d:" _fmt, 
__func__
, 
__LINE__
, ##_¬gs)

	)

20 
	#FRCAPI_ERROR
(
_fmt
, 
_¬gs
...)

	)

21 
	#FRCAPI_DEBUG
(
_fmt
, 
_¬gs
...)

	)

25 
šlše


26 
	$äÿpi
(
ušt16_t
 
ty³
, ušt16_ˆ
cmd
, ušt16_ˆ
’
, *
šput
, ušt16_ˆ*
Ş’
, *
ouut
)

28 
äc_ioùl_t
 
¬g
;

29 
fd
, 
rv
;

31 
fd
 = 
	`İ’
(
FRC_DEVICE_PATH
, 
O_RDWR
);

32 if(
fd
 < 0) {

33 
	`FRCAPI_ERROR
("Cª'ˆİ’ %s.\n", 
FRC_DEVICE_PATH
);

34  
FRE_OPEN
;

37 
	`mem£t
(&
¬g
, 0, (
äc_ioùl_t
));

39 
¬g
.
ty³
 =ype;

40 
¬g
.
cmd
 = cmd;

41 
¬g
.
’
 = ilen;

42 
¬g
.
šput
 = input;

43 ià(
Ş’
 !ğ
NULL
 && 
ouut
 != NULL)

45 
¬g
.
Ş’
 = *olen;

46 
¬g
.
ouut
 = output;

49 
¬g
.
ty³
)

51 
CMD_TYPE_DRV
:

52 
rv
 = 
	`ioùl
(
fd
, 
IOCTL_FRCDRV_REQUEST
, &
¬g
);

54 
CMD_TYPE_TEST
:

55 
CMD_TYPE_CTRL
:

56 
CMD_TYPE_USER
:

57 
rv
 = 
	`ioùl
(
fd
, 
IOCTL_FRCORE_REQUEST
, &
¬g
);

60 
rv
 = 
FRE_UNSUPPORT
;

64 
	`şo£
(
fd
);

66 ià(
rv
 !ğ
FRE_SUCCESS
) {

67 
	`FRCAPI_ERROR
("IoùÈç:„v = %d!\n", 
rv
);

68  
FRE_IOCTL
;

71 ià(
¬g
.
rv
 !ğ
FRE_SUCCESS
)

73  
¬g
.
rv
;

76 ià(
Ş’
 !ğ
NULL
)

78 *
Ş’
 = 
¬g
.olen;

81  
FRE_SUCCESS
;

82 
	}
}

	@include/frcore_ctrl.h

1 #iâdeà
__FRCORE_CTRL_H__


2 
	#__FRCORE_CTRL_H__


	)

5 
	#FRC_CORE_CMD_ARG_MAX
 512

	)

6 
	#FRC_CORE_CMD_PARAM_MAX
 (
FRC_CORE_CMD_ARG_MAX
 / 8)

	)

9 #ià
__FRC_BYTE_ORDER
 =ğ
__FRC_LITTLE_ENDIAN


10 
ušt64_t
 
	m£q
:32;

11 
ušt64_t
 
	mËn
:16;

12 
ušt64_t
 
	mty³
:4;

13 
ušt64_t
 
	mcmd
:12;

15 
ušt64_t
 
	mcmd
:12;

16 
ušt64_t
 
	mty³
:4;

17 
ušt64_t
 
	mËn
:16;

18 
ušt64_t
 
	m£q
:32;

20 } 
	täcÜe_cmd_t
;

24 #ià
__FRC_BYTE_ORDER
 =ğ
__FRC_LITTLE_ENDIAN


25 
ušt64_t
 
	m»t
:16;

26 
ušt64_t
 
	mËn
:16;

27 
ušt64_t
 
	m£q
:32;

29 
ušt64_t
 
	m£q
:32;

30 
ušt64_t
 
	mËn
:16;

31 
ušt64_t
 
	m»t
:16;

33 
ušt8_t
 
	md©a
[
FRC_CMD_RESPOND_DATA_SZ
];

34 } 
	täc_cmd_»¥Úd_t
;

37 
	mCTRL_CMD_RESV
,

38 
	mCTRL_CMD_SETUP_QUEUE
,

39 
	mCTRL_CMD_SETUP_DMA_LOOP_BUFF
,

40 
	mCTRL_CMD_PORT_ENABLE
,

41 
	mCTRL_CMD_SETUP_SIMPLE_PACKAGE_CHAN
,

42 
	mCTRL_CMD_SETUP_SSN_CHAN
,

43 
	mCTRL_CMD_MAX


44 } 
	täcÜe_ù¾_cmd_e
;

	@
1
.
0
122
2677
frcapi/frc_api.c
frcapi/frc_api.h
frcdrv/frcdrv.c
frcdrv/frcdrv.h
frcdrv/frcdrv_chan.c
frcdrv/frcdrv_chan.h
frcdrv/frcdrv_cmd.c
frcdrv/frcdrv_cmd.h
frcdrv/frcdrv_dev.c
frcdrv/frcdrv_dev.h
frcdrv/frcdrv_dma.c
frcdrv/frcdrv_dma.h
frcdrv/frcdrv_intr.c
frcdrv/frcdrv_intr.h
frcdrv/frcdrv_main.c
frcdrv/frcdrv_network.c
frcdrv/frcdrv_network.h
frcdrv/frcdrv_rule.c
frcdrv/frcdrv_rule.h
frcdrv/frcdrv_tcp.c
frcdrv/frcdrv_tcp.h
frcdrv/frcdrv_udp.c
frcdrv/frcdrv_udp.h
frcdrv/octeon_nic.c
frcdrv/octeon_nic.h
frcdrv/zerocp.c
frcore/config/cvmcs-test-config.h
frcore/config/cvmx-config.h
frcore/config/executive-config.h
frcore/config/global-config.h
frcore/frcore.c
frcore/frcore.h
frcore/frcore_acl.c
frcore/frcore_acl.h
frcore/frcore_alg.c
frcore/frcore_alg.h
frcore/frcore_bmm.c
frcore/frcore_bmm.h
frcore/frcore_chan.c
frcore/frcore_chan.h
frcore/frcore_cmd.c
frcore/frcore_cmd.h
frcore/frcore_config.h
frcore/frcore_debug.h
frcore/frcore_defs.h
frcore/frcore_dma.c
frcore/frcore_dma.h
frcore/frcore_filter.c
frcore/frcore_filter.h
frcore/frcore_fr.c
frcore/frcore_fr.h
frcore/frcore_init.c
frcore/frcore_init.h
frcore/frcore_ip.c
frcore/frcore_ip.h
frcore/frcore_ipc.c
frcore/frcore_ipc.h
frcore/frcore_mac_statistics.c
frcore/frcore_mac_statistics.h
frcore/frcore_main.c
frcore/frcore_misc.c
frcore/frcore_misc.h
frcore/frcore_phy.c
frcore/frcore_phy.h
frcore/frcore_pkt.c
frcore/frcore_pkt.h
frcore/frcore_proc.h
frcore/frcore_proto.h
frcore/frcore_queue.h
frcore/frcore_rfc.c
frcore/frcore_rfc.h
frcore/frcore_rule.c
frcore/frcore_rule.h
frcore/frcore_ssn.c
frcore/frcore_ssn.h
frcore/frcore_ssn_priv.h
frcore/frcore_stat.c
frcore/frcore_stat.h
frcore/frcore_tcp.c
frcore/frcore_tcp.h
frcore/frcore_tcpflowrec.c
frcore/frcore_tcpflowrec.h
frcore/frcore_timestamp_check.c
frcore/frcore_timestamp_check.h
frcore/frcore_twotuple.c
frcore/frcore_twotuple.h
frcore/frcore_udp.c
frcore/frcore_udp.h
frcore/frcore_vlan_check.c
frcore/frcore_vlan_check.h
frctweak/frctweak.c
frctweak/frctweak.h
frctweak/frctweak_acl.c
frctweak/frctweak_arg_parser.c
frctweak/frctweak_arg_parser.h
frctweak/frctweak_bmm.c
frctweak/frctweak_chan.c
frctweak/frctweak_file.c
frctweak/frctweak_fr.c
frctweak/frctweak_ipc.c
frctweak/frctweak_mac_stat.c
frctweak/frctweak_pr.c
frctweak/frctweak_rule.c
frctweak/frctweak_stat.c
frctweak/frctweak_test.c
frctweak/frctweak_timestamp_check.c
frctweak/frctweak_udp.c
frctweak/frctweak_vlan_check.c
include/frc.h
include/frc_cmd.h
include/frc_config.h
include/frc_crc8.h
include/frc_debug.h
include/frc_defs.h
include/frc_dma.h
include/frc_ioctl.h
include/frc_list.h
include/frc_pack.h
include/frc_types.h
include/frc_util.h
include/frcapi.h
include/frcore_ctrl.h
